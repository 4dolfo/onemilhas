'use strict';function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}(function(){'use strict';angular.module('app.maintenance',['ui.calendar']).controller('ProfileCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger','$compile',function($scope,$rootScope,$filter,cfpLoadingBar,logger,$compile){var init;var original;$scope.findDate=function(){$scope.main.sales=$scope.profile.sales;$scope.main.purchases=$scope.profile.purchases;$scope.$apply();};$scope.loadProfile=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSelfProfile",{hashId:$scope.session.hashId,data:$scope.main},function(result){$scope.profile=jQuery.parseJSON(result).dataset;$scope.main.adress=$scope.profile.adress;$scope.main.phoneNumber=$scope.profile.phoneNumber;$scope.main.city=$scope.profile.city;$scope.main.name=$scope.profile.name;cfpLoadingBar.complete();$scope.findDate();});if($scope.main.wizardSale){$.post("../backend/application/index.php?rota=/loadSelfSales",{hashId:$scope.session.hashId,data:$scope.main},function(result){$scope.profileSales=jQuery.parseJSON(result).dataset;$scope.$apply();});}};$scope.loadEvents=function(){$.post("../backend/application/index.php?rota=/loadEvents",{hashId:$scope.session.hashId},function(result){$scope.eventsLoaded=jQuery.parseJSON(result).dataset;for(var i in $scope.events){$scope.events.splice(i,1);}for(var i in $scope.eventsLoaded){$scope.eventsLoaded[i].start=new Date($scope.eventsLoaded[i].start);if($scope.eventsLoaded[i].end!=''){$scope.eventsLoaded[i].end=new Date($scope.eventsLoaded[i].end);}$scope.events.push($scope.eventsLoaded[i]);}$scope.$digest();});};init=function init(){$scope.checkValidRoute();$scope.loadProfile();$scope.profileSales=[];$rootScope.modalOpen=false;};$scope.events=[];$scope.uiConfig={calendar:{lang:'pt-br',height:450,editable:true,customButtons:{myCustomButton:{text:'+',click:function click(){$rootScope.$emit('openCalendarModal',{});}}},viewRender:function viewRender(view,element){$scope.loadEvents();},header:{left:'month agendaWeek agendaDay, myCustomButton',center:'',right:'prev,next today'},eventClick:function eventClick(date,jsEvent,view){$scope.alertEventOnClick(date,jsEvent,view);},eventDrop:function eventDrop(event,delta,revertFunc,jsEvent,ui,view){$scope.alertOnDrop(event,delta,revertFunc,jsEvent,ui,view);},eventResize:function eventResize(event,delta,revertFunc,jsEvent,ui,view){$scope.alertOnResize(event,delta,revertFunc,jsEvent,ui,view);}}};$scope.eventRender=function(event,element,view){element.attr({'tooltip':event.title,'tooltip-append-to-body':true});$compile(element)($scope);};$scope.alertOnDrop=function(event,delta,revertFunc,jsEvent,ui,view){event.start=event._start._d;if(event.end){event.end=event._end._d;}$scope.saveEvent(event);};$scope.alertOnResize=function(event,delta,revertFunc,jsEvent,ui,view){event.start=event._start._d;if(event.end){event.end=event._end._d;}$scope.saveEvent(event);};$scope.alertEventOnClick=function(date,jsEvent,view){date.start=date._start._d;if(date.end){date.end=date._end._d;}$rootScope.$emit('openCalendarModal',date);};$scope.saveEvent=function(event){cfpLoadingBar.start();if(event.start){event._start=$rootScope.formatServerDateTime(event.start);}if(event.end){event._end=$rootScope.formatServerDateTime(event.end);}$.post("../backend/application/index.php?rota=/saveEvent",{hashId:$scope.session.hashId,data:event},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadEvents();});};$scope.eventSource={url:"http://www.google.com/calendar/feeds/usa__en%40holiday.calendar.google.com/public/basic",className:'gcal-event',currentTimezone:'America/Sao_Paulo'};$scope.uiConfig.calendar.dayNames=["Domingo","Segunda-Feira","Terça-Feira","Quarta-Feira","Quinta-Feira","Sexta-Feira","Sábado"];$scope.uiConfig.calendar.dayNamesShort=["Dom","Seg","Ter","Qua","Qui","Sex","Sab"];$scope.eventSources=[$scope.events,$scope.eventSource];return init();}]).directive('morrisUserSales',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;switch(attrs.type){case'line':if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.profileSales,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(finish,updateInterval);options.data=scope.$parent.profileSales;};finish=function finish(){options.data=scope.$parent.profileSales;return new Morris.Line(options);};return update();case'area':if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:data,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],behaveLikeLine:attrs.behaveLikeLine||false,fillOpacity:attrs.fillOpacity||'auto',pointSize:attrs.pointSize||4,resize:true};return new Morris.Area(options);case'bar':if(attrs.barColors===void 0||attrs.barColors===''){colors=null;}else{colors=JSON.parse(attrs.barColors);}options={element:ele[0],data:scope.$parent.milesAnalysis,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),barColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],stacked:attrs.stacked||null,resize:true};update=function update(){setTimeout(finish,updateInterval);options.data=scope.$parent.milesAnalysis;};finish=function finish(){options.data=scope.$parent.milesAnalysis;return new Morris.Bar(options);};return update();case'donut':if(attrs.colors===void 0||attrs.colors===''){colors=null;}else{colors=JSON.parse(attrs.colors);}options={element:ele[0],data:data,colors:colors||['#0B62A4','#3980B5','#679DC6','#95BBD7','#B0CCE1','#095791','#095085','#083E67','#052C48','#042135'],resize:true};if(attrs.formatter){func=new Function('y','data',attrs.formatter);options.formatter=func;}return new Morris.Donut(options);}}};}]).controller('CalendarEventModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openCalendarModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"CalendarEventModal.html",controller:'CalendarEventInstanceCtrl',resolve:{event:function event(){return args;}}});modalInstance.result.then(function(resolve){$scope.$parent.saveEvent(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('CalendarEventInstanceCtrl',['$scope','$rootScope','$modalInstance','event','logger',function($scope,$rootScope,$modalInstance,event,logger){$scope.event=event;$scope.eventOptions=[{label:'PUBLICO',type:'PUBLIC'},{label:'PRIVADO',type:'PRIVATED'}];$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){$modalInstance.close($scope.event);};}]);})();;(function(){'use strict';angular.module('app.purchase',['angularFileUpload','ui.mask']).controller('ProviderCtrl',['$scope','$rootScope','$filter','$timeout','$modal','cfpLoadingBar','logger','FileUploader','$http',function($scope,$rootScope,$filter,$timeout,$modal,cfpLoadingBar,logger,FileUploader,$http){var init;var original;var load;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.providerStatus=['Pendente','Aprovado','Bloqueado','Reprovado','Desistencia'];$scope.providerList=['CFTUR','TURISMO STAR'];$scope.searchKeywords='';$scope.filteredProviders=[];$scope.row='';$scope.accountType=[{type:'Conta Corrente'},{type:'Conta Poupança'},{type:'Conta Conjunta'}];$scope.select=function(page){if(load){$timeout.cancel(load);}load=$timeout($scope.loadProvider(),1000);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){if(load){$timeout.cancel(load);}load=$timeout($scope.loadProvider(),1000);};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){if(load){$timeout.cancel(load);}load=$timeout($scope.loadProvider(),1000);};$scope.searchRegistrationCode=function(){if($scope.selected){if($scope.selected.registrationCode){$.post("../backend/application/index.php?rota=/searchRegistrationCode",{hashId:$scope.session.hashId,data:$scope.selected,partnerType:'P'},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logError("Cliente ja cadastrado");}});}}};$scope.setSelected=function(){var original=angular.copy(this.provider);$scope.selected=original;$scope.selected.birthdate=new Date($scope.selected.birthdate);$scope.selected.birthdate.setDate($scope.selected.birthdate.getDate()+1);$scope.selected.registerDate=new Date($scope.selected.registerDate);$scope.selected.registerDate.setDate($scope.selected.registerDate.getDate()+1);$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};$scope.isTable=false;$scope.loadFiles();return this.provider;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadProvider();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadProvider();};$scope.removeFile=function(file){$.post("../backend/application/index.php?rota=/removeFile",{hashId:$scope.session.hashId,data:$scope.selected,file:file},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFiles();});};$scope.saveProvider=function(){if($scope.form_provider.$valid){$scope.selected.cityfullname=$scope.selected.city+', '+$scope.selected.state;if($scope.main.id!=34699){if(!$scope.noRegistrationCode){if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){return logger.logError('CPF Inválido');}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){return logger.logError('CNPJ Inválido');}}}}if($scope.selected.birthdate!==""&&$scope.selected.birthdate!='Invalid Date'){$scope.selected._birthdate=$rootScope.formatServerDate($scope.selected.birthdate);}if($scope.selected.registerDate!==""&&$scope.selected.registerDate!='Invalid Date'){$scope.selected._registerDate=$rootScope.formatServerDate($scope.selected.registerDate);}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveProvider",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();if($scope.selected.status=="Reprovado"){$scope.fillEmail();}else{$scope.cancelEdit();}});}};$scope.fillEmail=function(){$scope.webemail.emailpartner=$scope.selected.email;$scope.webemail.mailcc='';$scope.webemail.subject='[One Milhas] - Analise de Solicitação';$scope.webemail.emailContent="Olá!<br><br>"+"Para nós, identificar o seu interesse em negociar com a One Milhas foi muito importante. <br><br>"+"Porém, analisando a sua solicitação, verificamos que algumas informações não são compatíveis com os critérios internos da One Milhas.<br><br>"+"Por esse motivo, infelizmente, não podemos dar continuidade ao processo de aprovação.<br><br>"+"Agradecemos o seu contato.<br><br>"+"Att.";$scope.mail=true;$scope.$apply();};$scope.providerTag=function(status){switch(status){case'Pendente':return"label label-info";case'Aprovado':return"label label-success";case'Desistencia':return"label label-default";case'Bloqueado':return"label label-warning";case'Reprovado':return"label label-danger";}};$scope.cancelEdit=function(){$scope.loadProvider();$scope.isTable=!$scope.isTable;$scope.newUpload=false;$scope.mail=false;};$scope.mailOrder=function(){$scope.uploader.uploadAll();var file;if($scope.uploader.queue&&$scope.uploader.queue[$scope.uploader.queue.length-1]){file=$scope.uploader.queue[$scope.uploader.queue.length-1].file.name;}$scope.cancelEdit();$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.webemail,attachment:file,type:'COMPRAS',signiture:'signiture',emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.openSearchProvider=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"ProviderModalCtrl.html",controller:'ProviderModalCtrl',resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){$scope.filter=filter;$scope.loadProvider();});};$scope.newProvider=function(){$scope.selected={};$scope.selected.type='P';$scope.selected.registerDate=new Date();$scope.isTable=!$scope.isTable;};$scope.loadProvider=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadProvider",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.$digest();cfpLoadingBar.complete();if(load){load=undefined;}});};$scope.toggleNewUpload=function(){if($scope.newUpload){$scope.newUpload=false;}else{$scope.newUpload=true;}};$scope.loadFiles=function(){$scope.filesLoaded=new FileReader();$.post("../backend/application/index.php?rota=/loadFiles",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.filesLoaded=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.changeRegistrationCode=function(){$scope.noRegistrationCode=!$scope.noRegistrationCode;};$scope.validateData=function(){$.post("../backend/application/index.php?rota=/validadteProviderProfile",{data:$scope.selected},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.printProvider=function(){};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open('GET',url);xhr.send();};$scope.getCEP=function(){$.post("../backend/application/index.php?rota=/getCep",{data:$scope.selected},function(result){$scope.searchCep=jQuery.parseJSON(result).dataset;if($scope.searchCep.status=='success'){$scope.selected.adress=$scope.searchCep.data.logradouro;$scope.selected.adressDistrict=$scope.searchCep.data.bairro;$scope.selected.state=$scope.searchCep.data.uf;$scope.selected.city=$scope.searchCep.data.localidade;}else{logger.logError('Erro na busca pelo CEP');}$scope.$digest();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[0];$scope.currentPage=1;$scope.currentPageProviders=[];init=function init(){$scope.isTable=true;$scope.newUpload=false;$scope.newFile=undefined;$scope.mail=false;$scope.noRegistrationCode=false;$scope.filter={findSRM:false};$scope.checkValidRoute();cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$('#providerstate').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;});cfpLoadingBar.complete();});$scope.loadProvider();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});};return init();}]).controller('ProviderModalCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close($scope.filter);};}]).controller('ModalDemoCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(size){var modalInstance;modalInstance=$modal.open({templateUrl:"ModalDemoCtrl.html",controller:'ModalPermissionInstanceCtrl',size:size,resolve:{selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(){});};}]).controller('ModalPermissionInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','selected',function($scope,$rootScope,$modalInstance,logger,selected){$scope.application=angular.copy(selected);$scope.formatNumberMoney=function(milesDueDate,costPerThousand){$scope.application.multipleSelect.totalCost=milesDueDate*milesDueDate/100;return $scope.application.multipleSelect.totalCost;};$scope.ok=function(){void 0;$uibModalInstance.close();};$scope.cancel=function(){void 0;$uibModalInstance.dismiss('cancel');};$scope.printBankStatement=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFont("times");$scope.toDataUrl('images/bank.jpg',function(base64Img){$scope.toDataUrl('images/tamprint.png',function(base32Img){$scope.toDataUrl('images/smilesprint.png',function(base16Img){$scope.toDataUrl('images/azulprint.png',function(base8Img){$scope.toDataUrl('images/aviancaprint.png',function(base4Img){var _doc$autoTable,_doc$autoTable2;doc.addImage(base64Img,'JPEG',220,20,110,40);var start=70;start=start+20;var images=[];var i=0;var columns=[{title:" ",dataKey:"first"},{title:"OFERTA DE PONTOS",dataKey:"second"},{title:"VENCIMENTO",dataKey:"third"},{title:"VALOR 1000 Pts",dataKey:"four"},{title:"CONFIRMAÇÃO",dataKey:"five"}];var rows=[];var miles=' ';var due_date=' ';var costPerThousand=' ';var totalCost=' ';var airline=['LATAM','GOL','AZUL','AVIANCA'];for(var i=0;i<4;i++){if(airline[i]==$scope.application.multipleSelect[0].toUpperCase()){miles=$scope.application.multipleSelect['offer'];due_date=$scope.application.multipleSelect['milesDueDate'];costPerThousand=$scope.application.multipleSelect['costPerThousand'];totalCost=$scope.application.multipleSelect['totalCost'];rows.push({first:airline[i],second:miles,third:$scope.dateFormat(new Date(due_date)),four:costPerThousand,five:totalCost});}miles=' ',due_date=' ',costPerThousand=' ',totalCost=' ';}doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175]},margin:{left:60},startY:start,pageBreak:'auto',theme:'grid',showHeader:'firstPage',drawCell:function drawCell(cell,opts){},addPageContent:function addPageContent(data){}});start=start+120;var columns=[{title:"DADOS CADASTRAIS",dataKey:"first"},{title:" ",dataKey:"second"},{title:" ",dataKey:"third"}];var rows=[];for(var i=0;i<8;i++){if(i==0){rows.push({first:$scope.application.name});}else if(i==1){rows.push({first:'CPF: '+$scope.application.registrationCode});}else if(i==2){rows.push({first:'Data de Nascimento: '+$scope.dateFormat(new Date($scope.application.birthdate)),second:'Profissão: '+$scope.application.company_name});}else if(i==3){rows.push({first:'Endereço: '+$scope.application.adress});}else if(i==4){rows.push({first:'Cidade: '+$scope.application.city,second:'Estado: '+$scope.application.adressDistrict});}else if(i==5){rows.push({first:'Tel.Fixo: '+$scope.application.phoneNumber,second:'Tel.Cel: '+$scope.application.phoneNumber2,third:'Tel.Comercial: '+$scope.application.phoneNumber2});}else if(i==6){rows.push({first:'Email: '+$scope.application.email});}}doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175]},startY:start,margin:{left:60},theme:'grid',pageBreak:'auto',showHeader:'firstPage',addPageContent:function addPageContent(data){}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"ANÁLISE DE CRÉDITO",dataKey:"first"},{title:"                  ",dataKey:"second"}];var rows=[];rows.push({first:'Score de Crédito',second:$scope.application.creditAnalysis});start=start+50;doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175]},startY:start,margin:{left:60,right:100},theme:'grid',showHeader:'firstPage',createdCell:function createdCell(cell,data){if(data.column.dataKey==='right'){cell.styles.halign='right';}}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"",dataKey:"first"},{title:"SIM",dataKey:"second"},{title:"NÃO",dataKey:"third"}];var rows=[];var letter=['CPF Regular?','Endereço Confere Cadastro?','Cliente Recorrente?','Mesma Companhia','Registro de Débitos?'];for(var i=0;i<letter.length;i++){var _second=void 0;var _third=void 0;if(i==0){if($scope.application.registrationCodeCheck=='Sim'){_second='x';}else{_third='x';}}else if(i==1){if($scope.application.adressCheck=='Sim'){_second='x';}else{_third='x';}}else if(i==2){if($scope.application.clientCheck=='Sim'){_second='x';}else{_third='x';}}else if(i==3){if($scope.application.airlineCheck=='Sim'){_second='x';}else{_third='x';}}else if(i=4){if($scope.application.debitCheck=='Sim'){_second='x';}else{_third='x';}}rows.push({first:letter[i],second:_second,third:_third});}doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175]},startY:start,margin:{left:60,right:100},theme:'grid',showHeader:'firstPage',createdCell:function createdCell(cell,data){if(data.column.dataKey==='right'){cell.styles.halign='right';}}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"DADOS DO CARTÃO",dataKey:"first"}];var rows=[];doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175]},startY:start,margin:{left:60,right:100},theme:'grid',showHeader:'firstPage',createdCell:function createdCell(cell,data){if(data.column.dataKey==='right'){cell.styles.halign='right';}}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"TAM",dataKey:"first"},{title:"SMILES",dataKey:"second"},{title:"AZUL",dataKey:"third"},{title:"AVIANCA",dataKey:"four"}];var rows=[];var airline=['LATAM','GOL','AZUL','AVIANCA'];var card='';var password=void 0;var cardAvianca=' ',passwordAvianca=' ';var cardLatam=' ',passwordLatam=' ',passwordRecovery=' ';var cardAzul=' ',passwordAzul=' ';var cardGol=' ',passwordGol=' ';for(var i=0;i<3;i++){if($scope.application.multipleSelect){if($scope.application.multipleSelect=='latam'){cardLatam=$scope.application.latam.loyaltyLatam;passwordLatam=$scope.application.latam.passwordMultiplus;passwordRecovery=$scope.application.latam.passwordRecovery;}else if($scope.application.multipleSelect=='smiles'){cardGol=$scope.application.gol.cardNumber;passwordGol=$scope.application.gol.password;}else if($scope.application.multipleSelect=='azul'){cardAzul=$scope.application.azul.cardNumber;passwordAzul=$scope.application.azul.password;}else if($scope.application.multipleSelect=='avianca'){cardAvianca=$scope.application.avianca.cardNumber;passwordAvianca=$scope.application.avianca.password;}}if(i==0){rows.push({first:'FIDELIDADE: '+cardLatam,second:'Nº.Cartão: '+cardGol,third:'Nº.Cartão: '+cardAzul,four:'Nº.Cartão: '+cardAvianca});}else if(i==1){rows.push({first:'SENHA MÚLTIPLAS: '+passwordLatam,second:'Senha: '+passwordGol,third:'Senha: '+passwordAzul,four:'Senha: '+passwordAvianca});}else{rows.push({first:'SENHA RESGATE: '+passwordRecovery,second:'',third:'',four:''});}}doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175],lineColor:255},startY:start,margin:{left:60,right:100},theme:'grid',showHeader:'firstPage',createdCell:function createdCell(cell,data){if(data.column.dataKey==='right'){cell.styles.halign='right';}}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"           ",dataKey:"first"},{title:"Confirmação",dataKey:"second"}];var rows=[];var a=["1.Nome Completo ? ","2.Filiação ? ","3.CPF ","4.Idade ","5.Data de Nascimento? ","6.Endereço informado na Ficha ? \n Residencial ? ","7.Confirmação Endereços Antigos. ","8.Possui empresas por nome ","9.Confirmação em Telefone fixo ? "];for(var y=0;y<a.length;y++){var check=' ';if($scope.application.checkbox.fullNameCheck&&y==0){check='Sim';}else if($scope.application.checkbox.affiliationCheck&&y==1){check='Sim';}else if($scope.application.checkbox.registerCheck&&y==2){check='Sim';}else if($scope.application.checkbox.ageCheck&&y==3){check='Sim';}else if($scope.application.checkbox.birthCheck&&y==4){check='Sim';}else if($scope.application.checkbox.recordAddressCheck&&y==5){check='Sim';}else if($scope.application.checkbox.addressOldCheck&&y==6){check='Sim';}else if($scope.application.checkbox.companyNameCheck&&y==7){check='Sim';}else if($scope.application.checkbox.phoneCheck&&y==8){check='Sim';}rows.push({first:a[y],second:check});}doc.autoTable(columns,rows,(_doc$autoTable={headerStyles:{fillColor:[44,74,175]}},_defineProperty(_doc$autoTable,'headerStyles',{fillColor:[44,74,175],textColor:255}),_defineProperty(_doc$autoTable,'margin',{left:60}),_defineProperty(_doc$autoTable,'startY',start),_defineProperty(_doc$autoTable,'theme','plain'),_defineProperty(_doc$autoTable,'showHeader','firstPage'),_defineProperty(_doc$autoTable,'addPageContent',function addPageContent(data){}),_doc$autoTable));start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"Observação - Questionário Confirmação",dataKey:"first"}];var rows=[];rows.push({first:$scope.application.checkbox.observation});doc.autoTable(columns,rows,(_doc$autoTable2={headerStyles:{fillColor:[44,74,175]}},_defineProperty(_doc$autoTable2,'headerStyles',{fillColor:[44,74,175],textColor:255}),_defineProperty(_doc$autoTable2,'margin',{left:60}),_defineProperty(_doc$autoTable2,'startY',start),_defineProperty(_doc$autoTable2,'theme','plain'),_defineProperty(_doc$autoTable2,'showHeader','firstPage'),_defineProperty(_doc$autoTable2,'addPageContent',function addPageContent(data){}),_doc$autoTable2));start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"ONE MILHAS ",dataKey:"first"},{title:" ",dataKey:"second"}];var rows=[];var b=["Data de Cotação ","Data de Ligação ","Ficha Aprovada ","Responsável Análise ","Responsável Aprovação"];var first;var second;var third;for(var y=0;y<b.length;y++){first=b[y];if(y==0){second=$scope.dateFormat(new Date($scope.application.date_quote));}else if(y==1){second=$scope.dateFormat(new Date($scope.application.connection_date));}else if(y==2){if($scope.application.approvedCard){second='Sim';}else{second='Não';}}else if(y==3){second=$scope.application.responsible_analyst;}else if(y==4){second=$scope.application.responsible_approval;}rows.push({first:first,second:second});}doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175],textColor:255},margin:{left:60},startY:start,theme:'grid',showHeader:'firstPage',addPageContent:function addPageContent(data){}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"PAGAMENTO ",dataKey:"first"},{title:"              ",dataKey:"second"}];var rows=[];var c=["BANCO ","COD.","AGÊNCIA","OP.","CONTA","TITULAR"];var second;for(var i=0;i<c.length;i++){if(i==0){if($scope.application.bank){second=$scope.application.bank;}else{second="____________________________";}}else if(i==1){if($scope.application.code){second=$scope.application.code;}else{second="____________________________";}}else if(i==2){if($scope.application.agency){second=$scope.application.agency;}else{second="____________________________";}}else if(i==3){if($scope.application.op){second=$scope.application.op;}else{second="____________________________";}}else if(i==4){if($scope.application.account){second=$scope.application.account;}else{second="____________________________";}}else if(i==5){if($scope.application.holder){second=$scope.application.holder;}else{second="____________________________";}}rows.push({first:c[i],second:second});}doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175],textColor:255},showHeader:'firstPage',margin:{left:60},startY:start,theme:'plain',addPageContent:function addPageContent(data){}});start=doc.autoTableEndPosY();start=start+50;var columns=[{title:"ANDAMENTO ",dataKey:"first"}];var rows=[];var n=['1','2','3','4','5','6'];rows.push({first:$scope.application.progress});doc.autoTable(columns,rows,{columnStyles:{title:{fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175],textColor:255},margin:{left:60},startY:start,theme:'plain',showHeader:'firstPage',addPageContent:function addPageContent(data){}});doc.save('FichaDeIncricaoBank'+'.pdf');});});});});});};$scope.dateFormat=function(date,format){return $rootScope.pad(date.getDate())+"/"+$rootScope.pad(date.getMonth()+1)+"/"+date.getFullYear();};$scope.pad=function(n,width,z){if(width==undefined){width=2;}z=z||'0';n=n+'';return n.length>=width?n:new Array(width-n.length+1).join(z)+n;};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open('GET',url);xhr.send();};}]);})();(function(){"use strict";angular.module("app.sale",["angularFileUpload","ui.mask","ui.select"]).controller("ClientCtrl",["$scope","$rootScope","$filter","$modal","cfpLoadingBar","logger","FileUploader","$http",function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader,$http){var init;var original;$scope.clientStatus=["Pendente","Aprovado","Bloqueado","Reprovado","Arquivado","Coberto","Analise prazo","Pendente Liberacao","Antecipado/Bloqueado"];$scope.clientPayments=["Boleto","Antecipado"];$scope.clientBilling=["Diario","Semanal","Quinzenal","Mensal","Outro"];$scope.origins=["MMS","SRM"];$scope.searchKeywords="";$scope.filteredClients=[];$scope.row="";$scope.partners=[{},{}];$scope.filters=[{name:"id",label:"id",check:true},{name:"company_name",label:"Razao Social"},{name:"name",label:"Nome",check:true},{name:"registrationCode",label:"Cnpj"},{name:"city",label:"Cidade"},{name:"state",label:"Estado"},{name:"cityfullname",label:"Cidade - Estado",check:true},{name:"adress",label:"Endereço"},{name:"partnerType",label:""},{name:"email",label:"email"},{name:"phoneNumber",label:"Telefone Celular"},{name:"phoneNumber2",label:"Telefone Comercial"},{name:"phoneNumber3",label:"Telefone Residencial"},{name:"status",label:"Status",check:true},{name:"paymentType",label:"Forma de Pagamento",check:true},{name:"paymentDays",label:"Dias de Pagamento",check:true},{name:"description",label:"Observação"},{name:"creditAnalysis",label:"Score"},{name:"registrationCodeCheck",label:"CNPJ Regular"},{name:"adressCheck",label:"Endereço Confere"},{name:"creditDescription",label:"Registro de débito"},{name:"partnerLimit",label:"Limite Cliente",check:true},{name:"last_emission",label:"Ultima emissão",check:true},{name:"countd",label:"Quantidade de emissão(total)",check:true},{name:"last_month_emission",label:"Quantidade de emissão(ultimo mês)"},{name:"workingDays",label:"Dias Úteis"},{name:"billingPeriod",label:"Faturamento"},{name:"birthdate",label:"Data Fundação"},{name:"typeSociety",label:"Tipo Sociedade"},{name:"mulct",label:"Multa atraso"},{name:"registerDate",label:"Data Registro"},{name:"adressNumber",label:"Número Endereço"},{name:"adressComplement",label:"Complemento Endereço"},{name:"zipCode",label:"CEP"},{name:"adressDistrict",label:"Bairro"},{name:"account",label:"Tipo Cliente"},{name:"financialContact",label:"Responsavel Financeiro"},{name:"limitMargin",label:"Margem de Limite(%)"},{name:"salePlan",label:"Plano Commercial"},{name:"finnancialEmail",label:"Emails Financeiro"},{name:"interest",label:"Juros"},{name:"operationPlan",label:"Plano Multa/Custo"},{name:"dealer",label:"Representante"},{name:"lastCreditAnalysis",label:"Data Ultima Analise"},{name:"daysToBoarding",label:"Dias Embarque"}];$scope.modification=[];$scope.changeFilds=function(){$scope.filteredFilds=$filter("filter")($scope.filters,true);};$scope.select=function(page){$scope.loadClient();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row="";};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredClients=$filter("filter")($scope.clients,$scope.searchKeywords);return $scope.onFilterChange();};$scope.findColor=function(date,fild){if(date&&fild=="last_emission"){date=$rootScope.findDate(date);if(date!=""&&date!="Invalid Date"){date.setDate(date.getDate()+2);date.setHours(0,0,0,0);if(date>$scope.actual_date){return"#50A52F";}else{date.setDate(date.getDate()+1);if(date>$scope.actual_date){return"#D6CE62";}else{return"#E04545";}}}}};$scope.getCEP=function(){$.post("../backend/application/index.php?rota=/getCep",{data:$scope.selected},function(result){$scope.searchCep=jQuery.parseJSON(result).dataset;if($scope.searchCep.status=="success"){$scope.selected.adress=$scope.searchCep.data.logradouro;$scope.selected.adressDistrict=$scope.searchCep.data.bairro;$scope.selected.state=$scope.searchCep.data.uf;$scope.selected.city=$scope.searchCep.data.localidade;}else{logger.logError("Erro na busca pelo CEP");}$scope.$digest();});};$scope.removeClient=function(){$.post("../backend/application/index.php?rota=/removeClient",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancelEdit();});};$scope.searchRegistrationCode=function(){if($scope.selected){if($scope.selected.registrationCode){$.post("../backend/application/index.php?rota=/searchRegistrationCode",{hashId:$scope.session.hashId,data:$scope.selected,partnerType:"C"},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logError("Cliente ja cadastrado");}});}}$scope.currentSuggestions=$filter("filter")($scope.suggestions,$scope.selected.registrationCode);};$scope.showBillingPeriod=function(){if($scope.selected){return $scope.selected.billingPeriod=="Diario"||$scope.selected.billingPeriod=="Semanal"||$scope.selected.billingPeriod=="Quinzenal"||$scope.selected.billingPeriod=="Mensal"||$scope.selected.billingPeriod==""||$scope.selected.billingPeriod==undefined;}};$scope.setSelected=function(){$scope.partners=[{},{}];$("#partner_limit").number(true,2,",",".");original=angular.copy(this.client);$scope.clientDocs=[];$scope.modification=[];$scope.authorized=false;$scope.selected=this.client;if($scope.selected.last_emission){$scope.selected.last_emission=$rootScope.findDate($scope.selected.last_emission);}if($scope.selected.birthdate){$scope.selected.birthdate=$rootScope.findDate($scope.selected.birthdate);}if($scope.selected.registerDate){$scope.selected.registerDate=$rootScope.findDate($scope.selected.registerDate);}if($scope.selected.lastCreditAnalysis){$scope.selected._lastCreditAnalysis=$rootScope.findDate($scope.selected.lastCreditAnalysis);}$scope.selected._status=$scope.selected.status;$scope.selected._billingPeriod=$scope.selected.billingPeriod;$scope.selected._paymentType=$scope.selected.paymentType;$scope.selected._paymentDays=$scope.selected.paymentDays;$scope.selected._partnerLimit=$scope.selected.partnerLimit;$.post("../backend/application/index.php?rota=/loadPartnersClient",{hashId:$scope.session,data:$scope.selected},function(result){$scope.partners=jQuery.parseJSON(result).dataset;for(var i in $scope.partners){if($scope.partners[i].birthdate!="")$scope.partners[i].birthdate=$rootScope.findDate($scope.partners[i].birthdate);}if($scope.partners.length<1)$scope.partners=[{},{}];else if($scope.partners.length==1)$scope.partners.push({});$scope.loadIssuers();});$scope.currentSuggestions=$filter("filter")($scope.suggestions,$scope.selected.registrationCode);$.post("../backend/application/index.php?rota=/loadSalePlans",{hashId:$scope.session,data:$scope.selected},function(result){$scope.SalePlans=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadControlPlans",$scope.session,function(result){$scope.ControlPlans=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadActualClientLimit",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.ActualLimit=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientAnalisys",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.finnacialInfo=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientDocs",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientDocs=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientNotifications",{data:$scope.selected},function(result){$scope.clientNotifications=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadCupons",{data:$scope.selected},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.loadClientRegistrionUpdates();};$scope.loadClientRegistrionUpdates=function(){$.post("../backend/application/index.php?rota=/client/loadClientRegistrionUpdates",{data:$scope.selected},function(result){$scope.clientRegistrationUpdates=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openModalRegistrationUpdate=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/client_adress_update.html",controller:"ModalRegistrationUpdateInstanceCtrl",periods:$scope.$parent.periods,resolve:{clientRegistrationUpdates:function clientRegistrationUpdates(){return $scope.clientRegistrationUpdates;},selected:function selected(){return $scope.selected;}}});};$scope.openModalCreditAnalysis=function(partner){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/credit_analysis.html",controller:"ModalCreditAnalysisCtrl",periods:$scope.periods,size:"lg",resolve:{partnerObject:function partnerObject(){return partner;}}});};$scope.setStatusNotification=function(not){$.post("../backend/application/index.php?rota=/setStatusNotification",{data:$scope.selected,notification:not},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadClientNotifications",{data:$scope.selected},function(result){$scope.clientNotifications=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.checkOurAnalisys=function(){if($scope.selected){if($scope.selected.creditAnalysis){if($scope.selected.creditAnalysis.length>=5){var score=$scope.selected.creditAnalysis.slice(2,5);}}}};$scope.registerLog=function(){$.post("../backend/application/index.php?rota=/saveCommercialProgress",{hashId:$scope.session.hashId,data:$scope.selected,progress:$scope.newProgress},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.newProgress={};$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.loadIssuers=function(){$.post("../backend/application/index.php?rota=/loadIssuers",{data:$scope.selected},function(result){$scope.issuers=jQuery.parseJSON(result).dataset;$scope.isTable=false;$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};$scope.loadFiles();$scope.$apply();});};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadClient();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadClient();};$scope.intencionToSave=function(){$scope.saveClient();};$scope.openAutorization=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/autorization.html",controller:"AutorizationCtrl",periods:$scope.periods,resolve:{main:function main(){return $scope.main;},permissions:function permissions(){return{type:"Comercial"};}}});modalInstance.result.then(function(result){$scope.authorized=result;});};$scope.analiseAntiga=function(date,registerDate){if(date){if(date!==""&&date!="Invalid Date"){var data=new Date();data.setMonth(data.getMonth()-6);if(date<data){return true;}}}if(registerDate){if(registerDate!==""&&registerDate!="Invalid Date"){var data=new Date();data.setMonth(data.getMonth()-6);if(registerDate<data){return true;}}}return false;};$scope.saveClient=function(){$scope.selected.cityfullname=$scope.selected.city+", "+$scope.selected.state;if($scope.selected.noRegistrationCode!=true){if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){$scope.openAutorization();return logger.logError("CPF Inválido");}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){$scope.openAutorization();return logger.logError("CNPJ Inválido");}}}if($scope.selected.name.length>40&&$scope.authorized==false){$scope.openAutorization();return logger.logError("Nome da agencia nao deve ser superior a 40 caracteres");}if(!$scope.selected.adress&&$scope.authorized==false){$scope.openAutorization();return logger.logError("Endereço obrigatorio");}if(!$scope.selected.city&&$scope.authorized==false){$scope.openAutorization();return logger.logError("Estado e cidade obrigatorio");}if($scope.selected.birthdate){if($scope.selected.birthdate!==""&&$scope.selected.birthdate!="Invalid Date"){$scope.selected._birthdate=$rootScope.formatServerDate($scope.selected.birthdate);}}if($scope.selected._lastCreditAnalysis){if($scope.selected._lastCreditAnalysis!==""&&$scope.selected._lastCreditAnalysis!="Invalid Date"){$scope.selected.lastCreditAnalysis=$rootScope.formatServerDate($scope.selected._lastCreditAnalysis);}}if($scope.selected.registerDate!==""&&$scope.selected.registerDate!="Invalid Date"){$scope.selected._registerDate=$rootScope.formatServerDate($scope.selected.registerDate);}var docs="";var and="";for(var i in $scope.selected.docs){if($scope.selected.docs[i].checked){docs=docs+and+$scope.selected.docs[i].id;and="_";}}$scope.selected.docsSelected=docs;for(var i in $scope.partners){if($scope.partners[i].birthdate){if($scope.partners[i].birthdate!==""&&$scope.partners[i].birthdate!="Invalid Date"){$scope.partners[i]._birthdate=$rootScope.formatServerDate($scope.partners[i].birthdate);}}}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/checkRegister",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){if(jQuery.parseJSON(result).message.type=="S"){$.post("../backend/application/index.php?rota=/saveClient",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadClient();cfpLoadingBar.complete();});$scope.isTable=true;$scope.$digest();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.copyAddress=function(){$scope.selected.adressFinnancial=$scope.selected.adress;$scope.selected.adressNumberFinnancial=$scope.selected.adressNumber;$scope.selected.adressComplementFinnancial=$scope.selected.adressComplement;$scope.selected.adressDistrictFinnancial=$scope.selected.adressDistrict;$scope.selected.zipCodeFinnancial=$scope.selected.zipCode;$scope.selected.cityFinnancialState=$scope.selected.state;$scope.selected.cityFinnancialName=$scope.selected.city;};$scope.cancelEdit=function(){$scope.isTable=true;$scope.newUpload=false;$scope.mail=false;$scope.newRegister=false;$scope.loadClient();};$scope.cancelEditEmail=function(){$scope.mail=false;$scope.wemail.emailpartner="";$scope.wemail.mailcc="";$scope.wemail.subject="";$scope.wemail.emailContent="";};$scope.newClient=function(){$scope.selected={};$scope.issuers={};$scope.partners=[{},{}];$scope.selected.type="C";$scope.selected.registerDate=new Date();$scope.isTable=!$scope.isTable;$scope.newRegister=true;};$scope.loadClient=function(){$scope.newUpload=false;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClient",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.$digest();cfpLoadingBar.complete();});};$scope.toggleNewUpload=function(){if($scope.newUpload){$scope.newUpload=false;}else{$scope.newUpload=true;}};$scope.loadFiles=function(){$scope.filesLoaded=new FileReader();$.post("../backend/application/index.php?rota=/loadFiles",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.filesLoaded=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.fillEmailContent=function(){$scope.mail=true;$scope.selected=this.client;$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - One Milhas";$scope.wemail.emailContent="<br><br><br>";};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wemail,attachment:file,type:"COMERCIAL",emailType:$rootScope.emailType},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.mail=false;$scope.uploader.clearQueue();$scope.wemail={};}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.resetPassword=function(){$.post("../backend/application/index.php?rota=/busca/resetPassword",{data:$scope.selected},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.removeFile=function(file){$.post("../backend/application/index.php?rota=/removeFile",{hashId:$scope.session.hashId,data:$scope.selected,file:file},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFiles();});};$scope.addDealer=function(){$scope.selected.dealers.push({name:""});};$scope.removeDealer=function(){$scope.selected.dealers.pop();};$scope.setDocumentStatus=function(doc){$.post("../backend/application/index.php?rota=/setDocumentStatus",{hashId:$scope.session.hashId,data:$scope.selected,doc:doc},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadClientDocs",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientDocs=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.fillEmailIssuer=function(issuer){$scope.mail=true;$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent=$scope.returnLoginText(issuer);$scope.uploader.formData={hashId:$scope.session.hashId};$rootScope.emailType="EMAIL-ISSUER->"+issuer.id;};$scope.fillEmailActivation=function(){$scope.mail=true;$scope.uploader.formData={hashId:$scope.session.hashId};$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent=$scope.returnActivivationText();$rootScope.emailType="EMAIL-ACTIVATION";};$scope.findClass=function(issuer){if(!issuer.sendEmail){return"btn btn-danger smallBtn";}else{return"btn btn-info smallBtn";}};$scope.editCupom=function(_cupom){_cupom._dataInicio=new Date(_cupom.dataInicio);_cupom._dataExpiracao=new Date(_cupom.dataExpiracao);var modalInstance;modalInstance=$modal.open({templateUrl:"CupomDataCtrl.html",controller:"CupomModalInstanceCtrl",periods:$scope.periods,resolve:{cupom:function cupom(){return _cupom;}}});modalInstance.result.then(function(issuer_selected){$.post("../backend/application/index.php?rota=/loadCupons",{data:$scope.selected},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;});});};$scope.openCupomModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"CupomDataCtrl.html",controller:"CupomModalInstanceCtrl",periods:$scope.periods,resolve:{cupom:function cupom(){return{client_id:$scope.selected.id};}}});modalInstance.result.then(function(issuer_selected){$.post("../backend/application/index.php?rota=/loadCupons",{data:$scope.selected},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;});});};$scope.returnLoginText=function(issuer){var text="<p class='MsoNormal'><span>Seguindo com processo de ativação segue dados para acesso ao Busca Ideal.<span></span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span>Seu acesso ao Busca Ideal é o seguinte:</p>"+"<p class='MsoNormal'><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span></p>"+"<ul type='disc'>"+"<li class='MsoNormal'><span>Usuário: <b>"+$scope.selected.prefixo+".admin</b></span><span><span></span></span></li>"+"<li class='MsoNormal'><span>Senha: <b>admin123</b></span><span><span></span></span></li>"+"</ul>"+"<p class='MsoNormal'><span><span class='m_-2386000081486288919gmail-apple-converted-space'><br></span></span></p>"+"<p class='MsoNormal'><span style='color: rgb(46, 116, 181);'>Link Busca Ideal:<a href='https://busca.buscaideal.com.br'>https://busca.buscaideal.com.br</a><a href='https://busca.buscaideal.com.br' target='_blank'></a></span><br></p>"+"<p class='MsoNormal'><span></span></p>"+"<br>"+"<p class='MsoNormal'><span>Recomendamos que no primeiro acesso seja realizado alteração da senha padrão.</span><span></span></p>"+"<p class='MsoNormal'><span>(Meus Dados &gt; Senha e Validar senha)</span><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span><span></span></p>"+"<p class='MsoNormal'><span>Anexo manual de utilização do sistema.</span><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span><span></span></p>"+"<p class='MsoNormal'><b><i>Para criação de novos logins, utilize a aba minha conta em seu login master</i></b><br></p>"+"<div><b><i><br></i></b></div>"+"<div>Atenciosamente,<br></div>";if($scope.selected.subClient){text=text.replace("Busca Ideal","VOE B2B");text=text.replace("http://buscaideal.com","http://busca.voeb2b.com.br");}return text;};$scope.returnActivivationText=function(){var text="  <p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Caro parceiro nosso cadastro foi concluído, algumas informações sobre procedimentos e contatos estão no anexo desse e-mail.</span><span><br><br><span>Atender a "+$scope.selected.name+" será um grande prazer, gostaria de desde já nos colocar à disposição para o que precisar, sejam duvidas, criticas, sugestões ou qualquer outra demanda, abaixo seguem nossos telefones de contato.</span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span><span><br></span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><i><span style='color: rgb(47, 85, 151);'>*Toda demanda inicial como envio de O.P., passagens, informativos e boletos serão enviadas nesse e-mail, havendo interesse de alteração ou inclusão de novos e-mails gentileza responder esse e-mail especificando o e-mail e o que deverá ser encaminhado.</span></i></b><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><span style='color: rgb(47, 85, 151);'><br></span></b></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><span style='color: rgb(47, 85, 151);'>Gentileza confirmar o recebimento desse e-mail (protocolo)</span></b><br></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>&nbsp;</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Fixo: &nbsp; &nbsp; &nbsp; &nbsp; (31) 3972-9601</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Celular: &nbsp;(31) 9 7150-5535</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (31) 9 9584-9761</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'>Um forte abraço e muito sucesso nessa nova parceria!<br></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span><br><span>Atenciosamente,</span><br></span></p>"+"<p></p>";if($scope.selected.subClient){text=text.replace("Busca Ideal","VOE B2B");text=text.replace("http://buscaideal.com","http://busca.voeb2b.com.br");}return text;};$scope.numPerPageOpt=[10,30,50,100,2000];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageClients=[];$rootScope.hashId=$scope.session.hashId;$scope.getFild=function(client,fild){if(new Date(client[fild])=="Invalid Date"||typeof client[fild]=="number"||client[fild]==""||client[fild].length<=9||fild=="name"){return client[fild];}else{return $filter("date")($rootScope.findDate(client[fild]),"dd/MM/yyyy");}};$scope.searchState=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});};init=function init(){$scope.actual_date=new Date();$scope.isTable=true;$scope.checkValidRoute();$scope.clientDocs=[];cfpLoadingBar.start();$scope.mail=false;$scope.showFilters=false;$scope.changeFilds();$rootScope.modalOpen=true;$scope.newProgress={};$scope.newRegister=false;$scope.suggestions=[];$scope.filter={};if($scope.main.dealer&&($scope.main.id==22091||$scope.main.id==37362||$scope.main.id==25112||$scope.main.id==28341)){$scope.filters=[{name:"name",label:"Nome",check:true},{name:"registrationCode",label:"CPF",check:true},{name:"oabNumber",label:"OAB",check:true}];$scope.changeFilds();}$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadTags",{},function(result){$scope.tags=jQuery.parseJSON(result).dataset;});$("#partnerState").on("blur",function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.citiesPartners=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});});$scope.loadClient();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:"customFilter",fn:function fn(item,options){return this.queue.length<10;}});if(!$scope.main.dealer){$.post("../backend/application/index.php?rota=/loadClientSuggestions",{},function(result){$scope.suggestions=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clientNames=jQuery.parseJSON(result).dataset;});}$.post("../backend/application/index.php?rota=/loadDealers",$scope.session,function(result){$scope.dealers=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openSearchModal=function(){$.post("../backend/application/index.php?rota=/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"ClientsModalDemoCtrl.html",controller:"ClientsModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;},states:function states(){return $scope.states;},dealers:function dealers(){return $scope.dealers;}}});modalInstance.result.then(function(filter){filter._fromDate=$rootScope.formatServerDate(filter.fromDate);filter._toDate=$rootScope.formatServerDate(filter.toDate);filter._notFromDate=$rootScope.formatServerDate(filter.notFromDate);filter._notToDate=$rootScope.formatServerDate(filter.notToDate);filter._registerFromDate=$rootScope.formatServerDate(filter.registerFromDate);filter._registerToDate=$rootScope.formatServerDate(filter.registerToDate);$scope.loadClient();},function(){$log.info("Modal dismissed at: "+new Date());});});};$scope.generateHash=function(){$.post("../backend/application/index.php?rota=/generateHashClient",{},function(result){$scope.test=jQuery.parseJSON(result).dataset;$scope.span=true;$scope.$digest();});};return init();}]).controller("CupomModalInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","cupom",function($scope,$rootScope,$modalInstance,logger,cupom){$scope.cupom=cupom;$scope.ok=function(){$scope.cupom.dataInicio=$rootScope.formatServerDate($scope.cupom._dataInicio);$scope.cupom.dataExpiracao=$rootScope.formatServerDate($scope.cupom._dataExpiracao);$.post("../backend/application/index.php?rota=/saveCupons",{data:$scope.cupom},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(true);});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("ClientsModalInstanceCtrl",["$scope","$rootScope","$modalInstance","filter","states","dealers",function($scope,$rootScope,$modalInstance,filter,states,dealers){$scope.states=states;$scope.dealers=dealers;$scope.clientStatus=["Pendente","Aprovado","Bloqueado","Reprovado","Arquivado","Analise prazo","Pendente Liberacao","Antecipado/Bloqueado"];$scope.clientPayments=["Boleto","Antecipado"];$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("IssuersDataCtrl",["$scope","$rootScope","$modal","$log","logger",function($scope,$rootScope,$modal,$log,logger){$scope.saveIssuer=function(){$.post("../backend/application/index.php?rota=/saveIssuer",{hashId:$scope.session.hashId,data:$scope.issuer_selected,client:$scope.$parent.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.loadIssuers();});};$scope.span=false;$scope.open=function(){$scope.issuer_selected=angular.copy(this.issuer);var modalInstance;modalInstance=$modal.open({templateUrl:"IssuersDataCtrl.html",controller:"IssuersModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{issuer_selected:function issuer_selected(){return $scope.issuer_selected;}}});modalInstance.result.then(function(issuer_selected){if(issuer_selected!=undefined){$scope.issuer_selected=issuer_selected;$scope.saveIssuer();}else{$scope.$parent.loadIssuers();}});};}]).controller("IssuersModalInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","issuer_selected",function($scope,$rootScope,$modalInstance,logger,issuer_selected){$scope.issuer_selected=issuer_selected;$scope.clientStatus=["Pendente","Aprovado","Bloqueado","Reprovado","Arquivado","Analise prazo","Pendente Liberacao"];$scope.ok=function(){$modalInstance.close($scope.issuer_selected);};$scope.remove=function(){$.post("../backend/application/index.php?rota=/removeIssuer",{hashId:$rootScope.hashId,data:$scope.issuer_selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(undefined);});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("ClientLogModalCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on("openClientLogModal",function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"ClientLogModalCtrl.html",controller:"ClientLogInstanceCtrl",resolve:{}});modalInstance.result.then(function(resolve){args.resolveDescription=resolve.resolveDescription;$scope.$parent.saveClient();$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller("ClientLogInstanceCtrl",["$scope","$rootScope","$modalInstance","logger",function($scope,$rootScope,$modalInstance,logger){$scope.selectedClient={resolveDescription:""};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selectedClient.resolveDescription.length<1)return logger.logError("Motivos devem ser informados");$modalInstance.close($scope.selectedClient);};}]).controller("ModalRegistrationUpdateInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","clientRegistrationUpdates","selected",function($scope,$rootScope,$modalInstance,logger,clientRegistrationUpdates,selected){$scope.clientRegistrationUpdates=clientRegistrationUpdates;$scope.selected=selected;$scope.reject=function(registration){registration.id=$scope.selected.id;$.post("../backend/application/index.php?rota=/client/rejectRegistrationUpdate",{data:registration},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.accept=function(registration){registration.id=$scope.selected.id;$.post("../backend/application/index.php?rota=/client/acceptRegistrationUpdate",{data:registration},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();(function(){'use strict';angular.module('app.saleClientWait',['angularFileUpload','ui.mask','ui.select']).controller('ClientWaitCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger','FileUploader','$http',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader,$http){var init;var original;$scope.clientStatus=['Pendente','Aprovado','Bloqueado','Reprovado','Arquivado','Coberto','Analise prazo','Pendente Liberacao','Antecipado/Bloqueado'];$scope.clientPayments=['Boleto','Antecipado'];$scope.clientBilling=['Diario','Semanal','Quinzenal','Mensal','Outro'];$scope.origins=['MMS','SRM'];$scope.searchKeywords='';$scope.filteredClients=[];$scope.row='';$scope.partners=[{},{}];$scope.filters=[{name:'id',label:'id',check:true},{name:'company_name',label:'Razao Social'},{name:'name',label:'Nome',check:true},{name:'registrationCode',label:'Cnpj'},{name:'city',label:'Cidade'},{name:'state',label:'Estado'},{name:'cityfullname',label:'Cidade - Estado',check:true},{name:'adress',label:'Endereço'},{name:'partnerType',label:''},{name:'email',label:'email'},{name:'phoneNumber',label:'Telefone Celular'},{name:'phoneNumber2',label:'Telefone Comercial'},{name:'phoneNumber3',label:'Telefone Residencial'},{name:'status',label:'Status',check:true},{name:'paymentType',label:'Forma de Pagamento',check:true},{name:'paymentDays',label:'Dias de Pagamento',check:true},{name:'description',label:'Observação'},{name:'creditAnalysis',label:'Score'},{name:'registrationCodeCheck',label:'CNPJ Regular'},{name:'adressCheck',label:'Endereço Confere'},{name:'creditDescription',label:'Registro de débito'},{name:'partnerLimit',label:'Limite Cliente',check:true},{name:'last_emission',label:'Ultima emissão',check:true},{name:'countd',label:'Quantidade de emissão(total)',check:true},{name:'last_month_emission',label:'Quantidade de emissão(ultimo mês)'},{name:'workingDays',label:'Dias Úteis'},{name:'billingPeriod',label:'Faturamento'},{name:'birthdate',label:'Data Fundação'},{name:'typeSociety',label:'Tipo Sociedade'},{name:'mulct',label:'Multa atraso'},{name:'registerDate',label:'Data Registro'},{name:'adressNumber',label:'Número Endereço'},{name:'adressComplement',label:'Complemento Endereço'},{name:'zipCode',label:'CEP'},{name:'adressDistrict',label:'Bairro'},{name:'account',label:'Tipo Cliente'},{name:'financialContact',label:'Responsavel Financeiro'},{name:'limitMargin',label:'Margem de Limite(%)'},{name:'salePlan',label:'Plano Commercial'},{name:'finnancialEmail',label:'Emails Financeiro'},{name:'interest',label:'Juros'},{name:'operationPlan',label:'Plano Multa/Custo'},{name:'dealer',label:'Representante'},{name:'daysToBoarding',label:'Dias Embarque'}];$scope.modification=[];$scope.changeFilds=function(){$scope.filteredFilds=$filter('filter')($scope.filters,true);};$scope.select=function(page){$scope.loadClient();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredClients=$filter('filter')($scope.clients,$scope.searchKeywords);return $scope.onFilterChange();};$scope.findColor=function(date,fild){if(date&&fild=='last_emission'){date=$rootScope.findDate(date);if(date!=''&&date!='Invalid Date'){date.setDate(date.getDate()+2);date.setHours(0,0,0,0);if(date>$scope.actual_date){return'#50A52F';}else{date.setDate(date.getDate()+1);if(date>$scope.actual_date){return'#D6CE62';}else{return'#E04545';}}}}};$scope.getCEP=function(){$.post("../backend/application/index.php?rota=/getCep",{data:$scope.selected},function(result){$scope.searchCep=jQuery.parseJSON(result).dataset;if($scope.searchCep.status=='success'){$scope.selected.adress=$scope.searchCep.data.logradouro;$scope.selected.adressDistrict=$scope.searchCep.data.bairro;$scope.selected.state=$scope.searchCep.data.uf;$scope.selected.city=$scope.searchCep.data.localidade;}else{logger.logError('Erro na busca pelo CEP');}$scope.$digest();});};$scope.removeClient=function(){$.post("../backend/application/index.php?rota=/removeClient",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancelEdit();});};$scope.searchRegistrationCode=function(){if($scope.selected){if($scope.selected.registrationCode){$.post("../backend/application/index.php?rota=/searchRegistrationCode",{hashId:$scope.session.hashId,data:$scope.selected,partnerType:'C'},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logError("Cliente ja cadastrado");}});}}$scope.currentSuggestions=$filter('filter')($scope.suggestions,$scope.selected.registrationCode);};$scope.showBillingPeriod=function(){if($scope.selected){return $scope.selected.billingPeriod=='Diario'||$scope.selected.billingPeriod=='Semanal'||$scope.selected.billingPeriod=='Quinzenal'||$scope.selected.billingPeriod=='Mensal'||$scope.selected.billingPeriod==''||$scope.selected.billingPeriod==undefined;}};$scope.setSelected=function(){$scope.partners=[{},{}];$('#partner_limit').number(true,2,',','.');original=angular.copy(this.client);$scope.clientDocs=[];$scope.modification=[];$scope.authorized=false;$scope.selected=this.client;if($scope.selected.last_emission){$scope.selected.last_emission=$rootScope.findDate($scope.selected.last_emission);}if($scope.selected.birthdate){$scope.selected.birthdate=$rootScope.findDate($scope.selected.birthdate);}if($scope.selected.registerDate){$scope.selected.registerDate=$rootScope.findDate($scope.selected.registerDate);}$scope.selected._status=$scope.selected.status;$scope.selected._billingPeriod=$scope.selected.billingPeriod;$scope.selected._paymentType=$scope.selected.paymentType;$scope.selected._paymentDays=$scope.selected.paymentDays;$scope.selected._partnerLimit=$scope.selected.partnerLimit;$.post("../backend/application/index.php?rota=/loadPartnersClient",{hashId:$scope.session,data:$scope.selected},function(result){$scope.partners=jQuery.parseJSON(result).dataset;for(var i in $scope.partners){if($scope.partners[i].birthdate!="")$scope.partners[i].birthdate=$rootScope.findDate($scope.partners[i].birthdate);}if($scope.partners.length<1)$scope.partners=[{},{}];else if($scope.partners.length==1)$scope.partners.push({});$scope.loadIssuers();});$scope.currentSuggestions=$filter('filter')($scope.suggestions,$scope.selected.registrationCode);$.post("../backend/application/index.php?rota=/loadSalePlans",{hashId:$scope.session,data:$scope.selected},function(result){$scope.SalePlans=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadControlPlans",$scope.session,function(result){$scope.ControlPlans=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadActualClientLimit",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.ActualLimit=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientAnalisys",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.finnacialInfo=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientDocs",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientDocs=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientNotifications",{data:$scope.selected},function(result){$scope.clientNotifications=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.loadClientRegistrionUpdates();};$scope.loadClientRegistrionUpdates=function(){$.post("../backend/application/index.php?rota=/client/loadClientRegistrionUpdates",{data:$scope.selected},function(result){$scope.clientRegistrationUpdates=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openModalRegistrationUpdate=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/client_adress_update.html",controller:'ModalRegistrationUpdateInstanceCtrl',periods:$scope.$parent.periods,resolve:{clientRegistrationUpdates:function clientRegistrationUpdates(){return $scope.clientRegistrationUpdates;},selected:function selected(){return $scope.selected;}}});};$scope.openModalCreditAnalysis=function(partner){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/credit_analysis.html",controller:'ModalCreditAnalysisCtrl',periods:$scope.periods,size:'lg',resolve:{partnerObject:function partnerObject(){return partner;}}});};$scope.setStatusNotification=function(not){$.post("../backend/application/index.php?rota=/setStatusNotification",{data:$scope.selected,notification:not},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadClientNotifications",{data:$scope.selected},function(result){$scope.clientNotifications=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.checkOurAnalisys=function(){if($scope.selected){if($scope.selected.creditAnalysis){if($scope.selected.creditAnalysis.length>=5){var score=$scope.selected.creditAnalysis.slice(2,5);}}}};$scope.registerLog=function(){$.post("../backend/application/index.php?rota=/saveCommercialProgress",{hashId:$scope.session.hashId,data:$scope.selected,progress:$scope.newProgress},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.newProgress={};$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.loadIssuers=function(){$.post("../backend/application/index.php?rota=/loadIssuers",{data:$scope.selected},function(result){$scope.issuers=jQuery.parseJSON(result).dataset;$scope.isTable=false;$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};$scope.loadFiles();$scope.$apply();});};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadClient();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadClient();};$scope.intencionToSave=function(){$scope.saveClient();};$scope.openAutorization=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/autorization.html",controller:'AutorizationCtrl',periods:$scope.periods,resolve:{main:function main(){return $scope.main;},permissions:function permissions(){return{type:'Comercial'};}}});modalInstance.result.then(function(result){$scope.authorized=result;});};$scope.saveClient=function(){$scope.selected.cityfullname=$scope.selected.city+', '+$scope.selected.state;if($scope.selected.noRegistrationCode!=true){if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){$scope.openAutorization();return logger.logError('CPF Inválido');}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){$scope.openAutorization();return logger.logError('CNPJ Inválido');}}}if($scope.selected.name.length>40&&$scope.authorized==false){$scope.openAutorization();return logger.logError('Nome da agencia nao deve ser superior a 40 caracteres');}if(!$scope.selected.adress&&$scope.authorized==false){$scope.openAutorization();return logger.logError('Endereço obrigatorio');}if(!$scope.selected.city&&$scope.authorized==false){$scope.openAutorization();return logger.logError('Estado e cidade obrigatorio');}if($scope.selected.birthdate!==""&&$scope.selected.birthdate!='Invalid Date'){$scope.selected._birthdate=$rootScope.formatServerDate($scope.selected.birthdate);}if($scope.selected.registerDate!==""&&$scope.selected.registerDate!='Invalid Date'){$scope.selected._registerDate=$rootScope.formatServerDate($scope.selected.registerDate);}var docs='';var and='';for(var i in $scope.selected.docs){if($scope.selected.docs[i].checked){docs=docs+and+$scope.selected.docs[i].id;and='_';}}$scope.selected.docsSelected=docs;for(var i in $scope.partners){if($scope.partners[i].birthdate!=="")$scope.partners[i]._birthdate=$rootScope.formatServerDate($scope.partners[i].birthdate);}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/checkRegister",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){if(jQuery.parseJSON(result).message.type=='S'){$.post("../backend/application/index.php?rota=/saveClient",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadClient();cfpLoadingBar.complete();});$scope.isTable=true;$scope.$digest();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.copyAddress=function(){$scope.selected.adressFinnancial=$scope.selected.adress;$scope.selected.adressNumberFinnancial=$scope.selected.adressNumber;$scope.selected.adressComplementFinnancial=$scope.selected.adressComplement;$scope.selected.adressDistrictFinnancial=$scope.selected.adressDistrict;$scope.selected.zipCodeFinnancial=$scope.selected.zipCode;$scope.selected.cityFinnancialState=$scope.selected.state;$scope.selected.cityFinnancialName=$scope.selected.city;};$scope.cancelEdit=function(){$scope.isTable=true;$scope.newUpload=false;$scope.mail=false;$scope.newRegister=false;$scope.loadClient();};$scope.cancelEditEmail=function(){$scope.mail=false;$scope.wemail.emailpartner='';$scope.wemail.mailcc="";$scope.wemail.subject='';$scope.wemail.emailContent='';};$scope.newClient=function(){$scope.selected={};$scope.issuers={};$scope.partners=[{},{}];$scope.selected.type='C';$scope.selected.registerDate=new Date();$scope.isTable=!$scope.isTable;$scope.newRegister=true;};$scope.loadClient=function(){$scope.newUpload=false;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClientWait",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.$digest();cfpLoadingBar.complete();});};$scope.toggleNewUpload=function(){if($scope.newUpload){$scope.newUpload=false;}else{$scope.newUpload=true;}};$scope.loadFiles=function(){$scope.filesLoaded=new FileReader();$.post("../backend/application/index.php?rota=/loadFiles",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.filesLoaded=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.fillEmailContent=function(){$scope.mail=true;$scope.selected=this.client;$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent="<br><br><br>";};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wemail,attachment:file,type:'COMERCIAL',emailType:$rootScope.emailType},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.mail=false;$scope.uploader.clearQueue();$scope.wemail={};}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.removeFile=function(file){$.post("../backend/application/index.php?rota=/removeFile",{hashId:$scope.session.hashId,data:$scope.selected,file:file},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFiles();});};$scope.addDealer=function(){$scope.selected.dealers.push({name:''});};$scope.removeDealer=function(){$scope.selected.dealers.pop();};$scope.setDocumentStatus=function(doc){$.post("../backend/application/index.php?rota=/setDocumentStatus",{hashId:$scope.session.hashId,data:$scope.selected,doc:doc},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadClientDocs",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientDocs=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.fillEmailIssuer=function(issuer){$scope.mail=true;$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent=$scope.returnLoginText(issuer);$scope.uploader.formData={hashId:$scope.session.hashId};$rootScope.emailType='EMAIL-ISSUER->'+issuer.id;};$scope.fillEmailActivation=function(){$scope.mail=true;$scope.uploader.formData={hashId:$scope.session.hashId};$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent=$scope.returnActivivationText();$rootScope.emailType='EMAIL-ACTIVATION';};$scope.findClass=function(issuer){if(!issuer.sendEmail){return'btn btn-danger smallBtn';}else{return'btn btn-info smallBtn';}};$scope.returnLoginText=function(issuer){var text="<p class='MsoNormal'><span>Seguindo com processo de ativação segue dados para acesso ao Busca Ideal.<span></span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span>Seu acesso ao Busca Ideal é o seguinte:</p>"+"<p class='MsoNormal'><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span></p>"+"<ul type='disc'>"+"<li class='MsoNormal'><span>Usuário: <b>"+issuer.name+"</b></span><span><span></span></span></li>"+"<li class='MsoNormal'><span>Senha: <b>"+issuer.name.split('.')[1]+"123</b></span><span><span></span></span></li>"+"</ul>"+"<p class='MsoNormal'><span><span class='m_-2386000081486288919gmail-apple-converted-space'><br></span></span></p>"+"<p class='MsoNormal'><span style='color: rgb(46, 116, 181);'>Link Busca Ideal:<a href='https://novo.buscaideal.com/#/login'>https://novo.buscaideal.com/#/login</a><a href='https://novo.buscaideal.com/#/login' target='_blank'></a></span><br></p>"+"<p class='MsoNormal'><span></span></p>"+"<br>"+"<p class='MsoNormal'><span>Recomendamos que no primeiro acesso seja realizado alteração da senha padrão.</span><span></span></p>"+"<p class='MsoNormal'><span>(Meus Dados &gt; Senha e Validar senha)</span><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span><span></span></p>"+"<p class='MsoNormal'><span>Anexo manual de utilização do sistema.</span><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span><span></span></p>"+"<p class='MsoNormal'><b><i>Havendo interesse na criação de outro (s) usuário (s), favor responder este e-mail com os dados abaixo:</i></b><br></p>"+"<ul type='disc'>"+"<li class='MsoNormal'><b><i><span>Nome completo:</span></i></b><span></span></li>"+"<li class='MsoNormal'><b><i><span>CPF:&nbsp;</span></i></b><span></span></li>"+"<li class='MsoNormal'><b><i><span>E-mail</span></i></b></li>"+"</ul>"+"<div><b><i><br></i></b></div>"+"<div>Atenciosamente,<br></div>";if($scope.selected.subClient){text=text.replace("Busca Ideal","VOE B2B");text=text.replace("http://buscaideal.com","http://busca.voeb2b.com.br");}return text;};$scope.returnActivivationText=function(){var text="  <p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Caro parceiro nosso cadastro foi concluído, algumas informações sobre procedimentos e contatos estão no anexo desse e-mail.</span><span><br><br><span>Atender a "+$scope.selected.name+" será um grande prazer, gostaria de desde já nos colocar à disposição para o que precisar, sejam duvidas, criticas, sugestões ou qualquer outra demanda, abaixo seguem nossos telefones de contato.</span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span><span><br></span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><i><span style='color: rgb(47, 85, 151);'>*Toda demanda inicial como envio de O.P., passagens, informativos e boletos serão enviadas nesse e-mail, havendo interesse de alteração ou inclusão de novos e-mails gentileza responder esse e-mail especificando o e-mail e o que deverá ser encaminhado.</span></i></b><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><span style='color: rgb(47, 85, 151);'><br></span></b></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><span style='color: rgb(47, 85, 151);'>Gentileza confirmar o recebimento desse e-mail (protocolo)</span></b><br></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>&nbsp;</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Fixo: &nbsp; &nbsp; &nbsp; &nbsp; (31) 3546-0800</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Celular: &nbsp;(31) 9 7150-5535</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (31) 9 9584-9761</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'>Um forte abraço e muito sucesso nessa nova parceria!<br></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span><br><span>Atenciosamente,</span><br></span></p>"+"<p></p>";if($scope.selected.subClient){text=text.replace("Busca Ideal","VOE B2B");text=text.replace("http://buscaideal.com","http://busca.voeb2b.com.br");}return text;};$scope.numPerPageOpt=[10,30,50,100,2000];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageClients=[];$rootScope.hashId=$scope.session.hashId;$scope.getFild=function(client,fild){if(new Date(client[fild])=='Invalid Date'||typeof client[fild]=="number"||client[fild]==""||client[fild].length<=9||fild=='name'){return client[fild];}else{return $filter('date')($rootScope.findDate(client[fild]),'dd/MM/yyyy');}};$scope.searchState=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});};init=function init(){$scope.actual_date=new Date();$scope.isTable=true;$scope.checkValidRoute();$scope.clientDocs=[];cfpLoadingBar.start();$scope.mail=false;$scope.showFilters=false;$scope.changeFilds();$rootScope.modalOpen=true;$scope.newProgress={};$scope.newRegister=false;$scope.suggestions=[];$scope.filter={};if($scope.main.dealer&&($scope.main.id==22091||$scope.main.id==37362||$scope.main.id==25112||$scope.main.id==28341)){$scope.filters=[{name:'name',label:'Nome',check:true},{name:'registrationCode',label:'CPF',check:true},{name:'oabNumber',label:'OAB',check:true}];$scope.changeFilds();}$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadTags",{},function(result){$scope.tags=jQuery.parseJSON(result).dataset;});$('#partnerState').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.citiesPartners=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});});$scope.loadClient();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});if(!$scope.main.dealer){$.post("../backend/application/index.php?rota=/loadClientSuggestions",{},function(result){$scope.suggestions=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clientNames=jQuery.parseJSON(result).dataset;});}$.post("../backend/application/index.php?rota=/loadDealers",$scope.session,function(result){$scope.dealers=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openSearchModal=function(){$.post("../backend/application/index.php?rota=/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"ClientsModalDemoCtrl.html",controller:'ClientsModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;},states:function states(){return $scope.states;},dealers:function dealers(){return $scope.dealers;}}});modalInstance.result.then(function(filter){filter._fromDate=$rootScope.formatServerDate(filter.fromDate);filter._toDate=$rootScope.formatServerDate(filter.toDate);filter._notFromDate=$rootScope.formatServerDate(filter.notFromDate);filter._notToDate=$rootScope.formatServerDate(filter.notToDate);filter._registerFromDate=$rootScope.formatServerDate(filter.registerFromDate);filter._registerToDate=$rootScope.formatServerDate(filter.registerToDate);$scope.loadClient();},function(){$log.info("Modal dismissed at: "+new Date());});});};$scope.generateHash=function(){$.post("../backend/application/index.php?rota=/generateHashClient",{},function(result){$scope.test=jQuery.parseJSON(result).dataset;$scope.span=true;$scope.$digest();});};return init();}]).controller('ClientsModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter','states','dealers',function($scope,$rootScope,$modalInstance,filter,states,dealers){$scope.states=states;$scope.dealers=dealers;$scope.clientStatus=['Pendente','Aprovado','Bloqueado','Reprovado','Arquivado','Analise prazo','Pendente Liberacao','Antecipado/Bloqueado'];$scope.clientPayments=['Boleto','Antecipado'];$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('IssuersDataCtrl',['$scope','$rootScope','$modal','$log','logger',function($scope,$rootScope,$modal,$log,logger){$scope.saveIssuer=function(){$.post("../backend/application/index.php?rota=/saveIssuer",{hashId:$scope.session.hashId,data:$scope.issuer_selected,client:$scope.$parent.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.loadIssuers();});};$scope.span=false;$scope.open=function(){$scope.issuer_selected=angular.copy(this.issuer);var modalInstance;modalInstance=$modal.open({templateUrl:"IssuersDataCtrl.html",controller:'IssuersModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{issuer_selected:function issuer_selected(){return $scope.issuer_selected;}}});modalInstance.result.then(function(issuer_selected){if(issuer_selected!=undefined){$scope.issuer_selected=issuer_selected;$scope.saveIssuer();}else{$scope.$parent.loadIssuers();}});};}]).controller('IssuersModalInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','issuer_selected',function($scope,$rootScope,$modalInstance,logger,issuer_selected){$scope.issuer_selected=issuer_selected;$scope.clientStatus=['Pendente','Aprovado','Bloqueado','Reprovado','Arquivado','Analise prazo','Pendente Liberacao'];$scope.ok=function(){$modalInstance.close($scope.issuer_selected);};$scope.remove=function(){$.post("../backend/application/index.php?rota=/removeIssuer",{hashId:$rootScope.hashId,data:$scope.issuer_selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(undefined);});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('ClientLogModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openClientLogModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"ClientLogModalCtrl.html",controller:'ClientLogInstanceCtrl',resolve:{}});modalInstance.result.then(function(resolve){args.resolveDescription=resolve.resolveDescription;$scope.$parent.saveClient();$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('ClientLogInstanceCtrl',['$scope','$rootScope','$modalInstance','logger',function($scope,$rootScope,$modalInstance,logger){$scope.selectedClient={resolveDescription:''};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selectedClient.resolveDescription.length<1)return logger.logError('Motivos devem ser informados');$modalInstance.close($scope.selectedClient);};}]).controller('ModalRegistrationUpdateInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','clientRegistrationUpdates','selected',function($scope,$rootScope,$modalInstance,logger,clientRegistrationUpdates,selected){$scope.clientRegistrationUpdates=clientRegistrationUpdates;$scope.selected=selected;$scope.reject=function(registration){registration.id=$scope.selected.id;$.post("../backend/application/index.php?rota=/client/rejectRegistrationUpdate",{data:registration},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.accept=function(registration){registration.id=$scope.selected.id;$.post("../backend/application/index.php?rota=/client/acceptRegistrationUpdate",{data:registration},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){"use strict";angular.module("app.saleClientArquivo",["angularFileUpload","ui.mask","ui.select"]).controller("ClientArquivoCtrl",["$scope","$rootScope","$filter","$modal","cfpLoadingBar","logger","FileUploader","$http",function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader,$http){var init;var original;$scope.clientStatus=["Pendente","Aprovado","Bloqueado","Reprovado","Arquivado","Coberto","Analise prazo","Pendente Liberacao","Antecipado/Bloqueado"];$scope.clientPayments=["Boleto","Antecipado"];$scope.clientBilling=["Diario","Semanal","Quinzenal","Mensal","Outro"];$scope.origins=["MMS","SRM"];$scope.searchKeywords="";$scope.filteredClients=[];$scope.row="";$scope.partners=[{},{}];$scope.filters=[{name:"id",label:"id",check:true},{name:"company_name",label:"Razao Social"},{name:"name",label:"Nome",check:true},{name:"registrationCode",label:"Cnpj"},{name:"city",label:"Cidade"},{name:"state",label:"Estado"},{name:"cityfullname",label:"Cidade - Estado",check:true},{name:"adress",label:"Endereço"},{name:"partnerType",label:""},{name:"email",label:"email"},{name:"phoneNumber",label:"Telefone Celular"},{name:"phoneNumber2",label:"Telefone Comercial"},{name:"phoneNumber3",label:"Telefone Residencial"},{name:"status",label:"Status",check:true},{name:"paymentType",label:"Forma de Pagamento",check:true},{name:"paymentDays",label:"Dias de Pagamento",check:true},{name:"description",label:"Observação"},{name:"creditAnalysis",label:"Score"},{name:"registrationCodeCheck",label:"CNPJ Regular"},{name:"adressCheck",label:"Endereço Confere"},{name:"creditDescription",label:"Registro de débito"},{name:"partnerLimit",label:"Limite Cliente",check:true},{name:"last_emission",label:"Ultima emissão",check:true},{name:"countd",label:"Quantidade de emissão(total)",check:true},{name:"last_month_emission",label:"Quantidade de emissão(ultimo mês)"},{name:"workingDays",label:"Dias Úteis"},{name:"billingPeriod",label:"Faturamento"},{name:"birthdate",label:"Data Fundação"},{name:"typeSociety",label:"Tipo Sociedade"},{name:"mulct",label:"Multa atraso"},{name:"registerDate",label:"Data Registro"},{name:"adressNumber",label:"Número Endereço"},{name:"adressComplement",label:"Complemento Endereço"},{name:"zipCode",label:"CEP"},{name:"adressDistrict",label:"Bairro"},{name:"account",label:"Tipo Cliente"},{name:"financialContact",label:"Responsavel Financeiro"},{name:"limitMargin",label:"Margem de Limite(%)"},{name:"salePlan",label:"Plano Commercial"},{name:"finnancialEmail",label:"Emails Financeiro"},{name:"interest",label:"Juros"},{name:"operationPlan",label:"Plano Multa/Custo"},{name:"dealer",label:"Representante"},{name:"lastCreditAnalysis",label:"Data Ultima Analise"},{name:"daysToBoarding",label:"Dias Embarque"}];$scope.modification=[];$scope.changeFilds=function(){$scope.filteredFilds=$filter("filter")($scope.filters,true);};$scope.select=function(page){$scope.loadClient();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row="";};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredClients=$filter("filter")($scope.clients,$scope.searchKeywords);return $scope.onFilterChange();};$scope.findColor=function(date,fild){if(date&&fild=="last_emission"){date=$rootScope.findDate(date);if(date!=""&&date!="Invalid Date"){date.setDate(date.getDate()+2);date.setHours(0,0,0,0);if(date>$scope.actual_date){return"#50A52F";}else{date.setDate(date.getDate()+1);if(date>$scope.actual_date){return"#D6CE62";}else{return"#E04545";}}}}};$scope.getCEP=function(){$.post("../backend/application/index.php?rota=/getCep",{data:$scope.selected},function(result){$scope.searchCep=jQuery.parseJSON(result).dataset;if($scope.searchCep.status=="success"){$scope.selected.adress=$scope.searchCep.data.logradouro;$scope.selected.adressDistrict=$scope.searchCep.data.bairro;$scope.selected.state=$scope.searchCep.data.uf;$scope.selected.city=$scope.searchCep.data.localidade;}else{logger.logError("Erro na busca pelo CEP");}$scope.$digest();});};$scope.removeClient=function(){$.post("../backend/application/index.php?rota=/removeClient",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancelEdit();});};$scope.searchRegistrationCode=function(){if($scope.selected){if($scope.selected.registrationCode){$.post("../backend/application/index.php?rota=/searchRegistrationCode",{hashId:$scope.session.hashId,data:$scope.selected,partnerType:"C"},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logError("Cliente ja cadastrado");}});}}$scope.currentSuggestions=$filter("filter")($scope.suggestions,$scope.selected.registrationCode);};$scope.showBillingPeriod=function(){if($scope.selected){return $scope.selected.billingPeriod=="Diario"||$scope.selected.billingPeriod=="Semanal"||$scope.selected.billingPeriod=="Quinzenal"||$scope.selected.billingPeriod=="Mensal"||$scope.selected.billingPeriod==""||$scope.selected.billingPeriod==undefined;}};$scope.setSelected=function(){$scope.partners=[{},{}];$("#partner_limit").number(true,2,",",".");original=angular.copy(this.client);$scope.clientDocs=[];$scope.modification=[];$scope.authorized=false;$scope.selected=this.client;if($scope.selected.last_emission){$scope.selected.last_emission=$rootScope.findDate($scope.selected.last_emission);}if($scope.selected.birthdate){$scope.selected.birthdate=$rootScope.findDate($scope.selected.birthdate);}if($scope.selected.registerDate){$scope.selected.registerDate=$rootScope.findDate($scope.selected.registerDate);}if($scope.selected.lastCreditAnalysis){$scope.selected._lastCreditAnalysis=$rootScope.findDate($scope.selected.lastCreditAnalysis);}$scope.selected._status=$scope.selected.status;$scope.selected._billingPeriod=$scope.selected.billingPeriod;$scope.selected._paymentType=$scope.selected.paymentType;$scope.selected._paymentDays=$scope.selected.paymentDays;$scope.selected._partnerLimit=$scope.selected.partnerLimit;$.post("../backend/application/index.php?rota=/loadPartnersClient",{hashId:$scope.session,data:$scope.selected},function(result){$scope.partners=jQuery.parseJSON(result).dataset;for(var i in $scope.partners){if($scope.partners[i].birthdate!="")$scope.partners[i].birthdate=$rootScope.findDate($scope.partners[i].birthdate);}if($scope.partners.length<1)$scope.partners=[{},{}];else if($scope.partners.length==1)$scope.partners.push({});$scope.loadIssuers();});$scope.currentSuggestions=$filter("filter")($scope.suggestions,$scope.selected.registrationCode);$.post("../backend/application/index.php?rota=/loadSalePlans",{hashId:$scope.session,data:$scope.selected},function(result){$scope.SalePlans=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadControlPlans",$scope.session,function(result){$scope.ControlPlans=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadActualClientLimit",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.ActualLimit=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientAnalisys",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.finnacialInfo=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientDocs",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientDocs=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientNotifications",{data:$scope.selected},function(result){$scope.clientNotifications=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadCupons",{data:$scope.selected},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.loadClientRegistrionUpdates();};$scope.loadClientRegistrionUpdates=function(){$.post("../backend/application/index.php?rota=/client/loadClientRegistrionUpdates",{data:$scope.selected},function(result){$scope.clientRegistrationUpdates=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openModalRegistrationUpdate=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/client_adress_update.html",controller:"ModalRegistrationUpdateInstanceCtrl",periods:$scope.$parent.periods,resolve:{clientRegistrationUpdates:function clientRegistrationUpdates(){return $scope.clientRegistrationUpdates;},selected:function selected(){return $scope.selected;}}});};$scope.openModalCreditAnalysis=function(partner){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/credit_analysis.html",controller:"ModalCreditAnalysisCtrl",periods:$scope.periods,size:"lg",resolve:{partnerObject:function partnerObject(){return partner;}}});};$scope.setStatusNotification=function(not){$.post("../backend/application/index.php?rota=/setStatusNotification",{data:$scope.selected,notification:not},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadClientNotifications",{data:$scope.selected},function(result){$scope.clientNotifications=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.checkOurAnalisys=function(){if($scope.selected){if($scope.selected.creditAnalysis){if($scope.selected.creditAnalysis.length>=5){var score=$scope.selected.creditAnalysis.slice(2,5);}}}};$scope.registerLog=function(){$.post("../backend/application/index.php?rota=/saveCommercialProgress",{hashId:$scope.session.hashId,data:$scope.selected,progress:$scope.newProgress},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.newProgress={};$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.loadIssuers=function(){$.post("../backend/application/index.php?rota=/loadIssuers",{data:$scope.selected},function(result){$scope.issuers=jQuery.parseJSON(result).dataset;$scope.isTable=false;$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};$scope.loadFiles();$scope.$apply();});};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadClient();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadClient();};$scope.intencionToSave=function(){$scope.saveClient();};$scope.openAutorization=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/autorization.html",controller:"AutorizationCtrl",periods:$scope.periods,resolve:{main:function main(){return $scope.main;},permissions:function permissions(){return{type:"Comercial"};}}});modalInstance.result.then(function(result){$scope.authorized=result;});};$scope.analiseAntiga=function(date,registerDate){if(date){if(date!==""&&date!="Invalid Date"){var data=new Date();data.setMonth(data.getMonth()-6);if(date<data){return true;}}}if(registerDate){if(registerDate!==""&&registerDate!="Invalid Date"){var data=new Date();data.setMonth(data.getMonth()-6);if(registerDate<data){return true;}}}return false;};$scope.saveClient=function(){$scope.selected.cityfullname=$scope.selected.city+", "+$scope.selected.state;if($scope.selected.noRegistrationCode!=true){if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){$scope.openAutorization();return logger.logError("CPF Inválido");}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){$scope.openAutorization();return logger.logError("CNPJ Inválido");}}}if($scope.selected.name.length>40&&$scope.authorized==false){$scope.openAutorization();return logger.logError("Nome da agencia nao deve ser superior a 40 caracteres");}if(!$scope.selected.adress&&$scope.authorized==false){$scope.openAutorization();return logger.logError("Endereço obrigatorio");}if(!$scope.selected.city&&$scope.authorized==false){$scope.openAutorization();return logger.logError("Estado e cidade obrigatorio");}if($scope.selected.birthdate){if($scope.selected.birthdate!==""&&$scope.selected.birthdate!="Invalid Date"){$scope.selected._birthdate=$rootScope.formatServerDate($scope.selected.birthdate);}}if($scope.selected._lastCreditAnalysis){if($scope.selected._lastCreditAnalysis!==""&&$scope.selected._lastCreditAnalysis!="Invalid Date"){$scope.selected.lastCreditAnalysis=$rootScope.formatServerDate($scope.selected._lastCreditAnalysis);}}if($scope.selected.registerDate!==""&&$scope.selected.registerDate!="Invalid Date"){$scope.selected._registerDate=$rootScope.formatServerDate($scope.selected.registerDate);}var docs="";var and="";for(var i in $scope.selected.docs){if($scope.selected.docs[i].checked){docs=docs+and+$scope.selected.docs[i].id;and="_";}}$scope.selected.docsSelected=docs;if($scope.selected.partnerData){if($scope.selected.partnerData._birthDate!==""&&$scope.selected.partnerData._birthDate!="Invalid Date"){$scope.selected.partnerData.birthDate=$rootScope.formatServerDate($scope.selected.partnerData._birthDate);}}for(var i in $scope.partners){if($scope.partners[i].birthdate){if($scope.partners[i].birthdate!==""&&$scope.partners[i].birthdate!="Invalid Date"){$scope.partners[i]._birthdate=$rootScope.formatServerDate($scope.partners[i].birthdate);}}}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/checkRegister",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){if(jQuery.parseJSON(result).message.type=="S"){$.post("../backend/application/index.php?rota=/saveClient",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadClient();cfpLoadingBar.complete();});$scope.isTable=true;$scope.$digest();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.copyAddress=function(){$scope.selected.adressFinnancial=$scope.selected.adress;$scope.selected.adressNumberFinnancial=$scope.selected.adressNumber;$scope.selected.adressComplementFinnancial=$scope.selected.adressComplement;$scope.selected.adressDistrictFinnancial=$scope.selected.adressDistrict;$scope.selected.zipCodeFinnancial=$scope.selected.zipCode;$scope.selected.cityFinnancialState=$scope.selected.state;$scope.selected.cityFinnancialName=$scope.selected.city;};$scope.cancelEdit=function(){$scope.isTable=true;$scope.newUpload=false;$scope.mail=false;$scope.newRegister=false;$scope.loadClient();};$scope.cancelEditEmail=function(){$scope.mail=false;$scope.wemail.emailpartner="";$scope.wemail.mailcc="";$scope.wemail.subject="";$scope.wemail.emailContent="";};$scope.newClient=function(){$scope.selected={};$scope.issuers={};$scope.partners=[{},{}];$scope.selected.type="C";$scope.selected.registerDate=new Date();$scope.isTable=!$scope.isTable;$scope.newRegister=true;};$scope.loadClient=function(){$scope.newUpload=false;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClientArquivo",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.$digest();cfpLoadingBar.complete();});};$scope.toggleNewUpload=function(){if($scope.newUpload){$scope.newUpload=false;}else{$scope.newUpload=true;}};$scope.loadFiles=function(){$scope.filesLoaded=new FileReader();$.post("../backend/application/index.php?rota=/loadFiles",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.filesLoaded=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.fillEmailContent=function(){$scope.mail=true;$scope.selected=this.client;$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - One Milhas";$scope.wemail.emailContent="<br><br><br>";};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wemail,attachment:file,type:"COMERCIAL",emailType:$rootScope.emailType},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.mail=false;$scope.uploader.clearQueue();$scope.wemail={};}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.resetPassword=function(){$.post("../backend/application/index.php?rota=/busca/resetPassword",{data:$scope.selected},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.removeFile=function(file){$.post("../backend/application/index.php?rota=/removeFile",{hashId:$scope.session.hashId,data:$scope.selected,file:file},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFiles();});};$scope.addDealer=function(){$scope.selected.dealers.push({name:""});};$scope.removeDealer=function(){$scope.selected.dealers.pop();};$scope.setDocumentStatus=function(doc){$.post("../backend/application/index.php?rota=/setDocumentStatus",{hashId:$scope.session.hashId,data:$scope.selected,doc:doc},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadClientDocs",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientDocs=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.fillEmailIssuer=function(issuer){$scope.mail=true;$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent=$scope.returnLoginText(issuer);$scope.uploader.formData={hashId:$scope.session.hashId};$rootScope.emailType="EMAIL-ISSUER->"+issuer.id;};$scope.fillEmailActivation=function(){$scope.mail=true;$scope.uploader.formData={hashId:$scope.session.hashId};$scope.wemail.emailpartner=$scope.selected.email;$scope.wemail.mailcc="";$scope.wemail.subject="[COMERCIAL] - ONE MILHAS";$scope.wemail.emailContent=$scope.returnActivivationText();$rootScope.emailType="EMAIL-ACTIVATION";};$scope.findClass=function(issuer){if(!issuer.sendEmail){return"btn btn-danger smallBtn";}else{return"btn btn-info smallBtn";}};$scope.editCupom=function(_cupom2){var modalInstance;modalInstance=$modal.open({templateUrl:"CupomDataCtrl.html",controller:"CupomModalInstanceCtrl",periods:$scope.periods,resolve:{cupom:function cupom(){return _cupom2;}}});modalInstance.result.then(function(issuer_selected){$.post("../backend/application/index.php?rota=/loadCupons",{data:$scope.selected},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;});});};$scope.openCupomModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"CupomDataCtrl.html",controller:"CupomModalInstanceCtrl",periods:$scope.periods,resolve:{cupom:function cupom(){return{client_id:$scope.selected.id};}}});modalInstance.result.then(function(issuer_selected){$.post("../backend/application/index.php?rota=/loadCupons",{data:$scope.selected},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;});});};$scope.returnLoginText=function(issuer){var text="<p class='MsoNormal'><span>Seguindo com processo de ativação segue dados para acesso ao Busca Ideal.<span></span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span>Seu acesso ao Busca Ideal é o seguinte:</p>"+"<p class='MsoNormal'><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span></p>"+"<ul type='disc'>"+"<li class='MsoNormal'><span>Usuário: <b>"+$scope.selected.prefixo+".admin</b></span><span><span></span></span></li>"+"<li class='MsoNormal'><span>Senha: <b>admin123</b></span><span><span></span></span></li>"+"</ul>"+"<p class='MsoNormal'><span><span class='m_-2386000081486288919gmail-apple-converted-space'><br></span></span></p>"+"<p class='MsoNormal'><span style='color: rgb(46, 116, 181);'>Link Busca Ideal:<a href='https://busca.buscaideal.com.br'>https://busca.buscaideal.com.br</a><a href='https://busca.buscaideal.com.br' target='_blank'></a></span><br></p>"+"<p class='MsoNormal'><span></span></p>"+"<br>"+"<p class='MsoNormal'><span>Recomendamos que no primeiro acesso seja realizado alteração da senha padrão.</span><span></span></p>"+"<p class='MsoNormal'><span>(Meus Dados &gt; Senha e Validar senha)</span><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span><span></span></p>"+"<p class='MsoNormal'><span>Anexo manual de utilização do sistema.</span><span></span></p>"+"<p class='MsoNormal'><span>&nbsp;</span><span></span></p>"+"<p class='MsoNormal'><b><i>Para criação de novos logins, utilize a aba minha conta em seu login master</i></b><br></p>"+"<div><b><i><br></i></b></div>"+"<div>Atenciosamente,<br></div>";if($scope.selected.subClient){text=text.replace("Busca Ideal","VOE B2B");text=text.replace("http://buscaideal.com","http://busca.voeb2b.com.br");}return text;};$scope.returnActivivationText=function(){var text="  <p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Caro parceiro nosso cadastro foi concluído, algumas informações sobre procedimentos e contatos estão no anexo desse e-mail.</span><span><br><br><span>Atender a "+$scope.selected.name+" será um grande prazer, gostaria de desde já nos colocar à disposição para o que precisar, sejam duvidas, criticas, sugestões ou qualquer outra demanda, abaixo seguem nossos telefones de contato.</span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span><span><br></span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><i><span style='color: rgb(47, 85, 151);'>*Toda demanda inicial como envio de O.P., passagens, informativos e boletos serão enviadas nesse e-mail, havendo interesse de alteração ou inclusão de novos e-mails gentileza responder esse e-mail especificando o e-mail e o que deverá ser encaminhado.</span></i></b><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><span style='color: rgb(47, 85, 151);'><br></span></b></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><b><span style='color: rgb(47, 85, 151);'>Gentileza confirmar o recebimento desse e-mail (protocolo)</span></b><br></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span></span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>&nbsp;</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Fixo: &nbsp; &nbsp; &nbsp; &nbsp; (31) 3972-9601</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>Celular: &nbsp;(31) 9 7150-5535</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (31) 9 9584-9761</span></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'>Um forte abraço e muito sucesso nessa nova parceria!<br></p>"+"<p style='color: rgb(34, 34, 34);background-color: rgb(255, 255, 255);'><span><br><span>Atenciosamente,</span><br></span></p>"+"<p></p>";if($scope.selected.subClient){text=text.replace("Busca Ideal","VOE B2B");text=text.replace("http://buscaideal.com","http://busca.voeb2b.com.br");}return text;};$scope.numPerPageOpt=[10,30,50,100,2000];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageClients=[];$rootScope.hashId=$scope.session.hashId;$scope.getFild=function(client,fild){if(new Date(client[fild])=="Invalid Date"||typeof client[fild]=="number"||client[fild]==""||client[fild].length<=9||fild=="name"){return client[fild];}else{return $filter("date")($rootScope.findDate(client[fild]),"dd/MM/yyyy");}};$scope.searchState=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});};init=function init(){$scope.actual_date=new Date();$scope.isTable=true;$scope.checkValidRoute();$scope.clientDocs=[];cfpLoadingBar.start();$scope.mail=false;$scope.showFilters=false;$scope.changeFilds();$rootScope.modalOpen=true;$scope.newProgress={};$scope.newRegister=false;$scope.suggestions=[];$scope.filter={};if($scope.main.dealer&&($scope.main.id==22091||$scope.main.id==37362||$scope.main.id==25112||$scope.main.id==28341)){$scope.filters=[{name:"name",label:"Nome",check:true},{name:"registrationCode",label:"CPF",check:true},{name:"oabNumber",label:"OAB",check:true}];$scope.changeFilds();}$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadTags",{},function(result){$scope.tags=jQuery.parseJSON(result).dataset;});$("#partnerState").on("blur",function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.citiesPartners=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});});$scope.loadClient();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:"customFilter",fn:function fn(item,options){return this.queue.length<10;}});if(!$scope.main.dealer){$.post("../backend/application/index.php?rota=/loadClientSuggestions",{},function(result){$scope.suggestions=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clientNames=jQuery.parseJSON(result).dataset;});}$.post("../backend/application/index.php?rota=/loadDealers",$scope.session,function(result){$scope.dealers=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openSearchModal=function(){$.post("../backend/application/index.php?rota=/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"ClientsModalDemoCtrl.html",controller:"ClientsModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;},states:function states(){return $scope.states;},dealers:function dealers(){return $scope.dealers;}}});modalInstance.result.then(function(filter){filter._fromDate=$rootScope.formatServerDate(filter.fromDate);filter._toDate=$rootScope.formatServerDate(filter.toDate);filter._notFromDate=$rootScope.formatServerDate(filter.notFromDate);filter._notToDate=$rootScope.formatServerDate(filter.notToDate);filter._registerFromDate=$rootScope.formatServerDate(filter.registerFromDate);filter._registerToDate=$rootScope.formatServerDate(filter.registerToDate);$scope.loadClient();},function(){$log.info("Modal dismissed at: "+new Date());});});};$scope.generateHash=function(){$.post("../backend/application/index.php?rota=/generateHashClient",{},function(result){$scope.test=jQuery.parseJSON(result).dataset;$scope.span=true;$scope.$digest();});};return init();}]).controller("CupomModalInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","cupom",function($scope,$rootScope,$modalInstance,logger,cupom){$scope.cupom=cupom;$scope.ok=function(){$scope.cupom.dataExpiracao=$rootScope.formatServerDate($scope.cupom._dataExpiracao);$.post("../backend/application/index.php?rota=/saveCupons",{data:$scope.cupom},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(true);});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("ClientsModalInstanceCtrl",["$scope","$rootScope","$modalInstance","filter","states","dealers",function($scope,$rootScope,$modalInstance,filter,states,dealers){$scope.states=states;$scope.dealers=dealers;$scope.clientStatus=["Pendente","Aprovado","Bloqueado","Reprovado","Arquivado","Analise prazo","Pendente Liberacao","Antecipado/Bloqueado"];$scope.clientPayments=["Boleto","Antecipado"];$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("IssuersDataCtrl",["$scope","$rootScope","$modal","$log","logger",function($scope,$rootScope,$modal,$log,logger){$scope.saveIssuer=function(){$.post("../backend/application/index.php?rota=/saveIssuer",{hashId:$scope.session.hashId,data:$scope.issuer_selected,client:$scope.$parent.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.loadIssuers();});};$scope.span=false;$scope.open=function(){$scope.issuer_selected=angular.copy(this.issuer);var modalInstance;modalInstance=$modal.open({templateUrl:"IssuersDataCtrl.html",controller:"IssuersModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{issuer_selected:function issuer_selected(){return $scope.issuer_selected;}}});modalInstance.result.then(function(issuer_selected){if(issuer_selected!=undefined){$scope.issuer_selected=issuer_selected;$scope.saveIssuer();}else{$scope.$parent.loadIssuers();}});};}]).controller("IssuersModalInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","issuer_selected",function($scope,$rootScope,$modalInstance,logger,issuer_selected){$scope.issuer_selected=issuer_selected;$scope.clientStatus=["Pendente","Aprovado","Bloqueado","Reprovado","Arquivado","Analise prazo","Pendente Liberacao"];$scope.ok=function(){$modalInstance.close($scope.issuer_selected);};$scope.remove=function(){$.post("../backend/application/index.php?rota=/removeIssuer",{hashId:$rootScope.hashId,data:$scope.issuer_selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(undefined);});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("ClientLogModalCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on("openClientLogModal",function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"ClientLogModalCtrl.html",controller:"ClientLogInstanceCtrl",resolve:{}});modalInstance.result.then(function(resolve){args.resolveDescription=resolve.resolveDescription;$scope.$parent.saveClient();$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller("ClientLogInstanceCtrl",["$scope","$rootScope","$modalInstance","logger",function($scope,$rootScope,$modalInstance,logger){$scope.selectedClient={resolveDescription:""};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selectedClient.resolveDescription.length<1)return logger.logError("Motivos devem ser informados");$modalInstance.close($scope.selectedClient);};}]).controller("ModalRegistrationUpdateInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","clientRegistrationUpdates","selected",function($scope,$rootScope,$modalInstance,logger,clientRegistrationUpdates,selected){$scope.clientRegistrationUpdates=clientRegistrationUpdates;$scope.selected=selected;$scope.reject=function(registration){registration.id=$scope.selected.id;$.post("../backend/application/index.php?rota=/client/rejectRegistrationUpdate",{data:registration},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.accept=function(registration){registration.id=$scope.selected.id;$.post("../backend/application/index.php?rota=/client/acceptRegistrationUpdate",{data:registration},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();(function(){'use strict';angular.module('app.wizardpurchase',['ui.utils.masks']).controller('WizardPurchaseCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var providerSelected;$scope.accountType=[{type:'Conta Corrente'},{type:'Conta Poupança'}];$scope.nextWizardStage=function(){$scope.tabindex=$scope.tabindex+1;return $scope.tabindex;};$scope.priorWizardStage=function(){$scope.tabindex=$scope.tabindex-1;return $scope.tabindex;};$scope.WizardStageProgress=function(){return($scope.tabindex+1)*20;};$scope.validateProvidersFields=function(){if($scope.wpurchase_formprovider.$valid){$scope.wpurchase.contract_due_date=new Date();$scope.wpurchase.contract_due_date.setDate($scope.wpurchase.contract_due_date.getDate()+120);$scope.wpurchase.cityfullname=$scope.wpurchase.city+', '+$scope.wpurchase.state;$.post("../backend/application/index.php?rota=/loadPurchaseHistory",{hashId:$scope.session.hashId,data:$scope.wpurchase},function(result){$scope.purchaseHistory=jQuery.parseJSON(result).dataset;$scope.$apply();});$scope.wpurchase.paymentMethod='prepaid';$('#purchase_miles').number(true,0,',','.');$("#cost_per_thousand").maskMoney({thousands:'.',decimal:',',precision:2});$('#total_cost').number(true,2,',','.');return $scope.nextWizardStage();}};$scope.findDate=function(date){return new Date(date);};$scope.validPurchaseFields=function(){if($scope.wpurchase.paymentMethod!='after_use'){if(!$scope.wpurchase.pay_date||$scope.wpurchase.pay_date==""||$scope.wpurchase.pay_date=='Invalid Date'){return logger.logError('Data de pagamento obrigatoria');}}if($scope.wpurchase.airline=='LATAM'){if($scope.wpurchase.onlyInter==null||$scope.wpurchase.onlyInter=='null'){return logger.logError('Tipo de emissão obrigatorio!');}}if($scope.wpurchase_formpurchase.$valid){return $scope.tabindex=3;}};$scope.validCardsFields=function(){if($scope.wpurchase_formcard.$valid){return $scope.nextWizardStage();}};$scope.fillProvidersFields=function(){if(!($scope.wpurchase==undefined)){providerSelected=$scope.provider_index($scope.wpurchase.registrationCode);if(!(providerSelected==undefined)){if($scope.providers[providerSelected].status=='Bloqueado'){logger.logError('Fornecedor bloqueado para compra: '+$scope.providers[providerSelected].blockreason);return false;}else{$scope.wpurchase.provider_id=$scope.providers[providerSelected].id;$scope.wpurchase.name=$scope.providers[providerSelected].name;$scope.wpurchase.registrationCode=$scope.providers[providerSelected].registrationCode;$scope.wpurchase.adress=$scope.providers[providerSelected].adress;$scope.wpurchase.state=$scope.providers[providerSelected].state;$scope.wpurchase.city=$scope.providers[providerSelected].city;$scope.wpurchase.email=$scope.providers[providerSelected].email;$scope.wpurchase.phoneNumber=$scope.providers[providerSelected].phoneNumber;$scope.wpurchase.phoneNumber2=$scope.providers[providerSelected].phoneNumber2;$scope.wpurchase.phoneNumber3=$scope.providers[providerSelected].phoneNumber3;$scope.wpurchase.bank=$scope.providers[providerSelected].bank;$scope.wpurchase.agency=$scope.providers[providerSelected].agency;$scope.wpurchase.account=$scope.providers[providerSelected].account;$scope.wpurchase.card_number=$scope.providers[providerSelected].registrationCode;$scope.wpurchase.paymentType=$scope.providers[providerSelected].paymentType;$scope.wpurchase.description=$scope.providers[providerSelected].description;$scope.wpurchase.phoneNumberAirline=$scope.providers[providerSelected].phoneNumberAirline;$scope.wpurchase.celNumberAirline=$scope.providers[providerSelected].celNumberAirline;}}}return $scope.nextWizardStage();};$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.ecript=function(code){if(code!=undefined){var data=code.split('');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;}};$scope.fillCardsFields=function(){if(!$scope.wpurchase.airline==''){$.post("../backend/application/index.php?rota=/loadProviderAirlineCard",{hashId:$scope.session.hashId,name:$scope.wpurchase.name,airline:$scope.wpurchase.airline},function(result){$scope.card=jQuery.parseJSON(result).dataset;if(!($scope.card[0]==undefined)){$scope.wpurchase.card_number=$scope.card[0].card_number;$scope.wpurchase.access_password=$scope.decript($scope.card[0].access_password);$scope.wpurchase.access_id=$scope.card[0].access_id;$scope.wpurchase.recovery_password=$scope.decript($scope.card[0].recovery_password);}});}};$scope.getTotalPurchased=function(){var total=0;if($scope.purchaseHistory!=undefined){if($scope.purchaseHistory.length>0){for(var i in $scope.purchaseHistory){total+=$scope.purchaseHistory[i].leftover;}}}return total;};$scope.provider_index=function(providerName){if(!providerName==''){for(var i=0;i<$scope.providers.length;i++){if($scope.providers[i].registrationCode==providerName){return i;}}}};$scope.setTotalCost=function(){var purchase_miles=parseFloat($scope.wpurchase.purchase_miles);$scope.wpurchase.total_cost=parseFloat(($scope.wpurchase.cost_per_thousand*(purchase_miles/1000)).toFixed(2));};$scope.setCosPerThousand=function(){$scope.wpurchase.cost_per_thousand=$scope.wpurchase.total_cost/($scope.wpurchase.purchase_miles/1000);};$scope.savePurchase=function(){$scope.wpurchase._miles_due_date=$rootScope.formatServerDate($scope.wpurchase.miles_due_date);$scope.wpurchase._contract_due_date=$rootScope.formatServerDate($scope.wpurchase.contract_due_date);if($scope.wpurchase.pay_date!==""&&$scope.wpurchase.pay_date!='Invalid Date'){$scope.wpurchase._pay_date=$rootScope.formatServerDate($scope.wpurchase.pay_date);}$scope.wpurchase.accessPassword=$scope.ecript($scope.wpurchase.accessPassword);for(var i in $scope.milesDueDate){if($scope.milesDueDate[i].dueDate!==""&&$scope.milesDueDate[i].dueDate!='Invalid Date'){$scope.milesDueDate[i]._dueDate=$rootScope.formatServerDate($scope.milesDueDate[i].dueDate);}}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/savePurchase",{hashId:$scope.session.hashId,data:$scope.wpurchase,milesDivisions:$scope.milesDueDate},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});cfpLoadingBar.complete();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.addDueDate=function(){if($scope.milesDueDate.length<3){$scope.milesDueDate.push({miles:0,dueDate:new Date()});}};$scope.removeDueDate=function(){$scope.milesDueDate.pop();};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.milesDueDate=[];$scope.wpurchase={onlyInter:'null'};cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadAirline",$scope.session,function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});$('#wpurchaseairline').on('blur',function(obj,datum){$scope.fillCardsFields();});$('#wpurchasestate').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.wpurchase.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;});});};$scope.searchProvider=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadProvider",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.wpurchase.registrationCode},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();cfpLoadingBar.complete();});};return init();}]);})();;(function(){'use strict';angular.module('app.billsPayList',['ui.utils.masks']).controller('BillsPayCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.accountType=['Taxa DU','Taxa Extra','Taxa Aeroporto','Reembolso','Milhas + Money','Contas Comuns','Taxas'];$scope.paymentType=['Cartão de Crédito','Deposito em Conta','Boleto Bancario','Reembolso'];$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.searchKeywords='';$scope.filteredBillsPay=[];$scope.row='';$scope.select=function(page){$scope.loadBillsPay();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.loadBillsPay();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.setSelected=function(){$scope.selected=this.billpay;$scope.tabindex=1;return $scope.selected;};$scope.getStatusDesc=function(status){if(status=='B'){return'Baixada';}else{return'Em Aberto';}};$scope.billPayTag=function(status){if(status=='B'){return"label label-success";}else{return"label label-warning";}};$scope.addRow=function(){if(this.billpay.status=='B'){this.billpay.checked=false;}};$scope.loadSynthetic=function(){$.post("../backend/application/index.php?rota=/billspay/loadSynthetic",{data:$scope.filter},function(result){$scope.data=jQuery.parseJSON(result).dataset;var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(18);var columns=[{title:"Valor",dataKey:"value"},{title:"Quantidade",dataKey:"quant"},{title:"Cartão",dataKey:"card_number"}];var rows=[];doc.autoTable(columns,$scope.data,{theme:'grid',styles:{fontSize:8,overflow:'linebreak'},startY:90,margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='value'){cell.styles.halign='right';}}});doc.save('sintetico.pdf');});};$scope.loadAnalytical=function(){$.post("../backend/application/index.php?rota=/billspay/loadAnalytical",{data:$scope.filter},function(result){$scope.data=jQuery.parseJSON(result).dataset;var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(18);var columns=[{title:"Cartão",dataKey:"card_number"},{title:"Data",dataKey:"issue_date"},{title:"Companhia",dataKey:"airline_name"},{title:"Valor",dataKey:"amount_paid"}];var obj={card_number:$scope.filter.credit_card,issue_date:'De '+$scope.filter.dueDateFrom.getDate()+'/'+$scope.filter.dueDateFrom.getMonth()+1};if($scope.filter.dueDateTo){obj['airline_name']=' a '+$scope.filter.dueDateTo.getDate()+'/'+$scope.filter.dueDateTo.getMonth()+1;}$scope.data.unshift(obj);doc.autoTable(columns,$scope.data,{theme:'grid',styles:{fontSize:8,overflow:'linebreak'},startY:90,margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='value'){cell.styles.halign='right';}}});doc.save('analitico.pdf');});};$scope.search=function(){$scope.filteredBillsPay=$filter('filter')($scope.billspay,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadBillsPay();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadBillsPay();};$scope.loadData=function(){$.post("../backend/application/index.php?rota=/loadSumOpenedBillsPay",{data:$scope.filter},function(result){$scope.sumOpenedbillspay=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadSumClosedBillsPay",{data:$scope.filter},function(result){$scope.sumClosedbillspay=jQuery.parseJSON(result).dataset;});$scope.loadBillsPay();};$scope.loadBillsPay=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadBillsPay",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.billspays=jQuery.parseJSON(result).dataset.billspay;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.$digest();});};$scope.loadFixed=function(){$.post("../backend/application/index.php?rota=/loadFixedBillsPay",{},function(result){$scope.fixedBillsPay=jQuery.parseJSON(result).dataset;$scope.searchFixedBillsPay();$scope.loadEvents();$scope.selectFixedBillsPay($scope.currentPageFixed);});$.post("../backend/application/index.php?rota=/loadChartCalendarBillsPay",{},function(result){$scope.chartCalendar=jQuery.parseJSON(result).dataset;});};$scope.searchFixedBillsPay=function(){$scope.filteredFixedBillsPay=$filter('filter')($scope.fixedBillsPay,$scope.searchKeywords);return $scope.onFilterChange();};$scope.toggleFormTable=function(){$scope.tabindex=0;};$scope.selectFixedBillsPay=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageFixedBillsPay=$scope.filteredFixedBillsPay.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChangeFixedBillsPay=function(){$scope.select(1);return $scope.currentPage=1;};$scope.saveClosePay=function(){$scope.checkedrows=$filter('filter')($scope.billspay,true);$.post("../backend/application/index.php?rota=/saveClosePay",{hashId:$scope.session.hashId,checkedrows:$scope.checkedrows},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadData();return $scope.select($scope.currentPage);});};$scope.saveBillPay=function(){$scope.checkedrows=$filter('filter')($scope.billspay,true);$scope.selected.actual_value=$('#bpay_actualvalue').maskMoney('unmasked')[0];$scope.selected.tax=$('#bpay_tax').maskMoney('unmasked')[0];$scope.selected.discount=$('#bpay_discount').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/saveBillPay",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.loadData();return $scope.select($scope.currentPage);});};$scope.setActual_Value=function(){$scope.selected.actual_value=parseFloat($scope.selected.original_value)+parseFloat($scope.selected.tax)-parseFloat($scope.selected.discount);};$scope.findDate=function(date){var actualDate=new Date(date);actualDate.setDate(actualDate.getDate()+1);return actualDate;};$scope.returnDate=function(date){return new Date(date);};$scope.newBill=function(){$scope.tabindex=2;$('#value').number(true,2,',','.');};$scope.generateBill=function(){$scope.billpay._dueDate=$rootScope.formatServerDate($scope.billpay.due_date);$.post("../backend/application/index.php?rota=/generateBill",{hashId:$scope.session.hashId,data:$scope.billpay},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadData();});$scope.back();};$scope.back=function(){$scope.tabindex=0;$scope.billpay=undefined;};$scope.loadEvents=function(view){$.post("../backend/application/index.php?rota=/loadEventsBillsPay",{},function(result){$scope.eventsLoaded=jQuery.parseJSON(result).dataset;for(var i in $scope.events){$scope.events.splice(i,1);}for(var i in $scope.eventsLoaded){$scope.eventsLoaded[i].start=new Date($scope.eventsLoaded[i].start);if($scope.eventsLoaded[i].end!=''){$scope.eventsLoaded[i].end=new Date($scope.eventsLoaded[i].end);}$scope.events.push($scope.eventsLoaded[i]);}for(var i in $scope.fixedBillsPay){$scope.fixedBillsPay[i].start=new Date();$scope.fixedBillsPay[i].date=new Date($scope.fixedBillsPay[i].date);$scope.fixedBillsPay[i].start.setDate($scope.fixedBillsPay[i].date.getDate());if(view){$scope.fixedBillsPay[i].start.setMonth($scope.getMonth(view));}var object={title:$scope.fixedBillsPay[i].title,start:$scope.fixedBillsPay[i].start,allDay:true};$scope.events.push(object);}$scope.$digest();});};$scope.AddFixed=function(){$rootScope.$emit('openFixedBillsPayModal',{});};$scope.setSelectedFixed=function(fixed){fixed.date=new Date(fixed.date);$rootScope.$emit('openFixedBillsPayModal',fixed);};$scope.toCalendar=function(){$scope.tabindex=3;$scope.loadEvents();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBillsPay=[];$scope.numPerPageFixedBillsPay=$scope.numPerPageOpt[2];$scope.currentPageFixed=1;$scope.currentPageFixedBillsPay=[];$rootScope.hashId=$scope.session.hashId;init=function init(){$scope.tabindex=0;$scope.checkValidRoute();$scope.loadData();$rootScope.modalOpen=false;$scope.chartCalendar=[];$scope.loadFixed();$('#calendar').fullCalendar({googleCalendarApiKey:'AIzaSyAAtkhpiuH-hBzvaGp8QP6C_VqBlE37t6I'});};$scope.getMonth=function(date){if(date.title.indexOf('January')>-1)return 0;if(date.title.indexOf('February')>-1)return 1;if(date.title.indexOf('March')>-1)return 2;if(date.title.indexOf('April')>-1)return 3;if(date.title.indexOf('May')>-1)return 4;if(date.title.indexOf('June')>-1)return 5;if(date.title.indexOf('July')>-1)return 6;if(date.title.indexOf('August')>-1)return 7;if(date.title.indexOf('September')>-1)return 8;if(date.title.indexOf('October')>-1)return 9;if(date.title.indexOf('November')>-1)return 10;if(date.title.indexOf('December')>-1)return 11;};$scope.events=[];$scope.uiConfigBillsPay={calendar:{lang:'pt-br',height:550,editable:true,customButtons:{myCustomButton:{text:'+',click:function click(){$rootScope.$emit('openCalendarBillsPayModal',{allDay:true});}}},viewRender:function viewRender(view,element){$scope.loadEvents(view);},header:{left:'month agendaWeek agendaDay, myCustomButton',center:'',right:'prev,next today'},eventClick:function eventClick(date,jsEvent,view){$scope.alertEventOnClick(date,jsEvent,view);},eventDrop:function eventDrop(event,delta,revertFunc,jsEvent,ui,view){$scope.alertOnDrop(event,delta,revertFunc,jsEvent,ui,view);},eventResize:function eventResize(event,delta,revertFunc,jsEvent,ui,view){$scope.alertOnResize(event,delta,revertFunc,jsEvent,ui,view);}}};$scope.eventRender=function(event,element,view){element.attr({'tooltip':event.title,'tooltip-append-to-body':true});$compile(element)($scope);};$scope.alertOnDrop=function(event,delta,revertFunc,jsEvent,ui,view){event.start=event._start._d;if(event.end){event.end=event._end._d;}$scope.saveEvent(event);};$scope.alertOnResize=function(event,delta,revertFunc,jsEvent,ui,view){event.start=event._start._d;if(event.end){event.end=event._end._d;}$scope.saveEvent(event);};$scope.alertEventOnClick=function(date,jsEvent,view){date.start=date._start._i;if(date.end){date.end=date._end._i;}$rootScope.$emit('openCalendarBillsPayModal',date);};$scope.saveEvent=function(event){cfpLoadingBar.start();if(event.start){event._start=$rootScope.formatServerDateTime(event.start);}$.post("../backend/application/index.php?rota=/saveEventBillsPay",{data:event},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadEvents();});};$scope.eventSource={url:"http://www.google.com/calendar/feeds/usa__en%40holiday.calendar.google.com/public/basic",className:'gcal-event',currentTimezone:'America/Sao_Paulo'};$scope.uiConfigBillsPay.calendar.dayNames=["Domingo","Segunda-Feira","Terça-Feira","Quarta-Feira","Quinta-Feira","Sexta-Feira","Sábado"];$scope.uiConfigBillsPay.calendar.dayNamesShort=["Dom","Seg","Ter","Qua","Qui","Sex","Sab"];$scope.eventSources=[$scope.events,$scope.eventSource];$scope.saveFixed=function(fixed){cfpLoadingBar.start();fixed._date=$rootScope.formatServerDate(fixed.date);$.post("../backend/application/index.php?rota=/saveFixedBillsPay",{data:fixed},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadFixed();});};return init();}]).controller('BillPayModalCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.filterproviders=$scope.$parent.providers;$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"BillPay.html",controller:'BillPayInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._dueDateFrom=$rootScope.formatServerDate(filter.dueDateFrom);filter._dueDateTo=$rootScope.formatServerDate(filter.dueDateTo);}$scope.$parent.filter=filter;$scope.$parent.loadData();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('BillPayInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.billStatus=['Em aberto','Baixada'];$scope.accountType=['Taxa DU','Taxa Extra','Taxa Aeroporto','Compra Milhas','Reembolso','Milhas + Money','Contas Comuns','Taxas'];$scope.paymentType=['Cartão de Crédito','Deposito em Conta','Boleto Bancario','Reembolso'];$.post("../backend/application/index.php?rota=/loadInternalCards",{hashId:$scope.$parent.hashId},function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadProvider",{hashId:$scope.$parent.hashId},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;});$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('CalendarBillsPayModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openCalendarBillsPayModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"CalendarBillsPayModal.html",controller:'CalendarBillsPayInstanceCtrl',resolve:{event:function event(){return args;}}});modalInstance.result.then(function(resolve){$scope.$parent.saveEvent(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('CalendarBillsPayInstanceCtrl',['$scope','$rootScope','$modalInstance','event','logger',function($scope,$rootScope,$modalInstance,event,logger){$scope.event=event;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){$modalInstance.close($scope.event);};}]).directive('morrisAmountBillspay',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish){var colors,data,func,options;data=scope.data;updateInterval=2000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.chartCalendar,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#ff0066','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(_finish,updateInterval);options.data=scope.$parent.chartCalendar;};_finish=function finish(){if(scope.$parent.chartCalendar.length>0){options.data=scope.$parent.chartCalendar;return new Morris.Line(options);}else{setTimeout(_finish,updateInterval);}};return update();}};}]).controller('FixedBillsPayModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openFixedBillsPayModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"FixedBillsPayModal.html",controller:'FixedBillsPayInstanceCtrl',resolve:{fixed:function fixed(){return args;}}});modalInstance.result.then(function(resolve){$scope.$parent.saveFixed(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('FixedBillsPayInstanceCtrl',['$scope','$rootScope','$modalInstance','fixed','logger',function($scope,$rootScope,$modalInstance,fixed,logger){$scope.fixed=fixed;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){$modalInstance.close($scope.fixed);};}]);})();;(function(){'use strict';angular.module('app.plans_sale',['angularFileUpload','ui.utils.masks']).controller('PlansSaleCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','FileUploader','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,FileUploader,logger){var init;var original;window.PLAN_SALE_SCOPE=$scope;$scope.userStatus=['Aprovado','Bloqueado'];$scope.searchKeywords='';$scope.filteredPlans=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePlans=$scope.filteredPlans.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredPlans=$filter('filter')($scope.salePlans,$scope.searchKeywords);if($scope.ocultar_bloqueados)$scope.filteredPlans=$scope.filteredPlans.filter(function(Row){return Row.sistemaDisp;});return $scope.onFilterChange();};$scope.$watch('ocultar_bloqueados',function(){$scope.search();});$scope.togglePlan=function(plan){if(!plan.sistemaDisp){plan.sistemaDisp=true;plan.sistemaDispStr='NÃO';}else{plan.sistemaDisp=false;plan.sistemaDispStr='SIM';}$scope.search();};$scope.setSelected=function(){$scope.selected=this.plan;$.post("../backend/application/index.php?rota=/loadPlansControl",{data:$scope.selected},function(result){$scope.profilePlan=jQuery.parseJSON(result).dataset.profile;$scope.controlAirline=jQuery.parseJSON(result).dataset.airlines;$scope.profilePlan.clients=[];$scope.uploader.formData={data:$scope.selected};$scope.tabindex=1;$scope.loadClientsPlan();$scope.$apply();});};$scope.loadClientsPlan=function(){$.post("../backend/application/index.php?rota=/SalePlans/loadClients",{data:$scope.selected},function(result){$scope.profilePlan.clients=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.removeClient=function(id){$.post("../backend/application/index.php?rota=/SalePlans/removeClient",{data:id},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadClientsPlan();});};$scope.newPlan=function(){$scope.selected={};$scope.tabindex=1;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredPlans=$filter('orderBy')($scope.salePlans,rowName);return $scope.onOrderChange();};$scope.savePlan=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveSalePlan",{data:$scope.selected,control:$scope.controlAirline,profile:$scope.profilePlan},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadPlans();});};$scope.cancelEdit=function(){$scope.loadPlans();$scope.tabindex=0;};$scope.loadPlans=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSalePlans",$scope.session,function(result){$scope.salePlans=jQuery.parseJSON(result).dataset;$scope.search();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.moveCLients=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/SalePlans/moveCLients",{data:$scope.selected,newPlan:$scope.newPlan},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadPlans();});};$scope.addAllClients=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/SalePlans/addAllClients",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadPlans();});};$scope.removeAllClients=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/SalePlans/removeAllClients",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadPlans();});};$scope.removeSlide=function(id){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/SalePlans/removeSlide",{data:id},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadPlans();});};$scope.openModalSelection=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_clients_selection.html",controller:'ModalClientsSelectionCtrl',size:'lg',resolve:{clients:function clients(){return $scope.profilePlan.clients;}}});modalInstance.result.then(function(clients){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/SalePlans/addClients",{clients:clients,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadClientsPlan();});});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPagePlans=[];init=function init(){$scope.tabindex=0;$scope.controlAirline=[];$scope.checkValidRoute();$scope.loadPlans();$.post("../backend/application/index.php?rota=/loadConfiancaUsers",{},function(result){$scope.users=jQuery.parseJSON(result).dataset;});$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/SalePlans/saveFilePlan";$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});$scope.uploader.onCompleteItem=function(fileItem,response,status,headers){void 0;$scope.profilePlan.slides=response.dataset;$scope.$digest();};};return init();}]);})();;(function(){'use strict';angular.module('app.modalClientsSelection').controller('ModalClientsSelectionCtrl',['$scope','$rootScope','$modalInstance','$filter','logger',function($scope,$rootScope,$modalInstance,$filter,logger){$scope.searchKeywords='';$scope.clients=[];$scope.filteredClients=[];$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.response=jQuery.parseJSON(result).dataset;$scope.search();});$scope.search=function(){$scope.filteredClients=$filter('filter')($scope.response,$scope.searchKeywords);$scope.$digest();};$scope.setSelected=function(client){if($scope.clients.indexOf(client.id)>-1){$scope.clients.slice($scope.clients.indexOf(client.id),1);}else{$scope.clients.push(client.id);}};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close($scope.clients);};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('AirlineCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredAirlines=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageAirlines=$scope.filteredAirlines.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredAirlines=$filter('filter')($scope.airlines,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){original=angular.copy(this.airline);$scope.selected=this.airline;$scope.tabindex=1;$('#value').number(true,2,',','.');$('#cards_limit').number(true,0,',','.');$('#miles_limit').number(true,0,',','.');return this.airline;};$scope.newAirline=function(){$scope.selected={};$scope.selected.type='U';$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredAirlines=$filter('orderBy')($scope.airlines,rowName);return $scope.onOrderChange();};$scope.saveAirline=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveAirline",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadAirport();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.searchMiles=function(){$.post("../backend/application/index.php?rota=/loadSalesMiles",{milesUsed:50000,airline:$scope.selected.name},function(result){$scope.miles=jQuery.parseJSON(result).dataset;$scope.search_miles();$scope.tabindex=2;$scope.$digest();});};$scope.setCard=function(){$scope.selected.cards_id=this.mile.cards_id;$scope.selected.provider_name=this.mile.name;$scope.tabindex=1;};$scope.search_miles=function(){$scope.currentMiles=$filter('filter')($scope.miles,$scope.searchKeywordsMiles);$scope.$digest();};$scope.order_miles=function(rowName){$scope.rowMiles=rowName;$scope.filteredflight_miles=$filter('orderBy')($scope.flight_miles,rowName);$scope.onOrderMilesChange();};$scope.onOrderMilesChange=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.selectMiles=function(page){var end,start;start=(page-1)*$scope.numPerPageMiles;end=start+$scope.numPerPageMiles;return $scope.currentMiles=$scope.filteredflight_miles.slice(start,end);};$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.cancelEdit=function(){$scope.loadAirport();$scope.tabindex=0;};$scope.loadAirport=function(){$.post("../backend/application/index.php?rota=/loadAirline",$scope.session,function(result){$scope.airlines=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.removeOperation=function(){if($scope.selected.operations.length>0){$scope.selected.operations.pop();}};$scope.addOperation=function(){if($scope.selected.operations.length<3){$scope.selected.operations.push({type:'',nationalBeforeBoarding:0,nationalAfterBoarding:0,internationalBeforeBoarding:0,internationalAfterBoarding:0,northAmericaBeforeBoarding:0,northAmericaAfterBoarding:0,southAmericaBeforeBoarding:0,southAmericaAfterBoarding:0});}};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageAirlines=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;cfpLoadingBar.start();$scope.loadAirport();};return init();}]);})();;(function(){'use strict';angular.module('app.purchase').controller('AirportCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredAirports=[];$scope.row='';$scope.locations=['America Norte','America Sul'];$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageAirports=$scope.filteredAirports.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredAirports=$filter('filter')($scope.airports,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){original=angular.copy(this.airport);$scope.selected=this.airport;$scope.isTable=false;return this.airport;};$scope.newAirport=function(){$scope.selected={};$scope.selected.type='U';$scope.isTable=false;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return $scope.isTable;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredAirports=$filter('orderBy')($scope.airports,rowName);return $scope.onOrderChange();};$scope.saveAirport=function(){if($scope.form_user.$valid){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveAirport",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.airports.push($scope.selected);$scope.$apply();$scope.isTable=!$scope.isTable;});cfpLoadingBar.complete();}};$scope.saveInternational=function(airport){$.post("../backend/application/index.php?rota=/saveAirport",{hashId:$scope.session.hashId,data:airport},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadAirport();});};$scope.cancelEdit=function(){$scope.loadAirport();$scope.isTable=!$scope.isTable;};$scope.loadAirport=function(){$.post("../backend/application/index.php?rota=/loadAirport",$scope.session,function(result){$scope.airports=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageAirports=[];init=function init(){$scope.checkValidRoute();$scope.isTable=true;cfpLoadingBar.start();$scope.cities=[];$scope.loadAirport();$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$('#state').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.citystate},function(result){$scope.cities=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});});};return init();}]);})();;(function(){'use strict';angular.module('app.modal').controller('AutorizationCtrl',['$scope','$rootScope','$modalInstance','logger','main','permissions',function($scope,$rootScope,$modalInstance,logger,main,permissions){$scope.permissions=permissions;$scope.main=main;$scope.check=function(){if($scope.permissions.type=='Comercial'){$.post("../backend/application/index.php?rota=/checkAcessCodeComercial",{data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=='true'||$scope.response.valid==true){$modalInstance.close(true);}else{logger.logError("Dados não conferem!");$scope.$apply();}});}else{$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=='true'||$scope.response.valid==true){$modalInstance.close(true);}else{logger.logError("Dados não conferem!");$scope.$apply();}});}};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.table').controller('BalanceBilletsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.clientStatus=['Pendente','Aprovado','Bloqueado','Reprovado'];$scope.clientPayments=['Boleto','Antecipado'];$scope.searchKeywords='';$scope.filteredClients=[];$scope.row='';$scope.partners=[{},{}];$scope.filter={days:7,client:''};$scope.search=function(){$.post("../backend/application/index.php?rota=/loadBilletsLate",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.billetsLate=jQuery.parseJSON(result).dataset;$scope.$apply();});};init=function init(){$scope.checkValidRoute();$scope.billetsLate=[];$scope.billetsPayment=[];$scope.BilletsDefaultDaily=[];$scope.BilletsDefaultMonthly=[];$scope.search();$.post("../backend/application/index.php?rota=/loadBilletsPayment",$scope.session,function(result){$scope.billetsPayment=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadBilletsDefaultDaily",$scope.session,function(result){$scope.BilletsDefaultDaily=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadBilletsDefaultMonthly",$scope.session,function(result){$scope.BilletsDefaultMonthly=jQuery.parseJSON(result).dataset;$scope.$apply();});$scope.options={series:{pie:{show:true,innerRadius:0.25}},legend:{show:false},grid:{hoverable:true,clickable:false},colors:["#903875, #176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7","#56B176","#15582D","#547D63","#299431","#906D38","#E21414","#E1E41E","#4CB938"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};};return init();}]).directive('flotChartBilletsLate',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish2,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.billetsLate;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.billetsLate);plot.draw();setTimeout(_finish2,updateInterval);};_finish2=function finish(){plot.setData(scope.$parent.billetsLate);plot.draw();updateInterval=5000;setTimeout(_finish2,updateInterval);};updateInterval=1000;return update();}};}]).directive('morrisBilletsPayment',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.billetsPayment,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0000ff','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(finish,updateInterval);void 0;options.data=scope.$parent.billetsPayment;};finish=function finish(){options.data=scope.$parent.billetsPayment;return new Morris.Line(options);};return update();}};}]).directive('morrisBilletsDefaultMonthly',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.BilletsDefaultMonthly,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||["#56B176","#15582D","#547D63"],resize:true};update=function update(){setTimeout(finish,updateInterval);options.data=scope.$parent.BilletsDefaultMonthly;};finish=function finish(){options.data=scope.$parent.BilletsDefaultMonthly;return new Morris.Line(options);};return update();}};}]).directive('morrisBilletsDefaultDaily',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.BilletsDefaultDaily,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||["#56B176","#15582D","#547D63"],resize:true};update=function update(){setTimeout(finish,updateInterval);options.data=scope.$parent.BilletsDefaultDaily;};finish=function finish(){options.data=scope.$parent.BilletsDefaultDaily;return new Morris.Line(options);};return update();}};}]);})();;(function(){'use strict';angular.module('app.miles').controller('BalanceCardsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.load=function(){$.post("../backend/application/index.php?rota=/loadCardsAirlinesStatus",{},function(result){$scope.airlinesStatus=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadCardsAirlinesRange",{},function(result){$scope.airlinesRange=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findCards=function(airline){$scope.cardsAirlines=null;$.post("../backend/application/index.php?rota=/loadCardsAirline",{airline:airline},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findCardsAirlines=function(range){$scope.cards=null;$.post("../backend/application/index.php?rota=/loadCardsAirlineByMiles",{range:range},function(result){$scope.cardsAirlines=jQuery.parseJSON(result).dataset;$scope.$digest();});};init=function init(){$scope.checkValidRoute();$scope.airlinesStatus=[];$scope.airlinesRange=[];$scope.load();};return init();}]);})();;(function(){'use strict';angular.module('app.sale').controller('BalanceClientsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filter={days:7,client:''};$scope.search=function(){$.post("../backend/application/index.php?rota=/loadClientsBalance",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.clientChart=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadAirlineBalance",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.airlineChart=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadAirlineMiles",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.airlineMiles=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadClientsTotal",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.clientsTotal=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadClientsCancelSales",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.clientsCancels=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadClientsStates",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.clientsState=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadCountClientesPerStates",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.clientsCountState=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadTopParts",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.topParts=jQuery.parseJSON(result).dataset;$scope.airportsFrom=$scope.topParts.from;$scope.airportsTo=$scope.topParts.to;$scope.airports=$scope.topParts.trechos;$scope.$apply();});};$scope.getMonthDate=function(date){if(date=='Representantes'||date=='Totais'){return date;}var day=new Date(date+' 00:00:00').getMonth();switch(day){case 0:return'Janeiro '+new Date(date).getFullYear();case 1:return'Fevereiro'+new Date(date).getFullYear();case 2:return'Março '+new Date(date).getFullYear();case 3:return'Abril '+new Date(date).getFullYear();case 4:return'Maio '+new Date(date).getFullYear();case 5:return'Junho '+new Date(date).getFullYear();case 6:return'Julho '+new Date(date).getFullYear();case 7:return'Agosto '+new Date(date).getFullYear();case 8:return'Setembro '+new Date(date).getFullYear();case 9:return'Outubro '+new Date(date).getFullYear();case 10:return'Novembro '+new Date(date).getFullYear();case 11:return'Dezembro '+new Date(date).getFullYear();}};$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageDealers=$scope.filteredDealers.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.searchDealers=function(){$scope.filteredDealers=$filter('filter')($scope.dealersAnalysis,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredDealers=$filter('orderBy')($scope.dealersAnalysis,rowName);return $scope.onOrderChange();};$scope.loadDealers=function(){$.post("../backend/application/index.php?rota=/loadDealersAnalysisMonth",{data:$scope.filterDealer},function(result){$scope.dealersMonth=jQuery.parseJSON(result).dataset;$scope.monthDealers=true;$scope.$digest();});};$scope.loadleaderBoarding=function(){$.post("../backend/application/index.php?rota=/loadleaderBoarding",{data:$scope.filterLeaderBoarding},function(result){$scope.leaderBoardingData=jQuery.parseJSON(result).dataset;$scope.leaderBoarding=true;$scope.$digest();});};$scope.showLeaderBoarding=function(){$scope.showCharts=true;$scope.loadleaderBoarding();};$scope.showMonthDealers=function(){$scope.showCharts=true;$scope.loadDealers();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageDealers=[];init=function init(){$scope.checkValidRoute();$scope.comboData=[];$scope.clientChart=[];$scope.airlineChart=[];$scope.airlineMiles=[];$scope.clientsTotal=[];$scope.clientsCancels=[];$scope.clientsDaily=[];$scope.clientsState=[];$scope.clientsCountState=[];$scope.airportsTo=[];$scope.airportsFrom=[];$scope.airports=[];$scope.filterDealer={};$scope.showCharts=false;$scope.filterLeaderBoarding={days:1};$.post("../backend/application/index.php?rota=/loadClientsTotalChart",$scope.session,function(result){$scope.comboData=jQuery.parseJSON(result).dataset;});$scope.search();$.post("../backend/application/index.php?rota=/loadClientsDaily",$scope.session,function(result){$scope.clientsDaily=jQuery.parseJSON(result).dataset;});$scope.options={series:{pie:{show:true,innerRadius:0.25}},legend:{show:false},grid:{hoverable:true,clickable:false},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7","#56B176","#15582D","#547D63","#299431","#906D38","#903875","#E21414","#E1E41E","#4CB938"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};};return init();}]).directive('flotChartClientsAirline',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish3,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.airlineChart;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.airlineChart);plot.draw();setTimeout(_finish3,updateInterval);};_finish3=function finish(){plot.setData(scope.$parent.airlineChart);plot.draw();updateInterval=5000;setTimeout(_finish3,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotMilesClientsAirline',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish4,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.airlineMiles;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.airlineMiles);plot.draw();setTimeout(_finish4,updateInterval);};_finish4=function finish(){plot.setData(scope.$parent.airlineMiles);plot.draw();updateInterval=5000;setTimeout(_finish4,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotClientsCancels',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish5,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.clientsCancels;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.clientsCancels);plot.draw();setTimeout(_finish5,updateInterval);};_finish5=function finish(){plot.setData(scope.$parent.clientsCancels);plot.draw();updateInterval=5000;setTimeout(_finish5,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotChartClientsTotals',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish6,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.clientsTotal;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.clientsTotal);plot.draw();setTimeout(_finish6,updateInterval);};_finish6=function finish(){plot.setData(scope.$parent.clientsTotal);plot.draw();updateInterval=5000;setTimeout(_finish6,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotChartClientsSales',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish7,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.clientChart;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.clientChart);plot.draw();setTimeout(_finish7,updateInterval);};_finish7=function finish(){plot.setData(scope.$parent.clientChart);plot.draw();updateInterval=5000;setTimeout(_finish7,updateInterval);};updateInterval=1000;return update();}};}]).directive('barClientsTotal',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish8){var colors,data,func,options;data=scope.data;updateInterval=2500;switch(attrs.type){case'line':if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:data,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};return new Morris.Line(options);case'area':if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:data,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],behaveLikeLine:attrs.behaveLikeLine||false,fillOpacity:attrs.fillOpacity||'auto',pointSize:attrs.pointSize||4,resize:true};return new Morris.Area(options);case'bar':if(attrs.barColors===void 0||attrs.barColors===''){colors=null;}else{colors=JSON.parse(attrs.barColors);}options={element:ele[0],data:scope.$parent.comboData,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),barColors:['#4da74d','#c11313','#e2671b','#4c69e8','#e84c4c','#cb4b4b','#9440ed'],stacked:attrs.stacked||null,resize:true};update=function update(){setTimeout(_finish8,updateInterval);options.data=scope.$parent.comboData;};_finish8=function finish(){if(scope.$parent.comboData.length>0){options.data=scope.$parent.comboData;return new Morris.Bar(options);}else{setTimeout(_finish8,updateInterval);}};return update();case'donut':if(attrs.colors===void 0||attrs.colors===''){colors=null;}else{colors=JSON.parse(attrs.colors);}options={element:ele[0],data:data,colors:colors||['#0B62A4','#3980B5','#679DC6','#95BBD7','#B0CCE1','#095791','#095085','#083E67','#052C48','#042135'],resize:true};if(attrs.formatter){func=new Function('y','data',attrs.formatter);options.formatter=func;}return new Morris.Donut(options);}}};}]).directive('chartClientsStates',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish9,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.clientsState;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.clientsState);plot.draw();setTimeout(_finish9,updateInterval);};_finish9=function finish(){plot.setData(scope.$parent.clientsState);plot.draw();updateInterval=5000;setTimeout(_finish9,updateInterval);};updateInterval=1000;return update();}};}]).directive('chartClientsCountStates',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish10,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.clientsCountState;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.clientsCountState);plot.draw();setTimeout(_finish10,updateInterval);};_finish10=function finish(){plot.setData(scope.$parent.clientsCountState);plot.draw();updateInterval=5000;setTimeout(_finish10,updateInterval);};updateInterval=1000;return update();}};}]).directive('morrisClientsDailys',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish11){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.clientsDaily,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0000ff','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){updateInterval=3000;setTimeout(_finish11,updateInterval);options.data=scope.$parent.clientsDaily;};_finish11=function finish(){if(scope.$parent.clientsDaily.length>0){options.data=scope.$parent.clientsDaily;return new Morris.Line(options);}else{setTimeout(_finish11,updateInterval);}};return update();}};}]).directive('morrisAirportsFrom',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.airportsFrom,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0000ff','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){updateInterval=4000;setTimeout(finish,updateInterval);options.data=scope.$parent.airportsFrom;};finish=function finish(){options.data=scope.$parent.airportsFrom;return new Morris.Bar(options);};return update();}};}]).directive('morrisAirportsTo',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.airportsTo,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0000ff','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){updateInterval=4000;setTimeout(finish,updateInterval);options.data=scope.$parent.airportsTo;};finish=function finish(){options.data=scope.$parent.airportsTo;return new Morris.Bar(options);};return update();}};}]).directive('morrisAirportsTrechos',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.airports,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#afd8f8','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){updateInterval=4000;setTimeout(finish,updateInterval);options.data=scope.$parent.airports;};finish=function finish(){options.data=scope.$parent.airports;return new Morris.Bar(options);};return update();}};}]).controller('DealerTableModalCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.filterproviders=$scope.$parent.providers;$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"DealerTableModal.html",controller:'DealerTableInstanceCtrl',periods:$scope.$parent.periods,resolve:{filterDealer:function filterDealer(){return $scope.$parent.filterDealer;}}});modalInstance.result.then(function(filterDealer){if(filterDealer!=undefined){filterDealer._issueDateFrom=$rootScope.formatServerDate(filterDealer.issueDateFrom);filterDealer._issueDateTo=$rootScope.formatServerDate(filterDealer.issueDateTo);}$scope.$parent.filterDealer=filterDealer;$scope.$parent.loadDealers();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('DealerTableInstanceCtrl',['$scope','$rootScope','$modalInstance','filterDealer',function($scope,$rootScope,$modalInstance,filterDealer){$scope.filterDealer=filterDealer;$scope.ok=function(){$modalInstance.close($scope.filterDealer);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.miles').controller('BalanceMilesCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filter={days:7,client:'',points:4000};$scope.showFilter=false;$scope.search=function(){if($scope.$parent.$parent.main.isMaster){if($scope.showFilter){$scope.filter._dateFrom=$rootScope.formatServerDate($scope.filter.dateFrom);$scope.filter._dateTo=$rootScope.formatServerDate($scope.filter.dateTo);}}$.post("../backend/application/index.php?rota=/loadBlueSalesSRM",{data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.blueSRMSales=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadbluePointsSRM",{data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.blueSRMPoints=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadbluePoints",{hashId:$scope.session.hashId,data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.bluePoints=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadbluePointsCompetitive",{hashId:$scope.session.hashId,data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.bluePointsCompetitive=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadbluePointsMonopoly",{hashId:$scope.session.hashId,data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.bluePointsMonopoly=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadTotalMiles",{hashId:$scope.session.hashId,data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.totalMiles=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadLatamSales",{hashId:$scope.session.hashId,data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.laTamSales=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadLatamPoints",{hashId:$scope.session.hashId,data:$scope.filter,searchType:$scope.showFilter},function(result){$scope.laTamPoints=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.loadAzulSRM=function(){$.post("../backend/application/index.php?rota=/loadAZULSRMUsage",{},function(result){$scope.AZULSRMUsage=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadAZULMMSUsage",{},function(result){$scope.AZULMMSUsage=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.saveChangeMiles=function(data){$.post("../backend/application/index.php?rota=/saveChangeMilesAZULSRM",{data:data},function(result){$scope.loadAzulSRM();});};$scope.attAverageMiles=function(){$.post("../backend/application/index.php?rota=/loadAverageMiles",{data:$scope.filter},function(result){$scope.averageMiles=jQuery.parseJSON(result).dataset;$scope.$apply();});};init=function init(){$scope.checkValidRoute();$scope.milesAnalysis=[];$scope.bluePoints=[];$scope.blueSRMSales=[];$scope.blueSRMPoints=[];$scope.bluePointsCompetitive=[];$scope.bluePointsMonopoly=[];$scope.cancelSales=[];$scope.refoundSales=[];$scope.totalMiles=[];$scope.laTamSales=[];$scope.laTamPoints=[];$scope.search();$.post("../backend/application/index.php?rota=/loadMilesAnalysis",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.milesAnalysis=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadCancelSalesChart",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.cancelSales=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadRefoundSalesChart",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.refoundSales=jQuery.parseJSON(result).dataset;$scope.$apply();});$scope.attAverageMiles();$scope.loadAzulSRM();$scope.options={series:{pie:{show:true,innerRadius:0.25}},legend:{show:false},grid:{hoverable:true,clickable:false},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7","#56B176","#15582D","#547D63","#299431","#906D38","#903875","#E21414","#E1E41E","#4CB938"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};};return init();}]).directive('morrisMilesAnalysis',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish12){var colors,data,func,options;data=scope.data;updateInterval=2000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.milesAnalysis,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0000ff','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(_finish12,updateInterval);options.data=scope.$parent.milesAnalysis;};_finish12=function finish(){if(scope.$parent.milesAnalysis.length>0){options.data=scope.$parent.milesAnalysis;return new Morris.Line(options);}else{setTimeout(_finish12,updateInterval);}};return update();}};}]).directive('flotSrmPoints',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish13,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.bluePoints;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.bluePoints);plot.draw();setTimeout(_finish13,updateInterval);};_finish13=function finish(){plot.setData(scope.$parent.bluePoints);plot.draw();updateInterval=5000;setTimeout(_finish13,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotSrmPointsMonopoly',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish14,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.bluePointsMonopoly;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.bluePointsMonopoly);plot.draw();setTimeout(_finish14,updateInterval);};_finish14=function finish(){plot.setData(scope.$parent.bluePointsMonopoly);plot.draw();updateInterval=5000;setTimeout(_finish14,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotSrmPointsCompetitive',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish15,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.bluePointsCompetitive;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.bluePointsCompetitive);plot.draw();setTimeout(_finish15,updateInterval);};_finish15=function finish(){plot.setData(scope.$parent.bluePointsCompetitive);plot.draw();updateInterval=5000;setTimeout(_finish15,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotCancelSalesPoints',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,finish,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.cancelSales;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.cancelSales);plot.draw();setTimeout(finish,updateInterval);};finish=function finish(){plot.setData(scope.$parent.cancelSales);plot.draw();};updateInterval=2000;return update();}};}]).directive('flotRefoundSalesPoints',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,finish,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.refoundSales;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.refoundSales);plot.draw();setTimeout(finish,updateInterval);};finish=function finish(){plot.setData(scope.$parent.refoundSales);plot.draw();};updateInterval=2000;return update();}};}]).directive('flotTotalMilesUsed',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish16,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.totalMiles;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.totalMiles);plot.draw();setTimeout(_finish16,updateInterval);};_finish16=function finish(){plot.setData(scope.$parent.totalMiles);plot.draw();updateInterval=5000;setTimeout(_finish16,updateInterval);};updateInterval=2000;return update();}};}]).directive('floatLatamSales',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish17,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.laTamSales;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.laTamSales);plot.draw();setTimeout(_finish17,updateInterval);};_finish17=function finish(){plot.setData(scope.$parent.laTamSales);plot.draw();updateInterval=5000;setTimeout(_finish17,updateInterval);};updateInterval=2000;return update();}};}]).directive('floatLatamPoints',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish18,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.laTamPoints;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.laTamPoints);plot.draw();setTimeout(_finish18,updateInterval);};_finish18=function finish(){plot.setData(scope.$parent.laTamPoints);plot.draw();updateInterval=5000;setTimeout(_finish18,updateInterval);};updateInterval=2000;return update();}};}]).directive('flotSrmSales',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish19,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.blueSRMSales;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.blueSRMSales);plot.draw();setTimeout(_finish19,updateInterval);};_finish19=function finish(){plot.setData(scope.$parent.blueSRMSales);plot.draw();updateInterval=5000;setTimeout(_finish19,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotSrmPointsSales',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish20,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.blueSRMPoints;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.blueSRMPoints);plot.draw();setTimeout(_finish20,updateInterval);};_finish20=function finish(){plot.setData(scope.$parent.blueSRMPoints);plot.draw();updateInterval=5000;setTimeout(_finish20,updateInterval);};updateInterval=1000;return update();}};}]);})();;(function(){'use strict';angular.module('app.balance').controller('BalanceOrdesCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;$scope.filter={days:7};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.UsersSales=$filter('orderBy')($scope.UsersSales,rowName);};$scope.search=function(){$.post("../backend/application/index.php?rota=/loadUserSales",{data:$scope.filter},function(result){$scope.userSales=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.loadUsersDescription=function(){$scope.sales=[];$.post("../backend/application/index.php?rota=/loadUsersPannel",{data:$scope.filterSales},function(result){$scope.UsersSales=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findUserProcessingTime=function(user){$scope.sales=[];$.post("../backend/application/index.php?rota=/findUserProcessingTime",{data:user,filter:$scope.filterSales},function(result){$scope.UserProcessingTime=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findUserSalesDay=function(day){$scope.sales=[];$.post("../backend/application/index.php?rota=/findUserSalesDay",{data:day,filter:$scope.UserProcessingTime},function(result){$scope.sales=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findUserSalesFilter=function(UserProcessingTime){$scope.sales=[];$.post("../backend/application/index.php?rota=/findUserSalesFilter",{data:$scope.UserProcessingTime,filter:$scope.filterSales},function(result){$scope.sales=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.loadOrdersPerHour=function(UserProcessingTime){$scope.ordersPerHour=[];$.post("../backend/application/index.php?rota=/loadOrdersPerHour",{},function(result){$scope.ordersPerHour=jQuery.parseJSON(result).dataset;$scope.$digest();$scope.ordersPerHour=$scope.formatHour($scope.ordersPerHour);});};$scope.formatHour=function(ordersPerHour){var ordersPerHour=ordersPerHour;ordersPerHour.forEach(function(element){if(parseInt(element.value)<10){element.value='0'+element.value+':'+'00';}else{element.value=element.value+':'+'00';}});return ordersPerHour;};$scope.findDate=function(date){if(date==''){return'';}if(date.length>10)return new Date(date);var date=new Date(date);return date.setDate(date.getDate()+1);};init=function init(){$scope.checkValidRoute();$scope.userSales=[];$scope.users={values:[]};$scope.showCharts=false;$scope.filterSales={airlines:{},days:7};$scope.ordersPerHour=[];$scope.options={series:{pie:{show:true,innerRadius:0.25}},legend:{show:false},grid:{hoverable:true,clickable:false},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7","#56B176","#15582D","#547D63","#299431","#906D38","#903875","#E21414","#E1E41E","#4CB938"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};$scope.search();$scope.loadOrdersPerHour();$.post("../backend/application/index.php?rota=/loadUserHistory",{data:$scope.filter},function(result){$scope.users=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadSumOrderMilesCancels",{},function(result){$scope.SumOrderMiles=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/airline/loadValidAirlines",{},function(result){$scope.airlines=jQuery.parseJSON(result).dataset;for(var i in $scope.airlines){$scope.filterSales.airlines[$scope.airlines[i].id]=true;}$scope.filterSales.airlines['todas']=true;$scope.airlines.push({id:'todas',name:'todas'});$scope.$digest();});};$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"BalanceModalCtrl.html",controller:'BalanceModalInstanceCtrl',resolve:{filterSales:function filterSales(){return $scope.filterSales;}}});modalInstance.result.then(function(filterSales){filterSales._dateFrom=$rootScope.formatServerDate(filterSales.dateFrom);filterSales._dateTo=$rootScope.formatServerDate(filterSales.dateTo);$scope.filterSales=filterSales;$scope.loadUsersDescription();});};return init();}]).controller('BalanceModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filterSales',function($scope,$rootScope,$modalInstance,filterSales){$scope.filterSales=filterSales;$scope.ok=function(){$modalInstance.close($scope.filterSales);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).directive('morrisUserEmissionsAnalysis',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish21){var colors,data,func,options;data=scope.data;updateInterval=2000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.users.values,xkey:attrs.xkey,ykeys:scope.$parent.users.keys,labels:scope.$parent.users.names,lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#ff0066','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(_finish21,updateInterval);options.data=scope.$parent.users.values;};_finish21=function finish(){options.data=scope.$parent.users.values;if(scope.$parent.users.values.length>0){options.ykeys=scope.$parent.users.keys;options.labels=scope.$parent.users.names;return new Morris.Line(options);}else{setTimeout(_finish21,updateInterval);}};return update();}};}]).directive('morrisemissionsperhour',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish22,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.userSales;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.userSales);plot.draw();setTimeout(_finish22,updateInterval);};_finish22=function finish(){plot.setData(scope.$parent.userSales);plot.draw();updateInterval=5000;setTimeout(_finish22,updateInterval);};updateInterval=1000;return update();}};}]).directive('morrisEmissionsPerHour',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish23){var colors,data,func,options;data=scope.data;updateInterval=2000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.ordersPerHour,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),parseTime:false,lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#ff0066','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(_finish23,updateInterval);options.data=scope.$parent.ordersPerHour;};_finish23=function finish(){if(scope.$parent.ordersPerHour.length>0){options.data=scope.$parent.ordersPerHour;return new Morris.Line(options);}else{setTimeout(_finish23,updateInterval);}};return update();}};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('BalanceProvidersCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.clientStatus=['Pendente','Aprovado','Bloqueado','Reprovado','Desistencia'];$scope.searchKeywords='';$scope.filter={days:7,client:''};$scope.search=function(){$.post("../backend/application/index.php?rota=/loadPurchaseMiles",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.airlinesData=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadPurchasesAnalysis",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.PurchasesData=jQuery.parseJSON(result).dataset;$scope.$apply();});};init=function init(){$scope.checkValidRoute();$scope.airlinesData=[];$scope.PurchasesData=[];$scope.PurchasesTotal=[];$scope.search();$.post("../backend/application/index.php?rota=/loadMergedMiles",$scope.session,function(result){$scope.mergedMiles=jQuery.parseJSON(result).dataset;});$scope.options={series:{pie:{show:true,innerRadius:0.25}},legend:{show:false},grid:{hoverable:true,clickable:false},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7","#56B176","#15582D","#547D63","#299431","#906D38","#903875","#E21414","#E1E41E","#4CB938"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};};return init();}]).directive('flotMilesPurchasesAirline',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish24,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.airlinesData;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.airlinesData);plot.draw();setTimeout(_finish24,updateInterval);};_finish24=function finish(){plot.setData(scope.$parent.airlinesData);plot.draw();updateInterval=5000;setTimeout(_finish24,updateInterval);};updateInterval=1000;return update();}};}]).directive('flotPurchasesAirline',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish25,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.PurchasesData;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.PurchasesData);plot.draw();setTimeout(_finish25,updateInterval);};_finish25=function finish(){plot.setData(scope.$parent.PurchasesData);plot.draw();updateInterval=5000;setTimeout(_finish25,updateInterval);};updateInterval=1000;return update();}};}]).directive('morrisLineMergedMiles',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,finish){var colors,data,func,options;data=scope.data;updateInterval=1000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.mergedMiles,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0000ff','#ff9933','#ff0000','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(finish,updateInterval);options.data=scope.$parent.mergedMiles;};finish=function finish(){options.data=scope.$parent.mergedMiles;return new Morris.Line(options);};return update();}};}]);})();;(function(){'use strict';angular.module('app.banks').controller('BanksCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredBanks=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBanks=$scope.filteredBanks.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredBanks=$filter('filter')($scope.banks,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.bank;$scope.tabindex=1;return void 0;};$scope.newBank=function(){$scope.selected={};$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredBanks=$filter('orderBy')($scope.banks,rowName);return $scope.onOrderChange();};$scope.cancelEdit=function(){$scope.loadBanks();$scope.tabindex=0;};$scope.loadBanks=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/banks/load",{},function(result){$scope.banks=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.tabindex=0;return $scope.search();});};$scope.save=function(){$.post("../backend/application/index.php?rota=/banks/save",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadBanks();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBanks=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadBanks();};return init();}]);})();;(function(){'use strict';angular.module('app.billsReceive').controller('BilletsReceiveCtrl',['$scope','$rootScope','$filter','$modal','$window','cfpLoadingBar','logger','FileUploader',function($scope,$rootScope,$filter,$modal,$window,cfpLoadingBar,logger,FileUploader){var init;var tabindex;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.banks=['BRADESCO','SANTANDER'];$scope.searchKeywords='';$scope.filteredBilletsReceive=[];$scope.row='';$scope.totalFilteredValue=0;$scope.filter={};$scope.filter2={days:0,daysBils:0,enterPressed:false};$scope.detalhes=false;$scope.pesqSelect='0';$scope.totalPreco=0;$scope.totalDataMark=0;$scope.totalPrecoMark=0;$scope.payment_date='';$scope.select=function(page){$scope.loadBillets();};$scope.onFilter2EnterKey=function(keyCode){if($scope.filter2.days){$scope.filter2.enterPressed=false;if(keyCode==13){$scope.filter2.enterPressed=true;$scope.loadData();}}};$scope.onFilter2Blur=function(){if($scope.filter2.days){if(!$scope.filter2.enterPressed){$scope.loadData();}}};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.loadBillets();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.back=function(){$scope.tabindex=0;$scope.selected={};$scope.billReceive={};$scope.bill=false;$scope.receive=false;$scope.debits=false;$scope.Anticipated=false;$scope.clientAnalisys=false;$scope.agreement=false;$scope.billetAgreement={};};$scope.newBillAdvance=function(){$scope.tabindex=4;$scope.bill=true;$scope.billReceive={};$scope.billReceive.type='advance';$("#value").maskMoney({thousands:'.',decimal:',',precision:2});$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;});};$scope.newBill=function(){$scope.tabindex=4;$scope.bill=true;$scope.billReceive={};$("#value").maskMoney({thousands:'.',decimal:',',precision:2});$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;});};$scope.newBillReceive=function(){$scope.tabindex=4;$scope.receive=true;$scope.billReceive={description:'',client:'',actual_value:0};$("#valueBillReceive").maskMoney({thousands:'.',decimal:',',precision:2});$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;});};$scope.generateBill=function(){$scope.billReceive._dueDate=$rootScope.formatServerDate($scope.billReceive.due_date);$scope.billReceive.actual_value=$('#value').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/generateBillReceive",{data:$scope.billReceive},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadData();$scope.billReceive={};$scope.bill=false;$scope.tabindex=0;});};$scope.generateBillReceive=function(){$scope.billReceive.actual_value=$('#valueBillReceive').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/generateBillClient",{hashId:$scope.session.hashId,data:$scope.billReceive},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadData();$scope.billReceive={};$scope.receive=false;$scope.tabindex=0;});};$scope.setSelected=function(){$scope.selected=angular.copy(this.billetreceive);$scope.tabindex=1;$scope.loadBilletBills();$scope.selected._due_date=new Date($scope.selected.due_date);$('#original').number(true,2,',','.');$scope.selected.actual_value=$rootScope.formatNumber($scope.selected.actual_value);$("#actual").maskMoney({thousands:'.',decimal:',',precision:2});$("#actual").maskMoney('mask',$scope.selected.actual_value);$("#tax").maskMoney({thousands:'.',decimal:',',precision:2});$("#tax").maskMoney('mask',$scope.selected.tax);$("#discount").maskMoney({thousands:'.',decimal:',',precision:2});$("#discount").maskMoney('mask',$scope.selected.discount);$scope.uploader.formData={hashId:$scope.session.hashId};$.post("../backend/application/index.php?rota=/loadDivisionsBillet",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.billetsDivision=jQuery.parseJSON(result).dataset;for(var i in $scope.billetsDivision){$scope.billetsDivision[i].dueDate=new Date($scope.billetsDivision[i].dueDate);$scope.billetsDivision[i].dueDate.setDate($scope.billetsDivision[i].dueDate.getDate()+1);}$scope.$apply();});};$scope.printReport=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(18);var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"},{title:"EMISSOR",dataKey:"issuing"},{title:"CLIENTE",dataKey:"client"}];var rows=[];var total=0;for(var i=0;i<$scope.billsreceive.length;i++){if($scope.billsreceive[i].account_type=="Reembolso"||$scope.billsreceive[i].account_type=="Credito"||$scope.billsreceive[i].account_type=="Credito Adiantamento"){total-=$scope.billsreceive[i].actual_value;rows.push({issuing_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),flightLocator:$scope.billsreceive[i].flightLocator,from:$scope.billsreceive[i].account_type,airline:$scope.billsreceive[i].airline,pax_name:$scope.billsreceive[i].description,actual_value:$scope.billsreceive[i].actual_value*-1,issuing:$scope.billsreceive[i].issuing,client:$scope.billsreceive[i].client});}else{total+=$scope.billsreceive[i].actual_value;rows.push({issuing_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),flightLocator:$scope.billsreceive[i].flightLocator,from:$scope.billsreceive[i].from+'-'+$scope.billsreceive[i].to,airline:$scope.billsreceive[i].airline,pax_name:$scope.billsreceive[i].pax_name,actual_value:$scope.billsreceive[i].actual_value,issuing:$scope.billsreceive[i].issuing,client:$scope.billsreceive[i].client});}}rows.push({});rows.push({});rows.push({pax_name:'Total:',actual_value:$rootScope.formatNumber($scope.selected.actual_value)});rows.push({});if($scope.selected.discount>0){rows.push({pax_name:'Descontos:',actual_value:$rootScope.formatNumber($scope.selected.discount)});}rows.push({});rows.push({issuing_date:'Vencimento:',flightLocator:$filter('date')($scope.selected.due_date,'dd/MM/yyyy'),pax_name:'Boleto Nº '+$scope.selected.ourNumber});doc.autoTable(columns,rows,{theme:'grid',styles:{fontSize:8,overflow:'linebreak'},startY:90,margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='actual_value'){cell.styles.halign='right';}}});doc.save('BORDERO '+$scope.billsreceive[0].client+'.pdf');};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open('GET',url);xhr.send();};$scope.printReportModel=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(16);doc.setTextColor(0);doc.setFontStyle('bold');doc.text('IDEAL VIAGENS',200,50);var start=60;doc.autoTable([{title:'',dataKey:"text"}],[{text:'PAULO RDRIGUES DOS SANTOS JUNIOR MMS VIAGENS'},{text:'CNPJ: 20.966.716/0001-55'},{text:'Rua: Jurua, 46 Conj. 301 Bairro: Graça'},{text:'CEP: 31.140-020 BELO HORIZONTE / MG'},{text:'Tel: 31.3017-0304  E-mail: '}],{theme:'plain',styles:{fontSize:8,overflow:'linebreak'},startY:start,margin:{horizontal:10},bodyStyles:{valign:'top'}});start=doc.autoTableEndPosY()+20;doc.autoTable([{title:'Nº Borderô',dataKey:"ourNumber"},{title:'Valor da Fatura / Borderô',dataKey:"actual_value"},{title:'Data Emissão',dataKey:"issue_date"},{title:'Data Vencimento',dataKey:"due_date"}],[{ourNumber:$scope.selected.ourNumber,actual_value:'R$ '+$rootScope.formatNumber($scope.selected.actual_value),issue_date:$filter('date')(new Date($scope.selected.issue_date),'dd/MM/yyyy'),text:$filter('date')(new Date($scope.selected.due_date),'dd/MM/yyyy')}],{theme:'plain',styles:{fontSize:8,overflow:'linebreak'},startY:start,margin:{horizontal:10},bodyStyles:{valign:'top'}});start=doc.autoTableEndPosY()+10;doc.autoTable([{title:'',dataKey:"text"}],[{text:'Sacado: '+$scope.selected.company_name},{text:'Endereço: '+$scope.selected.adress},{text:'Tel: '+$scope.selected.phoneNumber},{text:'CNPJ: '+$scope.selected.registrationCode},{text:''},{text:'Banco: 237- Bradesco - Agência: 3420 Conta Corrente: 4879-8'}],{theme:'plain',styles:{fontSize:8,overflow:'linebreak'},startY:start,margin:{horizontal:10},bodyStyles:{valign:'top'}});var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"TRECHO",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"SOLICITANTE",dataKey:"issuing"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"}];var rows=[];var total=0;for(var i=0;i<$scope.billsreceive.length;i++){if($scope.billsreceive[i].account_type=="Reembolso"||$scope.billsreceive[i].account_type=="Credito"||$scope.billsreceive[i].account_type=="Credito Adiantamento"){total-=$scope.billsreceive[i].actual_value;rows.push({issuing_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),flightLocator:$scope.billsreceive[i].flightLocator,from:$scope.billsreceive[i].account_type,airline:$scope.billsreceive[i].airline,pax_name:$scope.billsreceive[i].description,actual_value:$scope.billsreceive[i].actual_value*-1,issuing:$scope.billsreceive[i].issuing});}else{total+=$scope.billsreceive[i].actual_value;rows.push({issuing_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),flightLocator:$scope.billsreceive[i].flightLocator,from:$scope.billsreceive[i].from+'-'+$scope.billsreceive[i].to,airline:$scope.billsreceive[i].airline,pax_name:$scope.billsreceive[i].pax_name,actual_value:$scope.billsreceive[i].actual_value,issuing:$scope.billsreceive[i].issuing});}}rows.push({});rows.push({pax_name:'Total:',actual_value:$rootScope.formatNumber(total)});rows.push({});if($scope.selected.discount>0){rows.push({pax_name:'Descontos:',actual_value:$rootScope.formatNumber($scope.selected.discount)});}start=doc.autoTableEndPosY()+20;doc.autoTable(columns,rows,{theme:'plain',styles:{fontSize:8,overflow:'linebreak'},startY:start,margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='actual_value'){cell.styles.halign='right';}}});doc.save('BORDERO '+$scope.billsreceive[0].client+'.pdf');};$scope.print=function(){var doc=new jsPDF('l','pt');doc.margin=0.5;doc.setFontSize(18);var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"BORDERO",dataKey:"billet"},{title:"CLIENTE",dataKey:"client"},{title:"VALOR",dataKey:"actual_value"},{title:"VENCIMETO",dataKey:"due_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"EMISSOR",dataKey:"issuing"}];var rows=[];$.post("../backend/application/index.php?rota=/loadBilletsReceive",{data:$scope.filter},function(result){$scope.billetsreceive=jQuery.parseJSON(result).dataset.billetreceive;for(var j in $scope.billetsreceive){$.post("../backend/application/index.php?rota=/loadBilletBills",{data:$scope.billetsreceive[j]},function(result){$scope.billsreceive=jQuery.parseJSON(result).dataset;rows.push({});for(var i in $scope.billsreceive){if($scope.billsreceive[i].account_type=="Reembolso"||$scope.billsreceive[i].account_type=="Credito"||$scope.billsreceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),flightLocator:$scope.billsreceive[i].flightLocator,from:$scope.billsreceive[i].account_type,airline:$scope.billsreceive[i].airline,pax_name:$scope.billsreceive[i].description,actual_value:$scope.billsreceive[i].actual_value,issuing:$scope.billsreceive[i].issuing});}else{rows.push({issuing_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),flightLocator:$scope.billsreceive[i].flightLocator,from:$scope.billsreceive[i].from+'-'+$scope.billsreceive[i].to,airline:$scope.billsreceive[i].airline,pax_name:$scope.billsreceive[i].pax_name,actual_value:$scope.billsreceive[i].actual_value,issuing:$scope.billsreceive[i].issuing});}}});rows.push({});rows.push({});}doc.autoTable(columns,rows,{theme:'grid',styles:{fontSize:8,overflow:'linebreak'},startY:90,margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='actual_value'){cell.styles.halign='right';}}});doc.save('Resumo debitos '+$scope.billsreceive[0].client+'.pdf');});};$scope.cancelBillet=function(){$.post("../backend/application/index.php?rota=/cancelBillet",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadData();});};$scope.attMarked=function(){$scope.totalDataMark=0;$scope.totalPrecoMark=0;for(var i in $scope.billetsreceive){if($scope.billetsreceive[i].checked){$scope.totalDataMark+=1;$scope.totalPrecoMark+=$scope.billetsreceive[i].actual_value-$scope.billetsreceive[i].alreadyPaid;}}};$scope.addRow=function(){if(this.billetreceive.status=='B'){this.billetreceive.checked=false;}$scope.attMarked();};$scope.search=function(){$scope.filteredBilletsReceive=$filter('filter')($scope.billetsreceive,$scope.searchKeywords);if($scope.filteredBilletsReceive.length==1&&$scope.filter._dueDateFrom!=undefined&&$scope.filter._dueDateTo!=undefined){$scope.filteredBilletsReceive[0].checked=true;}$scope.totalFilteredValue=$scope.getTotalFiltered();$scope.$apply();return $scope.onFilterChange();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadBillets();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadBillets();};$scope.loadData=function(){if($scope.main.isMaster){var q_intervalo=function q_intervalo(){if(q==0){cfpLoadingBar.complete();clearInterval(q_id);}};cfpLoadingBar.start();var q=8;$.post("../backend/application/index.php?rota=/loadSumOpenedBillsReceive",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumOpenedbillsreceive=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumClosedBilletsReceive",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumClosedbilletsreceive=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumBilletsHasBillets",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumBilletsHasBillets=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumBilletsDontHasBillets",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumBilletsDontHasBillets=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumBilletsLosses",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumBilletsLosses=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumBilletsToDue",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumBilletsToDue=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumBilletsPast",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumBilletsPast=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSumBilletBilletsReceive",{data:$scope.filter,days:$scope.filter2.days},function(result){$scope.sumBilletbilletsreceive=jQuery.parseJSON(result).dataset;q-=1;$scope.$apply();});var q_id=setInterval(q_intervalo,1000);}};$scope.loadTodaysOpened=function(){$scope.advising=true;$scope.opened=false;$scope.debits=false;$scope.filter._dueDateFrom=$rootScope.formatServerDate(new Date());$scope.filter._dueDateTo=$rootScope.formatServerDate(new Date());$scope.filter.status='Em Aberto';$scope.loadBillets();};$scope.loadOpened=function(){$scope.advising=false;$scope.opened=true;$scope.debits=false;$scope.filter._dueDateTo=$rootScope.formatServerDate(new Date());$scope.filter._dueDateFrom=undefined;$scope.filter.status='Em Aberto';$scope.loadBillets();};$scope.getHojeMaisDias=function(dias){var today=new Date();if(dias!=0)today.setDate(today.getDate()+dias);var dd=String(today.getDate()).padStart(2,'0');var mm=String(today.getMonth()+1).padStart(2,'0');var yyyy=today.getFullYear();return yyyy+'-'+mm+'-'+dd;};$scope.searchAVencer=function(){var v=parseInt($scope.pesqSelect,10);if($scope.pesqSelect=="99"){v=$scope.filter2.daysBils;}else if($scope.pesqSelect=="-99"){v=$scope.filter2.daysBils*-1;}if(v<=0){$scope.filter={dueDateFrom:new Date($scope.getHojeMaisDias(v)),dueDateTo:new Date(),_dueDateFrom:$scope.getHojeMaisDias(v),_dueDateTo:$scope.getHojeMaisDias(0),status:"Em aberto"};}else{$scope.filter={dueDateFrom:new Date(),dueDateTo:new Date($scope.getHojeMaisDias(v)),_dueDateFrom:$scope.getHojeMaisDias(0),_dueDateTo:$scope.getHojeMaisDias(v),status:"Em aberto"};}$scope.loadBillets();};$scope.searchVencidas=function(){var v=parseInt($scope.pesqSelect,10);if($scope.pesqSelect=="99"){v=$scope.filter2.daysBils;}else if($scope.pesqSelect=="-99"){v=$scope.filter2.daysBils*-1;}if(v<=0){$scope.filter={dueDateFrom:new Date($scope.getHojeMaisDias(v)),dueDateTo:new Date(),_dueDateFrom:$scope.getHojeMaisDias(v),_dueDateTo:$scope.getHojeMaisDias(0),status:"Em aberto"};}else{$scope.filter={dueDateFrom:new Date(),dueDateTo:new Date($scope.getHojeMaisDias(v)),_dueDateFrom:$scope.getHojeMaisDias(0),_dueDateTo:$scope.getHojeMaisDias(v),status:"Em aberto"};}$scope.orderDown('due_date');};$scope.searchPagas=function(){var v=parseInt($scope.pesqSelect,10);if($scope.pesqSelect=="99"){v=$scope.filter2.daysBils;}else if($scope.pesqSelect=="-99"){v=$scope.filter2.daysBils*-1;}if(v<=0){$scope.filter={paymentDateFrom:new Date($scope.getHojeMaisDias(v)),paymentDateTo:new Date(),_paymentDateFrom:$scope.getHojeMaisDias(v),_paymentDateTo:$scope.getHojeMaisDias(0),status:"Baixada",refund:true};}else{$scope.filter={paymentDateFrom:new Date(),paymentDateTo:new Date($scope.getHojeMaisDias(v)),_paymentDateFrom:$scope.getHojeMaisDias(0),_paymentDateTo:$scope.getHojeMaisDias(v),status:"Baixada",refund:true};}$scope.orderDown('payment_date');};$scope.loadBillets=function(){cfpLoadingBar.start();if($scope.main.isMaster){$scope.loadData();}$.post("../backend/application/index.php?rota=/loadBilletsReceive",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.billetsreceive=jQuery.parseJSON(result).dataset.billetreceive;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.totalPreco=jQuery.parseJSON(result).dataset.totalValueNotPaid;$scope.debits=false;$scope.showTable=true;cfpLoadingBar.complete();$scope.$digest();});};$scope.loadBilletBills=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadBilletBills",{data:$scope.selected},function(result){$scope.billsreceive=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.saveCloseReceive=function(){$scope.checkedrows=[];for(var i in $scope.billetsreceive){if($scope.billetsreceive[i].checked){$scope.checkedrows.push($scope.billetsreceive[i]);}}$.post("../backend/application/index.php?rota=/saveCloseReceive",{checkedrows:$scope.checkedrows},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadModalInfoBaixa();$scope.loadBillets();});};$scope.loadModalInfoBaixa=function(){var modalInstance=$modal.open({templateUrl:"modalInfoBaixa.html",controller:'infoBaixaModalInstanceCtrl',size:'lg',scope:$scope});modalInstance.result.then(function(){$scope.printBaixa(true);$scope.totalDataMark=0;$scope.totalPrecoMark=0;},function(){$scope.totalDataMark=0;$scope.totalPrecoMark=0;});};$scope.loadClientsBloquedsWithNoPendency=function(){$.post("../backend/application/index.php?rota=/loadClientsBloquedsWithNoPendency",{},function(result){$scope.clientsNoPendency=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_client_list.html",controller:'NotificationClientListCtrl',periods:$scope.periods,size:'lg',resolve:{data:function data(){return $scope.clientsNoPendency;},header:function header(){return'Clientes bloqueados sem pendencia no financeiro!';}}});});};$scope.printFillBaixa=function(){var columns=[{title:"Nome",dataKey:"Nome"},{title:"Nº Borderô",dataKey:"Numero"},{title:"Valor Baixado",dataKey:"Valor"},{title:"Status",dataKey:"Status"}];var rows=[];for(var i in $scope.checkedrows){var c=$scope.checkedrows[i];rows.push({Nome:c.client,Numero:c.ourNumber,Valor:$rootScope.formatNumber(c.actual_value-c.alreadyPaid,2),Status:c.client_status});}return[columns,rows];};$scope.printBaixa=function(isSave){var resp=$scope.printFillBaixa();if(isSave){var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(6);var columns=resp[0];var rows=resp[1];doc.autoTable(columns,rows,{theme:"grid",styles:{fontSize:6,overflow:"linebreak"},margin:{horizontal:10},bodyStyles:{valign:"top",halign:"left"}});var finalY=doc.autoTableEndPosY()+12;var txt="Quantidade Total: "+$scope.totalDataMark;doc.text(20,finalY,txt);var lineHeight=doc.getLineHeight(txt)/doc.internal.scaleFactor;txt="Preço Total: R$"+$rootScope.formatNumber($scope.totalPrecoMark,2);doc.text(20,finalY+lineHeight+6,txt);if($scope.payment_date!=''){txt="Data Pagamento: "+$scope.payment_date;doc.text(20,finalY+lineHeight+18,txt);}doc.save("Relatório_Baixa.pdf");}return JSON.stringify(resp);};$scope.getStatusDesc=function(billetreceive){if(billetreceive.actual_value<0){if(billetreceive.status=='T')return"Transferencia";if(billetreceive.status=='T')return"Cancelamento";return"Reembolso";}switch(billetreceive.status){case'B':return"Pago";case'T':return"Transferencia";case'C':return"Cancelamento";case'E':var dueDate=new Date(billetreceive.due_date);if(dueDate<new Date()){return"Atrasado";}return"Em Aberto";case'A':var dueDate=new Date(billetreceive.due_date);if(dueDate<new Date()){return"Atrasado";}return"Em Aberto";case'C':return"Cancelado";}};$scope.billReceiveTag=function(billetreceive){switch(billetreceive.status){case'B':return"label label-success";case'E':return"label label-info";case'A':return"label label-warning";case'C':return"label label-error";case'T':return"label label-default";case'C':return"label label-default";}};$scope.fillEmailAll=function(){$scope.selected=this.billetreceive;$scope.billet.emailpartner=$scope.selected.email;$scope.billet.client=$scope.selected.client;$scope.billet.mailcc='';$scope.billet.subject='BOLETO - ONE MILHAS - VENCIMENTO '+$filter('date')($rootScope.findDate($scope.selected.due_date),'dd/MM/yyyy')+'  - '+$scope.selected.ourNumber;$.post("../backend/application/index.php?rota=/loadBilletBills",{data:$scope.selected},function(result){$scope.billsreceive=jQuery.parseJSON(result).dataset;$scope.billet.emailContent="<br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'>"+"<tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'><b>Dados</b></font></td></tr>"+"<tr><td>Data</td><td>Passageiro</td><td>Localizador</td><td>Trecho</td><td>CIA</td><td>Valor</td><td>Emissor</td><td>Cliente</td>";if($scope.billetGenerated){$scope.billet.emailContent+="<td>Bordero</td>";}$scope.billet.emailContent+="</tr>";$scope.checkedrows=$filter('filter')($scope.billsreceive,true);for(var i=0;$scope.checkedrows.length>i;i++){$scope.billet.emailContent+="<tr><td>"+$filter('date')($scope.checkedrows[i].issuing_date,'dd/MM/yyyy')+"</td><td>";if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.billet.emailContent+=$scope.checkedrows[i].description+"</td><td>";}else{$scope.billet.emailContent+=$scope.checkedrows[i].pax_name+"</td><td>";}$scope.billet.emailContent+=$scope.checkedrows[i].flightLocator+"</td><td>"+$scope.checkedrows[i].from+"-"+$scope.checkedrows[i].to+"</td><td>"+$scope.checkedrows[i].airline+"</td>";if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.billet.emailContent+="<td><font color='red'>"+$rootScope.formatNumber(-$scope.checkedrows[i].actual_value)+"</font></td>";}else{$scope.billet.emailContent+="<td>"+$rootScope.formatNumber($scope.checkedrows[i].actual_value)+"</td>";}$scope.billet.emailContent+="<td>"+$scope.checkedrows[i].issuing+"</td><td>"+$scope.checkedrows[i].client+"</td>";if($scope.billetGenerated){if($scope.checkedrows[i].status=='E'){$scope.billet.emailContent+="<td>"+$scope.checkedrows[i].billet+"<td>";}else{$scope.billet.emailContent+="<td><td>";}}$scope.billet.emailContent+="</tr>";}$scope.billet.emailContent+="<tr><td></td><td></td><td></td><td></td><td><b>Total:</b></td><td><b>"+$rootScope.formatNumber($scope.selected.actual_value)+"</b></td><td></td><td></td></tr>";$scope.billet.emailContent+="</tbody></table><br><br><b>Vencimento: "+$filter('date')($rootScope.findDate($scope.selected.due_date),'dd/MM/yyyy')+" </b>"+"<br><br><b>Numero boleto: "+$scope.selected.ourNumber+"</b>";if($scope.selected.actual_value<0){$scope.billet.subject='BORDERO DE REEMBOLSO ONE MILHAS - '+$scope.selected.ourNumber;}if($scope.selected.discount>0){$scope.billet.emailContent+="<br><br><b>Descontos: "+$rootScope.formatNumber($scope.selected.discount)+"</b>";}$scope.tabindex=2;$scope.$apply();});};$scope.fillEmailContent=function(){$scope.billet.emailpartner=$scope.selected.email;$scope.billet.client=$scope.selected.client;$scope.billet.mailcc='';$scope.billet.subject='BOLETO(S) ATUALIZADO(S) - URGENTE!!';$scope.billet.emailContent="Bom dia,<br><br>Aguardamos o(s) pagamento(s) do(s) boleto(s) em anexo: ";$scope.selected.due_date=$rootScope.formatServerDate($scope.selected._due_date);$scope.selected.actual_value=$('#actual').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.billetsClient=jQuery.parseJSON(result).dataset.billetreceive;var actualDate=new Date();for(var i in $scope.billetsClient){if($scope.billetsClient[i].actual_value>0){var dueDate=new Date($scope.billetsClient[i].due_date);dueDate.setDate(dueDate.getDate()+1);if(new Date($scope.billetsClient[i].due_date)<new Date()){if($scope.billetsClient[i].ourNumber=='ACORDO'){$scope.billet.emailContent+="<br>BORDERO "+$scope.billetsClient[i].ourNumber+" Valor: R$"+$rootScope.formatNumber($scope.billetsClient[i].actual_value);}else{$scope.billet.emailContent+="<br>BORDERO "+$scope.billetsClient[i].ourNumber;}}}}});for(var i in $scope.billetsDivision){$scope.billetsDivision[i]._dueDate=$rootScope.formatServerDate($scope.billetsDivision[i].dueDate);}$.post("../backend/application/index.php?rota=/saveChangeValue",{hashId:$scope.session.hashId,data:$scope.selected,billetsDivision:$scope.billetsDivision},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=2;$scope.$apply();});};$scope.removeDivision=function(){$scope.billetsDivision.pop();};$scope.addDivision=function(){$scope.billetsDivision.push({name:'',actualValue:0,dueDate:new Date(),paid:false});};$scope.fillEmailAdvising=function(){if($scope.advising){$scope.selected=this.billetreceive;$scope.billet.emailpartner=$scope.selected.financial_email?$scope.selected.financial_email:$scope.selected.email;$scope.billet.client=$scope.selected.client;$scope.billet.mailcc='';$scope.billet.subject='LEMBRETE VENCIMENTO BOLETO(S)';$scope.billet.emailContent="<br><br>Bom dia,<br><br>Lembramos o(s) vencimento(s) do(s) boleto(s) com as referências abaixo. Pague em dia, evite juros.<br>Caso já tenha pago, favor desconsiderar o e-mail.";$scope.selected.type='advising';$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.billetsClient=jQuery.parseJSON(result).dataset.billetreceive;var actualDate=new Date();for(var i in $scope.billetsClient){if($scope.billetsClient[i].actual_value>0){var dueDate=new Date($scope.billetsClient[i].due_date);dueDate.setDate(dueDate.getDate()+1);if(dueDate.getDate()==actualDate.getDate()&&dueDate.getMonth()==actualDate.getMonth()&&dueDate.getFullYear()==actualDate.getFullYear()){$scope.billet.emailContent+="<br><br>A VENCER / VENCIDO  -  "+$scope.billetsClient[i].client+"  -  "+$scope.billetsClient[i].ourNumber+"  -  "+$filter('date')($scope.billetsClient[i].due_date,'dd/MM/yyyy')+"  -  "+$rootScope.formatNumber($scope.billetsClient[i].actual_value-$scope.billetsClient[i].alreadyPaid);}}}$scope.billet.emailContent+="<br><br><br>Obrigado pela parceria!";$scope.tabindex=2;$scope.$apply();});}else{$scope.selected=this.billetreceive;$scope.billet.emailpartner=$scope.selected.financial_email?$scope.selected.financial_email:$scope.selected.email;$scope.billet.client=$scope.selected.client;$scope.billet.mailcc='';$scope.billet.subject='BOLETO(S) ATUALIZADO(S) - URGENTE!!';$scope.billet.emailContent="Bom dia,<br><br>Aguardamos o(s) pagamento(s) do(s) boleto(s) em anexo: <br>";$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.billetsClient=jQuery.parseJSON(result).dataset.billetreceive;var actualDate=new Date();for(var i in $scope.billetsClient){if($scope.billetsClient[i].actual_value>0){var dueDate=new Date($scope.billetsClient[i].due_date);dueDate.setDate(dueDate.getDate()+1);if(dueDate<actualDate){if($scope.billetsClient[i].ourNumber=='ACORDO'){$scope.billet.emailContent+="<br>BORDERO "+$scope.billetsClient[i].ourNumber+" Valor: R$"+$rootScope.formatNumber($scope.billetsClient[i].actual_value);}else{$scope.billet.emailContent+="<br>BORDERO "+$scope.billetsClient[i].ourNumber;}}}}$.post("../backend/application/index.php?rota=/saveChangeValue",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=2;$scope.$apply();});});}};$scope.findColor=function(billetreceive){var dueDate=new Date(billetreceive.due_date);var actualDate=new Date();if(billetreceive.status=='B'){return"#9DCE9D";}if(dueDate.getDate()==actualDate.getDate()&&dueDate.getMonth()==actualDate.getMonth()&&dueDate.getFullYear()==actualDate.getFullYear()){return"#F5F5C8";}else if(dueDate<actualDate){return"#F38E8E";}};$scope.printB=function(){var doc=new jsPDF('l','pt');doc.margin=0.5;doc.setFontSize(18);doc.text(150,30,'Borderô - '+$scope.selected.client+' - '+$filter('date')($scope.selected.due_date,'dd/MM/yyyy'));var columns=[{title:"Data",dataKey:"due_date"},{title:"Descrição",dataKey:"description"},{title:"Trecho",dataKey:"airports"},{title:"CIA",dataKey:"airline"},{title:"Valor",dataKey:"value"},{title:"Emissor",dataKey:"issuing"},{title:"Cliente",dataKey:"client"}];var rows=[];for(var i=0;i<$scope.billsreceive.length;i++){rows.push({due_date:$filter('date')($scope.billsreceive[i].issuing_date,'dd/MM/yyyy'),description:$scope.billsreceive[i].description,airports:$scope.billsreceive[i].from+"-"+$scope.billsreceive[i].to,airline:$scope.billsreceive[i].airline,value:$rootScope.formatNumber($scope.billsreceive[i].actual_value),issuing:$scope.billsreceive[i].issuing,client:$scope.billsreceive[i].client});}rows.push({due_date:'Numero:',description:$scope.selected.ourNumber});rows.push({due_date:'Total:',description:$rootScope.formatNumber($scope.selected.actual_value)});rows.push({due_date:'Vencimento:',description:$filter('date')($scope.selected.due_date,'dd/MM/yyyy')});doc.autoTable(columns,rows,{styles:{fontSize:8,overflow:'linebreak'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='value'){cell.styles.halign='right';}}});doc.save('Bordero_'+$scope.selected.client+'_'+$filter('date')($scope.selected.due_date,'dd/MM/yyyy')+'.pdf');};$scope.printTotalDebits=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(16);doc.setTextColor(0);doc.setFontStyle('bold');doc.text('IDEAL VIAGENS',200,50);var columns=[{title:"Cliente",dataKey:"client"},{title:"Bordero",dataKey:"ourNumber"},{title:"VALOR-PAGO",dataKey:"actualValue"},{title:"ATUAL",dataKey:"valueBillReceive"},{title:"Status",dataKey:"status"}];var rows=[];for(var i in $scope.billetsClient){rows.push({client:$scope.billetsClient[i].client,status:$scope.billetsClient[i].status});for(var j in $scope.billetsClient[i].billets){rows.push({ourNumber:$scope.billetsClient[i].billets[j].our_number,actualValue:$rootScope.formatNumber($scope.billetsClient[i].billets[j].actualValue)+' - '+$rootScope.formatNumber($scope.billetsClient[i].billets[j].alreadyPaid),valueBillReceive:$rootScope.formatNumber($scope.billetsClient[i].billets[j].value)});}}rows.push({ourNumber:'Total:',valueBillReceive:$rootScope.formatNumber($scope.getTotal())});doc.autoTable(columns,rows,{theme:'plain',styles:{fontSize:8,overflow:'linebreak'},margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='actual_value'){cell.styles.halign='right';}}});doc.save('Debitos.pdf');};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/mailOrder",{data:$scope.billet,attachment:file,type:'FINANCEIRO',origin:$scope.selected.origin,emailType:'EMAIL-GMAIL'},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.uploader.clearQueue();cfpLoadingBar.complete();if($scope.advising){$scope.loadTodaysOpened();}else{$scope.loadOpened();}$scope.tabindex=0;$scope.apply();});};$scope.blockClient=function(client){if(client.status=='Bloqueado'){client.status='Aprovado';}else client.status='Bloqueado';cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveClientStatus",{hashId:$scope.session.hashId,data:client},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadDefaulters();});};$scope.saveBillets=function(clients){$.post("../backend/application/index.php?rota=/saveBilletsValue",{data:clients},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadDefaulters();});};$scope.intentToSaveBillets=function(clients){$rootScope.$emit('openDebitsValuesLogModal',clients);};$scope.getTotal=function(){var total=0;if($scope.debits||$scope.Anticipated){if($scope.billetsClient){if($scope.billetsClient.length>0){for(var i in $scope.billetsClient){total+=$scope.billetsClient[i].billets[$scope.billetsClient[i].billets.length-1].value;}}}}return total;};$scope.setActual_Value=function(){if($scope.selected.original_value>=$scope.selected.actual_value)$scope.selected.discount=$scope.selected.original_value-$scope.selected.actual_value;else $scope.selected.tax=$scope.selected.actual_value-$scope.selected.original_value;$scope.selected.actual_value=parseFloat($scope.selected.original_value)+parseFloat($scope.selected.tax)-parseFloat($scope.selected.discount);};$scope.setAsLoss=function(billlet){$.post("../backend/application/index.php?rota=/setAsLoss",{hashId:$scope.session.hashId,data:billlet},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadDefaulters();});};$scope.getChecked=function(selected){if(selected.status=='L'){return true;}return false;};$scope.getDayOfDelay=function(date){var date1=new Date();var delayed=new Date(date);var diffDays='';if(date!=''&&delayed!='Invalid Date'){var timeDiff=Math.abs(delayed.getTime()-date1.getTime());diffDays=Math.ceil(timeDiff/(1000*3600*24));}return diffDays;};$scope.loadDefaulters=function(){$scope.debits=true;$scope.Anticipated=false;$scope.showTable=false;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClientsDebits",{hashId:$scope.session.hashId,data:$scope.selected,filter:$scope.filterDebits},function(result){$scope.billetsClient=jQuery.parseJSON(result).dataset;$scope.filterDebits={};$scope.$digest();cfpLoadingBar.complete();});};$scope.setFilter=function(dayFrom,dayTo){$scope.filterDebits.dayFrom=dayFrom;$scope.filterDebits.dayTo=dayTo;$scope.loadDefaulters();};$scope.loadAnticipatedDebtis=function(){$scope.Anticipated=true;$scope.debits=false;$scope.showTable=false;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadAnticipatedDebits",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.billetsClient=jQuery.parseJSON(result).dataset;$scope.$apply();cfpLoadingBar.complete();});};$scope.loadClientAnalisys=function(){$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$scope.debits=false;$scope.Anticipated=false;$scope.clientAnalisys=true;$scope.tabindex=-1;};$scope.findClient=function(){if($scope.filterHistoric.client){var request={type:'advising',client:$scope.filterHistoric.client};$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session.hashId,data:request},function(result){$scope.ClientHistoric=jQuery.parseJSON(result).dataset.billetreceive;$scope.filteredClientHistoric=$scope.ClientHistoric;$scope.$digest();});}else{logger.logError('Cliente deve ser definido');}};$scope.newAgreement=function(){$("#valueAgreement").maskMoney({thousands:'.',decimal:',',precision:2});$scope.billetAgreement={};$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$scope.agreement=true;$scope.debits=false;$scope.Anticipated=false;$scope.tabindex=-1;};$scope.generateBilletAgreement=function(){$scope.billetAgreement.actualValue=$('#valueAgreement').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/saveBilletAgreement",{hashId:$scope.session.hashId,data:$scope.billetAgreement},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.agreement=false;$scope.billetAgreement={};$scope.tabindex=0;$scope.$digest();});};$scope.filterClientDebits=function(){$scope.filteredClientHistoric=[];if($scope.filterClient.refund){for(var i in $scope.ClientHistoric){if($scope.ClientHistoric[i].actual_value>0){$scope.filteredClientHistoric.push($scope.ClientHistoric[i]);}}}else{$scope.filteredClientHistoric=$scope.ClientHistoric;}};$scope.getTotalClient=function(){var total=0;for(var i in $scope.filteredClientHistoric){if($scope.filteredClientHistoric[i].status==''){total+=$scope.filteredClientHistoric[i].actual_value;}else{total+=$scope.filteredClientHistoric[i].actual_value-$scope.filteredClientHistoric[i].alreadyPaid;}}return total;};$scope.getUrlContaAzul=function(){$.post("../backend/application/index.php?rota=/ContaAzul/authorize",{},function(result){$scope.redirectToGoogle(jQuery.parseJSON(result).dataset['url']);});};$scope.redirectToGoogle=function(link){$window.open(link,'_blank');};$scope.getTotalFiltered=function(){var total=0;if($scope.filteredBilletsReceive){for(var i in $scope.filteredBilletsReceive){if($scope.filteredBilletsReceive[i].status=='B'){total+=$scope.filteredBilletsReceive[i].actual_value;}else{total+=$scope.filteredBilletsReceive[i].actual_value-$scope.filteredBilletsReceive[i].alreadyPaid;}}}return total;};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBilletsReceive=[];$scope.currentPageBillsReceive=[];$rootScope.hashId=$scope.session.hashId;$scope.reader=new FileReader();init=function init(){$scope.file;$scope.advising=false;$scope.opened=false;$scope.clientAnalisys=false;$scope.agreement=false;$scope.billetsDivision=[];$scope.filterDebits={};$scope.receive=false;$scope.showTable=false;$scope.debits=false;$scope.Anticipated=false;$scope.tabindex=0;$scope.checkValidRoute();$scope.loadData();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});$rootScope.modalOpen=false;};return init();}]).controller('BilletModalCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.filterclients=$scope.$parent.clients;$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"BilletFilter.html",controller:'BilletModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!==undefined){filter._dueDateFrom=$rootScope.formatServerDate(filter.dueDateFrom);filter._dueDateTo=$rootScope.formatServerDate(filter.dueDateTo);filter._issueDateFrom=$rootScope.formatServerDate(filter.issueDateFrom);filter._issueDateTo=$rootScope.formatServerDate(filter.issueDateTo);filter._paymentDateFrom=$rootScope.formatServerDate(filter.paymentDateFrom);filter._paymentDateTo=$rootScope.formatServerDate(filter.paymentDateTo);}$scope.$parent.filter=filter;$scope.$parent.loadBillets();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('BilletModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.billStatus=['Em aberto','Emitida','Baixada','Cancelado'];$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('CloseModalCtrl',['$scope','$rootScope','$modal','$filter','$log',function($scope,$rootScope,$modal,$filter,$log){$scope.filterclients=$scope.$parent.clients;$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"CloseBillet.html",controller:'CloseModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter.payment_date!==undefined){$scope.$parent.payment_date=filter.payment_date.toLocaleDateString();$scope.checkedrows=[];for(var i in $scope.$parent.billetsreceive){if($scope.$parent.billetsreceive[i].checked){$scope.checkedrows.push($scope.$parent.billetsreceive[i]);}}for(var i in $scope.checkedrows){$scope.checkedrows[i].payment_date=$rootScope.formatServerDate(filter.payment_date);}if($scope.selected){$scope.selected.actual_value=$('#actual').maskMoney('unmasked')[0];}$scope.$parent.saveCloseReceive();}});};}]).controller('CloseModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('TodayFinancialEmailsModalCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.open=function(){if($scope.$parent.advising){$scope.filter='LEMBRETE VENCIMENTO BOLETO';}else if($scope.$parent.opened){$scope.filter='BOLETO ATUALIZADO';}else{$scope.filter='';}var modalInstance;modalInstance=$modal.open({templateUrl:"TodayFinancialEmailsModalCtrl.html",controller:'TodayFinancialEmailsModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){});};}]).controller('TodayFinancialEmailsModalInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','filter',function($scope,$rootScope,$modalInstance,$filter,filter){$scope.filter=filter;$.post("../backend/application/index.php?rota=/loadTodayEmails",{hashId:$rootScope.hashId},function(result){$scope.emails=jQuery.parseJSON(result).dataset;$scope.emails=$filter('filter')($scope.emails,$scope.filter);$scope.total=$scope.emails.length;$scope.$apply();});$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('BillsgeneratedChangeCtrl',['$scope','$rootScope','$modal','$log','$filter','logger',function($scope,$rootScope,$modal,$log,$filter,logger){$scope.open=function(){$scope.bill=this.billreceive;$scope.bill=angular.copy($scope.bill);var modalInstance;modalInstance=$modal.open({templateUrl:"BillsgeneratedChangeCtrl.html",controller:'BillsgeneratedChangeInstanceCtrl',resolve:{main:function main(){return $scope.$parent.$parent.$parent.$parent.main;},hashId:function hashId(){return $scope.$parent.$parent.$parent.$parent.session.hashId;},bill:function bill(){return $scope.bill;}}});modalInstance.result.then(function(bill){if(bill){$.post("../backend/application/index.php?rota=/changeBillValue",{hashId:$scope.$parent.$parent.$parent.session.hashId,data:bill},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.$parent.loadBilletBills();$scope.$parent.$parent.$apply();});}else{$scope.$parent.$parent.loadBilletBills();$scope.$parent.$parent.$apply();}});};}]).controller('BillsgeneratedChangeInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','main','hashId','bill',function($scope,$rootScope,$modalInstance,logger,main,hashId,bill){$scope.main=main;$scope.hashId=hashId;$scope.bill=bill;$scope.checked=true;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.remove=function(){$.post("../backend/application/index.php?rota=/removeBill",{hashId:$scope.hashId,data:$scope.bill},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(undefined);});};$scope.ok=function(){$modalInstance.close($scope.bill);};}]).controller('DebitsValuesModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openDebitsValuesLogModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"DebitsValuesModal.html",controller:'DebitsValuesLogInstanceCtrl',resolve:{selected:function selected(){return args;}}});modalInstance.result.then(function(resolve){$scope.$parent.saveBillets(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('DebitsValuesLogInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','selected',function($scope,$rootScope,$modalInstance,logger,selected){$scope.selected=selected;$scope.selected.resolveDescription='';$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selected.resolveDescription.length<1)return logger.logError('Motivos devem ser informados');$modalInstance.close($scope.selected);};}]).controller("infoBaixaModalInstanceCtrl",["$scope","$rootScope","$modalInstance",function($scope,$rootScope,$modalInstance){$scope.ok=function(){$modalInstance.close("ok");};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){"use strict";angular.module("app.table",["ui.calendar"]).controller("PurchaseBillsPayCtrl",["$scope","$rootScope","$filter","$modal","cfpLoadingBar","logger","FileUploader",function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader){var init;$scope.accountType=["Compra Milhas"];$scope.paymentType=["Cartão de Crédito","Deposito em Conta","Boleto Bancario","Reembolso"];$scope.periods=["Ultimos 30 dias","Mes Corrente","Semana Corrente","Hoje"];$scope.searchKeywords="";$scope.filteredBillsPay=[];$scope.row="";$scope.select=function(page){$scope.loadData();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row="";};$scope.onNumPerPageChange=function(){$scope.loadData();};$scope.findColor=function(billpay){var dueDate=new Date(billpay.due_date);var actualDate=new Date();dueDate.setDate(dueDate.getDate()+1);if(billpay.status=="B"){return"#9DCE9D";}if(dueDate.getDate()==actualDate.getDate()&&dueDate.getMonth()==actualDate.getMonth()&&dueDate.getFullYear()==actualDate.getFullYear()){return"#E2E298";}if(dueDate<actualDate){return"#FBA1A1";}};$scope.findDate=function(date){if(date==""){return"";}return new Date(date);};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.setSelected=function(){$scope.selected=this.billpay;$scope.selected._due_date=new Date($scope.selected.due_date);$scope.selected._due_date.setDate($scope.selected._due_date.getDate()+1);$scope.tabindex=1;$("#bpay_actualvalue").number(true,2,",",".");$("#bpay_tax").number(true,2,",",".");$("#bpay_discount").number(true,2,",",".");return $scope.selected;};$scope.print=function(){var doc=new jsPDF("l","pt");doc.margin=0.5;doc.setFontSize(20);doc.text(150,30,"Contas a Pagar");var columns=[{title:"Status",dataKey:"status"},{title:"Fornecedor",dataKey:"partner"},{title:"Email",dataKey:"email"},{title:"Telefone",dataKey:"phone"},{title:"Tipo de Conta",dataKey:"account_type"},{title:"Valor original",dataKey:"original_value"},{title:"Desconto",dataKey:"discount"},{title:"Valor Atual",dataKey:"actual_value"},{title:"Vencimento",dataKey:"due_date"},{title:"Tipo de Pagamento",dataKey:"payment_type"}];var rows=[];for(var i=0;i<$scope.filteredBillsPay.length;i++){rows.push({status:$scope.getStatusDesc($scope.filteredBillsPay[i].status),partner:$scope.filteredBillsPay[i].provider,email:$scope.filteredBillsPay[i].email,phone:$scope.filteredBillsPay[i].phoneNumber,account_type:$scope.filteredBillsPay[i].account_type,original_value:$rootScope.formatNumber($scope.filteredBillsPay[i].original_value),discount:$rootScope.formatNumber($scope.filteredBillsPay[i].discount),actual_value:$rootScope.formatNumber($scope.filteredBillsPay[i].actual_value),due_date:$filter("date")($scope.filteredBillsPay[i].due_date,"dd/MM/yyyy"),payment_type:$scope.filteredBillsPay[i].payment_type});}doc.autoTable(columns,rows,{styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==="original_value"){cell.styles.halign="right";}if(data.column.dataKey==="discount"){cell.styles.halign="right";}if(data.column.dataKey==="actual_value"){cell.styles.halign="right";}}});doc.save("Contas_A_Pagar.pdf");};$scope.getStatusDesc=function(status){if(status=="B"){return"Baixada";}else{return"Em Aberto";}};$scope.toggleFormTable=function(){$scope.tabindex=0;};$scope.cancelBillsPay=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_justification.html",controller:"ModalJustificationCtrl",resolve:{header:function header(){return"Digite o motivo da exclusão";}}});modalInstance.result.then(function(filter){$scope.selected.deleteDescription=filter;$.post("../backend/application/index.php?rota=/cancelBillsPay",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.loadData();});});};$scope.billPayTag=function(status){if(status=="B"){return"label label-success";}else{return"label label-warning";}};$scope.addRow=function(){if(!$scope.main.isMaster){if(this.billpay.status=="B"){this.billpay.checked=false;}}};$scope.getDataHoje=function(){var hoje=new Date();var dd=String(hoje.getDate()).padStart(2,'0');var mm=String(hoje.getMonth()+1).padStart(2,'0');var yyyy=hoje.getFullYear();return yyyy+'-'+mm+'-'+dd;};$scope.filtroHoje=function(){var from=new Date();from.setHours(0,0,1);var to=new Date();from.setHours(23,59,59);$scope.filter={dueDateFrom:from,_dueDateFrom:$scope.getDataHoje(),dueDateTo:to,_dueDateTo:$scope.getDataHoje()};$scope.loadData();};$scope.search=function(){$scope.loadData();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadData();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadData();};$scope.loadData=function(){if(!$scope.filter.providerName&&!$scope.filter.payment_id&&!$scope.filter.status&&!$scope.filter.airline&&!$scope.filter.account_type&&!$scope.filter.payment_type&&!$scope.filter.dueDateFrom&&!$scope.filter.dueDateTo){void 0;return;}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSumOpenedBillsPayPurchase",{data:$scope.filter},function(result){$scope.sumOpenedbillspay=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadBillsPayPurchase",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.billpays=jQuery.parseJSON(result).dataset.billpays;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.$digest();});};$scope.filterproviders=$scope.$parent.providers;$scope.saveClosePay=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"BillPayTwo.html",controller:"BillPayModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{filter:function filter(){return{dueDateFromPay:new Date()};}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._dueDateFrom=$rootScope.formatServerDate(filter.dueDateFromPay);}$scope.checkedrows=$filter("filter")($scope.billpays,true);$.post("../backend/application/index.php?rota=/saveClosePay",{hashId:$scope.session.hashId,checkedrows:$scope.checkedrows,filter:filter},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.fillEmail();});},function(){$log.info("Modal dismissed at: "+new Date());});};$scope.saveBillPay=function(){$scope.checkedrows=$filter("filter")($scope.billspay,true);$scope.selected.due_date=$rootScope.formatServerDate($scope.selected._due_date);$.post("../backend/application/index.php?rota=/saveBillPay",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.back();});};$scope.setActual_Value=function(){$scope.selected.actual_value=parseFloat($scope.selected.original_value)+parseFloat($scope.selected.tax)-parseFloat($scope.selected.discount);};$scope.sendEmail=function(){$scope.checkedrows=[];$scope.checkedrows.push(this.billpay);$scope.fillEmail();};$scope.fillEmail=function(){$scope.email.emailpartner="";$scope.email.mailcc="";$scope.email.subject="[Aviso de Pagamento] - One Milhas";$scope.email.emailContent="";var and="";for(var i in $scope.checkedrows){$scope.email.emailpartner+=and+$scope.checkedrows[i].email;and=";";if($scope.checkedrows[i].airline=="TAM"||$scope.checkedrows[i].airline=="LATAM"){if($scope.checkedrows[i].card_type=="RED"||$scope.checkedrows[i].card_type=="BLACK"){$scope.email.emailContent+="Olá!<br><br>"+"Segue em anexo comprovante de pagamento referente à compra de "+$scope.checkedrows[i].purchased_miles+" do programa Latam Pass.<br>"+"Assim que confirmado a disponibilidade do valor em conta, nos responda esse e-mail com a SENHA DE ACESSO e a SENHA DE RESGATE. Entraremos em contato para incluir um telefone nosso eu seu cadastro Latam Pass, para que possamos utilizar os pontos.<br>"+"<br>ATENÇÃO: caso a companhia aérea entre em contato, confirme as emissões e os demais dados solicitados, caso tenha qualquer tipo de problema na confirmação nos comunique de imediato.<br>"+"O prazo de utilização dos pontos é de 180 dias da data de envio da senha. Caso tenha que alterar a senha dentro do prazo de 180 dias, pedimos que nos comunique imediatamente para que possamos atualizar em nosso sistema. Mesmo que tenhamos utilizado todos os pontos.<br><br>"+"Gostou da One Milhas? Faça uma breve avaliação e ajude mais pessoas a venderem pontos!!!"+"<br>Facebook: <a href=''>Clique aqui</a> <br>"+"Instagram: <a href='https://instagram.com/one.milhas?igshid=19fbm6umf8q66'>Clique aqui</a><br>"+"<br><br>Atenciosamente<br>"+"Equipe One Milhas";}else{$scope.email.emailContent+="Olá!<br><br>"+"Segue em anexo comprovante de pagamento referente à compra de "+$scope.checkedrows[i].purchased_miles+" do programa Latam Pass.<br>"+"Assim que confirmado a disponibilidade do valor em conta, nos responda esse e-mail com a SENHA DE ACESSO e a SENHA DE RESGATE. Entraremos em contato para incluir um telefone nosso eu seu cadastro Latam Pass, para que possamos utilizar os pontos.<br><br>"+"ATENÇÃO: caso a companhia aérea entre em contato, confirme as emissões e os demais dados solicitados, caso tenha qualquer tipo de problema na confirmação nos comunique de imediato.<br>"+"O prazo de utilização dos pontos é de 180 dias da data de envio da senha. Caso tenha que alterar a senha dentro do prazo de 180 dias, pedimos que nos comunique imediatamente para que possamos atualizar em nosso sistema. Mesmo que tenhamos utilizado todos os pontos.<br><br>"+"Gostou da One Milhas? Faça uma breve avaliação e ajude mais pessoas a venderem pontos!!!"+"<br>Facebook: <a href=''>Clique aqui</a> <br>"+"Instagram: <a href='https://instagram.com/one.milhas?igshid=19fbm6umf8q66'>Clique aqui</a><br>"+"<br><br>Atenciosamente<br>"+"Equipe One Milhas";}}else if($scope.checkedrows[i].airline=="GOL"){$scope.email.emailContent+="Olá!<br><br>"+"Segue em anexo comprovante de pagamento referente à compra de "+$scope.checkedrows[i].purchased_miles+" pontos do programa SMILES/GOL.<br>"+"Assim que confirmado a disponibilidade do valor em conta, nos responda esse e-mail com a SENHA DE ACESSO.<br><br>"+"ATENÇÃO: caso a companhia aérea entre em contato, confirme as emissões e os demais dados solicitados, caso tenha qualquer tipo de problema na confirmação nos comunique de imediato. O prazo de utilização dos pontos é de 180 dias da data de envio da senha. Caso tenha que alterar a senha dentro do prazo de 180 dias, pedimos que nos comunique imediatamente para que possamos atualizar em nosso sistema. Mesmo que tenhamos utilizado todos os pontos.<br><br>"+"Gostou da One Milhas? Faça uma breve avaliação e ajude mais pessoas a venderem pontos!!!"+"<br>Facebook: <a href=''>Clique aqui</a> <br>"+"Instagram: <a href='https://instagram.com/one.milhas?igshid=19fbm6umf8q66'>Clique aqui</a><br>"+"<br><br>Atenciosamente, <br>"+"Equipe One Milhas";}else if($scope.checkedrows[i].airline=="AVIANCA"){$scope.email.emailContent+="Olá!<br><br>"+"Segue em anexo comprovante de pagamento referente à compra de "+$scope.checkedrows[i].purchased_miles+" pontos do programa AMIGO/AVIANCA.<br>"+"Pedimos, assim que confirmado a disponibilidade do valor em conta, nos responda esse e-mail com a SENHA.<br>"+"Pedimos também atenção, caso a CIA  Aérea entre em contato, confirme as emissões e os demais dados solicitados, caso tenha qualquer tipo de problema na confirmação nos comunique de imediato.<br>"+"Atenção: O prazo de utilização dos pontos é de 180 dias da data de envio da senha. Caso tenha que alterar a senha dentro do prazo de 180 dias, pedimos que nos comunique imediatamente para que possamos atualizar em nosso sistema. Mesmo que tenhamos utilizado todos os pontos. <br>"+"Para nós da One Milhas foi um prazer atendê-lo, estamos à disposição caso tenha alguma dúvida.<br>"+"<br><br>Atenciosamente";}else if($scope.checkedrows[i].airline=="AZUL"){$scope.email.emailContent+="Olá!<br><br>"+"Segue em anexo comprovante de pagamento referente à compra de "+$scope.checkedrows[i].purchased_miles+" pontos do programa TUDO AZUL.<br>"+"Assim que confirmado a disponibilidade do valor em conta, nos responda esse e-mail com a SENHA DE ACESSO.<br><br>"+"ATENÇÃO: caso a companhia aérea entre em contato, confirme as emissões e os demais dados solicitados, caso tenha qualquer tipo de problema na confirmação nos comunique de imediato.<br>"+"O prazo de utilização dos pontos é de 180 dias da data de envio da senha. Caso tenha que alterar a senha dentro do prazo de 180 dias, pedimos que nos comunique imediatamente para que possamos atualizar em nosso sistema. Mesmo que tenhamos utilizado todos os pontos. <br><br>"+"Gostou da One Milhas? Faça uma breve avaliação e ajude mais pessoas a venderem pontos!!!"+"<br>Facebook: <a href=''>Clique aqui</a> <br>"+"Instagram: <a href='https://instagram.com/one.milhas?igshid=19fbm6umf8q66'>Clique aqui</a><br>"+"<br><br>Atenciosamente<br>"+"Equipe One Milhas";}else if($scope.checkedrows[i].airline=="TAP"){$scope.email.emailContent+="Olá!<br><br>"+"Segue em anexo comprovante de pagamento referente à compra de "+$scope.checkedrows[i].purchased_miles+" pontos do programa TAP.<br>"+"Assim que confirmado a disponibilidade do valor em conta, nos responda esse e-mail com a SENHA DE ACESSO.<br><br>"+"ATENÇÃO: caso a companhia aérea entre em contato, confirme as emissões e os demais dados solicitados, caso tenha qualquer tipo de problema na confirmação nos comunique de imediato. O prazo de utilização dos pontos é de 180 dias da data de envio da senha. Caso tenha que alterar a senha dentro do prazo de 180 dias, pedimos que nos comunique imediatamente para que possamos atualizar em nosso sistema. Mesmo que tenhamos utilizado todos os pontos.<br><br>"+"Gostou da One Milhas? Faça uma breve avaliação e ajude mais pessoas a venderem pontos!!!"+"<br>Facebook: <a href=''>Clique aqui</a> <br>"+"Instagram: <a href='https://instagram.com/one.milhas?igshid=19fbm6umf8q66'>Clique aqui</a><br>"+"<br><br>Atenciosamente<br>"+"Equipe One Milhas";}}$scope.tabindex=2;$scope.$apply();};$scope.mailOrder=function(){$scope.back();for(var i in $scope.checkedrows){$scope.sendEmailForChecked($scope.email);}};$scope.sendEmailForChecked=function(mail){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:mail,attachment:file,type:"COMPRAS",emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.uploader.clearQueue();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.deleteBillsPay=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_justification.html",controller:"ModalJustificationCtrl",resolve:{header:function header(){return"Digite o motivo da exclusão";}}});modalInstance.result.then(function(filter){$scope.selected.deleteDescription=filter;$.post("../backend/application/index.php?rota=/deleteBillsPayAndProvider",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.loadData();});});};$scope.toCalendar=function(){$scope.tabindex=3;};$scope.back=function(){$scope.tabindex=0;$scope.loadData();return $scope.select($scope.currentPage);};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBillsPay=[];$rootScope.hashId=$scope.session.hashId;init=function init(){$scope.tabindex=0;$scope.checkValidRoute();$scope.filtroHoje();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.formData={hashId:$scope.session.hashId};$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:"customFilter",fn:function fn(item,options){return this.queue.length<10;}});};$scope.events=[];$scope.loadEvents=function(){$.post("../backend/application/index.php?rota=/loadEventsBillsPayPurchaseCalendar",{month:$scope.currentMonth,year:$scope.currentYear},function(data){$scope.UserEvents=JSON.parse(data).dataset;for(var i in $scope.events){$scope.events.splice(i,1);}for(var i in $scope.UserEvents){$scope.UserEvents[i].start=new Date($scope.UserEvents[i].start);$scope.events.push($scope.UserEvents[i]);}$scope.$digest();});};$scope.saveEvent=function(){if($scope.selected.start!="Invalid Date"){$scope.selected._start=$rootScope.formatServerDate($scope.selected.start);}if($scope.selected.end!="Invalid Date"){$scope.selected._end=$rootScope.formatServerDate($scope.selected.end);}$scope.selected.calendar=$scope.selectedCalendar;$.post("../backend/application/index.php?rota=/saveEvent",{hash:$scope.session.hash,data:$scope.selected},function(data){$scope.loadEvents();});};$scope.uiConfig={calendar:{lang:"pt-br",height:"100%",editable:false,viewRender:function viewRender(view,element){$scope.currentMonth=view.start._d.getMonth()+2;$scope.currentYear=view.start._d.getFullYear();$scope.loadEvents();},header:{left:"month agendaWeek agendaDay",center:"",right:"prev,next today"},eventClick:function eventClick(date,jsEvent,view){$scope.alertEventOnClick(date,jsEvent,view);},eventDrop:function eventDrop(event,delta,revertFunc,jsEvent,ui,view){$scope.alertOnDrop(event,delta,revertFunc,jsEvent,ui,view);},eventResize:function eventResize(event,delta,revertFunc,jsEvent,ui,view){$scope.alertOnResize(event,delta,revertFunc,jsEvent,ui,view);}}};$scope.eventRender=function(event,element,view){element.attr({tooltip:event.title,"tooltip-append-to-body":true});$compile(element)($scope);};$scope.alertOnDrop=function(event,delta,revertFunc,jsEvent,ui,view){event.start=event._start._d;if(event.end){event.end=event._end._d;}$scope.saveEvent(event);};$scope.alertOnResize=function(event,delta,revertFunc,jsEvent,ui,view){event.start=event._start._d;if(event.end){event.end=event._end._d;}$scope.saveEvent(event);};$scope.alertEventOnClick=function(date,jsEvent,view){date.start=date._start._d;if(date.end){date.end=date._end._d;}$scope.selected=date;$("#modal-event").click();};$scope.eventSource={url:"http://www.google.com/calendar/feeds/usa__en%40holiday.calendar.google.com/public/basic",className:"gcal-event",currentTimezone:"America/Sao_Paulo"};$scope.uiConfig.calendar.dayNames=["Domingo","Segunda-Feira","Terça-Feira","Quarta-Feira","Quinta-Feira","Sexta-Feira","Sábado"];$scope.uiConfig.calendar.dayNamesShort=["Dom","Seg","Ter","Qua","Qui","Sex","Sab"];$scope.eventSources=[$scope.events,$scope.eventSource];return init();}]).controller("BillPayModalDemoCtrl",["$scope","$rootScope","$modal","$log",function($scope,$rootScope,$modal,$log){$scope.filterproviders=$scope.$parent.providers;$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"BillPay.html",controller:"BillPayModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{filter:function filter(){if($scope.filter.dueDateFrom){$scope.filter.dueDateFrom=undefined;$scope.filter._dueDateFrom=undefined;}if($scope.filter.dueDateTo){$scope.filter.dueDateTo=undefined;$scope.filter._dueDateTo=undefined;}return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._dueDateFrom=$rootScope.formatServerDate(filter.dueDateFrom);filter._dueDateTo=$rootScope.formatServerDate(filter.dueDateTo);}$scope.$parent.filter=filter;$scope.$parent.loadData();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller("BillPayModalInstanceCtrl",["$scope","$rootScope","$modalInstance","$timeout","filter",function($scope,$rootScope,$modalInstance,$timeout,filter){$scope.billStatus=["Em aberto","Baixada"];$scope.accountType=["Taxa DU","Taxa Extra","Taxa Aeroporto","Compra Milhas","Reembolso","Milhas + Money","Contas Comuns"];$scope.paymentType=["Cartão de Crédito","Deposito em Conta","Boleto Bancario","Reembolso"];$scope.filter=filter;$scope.providers=[];var load=undefined;$scope.loadProvider=function(){if(load){$timeout.cancel(load);}load=$timeout($scope.searchProviders(),1000);};$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;if(load){load=undefined;}$scope.$digest();});};$.post("../backend/application/index.php?rota=/loadAirline",{hashId:$scope.$parent.hashId},function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();(function(){'use strict';angular.module('app.table').controller('BillsReceiveCtrl',['$scope','$filter',function($scope,$filter){var init;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.billsreceive=[{id:41,status:"Em Aberto",client:"Roberto Augusto Lopes",email:"robertoalmartins@yahoo.com.br",phoneNumber:"(86)89899009",billType:"Compra de Milhas",description:"10.000 milhas TAM - Fidelidade 45889988",due_date:"31/08/2015",value:"290,00"},{id:41,status:"Em Aberto",client:"Carlos Augusto dos Santos Sampaio",email:"cass@gmail.com",phoneNumber:"(86)89898788",billType:"Compra de Milhas",description:"20.000 milhas GOL - Fidelidade 5435444",due_date:"31/08/2015",value:"580,00"},{id:41,status:"Em Aberto",client:"Gustavo José dos Reis",email:"gjr@yahoo.com.br",phoneNumber:"(31)87889009",billType:"Compra de Milhas",description:"30.000 milhas TAM - Fidelidade 45889988",due_date:"31/08/2015",value:"870,00"},{id:41,status:"Em Aberto",client:"Roberto Augusto Lopes",email:"robertoalmartins@yahoo.com.br",phoneNumber:"(86)89899009",billType:"Compra de Milhas",description:"10.000 milhas TAM - Fidelidade 45889988",due_date:"31/08/2015",value:"290,00"},{id:41,status:"Em Aberto",client:"Carlos Augusto dos Santos Sampaio",email:"cass@gmail.com",phoneNumber:"(86)89898788",billType:"Compra de Milhas",description:"20.000 milhas GOL - Fidelidade 5435444",due_date:"31/08/2015",value:"580,00"},{id:41,status:"Em Aberto",client:"Gustavo José dos Reis",email:"gjr@yahoo.com.br",phoneNumber:"(31)87889009",billType:"Compra de Milhas",description:"30.000 milhas TAM - Fidelidade 45889988",due_date:"31/08/2015",value:"870,00"}];$scope.searchKeywords='';$scope.filteredBillsReceive=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBillsReceive=$scope.filteredBillsReceive.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.setSelected=function(){$scope.selected=this.billreceive;$scope.isTable=false;return $scope.selected;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return $scope.isTable;};$scope.search=function(){$scope.filteredBillsReceive=$filter('filter')($scope.billsreceive,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredBillsReceive=$filter('orderBy')($scope.billsreceive,rowName);return $scope.onOrderChange();};$scope.numPerPageOpt=[3,5,10,20];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBillsReceive=[];init=function init(){$scope.search();$scope.isTable=true;return $scope.select($scope.currentPage);};return init();}]);})();;(function(){'use strict';angular.module('app.cashFlow',['ngTouch','ui.grid','ui.grid.edit','ui.grid.pinning']).controller('BookEntryCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger','$timeout','$interval',function($scope,$rootScope,$filter,cfpLoadingBar,logger,$timeout,$interval){var init;var original;$scope.searchKeywords='';$scope.filteredBookEntries=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBookEntry=$scope.filteredBookEntries.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredBookEntries=$filter('filter')($scope.bookEntries,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){var original=angular.copy(this.bookEntry);$scope.bookEntry=original;$scope.bookEntry.value=$rootScope.formatNumber($scope.bookEntry.value);$("#amount").maskMoney({thousands:'.',decimal:',',precision:2});$scope.tabindex=1;return this.bookEntry;};$scope.newBookEntry=function(){$scope.bookEntry={};$("#amount").maskMoney({thousands:'.',decimal:',',precision:2});$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredBookEntries=$filter('orderBy')($scope.bookEntries,rowName);return $scope.onOrderChange();};$scope.getType=function(type){if(type=="C")return"Custo";if(type=="R")return"Receita";};$scope.getTypeColorClass=function(type){if(type=="C")return"warning";if(type=="R")return"success";};$scope.saveBookEntry=function(){if($scope.form_book_entry.$valid){$scope.bookEntry.value=$('#amount').maskMoney('unmasked')[0];$scope.bookEntry._date=$rootScope.formatServerDate($scope.bookEntry.date);$.post("../backend/application/index.php?rota=/saveBookEntry",{hashId:$scope.session.hashId,data:$scope.bookEntry},function(result){$scope.tabindex=0;logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadBookEntry();});}};$scope.sumFilteredEntrys=function(){var total=0;if($scope.filteredBookEntries.length>0){for(var i in $scope.filteredBookEntries){if($scope.filteredBookEntries[i].cost_center_type=='C'){total-=$scope.filteredBookEntries[i].value;}else{total+=$scope.filteredBookEntries[i].value;}}}return total;};$scope.cancelEdit=function(){$scope.tabindex=0;};$scope.loadBookEntry=function(){$.post("../backend/application/index.php?rota=/loadBookEntryCurrentMonth",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.currentMonth=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadBookEntry",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.bookEntries=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.loadCostCenter=function(){$.post("../backend/application/index.php?rota=/loadCostCenter",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.valueDescriptions=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.toTimeLine=function(){$scope.tabindex=2;$.post("../backend/application/index.php?rota=/loadTimeLine",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.timeLine=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.toCharts=function(){$scope.tabindex=4;$.post("../backend/application/index.php?rota=/loadBookEntryMonth",$scope.session,function(result){$scope.bookEntryAnalysis=jQuery.parseJSON(result).dataset;});};$scope.toGrid=function(){$scope.tabindex=3;if($scope.filterGrid.dateFrom){$scope.filterGrid._dateFrom=$rootScope.formatServerDate($scope.filterGrid.dateFrom);$scope.filterGrid.dateTo=$scope.filterGrid.dateFrom;$scope.filterGrid.dateTo.setMonth($scope.filterGrid.dateTo.getMonth()+1);$scope.filterGrid.dateTo.setDate($scope.filterGrid.dateTo.getDate()-1);$scope.filterGrid._dateTo=$rootScope.formatServerDate($scope.filterGrid.dateTo);}$.post("../backend/application/index.php?rota=/loadGridMonth",{hashId:$scope.session.hashId,data:$scope.filterGrid},function(result){var returnData=jQuery.parseJSON(result).dataset;void 0;$scope.gridOptions.columnDefs=returnData.coluns;$scope.gridOptions.data=returnData.data;$scope.$digest();});};$scope.saveGridValue=function(data){$.post("../backend/application/index.php?rota=/saveGridValue",{hashId:$scope.session.hashId,data:data},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.toGrid();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.cellClicked=function(row,col){var data={entity:row.entity,date:col.field};$rootScope.$emit('openEditBookEntryValueModal',data);};$scope.gridOptions={};$scope.gridOptions.columnDefs=[];$scope.gridOptions.rowHeight=40;$scope.gridOptions.enableFiltering=true;$scope.gridOptions.onRegisterApi=function(gridApi){$scope.gridApi=gridApi;gridApi.edit.on.afterCellEdit($scope,function(rowEntity,colDef,newValue,oldValue){});$interval(function(){$scope.gridApi.core.handleWindowResize();},200);};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBookEntry=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.filterGrid={};$scope.filter={};$rootScope.modalOpen=false;cfpLoadingBar.start();$scope.bookEntryAnalysis=[];$scope.loadBookEntry();$scope.loadCostCenter();};return init();}]).controller('BookEntryModalCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.open=function(){$scope.filter=$scope.$parent.filter;var modalInstance;modalInstance=$modal.open({templateUrl:"BookEntryModalCtrl.html",controller:'BookEntryModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!==undefined){filter._dateFrom=$rootScope.formatServerDate(filter.dateFrom);filter._dateTo=$rootScope.formatServerDate(filter.dateTo);}$scope.$parent.filter=filter;$scope.$parent.loadBookEntry();});};}]).controller('BookEntryModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('EditBookEntryValueModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openEditBookEntryValueModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){$scope.selected={};$scope.selected.date=args.date;$scope.selected.value=args.entity[args.date];$scope.selected.type=args.entity['FLUXO_DE_CAIXA'];var modalInstance;modalInstance=$modal.open({templateUrl:"EditBookEntryValueModal.html",controller:'EditBookEntryValueInstanceCtrl',resolve:{selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(resolve){$scope.$parent.saveGridValue(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('EditBookEntryValueInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','selected',function($scope,$rootScope,$modalInstance,logger,selected){$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){$modalInstance.close($scope.selected);};}]).directive('morrisBookEntryAnalysis',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish26){var colors,data,func,options;data=scope.data;updateInterval=2000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.bookEntryAnalysis,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:["#565252","#4CAD29","#DD2E2E"],resize:true};update=function update(){setTimeout(_finish26,updateInterval);options.data=scope.$parent.bookEntryAnalysis;};_finish26=function finish(){options.data=scope.$parent.bookEntryAnalysis;if(scope.$parent.bookEntryAnalysis.length>0){return new Morris.Bar(options);}else{setTimeout(_finish26,updateInterval);}};return update();}};}]);})();;(function(){'use strict';angular.module('app.marketing').controller('CampanhasB2CCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredPromos=[];$scope.row='';$scope.clientStatus=['Aprovado','Bloqueado'];$scope.setSelected=function(){$scope.selected=this.campanha;$scope.tabindex=1;};$scope.newDealer=function(){$scope.selected={};$scope.tabindex=1;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadCampanha();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadCampanha();};$scope.saveCampanha=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/saveCampanha",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCampanha();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.cancelEdit=function(){$scope.loadCampanha();$scope.tabindex=0;};$scope.loadCampanha=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/loadCampanha",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown},function(result){$scope.campanhas=jQuery.parseJSON(result).dataset.campanhas;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.$digest();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePromos=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadCampanha();$.post("../backend/application/index.php?rota=/marketing/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset.dealers;$scope.$digest();});};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('CardsInUseCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.filter={days:7};$scope.loadCardsInUse=function(){$.post("../backend/application/index.php?rota=/loadCardsInUse",{hashId:$scope.session.hashId},function(result){$scope.Cards=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.removeCardUse=function(card){$.post("../backend/application/index.php?rota=/removeCardUse",{hashId:$scope.session.hashId,data:card},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCardsInUse();});};$scope.saveChangeMiles=function(data){$.post("../backend/application/index.php?rota=/saveChangeMilesAZULSRM",{data:data},function(result){$scope.loadAzulSRM();});};$scope.loadAzulSRM=function(){$.post("../backend/application/index.php?rota=/loadAZULSRMUsage",{},function(result){$scope.AZULSRMUsage=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadAZULMMSUsage",{},function(result){$scope.AZULMMSUsage=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadAZULSRMInUse",{},function(result){$scope.AZULSRMInUSe=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.printReport=function(){$.post("../backend/application/index.php?rota=/loadSalesAzulSRM",{},function(result){$scope.sales=jQuery.parseJSON(result).dataset;var data=[['Dt Venda','Dt Embarque','Dias p embarque','Trecho','Tipo Trecho','Milhas','Loc','Status']];for(var i in $scope.sales){data.push([$filter('date')(new Date($scope.sales[i].issue_date),'dd/MM/yyyy hh:mm:ss'),$filter('date')(new Date($scope.sales[i].boarding_date),'dd/MM/yyyy hh:mm:ss'),$scope.sales[i].date_diff,$scope.sales[i].airport_from+'-'+$scope.sales[i].airport_to,$scope.sales[i].category,parseFloat($scope.sales[i].miles_used),$scope.sales[i].flight_locator,$scope.sales[i].status]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","my_data.csv");document.body.appendChild(link);link.click();});};$scope.printReportLastMonth=function(){$.post("../backend/application/index.php?rota=/loadSalesAzulSRMLastMonth",{},function(result){$scope.sales=jQuery.parseJSON(result).dataset;var data=[['Dt Venda','Dt Embarque','Dias p embarque','Trecho','Tipo Trecho','Milhas','Loc','Status']];for(var i in $scope.sales){data.push([$filter('date')(new Date($scope.sales[i].issue_date),'dd/MM/yyyy hh:mm:ss'),$filter('date')(new Date($scope.sales[i].boarding_date),'dd/MM/yyyy hh:mm:ss'),$scope.sales[i].date_diff,$scope.sales[i].airport_from+'-'+$scope.sales[i].airport_to,$scope.sales[i].category,parseFloat($scope.sales[i].miles_used),$scope.sales[i].flight_locator,$scope.sales[i].status]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","my_data.csv");document.body.appendChild(link);link.click();});};$scope.loadAzulSRM();init=function init(){$scope.checkValidRoute();$scope.loadCardsInUse();};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('CardsLossesCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filtered=[];$scope.row='';$scope.select=function(page){$scope.loadCardsBloqued();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.loadCardsBloqued();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.findColor=function(purchase){if(purchase.payment_status=='A')return"#FBA1A1";else return;};$scope.setSelected=function(){$scope.selected={};$scope.selected=this.cards;$scope.tabindex=1;};$scope.saveStatus=function(){cfpLoadingBar.start();$scope.selected.recovery_password=$scope.ecript($scope.selected.recovery_password);$scope.selected.access_password=$scope.ecript($scope.selected.access_password);if($scope.selected.bloqued){$scope.selected.bloqued='L';}else{$scope.selected.bloqued='N';}$.post("../backend/application/index.php?rota=/saveProviderCards",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$apply();cfpLoadingBar.complete();$scope.loadCardsBloqued();});};$scope.savePrograss=function(){$.post("../backend/application/index.php?rota=/saveCardProgress",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadCardsProgress",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.progress=jQuery.parseJSON(result).dataset;$scope.$apply();});});};$scope.findDate=function(date){return new Date(date);};$scope.ecript=function(code){if(code!=undefined){var data=code.split('');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;}};$scope.cardPassword=function(){for(var i=0;$scope.cardsBloqued.length>i;i++){$scope.cardsBloqued[i].recovery_password=$scope.decript($scope.cardsBloqued[i].recovery_password);if($scope.cardsBloqued[i].airline=="LATAM"){$scope.cardsBloqued[i].access_password=$scope.decript($scope.cardsBloqued[i].access_password);}else{$scope.cardsBloqued[i].access_password=" - ";}}$scope.$apply();};$scope.decript=function(code){if(code!=null&&code!=undefined){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;}};$scope.back=function(){$scope.tabindex=0;};$scope.setTotalCost=function(){$scope.selected.totalCost=$scope.selected.purchaseMiles/1000*$scope.selected.costPerThousand;return $scope.$apply();};$scope.search=function(){$scope.loadCardsBloqued();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadCardsBloqued();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadCardsBloqued();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPagePurchases=[];$scope.loadCardsBloqued=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCardsLosses",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown},function(result){$scope.cardsBloqued=jQuery.parseJSON(result).dataset.cardsBloqued;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.cardPassword();cfpLoadingBar.complete();$scope.$digest();});};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadCardsBloqued();};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('CardsPendencyCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filtered=[];$scope.row='';$scope.select=function(page){$scope.loadCardsBloqued();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.loadCardsBloqued();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.findColor=function(purchase){if(purchase.payment_status=='A')return"#FBA1A1";else return;};$scope.setSelected=function(){$scope.selected={};$scope.selected=this.cards;$scope.tabindex=1;};$scope.saveStatus=function(){cfpLoadingBar.start();$scope.selected.recovery_password=$scope.ecript($scope.selected.recovery_password);$scope.selected.access_password=$scope.ecript($scope.selected.access_password);if($scope.selected.bloqued){$scope.selected.bloqued='Y';}else{$scope.selected.bloqued='N';}$.post("../backend/application/index.php?rota=/saveProviderCards",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$apply();cfpLoadingBar.complete();$scope.loadCardsBloqued();});};$scope.savePrograss=function(){$.post("../backend/application/index.php?rota=/saveCardProgress",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadCardsProgress",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.progress=jQuery.parseJSON(result).dataset;$scope.$apply();});});};$scope.findDate=function(date){return new Date(date);};$scope.ecript=function(code){if(code!=undefined){var data=code.split('');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;}};$scope.cardPassword=function(){for(var i=0;$scope.cardsBloqued.length>i;i++){$scope.cardsBloqued[i].recovery_password=$scope.decript($scope.cardsBloqued[i].recovery_password);if($scope.cardsBloqued[i].airline=="LATAM"){$scope.cardsBloqued[i].access_password=$scope.decript($scope.cardsBloqued[i].access_password);}else{$scope.cardsBloqued[i].access_password=" - ";}}$scope.$apply();};$scope.decript=function(code){if(code!=null&&code!=undefined){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;}};$scope.back=function(){$scope.tabindex=0;};$scope.setTotalCost=function(){$scope.selected.totalCost=$scope.selected.purchaseMiles/1000*$scope.selected.costPerThousand;return $scope.$apply();};$scope.search=function(){$scope.loadCardsBloqued();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadCardsBloqued();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadCardsBloqued();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPagePurchases=[];$scope.loadCardsBloqued=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCardsBloqued",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown},function(result){$scope.cardsBloqued=jQuery.parseJSON(result).dataset.cardsBloqued;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.cardPassword();cfpLoadingBar.complete();$scope.$digest();});};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadCardsBloqued();};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('CardsWaitingCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filtered=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPage=$scope.filtered.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.findColor=function(purchase){if(purchase.payment_status=='A')return"#FBA1A1";else return;};$scope.setSelected=function(){$scope.selected={};$scope.selected=this.cards;$scope.tabindex=1;};$scope.saveStatus=function(){cfpLoadingBar.start();$scope.selected.recovery_password=$scope.ecript($scope.selected.recovery_password);$scope.selected.access_password=$scope.ecript($scope.selected.access_password);if($scope.bloqued){$scope.bloqued='W';}else{$scope.bloqued='N';}$.post("../backend/application/index.php?rota=/saveProviderCards",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$apply();cfpLoadingBar.complete();$scope.loadCardsWaiting();});};$scope.savePrograss=function(){$.post("../backend/application/index.php?rota=/saveCardProgressWainting",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadCardsProgressWainting",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.progress=jQuery.parseJSON(result).dataset;$scope.$apply();});});};$scope.findDate=function(date){return new Date(date);};$scope.ecript=function(code){if(code!=undefined){var data=code.split('');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;}};$scope.cardPassword=function(){for(var i=0;$scope.cards.length>i;i++){$scope.cards[i].recovery_password=$scope.decript($scope.cards[i].recovery_password);if($scope.cards[i].airline=="TAM"){$scope.cards[i].access_password=$scope.decript($scope.cards[i].access_password);}else{$scope.cards[i].access_password=" - ";}}$scope.$apply();};$scope.decript=function(code){if(code!=null&&code!=undefined){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;}};$scope.back=function(){$scope.tabindex=0;};$scope.setTotalCost=function(){$scope.selected.totalCost=$scope.selected.purchaseMiles/1000*$scope.selected.costPerThousand;return $scope.$apply();};$scope.search=function(){$scope.filtered=$filter('filter')($scope.cards,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filtered=$filter('orderBy')($scope.cards,rowName);return $scope.onOrderChange();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePurchases=[];$scope.loadCardsWaiting=function(){$.post("../backend/application/index.php?rota=/loadCardsWaiting",$scope.session,function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.cardPassword();$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;cfpLoadingBar.start();$scope.loadCardsWaiting();};return init();}]).controller('BloquedCardWaitingModalCtrl',['$scope','$rootScope','$modal','$log','$filter','logger',function($scope,$rootScope,$modal,$log,$filter,logger){$scope.saveCardStatus=function(card){$.post("../backend/application/index.php?rota=/saveCardProgressCardWaiting",{hashId:$scope.$parent.$parent.$parent.$parent.$parent.session.hashId,data:card},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.open=function(){$scope.card=$scope.$parent.$parent.$parent.selected;var modalInstance;modalInstance=$modal.open({templateUrl:"BloquedCardWaitingModalCtrl.html",controller:'BloquedCardWaitingInstanceCtrl',resolve:{card:function card(){return $scope.card;}}});modalInstance.result.then(function(card){$scope.saveCardStatus(card);});};}]).controller('BloquedCardWaitingInstanceCtrl',['$scope','$rootScope','$modalInstance','card',function($scope,$rootScope,$modalInstance,card){$scope.card=card;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close($scope.card);};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('PlansAirlineCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredPlans=[];$scope.row='';$scope.operations=['Reembolso','Remarcação','Analise Risco'];$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePlans=$scope.filteredPlans.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredPlans=$filter('filter')($scope.airlinePlans,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.plan;$.post("../backend/application/index.php?rota=/loadPlanControl",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.controlAirline=jQuery.parseJSON(result).dataset;$scope.tabindex=1;$scope.$apply();});};$scope.newPlan=function(){$scope.selected={};$scope.tabindex=1;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredPlans=$filter('orderBy')($scope.airlinePlans,rowName);return $scope.onOrderChange();};$scope.addAirline=function(airline){for(var i in $scope.controlAirline){if($scope.controlAirline[i].airline==airline){return logger.logError('ERROR');}}$scope.controlAirline.push({airline:airline,plansData:[{type:'Reembolso'},{type:'Remarcação'},{type:'Analise Risco'}]});};$scope.savePlan=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/savePlanControl",{hashId:$scope.session.hashId,data:$scope.selected,control:$scope.controlAirline},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadPlans();});};$scope.cancelEdit=function(){$scope.loadPlans();$scope.tabindex=0;};$scope.loadPlans=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadControlPlans",$scope.session,function(result){$scope.airlinePlans=jQuery.parseJSON(result).dataset;$scope.search();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPagePlans=[];init=function init(){$scope.tabindex=0;$scope.controlAirline=[];$scope.checkValidRoute();$.post("../backend/application/index.php?rota=/loadAirline",$scope.session,function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$scope.loadPlans();};return init();}]);})();;(function(){'use strict';angular.module('app.cashFlow').controller('CostCenterCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredValueDescriptions=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageValueDescription=$scope.filteredValueDescriptions.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredValueDescriptions=$filter('filter')($scope.valueDescriptions,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){original=angular.copy(this.valueDescription);$scope.valueDescription=original;$scope.isTable=false;return this.valueDescription;};$scope.newValueDescription=function(){$scope.valueDescription={};$scope.valueDescription.type='C';$scope.isTable=false;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return $scope.isTable;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredValueDescriptions=$filter('orderBy')($scope.valueDescriptions,rowName);return $scope.onOrderChange();};$scope.getType=function(type){if(type=="C")return"Custo";if(type=="R")return"Receita";if(type=="T")return"Transito";};$scope.getTypeColorClass=function(type){if(type=="C"||type=="T")return"warning";if(type=="R")return"success";};$scope.saveValueDescription=function(){if($scope.form_cost_center.$valid){$.post("../backend/application/index.php?rota=/saveCostCenter",{hashId:$scope.session.hashId,data:$scope.valueDescription},function(result){$scope.isTable=!$scope.isTable;logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadValueDescription();});}};$scope.cancelEdit=function(){$scope.isTable=!$scope.isTable;};$scope.loadValueDescription=function(){$.post("../backend/application/index.php?rota=/loadCostCenter",$scope.session,function(result){$scope.valueDescriptions=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageValueDescription=[];init=function init(){$scope.checkValidRoute();$scope.isTable=true;cfpLoadingBar.start();$scope.loadValueDescription();};return init();}]);})();;(function(){'use strict';angular.module('app.modal').controller('ModalCreditAnalysisCtrl',['$scope','$rootScope','$modalInstance','logger','partnerObject',function($scope,$rootScope,$modalInstance,logger,partnerObject){$scope.partner=partnerObject;$scope.creditsAnalysis=[];$scope.loadCreditAnalysis=function(){$.post("../backend/application/index.php?rota=/loadCreditAnalysisHistory",{data:$scope.partner},function(result){$scope.creditsAnalysis=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.removeCreditAnalysis=function(creditAnalysis){$.post("../backend/application/index.php?rota=/removeCreditAnalysisHistory",{data:creditAnalysis},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCreditAnalysis();});};$scope.saveCreditAnalysis=function(){$.post("../backend/application/index.php?rota=/saveCreditAnalysisHistory",{client:$scope.partner,data:$scope.partner},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.partner.creditAnalysis='';$scope.partner.registrationCodeCheck='';$scope.partner.adressCheck='';$scope.partner.creditDescription='';$scope.loadCreditAnalysis();});};return $scope.loadCreditAnalysis();}]);})();;(function(){'use strict';angular.module('app.marketing').controller('CuponsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredPromos=[];$scope.row='';$scope.aereas=['GOL','LATAM','AZUL','AVIANCA'];$scope.selectedAereas=[];$scope.toggleSelectedAereas=function(aerea){var idx=$scope.selectedAereas.indexOf(aerea);if(idx>-1){$scope.selectedAereas.splice(idx,1);}else{$scope.selectedAereas.push(aerea);}};$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePromos=$scope.filteredPromos.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredPromos=$filter('filter')($scope.promos,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.cupom;$scope.selected._dataExpiracao=new Date($scope.selected.dataExpiracao);$scope.selected._dataInicio=new Date($scope.selected.dataInicio);$scope.selectedAereas=this.cupom.aereas.slice();$scope.tabindex=1;};$scope.newPromo=function(){$scope.selected={};$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredPromos=$filter('orderBy')($scope.promos,rowName);return $scope.onOrderChange();};$scope.saveCupon=function(){cfpLoadingBar.start();$scope.selected.dataInicio=$rootScope.formatServerDateTime($scope.selected._dataInicio);$scope.selected.dataExpiracao=$rootScope.formatServerDateTime($scope.selected._dataExpiracao);$scope.selected.selectedAereas=$scope.selectedAereas;$.post("../backend/application/index.php?rota=/marketing/saveCupon",{data:$scope.selected},function(result){void 0;logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCupons();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.deleteCupons=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/deleteCupons",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadCupons();$scope.tabindex=0;$scope.$digest();});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.cancelEdit=function(){$scope.loadCupons();$scope.tabindex=0;};$scope.loadCupons=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/cupons",{},function(result){$scope.cupons=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.$digest();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePromos=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadCupons();};return init();}]);})();;(function(){'use strict';angular.module('app.marketing').controller('CuponsB2CCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredPromos=[];$scope.row='';$scope.clientStatus=['Aguardando Aprov'];$scope.setSelected=function(){$scope.selected=this.cupon;$scope.selected._dataInicio=new Date($scope.selected.dataInicio);$scope.selected._dataFim=new Date($scope.selected.dataFim);$scope.tabindex=1;};$scope.newDealer=function(){$scope.selected={};$scope.selected.status='Aguardando Aprov';$scope.tabindex=1;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadCupons();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadCupons();};$scope.saveCupom=function(){cfpLoadingBar.start();if($scope.selected._dataInicio!==""&&$scope.selected._dataInicio!='Invalid Date'){$scope.selected.dataInicio=$rootScope.formatServerDate($scope.selected._dataInicio);}if($scope.selected._dataFim!==""&&$scope.selected._dataFim!='Invalid Date'){$scope.selected.dataFim=$rootScope.formatServerDate($scope.selected._dataFim);}$.post("../backend/application/index.php?rota=/marketing/saveCupom",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCupons();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.aprovar=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/aprovarCupom",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCupons();$scope.tabindex=0;cfpLoadingBar.complete();$scope.$digest();});};$scope.cancelarCupom=function(cupon){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/inativarCupom",{data:cupon},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadCupons();$scope.tabindex=0;cfpLoadingBar.complete();$scope.$digest();});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.cancelEdit=function(){$scope.loadCupons();$scope.tabindex=0;};$scope.loadCupons=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/loadCupons",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown},function(result){$scope.cupons=jQuery.parseJSON(result).dataset.cupons;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.$digest();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePromos=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadCupons();$.post("../backend/application/index.php?rota=/marketing/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset.dealers;$scope.$digest();});};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('CustomerCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger','FileUploader',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader){var init;var original;$scope.clientStatus=['Pendente','Aprovado','Bloqueado','Reprovado','Arquivado','Antecipado/Bloqueado'];$scope.clientPayments=['Boleto','Antecipado'];$scope.clientBilling=['Diario','Semanal','Quinzenal','Mensal','Outro'];$scope.searchKeywords='';$scope.searchBilletsClient='';$scope.filteredClients=[];$scope.row='';$scope.partners=[{},{}];$scope.select=function(page){$scope.loadClient();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.showBillingPeriod=function(){if($scope.selected){return $scope.selected.billingPeriod=='Diario'||$scope.selected.billingPeriod=='Semanal'||$scope.selected.billingPeriod=='Quinzenal'||$scope.selected.billingPeriod=='Mensal'||$scope.selected.billingPeriod==''||$scope.selected.billingPeriod==undefined;}};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredClients=$filter('filter')($scope.clients,$scope.searchKeywords);return $scope.onFilterChange();};$scope.findColor=function(date){if(date){date=new Date(date);date.setDate(date.getDate()+2);date.setHours(0,0,0,0);if(date>$scope.actual_date){return'#50A52F';}else{date.setDate(date.getDate()+1);if(date>$scope.actual_date){return'#D6CE62';}else{return'#E04545';}}}};$scope.removeClient=function(){$.post("../backend/application/index.php?rota=/removeClient",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancelEdit();});};$scope.setSelected=function(){original=angular.copy(this.client);$scope.selected=this.client;$scope.selected.last_emission=new Date($scope.selected.last_emission);$scope.selected.birthdate=new Date($scope.selected.birthdate);$scope.selected.registerDate=new Date($scope.selected.registerDate);$scope.selected.registerDate.setDate($scope.selected.registerDate.getDate()+1);$scope.uploader.formData={hashId:$scope.session.hashId};$scope.modification=[];$scope.selected._status=$scope.selected.status;$scope.selected._billingPeriod=$scope.selected.billingPeriod;$scope.selected._paymentType=$scope.selected.paymentType;$scope.selected._paymentDays=$scope.selected.paymentDays;$scope.selected._partnerLimit=$scope.selected.partnerLimit;$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session,data:{client:$scope.selected.name}},function(result){$scope.billets=jQuery.parseJSON(result).dataset.billetreceive;$scope.buildCharts();$scope.searchBillets();$scope.loadBillingProgress();$scope.isTable=false;$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};$scope.$apply();});$.post("../backend/application/index.php?rota=/loadActualClientLimit",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.ActualLimit=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadCommercialProgress",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadClientAnalisys",{data:$scope.selected},function(result){$scope.finnacialInfo=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.clientModify=function(data){if($scope.modification.indexOf(data)<0){$scope.modification.push(data);}};$scope.buildCharts=function(){$.post("../backend/application/index.php?rota=/loadClientBilletsChart",{hashId:$scope.session,data:$scope.selected},function(result){$scope.clientBillets=jQuery.parseJSON(result).dataset;});};$scope.searchBillets=function(){$scope.filteredBillets=$filter('filter')($scope.billets,$scope.searchBilletsClient);};$scope.loadBillingProgress=function(){$.post("../backend/application/index.php?rota=/loadBillingProgress",{hashId:$scope.session,data:$scope.selected},function(result){$scope.billingRecord=jQuery.parseJSON(result).dataset;});};$scope.getTag=function(client){switch(client.billingPeriod){case'Quinzenal':return"label label-warning";case'Mensal':return"label label-warning";default:return"label label-info";}};$scope.printFill=function(){var columns=[{title:"ID",dataKey:"ID"},{title:"Nome",dataKey:"Nome"},{title:"Prazo",dataKey:"Prazo"},{title:"Multa",dataKey:"Multa"},{title:"Email",dataKey:"Email"},{title:"Telefone",dataKey:"Telefone"},{title:"Status",dataKey:"Status"}];var rows=[];for(var i in $scope.clients){var c=$scope.clients[i];var tel=c.phoneNumber;if(c.phoneNumber2!=''){tel+="\n"+c.phoneNumber2;if(c.phoneNumber3!=''){tel+="\n"+c.phoneNumber3;}}tel=tel.replaceAll("|","\n");tel=tel.replaceAll("/","\n");var email=c.email.replaceAll(";","\n").toLowerCase();rows.push({ID:c.id,Nome:c.name,Prazo:c.paymentType.toString()+"-"+c.paymentDays.toString(),Multa:c.mulct,Email:email,Telefone:tel,Status:c.status});}return[columns,rows];};$scope.print=function(isSave){var resp=$scope.printFill();if(isSave){var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(18);var columns=resp[0];var rows=resp[1];doc.autoTable(columns,rows,{theme:"grid",styles:{fontSize:6,overflow:"linebreak"},margin:{horizontal:10},bodyStyles:{valign:"top",halign:"left"}});doc.save("Relatório_Clientes.pdf");}return JSON.stringify(resp);};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadClient();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadClient();};$scope.loadClient=function(){$scope.newUpload=false;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClient",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.$digest();cfpLoadingBar.complete();});};$scope.blockClient=function(client){if(client.status=='Bloqueado'){client.status='Aprovado';}else client.status='Bloqueado';$.post("../backend/application/index.php?rota=/saveClient",{hashId:$scope.session.hashId,data:client,partners:$scope.partners},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadClient();});};$scope.intencionToChangeStatus=function(client){void 0;$rootScope.$emit('openCustomerStatusLogModal',client);};$scope.saveClient=function(){$scope.selected.cityfullname=$scope.selected.city+', '+$scope.selected.state;if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){return logger.logError('CPF Inválido');}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){return logger.logError('CNPJ Inválido');}}if($scope.selected.birthdate!==""&&$scope.selected.birthdate!='Invalid Date'){$scope.selected._birthdate=$rootScope.formatServerDate($scope.selected.birthdate);}if($scope.selected.registerDate!==""&&$scope.selected.registerDate!='Invalid Date'){$scope.selected._registerDate=$rootScope.formatServerDate($scope.selected.registerDate);}for(var i in $scope.partners){if($scope.partners[i].birthdate!=="")$scope.partners[i]._birthdate=$rootScope.formatServerDate($scope.partners[i].birthdate);}cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveClient",{hashId:$scope.session.hashId,data:$scope.selected,partners:$scope.partners},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadClient();});$scope.isTable=!$scope.isTable;cfpLoadingBar.complete();};$scope.intencionToSave=function(){var changeDetected=false;$scope.saveClient();};$scope.getStatusDesc=function(status){switch(status){case'B':return"Pago";case'E':return"Em Aberto";case'A':return"Em Aberto";case'C':return"Cancelado";}};$scope.findDate=function(date){if(date!='')return new Date(date);else return'';};$scope.cancelEdit=function(){$scope.isTable=true;$scope.newUpload=false;$scope.mail=false;$scope.partners=[{},{}];};$scope.toggleNewUpload=function(){if($scope.newUpload){$scope.newUpload=false;}else{$scope.newUpload=true;}};$scope.loadFiles=function(){$scope.filesLoaded=new FileReader();$.post("../backend/application/index.php?rota=/loadFiles",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.filesLoaded=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.fillEmailContent=function(){$scope.selected=this.client;$scope.mail=true;$scope.partner.emailpartner=$scope.selected.email;$scope.partner.mailcc="financeiro@onemilhas.com.br";$scope.partner.subject="[FINANCEIRO] - One Milhas";$scope.partner.emailContent="<br><br><br>";};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}if($scope.uploader.queue>0){$scope.uploader.uploadAll();$scope.uploader.onCompleteAll=function(){$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.partner,attachment:file,type:'FINANCEIRO',emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$scope.cancelEdit();$scope.partner={};$scope.uploader.clearQueue();});};}else{$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.partner,attachment:file,type:'FINANCEIRO',emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$scope.cancelEdit();$scope.partner={};$scope.uploader.clearQueue();});}};$scope.removeFile=function(file){$.post("../backend/application/index.php?rota=/removeFile",{hashId:$scope.session.hashId,data:$scope.selected,file:file},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFiles();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageClients=[];init=function init(){$scope.actual_date=new Date();$scope.isTable=true;$rootScope.modalOpen=false;$scope.checkValidRoute();$scope.newProgress={};cfpLoadingBar.start();$scope.mail=false;$scope.clientBillets=[{data:0,label:"Não Atrasados / Adiantados"},{data:0,label:"Atrasados"}];$scope.options={series:{pie:{show:true,innerRadius:0.25}},legend:{show:false},grid:{hoverable:true,clickable:false},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7","#56B176","#15582D","#547D63","#299431","#906D38","#903875","#E21414","#E1E41E","#4CB938"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$('#clientstate').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;});cfpLoadingBar.complete();});$('#partnerState').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.citiesPartners=jQuery.parseJSON(result).dataset;});cfpLoadingBar.complete();});$('#clientstatefinnancial').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.cityFinnancialState},function(result){$scope.citiesFinnancial=jQuery.parseJSON(result).dataset;});cfpLoadingBar.complete();});$scope.filter={status:'Bloqueado'};$scope.loadClient();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});};$scope.registerLog=function(){$.post("../backend/application/index.php?rota=/saveCommercialProgress",{data:$scope.selected,progress:$scope.newProgress},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.newProgress={};$.post("../backend/application/index.php?rota=/loadCommercialProgress",{data:$scope.selected},function(result){$scope.ClientLog=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.openModalSearch=function(){$.post("../backend/application/index.php?rota=/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"ClientsModalDemoCtrl.html",controller:'ClientsModalInstanceCtrl',periods:$scope.periods,resolve:{filter:function filter(){return $scope.filter;},states:function states(){return $scope.states;},dealers:function dealers(){return $scope.dealers;}}});modalInstance.result.then(function(filter){filter._fromDate=$rootScope.formatServerDate(filter.fromDate);filter._toDate=$rootScope.formatServerDate(filter.toDate);filter._notFromDate=$rootScope.formatServerDate(filter.notFromDate);filter._notToDate=$rootScope.formatServerDate(filter.notToDate);filter._registerFromDate=$rootScope.formatServerDate(filter.registerFromDate);filter._registerToDate=$rootScope.formatServerDate(filter.registerToDate);$scope.loadClient();},function(){$log.info("Modal dismissed at: "+new Date());});});};return init();}]).controller('BillingRecordModalCtrl',['$scope','$rootScope','$modal','$log','logger',function($scope,$rootScope,$modal,$log,logger){$scope.saveBilling=function(billing){$.post("../backend/application/index.php?rota=/saveBillingProgress",{hashId:$scope.$parent.$parent.$parent.$parent.session.hashId,data:$scope.clientSelected,billing:billing},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.open=function(){$scope.clientSelected=this.client;$.post("../backend/application/index.php?rota=/loadBillingProgress",{hashId:$scope.session,data:$scope.clientSelected},function(result){$scope.billingRecord=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"BillingRecordModalCtrl.html",controller:'BillingRecordModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{billingRecord:function billingRecord(){return $scope.billingRecord;}}});modalInstance.result.then(function(billing){$scope.saveBilling(billing);});});};}]).controller('BillingRecordModalInstanceCtrl',['$scope','$rootScope','$modalInstance','billingRecord',function($scope,$rootScope,$modalInstance,billingRecord){$scope.billingRecord=billingRecord;$scope.findDate=function(date){return new Date(date);};$scope.billing={description:''};$scope.ok=function(){$modalInstance.close($scope.billing);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).directive('flotClientBilletsChart',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,_finish27,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.$parent.$parent.clientBillets;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.$parent.$parent.clientBillets);plot.draw();setTimeout(_finish27,updateInterval);};_finish27=function finish(){plot.setData(scope.$parent.$parent.$parent.clientBillets);plot.draw();updateInterval=2000;setTimeout(_finish27,updateInterval);};updateInterval=1000;return update();}};}]).controller('CustomerLogModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openCustomerLogModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"CustomerLogModalCtrl.html",controller:'CustomerLogInstanceCtrl',resolve:{}});modalInstance.result.then(function(resolve){$scope.$parent.selected.resolveDescription=resolve.resolveDescription;$scope.$parent.saveClient();$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('CustomerLogInstanceCtrl',['$scope','$rootScope','$modalInstance','logger',function($scope,$rootScope,$modalInstance,logger){$scope.selected={resolveDescription:''};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selected.resolveDescription.length<1)return logger.logError('Motivos devem ser informados');$modalInstance.close($scope.selected);};}]).controller('CustomerStatusLogModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.$on('openCustomerStatusLogModal',function(event,args){void 0;void 0;if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"CustomerStatusLogModal.html",controller:'CustomerStatusLogInstanceCtrl',resolve:{selected:function selected(){return args;}}});modalInstance.result.then(function(resolve){$scope.$parent.blockClient(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('CustomerStatusLogInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','selected',function($scope,$rootScope,$modalInstance,logger,selected){$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selected.resolveDescription.length<1)return logger.logError('Motivos devem ser informados');$modalInstance.close($scope.selected);};}]);})();;(function(){'use strict';angular.module('app.table').controller('MainPageCtrl',['$scope','$rootScope','$route','$filter','cfpLoadingBar','logger','$modal','$element','ui.checkbox',function($scope,$rootScope,$route,$filter,cfpLoadingBar,logger,$modal,$element){}]).controller('NavCtrl',['$scope','$rootScope','cfpLoadingBar','filterFilter',function($scope,$rootScope,cfpLoadingBar,filterFilter){}]).controller('DashboardCtrl',['$scope','$rootScope','logger','cfpLoadingBar',function($scope,$rootScope,logger,cfpLoadingBar){var init;$scope.filter={days:30,points:900,enterPressed:false};$scope.SumMilesLef_detalhes=false;$scope.SumOrderMiles_detalhes=false;$scope.onFilterEnterKey=function(keyCode){$scope.filter.enterPressed=false;if(keyCode==13){$scope.filter.enterPressed=true;$scope.search();}};$scope.onFilterBlur=function(){if(!$scope.filter.enterPressed){$scope.search();}$scope.filter.enterPressed=false;};$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.response=jQuery.parseJSON(result).dataset;$rootScope.notificationsInfo=[];$scope.notificationsInfoCheck=[];logger.logWarning("Informações em notificações !!! ");for(var i in $scope.response){if(!$scope.response[i].checkBox){$rootScope.pushNotificationInfo("Novas Notificações");$scope.notificationsInfoCheck.push(i);}}});$scope.search=function(){if($scope.showFilter){$scope.filter._dateFrom=$rootScope.formatServerDate($scope.filter.dateFrom);$scope.filter._dateTo=$rootScope.formatServerDate($scope.filter.dateTo);}if($scope.$parent.$parent.main.isMaster||$scope.main.id==8693){$.post("../backend/application/index.php?rota=/loadSumOrderMiles",{data:$scope.filter},function(result){$scope.SumOrderMiles=jQuery.parseJSON(result).dataset;$scope.$digest();});}if($scope.$parent.$parent.main.isMaster){$.post("../backend/application/index.php?rota=/loadSumPurchaseMiles",{data:$scope.filter},function(result){$scope.SumPurchaseMiles=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadSumMilesLeft",{data:$scope.filter},function(result){$scope.SumMilesLef=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadAverageMiles",{data:$scope.filter},function(result){$scope.averageMiles=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadTotalBalance",{data:$scope.filter},function(result){$scope.TotalBalance=jQuery.parseJSON(result).dataset;$scope.$digest();});}if($scope.main.id==5164||$scope.main.id==5162){if($scope.showFilter){$scope.filter._dateFrom=$rootScope.formatServerDate($scope.filter.dateFrom);$scope.filter._dateTo=$rootScope.formatServerDate($scope.filter.dateTo);}$.post("../backend/application/index.php?rota=/loadSumDatas",{data:$scope.filter},function(result){$scope.sumData=jQuery.parseJSON(result).dataset;$scope.$digest();});}};$scope.loadData=function(){if($scope.$parent.$parent.main.isMaster){$.post("../backend/application/index.php?rota=/loadSumMilesLeftGroupBy",{hashId:$scope.session.hashId},function(result){$scope.Group=jQuery.parseJSON(result).dataset;$scope.donutChart2.data=[];for(var grop in $scope.Group){$scope.donutChart2.data.push({label:$scope.Group[grop].airline,data:$scope.Group[grop].miles});}});$.post("../backend/application/index.php?rota=/loadBalanceHistory",{hashId:$scope.session.hashId},function(result){$scope.balance=jQuery.parseJSON(result).dataset;$scope.comboData=[];for(var grop in $scope.balance){$scope.comboData.push({month:$scope.balance[grop].month,a:$scope.balance[grop].purchased,b:$scope.balance[grop].saled});}});$.post("../backend/application/index.php?rota=/checkAirlinesMilesBench",{hashId:$scope.session.hashId},function(result){$scope.response=jQuery.parseJSON(result).dataset;for(var i in $scope.response){logger.logWarning("Estoque de milhas baixo: "+$scope.response[i].miles);$rootScope.pushNotification("Estoque de milhas baixo: "+$scope.response[i].miles);}});$.post("../backend/application/index.php?rota=/loadSumMilesLeftSRM",{hashId:$scope.session.hashId},function(result){$scope.SRMViagens=jQuery.parseJSON(result).dataset;});}};$scope.findDate=function(date){return new Date(date);};$scope.loadBlockedClients=function(){$rootScope.notifications=[];if(!$scope.$parent.$parent.main.isMaster&&$scope.$parent.$parent.main.dealer){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){cfpLoadingBar.complete();$scope.clients=jQuery.parseJSON(result).dataset;$scope.$digest();});}if($scope.$parent.$parent.main.financial){if(new Date().getDate()==1){logger.logWarning("Realizar pagamentos mensais");$rootScope.pushNotification('Realizar pagamentos mensais');}if(new Date().getDate()==1||new Date().getDate()==16){logger.logWarning("Realizar pagamentos quinzenais");$rootScope.pushNotification('Realizar pagamentos quinzenais');}$.post("../backend/application/index.php?rota=/checkClientsDeadLine",{hashId:$scope.session.hashId},function(result){$scope.deadLine=jQuery.parseJSON(result).dataset;});}if($scope.$parent.$parent.main.milesBench){logger.logWarning("Notificações");$rootScope.pushNotification('Novas Informações.');}if($scope.$parent.$parent.main.humanResources){$.post("../backend/application/index.php?rota=/checkBillsPayCalendar",{},function(result){$scope.billsPayCalendar=jQuery.parseJSON(result).dataset;for(var i in $scope.billsPayCalendar){logger.logWarning('Realizar Pagamento '+$scope.billsPayCalendar[i].name);$rootScope.pushNotification('Realizar Pagamento '+$scope.billsPayCalendar[i].name);}});}if(!$scope.$parent.$parent.main.isMaster&&$scope.$parent.$parent.main.wizardPurchase){if($scope.$parent.$parent.main.wizardPurchase){$.post("../backend/application/index.php?rota=/checkBlockedCards",{},function(result){$scope.bloquedCards=jQuery.parseJSON(result).dataset;for(var i in $scope.bloquedCards){$rootScope.pushNotification('Cartão Bloqueado: '+$scope.bloquedCards[i].name);}});}}if($scope.$parent.$parent.main.isMaster||$scope.$parent.$parent.main.financial){$.post("../backend/application/index.php?rota=/checkRiskAnalysis",{hashId:$scope.session.hashId},function(result){$scope.checkRiskAnalysis=jQuery.parseJSON(result).dataset;$scope.$digest();});}};$scope.countClients=function(){return $scope.clients.length;};init=function init(){$scope.checkValidRoute();$scope.sumData=undefined;$scope.search();$scope.loadBlockedClients();$scope.clients=[];$scope.donutChart2={};$scope.donutChart2.data=[];$scope.donutChart2.data=[{label:"TAM",data:1},{label:"GOL",data:1},{label:"AZUL",data:1},{label:"AVIANCA",data:1}];$scope.comboData=[];$scope.loadData();$scope.donutChart2.options={series:{pie:{show:true,innerRadius:0.45}},legend:{show:false},grid:{hoverable:true,clickable:true},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};if($scope.$parent.$parent.main.financial){$.post("../backend/application/index.php?rota=/checklist/loadNotes",{},function(result){$scope.checklist=jQuery.parseJSON(result).dataset;$rootScope.userTasks=$scope.checklist.filter(function(note){return note.done==false;}).length;$scope.$digest();});}};return init();}]).controller('ClientDataCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"ClientData.html",controller:'ClientInstanceCtrl',size:'lg'});};}]).controller('ClientInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$modalInstance,$filter,cfpLoadingBar,logger){$scope.filter={name:''};$scope.search=function(){$scope.filteredClients=$filter('filter')($scope.clients,$scope.filter.name);cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClientCredits",{searchKeywords:$scope.filter.name},function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;$scope.$digest();cfpLoadingBar.complete();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};return $scope.search();}]).controller('NotesCtrl',['$scope','$rootScope','$filter','logger','$modal','cfpLoadingBar',function($scope,$rootScope,$filter,logger,$modal,cfpLoadingBar){var init;$scope.loadNotes=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.Notes=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.$digest();});};$scope.open=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.Notes=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();var modalInstance;modalInstance=$modal.open({templateUrl:"Notes.html",controller:'NotesInstanceCtrl',resolve:{notes:function notes(){return $scope.Notes;},session:function session(){return $scope.$parent.$parent.session;}}});});};$scope.removeAll=function(){$rootScope.notifications=[];};$scope.toggleOpen=function(){$scope.isOpen=!$scope.isOpen;};init=function init(){$scope.isOpen=false;};return init;}]).controller('ChecklistCtrl',['$scope','$rootScope','$filter','logger','$modal','cfpLoadingBar',function($scope,$rootScope,$filter,logger,$modal,cfpLoadingBar){var init;$scope.open=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/checklist/loadNotes",{},function(result){$scope.checklist=jQuery.parseJSON(result).dataset;$rootScope.userTasks=$scope.checklist.filter(function(note){return note.done==false;}).length;cfpLoadingBar.complete();var modalInstance;modalInstance=$modal.open({templateUrl:"Checklist.html",controller:'ChecklistInstanceCtrl',resolve:{checklist:function checklist(){return $scope.checklist;}}});});};}]).controller('NotesInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','notes','session','cfpLoadingBar',function($scope,$rootScope,$modalInstance,$filter,logger,notes,session,cfpLoadingBar){$scope.notes=notes;$scope.filteredNotes=notes;$scope.session=session;$scope.new={};$scope.filter={};$scope.search=function(){$scope.filteredNotes=$filter('filter')($scope.notes,$scope.filter.name);};$scope.createNote=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/createNote",{data:$scope.new},function(result){$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.new={};$scope.$digest();});});};$scope.remove=function(note){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/removeNote",{data:note},function(result){$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.$digest();});});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('NotesInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','notes','session','cfpLoadingBar',function($scope,$rootScope,$modalInstance,$filter,logger,notes,session,cfpLoadingBar){$scope.notes=notes;$scope.filteredNotes=notes;$scope.session=session;$scope.new={};$scope.filter={};$scope.search=function(){$scope.filteredNotes=$filter('filter')($scope.notes,$scope.filter.name);};$scope.createNote=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/createNote",{data:$scope.new},function(result){$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.new={};$scope.$digest();});});};$scope.remove=function(note){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/removeNote",{data:note},function(result){$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.$digest();});});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('InfoCtrl',['$scope','$rootScope','$filter','logger','$modal','cfpLoadingBar',function($scope,$rootScope,$filter,logger,$modal,cfpLoadingBar){var init;$scope.infoNotification=function(){$rootScope.notificationsInfo=[];$scope.notificationsInfoCheck=[];$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.response=jQuery.parseJSON(result).dataset;logger.logWarning("Informações em notificações !!! ");for(var i in $scope.response){if(!$scope.response[i].checkBox){$rootScope.pushNotificationInfo("Novas Notificações");$scope.notificationsInfoCheck.push(i);}}});};$scope.open=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.Info=jQuery.parseJSON(result).dataset;$scope.infoNotification();cfpLoadingBar.complete();var modalInstance;modalInstance=$modal.open({templateUrl:"Info.html",controller:'InfoInstanceCtrl',resolve:{info:function info(){return $scope.Info;},session:function session(){return $scope.$parent.$parent.session;},main:function main(){return $scope.$parent.$parent.main;}}});});};$scope.removeAll=function(){$rootScope.notifications=[];};$scope.toggleOpen=function(){$scope.isOpen=!$scope.isOpen;};init=function init(){$scope.isOpen=false;};return init;}]).controller('InfoInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','info','session','cfpLoadingBar','main',function($scope,$rootScope,$modalInstance,$filter,logger,info,session,cfpLoadingBar,main){$scope.info=info;$scope.filteredInfo=info;$scope.session=session;$scope.news={};$scope.filter={};$scope.main=main;$scope.checkVerify=false;$scope.search=function(){$scope.filteredInfo=$filter('filter')($scope.info,$scope.filter.name);};$scope.createInfo=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/createInfo",{data:$scope.news},function(result){$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.info=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.news={};$scope.$digest();});});};$scope.remove=function(info){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/removeInfo",{data:info},function(result){$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.info=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.$digest();});});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('InfoInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','info','session','cfpLoadingBar','main',function($scope,$rootScope,$modalInstance,$filter,logger,info,session,cfpLoadingBar,main){$scope.info=info;$scope.filteredInfo=info;$scope.session=session;$scope.new={};$scope.filter={};$scope.main=main;$scope.read=[];$scope.search=function(){$scope.filteredInfo=$filter('filter')($scope.info,$scope.filter.name);};$scope.createInfo=function(){cfpLoadingBar.start();$rootScope.notificationsInfo=[];$scope.notificationsInfoCheck=[];$.post("../backend/application/index.php?rota=/createInfo",{data:$scope.new},function(result){$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.info=jQuery.parseJSON(result).dataset;logger.logWarning("Informações em notificações !!! ");for(var i in $scope.info){if(!$scope.info[i].checkBox){$rootScope.pushNotificationInfo("Novas Notificações");$scope.notificationsInfoCheck.push(i);}}$scope.search();cfpLoadingBar.complete();$scope.new={};$scope.$digest();});});};$scope.remove=function(info){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/removeInfo",{data:info},function(result){$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.info=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.$digest();});});};$scope.checkVerify=false;$scope.toggleCheckFunction=function(info){$scope.checkVerify=true;$scope.infoCheck=info;$scope.infoCheck.check=$scope.checkVerify;$scope.infoCheck.check;$rootScope.notificationsInfo=[];$scope.notificationsInfoCheck=[];$.post("../backend/application/index.php?rota=/systemCheck",{data:$scope.infoCheck},function(result){$scope.check=jQuery.parseJSON(result).dataset;void 0;$.post("../backend/application/index.php?rota=/loadInfo",{},function(result){$scope.response=jQuery.parseJSON(result).dataset;logger.logWarning("Informações em notificações !!! ");for(var i in $scope.response){if(!$scope.response[i].checkBox){$rootScope.pushNotificationInfo("Novas Notificações");$scope.notificationsInfoCheck.push(i);}}});});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('ChecklistInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','checklist','cfpLoadingBar',function($scope,$rootScope,$modalInstance,$filter,logger,checklist,cfpLoadingBar){$scope.checklist=checklist;$scope.new={};$scope.loadNotes=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/checklist/loadNotes",{},function(result){$scope.checklist=jQuery.parseJSON(result).dataset;$rootScope.userTasks=$scope.checklist.filter(function(note){return note.done==false;}).length;cfpLoadingBar.complete();$scope.$digest();});};$scope.createNote=function(){$.post("../backend/application/index.php?rota=/checklist/createNote",{data:$scope.new},function(result){$scope.new={};$scope.loadNotes();});};$scope.remove=function(note){$.post("../backend/application/index.php?rota=/checklist/removeNote",{data:note},function(result){$scope.loadNotes();});};$scope.checkNote=function(note){$.post("../backend/application/index.php?rota=/checklist/checkNote",{data:note},function(result){$scope.loadNotes();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('NotesInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','notes','session','cfpLoadingBar',function($scope,$rootScope,$modalInstance,$filter,logger,notes,session,cfpLoadingBar){$scope.notes=notes;$scope.filteredNotes=notes;$scope.session=session;$scope.new={};$scope.filter={};$scope.search=function(){$scope.filteredNotes=$filter('filter')($scope.notes,$scope.filter.name);};$scope.createNote=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/createNote",{data:$scope.new},function(result){$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.new={};$scope.$digest();});});};$scope.remove=function(note){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/removeNote",{data:note},function(result){$.post("../backend/application/index.php?rota=/loadNotes",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.$digest();});});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('ProvidersDialogDataCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"ProviderData.html",controller:'ProvidersDialogInstanceCtrl',resolve:{providers:function providers(){return $scope.providers;}}});};}]).controller('ProvidersDialogInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','$timeout','logger','providers',function($scope,$rootScope,$modalInstance,$filter,$timeout,logger,providers){$scope.providers=providers;$scope.showData=false;$scope.search=function(){if(load){$timeout.cancel(load);}var load=$timeout($scope.searchProvider(),1000);};$scope.searchProvider=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.name},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;if($scope.providers.length==1){$scope.filtered=$scope.providers[0];$scope.showData=true;}$scope.$digest();if(load){load=undefined;}});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).directive('flotChart',[function(){return{restrict:'A',scope:{data:'=',options:'='},link:function link(scope,ele,attrs,update,finish,updateInterval){var data,options,plot;options=scope.options;data=scope.$parent.donutChart2.data;plot=$.plot(ele[0],data,options);update=function update(){plot.setData(scope.$parent.donutChart2.data);plot.draw();setTimeout(finish,updateInterval);};finish=function finish(){plot.setData(scope.$parent.donutChart2.data);plot.draw();};updateInterval=2000;return update();}};}]).directive('morrisChart',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish28){var colors,data,func,options;data=scope.data;updateInterval=2000;switch(attrs.type){case'line':if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:data,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};return new Morris.Line(options);case'area':if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:data,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],behaveLikeLine:attrs.behaveLikeLine||false,fillOpacity:attrs.fillOpacity||'auto',pointSize:attrs.pointSize||4,resize:true};return new Morris.Area(options);case'bar':if(attrs.barColors===void 0||attrs.barColors===''){colors=null;}else{colors=JSON.parse(attrs.barColors);}options={element:ele[0],data:scope.$parent.comboData,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),barColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],stacked:attrs.stacked||null,resize:true};update=function update(){setTimeout(_finish28,updateInterval);options.data=scope.$parent.comboData;};_finish28=function finish(){options.data=scope.$parent.comboData;if(scope.$parent.comboData.length>0){return new Morris.Bar(options);}else{setTimeout(_finish28,updateInterval);}};return update();case'donut':if(attrs.colors===void 0||attrs.colors===''){colors=null;}else{colors=JSON.parse(attrs.colors);}options={element:ele[0],data:data,colors:colors||['#0B62A4','#3980B5','#679DC6','#95BBD7','#B0CCE1','#095791','#095085','#083E67','#052C48','#042135'],resize:true};if(attrs.formatter){func=new Function('y','data',attrs.formatter);options.formatter=func;}return new Morris.Donut(options);}}};}]).controller('ResponsesCtrl',['$scope','$rootScope','$filter','logger','$modal','cfpLoadingBar',function($scope,$rootScope,$filter,logger,$modal,cfpLoadingBar){var init;$scope.open=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadNotesCommun",{},function(result){$scope.Notes=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();var modalInstance;modalInstance=$modal.open({templateUrl:"Responses.html",controller:'ResponsesInstanceCtrl',resolve:{notes:function notes(){return $scope.Notes;}}});});};init=function init(){};return init;}]).controller('ResponsesInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','logger','notes','cfpLoadingBar',function($scope,$rootScope,$modalInstance,$filter,logger,notes,cfpLoadingBar){$scope.notes=notes;$scope.filteredNotes=notes;$scope.new={};$scope.filter={};$scope.search=function(){$scope.filteredNotes=$filter('filter')($scope.notes,$scope.filter.name);};$scope.createNote=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/createNoteCommun",{data:$scope.new},function(result){$.post("../backend/application/index.php?rota=/loadNotesCommun",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.new={};$scope.$digest();});});};$scope.remove=function(note){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/removeNoteCommun",{data:note},function(result){$.post("../backend/application/index.php?rota=/loadNotesCommun",{},function(result){$scope.notes=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$scope.$digest();});});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.chart').controller('MorrisChartCtrl',['$scope',function($scope){$scope.mainData=[{month:'2013-01',xbox:294000,will:136000,playstation:244000},{month:'2013-02',xbox:228000,will:335000,playstation:127000},{month:'2013-03',xbox:199000,will:159000,playstation:130000},{month:'2013-04',xbox:174000,will:160000,playstation:82000},{month:'2013-05',xbox:255000,will:318000,playstation:82000},{month:'2013-06',xbox:298400,will:401800,playstation:98600},{month:'2013-07',xbox:370000,will:225000,playstation:159000},{month:'2013-08',xbox:376700,will:303600,playstation:130000},{month:'2013-09',xbox:527800,will:301000,playstation:119400}];$scope.simpleData=[{year:'2008',value:20},{year:'2009',value:10},{year:'2010',value:5},{year:'2011',value:5},{year:'2012',value:20},{year:'2013',value:19}];$scope.comboData=[{month:'Jan',a:50,b:70,c:7},{month:'Fev',a:70,b:80,c:8},{month:'Mar',a:78,b:89,c:9},{month:'Apr',a:70,b:140,c:14},{month:'Mai',a:120,b:90,c:9},{month:'Jun',a:110,b:120,c:12}];$scope.donutData=[{label:"Download Sales",value:12},{label:"In-Store Sales",value:30},{label:"Mail-Order Sales",value:20},{label:"Online Sales",value:19}];}]);})();;(function(){'use strict';angular.module('app.chart').controller('FlotChartCtrl',['$scope',function($scope){var areaChart,barChart;areaChart={};areaChart.data1=[[2007,15],[2008,20],[2009,10],[2010,5],[2011,5],[2012,20],[2013,28]];areaChart.data2=[[2007,15],[2008,16],[2009,22],[2010,14],[2011,12],[2012,19],[2013,22]];$scope.area={};$scope.area.data=[{data:areaChart.data1,label:"Value A",lines:{fill:true}},{data:areaChart.data2,label:"Value B",points:{show:true},yaxis:2}];$scope.area.options={series:{lines:{show:true,fill:false},points:{show:true,lineWidth:2,fill:true,fillColor:"#ffffff",symbol:"circle",radius:5},shadowSize:0},grid:{hoverable:true,clickable:true,tickColor:"#f9f9f9",borderWidth:1,borderColor:"#eeeeee"},colors:["#23AE89","#6A55C2"],tooltip:true,tooltipOpts:{defaultTheme:false},xaxis:{mode:"time"},yaxes:[{},{position:"right"}]};barChart={};barChart.data1=[[2008,20],[2009,10],[2010,5],[2011,5],[2012,20],[2013,28]];barChart.data2=[[2008,16],[2009,22],[2010,14],[2011,12],[2012,19],[2013,22]];barChart.data3=[[2008,12],[2009,30],[2010,20],[2011,19],[2012,13],[2013,20]];$scope.barChart={};$scope.barChart.data=[{label:"Value A",data:barChart.data1},{label:"Value B",data:barChart.data2},{label:"Value C",data:barChart.data3}];$scope.barChart.options={series:{stack:true,bars:{show:true,fill:1,barWidth:0.3,align:"center",horizontal:false,order:1}},grid:{hoverable:true,borderWidth:1,borderColor:"#eeeeee"},tooltip:true,tooltipOpts:{defaultTheme:false},colors:["#23AE89","#2EC1CC","#FFB61C","#E94B3B"]};$scope.pieChart={};$scope.pieChart.data=[{label:"Download Sales",data:12},{label:"In-Store Sales",data:30},{label:"Mail-Order Sales",data:20},{label:"Online Sales",data:19}];$scope.pieChart.options={series:{pie:{show:true}},legend:{show:true},grid:{hoverable:true,clickable:true},colors:["#23AE89","#2EC1CC","#FFB61C","#E94B3B"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};$scope.donutChart={};$scope.donutChart.data=[{label:"Download Sales",data:12},{label:"In-Store Sales",data:30},{label:"Mail-Order Sales",data:20},{label:"Online Sales",data:19}];$scope.donutChart.options={series:{pie:{show:true,innerRadius:0.5}},legend:{show:true},grid:{hoverable:true,clickable:true},colors:["#23AE89","#2EC1CC","#FFB61C","#E94B3B"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};$scope.donutChart2={};$scope.donutChart2.data=[{label:"TAM",data:0},{label:"GOL",data:0},{label:"AZUL",data:0},{label:"AVIANCA",data:0}];return $scope.donutChart2.options={series:{pie:{show:true,innerRadius:0.45}},legend:{show:false},grid:{hoverable:true,clickable:true},colors:["#176799","#2F87B0","#42A4BB","#5BC0C4","#78D6C7"],tooltip:true,tooltipOpts:{content:"%p.0%, %s",defaultTheme:false}};}]).controller('FlotChartCtrlRealtime',['$scope',function($scope){}]);})();;(function(){'use strict';angular.module('app.table').controller('DataConferenceCtrl',['$scope','$rootScope','$route','$filter','cfpLoadingBar','logger','$modal','$element',function($scope,$rootScope,$route,$filter,cfpLoadingBar,logger,$modal,$element){var init;$scope.saleStatus=['Pendente','Emitido','Reembolso Solicitado','Reembolso Confirmado','Cancelamento Solicitado','Cancelamento Efetivado'];$scope.searchKeywords='';$scope.filteredSales=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageSales=$scope.filteredSales.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.findDate=function(date){return new Date(date);};$scope.setSelected=function(){$scope.selected={};if(this.sale.status!="Cancelado"){$scope.selected=this.sale;$('#salemilesused').number(true,0,',','.');$('#saletax').number(true,2,',','.');$('#saledutax').number(true,2,',','.');$('#saletotalcost').number(true,2,',','.');$("#saleamountpaid").maskMoney({thousands:'.',decimal:',',precision:2});$('#saleextrafee').number(true,2,',','.');$('#salekickback').number(true,2,',','.');$('#milesMoney').number(true,2,',','.');$('#totalCost').number(true,2,',','.');$.post("../backend/application/index.php?rota=/loadLog",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.saleLog=jQuery.parseJSON(result).dataset;$scope.tabindex=1;$scope.airlineShowFields=$scope.selected.airline=='TAM';$scope.boardingDate=new Date($scope.selected.boardingDate);$scope.landingDate=new Date($scope.selected.landingDate);$scope.paxBirthdate=new Date($scope.selected.paxBirthdate+'T12:00:00Z');$scope.$apply();return true;});}else{logger.logError("Esta venda foi cancelada!");}};$scope.findMiles=function(){var total=0;if($scope.filteredSales){if($scope.filteredSales.length>0){for(var i in $scope.filteredSales){total+=$scope.filteredSales[i].milesused;}}}return $rootScope.formatNumber(total,0);};$scope.findAmountPaid=function(){var total=0;if($scope.filteredSales){if($scope.filteredSales.length>0){for(var i in $scope.filteredSales){total+=$scope.filteredSales[i].amountPaid;}}}return $rootScope.formatNumber(total);};$scope.setKickBack=function(){$scope.selected.kickback=$scope.selected.amountPaid-$scope.selected.totalCost-$scope.selected.tax-$scope.selected.duTax-$scope.selected.extraFee;};$scope.toggleFormTable=function(){if($scope.tabindex==0){return $scope.tabindex=1;}return $scope.tabindex=0;};$scope.search=function(){$scope.filteredSales=$filter('filter')($scope.sales,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredSales=$filter('orderBy')($scope.sales,rowName);return $scope.onOrderChange();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.saleTag=function(status){switch(status){case'Pendente':return"label label-info";case'Emitido':return"label label-success";case'Reembolso Solicitado':return"label label-warning";case'Reembolso Confirmado':return"label label-default";case'Cancelamento Solicitado':return"label label-warning";case'Cancelamento Efetivado':return"label label-danger";}};$scope.numPerPageOpt=[10,25,50,150];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPageSales=[];$rootScope.hashId=$scope.session.hashId;$scope.saveOrder=function(){cfpLoadingBar.start();$scope.selected.amountPaid=$('#saleamountpaid').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/saveOrder",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadSaleByFilter",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.sales=jQuery.parseJSON(result).dataset;$scope.search();$scope.$apply();return $scope.select($scope.currentPage);});});cfpLoadingBar.complete();$scope.toggleFormTable();};$scope.saveFlightLocator=function(){$.post("../backend/application/index.php?rota=/saveFlightLocator",{hashId:$scope.$parent.hashId,flightLocator:$scope.editsale.flightLocator,sales:$scope.selectedSale},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$apply();});};$scope.loadSalesByFilter=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSaleByFilter",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.sales=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.search();$scope.$apply();return $scope.select($scope.currentPage);});};$scope.findCard=function(){$.post("../backend/application/index.php?rota=/loadSalesMiles",{hashId:$scope.session.hashId,milesUsed:$scope.selected.milesused,airline:$scope.selected.airline},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset;$scope.tabindex=3;$scope.$apply();});};$scope.setCard=function(){$scope.selected.providerName=this.mile.name;$scope.selected.cards_id=this.mile.cards_id;$scope.tabindex=1;};$scope.validateData=function(){$scope.divergence=[];var check=false;$.post("../backend/application/index.php?rota=/loadDataConference",{hashId:$scope.session.hashId},function(result){$scope.dataConference=jQuery.parseJSON(result).dataset;for(var i in $scope.dataConference){$scope.filtered=$filter('filter')($scope.sales,$scope.dataConference[i].loc);$scope.filtered=$filter('filter')($scope.filtered,$scope.dataConference[i].paxName);$scope.filtered=$filter('filter')($scope.filtered,$scope.dataConference[i].valorPago);$scope.filtered=$filter('filter')($scope.filtered,$scope.dataConference[i].amountPaid);$scope.filtered=$filter('filter')($scope.filtered,$scope.dataConference[i].dU);check=false;if($scope.filtered.length>0){check=true;}if(!check){$scope.divergence.push($scope.dataConference[i]);}}$rootScope.$emit('openDataConference',$scope.divergence);void 0;});};$scope.dataConferenceSales=function(){$.post("../backend/application/index.php?rota=/dataConferenceSales",{hashId:$scope.session.hashId},function(result){$scope.dataConference=jQuery.parseJSON(result).dataset;void 0;});};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.from=true;$scope.to=true;$scope.paxName=true;$scope.issuing=true;$scope.providerName=true;$scope.user=true;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClient",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;});$.post("../backend/application/index.php?rota=/loadAirport",$scope.session,function(result){$scope.airports=jQuery.parseJSON(result).dataset;});};return init();}]).controller('DataConferenceModalCtrl',['$scope','$rootScope','$modal','$log','logger',function($scope,$rootScope,$modal,$log,logger){$rootScope.$on('openDataConference',function(event,args){$scope.open(args);});$scope.open=function(args){$scope.divergences=args;var modalInstance;modalInstance=$modal.open({templateUrl:"DataConferenceModalCtrl.html",controller:'DataConferenceInstanceCtrl',periods:$scope.$parent.periods,resolve:{divergences:function divergences(){return $scope.divergences;}}});modalInstance.result.then(function(billing){$scope.saveBilling(billing);});};}]).controller('DataConferenceInstanceCtrl',['$scope','$rootScope','$modalInstance','divergences',function($scope,$rootScope,$modalInstance,divergences){$scope.divergences=divergences;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.marketing').controller('DealersB2CCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredPromos=[];$scope.row='';$scope.clientStatus=['Aprovado','Bloqueado'];$scope.setSelected=function(){$scope.selected=this.dealer;$scope.tabindex=1;$scope.loadSubDealers();};$scope.newDealer=function(){$scope.selected={};$scope.tabindex=1;};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadDealers();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadDealers();};$scope.saveDealer=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/saveDealer",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadDealers();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.cancelEdit=function(){$scope.loadDealers();$scope.tabindex=0;};$scope.loadDealers=function(){cfpLoadingBar.start();void 0;$.post("../backend/application/index.php?rota=/marketing/loadDealers",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown},function(result){$scope.dealers=jQuery.parseJSON(result).dataset.dealers;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.$digest();});};$scope.loadSubDealers=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/loadSubDealers",{data:$scope.selected},function(result){$scope.subDealers=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.$digest();});};$scope.saveSubDealers=function(dealerSelected){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/saveSubDealers",{data:$scope.selected,subDealer:dealerSelected},function(result){$scope.loadSubDealers();});};$scope.openSubDealerModal=function(){if(this.subDealer){$scope.subDealer=this.subDealer;}else{$scope.subDealer={};}var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/sub_dealer_modal.html",controller:'SubDealerInstanceCtrl',periods:$scope.$parent.periods,resolve:{subDealer:function subDealer(){return $scope.subDealer;}}});modalInstance.result.then(function(dealerSelected){$scope.saveSubDealers(dealerSelected);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePromos=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadDealers();cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/loadDealers",{},function(result){$scope.allDealers=jQuery.parseJSON(result).dataset.dealers;cfpLoadingBar.complete();$scope.$digest();});};return init();}]).controller('SubDealerInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','subDealer',function($scope,$rootScope,$modalInstance,logger,subDealer){$scope.clientStatus=['Aprovado','Bloqueado'];$scope.subDealer=subDealer;$scope.save=function(){$modalInstance.close($scope.subDealer);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.sale').controller('DealersOrdersCtrl',['$scope','$rootScope','$filter','$timeout','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$timeout,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredProviders=[];$scope.row='';$scope.loadDealersOrders=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadDealersOrders",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){cfpLoadingBar.complete();$scope.orders=jQuery.parseJSON(result).dataset.orders;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.$digest();});};$scope.export=function(){$.post("../backend/application/index.php?rota=/loadDealersOrders",{},function(result){$scope.salesToReport=jQuery.parseJSON(result).dataset.orders;var find='<br>';var re=new RegExp(find,'g');var data=[['id','Cliente','Status','Milhas','Valor','Data','Origem','Trecho','Companhia','Embarque','Observacao','Evento']];for(var i in $scope.salesToReport){data.push([$scope.salesToReport[i].id,$scope.salesToReport[i].client,$scope.salesToReport[i].status,$rootScope.formatNumber($scope.salesToReport[i].miles,0),$scope.salesToReport[i].amount,$filter('date')(new Date($scope.salesToReport[i].issue_date),'dd/MM/yyyy hh:mm:ss'),$scope.salesToReport[i].origin,$scope.salesToReport[i].path,$scope.salesToReport[i].airlines,$filter('date')(new Date($scope.salesToReport[i].firstBoardingDate),'dd/MM/yyyy hh:mm:ss'),$scope.salesToReport[i].comments,$scope.salesToReport[i].event.replace(re,'|')]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","my_data.csv");document.body.appendChild(link);link.click();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[0];$scope.currentPage=1;$scope.currentPageProviders=[];init=function init(){$scope.tabindex=0;$scope.checkValidRoute();$scope.loadDealersOrders();};return init();}]);})();(function(){'use strict';angular.module('app.internal').controller('DocumentsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filtered=[];$scope.row='';$scope.selected={};$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPage=$scope.filtered.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filtered=$filter('filter')($scope.documents,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){original=angular.copy(this.doc);$scope.selected=this.doc;$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filtered=$filter('orderBy')($scope.documents,rowName);return $scope.onOrderChange();};$scope.saveDocument=function(){$.post("../backend/application/index.php?rota=/saveDocuments",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadDocuments();});};$scope.cancelEdit=function(){$scope.selected={};$scope.loadDocuments();};$scope.loadDocuments=function(){$.post("../backend/application/index.php?rota=/loadDocuments",$scope.session,function(result){$scope.documents=jQuery.parseJSON(result).dataset;$scope.search();$scope.tabindex=0;$scope.$apply();});};$scope.newDocument=function(){$scope.selected={};$scope.tabindex=1;};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPage=[];init=function init(){$scope.tabindex=0;$scope.checkValidRoute();$scope.loadDocuments();};return init();}]);})();;(function(){'use strict';angular.module('app.purchase').controller('EditProfileCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger','FileUploader',function($scope,$rootScope,$filter,cfpLoadingBar,logger,FileUploader){var init;var original;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.userStatus=['Pendente','Aprovado','Bloqueado','Reprovado'];$scope.specialChars=['!','@','#','$','%','¨','&','*','.',':','^','~','?'];$scope.searchKeywords='';$scope.filteredUsers=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageUsers=$scope.filteredUsers.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredUsers=$filter('filter')($scope.users,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.users[0];$scope.isTable=false;$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};return void 0;};$scope.newUser=function(){$scope.selected={};$scope.isTable=false;};$scope.toggleFormTable=function(){$scope.isTable=false;return void 0;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredUsers=$filter('orderBy')($scope.users,rowName);return $scope.onOrderChange();};$scope.verify=function(){$scope.checkscpecialChat=false;$scope.checkNumber=false;$scope.checkString=false;for(var i in $scope.selected.password){if(!isNaN($scope.selected.password[i])){$scope.checkNumber=true;}if(isNaN($scope.selected.password[i])){$scope.checkString=true;}if($scope.specialChars.indexOf($scope.selected.password[i])!=-1){$scope.checkscpecialChat=true;}}};$scope.saveUser=function(){if($scope.form_user.$valid){if(!$scope.main.isMaster){if($scope.selected.password.length>6){for(var i in $scope.selected.password){if(!isNaN($scope.selected.password[i])){$scope.checkNumber=true;}if(isNaN($scope.selected.password[i])){$scope.checkString=true;}if($scope.specialChars.indexOf($scope.selected.password[i])!=-1){$scope.checkscpecialChat=true;}}if(!$scope.checkNumber||!$scope.checkString||!$scope.checkscpecialChat){return logger.logError('Verifique requisitos');}}else{return logger.logError('Senha Muito Curta');}$scope.selected.cityfullname=$scope.selected.city+', '+$scope.selected.state;if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){return logger.logError('CPF Inválido');}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){return logger.logError('CNPJ Inválido');}}}$scope.uploader.uploadAll();cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveProfile",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);window.location='#/page/profile';$scope.isTable=false;cfpLoadingBar.complete();});}};$scope.cancelEdit=function(){$scope.isTable=false;};$scope.loadProfile=function(){$.post("../backend/application/index.php?rota=/loadProfile",{hashId:$scope.session.hashId,id:$scope.main.id},function(result){$scope.users=jQuery.parseJSON(result).dataset;$scope.search();$scope.setSelected();return $scope.select($scope.currentPage);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageUsers=[];init=function init(){$scope.checkNumber=false;$scope.checkscpecialChat=false;$scope.checkString=false;$scope.checkValidRoute();$scope.isTable=false;$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$('#userstate').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;});cfpLoadingBar.complete();});$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveProfilePicture";$scope.uploader.filters.push({name:'imageFilter',fn:function fn(item,options){var type='|'+item.type.slice(item.type.lastIndexOf('/')+1)+'|';return'|jpg|'.indexOf(type)!==-1;}});cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSelfProfile",{hashId:$scope.session.hashId,data:$scope.main},function(result){$scope.selected=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});};return init();}]).directive('ngThumb',['$window',function($window){var helper={support:!!($window.FileReader&&$window.CanvasRenderingContext2D),isFile:function isFile(item){return angular.isObject(item)&&item instanceof $window.File;},isImage:function isImage(file){var type='|'+file.type.slice(file.type.lastIndexOf('/')+1)+'|';return'|jpg|png|jpeg|bmp|gif|'.indexOf(type)!==-1;}};return{restrict:'A',template:'<canvas/>',link:function link(scope,element,attributes){if(!helper.support)return;var params=scope.$eval(attributes.ngThumb);if(!helper.isFile(params.file))return;if(!helper.isImage(params.file))return;var canvas=element.find('canvas');var reader=new FileReader();reader.onload=onLoadFile;reader.readAsDataURL(params.file);function onLoadFile(event){var img=new Image();img.onload=onLoadImage;img.src=event.target.result;}function onLoadImage(){var width=params.width||this.width/this.height*params.height;var height=params.height||this.height/this.width*params.width;canvas.attr({width:width,height:height});canvas[0].getContext('2d').drawImage(this,0,0,width,height);}}};}]);})();;(function(){'use strict';angular.module('app.maintenance').controller('EmailsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger','FileUploader',function($scope,$rootScope,$filter,cfpLoadingBar,logger,FileUploader){var init;$scope.status=['PENDENTE','ENVIADO'];$scope.searchKeywords='';$scope.currentPageEmails=[];$scope.row='';$scope.fillEmailContent=function(){$scope.selected=angular.copy(this.email);$scope.uploader.formData={hashId:$scope.session.hashId,data:$scope.selected};$scope.webEmail.emailpartner=$scope.selected.partner;$scope.webEmail.subject=$scope.selected.subject;$scope.webEmail.emailContent=$scope.selected.content;$scope.tabindex=1;};$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;$scope.currentPageEmails=$scope.filteredEmails.slice(start,end);$scope.$digest();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredEmails=$filter('filter')($scope.Emails,$scope.searchKeywords);return $scope.onFilterChange();};$scope.findDate=function(date){var data=new Date(date);return data.setDate(data.getDate()+1);};$scope.removeEmail=function(email){$.post("../backend/application/index.php?rota=/removeEmailScheduled",{hashId:$scope.session.hashId,data:email},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadEmails();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.removeItem=function(item){$.post("../backend/application/index.php?rota=/removeFileScheduled",{hashId:$scope.session.hashId,data:$scope.selected,file:item},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFilesSelected();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.loadFilesSelected=function(){$.post("../backend/application/index.php?rota=/loadFilesSelected",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.attachments=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.mailOrder=function(){$.post("../backend/application/index.php?rota=/sendMailScheduled",{hashId:$scope.session.hashId,data:$scope.selected,mail:$scope.webEmail},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadFilesSelected();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.cancelEdit=function(){$scope.tabindex=0;$scope.selected={};$scope.loadEmails();};$scope.loadEmails=function(){$.post("../backend/application/index.php?rota=/loadEmails",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.Emails=jQuery.parseJSON(result).dataset;$scope.search();});};$scope.getStatusOrder=function(status){switch(status){case'PENDENTE':return"Pendente";case'RESERVA':return"Reserva";case'EMITIDO':return"Emitido";case'ENVIADO':return"Enviado";case'CANCELADO':return"Cancelado";case'ESPERA':return"Espera";}};$scope.orderTag=function(status){switch(status){case'PENDENTE':return"label label-warning";case'RESERVA':return"label label-info";case'ENVIADO':return"label label-success";case'EMITIDO':return"label label-success";case'CANCELADO':return"label label-danger";case'ESPERA':return"label label-default";}};$scope.sendEmails=function(){$.post("../backend/application/index.php?rota=/sendAllEmails",{hashId:$scope.session.hashId},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess("Emails Na fila para envio!");$scope.loadFilesSelected();}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageEmails=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadEmails();$scope.filter={};$scope.webEmail={};$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFileScheduled";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});$scope.uploader.onCompleteItem=function(fileItem,response,status,headers){$scope.loadFilesSelected();};};return init();}]).controller('EmailsModalCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.open=function(){$scope.status=$scope.$parent.status;$scope.filter=$scope.$parent.filter;var modalInstance;modalInstance=$modal.open({templateUrl:"EmailsScheduled.html",controller:'EmailsScheduledModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;},status:function status(){return $scope.status;}}});modalInstance.result.then(function(filter){if(filter!==undefined){filter._dateFrom=$rootScope.formatServerDate(filter.dateFrom);filter._dateTo=$rootScope.formatServerDate(filter.dateTo);}$scope.$parent.filter=filter;$scope.$parent.loadEmails();});};}]).controller('EmailsScheduledModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter','status',function($scope,$rootScope,$modalInstance,filter,status){$scope.filter=filter;$scope.status=status;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.table').controller('EndPurchaseCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filteredPurchases=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePurchases=$scope.filteredPurchases.slice(start,end);};$scope.onFilterChange=function(){$scope.loadPurchasesWaiting();};$scope.onNumPerPageChange=function(){$scope.loadPurchasesWaiting();};$scope.onOrderChange=function(){$scope.loadPurchasesWaiting();};$scope.findColor=function(purchase){if(purchase.payment_status=='A')return"#FBA1A1";else return;};$scope.findDate=function(date){return new Date(date);};$scope.setSelected=function(){$scope.selected={};$scope.selected=this.purchase;$scope.airlineShowFields=this.purchase.airline=='TAM'||this.purchase.airline=='LATAM';$scope.purchaseDate=new Date($scope.selected.purchaseDate+'T12:00:00Z');$scope.selected.milesDueDate=new Date($scope.selected.milesDueDate+'T12:00:00Z');$scope.selected.payment_date=new Date($scope.selected.payment_date);$scope.contractDueDate=new Date($scope.selected.contract_due_date+'T12:00:00Z');$('#purchasemiles').number(true,0,',','.');$('#purchasecostperthousand').number(true,2,',','.');$('#purchasetotalcost').number(true,2,',','.');if($scope.selected.bloqued=="Y")$scope.selected.is_bloqued=true;else $scope.selected.is_bloqued=false;if($scope.selected.status_purchase=='T'){$scope.openModalTransfer();}else{$scope.isTable=false;}$scope.selected.isPriority=false;if($scope.selected.partner_status=='Pendente'||$scope.selected.partner_status=='Bloqueado'){logger.logError("Status do cliente: "+$scope.selected.partner_status);}return true;};$scope.saveStatus=function(){if($scope.selected.airline=='LATAM'){if($scope.selected.onlyInter==null||$scope.selected.onlyInter=='null'){return logger.logError('Tipo de emissão obrigatorio!');}}if($scope.loading==true){return logger.logError('processo em andamento!');}if($scope.form_purchase.$valid){$scope.loading=true;cfpLoadingBar.start();$scope.selected.recoveryPassword=$scope.ecript($scope.selected.recoveryPassword);$scope.selected.accessPassword=$scope.ecript($scope.selected.accessPassword);$scope.selected.contract_due_date=$rootScope.formatServerDate($scope.contractDueDate);$scope.selected._milesDueDate=$rootScope.formatServerDate($scope.selected.milesDueDate);$.post("../backend/application/index.php?rota=/generatePurchase",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.loading=false;logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.isTable=true;$scope.$apply();cfpLoadingBar.complete();$scope.loadPurchasesWaiting();});}else{logger.logError("Existem dados necessarios não vinculados!");}};$scope.print=function(){$scope.filter.airline='LATAM';$.post("../backend/application/index.php?rota=/loadPurchasesToOperations",{order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,searchKeywords:$scope.searchKeywords},function(result){$scope.purchasesReport=jQuery.parseJSON(result).dataset.purchases;var data=[['Dt finalizado','PG','Cadastro','Data Comp.','Cliente','token','Nº Fidelidade','CARTÃO','Ass Eletronica','Senha Resgate','CPF/Multiplus','Senha Multiplus','VENCIMENTO','Qtd. de Milhas','Milhas Utilizadas','TOTAL','Valor p/ 1.000 pts','Valor Total','OBS.','Telefone Contato','E-mail Contato']];for(var i in $scope.purchasesReport){data.push([$scope.purchasesReport[i].merge_date!=''?$filter('date')(new Date($scope.purchasesReport[i].merge_date),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Billspay_DueDate!=''?$filter('date')(new Date($scope.purchasesReport[i].Billspay_DueDate),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Cadastro,$filter('date')(new Date($scope.purchasesReport[i].purchase_date),'dd/MM/yyyy hh:mm:ss'),$scope.purchasesReport[i].providerName,$scope.purchasesReport[i].token,$scope.purchasesReport[i].card_number,'','',$scope.decript($scope.purchasesReport[i].recovery_password),$scope.purchasesReport[i].registration_code,$scope.decript($scope.purchasesReport[i].access_password),$filter('date')(new Date($scope.purchasesReport[i].miles_due_date),'dd/MM/yyyy hh:mm:ss'),$rootScope.formatNumber($scope.purchasesReport[i].leftover,0),$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles-$scope.purchasesReport[i].leftover,0),$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles,0),$scope.purchasesReport[i].cost_per_thousand,$scope.purchasesReport[i].total_cost,'',$scope.purchasesReport[i].phone_number+' / '+$scope.purchasesReport[i].phone_number2,$scope.purchasesReport[i].email]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","latam.csv");document.body.appendChild(link);link.click();});$scope.filter.airline='AZUL';$.post("../backend/application/index.php?rota=/loadPurchasesToOperations",{order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,searchKeywords:$scope.searchKeywords},function(result){$scope.purchasesReport=jQuery.parseJSON(result).dataset.purchases;var data=[['Dt finalizado','PG','Cadastro','Data Comp.','Cliente','Nº  Cartão','Senha','CPF','Qtd de Milhas','Milhas Utilizadas','REAL Valor p/ 1.000 pts','Valor Total','Análise','OBS.','Telefone Contato','E-mail Contato','CONTA','CARTÃO','BANDEIRA','VALIDADE','CÓD.','NOME','obs 2:']];for(var i in $scope.purchasesReport){data.push([$scope.purchasesReport[i].merge_date!=''?$filter('date')(new Date($scope.purchasesReport[i].merge_date),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Billspay_DueDate!=''?$filter('date')(new Date($scope.purchasesReport[i].Billspay_DueDate),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Cadastro,$filter('date')(new Date($scope.purchasesReport[i].purchase_date),'dd/MM/yyyy hh:mm:ss'),$scope.purchasesReport[i].providerName,$scope.purchasesReport[i].card_number,$scope.decript($scope.purchasesReport[i].recovery_password),$scope.purchasesReport[i].registration_code,$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles,0),$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles-$scope.purchasesReport[i].leftover,0),$scope.purchasesReport[i].cost_per_thousand,$scope.purchasesReport[i].total_cost,'','',$scope.purchasesReport[i].phone_number+' / '+$scope.purchasesReport[i].phone_number2,$scope.purchasesReport[i].email,'','','','','','','']);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","azul.csv");document.body.appendChild(link);link.click();});$scope.filter.airline='AVIANCA';$.post("../backend/application/index.php?rota=/loadPurchasesToOperations",{order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,searchKeywords:$scope.searchKeywords},function(result){$scope.purchasesReport=jQuery.parseJSON(result).dataset.purchases;var data=[['Dt finalizado','PG','Cadastro','Data Comp.','Cliente','Nº  Cartão','Senha','CPF','Qtd de Milhas','Milhas Utilizadas','REAL Valor p/ 1.000 pts','Valor Total','Situação da Análise','Telefone Contato','E-mail Contato','PG','EXPIRAR']];for(var i in $scope.purchasesReport){data.push([$scope.purchasesReport[i].merge_date!=''?$filter('date')(new Date($scope.purchasesReport[i].merge_date),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Billspay_DueDate!=''?$filter('date')(new Date($scope.purchasesReport[i].Billspay_DueDate),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Cadastro,$filter('date')(new Date($scope.purchasesReport[i].purchase_date),'dd/MM/yyyy hh:mm:ss'),$scope.purchasesReport[i].providerName,$scope.purchasesReport[i].card_number,$scope.decript($scope.purchasesReport[i].recovery_password),$scope.purchasesReport[i].registration_code,$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles,0),$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles-$scope.purchasesReport[i].leftover,0),$scope.purchasesReport[i].cost_per_thousand,$scope.purchasesReport[i].total_cost,'',$scope.purchasesReport[i].phone_number+' / '+$scope.purchasesReport[i].phone_number2,$scope.purchasesReport[i].email,'','']);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","avianca.csv");document.body.appendChild(link);link.click();});$scope.filter.airline='GOL';$.post("../backend/application/index.php?rota=/loadPurchasesToOperations",{order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,searchKeywords:$scope.searchKeywords},function(result){$scope.purchasesReport=jQuery.parseJSON(result).dataset.purchases;var data=[['Dt finalizado','PG','Cadastro','Data Comp.','Cliente','Nº  Cartão','Senha','CARTAO','CPF','Qtd de Milhas','Milhas Utilizadas','REAL Valor p/ 1.000 pts','Valor Total','Situação da Análise','OBS.','Telefone Contato','E-mail Contato','EXPIRAR']];for(var i in $scope.purchasesReport){data.push([$scope.purchasesReport[i].merge_date!=''?$filter('date')(new Date($scope.purchasesReport[i].merge_date),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Billspay_DueDate!=''?$filter('date')(new Date($scope.purchasesReport[i].Billspay_DueDate),'dd/MM/yyyy hh:mm:ss'):'',$scope.purchasesReport[i].Cadastro,$filter('date')(new Date($scope.purchasesReport[i].purchase_date),'dd/MM/yyyy hh:mm:ss'),$scope.purchasesReport[i].providerName,$scope.purchasesReport[i].card_number,$scope.decript($scope.purchasesReport[i].recovery_password),$scope.purchasesReport[i].registration_code,$scope.purchasesReport[i].registration_code,$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles,0),$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles-$scope.purchasesReport[i].leftover,0),$scope.purchasesReport[i].cost_per_thousand,$scope.purchasesReport[i].total_cost,'','',$scope.purchasesReport[i].phone_number+' / '+$scope.purchasesReport[i].phone_number2,$scope.purchasesReport[i].email,'']);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","gol.csv");document.body.appendChild(link);link.click();});};$scope.ecript=function(code){if(code!=undefined){var data=code.split('');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;}};$scope.cardPassword=function(){for(var i=0;$scope.purchases.length>i;i++){$scope.purchases[i].recoveryPassword=$scope.decript($scope.purchases[i].recoveryPassword);if($scope.purchases[i].airline=="TAM"||$scope.purchases[i].airline=="LATAM"){$scope.purchases[i].accessPassword=$scope.decript($scope.purchases[i].accessPassword);}else{$scope.purchases[i].accessPassword=" - ";}}$scope.$apply();};$scope.decript=function(code){if(code!=null&&code!=undefined){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;}};$scope.setTotalCost=function(){$scope.selected.totalCost=$scope.selected.purchaseMiles/1000*$scope.selected.costPerThousand;return $scope.$apply();};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return $scope.isTable;};$scope.search=function(){$scope.loadPurchasesWaiting();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePurchases=[];$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadPurchasesWaiting();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadPurchasesWaiting();};$scope.loadPurchasesWaiting=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadPurchasesWaiting",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.purchases=jQuery.parseJSON(result).dataset.purchases;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.cardPassword();cfpLoadingBar.complete();$scope.$digest();});};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open('GET',url);xhr.send();};$scope.printUtilizacao=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFont("times");doc.setFontSize(10);doc.line(30,80,100,80);doc.text(30,78,"TOKEN");doc.text(30,88,$scope.selected.token);doc.line(30,110,100,110);doc.text(30,108,"COMPRA");doc.text(30,118,$filter('date')(new Date($scope.selected.purchaseDate+'T12:00:00Z'),'dd/MM/yyyy'));doc.line(30,140,100,140);doc.text(30,138,"VENCIMENTO");doc.text(30,148,$filter('date')($scope.selected.milesDueDate,'dd/MM/yyyy'));$scope.toDataUrl('images/bank.jpg',function(base64Img){doc.addImage(base64Img,'JPEG',50,20,150,40);doc.setFontSize(28);doc.text(300,50,"FICHA DE USO ");doc.setFontSize(10);var start=100;doc.line(305,start+10,400,start+10);doc.text(305,start+8,"CPF");doc.text(305,start+18,$scope.selected.registrationCode);start+=30;doc.line(305,start+10,500,start+10);doc.text(305,start+8,"NOME DO TITULAR");doc.text(305,start+18,$scope.selected.partnerName);start+=50;doc.setDrawColor(91,0,255);doc.setFillColor(91,0,255);doc.rect(20,start,550,10,'FD');start+=20;doc.autoTable([{title:"Cia",dataKey:"cia"},{title:"Pontos",dataKey:"pts"},{title:"Nº FIDELIDADE",dataKey:"numero"},{title:"SENHA",dataKey:'senha'}],[{cia:$scope.selected.airline,pts:$rootScope.formatNumber($scope.selected.purchaseMiles,0),numero:$scope.selected.cardNumber,senha:$scope.selected.recoveryPassword}],{startY:start,margin:{left:150,right:150},theme:'striped',styles:{overflow:'linebreak'},headerStyles:{height:8,fontSize:8}});start=doc.autoTableEndPosY()+20;for(var index=0;index<10;index++){doc.rect(20,start,70,20);doc.text(25,start+10,"PEDIDO "+(parseInt(index)+1));doc.rect(90,start,150,20);doc.text(95,start+10,"DATA: ");doc.rect(240,start,150,20);doc.text(245,start+10,"LOC: ");doc.rect(390,start,150,20);doc.text(395,start+10,"Ptos Vendidos: ");start+=30;}doc.autoTable([{title:"",dataKey:"nada"},{title:"PEDIDO 1",dataKey:"1"},{title:"PEDIDO 2",dataKey:"2"},{title:"PEDIDO 3",dataKey:"3"},{title:"PEDIDO 4",dataKey:"4"},{title:"PEDIDO 5",dataKey:'5'}],[{nada:"PTS UTILIZADOS",1:"",2:"",3:"",4:"",5:""},{nada:"SALDO",1:"",2:"",3:"",4:"",5:""}],{startY:start,margin:{left:20,right:20},theme:'grid',styles:{overflow:'linebreak'},headerStyles:{height:8,fontSize:8}});start=doc.autoTableEndPosY()+40;doc.autoTable([{title:"",dataKey:"nada"},{title:"PEDIDO 6",dataKey:"6"},{title:"PEDIDO 7",dataKey:"7"},{title:"PEDIDO 8",dataKey:"8"},{title:"PEDIDO 9",dataKey:"9"},{title:"PEDIDO 10",dataKey:'10'}],[{nada:"PTS UTILIZADOS",6:"",7:"",8:"",9:"",10:""},{nada:"SALDO",6:"",7:"",8:"",9:"",10:""}],{startY:start,margin:{left:20,right:20},theme:'grid',styles:{overflow:'linebreak'},headerStyles:{height:8,fontSize:8}});start=doc.autoTableEndPosY()+40;doc.save($scope.selected.registrationCode+'_utilizacao_'+'.pdf');});};$scope.printReport=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFont("times");$scope.toDataUrl('images/bank.jpg',function(base64Img){doc.addImage(base64Img,'JPEG',50,20,110,40);doc.text(220,40,"FICHA DE PAGAMENTO ");var start=70;doc.autoTable([{title:"Nome",dataKey:"name"},{title:"CPF",dataKey:"cpf"},{title:"Email",dataKey:"email"}],[{name:$scope.selected.partnerName,cpf:mCPF($scope.selected.registrationCode),email:$scope.selected.email}],{startY:start,margin:{left:100,rigth:rigth},theme:'plain',styles:{overflow:'linebreak'},headerStyles:{height:8,fontSize:8,fillColor:[44,74,175],textColor:255}});start=doc.autoTableEndPosY()+15;doc.autoTable([{title:"Companhia",dataKey:"cia"},{title:"Data Compra",dataKey:"date"}],[{cia:$scope.selected.airline,date:$filter('date')(new Date($scope.selected.purchaseDate+'T12:00:00Z'),'dd/MM/yyyy')}],{startY:start,margin:{left:50,right:50},theme:'plain',styles:{overflow:'linebreak'},columnStyles:{cia:{columnWidth:'100'},date:{columnWidth:'100'},0:{columnWidth:'100'},1:{columnWidth:'100'},title:{halign:'center',fillColor:[0,0,255]}},headerStyles:{height:8,fontSize:8,fillColor:[44,74,175],textColor:255}});start=doc.autoTableEndPosY()+15;doc.autoTable([{title:"Milhas",dataKey:"miles"},{title:"Valor Por Milhar",dataKey:"milhar"},{title:"Valor Total",dataKey:"total"}],[{miles:$rootScope.formatNumber($scope.selected.purchaseMiles,0),milhar:'R$ '+$rootScope.formatNumber($scope.selected.costPerThousand,2),total:'R$ '+$rootScope.formatNumber($scope.selected.totalCost,2)}],{startY:start,margin:{left:50,right:50},theme:'plain',columnStyles:{title:{halign:'center',fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175],textColor:255}});start=doc.autoTableEndPosY()+15;doc.autoTable([{title:"Vencimento",dataKey:"vencimento"},{title:"Limite Comercialização",dataKey:"limite"},{title:"Data Pagamento",dataKey:"pagamento"}],[{vencimento:$filter('date')($scope.selected.milesDueDate,'dd/MM/yyyy'),limite:$filter('date')($scope.contractDueDate,'dd/MM/yyyy'),pagamento:$filter('date')(new Date($scope.selected.payment_date),'dd/MM/yyyy')}],{startY:start,margin:{left:50,right:50},theme:'plain',columnStyles:{title:{halign:'center',fillColor:[0,0,255]}},headerStyles:{fillColor:[44,74,175],textColor:255}});start=doc.autoTableEndPosY()+15;var onlyInter='';if($scope.selected.onlyInter=='true'){onlyInter='Internacional';}if($scope.selected.onlyInter=='false'){onlyInter='Nacional';}doc.line(0,start,600,start);start+=15;doc.autoTable([{title:"Banco",dataKey:"bank"},{title:"Agencia",dataKey:"agency"},{title:"Conta",dataKey:"account"},{title:"Operacao",dataKey:"bankOperation"}],[{emissao:$scope.selected.bank?$scope.selected.bank:'',cartao:$scope.selected.agency?$scope.selected.agency:'',token:$scope.selected.account?$scope.selected.account:'',bankOperation:$scope.selected.bankOperation?$scope.selected.bankOperation:''}],{startY:start,margin:{left:50,right:50},theme:'plain',columnStyles:{title:{halign:'center',fillColor:[0,0,255]}},headerStyles:{height:8,fontSize:8,fillColor:[44,74,175],textColor:255}});start=doc.autoTableEndPosY()+15;doc.autoTable([{title:"Nome Titular",dataKey:"bankNameOwner"},{title:"CPF Titular",dataKey:"cpfNameOwner"}],[{emissao:$scope.selected.bankNameOwner?$scope.selected.bankNameOwner:'',cartao:mCPF($scope.selected.cpfNameOwner)}],{startY:start,margin:{left:50,right:50},theme:'plain',columnStyles:{title:{halign:'center',fillColor:[0,0,255]}},headerStyles:{height:8,fontSize:8,fillColor:[44,74,175],textColor:255}});start=doc.autoTableEndPosY()+15;doc.save($scope.selected.registrationCode+'.pdf');});};$scope.openSearchModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"EndPurchase.html",controller:'EndPurchaseModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._purchaseDateFrom=$rootScope.formatServerDate(filter.purchaseDateFrom);filter._purchaseDateTo=$rootScope.formatServerDate(filter.purchaseDateTo);}$scope.filter=filter;$scope.loadPurchasesWaiting();},function(){void 0;});};function mCPF(cpf){if(!cpf||cpf==''){return'';}cpf=cpf.replace(/\D/g,"");cpf=cpf.replace(/(\d{3})(\d)/,"$1.$2");cpf=cpf.replace(/(\d{3})(\d)/,"$1.$2");cpf=cpf.replace(/(\d{3})(\d{1,2})$/,"$1-$2");return cpf;}$scope.loadPurchasesBusinessPartner=function(){};init=function init(){$scope.checkValidRoute();$scope.isTable=true;$scope.loading=false;$scope.loadPurchasesWaiting();};return init();}]).controller('EndPurchaseModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.statusPrucases=['Confirmadas','Canceladas','Pendentes'];$scope.filter=filter;$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.table').controller('FutureBoardingsCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredBoardings=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBoardings=$scope.filteredBoardings.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.findDate=function(date){return new Date(date);};$scope.search=function(){$scope.filteredBoardings=$filter('filter')($scope.Boardings,$scope.searchKeywords);return $scope.onFilterChange();};$scope.saveSelected=function(){$.post("../backend/application/index.php?rota=/saveCheckInStatus",{hashId:$scope.session.hashId,data:$scope.Boardings},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredBoardings=$filter('orderBy')($scope.Boardings,rowName);return $scope.onOrderChange();};$scope.getClass=function(boardings){if(boardings.occurrence!='Ocorrencia'){return'btn btn-danger smallBtn';}else{return'btn btn-line-info smallBtn';}};$scope.print=function(){var doc=new jsPDF('l','pt');doc.margin=0.5;doc.setFontSize(20);doc.text(150,30,'Embarques Futuros');var columns=[{title:"Cliente",dataKey:"client"},{title:"CIA",dataKey:"airline"},{title:"Data Embarque",dataKey:"boardingDate"},{title:"Pax",dataKey:"paxName"},{title:"Voo",dataKey:"flight"},{title:"Check-In",dataKey:"checkinState"},{title:"Localizador",dataKey:"flightLocator"},{title:"Ticket",dataKey:"ticket_code"},{title:"De",dataKey:"from"},{title:"Para",dataKey:"to"}];var rows=[];for(var i=0;i<$scope.filteredBoardings.length;i++){var checkin='';if($scope.filteredBoardings[i].checkinState=="true"){checkin="Realizado";}else{checkin="Pendente";}rows.push({client:$scope.filteredBoardings[i].client,airline:$scope.filteredBoardings[i].airline,boardingDate:$filter('date')($scope.filteredBoardings[i].boardingDate,'dd/MM/yyyy hh:mm:ss'),paxName:$scope.filteredBoardings[i].paxName,flight:$scope.filteredBoardings[i].flight,checkinState:checkin,flightLocator:$scope.filteredBoardings[i].flightLocator,ticket_code:$scope.filteredBoardings[i].ticket_code,from:$scope.filteredBoardings[i].from,to:$scope.filteredBoardings[i].to});}doc.autoTable(columns,rows,{styles:{fontSize:8},createdCell:function createdCell(cell,data){}});doc.save('embarques_futuros.pdf');};$scope.loadFutureBoardings=function(){$.post("../backend/application/index.php?rota=/loadFutureBoardings",$scope.session,function(result){$scope.Boardings=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.saveOccurrence=function(saleSelected){$.post("../backend/application/index.php?rota=/saveSaleOccurrence",{hashId:$scope.session.hashId,data:saleSelected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.markAll=function(){for(var i in $scope.Boardings){$scope.Boardings[i].checkinState=true;}};$scope.removeAll=function(){for(var i in $scope.Boardings){$scope.Boardings[i].checkinState=false;}};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageClients=[];init=function init(){$scope.filter={};$scope.isTable=true;$scope.checkValidRoute();cfpLoadingBar.start();$scope.loadFutureBoardings();};$scope.openModalLog=function(){$scope.saleSelected=this.boardings;$.post("../backend/application/index.php?rota=/loadLog",{hashId:$scope.session.hashId,data:$scope.saleSelected},function(result){$scope.logDescriptions=jQuery.parseJSON(result).dataset;$scope.saleSelected._boardingDate=new Date($scope.saleSelected.boardingDate);var modalInstance;modalInstance=$modal.open({templateUrl:"FutureBoardingsModalCtrl.html",controller:'FutureBoardingsModalInstanceCtrl',periods:$scope.periods,size:'lg',resolve:{saleSelected:function saleSelected(){return $scope.saleSelected;},logDescriptions:function logDescriptions(){return $scope.logDescriptions;}}});modalInstance.result.then(function(saleSelected){$scope.saveOccurrence(saleSelected);});});};return init();}]).controller('BoardingsModalDemoCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.loadFutureBoardings=function(){$.post("../backend/application/index.php?rota=/loadFutureBoardings",{hashId:$scope.session.hashId,data:$scope.$parent.filter},function(result){$scope.$parent.Boardings=jQuery.parseJSON(result).dataset;$scope.$parent.search();$scope.$parent.$apply();return $scope.$parent.select($scope.$parent.currentPage);});};$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"Boardings.html",controller:'BoardingsModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._boardingDateFrom=$rootScope.formatServerDate(filter.boardingDateFrom);filter._boardingDateTo=$rootScope.formatServerDate(filter.boardingDateTo);}$scope.$parent.filter=filter;$scope.loadFutureBoardings();});};}]).controller('BoardingsModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('FutureBoardingsModalInstanceCtrl',['$scope','$rootScope','$modalInstance','saleSelected','logDescriptions',function($scope,$rootScope,$modalInstance,saleSelected,logDescriptions){$scope.saleSelected=saleSelected;$scope.logDescriptions=logDescriptions;$scope.salesOccurrences=['Remarcação','Reembolso','Check-In Fechado','Outros'];$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.findDate=function(date){return new Date(date);};$scope.ok=function(){$modalInstance.close($scope.saleSelected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.internal').controller('InternalCardsCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.providerStatus=['Aprovado','Bloqueado','Arquivado'];$scope.searchKeywords='';$scope.filteredCards=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageCards=$scope.filteredCards.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredCards=$filter('filter')($scope.internalCards,$scope.searchKeywords);return $scope.onFilterChange();};$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.ecript=function(code){var data=code.split("");var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;};$scope.findDate=function(date){return new Date(date);};$scope.setSelected=function(){original=angular.copy(this.card);$scope.selected=original;$('#limit').number(true,2,',','.');$('#used').number(true,2,',','.');$scope.selected._due_date=new Date($scope.selected.due_date);$scope.selected._due_date.setDate($scope.selected._due_date.getDate()+1);$scope.selected._birthdate=new Date($scope.selected.birthdate);$scope.selected._birthdate.setDate($scope.selected._birthdate.getDate()+1);$scope.card={id:$scope.selected.card_number};$.post("../backend/application/index.php?rota=/loadCreditHistoric",{hashId:$scope.session.hashId,type:'CREDITCARD',data:$scope.card},function(result){$scope.CardLog=jQuery.parseJSON(result).dataset;});$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredCards=$filter('orderBy')($scope.internalCards,rowName);return $scope.onOrderChange();};$scope.saveInternal=function(){$scope.selected._due_date=$rootScope.formatServerDate($scope.selected._due_date);$scope.selected._birthdate=$rootScope.formatServerDate($scope.selected._birthdate);$scope.selected.password=$scope.ecript($scope.selected.password);$.post("../backend/application/index.php?rota=/saveInternal",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadInternalCards();});};$scope.providerTag=function(status){switch(status){case'Aprovado':return"label label-success";case'Bloqueado':return"label label-warning";}};$scope.cancelEdit=function(){$scope.loadInternalCards();$scope.selected={};$scope.tabindex=0;};$scope.loadInternalCards=function(){$.post("../backend/application/index.php?rota=/loadInternalCards",{data:$scope.filter},function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;for(var i in $scope.internalCards){$scope.internalCards[i].password=$scope.decript($scope.internalCards[i].password);}$scope.search();cfpLoadingBar.complete();$scope.tabindex=0;$scope.$apply();return $scope.select($scope.currentPage);});};$scope.exists=function(item){if($scope.selected){if($scope.selected.priority_airline.length>0){return $scope.selected.priority_airline.indexOf(item)>-1;}}};$scope.isChecked=function(){if($scope.selected){if($scope.selected.priority_airline)return $scope.selected.priority_airline.length===$scope.airlines.length;}return false;};$scope.toggleAll=function(){if($scope.selected.priority_airline.length===$scope.airlines.length){$scope.selected.priority_airline=[];}else{$scope.selected.priority_airline=[];for(var i in $scope.airlines){$scope.selected.priority_airline.push($scope.airlines[i].name);}}};$scope.toggle=function(item){if($scope.selected.priority_airline.indexOf(item)>-1){$scope.selected.priority_airline.splice($scope.selected.priority_airline.indexOf(item),1);}else{$scope.selected.priority_airline.push(item);}};$scope.newInternal=function(){$scope.selected={};$scope.tabindex=1;};$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.selected.prodider_exclusive},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageCards=[];init=function init(){$scope.tabindex=0;$scope.newUpload=false;$scope.newFile=undefined;$scope.filter={archived:false};$scope.checkValidRoute();$scope.selected={};$.post("../backend/application/index.php?rota=/loadAirline",$scope.session,function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$scope.searchProviders();$scope.loadInternalCards();};$scope.openSearchModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"CreditCardSearchModal.html",controller:'CreditCardSearchModalInstanceCtrl',periods:$scope.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){$scope.filter=filter;$scope.loadInternalCards();},function(){$log.info("Modal dismissed at: "+new Date());});};return init();}]).controller('CreditCardSearchModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('LoginCtrl',['$scope','$rootScope','$filter','$modal','$routeParams','$location','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,$routeParams,$location,cfpLoadingBar,logger){var init;var login_form;$scope.login=function(){if($scope.form_login==undefined){login_form=$scope.form_lock;}else{login_form=$scope.form_login;}if(login_form.$valid){cfpLoadingBar.start();if($scope.data==undefined){logger.logError('Senha deve ser informada');}else if($scope.data.email==undefined){$scope.data.email=$scope.main.email;}$scope.data.hashId='5a9b0fde419b522a8b9baede73811369';$scope.data.url_parameters=$scope.url_parameters;var response=$.post("../backend/application/index.php?rota=/login",$scope.data,function(result){if(jQuery.parseJSON(result).message.type=='E'){logger.logError(jQuery.parseJSON(result).message.text);}else{$scope.dataset=jQuery.parseJSON(result).dataset[0];$scope.main.name=$scope.dataset.acessName;$scope.main.id=$scope.dataset.id;$scope.main.email=$scope.dataset.email;$scope.main.adress=$scope.dataset.adress;$scope.main.phoneNumber=$scope.dataset.phoneNumber;$scope.main.city=$scope.dataset.city;$scope.main.sales=$scope.dataset.sales;$scope.main.purchases=$scope.dataset.purchases;$scope.main.image='images/'+$scope.dataset.id+'.jpg';$scope.main.isMaster=$scope.dataset.is_master=='true';$scope.session.hashId=$scope.dataset.hashId;$.ajaxSetup({headers:{'hashId':response.getResponseHeader('hashId')}});if($scope.dataset.forceChangesPassword){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/change_password.html",controller:'ModalChangePasswordCtrl',backdrop:'static',keyboard:false,resolve:{}});return;}var permissions=JSON.parse(window.atob(response.getResponseHeader('permissions')));$scope.main.purchase=permissions.purchase;$scope.main.wizardPurchase=permissions.wizardPurchase;$scope.main.sale=permissions.sale;$scope.main.wizardSale=permissions.wizardSale;$scope.main.milesBench=permissions.milesBench;$scope.main.financial=permissions.financial;$scope.main.creditCard=permissions.creditCard;$scope.main.users=permissions.users;$scope.main.changeSale=permissions.changeSale;$scope.main.changeMiles=permissions.changeMiles;$scope.main.commercial=permissions.commercial;$scope.main.permission=permissions.permission;$scope.main.pagseguro=permissions.pagseguro;$scope.main.internRefund=permissions.internRefund;$scope.main.internCommercial=permissions.internCommercial;$scope.main.dealer=permissions.dealer;$scope.main.humanResources=permissions.humanResources;$scope.main.client=permissions.client;$scope.main.salePlansEdit=permissions.salePlansEdit;$scope.main.conference=permissions.conference;$scope.main.onlineOnlineOrder=permissions.onlineOnlineOrder;$scope.main.onlineBalanceOrder=permissions.onlineBalanceOrder;$scope.main.onlineCardsInUse=permissions.onlineCardsInUse;$scope.main.purchaseProvider=permissions.purchaseProvider;$scope.main.purchasePaymentPruchase=permissions.purchasePaymentPruchase;$scope.main.purchaseEndPruchase=permissions.purchaseEndPruchase;$scope.main.purchasePruchases=permissions.purchasePruchases;$scope.main.purchaseCardsPendency=permissions.purchaseCardsPendency;$scope.main.saleClients=permissions.saleClients;$scope.main.saleBalanceClients=permissions.saleBalanceClients;$scope.main.saleFutureBoardings=permissions.saleFutureBoardings;$scope.main.saleRefundCancel=permissions.saleRefundCancel;$scope.main.saleRevertRefund=permissions.saleRevertRefund;$scope.main.wizarSaleEvent=permissions.wizardSaleEvent;$rootScope.notifications=[];window.location=document.getElementById('submit_login').href;$rootScope.connectToSocket(response.getResponseHeader('hashId'));}cfpLoadingBar.complete();});}};init=function init(){$scope.url_parameters=window.location.search;if($scope.url_parameters.indexOf('?')>-1){$scope.url_parameters=$scope.url_parameters.substr(1);}return true;};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('ManualInvoiceCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;$scope.filter={client:"",dateFrom:""};$scope.selectedClient={code:"-",name:"-",adress:"-",cityfullname:"-",phone1:"-",phone2:"-",phone3:"-",email:"-",zip:"-"};$scope.billsreceive=[];$scope.serviceValues=0.00;$scope.searchKeywords='';$scope.row='';$scope.rowSale='';$scope.getTotal=function(){$scope.serviceValues=0;if($scope.billsreceive)if($scope.billsreceive.length>0)for(var i in $scope.billsreceive){$scope.serviceValues+=$scope.billsreceive[i].original_value;}};$scope.getManualInvoiceText=function(){var fullText="-";if($scope.billsreceive)if($scope.billsreceive.length>0){fullText="COMISSOES DE INTERMEDIACAO DE PASSAGENS AEREAS - "+$filter('date')($rootScope.findDate($scope.billsreceive[0].due_date),'MM/yyyy');for(var i in $scope.billsreceive){fullText+="\rBORDERO "+$scope.billsreceive[i].ourNumber;fullText+=" - "+$filter('date')($rootScope.findDate($scope.billsreceive[i].due_date),'dd/MM/yyyy');fullText+=" - R$"+$rootScope.formatNumber($scope.billsreceive[i].original_value);}}return fullText;};$scope.quebraLinha=function(billreceive){return"\r";};$scope.loadReportMensal=function(){var dateFrom=angular.copy($scope.filter.dateFrom);var dateTo=angular.copy(dateFrom);dateTo.setMonth(dateTo.getMonth()+1);dateTo.setDate(0);$.post("../backend/application/index.php?rota=/loadInvoiceMonthly",{hashId:$scope.session.hashId,data:$scope.filter,_dueDateFrom:$rootScope.formatServerDate(dateFrom),_dueDateTo:$rootScope.formatServerDate(dateTo)},function(result){$scope.manualInvoices=jQuery.parseJSON(result).dataset;$scope.invoiceToReport();});};$scope.invoiceToReport=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(20);doc.text(150,30,'Contas a Pagar');var columns=[{title:"Cliente",dataKey:"client"},{title:"Valor",dataKey:"amount"}];var rows=[];var total;for(var i in $scope.manualInvoices){total+=$scope.manualInvoices[i].amount;rows.push({client:$scope.manualInvoices[i].client,amount:$rootScope.formatNumber($scope.manualInvoices[i].amount)});}rows.push({amount:$rootScope.formatNumber(total)});doc.autoTable(columns,rows,{styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='amount'){cell.styles.halign='right';}}});doc.save('Relatorio.pdf');};$scope.getClientText=function(){return"CPF/CNPJ: "+$scope.selectedClient.code+"\r"+$scope.selectedClient.name+"\r"+$scope.selectedClient.company_name+"\r"+$scope.selectedClient.adressFinnancial+"\r"+"CEP: "+$scope.selectedClient.zipCodeFinnancial+"\r"+$scope.selectedClient.city+"\r"+"Telefone: "+$scope.selectedClient.phone1+$scope.selectedClient.phone2+$scope.selectedClient.phone3+"\r"+"Email: "+$scope.selectedClient.finnancialEmail;};function compareClient(value){return value.name==$scope.filter.client;}$scope.updateClientInfo=function(){var filtered=$scope.clients.filter(compareClient);if(filtered.length<0)return;$scope.selectedClient.code=filtered[0].registrationCode;$scope.selectedClient.name=filtered[0].name+" ("+filtered[0].company_name+") ";$scope.selectedClient.adress=filtered[0].adressFinnancial+" "+filtered[0].adressNumberFinnancial+" "+filtered[0].adressComplementFinnancial+" "+filtered[0].adressDistrictFinnancial+" "+filtered[0].zipCodeFinnancial;$scope.selectedClient.city=filtered[0].cityFinnancialName+filtered[0].cityFinnancialState;$scope.selectedClient.phone1=filtered[0].phoneNumber;$scope.selectedClient.phone2=filtered[0].phoneNumber2;$scope.selectedClient.phone3=filtered[0].phoneNumber3;$scope.selectedClient.email=filtered[0].finnancialEmail;$scope.selectedClient.zip=filtered[0].zipCodeFinnancial;$scope.selectedClient.company_name=filtered[0].company_name;};$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBillsReceive=$scope.billsreceive.slice(start,end);};$scope.selectSale=function(pageSale){var end,start;start=(pageSale-1)*$scope.numPerPageSale;end=start+$scope.numPerPageSale;return $scope.currentPageSales=$scope.sales.slice(start,end);};$scope.onFilterChangeSale=function(){$scope.selectSale(1);$scope.currentPageSale=1;return $scope.rowSale='';};$scope.onNumPerPageChangeSale=function(){$scope.loadOrders();};$scope.onOrderChangeSale=function(){$scope.selectSale(1);return $scope.currentPageSale=1;};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.toWebService=function(){$scope.tabindex=1;$scope.webservice.ListRps=$scope.billsreceive;$scope.fillWebServiceValues();};$scope.statusText=function(status){var statusFormat=status=='E'?"Emitido":"Baixada";return statusFormat;};$scope.search=function(){$scope.loadBilletsReceive();$scope.loadOrders();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.billsreceive=$filter('orderBy')($scope.billsreceive,rowName);return $scope.onOrderChange();};$scope.orderSale=function(rowName){if($scope.rowSale===rowName){return;}$scope.rowSale=rowName;$scope.sales=$filter('orderBy')($scope.sales,rowName);return $scope.onOrderChangeSale();};$scope.loadClients=function(){$.post("../backend/application/index.php?rota=/loadClient",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;});};$scope.loadBilletsReceive=function(){var dateFrom=angular.copy($scope.filter.dateFrom);var dateTo=angular.copy(dateFrom);dateTo.setMonth(dateTo.getMonth()+1);dateTo.setDate(0);$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session.hashId,client:$scope.filter.client,_dueDateFrom:$rootScope.formatServerDate(dateFrom),_dueDateTo:$rootScope.formatServerDate(dateTo),refund:$scope.refund},function(result){$scope.billsreceive=JSON.parse(result).dataset.billetreceive;$scope.webservice.ListRps=$scope.billsreceive;if($scope.tabindex==1){$scope.fillWebServiceValues();}cfpLoadingBar.complete();$scope.getTotal();return $scope.onFilterChange();});};$scope.loadOrders=function(){var dateFromSales=angular.copy($scope.filter.dateFrom);var dateToSales=angular.copy(dateFromSales);dateToSales.setMonth(dateToSales.getMonth()+1);dateToSales.setDate(0);$scope.filter.saleDateFrom=dateFromSales;$scope.filter.saleDateTo=dateToSales;$scope.filter._saleDateFrom=$rootScope.formatServerDate($scope.filter.saleDateFrom);$scope.filter._saleDateTo=$rootScope.formatServerDate($scope.filter.saleDateTo);$scope.sumAmountPaid=0;$scope.sumTotalCost=0;$scope.sumProfit=0;$.post("../backend/application/index.php?rota=/loadSalesToOperations",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.sales=jQuery.parseJSON(result).dataset.sales;for(var i in $scope.sales){$scope.sales[i].dateT=new Date(angular.copy($scope.sales[i].issueDate));$scope.sumAmountPaid=$scope.sumAmountPaid+$scope.sales[i].amountPaid;$scope.sumTotalCost=$scope.sumTotalCost+$scope.sales[i].totalCost;}$scope.profit=$scope.sumAmountPaid-$scope.sumTotalCost;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.tabindex=0;$scope.currentPageSale=1;$scope.selectSale(1);$scope.$digest();});};$scope.load=function(){var dateFrom=angular.copy($scope.filter.dateFrom);var dateTo=angular.copy(dateFrom);dateTo.setMonth(dateTo.getMonth()+1);dateTo.setDate(0);$.post("../backend/application/index.php?rota=/loadBilletsReceive",{hashId:$scope.session.hashId,client:$scope.filter.client,_dueDateFrom:$rootScope.formatServerDate(dateFrom),_dueDateTo:$rootScope.formatServerDate(dateTo),refund:$scope.refund},function(result){$scope.billsreceive=JSON.parse(result).dataset.billetreceive;$scope.webservice.ListRps=$scope.billsreceive;if($scope.tabindex==1){$scope.fillWebServiceValues();}cfpLoadingBar.complete();$scope.getTotal();return $scope.onFilterChange();});};$scope.saveSelected=function(){$.post("../backend/application/index.php?rota=/checkBillsReceiveStatus",{hashId:$scope.session.hashId,data:$scope.billsreceive},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.toManual=function(){$scope.tabindex=0;};$scope.generateNFSe=function(){$.post("../backend/application/index.php?rota=/saveNFSe",{data:$scope.webservice},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.fillWebServiceValues=function(){for(var i in $scope.webservice.ListRps){var InfRps={IdentificacaoFromNames:{Numero:'1',Serie:'ABCDE',Tipo:'1'},NaturezaOperacao:'1',RegimeEspecialTributacao:'6',OptanteSimplesNacional:'1',IncentivadorCultural:'1',Status:'1'};$scope.webservice.ListRps[i].InfRps=InfRps;var Valores={ValorServicos:$scope.webservice.ListRps[i].original_value,ValorDeducoes:$scope.webservice.ListRps[i].original_value/100*5,ValorPis:0,ValorCofins:0,ValorInss:0,ValorIr:0,ValorCsll:0,IssRetido:1,ValorIss:0,OutrasRetencoes:0,Aliquota:0,DescontoIncondicionado:0,DescontoCondicionado:0};$scope.webservice.ListRps[i].Valores=Valores;var Servico={ItemListaServico:0,CodigoTributacaoMunicipio:0,Discriminacao:0,CodigoMunicipio:0};$scope.webservice.ListRps[i].Servico=Servico;var Prestador={Cnpj:'99999999000191',InscricaoMunicipal:'1733160024'};$scope.webservice.ListRps[i].Prestador=Prestador;var Tomador={RazaoSocial:'INSCRICAO DE TESTE SIATU - DAGUA -PAULINOS',IdentificacaoTomador:{Cnpj:'99999999000191',InscricaoMunicipal:'DAGUA'},Endereco:{rua:'DA BAHIA',numero:'200',complemento:'ANDAR 14',bairro:'CENTRO',CodigoMunicipio:'3106200',estado:'MG',cep:'30160010'}};$scope.webservice.ListRps[i].Tomador=Tomador;var IntermediarioServico={CpfCnpj:'99999999000191',RazaoSocial:'INSCRICAO DE TESTE SIATU - DAGUA -PAULINOS',InscricaoMunicipal:'8041700010'};$scope.webservice.ListRps[i].IntermediarioServico=IntermediarioServico;var ConstrucaoCivil={CodigoObra:'1234',Art:'1234'};$scope.webservice.ListRps[i].ConstrucaoCivil=ConstrucaoCivil;}};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.numPerPageOptSale=[10,30,50,100];$scope.numPerPageSale=$scope.numPerPageOptSale[0];$scope.currentPage=1;$scope.currentPageSale=1;$scope.currentPageBillsReceive=[];$scope.sales=[];$rootScope.hashId=$scope.session.hashId;init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.showme=false;$scope.refund=true;$scope.webservice={};$scope.webservice.NumeroLote=1;$scope.webservice.Cnpj=99999999000191;$scope.webservice.InscricaoMunicipal=1733160024;$scope.webservice.ListRps=[];$scope.loadClients();};return init();}]).directive('copyToClipboard',['$window',function($window){var body=angular.element($window.document.body);var textarea=angular.element('<textarea/>');textarea.css({position:'fixed',opacity:'0'});function copy(toCopy){textarea.val(toCopy);body.append(textarea);textarea[0].select();try{var successful=document.execCommand('copy');if(!successful)throw successful;}catch(err){void 0;}textarea.remove();}return{restrict:'A',link:function link(scope,element,attrs,$window){element.bind('click',function(e){copy(attrs.copyToClipboard);});}};}]);})();;(function(){'use strict';angular.module('app.miles').controller('MilesBenchCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filteredMilesBenchs=[];$scope.row='';$scope.rowSale='';$scope.select=function(page){$scope.loadMiles();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.loadMiles();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onNumPerPageChangeSale=function(numPSale){$scope.numPerPageSale=numPSale;$scope.loadSelected();};$scope.saveChanges=function(){if($scope.selected.datePriority!==""&&$scope.selected.datePriority!='Invalid Date'){$scope.selected._datePriority=$rootScope.formatServerDate($scope.selected.datePriority);}if($scope.selected.airline=='LATAM'){if($scope.selected.onlyInter==null||$scope.selected.onlyInter=='null'){return logger.logError('Tipo de emissão obrigatorio!');}}$.post("../backend/application/index.php?rota=/saveMilesChanges",{hashId:$scope.session.hashId,data:$scope.selected,purchases:$scope.purchaseHistory},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$scope.loadMiles();});};$scope.selectPageSale=function(currentPage){$scope.currentPageSale=currentPage;$scope.loadSelected();};$scope.setPriority=function(){$.post("../backend/application/index.php?rota=/saveCardStatusMiles",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.setSelected=function(){$scope.paxPerCards=[];$('#left_over').number(true,0,',','.');$('#leftOver').number(true,0,',','.');$('#milesPriority').number(true,0,',','.');$scope.selected=this.miles;if($scope.selected._datePriority){$scope.selected.datePriority=new Date($scope.selected._datePriority);}$.post("../backend/application/index.php?rota=/loadSaleHistory",{page:$scope.currentPageSale,numPerPage:$scope.numPerPageSale,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.selected},function(result){$scope.saleHistory=jQuery.parseJSON(result).dataset.sales;$scope.totalDataSale=jQuery.parseJSON(result).dataset.total;$scope.calculateHystoryTotalPrice();$.post("../backend/application/index.php?rota=/loadPurchaseHistory",{data:$scope.selected},function(result){$scope.purchaseHistory=jQuery.parseJSON(result).dataset;$scope.tabIndex=1;$scope.$apply();});$scope.$digest();});$.post("../backend/application/index.php?rota=/loadMilesbenchLog",{data:$scope.selected},function(result){$scope.dataBaseHistoric=jQuery.parseJSON(result).dataset;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadSaleRefunds",{data:$scope.selected},function(result){$scope.saleRefunds=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/cards/loadPaxPerCard",{data:$scope.selected},function(result){$scope.paxPerCards=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.calculateHystoryTotalPrice=function(){for(var i=0;i<$scope.saleHistory.length;i++){$scope.saleHistory[i].total_coast_calculated=0;if($scope.saleHistory[i].miles_used!='---'){for(var j=0;j<$scope.saleHistory[i].sale_purchases.length;j++){var milhas=parseFloat($scope.saleHistory[i].sale_purchases[j].miles_used);var preco=parseFloat($scope.saleHistory[i].sale_purchases[j].cost_per_thousand);$scope.saleHistory[i].total_coast_calculated+=milhas/1000*preco;}}}};$scope.loadSelected=function(){void 0;$.post("../backend/application/index.php?rota=/loadSaleHistory",{page:$scope.currentPageSale,numPerPage:$scope.numPerPageSale,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.selected},function(result){$scope.saleHistory=jQuery.parseJSON(result).dataset.sales;$scope.totalDataSale=jQuery.parseJSON(result).dataset.total;$scope.calculateHystoryTotalPrice();$scope.$apply();});};$scope.change=function(data){var d=new Date(data);return $scope.test=("0"+d.getDate()).substr(-2,2)+"-"+("0"+(d.getMonth()+1)).substr(-2,2)+"-"+d.getFullYear();};$scope.reportPurchaseCsv=function(){var data=[['Companhia','Data da Compra','Descricao','Tipo Cartao','Custo em (R$) por 100','Vencimento','Custo Total (R$)','Milhas','Adicionado no banco de milhas','Restante']];$.post("../backend/application/index.php?rota=/loadPurchaseHistory",{data:$scope.selected},function(result){$scope.purchaseH=jQuery.parseJSON(result).dataset;for(var i in $scope.purchaseH){data.push([$scope.purchaseH[i].airline,$filter('date')(new Date($scope.purchaseH[i].purchase_date),'dd/MM/yyyy HH:mm:ss'),$scope.purchaseH[i].description,$scope.purchaseH[i].card_type,$scope.purchaseH[i].cost_per_thousand,$filter('date')($scope.findDate($scope.purchaseH[i].miles_due_date),'dd/MM/yyyy HH:mm:ss'),$scope.purchaseH[i].total_cost,$scope.purchaseH[i].purchase_miles,$scope.purchaseH[i].realPurchased]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","historico_compra.csv");document.body.appendChild(link);link.click();$scope.$apply();});};$scope.reportSaleCsv=function(){var data=[['Data de Venda','Status','Passageiro','Voo','Localizador','Data de Embarque','Data de Desembarque','De','Para','Milhas Usadas','Reembolso','Retorno Pontos','e-ticket']];$.post("../backend/application/index.php?rota=/loadSaleHistory",{data:$scope.selected},function(result){$scope.saleHist=jQuery.parseJSON(result).dataset.sales;$.post("../backend/application/index.php?rota=/loadSaleRefunds",{data:$scope.selected},function(result){$scope.refundSales=jQuery.parseJSON(result).dataset;for(var i in $scope.saleHist){if($scope.saleHist[i].refundDate!=''||$scope.saleHist[i].returnDate!=''){data.push([$filter('date')($scope.findDate($scope.saleHist[i].issue_date),'dd/MM/yyyy HH:mm:ss'),$scope.saleHist[i].status,$scope.saleHist[i].pax_name,$scope.saleHist[i].flight,$scope.saleHist[i].flight_locator,$filter('date')(new Date($scope.saleHist[i].boardingDate),'dd/MM/yyyy HH:mm:ss'),$filter('date')(new Date($scope.saleHist[i].landingDate),'dd/MM/yyyy HH:mm:ss'),$scope.saleHist[i].from,$scope.saleHist[i].to,$rootScope.formatNumber($scope.saleHist[i].miles_used,0),$filter('date')(new Date($scope.saleHist[i].refundDate),'dd/MM/yyyy HH:mm:ss'),$filter('date')(new Date($scope.saleHist[i].returnDate),'dd/MM/yyyy HH:mm:ss'),$scope.saleHist[i].ticket_code]);}else{data.push([$filter('date')($scope.findDate($scope.saleHist[i].issue_date),'dd/MM/yyyy HH:mm:ss'),$scope.saleHist[i].status,$scope.saleHist[i].pax_name,$scope.saleHist[i].flight,$scope.saleHist[i].flight_locator,$filter('date')(new Date($scope.saleHist[i].boardingDate),'dd/MM/yyyy HH:mm:ss'),$filter('date')(new Date($scope.saleHist[i].landingDate),'dd/MM/yyyy HH:mm:ss'),$scope.saleHist[i].from,$scope.saleHist[i].to,$rootScope.formatNumber($scope.saleHist[i].miles_used,0),'','',$scope.saleHist[i].ticket_code]);}}for(var i in $scope.refundSales){if($scope.refundSales[i].refundDate!=''||$scope.refundSales[i].returnDate!=''){data.push([$scope.refundSales[i].issue_date,$scope.refundSales[i].status,$scope.refundSales[i].pax_name,$scope.refundSales[i].flight,$scope.refundSales[i].flight_locator,$scope.refundSales[i].boardingDate,$scope.refundSales[i].landingDate,$scope.refundSales[i].from,$scope.refundSales[i].to,$rootScope.formatNumber($scope.refundSales[i].miles_used,0),$scope.refundSales[i].refundDate,$scope.refundSales[i].returnDate,$scope.refundSales[i].ticket_code]);}else{data.push([$scope.refundSales[i].issue_date,$scope.refundSales[i].status,$scope.refundSales[i].pax_name,$scope.refundSales[i].flight,$scope.refundSales[i].flight_locator,$scope.refundSales[i].boardingDate,$scope.refundSales[i].landingDate,$scope.refundSales[i].from,$scope.refundSales[i].to,$rootScope.formatNumber($scope.refundSales[i].miles_used,0),'','',$scope.refundSales[i].ticket_code]);}}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","historico_vendas.csv");document.body.appendChild(link);link.click();$scope.$apply();});});};$scope.back=function(){$scope.selected=undefined;$scope.tabIndex=0;$scope.loadMiles();};$scope.findDate=function(date){if(new Date(date)!='Invalid Date'){return new Date(date);}else{return'';}};$scope.printHistory=function(){var doc=new jsPDF('l','pt');doc.margin=0.2;doc.setFontSize(10);doc.text(60,20,'Extrato do Cartão: - '+$scope.selected.card_number+' de '+$scope.selected.name);doc.text(60,35,'Compras');var columns=[];columns=[{title:"Companhia",dataKey:"airline"},{title:"Data Compra",dataKey:"purchase_date"},{title:"Descrição",dataKey:"description"},{title:"Tipo Cartão",dataKey:"card_type"},{title:"Custo p/ 1000",dataKey:"cost_per_thousand"},{title:"Vencimento",dataKey:"due_date"},{title:"Custo total",dataKey:"total_cost"},{title:"Milhas",dataKey:"miles"}];var rows=[];for(var i=0;i<$scope.purchaseHistory.length;i++){rows.push({airline:$scope.purchaseHistory[i].airline,purchase_date:$filter('date')($scope.findDate($scope.purchaseHistory[i].purchase_date),'dd/MM/yyyy HH:mm:ss'),description:$scope.purchaseHistory[i].description,card_type:$scope.purchaseHistory[i].card_type,cost_per_thousand:$scope.purchaseHistory[i].cost_per_thousand,due_date:$filter('date')($scope.findDate($scope.purchaseHistory[i].miles_due_date),'dd/MM/yyyy HH:mm:ss'),total_cost:$rootScope.formatNumber($scope.purchaseHistory[i].total_cost),miles:$rootScope.formatNumber($scope.purchaseHistory[i].purchase_miles,0)});}var columns2=[];columns2=[{title:"Data da Venda",dataKey:"issue_date"},{title:"Status",dataKey:"status"},{title:"Passageiro",dataKey:"pax_name"},{title:"Voo",dataKey:"flight"},{title:"Data Embarque",dataKey:"boardingDate"},{title:"Data Desembarque",dataKey:"landingDate"},{title:"De",dataKey:"from"},{title:"Para",dataKey:"to"},{title:"Milhas",dataKey:"miles_used"}];var rows2=[];if($scope.saleHistory!=null){for(var i=0;i<$scope.saleHistory.length;i++){rows2.push({issue_date:$filter('date')($scope.findDate($scope.saleHistory[i].issue_date),'dd/MM/yyyy HH:mm:ss'),status:$scope.saleHistory[i].status,pax_name:$scope.saleHistory[i].pax_name,flight:$scope.saleHistory[i].flight,boardingDate:$filter('date')($scope.findDate($scope.saleHistory[i].boardingDate),'dd/MM/yyyy HH:mm:ss'),landingDate:$filter('date')($scope.findDate($scope.saleHistory[i].landingDate),'dd/MM/yyyy HH:mm:ss'),from:$scope.saleHistory[i].from,to:$scope.saleHistory[i].to,miles_used:$rootScope.formatNumber($scope.saleHistory[i].miles_used,0)});}}doc.autoTable(columns,rows,{margin:{horizontal:10},styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='total_cost'||data.column.dataKey==='miles'||data.column.dataKey==='cost_per_thousand'){cell.styles.halign='right';}}});doc.text(60,doc.autoTableEndPosY()+20,'Vendas');doc.autoTable(columns2,rows2,{startY:doc.autoTableEndPosY()+30,margin:{horizontal:10},styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='miles_used'){cell.styles.halign='right';}}});doc.save('historico_cartao.pdf');};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open('GET',url);xhr.send();};$scope.printHistoryToProvider=function(){var doc=new jsPDF('l','pt');doc.margin=0.2;doc.setFontSize(10);doc.text(350,50,'Extrato do fornecedor: '+$scope.selected.name);$scope.toDataUrl('images/bank.jpg',function(imgData){doc.addImage(imgData,'JPEG',30,15,230,50);doc.text(60,80,'Compras');var columns=[];columns=[{title:"Companhia",dataKey:"airline"},{title:"Data Compra",dataKey:"purchase_date"},{title:"Custo p/ 1000",dataKey:"cost_per_thousand"},{title:"Vencimento",dataKey:"due_date"},{title:"Custo total",dataKey:"total_cost"},{title:"Milhas",dataKey:"miles"}];var rows=[];for(var i=0;i<$scope.purchaseHistory.length;i++){rows.push({airline:$scope.purchaseHistory[i].airline,purchase_date:$filter('date')($scope.findDate($scope.purchaseHistory[i].purchase_date),'dd/MM/yyyy HH:mm:ss'),cost_per_thousand:$scope.purchaseHistory[i].cost_per_thousand,due_date:$filter('date')($scope.findDate($scope.purchaseHistory[i].miles_due_date),'dd/MM/yyyy HH:mm:ss'),total_cost:$rootScope.formatNumber($scope.purchaseHistory[i].total_cost),miles:$rootScope.formatNumber($scope.purchaseHistory[i].purchase_miles,0)});}var columns2=[];columns2=[{title:"Data da Venda",dataKey:"issue_date"},{title:"Status",dataKey:"status"},{title:"Passageiro",dataKey:"pax_name"},{title:"Voo",dataKey:"flight"},{title:"Data Embarque",dataKey:"boardingDate"},{title:"Data Desembarque",dataKey:"landingDate"},{title:"De",dataKey:"from"},{title:"Para",dataKey:"to"},{title:"Milhas",dataKey:"miles_used"}];var rows2=[];if($scope.saleHistory!=null){for(var i=0;i<$scope.saleHistory.length;i++){rows2.push({issue_date:$filter('date')($scope.findDate($scope.saleHistory[i].issue_date),'dd/MM/yyyy HH:mm:ss'),status:$scope.saleHistory[i].status,pax_name:$scope.saleHistory[i].pax_name,flight:$scope.saleHistory[i].flight,boardingDate:$filter('date')($scope.findDate($scope.saleHistory[i].boardingDate),'dd/MM/yyyy HH:mm:ss'),landingDate:$filter('date')($scope.findDate($scope.saleHistory[i].landingDate),'dd/MM/yyyy HH:mm:ss'),from:$scope.saleHistory[i].from,to:$scope.saleHistory[i].to,miles_used:$rootScope.formatNumber($scope.saleHistory[i].miles_used,0)});}}doc.autoTable(columns,rows,{margin:{horizontal:10},startY:90,styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='total_cost'||data.column.dataKey==='miles'||data.column.dataKey==='cost_per_thousand'){cell.styles.halign='right';}}});doc.text(60,doc.autoTableEndPosY()+20,'Vendas');doc.autoTable(columns2,rows2,{startY:doc.autoTableEndPosY()+30,margin:{horizontal:10},styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='miles_used'){cell.styles.halign='right';}}});doc.save($scope.selected.name.split(' ')[0]+'_'+$scope.selected.airline+'.pdf');});};$scope.print=function(){$.post("../backend/application/index.php?rota=/loadMilesbenchReportData",{searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.reportData=jQuery.parseJSON(result).dataset;var doc=new jsPDF('l','pt');doc.margin=0.5;doc.setFontSize(22);doc.text(350,30,'Estoque de Milhas');var columns=[{title:"Fornecedor",dataKey:"name"},{title:"Email",dataKey:"email"},{title:"Telefone",dataKey:"phoneNumber"},{title:"Cia",dataKey:"airline"},{title:"Tipo Cartão",dataKey:"card_type"},{title:"Cartao",dataKey:"card_number"},{title:"Saldo",dataKey:"leftover"},{title:"Vencimento",dataKey:"due_date"},{title:"Limite",dataKey:"contract_due_date"},{title:"Status",dataKey:"status"}];var rows=[];var type;var status;for(var i=0;i<$scope.reportData.length;i++){if($scope.reportData[i].card_type===null)type="";else type=$scope.reportData[i].card_type;if($scope.reportData[i].status=='N')status='Liberado';else status='Bloqueado';rows.push({name:$scope.reportData[i].name,email:$scope.reportData[i].email,phoneNumber:$scope.reportData[i].phoneNumber,airline:$scope.reportData[i].airline,card_type:type,card_number:$scope.reportData[i].card_number,leftover:$rootScope.formatNumber($scope.reportData[i].leftover,0),due_date:$filter('date')($scope.reportData[i].due_date,'dd/MM/yyyy'),contract_due_date:$filter('date')($scope.reportData[i].contract_due_date,'dd/MM/yyyy'),status:status});}doc.autoTable(columns,rows,{styles:{fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='leftover'){cell.styles.halign='right';}if(data.column.dataKey==='cost_per_thousand'){cell.styles.halign='right';}}});doc.save('estoque_de_milhas.pdf');});};$scope.orderMiles=function(mile){switch(mile.priority){case'-1':return"label label-success";case'0':return"label label-danger";case'1':return"label label-warning";default:return"";}};$scope.search=function(){$scope.loadMiles();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadMiles();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadMiles();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.numPerPageOptSale=[10,25,50,100,2000,5000,10000];$scope.numPerPageSale=$scope.numPerPageOptSale[2];$scope.currentPageSale=1;$scope.numPerPageOpt=[10,30,50,100,2000,5000,10000];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageMilesBench=[];$scope.loadMiles=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadMiles",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.milebench=jQuery.parseJSON(result).dataset.milebench;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.totalFiltered=jQuery.parseJSON(result).dataset.totalFiltered;$scope.totalMilesRB=jQuery.parseJSON(result).dataset.totalMilesRB;$scope.$digest();void 0;cfpLoadingBar.complete();});};$scope.open=function(){$.post("../backend/application/index.php?rota=/loadAirline",{},function(result){$scope.airlines=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"MilesBenchModalCtrl.html",controller:'MilesBenchDataInstanceCtrl',resolve:{airlines:function airlines(){return $scope.airlines;},filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){$scope.filter=filter;$scope.loadMiles();});});};$scope.openPassengersList=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_names_list.html",controller:'ModalNamesLIstCtrl',resolve:{selected:function selected(){return $scope.selected;},paxPerCards:function paxPerCards(){return $scope.paxPerCards;}}});};$scope.saveCardStatus=function(card){$.post("../backend/application/index.php?rota=/saveCardProgressMilesBench",{data:card},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.openCardModalCtrl=function(){$scope.card=$scope.selected;var modalInstance;modalInstance=$modal.open({templateUrl:"MilesbenchCardModalCtrl.html",controller:'MilesbenchCardInstanceCtrl',resolve:{card:function card(){return $scope.card;}}});modalInstance.result.then(function(card){$scope.saveCardStatus(card);});};init=function init(){$scope.tabIndex=0;$scope.totalFiltered=0;$scope.filter={airline:'',miles:900,includeZero:false};$scope.checkValidRoute();$scope.loadMiles();};return init();}]).controller('MilesBenchDataInstanceCtrl',['$scope','$rootScope','$modalInstance','airlines','filter',function($scope,$rootScope,$modalInstance,airlines,filter){$scope.airlines=airlines;$scope.providers=[];$scope.loadProvider=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$scope.filter=filter;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close($scope.filter);};}]).controller('MilesbenchCardInstanceCtrl',['$scope','$rootScope','$modalInstance','card',function($scope,$rootScope,$modalInstance,card){$scope.card=card;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close($scope.card);};}]).controller('ModalNamesLIstCtrl',['$scope','$rootScope','$modalInstance','selected','paxPerCards',function($scope,$rootScope,$modalInstance,selected,paxPerCards){$scope.selected=selected;$scope.array=paxPerCards;void 0;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.table').controller('MilesConferenceCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filteredMilesConference=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageMilesConference=$scope.filteredMilesConference.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.orderMiles=function(mile){switch(mile.priority){case'-1':return"label label-success";case'0':return"label label-danger";case'1':return"label label-warning";default:return"";}};$scope.search=function(){$scope.filteredMilesConference=$filter('filter')($scope.milesConference,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredMilesConference=$filter('orderBy')($scope.milesConference,rowName);return $scope.onOrderChange();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageMilesConference=[];$scope.loadMilesConference=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadMilesConference",{filter:$scope.filter},function(result){$scope.milesConference=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.checkMiles=function(milebench){$.post("../backend/application/index.php?rota=/saveMilesCheck",{data:milebench,filter:$scope.filter},function(result){logger.logSuccess('Salvo com sucesso');$scope.loadMilesConference();});};$scope.findDate=function(date){return new Date(date);};$scope.setSelected=function(){$scope.selected=angular.copy(this.milebench);$rootScope.$emit('openMilesConferenceModal',$scope.selected);};init=function init(){$scope.checkValidRoute();$scope.loadMilesConference();$scope.tabIndex=0;$scope.selected={cards_id:0};$rootScope.modalOpen=false;};$scope.openSearchModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"MilesConferenceModalCtrl.html",controller:'MilesConferenceInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._dateFrom=$rootScope.formatServerDate(filter.dateFrom);filter._dateTo=$rootScope.formatServerDate(filter.dateTo);}$scope.filter=filter;$scope.loadMilesConference();},function(){$console.log("Modal dismissed at: "+new Date());});};return init();}]).controller('ShowCardMilesConferenceCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$rootScope.modalOpen=false;$rootScope.$on('openMilesConferenceModal',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){$scope.selected=args;$scope.selected.cardNumber='000000';var modalInstance;$.post("../backend/application/index.php?rota=/loadCardsData",{hashId:$scope.session.hashId,sale:$scope.selected},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.cards.recovery_password=$scope.decript($scope.cards.recovery_password);$scope.cards.access_password=$scope.decript($scope.cards.access_password);modalInstance=$modal.open({templateUrl:"ShowCardMilesConference.html",controller:'ShowCardMilesConferenceInstanceCtrl',resolve:{cards:function cards(){return $scope.cards;},selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(resolve){$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});});};}]).controller('ShowCardMilesConferenceInstanceCtrl',['$scope','$rootScope','$modalInstance','cards','selected',function($scope,$rootScope,$modalInstance,cards,selected){$scope.cards=cards;$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('MilesConferenceInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.modal').controller('ModalCardDataCtrl',['$scope','$rootScope','$modalInstance','logger','cards',function($scope,$rootScope,$modalInstance,logger,cards){$.post("../backend/application/index.php?rota=/loadCardsData",{sale:cards},function(result){$scope.cards=jQuery.parseJSON(result).dataset;if($scope.cards.recovery_password){$scope.cards.recovery_password=$scope.decript($scope.cards.recovery_password);}if($scope.cards.access_password){$scope.cards.access_password=$scope.decript($scope.cards.access_password);}$scope.$digest();});$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};}]);})();;(function(){'use strict';angular.module('app.modal').controller('ModalChangePasswordCtrl',['$scope','$rootScope','$modalInstance','logger',function($scope,$rootScope,$modalInstance,logger){$scope.changePassword={};$scope.specialChars=['!','@','#','$','%','¨','&','*','.',':','^','~','?'];$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){if(!$scope.changePassword.password1){return logger.logError('Senha deve ser preenchida!');}if(!$scope.changePassword.password2){return logger.logError('Senha deve ser preenchida!');}if($scope.changePassword.password1!==$scope.changePassword.password2){return logger.logError('Senha não conferem!');}if($scope.changePassword.password1.length>6){for(var i in $scope.changePassword.password1){if(!isNaN($scope.changePassword.password1[i])){$scope.checkNumber=true;}if(isNaN($scope.changePassword.password1[i])){$scope.checkString=true;}if($scope.specialChars.indexOf($scope.changePassword.password1[i])!=-1){$scope.checkscpecialChat=true;}}if(!$scope.checkNumber){return logger.logError('A senha deve conter numberos!');}if(!$scope.checkString){return logger.logError('A senha deve conter letras!');}if(!$scope.checkscpecialChat){return logger.logError('A senha deve conter caracteres especiais!');}if(!$scope.checkNumber||!$scope.checkString||!$scope.checkscpecialChat){return logger.logError('Verifique requisitos');}}else{return logger.logError('Senha muito curta, ela deve conter pelo menos 7 caracteres!');}$.post("../backend/application/index.php?rota=/changePassword",{data:$scope.changePassword},function(result){if(JSON.parse(result).message.type=='E'){logger.logError(JSON.parse(result).message.text);}else{$scope.cancel();}});};}]);})();;(function(){'use strict';angular.module('app.modal').controller('ModalConfirmationCtrl',['$scope','$rootScope','$modalInstance','logger','header',function($scope,$rootScope,$modalInstance,logger,header){$scope.header=header;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close(true);};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('ModalJustificationCtrl',['$scope','$rootScope','$modalInstance','logger','header',function($scope,$rootScope,$modalInstance,logger,header){$scope.header=header;$scope.description='';$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){if(!$scope.description){return logger.logError("Descrição é obrigatoria!");}if($scope.description==''){return logger.logError("Descrição é obrigatoria!");}$modalInstance.close($scope.description);};}]);})();;(function(){'use strict';angular.module('app.marketing').controller('ModalPromoCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger','FileUploader',function($scope,$rootScope,$filter,cfpLoadingBar,logger,FileUploader){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredPromos=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePromos=$scope.filteredPromos.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredPromos=$filter('filter')($scope.promos,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.promo;$scope.selected._startDate=new Date($scope.selected.startDate);$scope.selected._endDate=new Date($scope.selected.endDate);$scope.tabindex=1;};$scope.newPromo=function(){$scope.selected={};$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredPromos=$filter('orderBy')($scope.promos,rowName);return $scope.onOrderChange();};$scope.saveModalPromo=function(){cfpLoadingBar.start();$scope.selected.startDate=$rootScope.formatServerDateTime($scope.selected._startDate);$scope.selected.endDate=$rootScope.formatServerDateTime($scope.selected._endDate);var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}$.post("../backend/application/index.php?rota=/marketing/saveModalPromo",{data:$scope.selected,file:file},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadModalData();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.selectMiles=function(page){var end,start;start=(page-1)*$scope.numPerPageMiles;end=start+$scope.numPerPageMiles;return $scope.currentMiles=$scope.filteredflight_miles.slice(start,end);};$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.cancelEdit=function(){$scope.loadModalData();$scope.tabindex=0;};$scope.loadModalData=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/loadModalPromo",{},function(result){$scope.promos=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePromos=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadModalData();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});};return init();}]);})();;(function(){'use strict';angular.module('app.purchase').controller('NotificationClientListCtrl',['$scope','$rootScope','$modalInstance','data','header',function($scope,$rootScope,$modalInstance,data,header){function UniqueArraybyId(collection,keyname){var output=[],keys=[];angular.forEach(collection,function(item){var key=item[keyname];if(keys.indexOf(key)===-1){keys.push(key);output.push(item);}});return output;};$scope.header=header;$scope.data=UniqueArraybyId(data,"id");$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('NotificationRobotListCtrl',['$scope','$rootScope','$modalInstance','logs','header','order','onlineflights',function($scope,$rootScope,$modalInstance,logs,header,order,onlineflights){$scope.header=header;$scope.logs=logs;$scope.order=order;$scope.onlineflights=onlineflights;$scope.updateOrder=function(){$.post("../backend/application/index.php?rota=/incodde/updateOrderStatus",{order:$scope.order},function(result){$scope.checkOrderBot();});};$scope.checkOrderBot=function(){$.post("../backend/application/index.php?rota=/incodde/checkOrderBot",{order:$scope.order},function(result){$scope.logs=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.in8Bot=function(){$.post("../backend/application/index.php?rota=/incodde/newOrder",{order:$scope.order,onlineflights:$scope.onlineflights},function(result){var response=jQuery.parseJSON(result).dataset;$scope.checkOrderBot();});};$scope.cancelOrder=function(){$.post("../backend/application/index.php?rota=/incodde/cancelOrder",{order:$scope.order},function(result){var response=jQuery.parseJSON(result).dataset;$scope.checkOrderBot();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){"use strict";angular.module("app.table").controller("OnlineOrderCtrl",["$scope","$rootScope","$filter","$modal","cfpLoadingBar","logger","FileUploader",function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader){var init;var partnerSelected;$scope.searchKeywords="";$scope.searchKeywordsMiles="";$scope.filteredOnlineOrders=[];$scope.row="";$scope.previousIndex=0;$scope.currentPage=1;$scope.card=[];$scope.saleEmails=["tamvpg@gmail.com","loja.tv@hotmail.com","setorpt@gmail.com"];$scope.saleStatus=["RESERVA","PENDENTE","EMITIDO","EM ESPERA"];$scope.classOptions=["Economica","Executiva"];$scope.removeFromEmail=["JACK FOR","Loja TAM Ponta Grossa","Loja TAM Contagem","Loja TAM M","CONFIANÇA","Flytour","TAP","Rextur Advance","CNT Consolidadora","HAST Viagens","XML Viagens","Milhas Alpass","Alfa Rondonia Milhas","Outros"];$scope.blackListOfNames=["JUNIOR","NETO","FILHO","SOBRINHO"];$scope.card_previous_selected="";$scope.card_now_selected="";$rootScope.watchDogPID=0;$scope.watchDogSelected=true;$scope.select=function(page){$scope.loadOnlineOrder();};$scope.onFilterChange=function(){$scope.loadOnlineOrder();};$scope.onNumPerPageChange=function(){$scope.loadOnlineOrder();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$rootScope.$on("checkedPermission",function(event,args){$scope.setSelected(true);});$scope.setSelected=function(args){$scope.searchMilesOrder=undefined;$scope.searchMilesOrderDown=undefined;if($scope.main.dealer){return;}$scope.args=args;$scope.flight_selected=undefined;$scope.wsale={};$scope.robotLog=[];$scope.multiDownloads=false;$scope.wsalemail={};if(!args){$scope.selected=angular.copy(this.onlineorder);$rootScope.setOnlineOrder($scope.selected);}if(args===true){$scope.selected=$rootScope.onlineOrder;}$scope.uploader.clearQueue();$scope.uploader_billets.clearQueue();$scope.uploader.formData={hashId:$scope.session.hashId};$scope.uploader_billets.formData={hashId:$scope.session.hashId,order:$scope.selected};if($scope.main.commercial&&!$scope.main.isMaster){if(($scope.selected.status.indexOf("ESPERA")>-1||$scope.selected.status=="ANT"||$scope.selected.status=="BLOQ"||$scope.selected.status=="ANT BLOQ")&&!args){$rootScope.$emit("openPermission",{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId,type:"Comercial"});return;}else{return;}}if($scope.selected.status.indexOf("ESPERA")<0&&$scope.selected.status!="ANT"&&$scope.selected.status!="BLOQ"&&$scope.selected.status!="ANT BLOQ"||$scope.selected.commercialStatus||$scope.$parent.$parent.main.isMaster||args===true){if($scope.selected.status!="CANCELADO"&&$scope.selected.status!="FALHA EMISSAO"||$scope.$parent.$parent.main.isMaster||args===true){$scope.selected.issuing=$scope.selected.client_login;$scope.loadOnlineFlight(args);if($scope.selected.status=="CANCELADO"||$scope.selected.status=="FALHA EMISSAO"){logger.logWarning("Motivo cancelamento: "+$scope.selected.cancelReason);}}else{$rootScope.$emit("openPermission",{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});logger.logError("Este pedido foi cancelado!");}}else{$rootScope.$emit("openPermission",{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});logger.logError("Este pedido esta em Espera!");}};$scope.getFlightsAirlines=function(){if($scope.selected){if($scope.selected.airline!==""){return false;}}return true;};$rootScope.$on("fillEmailBLoqued",function(event,args){$scope.fillEmailBLoqued(args);});$scope.fillEmailBLoqued=function(args){if($scope.response){if($scope.response.origin=="MMS"){$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco=undefined;$scope.wsalemail.subject="[] - Pedido de emissão";var date=new Date();date.setUTCHours(date.getUTCHours()-2);if($scope.response){if($scope.response.subClientEmail){$scope.wsalemail.subClientEmail=$scope.response.subClientEmail;}if($scope.check48hours()){$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>";}else if($scope.response.status=="Bloqueado"){$scope.wsalemail.emailContent="Olá, <br><br>"+"Antes de seguirmos com a emissão, nosso setor financeiro solicita contato para as devidas atualizações.<br>"+"Horário de atendimento do setor financeiro: Segunda a Sexta de 09:00 as 18:00 ( horário de Brasília )  <br><br>"+"Email: financeiro@onemilhas.com.br <br>Telefones: (31) 3972-1929 <br><br>";$scope.wsalemail.mailcco='suporte@onemilhas.com.br';$scope.wsalemail.emailContent+="Atenciosamente.<br>";}else if($scope.response.status=="Pendente"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Cliente com status PENDENTE!"+"<br>"+$scope.response.client_name+"<br>"+"Atenciosamente.<br>";if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=21){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br';}else if(date.getDay()>0&&date.getDay()<6){$scope.wsalemail.mailcco='suporte@onemilhas.com.br';}else{$scope.wsalemail.emailpartner='suporte@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>21||date.getUTCHours()<=2)){$scope.wsalemail.mailcco='suporte@onemilhas.com.br';$scope.wsalemail.emailContent="Caro Parceiro.<br><br>"+"Agradecemos a confiança ao enviar a 1º emissão.Dentre as próximas horas iremos enviar nosso protocolo de ativação finalizando nosso cadastro.<br>"+"Para seguirmos com essa emissão gentileza entrar em contato com nosso setor comercial para alinharmos os últimos detalhes.<br><br>"+"(31) 3972-1929<br><br>"+"suporte@onemilhas.com.br<br><br>"+"Atenciosamente<br>Equipe";}}else if($scope.response.paymentType=="Antecipado"){$scope.wsalemail.mailcco='suporte@onemilhas.com.br';$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Para darmos andamento a sua solicitação, pedimos que nos encaminhe o comprovante de pagamento neste mesmo e-mail: suporte@onemilhas.com.br . Aguardamos o recebimento do comprovante e liberação do setor financeiro para seguirmos com o processo.<br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: (31) 3972-1929<br><br>";$scope.wsalemail.emailContent+="<table style='text-align: center; border-collapse: collapse;' border='1' width='95%' align='center'><tbody>"+"<tr bgcolor='#FFFFFF'><td>&nbsp;</td><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Caixa</strong></span></td><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Bradesco</strong></span></td>"+"<td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Ita&uacute;</strong></span></td><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Brasil</strong></span></td>"+"<td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Santander</strong></span></td></tr><tr><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Banco:</strong></span></td>"+"<td>104</td><td>237</td><td>341</td><td>001</td><td>033</td></tr><tr><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Ag&ecirc;ncia:</strong></span></td>"+"<td>2922</td><td>3420</td><td>1582</td><td>-</td><td>4232</td></tr><tr><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Conta:</strong></span></td>"+"<td>2643-6</td><td>29429-2</td><td>33678-8</td><td>-</td>"+"<td>13004689-8</td></tr><tr><td colspan='6'><strong>MMS VIAGENS LTDA</strong><br /><strong>CNPJ: 29.632.355/0001-85</strong></td></tr></tbody></table><br><br>";$scope.wsalemail.emailContent+="Atenciosamente.<br>";}else if($scope.response.partner_limit=="true"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Seu limite foi excedido, com isso pedimos que entre em contato com o setor financeiro para seguirmos com a emissão.<br><br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: 3972-1929<br><br>"+"Atenciosamente.<br>";if(date.getDay()==0||date.getDay()==6){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=23){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>23||date.getUTCHours()<=2)){$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco='suporte@onemilhas.com.br';}}}else{$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>";}$scope.uploader.clearQueue();$scope.uploader_billets.clearQueue();if($scope.response){if($scope.response.client_name){$scope.wsalemail.emailContent+="<br><br>Cliente: "+$scope.response.client_name;}}$scope.wsalemail.emailContent+="<br><br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(" ");var connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"HH:mm:ss")+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"HH:mm:ss")+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_code_from+"</td><td>"+$scope.resume_flights[i].airport_code_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter("date")($scope.resume_paxs[i].birhtdate,"dd/MM/yyyy")+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";if($scope.response){if($scope.response.status=="Bloqueado"||$scope.response.paymentType=="Antecipado"||$scope.response.partner_limit=="true"){$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles="";var pricing="";var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.resume_paxs){if($scope.resume_paxs[a].is_child=="S"){NumberOfChild++;}else if($scope.resume_paxs[a].is_newborn=="S"){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var miles="";var pricing="";var testes=$scope.resume_flights[b].connection.split(" ");connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult,0)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";pricing=pricing+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";}if(NumberOfChild>0){miles=miles+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child,0)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";pricing=pricing+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";}if(NumberOfNewborn>0){miles=miles+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn,0)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";pricing=pricing+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.total_cost)+"</font></td></tr>"+"</tbody></table>";}}else{$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles="";var pricing="";var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.onlineflights){if($scope.onlineflights[a].is_child=="S"){NumberOfChild++;}else if($scope.onlineflights[a].is_newborn=="S"){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var testes=$scope.resume_flights[b].connection.split(" ");connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";pricing=pricing+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";}if(NumberOfChild>0){miles=miles+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";pricing=pricing+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";}if(NumberOfNewborn>0){miles=miles+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";pricing=pricing+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.total_cost)+"</font></td></tr>"+"</tbody></table>";}}else{$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco=undefined;$scope.wsalemail.subject="Pedido de emissão";var date=new Date();date.setUTCHours(date.getUTCHours()-2);if($scope.response){if($scope.response.subClientEmail){$scope.wsalemail.subClientEmail=$scope.response.subClientEmail;}if($scope.check48hours()){$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.status=="Bloqueado"){$scope.wsalemail.emailContent="Olá, <br><br>"+"Antes de seguirmos com a emissão, nosso setor financeiro solicita contato para as devidas atualizações.<br>"+"Horário de atendimento do setor financeiro: Segunda a Sexta de 09:00 as 18:00 ( horário de Brasília )  <br><br>"+"Email: financeiro@onemilhas.com.br <br>Telefones: (31) 9 9766-6636 / 3972-9601 (opção 2)<br><br>";$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';if(date.getDay()==0||date.getDay()==6||date.getUTCHours()>=17||date.getUTCHours()<=2){$scope.wsalemail.emailContent+="Email: suporte@onemilhas.com.br ou financeiro@onemilhas.com.br <br>Telefone: (31) 9 9656-9292 <br><br>";}$scope.wsalemail.emailContent+="Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.status=="Antecipado/Bloqueado"){$scope.wsalemail.emailContent="Prezado parceiro, <br><br>"+"Para darmos andamento a sua solicitação, pedimos que nos encaminhe o comprovante de pagamento no valor da OP mais o mínimo de R$50,00, <br>"+"conforme acordo fechado com o financeiro.<br>"+"O comprovante deverá ser enviado neste mesmo e-mail: emissao@onemilhas.com.br . Aguardamos o recebimento do comprovante e liberação do setor financeiro para seguirmos com o processo.<br><br>";$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';if(date.getDay()==0||date.getDay()==6||date.getUTCHours()>=17||date.getUTCHours()<=2){$scope.wsalemail.emailContent+="Email: suporte@onemilhas.com.br ou financeiro@onemilhas.com.br <br>Telefone: (31) 9 9656-9292 <br><br>";}$scope.wsalemail.emailContent+="Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.status=="Pendente"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Cliente com status PENDENTE!"+"<br>"+$scope.response.client_name+"<br>"+"Atenciosamente.<br>Equipe One Milhas";if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=21){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}else if(date.getDay()>0&&date.getDay()<6){$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}else{$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>21||date.getUTCHours()<=2)){$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';$scope.wsalemail.emailContent="Caro Parceiro.<br><br>"+"Agradecemos a confiança ao enviar a 1º emissão.Dentre as próximas horas iremos enviar nosso protocolo de ativação finalizando nosso cadastro.<br>"+"Para seguirmos com essa emissão gentileza entrar em contato com nosso setor comercial para alinharmos os últimos detalhes.<br><br>"+"(31) 9 9467-1030<br><br>"+'suporte@onemilhas.com.br'+"<br><br>"+"Atenciosamente<br>Equipe Ideal";}}else if($scope.response.paymentType=="Antecipado"){$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Para darmos andamento a sua solicitação, pedimos que nos encaminhe o comprovante de pagamento neste mesmo e-mail: emissao@onemilhas.com.br . Aguardamos o recebimento do comprovante e liberação do setor financeiro para seguirmos com o processo.<br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: (31) 9 9766-6636 / 3972-9601(opção 2)<br><br>";$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody>"+"<tr bgcolor='#FFFFFF'><td></td><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Caixa</b></font></td><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Brasil</b></font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'><b>Caixa</b></font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'><b>Bradesco</b></font></td><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Itaú</b></font></td></tr>"+"<tr><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Banco:</b></font></td><td>C.E.F - 104</td><td>001</td><td>033</td><td>237</td><td>341</td></tr><tr>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'><b>Agência:</b></font></td><td>0087 - OP 003</td><td>4403-2</td><td>0944</td><td>2943</td><td>3101</td></tr>"+"<tr><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Conta:</b></font></td><td>3324-2</td><td>20123-5</td><td>13002164-6</td><td>0017241-3</td><td>43300-5</td></tr>"+"<tr><td colspan='6'><br><b>CML VIAGENS E TURISMO LTDA</b><br><b>CNPJ: 35.823.529-0001-90</b></td></tr></tbody></table><br><br>";$scope.wsalemail.emailContent+="Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.partner_limit=="true"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Seu limite foi excedido, com isso pedimos que entre em contato com o setor financeiro para seguirmos com a emissão.<br><br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: (31) 9 9766-6636 / 3972-9601(opção 2)<br><br>"+"Atenciosamente.<br>Equipe One Milhas";if(date.getDay()==0||date.getDay()==6){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=23){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>23||date.getUTCHours()<=2)){$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}}}else{$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>Equipe One Milhas";}$scope.uploader.clearQueue();if($scope.response){if($scope.response.client_name){$scope.wsalemail.emailContent+="<br><br>Cliente: "+$scope.response.client_name;}}$scope.wsalemail.emailContent+="<br><br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(" ");var connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"HH:mm:ss")+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"HH:mm:ss")+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_code_from+"</td><td>"+$scope.resume_flights[i].airport_code_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter("date")($scope.resume_paxs[i].birhtdate,"dd/MM/yyyy")+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";if($scope.response){if($scope.response.status=="Bloqueado"||$scope.response.paymentType=="Antecipado"||$scope.response.partner_limit=="true"){$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles="";var pricing="";var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.resume_paxs){if($scope.resume_paxs[a].is_child=="S"){NumberOfChild++;}else if($scope.resume_paxs[a].is_newborn=="S"){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var miles="";var pricing="";var testes=$scope.resume_flights[b].connection.split(" ");connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult,0)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";pricing=pricing+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";}if(NumberOfChild>0){miles=miles+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child,0)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";pricing=pricing+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";}if(NumberOfNewborn>0){miles=miles+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn,0)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";pricing=pricing+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.total_cost)+"</font></td></tr>"+"</tbody></table>";}}else{$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles="";var pricing="";var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.onlineflights){if($scope.onlineflights[a].is_child=="S"){NumberOfChild++;}else if($scope.onlineflights[a].is_newborn=="S"){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var testes=$scope.resume_flights[b].connection.split(" ");connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";pricing=pricing+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";}if(NumberOfChild>0){miles=miles+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";pricing=pricing+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";}if(NumberOfNewborn>0){miles=miles+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";pricing=pricing+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.total_cost)+"</font></td></tr>"+"</tbody></table>";}}}else{$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco=undefined;$scope.wsalemail.subject="Pedido de emissão";var date=new Date();date.setUTCHours(date.getUTCHours()-2);if($scope.response){if($scope.response.subClientEmail){$scope.wsalemail.subClientEmail=$scope.response.subClientEmail;}if($scope.check48hours()){$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.status=="Bloqueado"){$scope.wsalemail.emailContent="Olá, <br><br>"+"Antes de seguirmos com a emissão, nosso setor financeiro solicita contato para as devidas atualizações.<br>"+"Horário de atendimento do setor financeiro: Segunda a Sexta de 09:00 as 18:00 ( horário de Brasília )  <br><br>"+"Email: financeiro@onemilhas.com.br <br>Telefones: (31) 9 9766-6636 / 3972-9601 (opção 2)<br><br>";$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';if(date.getDay()==0||date.getDay()==6||date.getUTCHours()>=17||date.getUTCHours()<=2){$scope.wsalemail.emailContent+="Email: suporte@onemilhas.com.br ou financeiro@onemilhas.com.br <br>Telefone: (31) 9 9656-9292 <br><br>";}$scope.wsalemail.emailContent+="Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.status=="Antecipado/Bloqueado"){$scope.wsalemail.emailContent="Prezado parceiro,<br><br> "+"Para darmos andamento a sua solicitação, pedimos que nos encaminhe o comprovante de pagamento no valor da OP mais o mínimo de R$50,00, <br>"+"conforme acordo fechado com o financeiro.<br>"+"O comprovante deverá ser enviado neste mesmo e-mail: emissao@onemilhas.com.br . Aguardamos o recebimento do comprovante e liberação do setor financeiro para seguirmos com o processo.<br><br>";$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';if(date.getDay()==0||date.getDay()==6||date.getUTCHours()>=17||date.getUTCHours()<=2){$scope.wsalemail.emailContent+="Email: suporte@onemilhas.com.br ou financeiro@onemilhas.com.br <br>Telefone: (31) 9 9656-9292 <br><br>";}$scope.wsalemail.emailContent+="Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.status=="Pendente"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Cliente com status PENDENTE!"+"<br>"+$scope.response.client_name+"<br>"+"Atenciosamente.<br>Equipe One Milhas";if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=21){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}else if(date.getDay()>0&&date.getDay()<6){$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}else{$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>21||date.getUTCHours()<=2)){$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';$scope.wsalemail.emailContent="Caro Parceiro.<br><br>"+"Agradecemos a confiança ao enviar a 1º emissão.Dentre as próximas horas iremos enviar nosso protocolo de ativação finalizando nosso cadastro.<br>"+"Para seguirmos com essa emissão gentileza entrar em contato com nosso setor comercial para alinharmos os últimos detalhes.<br><br>"+"(31) 9 9467-1030<br><br>"+'suporte@onemilhas.com.br'+"<br><br>"+"Atenciosamente<br>Equipe One Milhas";}}else if($scope.response.paymentType=="Antecipado"){$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Para darmos andamento a sua solicitação, pedimos que nos encaminhe o comprovante de pagamento neste mesmo e-mail: emissao@onemilhas.com.br . Aguardamos o recebimento do comprovante e liberação do setor financeiro para seguirmos com o processo.<br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: (31) 9 9766-6636 / 3972-9601(opção 2)<br><br>";$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody>"+"<tr bgcolor='#FFFFFF'><td></td><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Caixa</b></font></td><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Brasil</b></font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'><b>Caixa</b></font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'><b>Bradesco</b></font></td><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Itaú</b></font></td></tr>"+"<tr><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Banco:</b></font></td><td>C.E.F - 104</td><td>001</td><td>033</td><td>237</td><td>341</td></tr><tr>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'><b>Agência:</b></font></td><td>0087 - OP 003</td><td>4403-2</td><td>0944</td><td>2943</td><td>3101</td></tr>"+"<tr><td bgcolor='#5D7B9D'><font color='#ffffff'><b>Conta:</b></font></td><td>3324-2</td><td>20123-5</td><td>13002164-6</td><td>0017241-3</td><td>43300-5</td></tr>"+"<tr><td colspan='6'><b>CML VIAGENS E TURISMO LTDA</b><br><b>CNPJ: 35.823.529-0001-90</b></td></tr></tbody></table><br><br>";$scope.wsalemail.emailContent+="Atenciosamente.<br>Equipe One Milhas";}else if($scope.response.partner_limit=="true"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Seu limite foi excedido, com isso pedimos que entre em contato com o setor financeiro para seguirmos com a emissão.<br><br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: (31) 9 9766-6636 / 3972-9601(opção 2)<br><br>"+"Atenciosamente.<br>Equipe One Milhas";if(date.getDay()==0||date.getDay()==6){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=23){$scope.wsalemail.emailpartner='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>23||date.getUTCHours()<=2)){$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco='suporte@onemilhas.com.br'+";"+'financeiro@onemilhas.com.br';}}}else{$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>EquipeOne Milhas";}$scope.uploader.clearQueue();if($scope.response){if($scope.response.client_name){$scope.wsalemail.emailContent+="<br><br>Cliente: "+$scope.response.client_name;}}$scope.wsalemail.emailContent+="<br><br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(" ");var connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"HH:mm:ss")+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"HH:mm:ss")+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_code_from+"</td><td>"+$scope.resume_flights[i].airport_code_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter("date")($scope.resume_paxs[i].birhtdate,"dd/MM/yyyy")+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";if($scope.response){if($scope.response.status=="Bloqueado"||$scope.response.paymentType=="Antecipado"||$scope.response.partner_limit=="true"){$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles="";var pricing="";var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.resume_paxs){if($scope.resume_paxs[a].is_child=="S"){NumberOfChild++;}else if($scope.resume_paxs[a].is_newborn=="S"){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var miles="";var pricing="";var testes=$scope.resume_flights[b].connection.split(" ");connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult,0)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";pricing=pricing+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";}if(NumberOfChild>0){miles=miles+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child,0)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";pricing=pricing+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";}if(NumberOfNewborn>0){miles=miles+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn,0)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";pricing=pricing+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($scope.getTotalValue())+"</font></td></tr>"+"</tbody></table>";}}else{$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles="";var pricing="";var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.onlineflights){if($scope.onlineflights[a].is_child=="S"){NumberOfChild++;}else if($scope.onlineflights[a].is_newborn=="S"){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var testes=$scope.resume_flights[b].connection.split(" ");connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";pricing=pricing+"ADT: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+" (x"+$rootScope.formatNumber(NumberOfAdult,0)+")";}if(NumberOfChild>0){miles=miles+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";pricing=pricing+"<br>CHD: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+" (x"+$rootScope.formatNumber(NumberOfChild,0)+")";}if(NumberOfNewborn>0){miles=miles+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";pricing=pricing+"<br>INF: "+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+" (x"+$rootScope.formatNumber(NumberOfNewborn,0)+")";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($scope.getTotalValue())+"</font></td></tr>"+"</tbody></table>";}}$scope.previousIndex=$scope.tabindex;$scope.tabindex=5;};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}if($scope.uploader.queue.length>0){$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wsalemail,attachment:file,type:"EMISSAO",order:$rootScope.onlineOrder,emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.undo();$scope.uploader.clearQueue();}else{logger.logError(jQuery.parseJSON(result).message.text);}});}else{if($scope.tabindex==2){$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wsalemail,attachment:file,type:"EMISSAO",order:$rootScope.onlineOrder,cards_data:$scope.cards,emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.uploader.clearQueue();if($scope.reserve)$scope.selected.status="RESERVA";if($scope.tabindex!=5){$.post("../backend/application/index.php?rota=/changeStatus",{hashId:$scope.session.hashId,data:$scope.selected,flights:$scope.onlineflights},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.selected=undefined;$scope.loadSalesByFilter();});}else{$scope.selected=undefined;$scope.loadSalesByFilter();}}else{logger.logError(jQuery.parseJSON(result).message.text);}});}else{$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wsalemail,attachment:file,type:"EMISSAO",order:$rootScope.onlineOrder,emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.uploader.clearQueue();$scope.selected=undefined;$scope.loadSalesByFilter();}else{logger.logError(jQuery.parseJSON(result).message.text);}});}}};$scope.check48hours=function(argument){var date=new Date();date.setDate(date.getDate()+2);for(var i=0;$scope.onlineflights.length>i;i++){if($scope.onlineflights[i].airline=="GOL"&&new Date($scope.onlineflights[i].boarding_date)<date){if($scope.onlineflights[i].emissionMethod!="Companhia"){return true;}}}return false;};$scope.getReturnFlight=function(airline,cards_id,flight,airport_code_from,airport_code_to,flightLocator){$scope.filterBillet=$filter("filter")($scope.onlineflights,airline);for(var i in $scope.filterBillet){if($scope.filterBillet[i].flightLocator==flightLocator&&$scope.filterBillet[i].flight!=flight&&$scope.filterBillet[i].isBreak!="Quebrado"){return $scope.filterBillet[i];}}return null;};$scope.spaceLetter=function(flight_selected){var letter=" ";var i=0;while(flight_selected[i]!=" "){letter+=flight_selected[i];i++;}return letter;};$scope.printBilletAzul2=function(flight_selected){$scope.billetCanbas=true;$scope.flight_selected=flight_selected||this.onlineflight;if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);if($scope.returnFlight){if($rootScope.findDate($scope.returnFlight.boarding_date)<$rootScope.findDate($scope.flight_selected.boarding_date)){$scope.flight_selected=angular.copy($scope.returnFlight);}}}if($scope.flight_selected.isBreak=="Quebrado"){return logger.logError("Este trecho esta quebrado!");}var start=0;var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFont("helvetica");$scope.toDataUrl("images/azul/AZUL.png",function(base64Img){doc.addImage(base64Img,"JPEG",100,15,100,35);start=70;doc.setLineWidth(0.5);doc.setFontSize(12);doc.rect(100,start,400,40);doc.setTextColor(100);$scope.toDataUrl("images/azul/check.png",function(base64Img){doc.addImage(base64Img,"JPEG",110,start+10,30,20);doc.text(150,start+15,"Sua compra foi realizada com sucesso! Obrigada por escolher\n a Azul,");doc.setTextColor(20);doc.text(200,start+30,$scope.flight_selected.pax_name);start+=55;doc.setTextColor(100);doc.text(100,start,"Código da Reserva: ");doc.setFontType("bold");doc.setTextColor(20);doc.text(220,start,$scope.flight_selected.flightLocator);doc.setFontType("normal");start+=10;doc.setLineWidth(0.7);doc.line(100,start,500,start);start+=20;doc.setFontType("bold");doc.setFontSize(8);doc.setTextColor(100);var initText=$scope.getWeekday($scope.flight_selected.boarding_date)+", "+$filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.boarding_date))+" "+$filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"yyyy");initText+=" "+$filter("date")(new Date($scope.flight_selected.boarding_date),"HH:mm")+" - ";if($scope.getIsReturn($scope.flight_selected)){initText+="IDA e VOLTA";}else{initText+="Somente IDA";}doc.text(100,start,initText);doc.setFontType("normal");start+=25;var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.flight_selected.airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.flight_selected.airport_code_to;})[0];doc.setFontSize(10);doc.setTextColor(90);doc.text(100,start,from.city.name+" ("+$scope.flight_selected.airport_code_from+")                   "+to.city.name+" ("+$scope.flight_selected.airport_code_to+")");$scope.toDataUrl("images/azul/aviao.png",function(base64Img){doc.addImage(base64Img,"JPEG",116+(from.city.name.length+$scope.flight_selected.airport_code_from.length+1)*5,start-10,20,10);start+=35;doc.setFontType("bold");doc.setFontSize(7);doc.setTextColor(100);doc.text(250,start,"Utilize o código de barras para agilizar o check-in nos ");doc.setFontSize(10);doc.setTextColor(20);doc.text(430,start,"Totens da Azul");doc.setFontType("normal");$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.connections=jQuery.parseJSON(result).dataset;$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator)},function(result){$scope.connectionsReturn=jQuery.parseJSON(result).dataset;$("#miscCanvas").barcode($scope.flight_selected.flightLocator,"code128",{barWidth:2,barHeight:30,showHRI:false});doc.setTextColor(20);html2canvas($("#miscCanvas"),{onrendered:function onrendered(canvas){var barcode=canvas.toDataURL("image/png");doc.addImage(barcode,"PNG",90,start-15,150,35);doc.setTextColor(0);doc.setDrawColor(0);doc.setTextColor(0);doc.setLineWidth(0.5);start=start+30;doc.autoTable([{title:"IDA --- "+$scope.getWeekday($scope.flight_selected.boarding_date)+", "+$filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.boarding_date))+" "+$filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"yyyy"),dataKey:"left"},{title:"PONTOS TUDOAZUL",dataKey:"right"}],[{left:from.city.name+" ("+$scope.flight_selected.airport_code_from+") > "+to.city.name+" ("+$scope.flight_selected.airport_code_to+")"}],{startY:start,margin:{left:100,right:100},theme:"plain",createdCell:function createdCell(cell,data){if(data.column.dataKey==="right"){cell.styles.halign="right";}}});doc.rect(100,start,400,doc.autoTableEndPosY()-start);start=doc.autoTableEndPosY();var toConnections="";var time="";if($scope.connections.length>0){toConnections=$scope.connections[0].airportCodeTo;time=$scope.connections[0].landing;if($scope.selected.notificationurl!=""&&$scope.selected.notificationurl!=null){time=$scope.connections[0].landing.split(" ")[1];}}else{toConnections=$scope.flight_selected.airport_code_to;time=$filter("date")(new Date($scope.flight_selected.landing_date),"HH:mm");}var startFLight=start;doc.autoTable([{title:"Voo "+$scope.flight_selected.flight,dataKey:"left"},{title:$filter("date")(new Date($scope.flight_selected.boarding_date),"HH:mm")+" > "+time,dataKey:"center"},{title:"",dataKey:"right"}],[{right:"",center:$scope.flight_selected.airport_code_from+"       "+toConnections}],{startY:start,margin:{left:100,right:100},theme:"plain",createdCell:function createdCell(cell,data){if(data.column.dataKey==="right"){cell.styles.halign="right";}}});start=doc.autoTableEndPosY();for(var i=1;i<=$scope.connections.length-1;i++){var boarding=$scope.connections[i].boarding;var landing=$scope.connections[i].landing;if($scope.selected.notificationurl!=""&&$scope.selected.notificationurl!=null){boarding=$scope.connections[i].boarding.split(" ")[1];landing=$scope.connections[i].landing.split(" ")[1];}doc.autoTable([{title:"Voo "+$scope.connections[i].flight,dataKey:"left"},{title:boarding+" > "+landing,dataKey:"center"},{title:"",dataKey:"right"}],[{right:"",center:$scope.connections[i].airportCodeFrom+"       "+$scope.connections[i].airportCodeTo}],{startY:start,margin:{left:100,right:100},theme:"plain",createdCell:function createdCell(cell,data){if(data.column.dataKey==="right"){cell.styles.halign="right";}}});start=doc.autoTableEndPosY();}doc.rect(100,startFLight,400,doc.autoTableEndPosY()-startFLight);doc.autoTable([{title:"Passageiro",dataKey:"pax"},{title:"Trecho",dataKey:"center"},{title:"Assento",dataKey:"sit"},{title:"Bagagens",dataKey:"cardNumber"}],$scope.getPax($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator),{startY:start,margin:{left:100,right:100},theme:"plain",headerStyles:{fontStyle:"normal"},bodyStyles:{rowHeight:20,cellPadding:5},drawRow:function drawRow(row,data){doc.line(100,row.y,500,row.y);}});doc.rect(100,start,400,doc.autoTableEndPosY()-start);start=doc.autoTableEndPosY()+20;if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);var fromReturn=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.returnFlight.airport_code_from;})[0];var toReturn=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.returnFlight.airport_code_to;})[0];doc.autoTable([{title:"VOLTA --- "+$scope.getWeekday($scope.returnFlight.boarding_date)+", "+$filter("date")($rootScope.findDate($scope.returnFlight.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.returnFlight.boarding_date))+" "+$filter("date")($rootScope.findDate($scope.returnFlight.boarding_date),"yyyy"),dataKey:"left"},{title:"PONTOS TUDOAZUL",dataKey:"right"}],[{left:fromReturn.city.name+" ("+$scope.returnFlight.airport_code_from+") > "+toReturn.city.name+" ("+$scope.returnFlight.airport_code_to+")"}],{startY:start,margin:{left:100,right:100},theme:"plain",createdCell:function createdCell(cell,data){if(data.column.dataKey==="right"){cell.styles.halign="right";}}});doc.rect(100,start,400,doc.autoTableEndPosY()-start);start=doc.autoTableEndPosY();$scope.connections;var toConnections="";var time="";if($scope.connectionsReturn.length>0){toConnections=$scope.connectionsReturn[0].airportCodeTo;time=$scope.connectionsReturn[0].landing;}else{toConnections=$scope.returnFlight.airport_code_to;time=$filter("date")(new Date($scope.returnFlight.landing_date),"HH:mm");}var startFLight=start;doc.autoTable([{title:"Voo "+$scope.returnFlight.flight,dataKey:"left"},{title:$filter("date")(new Date($scope.returnFlight.boarding_date),"HH:mm")+" > "+time,dataKey:"center"},{title:"",dataKey:"right"}],[{right:"",center:$scope.returnFlight.airport_code_from+"       "+toConnections}],{startY:start,margin:{left:100,right:100},theme:"plain",createdCell:function createdCell(cell,data){if(data.column.dataKey==="right"){cell.styles.halign="right";}}});start=doc.autoTableEndPosY();for(var i=1;i<=$scope.connectionsReturn.length-1;i++){doc.autoTable([{title:"Voo "+$scope.connectionsReturn[i].flight,dataKey:"left"},{title:$scope.connectionsReturn[i].boarding+" > "+$scope.connectionsReturn[i].landing,dataKey:"center"},{title:"",dataKey:"right"}],[{right:"",center:$scope.connectionsReturn[i].airportCodeFrom+"       "+$scope.connectionsReturn[i].airportCodeTo}],{startY:start,margin:{left:100,right:100},theme:"plain",createdCell:function createdCell(cell,data){if(data.column.dataKey==="right"){cell.styles.halign="right";}}});start=doc.autoTableEndPosY();}doc.rect(100,startFLight,400,doc.autoTableEndPosY()-startFLight);doc.autoTable([{title:"Passageiro",dataKey:"pax"},{title:"Trecho",dataKey:"center"},{title:"Assento",dataKey:"sit"},{title:"Bagagens",dataKey:"cardNumber"}],$scope.getPaxReturn($scope.returnFlight.airline,$scope.returnFlight.cards_id,$scope.returnFlight.flight,$scope.flight_selected.flightLocator),{startY:start,margin:{left:100,right:100},theme:"plain",headerStyles:{fontStyle:"normal"},bodyStyles:{rowHeight:20,cellPadding:5},drawRow:function drawRow(row,data){doc.line(100,row.y,500,row.y);}});doc.rect(100,start,400,doc.autoTableEndPosY()-start);start=doc.autoTableEndPosY()+20;}start=doc.autoTableEndPosY()+30;doc.setTextColor(100);doc.setFontSize(12);doc.text(110,start,"Lembretes para sua viagem");start+=15;$scope.toDataUrl("images/azul/personIcol.png",function(base64Img){doc.addImage(base64Img,"JPEG",110,start,25,15);doc.text(140,start+15,"Leve documento de identificação com foto");start+=20;$scope.toDataUrl("images/azul/timeIco.png",function(base64Img){doc.addImage(base64Img,"JPEG",110,start,25,15);doc.text(140,start+15,"Chegue com antecedência");start+=20;$scope.toDataUrl("images/azul/seatIco.png",function(base64Img){doc.addImage(base64Img,"JPEG",110,start,25,15);doc.text(140,start+15,"Marque seu assento");start+=20;$scope.toDataUrl("images/azul/pcIco.png",function(base64Img){doc.addImage(base64Img,"JPEG",110,start,25,15);doc.text(140,start+15,"Faça seu check-in pela Internet");start+=25;doc.autoTable([{title:"Outros avisos importantes",dataKey:"text"}],[{text:"1. Comparecer para o embarque 1 (uma) hora antes da partida do voo, munido de documento de"},{text:" identificação original com fotografia."},{text:"2. O bilhete não é endossável."},{text:"3. O bilhete eletrônico é válido por um ano após a data de emissão. No entanto, a tarifa é válida somente para"},{text:" as datas do voo especificado."},{text:"4. Para remarcação, remissão, reembolso e não comparecimento ao embarque (noshow), consulte"},{text:" penalidades no site voeazul.com.br, na seção Dúvidas Frequentes."},{text:"5. No caso de reembolso, contatar a companhia aérea no telefone 4003-1118"},{text:"O contrato de transporte de passagens encontra-se disponível em nossas lojas ou em nosso site."},{text:"A sua escolha é muito importante para nós!"}],{startY:start,margin:{left:100,right:100},styles:{fontSize:8},theme:"plain",headerStyles:{fontSize:12,fontStyle:"normal"},bodyStyles:{rowHeight:10,cellPadding:2},drawRow:function drawRow(row,data){if(row.index===0){doc.line(100,row.y,450,row.y);}}});start=doc.autoTableEndPosY()+10;$scope.billetCanbas=false;doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.multiDownloads!==true){if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}$scope.$apply();}});});});});}});});});});});});};$scope.printBilletAvianca=function(flight_selected){$scope.flight_selected=flight_selected||this.onlineflight;if($scope.flight_selected.isBreak=="Quebrado"){return logger.logError("Este trecho esta quebrado!");}var start=0;var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFont("helvetica");doc.setFontSize(16);var bagagge=0;var con,ret=0;var flights=$scope.getAviancaFlights($scope.flight_selected);$scope.toDataUrl("images/avianca/avianca.png",function(base64Img){doc.addImage(base64Img,"JPEG",15,17,565,90);doc.setFontType("bold");doc.text(20,120,"Recibo do Etkt / Electronic Ticket Receipt");doc.setDrawColor(0);doc.setFillColor(240,240,240);doc.rect(15,140,360,30,"F");doc.setFontSize(12);doc.setTextColor(0);doc.setFontType("bold");doc.text(20,160,"Localizador / Booking Reference: "+$scope.flight_selected.flightLocator);doc.setFontSize(11);doc.text(20,180,"No check-in você deverá apresentar um documento original com foto.");doc.setFontType("normal");doc.text(20,190,"At check-in, you must show a photo ID.");doc.setFontType("bold");doc.setDrawColor(0);doc.setFillColor(240,240,240);doc.rect(390,140,200,70,"F");doc.setFontSize(12);doc.text(400,160,"Escritório / Office");doc.setFontSize(9);doc.setFontType("normal");doc.text(400,170,"AVIANCA BRASIL");doc.text(400,180,"AV WASHINGTON LUIS, 7059 CAMPO BELO");doc.text(400,190,"SAO PAULO");doc.text(400,200,"TELEFONE / TELEPHONE: 4004 4040");doc.setFontSize(12);doc.text(31,240,"Passageiro / Passenger");doc.setLineWidth(1);doc.line(20,250,180,250);var fullName=$scope.flight_selected.pax_name;if($scope.flight_selected.paxLastName){fullName+=" "+$scope.flight_selected.paxLastName;}if($scope.flight_selected.paxAgnome){fullName+=" "+$scope.flight_selected.paxAgnome;}bagagge=$scope.flight_selected.baggage;bagagge=0;var paxName=fullName.split(" ");var name="";if(paxName[paxName.length-1]==""||paxName[paxName.length-1]==" "){paxName.splice(paxName.length-1,1);}var lastName=0;if(paxName.length>2){if($scope.checkPaxName(paxName[paxName.length-1])){name=paxName[paxName.length-2]+" "+paxName[paxName.length-1]+" ";lastName=2;}else{name=paxName[paxName.length-1]+" ";lastName=1;}}else{name=paxName[paxName.length-1]+" ";lastName=1;}for(var i=0;i<=paxName.length-1-lastName;i++){name+=paxName[i]+" ";}doc.setFontSize(10);doc.text(25,265,name+$scope.getPaxSex($scope.flight_selected));doc.text(25,280,"("+$scope.getPaxType($scope.flight_selected)+")");doc.setFontSize(16);doc.setFontType("bold");doc.text(20,310,"Itinerário / Itinerary");start=330;var rows=[{from:"From",to:"To",Flight:"Flight",Class:"Class",Date:"Date",Departure:"Departure",Arrival:"Arrival",Resa1:"Resa (1)",NVB2:"NVB(2)",NVA3:"NVA(3)",check_in:"Last check-in",Baggage:"Baggage",Seat:"Seat"}];rows.push({from:$scope.flight_selected.airport_code_from,to:$scope.flight_selected.airport_code_to,Flight:$scope.flight_selected.flight,Class:"X",Date:$filter("date")(new Date($scope.flight_selected.boarding_date),"dd")+$scope.getAviancaMonth(new Date($scope.flight_selected.boarding_date)),Departure:$filter("date")(new Date($scope.flight_selected.boarding_date),"HH:mm"),Arrival:$filter("date")(new Date($scope.flight_selected.landing_date),"HH:mm"),Resa1:"Ok",Baggage:bagagge+"PC",Seat:$scope.flight_selected.seat});$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{data:$scope.flight_selected},function(result){$scope.connectionsAvianca=jQuery.parseJSON(result).dataset;var connect=new Array();connect.push(angular.copy($scope.flight_selected.seat));if($scope.flight_selected.connections){for(var i=0;i<$scope.flight_selected.connections.length;i++){connect.push($scope.flight_selected.connections[i].seat);}}var dateReportDeparture=new Date($scope.flight_selected.boarding_date);for(var i=0;i<$scope.connectionsAvianca.length;i++){rows.push({});rows.push({});rows.push({from:"Frequent flyer number"});if(i>0){if(parseInt($scope.connectionsAvianca[i].boarding.split(":")[0])<parseInt($scope.connectionsAvianca[i-1].landing.split(":")[0])){dateReportDeparture.setDate(dateReportDeparture.getDate()+1);}}rows.push({from:$scope.connectionsAvianca[i].airport_code_from,to:$scope.connectionsAvianca[i].airport_code_to,Flight:$scope.connectionsAvianca[i].flight,Class:"X",Date:$filter("date")(dateReportDeparture,"dd")+$scope.getAviancaMonth(new Date(dateReportDeparture)),Departure:$scope.connectionsAvianca[i].boarding,Arrival:$scope.connectionsAvianca[i].landing,Resa1:"Ok",Baggage:bagagge+"PC",Seat:connect[i]});}rows.push({});rows.push({});rows.push({from:"Frequent flyer number"});if(flights.length>0){$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{data:flights[0]},function(result){$scope.connectionsAvianca=jQuery.parseJSON(result).dataset;var connectReturn=new Array();connectReturn.push(angular.copy(flights[0].seat));con=0;for(var i in flights){con=flights[i].baggage;con=0;if(flights[i].connections){for(var j=0;j<flights[i].connections.length;j++){connectReturn.push(flights[i].connections[j].seat);}}rows.push({from:flights[i].airport_code_from,to:flights[i].airport_code_to,Flight:flights[i].flight,Class:"X",Date:$filter("date")(new Date(flights[i].boarding_date),"dd")+$scope.getAviancaMonth(new Date(flights[i].boarding_date)),Departure:$filter("date")(new Date(flights[i].boarding_date),"HH:mm"),Arrival:$filter("date")(new Date(flights[i].landing_date),"HH:mm"),Resa1:"Ok",Baggage:con+"PC",Seat:flights[i].seat});rows.push({});rows.push({});rows.push({from:"Frequent flyer number"});}var dateReportDepartureReturn=new Date(flights[0].boarding_date);for(var i in $scope.connectionsAvianca){rows.push({});rows.push({});rows.push({from:"Frequent flyer number"});if(i>0){if(parseInt($scope.connectionsAvianca[i].boarding.split(":")[0])<parseInt($scope.connectionsAvianca[i-1].landing.split(":")[0])){dateReportDepartureReturn.setDate(dateReportDeparture.getDate()+1);}}rows.push({from:$scope.connectionsAvianca[i].airport_code_from,to:$scope.connectionsAvianca[i].airport_code_to,Flight:$scope.connectionsAvianca[i].flight,Class:"X",Date:$filter("date")(dateReportDepartureReturn,"dd")+$scope.getAviancaMonth(new Date(dateReportDepartureReturn)),Departure:$scope.connectionsAvianca[i].boarding,Arrival:$scope.connectionsAvianca[i].landing,Resa1:"Ok",Baggage:con+"PC",Seat:connectReturn[i]});}rows.push({});rows.push({});rows.push({from:"Frequent flyer number"});doc.autoTable([{title:"De",dataKey:"from"},{title:"Para",dataKey:"to"},{title:"Voo",dataKey:"Flight"},{title:"Classe",dataKey:"Class"},{title:"Data",dataKey:"Date"},{title:"Partida",dataKey:"Departure"},{title:"Chegada",dataKey:"Arrival"},{title:"Resa",dataKey:"Resa1"},{title:"NVB",dataKey:"NVB2"},{title:"NVA",dataKey:"NVA3"},{title:"Prazo para efetuar o Check-in",dataKey:"check_in"},{title:"Bagagem",dataKey:"Baggage"},{title:"Assento",dataKey:"Seat"}],rows,{startY:start,margin:{horizontal:15},fontSize:8,styles:{overflow:"linebreak",cellPadding:1},columnStyles:{from:{columnWidth:60},to:{columnWidth:60}},theme:"plain",drawRow:function drawRow(row,data){if(row.index===2||row.index===6||row.index===10||row.index===14||row.index===18||row.index===22||row.index===26||row.index===30||row.index===34||row.index===38||row.index===42){doc.autoTableText("Operado Por / Operated by AVIANCA BRASIL  Comercializado por / Marketed by AVIANCA BRASIL",data.settings.margin.left+5,row.y+10,{valign:"middle"});data.cursor.y+=20;}if(row.index===3||row.index===7||row.index===11||row.index===15||row.index===19||row.index===23||row.index===27||row.index===31||row.index===35||row.index===39||row.index===43){doc.autoTableText("Número de Passageiro Frequente /  "+$scope.flight_selected.card_number,data.settings.margin.left+5,row.y+10,{valign:"middle"});data.cursor.y+=20;}}});start=doc.autoTableEndPosY()+10;doc.setDrawColor(0);doc.setLineWidth(1);doc.line(15,start,565,start);start+=10;doc.autoTable([{title:"",dataKey:"text"}],[{text:"(1) Ok = confirmado / confirmed (2) NVB = Sem validade antes de / Not valid before (3) NVA = Sem validade depois de / Not valid after "}],{startY:start,pageBreak:"avoid",cellPadding:5,margin:{horizontal:10},fontSize:8,theme:"plain",headerStyles:{fontSize:10},styles:{cellPadding:2}});start=doc.autoTableEndPosY();$scope.toDataUrl("images/avianca/aviancaCheckIn.png",function(base64Img){doc.addImage(base64Img,"JPEG",15,start,565,90);start+=110;if(start>=295){doc.addPage();start=20;}doc.setFontSize(16);doc.setFontType("bold");doc.text(20,start,"Recibo / Receipt");var taxCard="";if($scope.flight_selected.tax_card){for(var i=0;i<$scope.flight_selected.tax_card.length-5;i++){taxCard+="X";}taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-4];taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-3];taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-2];taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-1];}start+=20;var taxCalculation="";taxCalculation+=": "+$scope.flight_selected.airport_code_from+" 06 ";if(flights.length>0){for(var i in flights){taxCalculation+=" X/"+flights[i].airport_code_from+" 06 ";}taxCalculation+=flights[flights.length-1].airport_code_to;}else{taxCalculation+=$scope.flight_selected.airport_code_to;}doc.autoTable([{title:"Nome / Name",dataKey:"text"},{title:": "+name+$scope.getPaxSex($scope.flight_selected)+" ( "+$scope.getPaxType($scope.flight_selected)+")",dataKey:"pax"}],[{text:"Forma de pagamento / Form of payment",pax:": CC "+taxCard+" Exp "+$filter("date")(new Date($scope.flight_selected.tax_dueDate),"mm")+$filter("date")(new Date($scope.flight_selected.tax_dueDate),"yy")+" S207728 : "+$scope.flight_selected.tax_billet},{text:"Forma de pagamento / Form of payment",pax:": FFR : 0.00 : BRL2"},{text:"Tarifa / Fare",pax:": USD 0.00"},{text:"Tarifa Equivalente / Fare Equivalent",pax:": BRL 0.00"},{text:"tax_billetas / Taxes",pax:": BRL "+$scope.flight_selected.tax_billet+" BR"},{text:"Valor Total / Total Amount",pax:": BRL "+$scope.getTotalTaxFlight($scope.flight_selected.flightLocator)+""},{text:"Cia Aérea Emissora e data / Issuing Airline and date",pax:": AVIANCA BRASIL "+$filter("date")(new Date(),"dd")+$scope.getAviancaMonth(new Date())+$filter("date")(new Date(),"yy")},{text:"IATA / IATA",pax:": 57996643"},{text:"Cálculo de Tarifa / Fare Calculation",pax:taxCalculation+" 0.00USD0.00END"}],{startY:start,margin:{horizontal:10},fontSize:9,pageBreak:"auto",theme:"plain",styles:{cellPadding:3}});start=doc.autoTableEndPosY()+10;doc.autoTable([{title:"",dataKey:"text"}],[{text:"A tarifa aplicada na data da compra só é válida para o itinerário e as datas específicas mencionadas no bilhete."},{text:"The fare that applies on the date of purchase is only valid for the entire itinerary and the specific travel dates mentioned on the ticket."}],{startY:start,pageBreak:"avoid",margin:{horizontal:5},theme:"plain",fontSize:9,styles:{cellPadding:2}});start=doc.autoTableEndPosY()+10;$scope.toDataUrl("images/avianca/aviancaCentral.png",function(base64Img){doc.addImage(base64Img,"JPEG",15,start,565,90);start+=100;doc.setDrawColor(0);doc.setLineWidth(1.5);doc.line(15,start,565,start);doc.autoTable([{title:"Ocean Air Linhas Aéreas S.A., ('Avianca Brasil')",dataKey:"text"}],[{text:"Av. Washington Luis, 7059, Campo Belo, São Paulo - SP - 04627-006"},{text:"CNPJ/MF n°. 02.575.829/0001-48"}],{startY:start,styles:{cellPadding:2,halign:"center",valign:"middle"},headerStyles:{rowHeight:15,fontSize:8},bodyStyles:{rowHeight:12,fontSize:8,valign:"middle"},margin:{horizontal:5},theme:"plain"});start=doc.autoTableEndPosY()+10;doc.setDrawColor(0);doc.line(15,start,565,start);start+=10;doc.autoTable([{title:"O transporte de certos materiais perigosos, como aerossóis, fogos de artifício, e líquidos inflamáveis, a bordo da aeronave é proibido. Se você tem algumas dúvidas com estas restrições, pode obter mais informações junto a sua companhia aérea.",dataKey:"text"}],[{text:"The carriage of certain hazardous materials, like aerosols, fireworks,and flammable liquids, aboard the aircraft is forbidden. If you do not understand these restrictions, further information may be obtained from your airline."}],{startY:start,pageBreak:"avoid",margin:{horizontal:5},theme:"plain",styles:{overflow:"linebreak"},fontSize:10});start=doc.autoTableEndPosY()+10;doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}});});});}else{doc.autoTable([{title:"De",dataKey:"from"},{title:"Para",dataKey:"to"},{title:"Voo",dataKey:"Flight"},{title:"Classe",dataKey:"Class"},{title:"Data",dataKey:"Date"},{title:"Partida",dataKey:"Departure"},{title:"Chegada",dataKey:"Arrival"},{title:"Resa",dataKey:"Resa1"},{title:"NVB",dataKey:"NVB2"},{title:"NVA",dataKey:"NVA3"},{title:"Prazo para efetuar o Check-in",dataKey:"check_in"},{title:"Bagagem",dataKey:"Baggage"},{title:"Assento",dataKey:"Seat"}],rows,{startY:start,margin:{horizontal:15},fontSize:7,styles:{overflow:"linebreak",cellPadding:2},columnStyles:{from:{columnWidth:80},to:{columnWidth:80}},theme:"plain",drawRow:function drawRow(row,data){if(row.index===2||row.index===6||row.index===10||row.index===14||row.index===18||row.index===22||row.index===26||row.index===30||row.index===34||row.index===38||row.index===42){doc.autoTableText("Operado Por / Operated by AVIANCA BRASIL   Comercializado por / Marketed by     AVIANCA BRASIL",data.settings.margin.left+10,row.y+10,{valign:"middle"});data.cursor.y+=20;}if(row.index===3||row.index===7||row.index===11||row.index===15||row.index===19||row.index===23||row.index===27||row.index===31||row.index===35||row.index===39||row.index===43){doc.autoTableText("Número de Passageiro Frequente /     "+$scope.flight_selected.card_number,data.settings.margin.left+10,row.y+10,{valign:"middle"});data.cursor.y+=20;}}});start=doc.autoTableEndPosY()+10;doc.setDrawColor(0);doc.setLineWidth(1);doc.line(15,start,565,start);start+=10;doc.autoTable([{title:"",dataKey:"text"}],[{text:"(1) Ok = confirmado / confirmed (2) NVB = Sem validade antes de / Not valid before (3) NVA = Sem validade depois de / Not valid after"}],{startY:start,pageBreak:"avoid",cellPadding:5,margin:{horizontal:10},fontSize:8,theme:"plain",headerStyles:{fontSize:10},styles:{cellPadding:2}});start=doc.autoTableEndPosY();$scope.toDataUrl("images/avianca/aviancaCheckIn.png",function(base64Img){doc.addImage(base64Img,"JPEG",15,start,565,90);start+=110;if(start>=295){doc.addPage();start=20;}doc.setFontSize(16);doc.setFontType("bold");doc.text(20,start,"Recibo / Receipt");var taxCard="";if($scope.flight_selected.tax_card){for(var i=0;i<$scope.flight_selected.tax_card.length-5;i++){taxCard+="X";}taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-4];taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-3];taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-2];taxCard+=$scope.flight_selected.tax_card[$scope.flight_selected.tax_card.length-1];}start+=20;var taxCalculation="";taxCalculation+=": "+$scope.flight_selected.airport_code_from+" 06 ";if(flights.length>0){for(var i in flights){taxCalculation+=" X/"+flights[i].airport_code_from+" 06 ";}taxCalculation+=flights[flights.length-1].airport_code_to;}else{taxCalculation+=$scope.flight_selected.airport_code_to;}doc.autoTable([{title:"Nome / Name",dataKey:"text"},{title:": "+name+$scope.getPaxSex($scope.flight_selected)+" ( "+$scope.getPaxType($scope.flight_selected)+")",dataKey:"pax"}],[{text:"Forma de pagamento / Form of payment",pax:": CC "+taxCard+" Exp "+$filter("date")(new Date($scope.flight_selected.tax_dueDate),"mm")+$filter("date")(new Date($scope.flight_selected.tax_dueDate),"yy")+" S207728 : "+$scope.flight_selected.tax_billet},{text:"Forma de pagamento / Form of payment",pax:": FFR : 0.00 : BRL2"},{text:"Tarifa / Fare",pax:": USD 0.00"},{text:"Tarifa Equivalente / Fare Equivalent",pax:": BRL 0.00"},{text:"Taxas / Taxes",pax:": BRL "+$scope.flight_selected.tax_billet+" BR"},{text:"Valor Total / Total Amount",pax:": BRL "+$scope.getTotalTaxFlight($scope.flight_selected.flightLocator)+""},{text:"Cia Aérea Emissora e data / Issuing Airline and date",pax:": AVIANCA BRASIL "+$filter("date")(new Date(),"dd")+$scope.getAviancaMonth(new Date())+$filter("date")(new Date(),"yy")},{text:"IATA / IATA",pax:": 57996643"},{text:"Cálculo de Tarifa / Fare Calculation",pax:taxCalculation+" 0.00USD0.00END"}],{startY:start,margin:{horizontal:10},fontSize:9,pageBreak:"auto",theme:"plain",styles:{cellPadding:3}});start=doc.autoTableEndPosY()+10;doc.autoTable([{title:"",dataKey:"text"}],[{text:"A tarifa aplicada na data da compra só é válida para o itinerário e as datas específicas mencionadas no bilhete."},{text:"The fare that applies on the date of purchase is only valid for the entire itinerary and the specific travel dates mentioned on the ticket."}],{startY:start,pageBreak:"avoid",margin:{horizontal:5},theme:"plain",fontSize:9,styles:{cellPadding:2}});start=doc.autoTableEndPosY()+10;$scope.toDataUrl("images/avianca/aviancaCentral.png",function(base64Img){doc.addImage(base64Img,"JPEG",15,start,565,90);start+=100;doc.setDrawColor(0);doc.setLineWidth(1.5);doc.line(15,start,565,start);doc.autoTable([{title:"Ocean Air Linhas Aéreas S.A., ('Avianca Brasil')",dataKey:"text"}],[{text:"Av. Washington Luis, 7059, Campo Belo, São Paulo - SP - 04627-006"},{text:"CNPJ/MF n°. 02.575.829/0001-48"}],{startY:start,styles:{cellPadding:2,halign:"center",valign:"middle"},headerStyles:{rowHeight:15,fontSize:8},bodyStyles:{rowHeight:12,fontSize:8,valign:"middle"},margin:{horizontal:5},theme:"plain"});start=doc.autoTableEndPosY()+10;doc.setDrawColor(0);doc.line(15,start,565,start);start+=10;doc.autoTable([{title:"O transporte de certos materiais perigosos, como aerossóis, fogos de artifício, e líquidos inflamáveis, a bordo da aeronave é proibido. Se você tem algumas dúvidas com estas restrições, pode obter mais informações junto a sua companhia aérea.",dataKey:"text"}],[{text:"The carriage of certain hazardous materials, like aerosols, fireworks,and flammable liquids, aboard the aircraft is forbidden. If you do not understand these restrictions, further information may be obtained from your airline."}],{startY:start,pageBreak:"avoid",margin:{horizontal:5},theme:"plain",styles:{overflow:"linebreak"},fontSize:10});start=doc.autoTableEndPosY()+10;doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.multiDownloads!==true){if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}}});});}});});};$scope.getAviancaFlights=function(flight_selected){var flights=[];for(var i in $scope.onlineflights){if($scope.onlineflights[i].flightLocator==flight_selected.flightLocator&&$scope.onlineflights[i].cards_id==flight_selected.cards_id&&$scope.onlineflights[i].pax_name==flight_selected.pax_name&&$scope.onlineflights[i].paxLastName==flight_selected.paxLastName&&$scope.onlineflights[i].paxAgnome==flight_selected.paxAgnome&&$scope.onlineflights[i].flight!=flight_selected.flight){flights.push($scope.onlineflights[i]);}}return flights;};$scope.getPaxSex=function(flight){if(flight.gender=="Masculino"){return"Mr";}return"Ms";};$scope.getAviancaMonth=function(date){var day=date.getMonth();switch(day){case 0:return"Jan";case 1:return"Feb";case 2:return"Mar";case 3:return"Apr";case 4:return"May";case 5:return"Jun";case 6:return"Jul";case 7:return"Aug";case 8:return"Sep";case 9:return"Oct";case 10:return"Nov";case 11:return"Dec";}};$scope.getPaxType=function(flight){if(flight.is_child=="S"){return"CHD";}else if(flight.is_newborn=="S"){return"INF";}return"ADT";};$scope.getWeekdayGol=function(date){var day=new Date(date).getDay();switch(day){case 0:return"Domingo";case 1:return"Segunda";case 2:return"Terça";case 3:return"Quarta";case 4:return"Quinta";case 5:return"Sexta";case 6:return"Sábado";}};$scope.golNovo=function(flight_selected){if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);if($scope.returnFlight){if($rootScope.findDate($scope.returnFlight.boarding_date)<$rootScope.findDate($scope.flight_selected.boarding_date)){$scope.flight_selected=angular.copy($scope.returnFlight);}}}$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.connections=jQuery.parseJSON(result).dataset;$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator)},function(result){$scope.connectionsReturn=jQuery.parseJSON(result).dataset;$scope.filterBillet=$filter("filter")($scope.onlineflights,$scope.flight_selected.flightLocator);var doc=new jsPDF("p","pt");var start=0;var pageHeight=doc.internal.pageSize.height;$scope.toDataUrl("images/smileBillet.png",function(base64Img){$scope.toDataUrl("images/roda.png",function(base14Img){$scope.toDataUrl("images/back.png",function(base59Img){$scope.toDataUrl("images/bar.png",function(base61Img){$scope.toDataUrl("images/conection.png",function(base62Img){$scope.toDataUrl("images/Golmini.png",function(base63Img){$scope.toDataUrl("images/set.png",function(base44Img){$scope.toDataUrl("images/ida.png",function(base34Img){start=80;doc.addImage(base64Img,"PNG",120,start-20,88,47);doc.setFontSize(7);doc.setFontStyle("bold");doc.setTextColor(255,128,0);var name=$scope.flight_selected.providerName.split(" ");doc.text(430,start," Olá "+name[0]+" ;)");doc.setTextColor(64);start=start+15;doc.text(370,start,"Seu número Smiles é: "+$scope.flight_selected.card_number);start=start+10;doc.text(430,start,"Acesse sua conta.");start=start+10;doc.setLineWidth(0.5);doc.line(120,start,490,start);start=start+30;doc.setFontSize(9);doc.setTextColor(255,128,0);doc.text(260,start," Olá "+name[0]+" ,");doc.setFontSize(8.5);doc.setTextColor(64);start=start+20;doc.text(200,start,"A Smiles deseja a você uma excelente viagem.");start=start+10;doc.text(160,start,"Confira abaixo os dados da sua passagem com o seu código de reserva.");start=start+30;doc.addImage(base34Img,"PNG",120,start,42,17);start=start+40;doc.setLineWidth(0.1);doc.setFontSize(9);doc.setTextColor(64);doc.text(180,start,"Código Localizador Smiles");doc.text(390,start,$scope.flight_selected.flightLocator);if($scope.filterBillet[0].connection.trim()=="Direto"){var x="DIRETO";}else{var x="PARADA(S)";}start=start+30;doc.text(250,start,"DE");doc.text(290,start-10,x);doc.addImage(base44Img,"PNG",280,start-5,67,10);doc.text(360,start,"PARA");var hour=$scope.filterBillet[0].flight_time.split(":");doc.setTextColor(0);doc.text(300,start+10,hour[0]+"h"+hour[1]+"m");start=start+10;doc.setFontSize(12);doc.text(244,start,$scope.filterBillet[0].airport_code_from);doc.text(360,start,$scope.filterBillet[0].airport_code_to);start=start+30;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{columnWidth:"auto",fontSize:12,overflow:"linebreak"},margin:{top:start,left:40},theme:"plain",pageBreak:"auto",tableWidth:"auto",addPageContent:function addPageContent(data){if($scope.connections.length>0){var board=new Date($scope.flight_selected.boarding_date);$scope.connections.newboarding=new Date();$scope.connections.newlanding=new Date();$scope.days=new Array();for(var ind=0;ind<$scope.connections.length;ind++){$scope.connections[ind].newboarding=new Date();$scope.connections[ind].newlanding=new Date();var land=new Date(board.getFullYear(),board.getMonth(),board.getDate());var verify=$scope.connections[ind].boarding.length;if(ind>0){if(verify<=5){if(parseInt($scope.connections[ind].boarding.split(":")[0])<parseInt($scope.connections[ind-1].landing.split(":")[0])||$scope.connections[ind-1].landing.split(":")[0]<$scope.connections[ind-1].boarding.split(":")[0]){land.setDate(land.getDate()+1);}else{}}}if(verify<=5){board.setHours(parseInt($scope.connections[ind].boarding.split(":")[0]));board.setMinutes(parseInt($scope.connections[ind].boarding.split(":")[1]));land.setHours(parseInt($scope.connections[ind].landing.split(":")[0]));land.setMinutes(parseInt($scope.connections[ind].landing.split(":")[1]));$scope.connections[ind].newboarding=board;$scope.connections[ind].newlanding=land;$scope.connections[ind].newboarding.setDate($scope.connections[ind].newlanding.getDate());var c=$scope.connections[ind].newboarding;var l=$scope.connections[ind].newlanding;$scope.days.push({boarding:new Date(c),landing:new Date(l)});$scope.days.forEach(function(element,index){$scope.connections[index].newboarding=new Date(element.boarding);$scope.connections[index].newlanding=new Date(element.landing);});}else{var b=$scope.connections[ind].boarding.split("/");var cr=$scope.connections[ind].landing.split("/");var y;var j;var bd;var bd2;var ht=b[2].split(" ");var ct=cr[2].split(" ");j=b[2].split(":");y=cr[2].split(":");if(ht&&j[1]){bd=new Date(ht[0],b[1],b[0]);bd.setHours(j[0]);bd.setMinutes(j[1]);bd2=new Date(ct[0],cr[1],cr[0]);bd2.setHours(y[0]);bd2.setMinutes(y[1]);$scope.days.push({boarding:bd,landing:bd2});}else{$scope.days.push({boarding:new Date(b[2],b[1],b[0]),landing:new Date(cr[2],cr[1],cr[0])});}$scope.days.forEach(function(element,index){$scope.connections[index].newboarding=element.boarding;$scope.connections[index].newlanding=element.landing;});}}for(var i=0;i<$scope.connections.length;i++){doc.addImage(base63Img,"PNG",180,start,50,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.connections[i].airportCodeFrom+")");doc.setTextColor(64);var dates=$scope.connections[i].boarding;doc.text(260,start+10,dates);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.connections[i].airportCodeTo+")");doc.setTextColor(64);var datesReturn=$scope.connections[i].landing;doc.text(360,start+10,datesReturn);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.connections[i].flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.filterBillet[0].class);start=start+20;}}else{doc.addImage(base63Img,"PNG",180,start,55,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.filterBillet[0].airport_code_from+")");var dateBoard=$scope.flight_selected.boarding_date.split("-");var dateBoard1=dateBoard[2].split(" ");var hour=dateBoard1[1].split(":");doc.setTextColor(64);doc.text(260,start+10,hour[0]+":"+hour[1]+" "+dateBoard1[0]+"/"+dateBoard[1]+"/"+dateBoard[0]);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.filterBillet[0].airport_code_to+")");var dateLand=$scope.flight_selected.landing_date.split("-");var dateLand1=dateLand[2].split(" ");var hourL=dateLand1[1].split(":");doc.setTextColor(64);doc.text(360,start+10,hourL[0]+":"+hourL[1]+" "+dateLand1[0]+"/"+dateLand[1]+"/"+dateLand[0]);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.filterBillet[0].flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.filterBillet[0].class);start=start+20;}start=start+20;doc.setTextColor(32);doc.setFontSize(9);var columns=[{title:"Passageiro",dataKey:"name"},{title:"Bagagem",dataKey:"baggage"},{title:"Assento",dataKey:"seat"}];var rows=[];start=start+20;var conectSeat="";var paxs=$scope.getPaxLaTam($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator);var group=$filter("groupBy")(paxs,"pax");var res=Object.keys(group).map(function(key){return group[key];});var inteRes=new Array();for(var j in res){var pax="";var seat=new Array();var baggage="";pax=res[j][0].pax;baggage=res[j][0].baggage;for(var f in res[j]){pax=res[j][f].pax;baggage=res[j][f].baggage;seat.push(res[j][f].sit);}inteRes.push({pax:pax,seat:seat,baggage:baggage});}for(var i=0;i<inteRes.length;i++){var str="";var seat="";var element=inteRes[i];if($scope.filterBillet[0].connection.trim()!="Direto"){for(var g in element.seat){conectSeat+=element.seat[g]+" / ";str=conectSeat;}}else{conectSeat=element.seat[0];str=conectSeat;}if(!element.baggage||element.baggage=="0"){element.baggage="Comprar Bagagem";}var seat=element.seat;if(!seat||seat=="---"){seat="Escolher Assento";}rows.push({name:element.pax,baggage:element.baggage,seat:str});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},baggage:{columnWidth:100,textColor:[255,128,0]},seat:{columnWidth:100,textColor:[255,128,0]}},showHeader:"firstPage",startY:start,headerStyles:{fillColor:[255,255,255],textColor:[0],fontSize:9,lineWidth:1,lineColor:[255,255,255]},styles:{fontSize:8,textColor:96},margin:{left:120},theme:"plain",pageBreak:"avoid"});},drawCell:function drawCell(cell,data){}});if(start>=470){start=30;doc.autoTableAddPage();}else{start=start+200;}if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);$scope.RetConn=$scope.returnFlight.connection;doc.addImage(base59Img,"PNG",120,start,42,17);start=start+40;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{columnWidth:"auto",fontSize:12,overflow:"linebreak",overflowColumns:false},startY:start,margin:{left:40},theme:"plain",pageBreak:"auto",showHeader:"firstPage",addPageContent:function addPageContent(datas){doc.setLineWidth(0.1);doc.setFontSize(9);doc.setTextColor(64);doc.text(180,start,"Código Localizador Smiles");doc.text(390,start,$scope.returnFlight.flightLocator);if($scope.returnFlight.connection.trim()=="Direto"){var y="DIRETO";}else{var y="PARADA(S)";}start=start+30;doc.text(250,start,"DE");doc.text(290,start-10,y);doc.addImage(base44Img,"PNG",280,start-5,67,10);doc.text(360,start,"PARA");var hour=$scope.returnFlight.flight_time.split(":");doc.setTextColor(0);doc.text(300,start+10,hour[0]+"h"+hour[1]+"m");start=start+10;doc.setTextColor(0);doc.setFontSize(12);doc.text(244,start,$scope.returnFlight.airport_code_from);doc.text(360,start,$scope.returnFlight.airport_code_to);start=start+30;if($scope.connectionsReturn.length>0){var board=new Date($scope.returnFlight.boarding_date);$scope.connectionsReturn.newboarding=new Date();$scope.connectionsReturn.newlanding=new Date();$scope.daysReturn=new Array();for(var index=0;index<$scope.connectionsReturn.length;index++){$scope.connectionsReturn[index].newboarding=new Date();$scope.connectionsReturn[index].newlanding=new Date();var land=new Date(board.getFullYear(),board.getMonth(),board.getDate());var verifyReturn=$scope.connectionsReturn[index].boarding.length;if(index>0){if(verifyReturn==5){if(parseInt($scope.connectionsReturn[index].boarding.split(":")[0])<parseInt($scope.connectionsReturn[index-1].landing.split(":")[0])||parseInt($scope.connectionsReturn[index-1].boarding.split(":")[0])>parseInt($scope.connectionsReturn[index-1].landing.split(":")[0])){land.setDate(land.getDate()+1);}}}if(verifyReturn==5){board.setHours(parseInt($scope.connectionsReturn[index].boarding.split(":")[0]));board.setMinutes(parseInt($scope.connectionsReturn[index].boarding.split(":")[1]));land.setHours(parseInt($scope.connectionsReturn[index].landing.split(":")[0]));land.setMinutes(parseInt($scope.connectionsReturn[index].landing.split(":")[1]));$scope.connectionsReturn[index].newboarding=board;$scope.connectionsReturn[index].newlanding=land;$scope.connectionsReturn[index].newboarding.setDate($scope.connectionsReturn[index].newlanding.getDate());var cv=$scope.connectionsReturn[index].newboarding;var lv=$scope.connectionsReturn[index].newlanding;$scope.daysReturn.push({boarding:new Date(cv),landing:new Date(lv)});}else{var br=$scope.connectionsReturn[index].boarding.split("/");var crr=$scope.connectionsReturn[index].landing.split("/");var yr;var jr;var bdr;var bd2r;var htr=br[2].split(" ");var ctr=crr[2].split(" ");jr=br[2].split(":");yr=crr[2].split(":");if(htr&&jr[1]){bdr=new Date(htr[0],br[1],br[0]);bdr.setHours(jr[0]);bdr.setMinutes(jr[1]);bd2r=new Date(ctr[0],crr[1],crr[0]);bd2r.setHours(yr[0]);bd2r.setMinutes(yr[1]);$scope.daysReturn.push({boarding:bdr,landing:bd2r});}else{$scope.daysReturn.push({boarding:new Date(br[2],br[1],br[0]),landing:new Date(crr[2],crr[1],crr[0])});}}}$scope.daysReturn.forEach(function(el,index){$scope.connectionsReturn[index].newboarding=new Date(el.boarding),$scope.connectionsReturn[index].newlanding=new Date(el.landing);});for(var i=0;i<$scope.connectionsReturn.length;i++){doc.addImage(base63Img,"PNG",180,start,50,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.connectionsReturn[i].airportCodeFrom+")");doc.setTextColor(64);var datesR=$scope.connectionsReturn[i].boarding;doc.text(260,start+10,datesR);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.connectionsReturn[i].airportCodeTo+")");doc.setTextColor(64);var datesR1=$scope.connectionsReturn[i].landing;doc.text(360,start+10,datesR1);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.connectionsReturn[i].flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.returnFlight.class);start=start+20;}}else{doc.addImage(base63Img,"PNG",180,start,55,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.returnFlight.airport_code_from+")");var dateBoard=$scope.returnFlight.boarding_date.split("-");var dateBoard1=dateBoard[2].split(" ");var hour=dateBoard1[1].split(":");doc.setTextColor(64);doc.text(260,start+10,hour[0]+":"+hour[1]+" "+dateBoard1[0]+"/"+dateBoard[1]+"/"+dateBoard[0]);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.returnFlight.airport_code_to+")");var dateLand=$scope.returnFlight.landing_date.split("-");var dateLand1=dateLand[2].split(" ");var hourL=dateLand1[1].split(":");doc.setTextColor(64);doc.text(360,start+10,hourL[0]+":"+hourL[1]+" "+dateLand1[0]+"/"+dateLand[1]+"/"+dateLand[0]);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.returnFlight.flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.returnFlight.class);start=start+20;}start=start+20;doc.setTextColor(0);doc.setFontSize(9);var columns=[{title:"Passageiro",dataKey:"name"},{title:"Bagagem",dataKey:"baggage"},{title:"Assento",dataKey:"seat"}];var rows=[];start=start+30;var conectSeatRet="";$scope.paxReturn=$scope.getPaxLaTamReturn($scope.returnFlight.airline,$scope.returnFlight.cards_id,$scope.returnFlight.flight,$scope.returnFlight.flightLocator);var letsR=$filter("groupBy")($scope.paxReturn,"pax");var resultsRet=Object.keys(letsR).map(function(key){return letsR[key];});var inteR=new Array();for(var jn in resultsRet){var seatReturn=new Array();var pax="";var baggage="";for(var fn in resultsRet[jn]){pax=resultsRet[jn][fn].pax;baggage=resultsRet[jn][fn].baggage;seatReturn.push(resultsRet[jn][fn].sit);}inteR.push({pax:pax,seat:seatReturn,baggage:baggage});}for(var i=0;i<inteR.length;i++){var strRet="";var seatRet="";var elementRet=inteR[i];if($scope.RetConn.trim()!="Direto"){for(var h in elementRet.seat){conectSeatRet+=elementRet.seat[h]+" / ";strRet=conectSeatRet;}}else{conectSeatRet=elementRet.seat[0];strRet=conectSeatRet;}elementRet.baggage.toString();if(!elementRet.baggage||elementRet.baggage=="0"){elementRet.baggage="Comprar Bagagem";}if(!strRet||strRet=="---"){strRet="Escolher Assento";}rows.push({name:elementRet.pax,baggage:elementRet.baggage,seat:strRet});}doc.autoTable(columns,rows,{startY:start,margin:{left:120},theme:"plain",pageBreak:"avoid",columnStyles:{name:{columnWidth:200},baggage:{columnWidth:100,textColor:[255,128,0]},seat:{columnWidth:100,textColor:[255,128,0]}},showHeader:"firstPage",drawRow:function drawRow(row,data){},headerStyles:{fillColor:[255,255,255],textColor:0,fontSize:9,lineWidth:1,lineColor:[255,255,255]},styles:{fontSize:8,textColor:96,overflowColumns:false}});for(var r in rows){start=start+15;}}});start=start+50;if(start>=600){start=start*20/100;}}start=start+20;var card_number=$scope.filterBillet[0].tax_card?$scope.filterBillet[0].tax_card.replace(/.(?=.{4})/g,"*"):"";var n=$rootScope.formatNumber($scope.getTotalTaxFlight($scope.filterBillet[0].flightLocator));n=n.toString();var columns=[{title:" Forma de Pagamento (R$) ",dataKey:"name"}];var rows=[{name:" Cartão de Crédito "},{name:" "+($scope.filterBillet[0].tax_providerName?$scope.filterBillet[0].tax_providerName:"")},{name:" R$ "+n+"  em 1x"}];var images=[];doc.autoTable(columns,rows,{columnStyles:{},startY:start,styles:{columnWidth:"auto",fontSize:9},headerStyles:{columnWidth:"auto",fontSize:9},margin:{left:115},theme:"plain",pageBreak:"avoid",showHeader:"firstPage",addPageContent:function addPageContent(data){doc.setFontSize(11);doc.setTextColor(0);}});start=start+90;var columns=[{title:" Dados do Comprador",dataKey:"name"}];var rows=[{name:"Nome: "+$scope.flight_selected.providerName},{name:"Telefone: "+$scope.flight_selected.provider_phone}];var images=[];doc.autoTable(columns,rows,{columnStyles:{},startY:start,styles:{columnWidth:"auto",fontSize:9},headerStyles:{columnWidth:"auto",fontSize:9},margin:{left:115},theme:"plain",overflow:"linebreak",tableWidth:"auto",pageBreak:"auto",showHeader:"firstPage",addPageContent:function addPageContent(data){start=start+70;}});start=doc.autoTableEndPosY()+10;var columns=[{title:" ",dataKey:"names"}];var rows=[{names:""}];if(start>=600){start=20;doc.autoTableAddPage();}doc.autoTable(columns,rows,{startY:start,margin:{left:120},theme:"plain",pageBreak:"avoid",columnStyles:{names:{columnWidth:200},baggage:{columnWidth:100},seat:{columnWidth:70}},drawCell:function drawCell(cell,opts){if(opts.column.dataKey=="names"){images.push({x:cell.textPos.x,y:cell.textPos.y});}},addPageContent:function addPageContent(){var y=images[0].y;doc.addImage(base14Img,"PNG",images[0].x-40,start,450,390);}});doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.multiDownloads!==true){if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}}});});});});});});});});});});};$scope.golvelho=function(flight_selected){if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);if($scope.returnFlight){if($rootScope.findDate($scope.returnFlight.boarding_date)<$rootScope.findDate($scope.flight_selected.boarding_date)){$scope.flight_selected=angular.copy($scope.returnFlight);}}}$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.connections=jQuery.parseJSON(result).dataset;$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator)},function(result){$scope.connectionsReturn=jQuery.parseJSON(result).dataset;$scope.filterBillet=$filter("filter")($scope.onlineflights,$scope.flight_selected.flightLocator);var doc=new jsPDF("p","pt");var start=0;var pageHeight=doc.internal.pageSize.height;$scope.toDataUrl("images/smileBillet.png",function(base64Img){$scope.toDataUrl("images/roda.png",function(base14Img){$scope.toDataUrl("images/back.png",function(base59Img){$scope.toDataUrl("images/bar.png",function(base61Img){$scope.toDataUrl("images/conection.png",function(base62Img){$scope.toDataUrl("images/Golmini.png",function(base63Img){$scope.toDataUrl("images/set.png",function(base44Img){$scope.toDataUrl("images/ida.png",function(base34Img){start=80;doc.addImage(base64Img,"PNG",120,start-20,88,47);doc.setFontSize(7);doc.setFontStyle("bold");doc.setTextColor(255,128,0);var name=$scope.flight_selected.providerName.split(" ");doc.text(430,start," Olá "+name[0]+" ;)");doc.setTextColor(64);start=start+15;doc.text(370,start,"Seu número Smiles é: "+$scope.flight_selected.card_number);start=start+10;doc.text(430,start,"Acesse sua conta.");start=start+10;doc.setLineWidth(0.5);doc.line(120,start,490,start);start=start+30;doc.setFontSize(9);doc.setTextColor(255,128,0);doc.text(260,start," Olá "+name[0]+" ,");doc.setFontSize(8.5);doc.setTextColor(64);start=start+20;doc.text(200,start,"A Smiles deseja a você uma excelente viagem.");start=start+10;doc.text(160,start,"Confira abaixo os dados da sua passagem com o seu código de reserva.");start=start+30;doc.addImage(base34Img,"PNG",120,start,42,17);start=start+40;doc.setLineWidth(0.1);doc.setFontSize(9);doc.setTextColor(64);doc.text(180,start,"Código Localizador Smiles");doc.text(390,start,$scope.flight_selected.flightLocator);if($scope.filterBillet[0].connection.trim()=="Direto"){var x="DIRETO";}else{var x="PARADA(S)";}start=start+30;doc.text(250,start,"DE");doc.text(290,start-10,x);doc.addImage(base44Img,"PNG",280,start-5,67,10);doc.text(360,start,"PARA");var hour=$scope.filterBillet[0].flight_time.split(":");doc.setTextColor(0);doc.text(300,start+10,hour[0]+"h"+hour[1]+"m");start=start+10;doc.setFontSize(12);doc.text(244,start,$scope.filterBillet[0].airport_code_from);doc.text(360,start,$scope.filterBillet[0].airport_code_to);start=start+30;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{columnWidth:"auto",fontSize:12,overflow:"linebreak"},margin:{top:start,left:40},theme:"plain",pageBreak:"auto",tableWidth:"auto",addPageContent:function addPageContent(data){if($scope.connections.length>0){var board=new Date($scope.flight_selected.boarding_date);$scope.connections.newboarding=new Date();$scope.connections.newlanding=new Date();$scope.days=new Array();for(var ind=0;ind<$scope.connections.length;ind++){$scope.connections[ind].newboarding=new Date();$scope.connections[ind].newlanding=new Date();var land=new Date(board.getFullYear(),board.getMonth(),board.getDate());var verify=$scope.connections[ind].boarding.length;if(ind>0){if(verify<=5){if(parseInt($scope.connections[ind].boarding.split(":")[0])<parseInt($scope.connections[ind-1].landing.split(":")[0])||$scope.connections[ind-1].landing.split(":")[0]<$scope.connections[ind-1].boarding.split(":")[0]){land.setDate(land.getDate()+1);}else{}}}if(verify<=5){board.setHours(parseInt($scope.connections[ind].boarding.split(":")[0]));board.setMinutes(parseInt($scope.connections[ind].boarding.split(":")[1]));land.setHours(parseInt($scope.connections[ind].landing.split(":")[0]));land.setMinutes(parseInt($scope.connections[ind].landing.split(":")[1]));$scope.connections[ind].newboarding=board;$scope.connections[ind].newlanding=land;$scope.connections[ind].newboarding.setDate($scope.connections[ind].newlanding.getDate());var c=$scope.connections[ind].newboarding;var l=$scope.connections[ind].newlanding;$scope.days.push({boarding:new Date(c),landing:new Date(l)});$scope.days.forEach(function(element,index){$scope.connections[index].newboarding=new Date(element.boarding);$scope.connections[index].newlanding=new Date(element.landing);});}else{var b=$scope.connections[ind].boarding.split("/");var cr=$scope.connections[ind].landing.split("/");var y;var j;var bd;var bd2;var ht=b[2].split(" ");var ct=cr[2].split(" ");j=b[2].split(":");y=cr[2].split(":");if(ht&&j[1]){bd=new Date(ht[0],b[1],b[0]);bd.setHours(j[0]);bd.setMinutes(j[1]);bd2=new Date(ct[0],cr[1],cr[0]);bd2.setHours(y[0]);bd2.setMinutes(y[1]);$scope.days.push({boarding:bd,landing:bd2});}else{$scope.days.push({boarding:new Date(b[2],b[1],b[0]),landing:new Date(cr[2],cr[1],cr[0])});}$scope.days.forEach(function(element,index){$scope.connections[index].newboarding=element.boarding;$scope.connections[index].newlanding=element.landing;});}}for(var i=0;i<$scope.connections.length;i++){doc.addImage(base63Img,"PNG",180,start,50,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.connections[i].airportCodeFrom+")");doc.setTextColor(64);var dates=$rootScope.pad($scope.connections[i].newboarding.getHours())+":"+$rootScope.pad($scope.connections[i].newboarding.getMinutes())+" "+$rootScope.pad($scope.connections[i].newboarding.getDate()).toString()+"/"+$rootScope.pad($scope.connections[i].newboarding.getMonth()+1).toString()+"/"+$scope.connections[i].newboarding.getFullYear().toString();doc.text(260,start+10,dates);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.connections[i].airportCodeTo+")");doc.setTextColor(64);var datesReturn=$rootScope.pad($scope.connections[i].newlanding.getHours())+":"+$rootScope.pad($scope.connections[i].newlanding.getMinutes())+" "+$rootScope.pad($scope.connections[i].newlanding.getDate()).toString()+"/"+$rootScope.pad($scope.connections[i].newlanding.getMonth()+1).toString()+"/"+$scope.connections[i].newlanding.getFullYear().toString();doc.text(360,start+10,datesReturn);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.connections[i].flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.filterBillet[0].class);start=start+20;}}else{doc.addImage(base63Img,"PNG",180,start,55,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.filterBillet[0].airport_code_from+")");var dateBoard=$scope.flight_selected.boarding_date.split("-");var dateBoard1=dateBoard[2].split(" ");var hour=dateBoard1[1].split(":");doc.setTextColor(64);doc.text(260,start+10,hour[0]+":"+hour[1]+" "+dateBoard1[0]+"/"+dateBoard[1]+"/"+dateBoard[0]);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.filterBillet[0].airport_code_to+")");var dateLand=$scope.flight_selected.landing_date.split("-");var dateLand1=dateLand[2].split(" ");var hourL=dateLand1[1].split(":");doc.setTextColor(64);doc.text(360,start+10,hourL[0]+":"+hourL[1]+" "+dateLand1[0]+"/"+dateLand[1]+"/"+dateLand[0]);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.filterBillet[0].flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.filterBillet[0].class);start=start+20;}start=start+20;doc.setTextColor(32);doc.setFontSize(9);var columns=[{title:"Passageiro",dataKey:"name"},{title:"Bagagem",dataKey:"baggage"},{title:"Assento",dataKey:"seat"}];var rows=[];start=start+20;var conectSeat="";var paxs=$scope.getPaxLaTam($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator);var group=$filter("groupBy")(paxs,"pax");var res=Object.keys(group).map(function(key){return group[key];});var inteRes=new Array();for(var j in res){var pax="";var seat=new Array();var baggage="";pax=res[j][0].pax;baggage=res[j][0].baggage;for(var f in res[j]){pax=res[j][f].pax;baggage=res[j][f].baggage;seat.push(res[j][f].sit);}inteRes.push({pax:pax,seat:seat,baggage:baggage});}for(var i=0;i<inteRes.length;i++){var str="";var seat="";var element=inteRes[i];if($scope.filterBillet[0].connection.trim()!="Direto"){for(var g in element.seat){conectSeat+=element.seat[g]+" / ";str=conectSeat;}}else{conectSeat=element.seat[0];str=conectSeat;}if(!element.baggage||element.baggage=="0"){element.baggage="Comprar Bagagem";}var seat=element.seat;if(!seat||seat=="---"){seat="Escolher Assento";}rows.push({name:element.pax,baggage:element.baggage,seat:str});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},baggage:{columnWidth:100,textColor:[255,128,0]},seat:{columnWidth:100,textColor:[255,128,0]}},showHeader:"firstPage",startY:start,headerStyles:{fillColor:[255,255,255],textColor:[0],fontSize:9,lineWidth:1,lineColor:[255,255,255]},styles:{fontSize:8,textColor:96},margin:{left:120},theme:"plain",pageBreak:"avoid"});},drawCell:function drawCell(cell,data){}});if(start>=470){start=30;doc.autoTableAddPage();}else{start=start+200;}if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);$scope.RetConn=$scope.returnFlight.connection;doc.addImage(base59Img,"PNG",120,start,42,17);start=start+40;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{columnWidth:"auto",fontSize:12,overflow:"linebreak",overflowColumns:false},startY:start,margin:{left:40},theme:"plain",pageBreak:"auto",showHeader:"firstPage",addPageContent:function addPageContent(datas){doc.setLineWidth(0.1);doc.setFontSize(9);doc.setTextColor(64);doc.text(180,start,"Código Localizador Smiles");doc.text(390,start,$scope.returnFlight.flightLocator);if($scope.returnFlight.connection.trim()=="Direto"){var y="DIRETO";}else{var y="PARADA(S)";}start=start+30;doc.text(250,start,"DE");doc.text(290,start-10,y);doc.addImage(base44Img,"PNG",280,start-5,67,10);doc.text(360,start,"PARA");var hour=$scope.returnFlight.flight_time.split(":");doc.setTextColor(0);doc.text(300,start+10,hour[0]+"h"+hour[1]+"m");start=start+10;doc.setTextColor(0);doc.setFontSize(12);doc.text(244,start,$scope.returnFlight.airport_code_from);doc.text(360,start,$scope.returnFlight.airport_code_to);start=start+30;if($scope.connectionsReturn.length>0){var board=new Date($scope.returnFlight.boarding_date);$scope.connectionsReturn.newboarding=new Date();$scope.connectionsReturn.newlanding=new Date();$scope.daysReturn=new Array();for(var index=0;index<$scope.connectionsReturn.length;index++){$scope.connectionsReturn[index].newboarding=new Date();$scope.connectionsReturn[index].newlanding=new Date();var land=new Date(board.getFullYear(),board.getMonth(),board.getDate());var verifyReturn=$scope.connectionsReturn[index].boarding.length;if(index>0){if(verifyReturn==5){if(parseInt($scope.connectionsReturn[index].boarding.split(":")[0])<parseInt($scope.connectionsReturn[index-1].landing.split(":")[0])||parseInt($scope.connectionsReturn[index-1].boarding.split(":")[0])>parseInt($scope.connectionsReturn[index-1].landing.split(":")[0])){land.setDate(land.getDate()+1);}}}if(verifyReturn==5){board.setHours(parseInt($scope.connectionsReturn[index].boarding.split(":")[0]));board.setMinutes(parseInt($scope.connectionsReturn[index].boarding.split(":")[1]));land.setHours(parseInt($scope.connectionsReturn[index].landing.split(":")[0]));land.setMinutes(parseInt($scope.connectionsReturn[index].landing.split(":")[1]));$scope.connectionsReturn[index].newboarding=board;$scope.connectionsReturn[index].newlanding=land;$scope.connectionsReturn[index].newboarding.setDate($scope.connectionsReturn[index].newlanding.getDate());var cv=$scope.connectionsReturn[index].newboarding;var lv=$scope.connectionsReturn[index].newlanding;$scope.daysReturn.push({boarding:new Date(cv),landing:new Date(lv)});}else{var br=$scope.connectionsReturn[index].boarding.split("/");var crr=$scope.connectionsReturn[index].landing.split("/");var yr;var jr;var bdr;var bd2r;var htr=br[2].split(" ");var ctr=crr[2].split(" ");jr=br[2].split(":");yr=crr[2].split(":");if(htr&&jr[1]){bdr=new Date(htr[0],br[1],br[0]);bdr.setHours(jr[0]);bdr.setMinutes(jr[1]);bd2r=new Date(ctr[0],crr[1],crr[0]);bd2r.setHours(yr[0]);bd2r.setMinutes(yr[1]);$scope.daysReturn.push({boarding:bdr,landing:bd2r});}else{$scope.daysReturn.push({boarding:new Date(br[2],br[1],br[0]),landing:new Date(crr[2],crr[1],crr[0])});}}}$scope.daysReturn.forEach(function(el,index){$scope.connectionsReturn[index].newboarding=new Date(el.boarding),$scope.connectionsReturn[index].newlanding=new Date(el.landing);});for(var i=0;i<$scope.connectionsReturn.length;i++){doc.addImage(base63Img,"PNG",180,start,50,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.connectionsReturn[i].airportCodeFrom+")");doc.setTextColor(64);var datesR=$rootScope.pad($scope.connectionsReturn[i].newboarding.getHours())+":"+$rootScope.pad($scope.connectionsReturn[i].newboarding.getMinutes())+" "+$rootScope.pad($scope.connectionsReturn[i].newboarding.getDate()).toString()+"/"+$rootScope.pad($scope.connectionsReturn[i].newboarding.getMonth()+1).toString()+"/"+$scope.connectionsReturn[i].newboarding.getFullYear().toString();doc.text(260,start+10,datesR);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.connectionsReturn[i].airportCodeTo+")");doc.setTextColor(64);var datesR1=$rootScope.pad($scope.connectionsReturn[i].newlanding.getHours())+":"+$rootScope.pad($scope.connectionsReturn[i].newlanding.getMinutes())+" "+$rootScope.pad($scope.connectionsReturn[i].newlanding.getDate()).toString()+"/"+$rootScope.pad($scope.connectionsReturn[i].newlanding.getMonth()+1).toString()+"/"+$scope.connectionsReturn[i].newlanding.getFullYear().toString();doc.text(360,start+10,datesR1);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.connectionsReturn[i].flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.returnFlight.class);start=start+20;}}else{doc.addImage(base63Img,"PNG",180,start,55,32);doc.setFontSize(8);doc.setTextColor(0);doc.text(300,start,"("+$scope.returnFlight.airport_code_from+")");var dateBoard=$scope.returnFlight.boarding_date.split("-");var dateBoard1=dateBoard[2].split(" ");var hour=dateBoard1[1].split(":");doc.setTextColor(64);doc.text(260,start+10,hour[0]+":"+hour[1]+" "+dateBoard1[0]+"/"+dateBoard[1]+"/"+dateBoard[0]);doc.addImage(base62Img,"PNG",335,start-5,17,22);doc.setTextColor(0);doc.text(360,start,"("+$scope.returnFlight.airport_code_to+")");var dateLand=$scope.returnFlight.landing_date.split("-");var dateLand1=dateLand[2].split(" ");var hourL=dateLand1[1].split(":");doc.setTextColor(64);doc.text(360,start+10,hourL[0]+":"+hourL[1]+" "+dateLand1[0]+"/"+dateLand[1]+"/"+dateLand[0]);start=start+40;doc.setTextColor(96);doc.text(185,start,$scope.returnFlight.flight);doc.addImage(base61Img,"PNG",300,start-10,12,12);doc.text(315,start-5,"Cabine "+$scope.returnFlight.class);start=start+20;}start=start+20;doc.setTextColor(0);doc.setFontSize(9);var columns=[{title:"Passageiro",dataKey:"name"},{title:"Bagagem",dataKey:"baggage"},{title:"Assento",dataKey:"seat"}];var rows=[];start=start+30;var conectSeatRet="";$scope.paxReturn=$scope.getPaxLaTamReturn($scope.returnFlight.airline,$scope.returnFlight.cards_id,$scope.returnFlight.flight,$scope.returnFlight.flightLocator);var letsR=$filter("groupBy")($scope.paxReturn,"pax");var resultsRet=Object.keys(letsR).map(function(key){return letsR[key];});var inteR=new Array();for(var jn in resultsRet){var seatReturn=new Array();var pax="";var baggage="";for(var fn in resultsRet[jn]){pax=resultsRet[jn][fn].pax;baggage=resultsRet[jn][fn].baggage;seatReturn.push(resultsRet[jn][fn].sit);}inteR.push({pax:pax,seat:seatReturn,baggage:baggage});}for(var i=0;i<inteR.length;i++){var strRet="";var seatRet="";var elementRet=inteR[i];if($scope.RetConn.trim()!="Direto"){for(var h in elementRet.seat){conectSeatRet+=elementRet.seat[h]+" / ";strRet=conectSeatRet;}}else{conectSeatRet=elementRet.seat[0];strRet=conectSeatRet;}elementRet.baggage.toString();if(!elementRet.baggage||elementRet.baggage=="0"){elementRet.baggage="Comprar Bagagem";}if(!strRet||strRet=="---"){strRet="Escolher Assento";}rows.push({name:elementRet.pax,baggage:elementRet.baggage,seat:strRet});}doc.autoTable(columns,rows,{startY:start,margin:{left:120},theme:"plain",pageBreak:"avoid",columnStyles:{name:{columnWidth:200},baggage:{columnWidth:100,textColor:[255,128,0]},seat:{columnWidth:100,textColor:[255,128,0]}},showHeader:"firstPage",drawRow:function drawRow(row,data){},headerStyles:{fillColor:[255,255,255],textColor:0,fontSize:9,lineWidth:1,lineColor:[255,255,255]},styles:{fontSize:8,textColor:96,overflowColumns:false}});for(var r in rows){start=start+15;}}});start=start+50;if(start>=600){start=start*20/100;}}start=start+20;var card_number=$scope.filterBillet[0].tax_card?$scope.filterBillet[0].tax_card.replace(/.(?=.{4})/g,"*"):"";var n=$rootScope.formatNumber($scope.getTotalTaxFlight($scope.filterBillet[0].flightLocator));n=n.toString();var columns=[{title:" Forma de Pagamento (R$) ",dataKey:"name"}];var rows=[{name:" Cartão de Crédito "},{name:" "+($scope.filterBillet[0].tax_providerName?$scope.filterBillet[0].tax_providerName:"")},{name:" R$ "+n+"  em 1x"}];var images=[];doc.autoTable(columns,rows,{columnStyles:{},startY:start,styles:{columnWidth:"auto",fontSize:9},headerStyles:{columnWidth:"auto",fontSize:9},margin:{left:115},theme:"plain",pageBreak:"avoid",showHeader:"firstPage",addPageContent:function addPageContent(data){doc.setFontSize(11);doc.setTextColor(0);}});start=start+90;var columns=[{title:" Dados do Comprador",dataKey:"name"}];var rows=[{name:"Nome: "+$scope.flight_selected.providerName},{name:"Telefone: "+$scope.flight_selected.provider_phone}];var images=[];doc.autoTable(columns,rows,{columnStyles:{},startY:start,styles:{columnWidth:"auto",fontSize:9},headerStyles:{columnWidth:"auto",fontSize:9},margin:{left:115},theme:"plain",overflow:"linebreak",tableWidth:"auto",pageBreak:"auto",showHeader:"firstPage",addPageContent:function addPageContent(data){start=start+70;}});start=doc.autoTableEndPosY()+10;var columns=[{title:" ",dataKey:"names"}];var rows=[{names:""}];if(start>=600){start=20;doc.autoTableAddPage();}doc.autoTable(columns,rows,{startY:start,margin:{left:120},theme:"plain",pageBreak:"avoid",columnStyles:{names:{columnWidth:200},baggage:{columnWidth:100},seat:{columnWidth:70}},drawCell:function drawCell(cell,opts){if(opts.column.dataKey=="names"){images.push({x:cell.textPos.x,y:cell.textPos.y});}},addPageContent:function addPageContent(){var y=images[0].y;doc.addImage(base14Img,"PNG",images[0].x-40,start,450,390);}});doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.multiDownloads!==true){if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}}});});});});});});});});});});};$scope.printBilletGol4=function(flight_selected){$scope.flight_selected=flight_selected||this.onlineflight;$scope.golNovo($scope.flight_selected);};$scope.getTotalTaxFlight=function(flightLocator){var tax=0;$scope.selectedFlights=$filter("filter")($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].is_newborn!="S"&&$scope.selectedFlights[i].flightLocator){tax+=$scope.selectedFlights[i].tax;if($scope.selectedFlights[i].money){tax+=$scope.selectedFlights[i].money;}}}return tax;};$scope.getTotalTaxFlightLatam=function(flightLocator,pax_name){var tax=0;$scope.selectedFlights=$filter("filter")($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].is_newborn!="S"&&pax_name==$scope.selectedFlights[i].pax_name){tax+=$scope.selectedFlights[i].tax_billet;if($scope.selectedFlights[i].money){tax+=$scope.selectedFlights[i].money;}}}return tax;};$scope.getTotalMilesFlight=function(flightLocator,flight){var miles=0;$scope.selectedFlights=$filter("filter")($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].flight==flight){miles+=$scope.selectedFlights[i].miles_used;}}return miles;};$scope.getTotalMilesOrder=function(flightLocator){var miles=0;$scope.selectedFlights=$filter("filter")($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){miles+=$scope.selectedFlights[i].miles_used;}return miles;};$scope.getTotalTaxFlightFlight=function(flightLocator,flight){var tax=0;$scope.selectedFlights=$filter("filter")($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].flight==flight){if($scope.selectedFlights[i].is_newborn!="S"){tax+=$scope.selectedFlights[i].tax_billet;if($scope.selectedFlights[i].money){tax+=$scope.selectedFlights[i].money;}}}}return tax;};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType="blob";xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open("GET",url);xhr.send();};$scope.fillEmailBillet=function(onlineflight){if(onlineflight){$scope.flight_selected=onlineflight;}if($scope.response){if($scope.response.origin=="MMS"){$scope.wsalemail.emailpartner=$scope.selected.client_email;$scope.wsalemail.mailcco=undefined;if($scope.selected.issuing.indexOf("app.voelegal")>-1){$scope.wsalemail.emailpartner='adm@onemilhas.com.br';}if($scope.selected.subClientEmail){$scope.wsalemail.subClientEmail=$scope.selected.subClientEmail;}$scope.wsalemail.mailcc="";$scope.wsalemail.subject="] - Bilhete - ";$scope.wsalemail.emailContent="Olá "+$scope.selected.client_name+",<br><br>";for(var i in $scope.onlineflights){$scope.wsalemail.subject+="LOC "+$scope.onlineflights[i].flightLocator+" - ";}$scope.wsalemail.subject+=" - ID: "+$scope.selected.id;if($scope.flight_selected.airline=="GOL"){$scope.selectedFlights=$filter("filter")($scope.onlineflights,"GOL");if($scope.selectedFlights.length>0){$scope.wsalemail.emailContent+="Segue bilhete em anexo.<br>"+"Obs.:  Informamos que a GOL, como medida de segurança, pode solicitar os dados do proprietário das milhas no momento de seu embarque. Segue os dados abaixo e também no seu bilhete em anexo.<br>"+"Caso o passageiro tenha algum problema no momento do embarque, entre em contato<br>"+"imediatamente com a equipe, providenciaremos a regularização do<br>"+"embarque, ou reacomodação. Bilhetes comprados no balcão sem<br>"+"autorização da nossa equipe, não serão ressarcidos pela. Essas medidas<br>"+"visam evitar transtornos para os nossos clientes. Grato pela compreensão.<br><br>";}for(var i in $scope.selectedFlights){var card_number=$scope.removeFromEmail.indexOf($scope.selectedFlights[i].card_number)>-1?" - ":$scope.selectedFlights[i].card_number;var providerName=$scope.removeFromEmail.indexOf($scope.selectedFlights[i].providerName)>-1?" - ":$scope.selectedFlights[i].providerName;$scope.wsalemail.emailContent+="SMILES:"+card_number+"<br>NOME:"+providerName+"<br><br>";if($scope.flight_selected.airline==$scope.selectedFlights[i].airline&&$scope.flight_selected.flightLocator==$scope.selectedFlights[i].flightLocator){if($scope.selectedFlights[i].seat!=" --- "){var pax_name=$scope.selectedFlights[i].pax_name;if($scope.selectedFlights[i].paxLastName){pax_name+=" "+$scope.selectedFlights[i].paxLastName;}if($scope.selectedFlights[i].paxAgnome){pax_name+=" "+$scope.selectedFlights[i].paxAgnome;}}}}}else if($scope.flight_selected.airline=="AZUL"){$scope.wsalemail.emailContent+="Segue em anexo bilhete Azul, conforme solicitado!<br>"+"Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: suporte@onemilhas.com.br<br>"+"Tel: (31) 3972-1929<br><br>";"Att<br>Equipe";}else if($scope.flight_selected.airline=="AVIANCA"){$scope.wsalemail.emailContent+="Segue em anexo bilhete Avianca, conforme solicitado!<br>";for(var i in $scope.onlineflights){if($scope.flight_selected.airline==$scope.onlineflights[i].airline&&$scope.flight_selected.flightLocator==$scope.onlineflights[i].flightLocator){if($scope.onlineflights[i].seat!=" --- "){var pax_name=$scope.onlineflights[i].pax_name;if($scope.onlineflights[i].paxLastName){pax_name+=" "+$scope.onlineflights[i].paxLastName;}if($scope.onlineflights[i].paxAgnome){pax_name+=" "+$scope.onlineflights[i].paxAgnome;}$scope.wsalemail.emailContent+="<br>Voo: "+$scope.onlineflights[i].flight+", pax:"+pax_name+", assento: "+$scope.onlineflights[i].seat+"<br>";}}}$scope.wsalemail.emailContent+="Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: suporte@onemilhas.com.br<br>"+"Tel: (31) 3972-1929<br><br>";"Att<br>Equipe";}else if($scope.flight_selected.airline=="LATAM"){$scope.wsalemail.emailContent+="Segue em anexo confirmação de compra Latam, conforme solicitado!<br>";"Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: suporte@onemilhas.com.br<br>"+"Tel: (31) 3972-1929<br><br>";"Att<br>Equipe";}$scope.wsalemail.emailContent+="<br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(" ");var connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"HH:mm:ss")+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"HH:mm:ss")+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_code_from+"</td><td>"+$scope.resume_flights[i].airport_code_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter("date")($scope.resume_paxs[i].birhtdate,"dd/MM/yyyy")+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";}else{$scope.wsalemail.emailpartner=$scope.selected.client_email;$scope.wsalemail.mailcco=undefined;if($scope.selected.issuing.indexOf("app.voelegal")>-1){$scope.wsalemail.emailpartner='adm@onemilhas.com.br';}if($scope.selected.subClientEmail){$scope.wsalemail.subClientEmail=$scope.selected.subClientEmail;}$scope.wsalemail.mailcc="";$scope.wsalemail.subject="Bilhete - ";$scope.wsalemail.emailContent="Olá "+$scope.selected.client_name+",<br><br>";for(var i in $scope.onlineflights){$scope.wsalemail.subject+="LOC "+$scope.onlineflights[i].flightLocator+" - ";}$scope.wsalemail.subject+=" - ID: "+$scope.selected.id;if($scope.flight_selected.airline=="GOL"){$scope.selectedFlights=$filter("filter")($scope.onlineflights,"GOL");if($scope.selectedFlights.length>0){$scope.wsalemail.emailContent+="Segue bilhete em anexo.<br>"+"Obs.:  Informamos que a GOL, como medida de segurança, pode solicitar os dados do proprietário das milhas no momento de seu embarque. Segue os dados abaixo e também no seu bilhete em anexo.<br>"+"Caso o passageiro tenha algum problema no momento do embarque, entre em contato<br>"+"imediatamente com a equipe ONE MILHAS, providenciaremos a regularização do<br>"+"embarque, ou reacomodação. Bilhetes comprados no balcão sem<br>"+"autorização da nossa equipe, não serão ressarcidos pela ONE MILHAS. Essas medidas<br>"+"visam evitar transtornos para os nossos clientes. Grato pela compreensão.<br><br>";}for(var i in $scope.selectedFlights){var card_number=$scope.removeFromEmail.indexOf($scope.selectedFlights[i].card_number)>-1?" - ":$scope.selectedFlights[i].card_number;var providerName=$scope.removeFromEmail.indexOf($scope.selectedFlights[i].providerName)>-1?" - ":$scope.selectedFlights[i].providerName;$scope.wsalemail.emailContent+="SMILES:"+card_number+"<br>NOME:"+providerName+"<br><br>";if($scope.flight_selected.airline==$scope.selectedFlights[i].airline&&$scope.flight_selected.flightLocator==$scope.selectedFlights[i].flightLocator){if($scope.selectedFlights[i].seat!=" --- "){var pax_name=$scope.selectedFlights[i].pax_name;if($scope.selectedFlights[i].paxLastName){pax_name+=" "+$scope.selectedFlights[i].paxLastName;}if($scope.selectedFlights[i].paxAgnome){pax_name+=" "+$scope.selectedFlights[i].paxAgnome;}}}}}else if($scope.flight_selected.airline=="AZUL"){$scope.wsalemail.emailContent+="Segue em anexo bilhete Azul, conforme solicitado!<br>"+"Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: emissao@onemilhas.com.br<br>"+"Tel: (31) 3972-9601<br><br>";"Att<br>Equipe One Milhas";}else if($scope.flight_selected.airline=="AVIANCA"){$scope.wsalemail.emailContent+="Segue em anexo bilhete Avianca, conforme solicitado!<br>";for(var i in $scope.onlineflights){if($scope.flight_selected.airline==$scope.onlineflights[i].airline&&$scope.flight_selected.flightLocator==$scope.onlineflights[i].flightLocator){if($scope.onlineflights[i].seat!=" --- "){var pax_name=$scope.onlineflights[i].pax_name;if($scope.onlineflights[i].paxLastName){pax_name+=" "+$scope.onlineflights[i].paxLastName;}if($scope.onlineflights[i].paxAgnome){pax_name+=" "+$scope.onlineflights[i].paxAgnome;}$scope.wsalemail.emailContent+="<br>Voo: "+$scope.onlineflights[i].flight+", pax:"+pax_name+", assento: "+$scope.onlineflights[i].seat+"<br>";}}}$scope.wsalemail.emailContent+="Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: emissao@onemilhas.com.br<br>"+"Tel: (31) 3972-9601<br><br>";"Att<br>Equipe One Milhas";}else if($scope.flight_selected.airline=="LATAM"){$scope.wsalemail.emailContent+="Segue em anexo confirmação de compra Latam, conforme solicitado!<br>";"Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: emissao@onemilhas.com.br<br>"+"Tel: (31) 3972-9601<br><br>";"Att<br>Equipe One Milhas";}$scope.wsalemail.emailContent+="<br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(" ");var connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"HH:mm:ss")+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"HH:mm:ss")+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_code_from+"</td><td>"+$scope.resume_flights[i].airport_code_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter("date")($scope.resume_paxs[i].birhtdate,"dd/MM/yyyy")+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";}}else{$scope.wsalemail.emailpartner=$scope.selected.client_email;$scope.wsalemail.mailcco=undefined;if($scope.selected.issuing.indexOf("app.voelegal")>-1){$scope.wsalemail.emailpartner='adm@onemilhas.com.br';}if($scope.selected.subClientEmail){$scope.wsalemail.subClientEmail=$scope.selected.subClientEmail;}$scope.wsalemail.mailcc="";$scope.wsalemail.subject="Bilhete - ";$scope.wsalemail.emailContent="Olá "+$scope.selected.client_name+",<br><br>";for(var i in $scope.onlineflights){$scope.wsalemail.subject+="LOC "+$scope.onlineflights[i].flightLocator+" - ";}$scope.wsalemail.subject+=" - ID: "+$scope.selected.id;if($scope.flight_selected.airline=="GOL"){$scope.selectedFlights=$filter("filter")($scope.onlineflights,"GOL");if($scope.selectedFlights.length>0){$scope.wsalemail.emailContent+="Segue bilhete em anexo.<br>"+"Obs.:  Informamos que a GOL, como medida de segurança, pode solicitar os dados do proprietário das milhas no momento de seu embarque. Segue os dados abaixo e também no seu bilhete em anexo.<br>"+"Caso o passageiro tenha algum problema no momento do embarque, entre em contato<br>"+"imediatamente com a equipe ONE MILHAS, providenciaremos a regularização do<br>"+"embarque, ou reacomodação. Bilhetes comprados no balcão sem<br>"+"autorização da nossa equipe, não serão ressarcidos pela ONE MILHAS. Essas medidas<br>"+"visam evitar transtornos para os nossos clientes. Grato pela compreensão.<br><br>";}for(var i in $scope.selectedFlights){var card_number=$scope.removeFromEmail.indexOf($scope.selectedFlights[i].card_number)>-1?" - ":$scope.selectedFlights[i].card_number;var providerName=$scope.removeFromEmail.indexOf($scope.selectedFlights[i].providerName)>-1?" - ":$scope.selectedFlights[i].providerName;$scope.wsalemail.emailContent+="SMILES:"+card_number+"<br>NOME:"+providerName+"<br><br>";if($scope.flight_selected.airline==$scope.selectedFlights[i].airline&&$scope.flight_selected.flightLocator==$scope.selectedFlights[i].flightLocator){if($scope.selectedFlights[i].seat!=" --- "){var pax_name=$scope.selectedFlights[i].pax_name;if($scope.selectedFlights[i].paxLastName){pax_name+=" "+$scope.selectedFlights[i].paxLastName;}if($scope.selectedFlights[i].paxAgnome){pax_name+=" "+$scope.selectedFlights[i].paxAgnome;}}}}}else if($scope.flight_selected.airline=="AZUL"){$scope.wsalemail.emailContent+="Segue em anexo bilhete Azul, conforme solicitado!<br>"+"Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: emissao@onemilhas.com.br<br>"+"Tel: (31) 3972-9601<br><br>";"Att<br>Equipe One Milhas";}else if($scope.flight_selected.airline=="AVIANCA"){$scope.wsalemail.emailContent+="Segue em anexo bilhete Avianca, conforme solicitado!<br>";for(var i in $scope.onlineflights){if($scope.flight_selected.airline==$scope.onlineflights[i].airline&&$scope.flight_selected.flightLocator==$scope.onlineflights[i].flightLocator){if($scope.onlineflights[i].seat!=" --- "){var pax_name=$scope.onlineflights[i].pax_name;if($scope.onlineflights[i].paxLastName){pax_name+=" "+$scope.onlineflights[i].paxLastName;}if($scope.onlineflights[i].paxAgnome){pax_name+=" "+$scope.onlineflights[i].paxAgnome;}$scope.wsalemail.emailContent+="<br>Voo: "+$scope.onlineflights[i].flight+", pax:"+pax_name+", assento: "+$scope.onlineflights[i].seat+"<br>";}}}$scope.wsalemail.emailContent+="Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: emissao@onemilhas.com.br<br>"+"Tel: (31) 3972-9601<br><br>";"Att<br>Equipe One Milhas";}else if($scope.flight_selected.airline=="LATAM"){$scope.wsalemail.emailContent+="Segue em anexo confirmação de compra Latam, conforme solicitado!<br>";"Qualquer situação envolvendo o bilhete, favor entrar em contato: <br>"+"E-mail: emissao@onemilhas.com.br<br>"+"Tel: (31) 3972-9601<br><br>";"Att<br>Equipe One Milhas";}$scope.wsalemail.emailContent+="<br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(" ");var connections="";for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].boarding_date),"HH:mm:ss")+"</td><td>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"dd/MM/yyyy")+"<br>"+$filter("date")($rootScope.findDate($scope.resume_flights[i].landing_date),"HH:mm:ss")+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_code_from+"</td><td>"+$scope.resume_flights[i].airport_code_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter("date")($scope.resume_paxs[i].birhtdate,"dd/MM/yyyy")+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";}$scope.previousIndex=$scope.tabindex;$scope.tabindex=5;if($scope.multiDownloads!=true){$scope.$apply();}};$scope.checkPaxName=function(name){var listNames=["JUNIOR","NETO","FILHO","SOBRINHO"];return listNames.indexOf(name)>-1;};$scope.getPaxName=function(name,segundo_nome,field){if($scope.selected&&name){if($scope.selected.airline){if($scope.selected.airline.indexOf("LATAM")>-1||$scope.selected.airline.indexOf("AZUL")>-1||$scope.selected.airline.indexOf("GOL")>-1){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_to;})[0];var novo_nome="";var nome=name.split(" ");for(var i in nome){if(from&&to){if(from.internacional=="1"||to.internacional=="1"){novo_nome+=nome[i];}else{if(i=="0"&&field=="primeiro"||i==nome.length-1&&field=="segundo"||$scope.checkPaxName(nome[parseInt(i)+1])){novo_nome+="<font color='#F70909'>"+nome[i]+"</font>";}else if(!segundo_nome&&i==nome.length-1){novo_nome+="<font color='#F70909'>"+nome[i]+"</font>";}else{novo_nome+=nome[i];}}}else{if(i=="0"&&field=="primeiro"||i==nome.length-1&&field=="segundo"||$scope.checkPaxName(nome[parseInt(i)+1])){novo_nome+="<font color='#F70909'>"+nome[i]+"</font>";}else if(!segundo_nome&&i==nome.length-1){novo_nome+="<font color='#F70909'>"+nome[i]+"</font>";}else{novo_nome+=nome[i];}}if(i!=nome.length){novo_nome+=" ";}}return novo_nome;}}}return name;};$scope.latamNovo=function(flight_selected){if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);if($scope.returnFlight){if($rootScope.findDate($scope.returnFlight.boarding_date)<$rootScope.findDate($scope.flight_selected.boarding_date)){$scope.flight_selected=angular.copy($scope.returnFlight);}}}$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{data:$scope.flight_selected},function(result){$scope.connections=jQuery.parseJSON(result).dataset;$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator)},function(result){$scope.connectionsReturn=jQuery.parseJSON(result).dataset;$scope.connecty="";$scope.seats=[];var toTime=$filter("date")($rootScope.findDate($scope.flight_selected.landing_date),"HH:mm");var flightTime=$scope.flight_selected.flight_time;$scope.paxLatamConn=$scope.getPaxLaTam($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator);$scope.seat=[];$scope.connect="";var doc=new jsPDF("p","pt");var start=10;var connection=$scope.flight_selected.connection.split(" ");$scope.connectionx=[];connection.forEach(function(element){if(element!=""&&element!=""&&element!=" "&&element!=" "){$scope.connectionx.push(element);}});doc.margin=0.5;doc.setFont("times");$scope.toDataUrl("images/LATAM2.png",function(base64Img){$scope.toDataUrl("images/AVIAO.png",function(base32Img){$scope.toDataUrl("images/ONEWORLD.jpg",function(base16Img){$scope.toDataUrl("images/SETA.png",function(base8Img){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.flight_selected.airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.flight_selected.airport_code_to;})[0];start=start+60;doc.setFontSize(12);doc.setFontType("bold");var dat=new Date(angular.copy($scope.flight_selected.boarding_date));var datRet=new Date(angular.copy($scope.flight_selected.landing_date));doc.text($filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.boarding_date))+" "+dat.getFullYear(),40,start);doc.addImage(base8Img,"JPEG",120,start-10,7,7);doc.text($filter("date")($rootScope.findDate($scope.flight_selected.landing_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.landing_date))+" "+datRet.getFullYear(),140,start);doc.setFontType("normal");doc.text("Viagem para ",220,start);doc.setFontType("bold");doc.setFontSize(10);doc.text($scope.flight_selected.airport_code_to.toUpperCase(),290,start);doc.setFontType("normal");start=start+5;doc.setDrawColor(32);doc.rect(40,start,500,1);start=start+10;doc.text(40,start,"PREPARADO PARA");start=start+15;doc.setFontType("bold");doc.setFontSize(12);doc.addImage(base64Img,"JPEG",320,start-22,160,60);doc.addImage(base16Img,"JPEG",460,start-12,70,40);$scope.paxLatam=$scope.getPaxLaTam($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator);var group=$filter("groupBy")($scope.paxLatam,"pax");var res=Object.keys(group).map(function(key){return group[key];});var inteRes=new Array();for(var jn in res){var pax="",ticket_code="";var seat="";pax=res[jn][0].pax;ticket_code=res[jn][0].ticket_code;inteRes.push({pax:pax,seat:seat.toString(),ticket_code:ticket_code});}for(var i in inteRes){var element=inteRes[i];doc.text(40,start,element.pax);start=start+10;}start=start+10;doc.setFontType("normal");doc.setFontSize(10);doc.text(40,start,"CÓDIGO DA RESERVA");doc.setFontSize(9);doc.text(180,start,$scope.flight_selected.flightLocator);start=start+5;doc.setDrawColor(32);doc.rect(40,start,500,1);start=start+20;var columns=[{title:"",dataKey:"name"}];var rows=[];var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{columnWidth:"auto",fontSize:12},margin:{top:start-30,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+20,20,20);doc.text("SAÍDA: ",60,start+30);doc.setFontType("bold");doc.text($scope.getWeekday(new Date($scope.flight_selected.boarding_date))+" "+$filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.boarding_date)),100,start+30);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(170);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+30);doc.setTextColor(0);doc.setFontSize(10);start=start+40;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(210,start,340,190,"FD");doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.flight_selected.airport_code_from,220,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.flight_selected.airport_code_to,340,start+20);doc.setTextColor(0);doc.setFontSize(10);doc.setTextColor(96);doc.text(from.city.name,220,start+30);doc.text(to.city.name,340,start+30);doc.setTextColor(0);var timeBoarding=new Date($scope.flight_selected.boarding_date);var timeLanding=new Date($scope.flight_selected.landing_date);doc.setFontSize(10);doc.setTextColor(96);doc.text("Partindo às (hora local):",220,start+50);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeBoarding.getHours())+":"+$rootScope.pad(timeBoarding.getMinutes()),220,start+70);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",220,start+90);doc.setTextColor(96);doc.setFontSize(9);doc.text("Chegando às (hora local):",335,start+50);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeLanding.getHours())+":"+$rootScope.pad(timeLanding.getMinutes()),335,start+70);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",335,start+90);doc.setTextColor(0);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(210,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(330,start+40,330,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);start=start+10;doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.flight_selected.flight);doc.setFontType("normal");start=start+10;doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.flight_selected.airline+" AIRLINES");start=start+30;var fl=$scope.flight_selected.flight_time.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.flight_selected.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+40;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];var group=$filter("groupBy")($scope.paxLatam,"pax");var resultGroup=Object.keys(group).map(function(key){return group[key];});for(var jn in resultGroup){rows.push({name:resultGroup[jn][0].pax,seat:resultGroup[jn][0].sit,ticket:resultGroup[jn][0].ticket_code});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},showHeader:"firstPage",headerStyles:{fillColor:[224,224,224],fontSize:8},styles:{fontSize:8,textColor:96},margin:{top:start,left:40},theme:"grid",pageBreak:"avoid"});start=doc.autoTableEndPosY();doc.setDrawColor(64);doc.setLineWidth(2);start=start+10;doc.line(40,start,550,start);if(start>=570){start=20;doc.autoTableAddPage();}}});doc.setFontSize(8);start=start+40;if($scope.connections.length>0){$scope.seat.push($scope.flight_selected.seat);if($scope.flight_selected.connections){for(var i=0;i<$scope.flight_selected.connections.length;i++){$scope.seat.push($scope.flight_selected.connections[i].seat);}}var classFlight=$scope.flight_selected.class;if(classFlight=="Executiva"){classFlight="Premium Business ( U )";}else{classFlight+=" ( T ) ";}var dateReportDeparture=new Date($scope.flight_selected.boarding_date);for(var conn=0;conn<$scope.connections.length;conn++){var newboarding=new Date($scope.connections[conn].boarding.split(" ")[0].split("/")[2]+"-"+$scope.connections[conn].boarding.split(" ")[0].split("/")[1]+"-"+$scope.connections[conn].boarding.split(" ")[0].split("/")[0]+" "+$scope.connections[conn].boarding.split(" ")[1]);var newlanding=new Date($scope.connections[conn].landing.split(" ")[0].split("/")[2]+"-"+$scope.connections[conn].landing.split(" ")[0].split("/")[1]+"-"+$scope.connections[conn].landing.split(" ")[0].split("/")[0]+" "+$scope.connections[conn].landing.split(" ")[1]);$scope.connections[conn].newboarding=newboarding;$scope.connections[conn].newlanding=newlanding;var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connections[conn].airportCodeFrom;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connections[conn].airportCodeTo;})[0];dateReportDeparture=$scope.connections[conn].newboarding;$scope.connect=$scope.connectionx[conn];var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{fontSize:12},margin:{top:start,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+10,20,20);doc.text("SAÍDA: ",60,start+20);doc.setFontType("bold");doc.text($scope.getWeekday(dateReportDeparture)+" "+$filter("date")(dateReportDeparture,"dd")+" "+$scope.getLaTamMonth(dateReportDeparture),100,start+20);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(160);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+20);doc.setFontSize(10);start=start+30;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(200,start,350,190,"FD");doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(200,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(320,start+40,320,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.connections[conn].airportCodeFrom,210,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.connections[conn].airportCodeTo,340,start+20);doc.setTextColor(0);doc.setFontSize(8);doc.setFontSize(10);doc.setTextColor(96);doc.text(from.city.name,210,start+30);doc.text(to.city.name,340,start+30);doc.setTextColor(0);start=start+10;doc.setTextColor(96);doc.setFontSize(10);doc.text("Partindo às (hora local):",210,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.connections[conn].boarding.split(" ")[1],210,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",210,start+80);doc.text("Chegando às (hora local):",330,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.connections[conn].landing.split(" ")[1],330,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",330,start+80);doc.setTextColor(0);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);start=start+10;doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.connections[conn].flight);doc.setFontType("normal");doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.flight_selected.airline+" AIRLINES");start=start+30;var fl=$scope.connections[conn].flightTime.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.flight_selected.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+40;var fullName=$scope.flight_selected.pax_name+" "+$scope.flight_selected.paxLastName;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];var lets=$filter("groupBy")($scope.paxLatamConn,"pax");var results=Object.keys(lets).map(function(key){return lets[key];});var inter=new Array();for(var j in results){var seat=new Array();var pax="",ticket_code="";for(var f in results[j]){pax=results[j][f].pax;ticket_code=results[j][f].ticket_code;seat.push(results[j][f].sit);}inter.push({pax:pax,seat:seat,ticket_code:ticket_code});}for(var i in inter){var element=inter[i];rows.push({name:element.pax,seat:element.seat[conn],ticket:element.ticket_code});}doc.autoTable(columns,rows,{startY:start,pageBreak:"auto",margin:{left:40},theme:"grid",showHeader:"firstPage",columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},styles:{overflow:"linebreak",overflowColumns:false,fontSize:8,textColor:96},headerStyles:{fillColor:[224,224,224],fontSize:8},createdCell:function createdCell(cell,data){}});doc.setDrawColor(64);doc.setLineWidth(2);start=doc.autoTableEndPosY();start=start+10;doc.line(40,start,550,start);start=start+20;if(start>=610){start=60;doc.autoTableAddPage();}},drawCell:function drawCell(cell,data){}});}}if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);$scope.Return=angular.copy($scope.returnFlight);var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.returnFlight.airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.returnFlight.airport_code_to;})[0];if($scope.flight_selected.seat){var seat=$scope.flight_selected.seat;}else{var seat="";}start=start+10;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{fontSize:12},margin:{top:start,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+20,20,20);doc.text("SAÍDA: ",60,start+30);doc.setFontType("bold");doc.text($scope.getWeekday(new Date($scope.returnFlight.boarding_date))+" "+$filter("date")(new Date($scope.returnFlight.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.returnFlight.boarding_date)),100,start+30);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(160);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+30);doc.setFontSize(10);start=start+40;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(200,start,350,190,"FD");doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(200,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(320,start+40,320,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.returnFlight.airport_code_from,210,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.returnFlight.airport_code_to,340,start+20);doc.setTextColor(0);doc.setFontSize(8);start=start+10;doc.setFontSize(10);doc.setTextColor(96);doc.text(from.city.name,210,start+20);doc.text(to.city.name,340,start+20);doc.setTextColor(0);var timeBoarding=new Date($scope.returnFlight.boarding_date);var timeLanding=new Date($scope.returnFlight.landing_date);doc.setTextColor(96);doc.setFontSize(10);doc.text("Partindo às (hora local):",210,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeBoarding.getHours())+":"+$rootScope.pad(timeBoarding.getMinutes()),210,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",210,start+80);doc.text("Chegando às (hora local):",330,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeLanding.getHours())+":"+$rootScope.pad(timeLanding.getMinutes()),330,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",330,start+80);doc.setTextColor(0);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);start=start+20;doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.returnFlight.flight);doc.setFontType("normal");doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.returnFlight.airline+" AIRLINES");start=start+30;var fl=$scope.returnFlight.flight_time.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.returnFlight.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+30;var fullName=$scope.returnFlight.pax_name+" "+$scope.returnFlight.paxLastName;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];$scope.paxReturn=$scope.getPaxLaTamReturn($scope.returnFlight.airline,$scope.returnFlight.cards_id,$scope.returnFlight.flight,$scope.returnFlight.flightLocator);var letsR=$filter("groupBy")($scope.paxReturn,"pax");var resultsRet=Object.keys(letsR).map(function(key){return letsR[key];});var inteR=new Array();for(var jn in resultsRet){var seatReturn=new Array();var pax="",ticket_code="";for(var fn in resultsRet[jn]){pax=resultsRet[jn][fn].pax;ticket_code=resultsRet[jn][fn].ticket_code;seatReturn.push(resultsRet[jn][fn].sit);}inteR.push({pax:pax,seat:seatReturn,ticket_code:ticket_code});}for(var i in inteR){var element=inteR[i];rows.push({name:element.pax,seat:element.seat[0],ticket:element.ticket_code});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},showHeader:"firstPage",headerStyles:{fillColor:[224,224,224],fontSize:8},styles:{fontSize:8,textColor:96},startY:start,margin:{left:40},theme:"grid",pageBreak:"avoid"});doc.setDrawColor(64);doc.setLineWidth(2);start=doc.autoTableEndPosY();start=start+10;doc.line(40,start,550,start);start=start+20;}});if(start>=610){start=20;doc.autoTableAddPage();}if($scope.connectionsReturn.length>0){$scope.seats.push($scope.returnFlight.seat);if($scope.returnFlight.connections){for(var i=0;i<$scope.returnFlight.connections.length;i++){$scope.seats.push($scope.returnFlight.connections[i].seat);}}var ConnectionsReturn=$scope.connectionsReturn;var classFlight=$scope.returnFlight.class;if(classFlight=="Executiva"){classFlight="Premium Business ( U )";}else{classFlight+=" ( T ) ";}var dateReportReturn=new Date($scope.Return.boarding_date);var counts=0;var board=new Date($scope.Return.boarding_date);$scope.daysReturn=new Array();for(var connection in $scope.connectionsReturn){var newboarding=new Date($scope.connectionsReturn[connection].boarding.split(" ")[0].split("/")[2]+"-"+$scope.connectionsReturn[connection].boarding.split(" ")[0].split("/")[1]+"-"+$scope.connectionsReturn[connection].boarding.split(" ")[0].split("/")[0]+" "+$scope.connectionsReturn[connection].boarding.split(" ")[1]);var newlanding=new Date($scope.connectionsReturn[connection].landing.split(" ")[0].split("/")[2]+"-"+$scope.connectionsReturn[connection].landing.split(" ")[0].split("/")[1]+"-"+$scope.connectionsReturn[connection].landing.split(" ")[0].split("/")[0]+" "+$scope.connectionsReturn[connection].landing.split(" ")[1]);$scope.connectionsReturn[connection].newboarding=newboarding;$scope.connectionsReturn[connection].newlanding=newlanding;var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connectionsReturn[connection].airportCodeFrom;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connectionsReturn[connection].airportCodeTo;})[0];dateReportReturn=$scope.connectionsReturn[connection].newboarding;counts++;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];start=start+10;doc.autoTable(columns,rows,{columnStyles:{},styles:{fontSize:12},margin:{top:start,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+20,20,20);doc.text("SAÍDA: ",60,start+30);doc.setFontType("bold");doc.text($scope.getWeekday(dateReportReturn)+" "+$filter("date")(new Date(dateReportReturn),"dd")+" "+$scope.getLaTamMonth(dateReportReturn),100,start+30);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(160);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+30);doc.setFontSize(10);start=start+40;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(200,start,350,190,"FD");doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(200,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(320,start+40,320,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.connectionsReturn[connection].airportCodeFrom,210,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.connectionsReturn[connection].airportCodeTo,340,start+20);doc.setTextColor(0);doc.setFontSize(8);doc.setFontSize(10);doc.setTextColor(96);start=start+10;doc.text(from.city.name,210,start+20);doc.text(to.city.name,340,start+20);doc.setTextColor(96);doc.setFontSize(10);doc.text("Partindo às (hora local):",210,start+40);doc.setFontSize(13);doc.setTextColor(32);$scope.connectionsReturn[connection].newboarding=new Date($scope.connectionsReturn[connection].newboarding);doc.text($scope.connectionsReturn[connection].boarding.split(" ")[1],210,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",210,start+80);doc.text("Chegando às (hora local):",330,start+40);doc.setFontSize(13);doc.setTextColor(32);$scope.connectionsReturn[connection].newlanding=new Date($scope.connectionsReturn[connection].newlanding);doc.text($scope.connectionsReturn[connection].landing.split(" ")[1],330,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",330,start+80);doc.setTextColor(0);doc.setTextColor(0);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.connectionsReturn[connection].flight);doc.setFontType("normal");doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.Return.airline+" AIRLINES");start=start+30;var fl=$scope.connectionsReturn[connection].flightTime.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.Return.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+40;doc.setFontSize(8);start=start+10;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];var lets=$filter("groupBy")($scope.paxReturn,"pax");var resultsReturn=Object.keys(lets).map(function(key){return lets[key];});var inter=new Array();for(var jn in resultsReturn){var seatReturn=new Array();var pax="",ticket_code="";for(var fn in resultsReturn[jn]){pax=resultsReturn[jn][fn].pax;ticket_code=resultsReturn[jn][fn].ticket_code;seatReturn.push(resultsReturn[jn][fn].sit);}inter.push({pax:pax,seat:seatReturn,ticket_code:ticket_code});}for(var i in inter){var element=inter[i];rows.push({name:element.pax,seat:element.seat[connection],ticket:element.ticket_code});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},showHeader:"firstPage",headerStyles:{fillColor:[224,224,224],fontSize:8},styles:{fontSize:8,textColor:96},startY:start,margin:{left:40},theme:"grid",pageBreak:"avoid"});doc.setDrawColor(64);doc.setLineWidth(2);start=doc.autoTableEndPosY();start=start+10;doc.line(40,start,550,start);start=start+20;},drawCell:function drawCell(cell,data){}});if(start>610){doc.autoTableAddPage();start=60;counts=0;}}}}if($scope.flight_selected.isBreak=="Quebrado"){return logger.logError("Este trecho esta quebrado!");}doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.multiDownloads!==true){if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}}});});});});});});};$scope.latamVelho=function(flight_selected){if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);if($scope.returnFlight){if($rootScope.findDate($scope.returnFlight.boarding_date)<$rootScope.findDate($scope.flight_selected.boarding_date)){$scope.flight_selected=angular.copy($scope.returnFlight);}}}$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{data:$scope.flight_selected},function(result){$scope.connections=jQuery.parseJSON(result).dataset;$.post("../backend/application/index.php?rota=/loadConnectionsFlight",{hashId:$scope.session.hashId,data:$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator)},function(result){$scope.connectionsReturn=jQuery.parseJSON(result).dataset;$scope.connecty="";$scope.seats=[];var toTime=$filter("date")($rootScope.findDate($scope.flight_selected.landing_date),"HH:mm");var flightTime=$scope.flight_selected.flight_time;$scope.paxLatamConn=$scope.getPaxLaTam($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator);$scope.seat=[];$scope.connect="";var doc=new jsPDF("p","pt");var start=10;var connection=$scope.flight_selected.connection.split(" ");$scope.connectionx=[];connection.forEach(function(element){if(element!=""&&element!=""&&element!=" "&&element!=" "){$scope.connectionx.push(element);}});doc.margin=0.5;doc.setFont("times");$scope.toDataUrl("images/LATAM2.png",function(base64Img){$scope.toDataUrl("images/AVIAO.png",function(base32Img){$scope.toDataUrl("images/ONEWORLD.jpg",function(base16Img){$scope.toDataUrl("images/SETA.png",function(base8Img){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.flight_selected.airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.flight_selected.airport_code_to;})[0];start=start+60;doc.setFontSize(12);doc.setFontType("bold");var dat=new Date(angular.copy($scope.flight_selected.boarding_date));var datRet=new Date(angular.copy($scope.flight_selected.landing_date));doc.text($filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.boarding_date))+" "+dat.getFullYear(),40,start);doc.addImage(base8Img,"JPEG",120,start-10,7,7);doc.text($filter("date")($rootScope.findDate($scope.flight_selected.landing_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.landing_date))+" "+datRet.getFullYear(),140,start);doc.setFontType("normal");doc.text("Viagem para ",220,start);doc.setFontType("bold");doc.setFontSize(10);doc.text($scope.flight_selected.airport_code_to.toUpperCase(),290,start);doc.setFontType("normal");start=start+5;doc.setDrawColor(32);doc.rect(40,start,500,1);start=start+10;doc.text(40,start,"PREPARADO PARA");start=start+15;doc.setFontType("bold");doc.setFontSize(12);doc.addImage(base64Img,"JPEG",320,start-22,160,60);doc.addImage(base16Img,"JPEG",460,start-12,70,40);$scope.paxLatam=$scope.getPaxLaTam($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.flightLocator);var group=$filter("groupBy")($scope.paxLatam,"pax");var res=Object.keys(group).map(function(key){return group[key];});var inteRes=new Array();for(var jn in res){var pax="",ticket_code="";var seat="";pax=res[jn][0].pax;ticket_code=res[jn][0].ticket_code;inteRes.push({pax:pax,seat:seat.toString(),ticket_code:ticket_code});}for(var i in inteRes){var element=inteRes[i];doc.text(40,start,element.pax);start=start+10;}start=start+10;doc.setFontType("normal");doc.setFontSize(10);doc.text(40,start,"CÓDIGO DA RESERVA");doc.setFontSize(9);doc.text(180,start,$scope.flight_selected.flightLocator);start=start+5;doc.setDrawColor(32);doc.rect(40,start,500,1);start=start+20;var columns=[{title:"",dataKey:"name"}];var rows=[];var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{columnWidth:"auto",fontSize:12},margin:{top:start-30,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+20,20,20);doc.text("SAÍDA: ",60,start+30);doc.setFontType("bold");doc.text($scope.getWeekday(new Date($scope.flight_selected.boarding_date))+" "+$filter("date")($rootScope.findDate($scope.flight_selected.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.flight_selected.boarding_date)),100,start+30);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(170);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+30);doc.setTextColor(0);doc.setFontSize(10);start=start+40;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(210,start,340,190,"FD");doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.flight_selected.airport_code_from,220,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.flight_selected.airport_code_to,340,start+20);doc.setTextColor(0);doc.setFontSize(10);doc.setTextColor(96);doc.text(from.city.name,220,start+30);doc.text(to.city.name,340,start+30);doc.setTextColor(0);var timeBoarding=new Date($scope.flight_selected.boarding_date);var timeLanding=new Date($scope.flight_selected.landing_date);doc.setFontSize(10);doc.setTextColor(96);doc.text("Partindo às (hora local):",220,start+50);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeBoarding.getHours())+":"+$rootScope.pad(timeBoarding.getMinutes()),220,start+70);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",220,start+90);doc.setTextColor(96);doc.setFontSize(9);doc.text("Chegando às (hora local):",335,start+50);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeLanding.getHours())+":"+$rootScope.pad(timeLanding.getMinutes()),335,start+70);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",335,start+90);doc.setTextColor(0);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(210,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(330,start+40,330,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);start=start+10;doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.flight_selected.flight);doc.setFontType("normal");start=start+10;doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.flight_selected.airline+" AIRLINES");start=start+30;var fl=$scope.flight_selected.flight_time.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.flight_selected.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+40;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];var group=$filter("groupBy")($scope.paxLatam,"pax");var resultGroup=Object.keys(group).map(function(key){return group[key];});for(var jn in resultGroup){rows.push({name:resultGroup[jn][0].pax,seat:resultGroup[jn][0].sit,ticket:resultGroup[jn][0].ticket_code});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},showHeader:"firstPage",headerStyles:{fillColor:[224,224,224],fontSize:8},styles:{fontSize:8,textColor:96},margin:{top:start,left:40},theme:"grid",pageBreak:"avoid"});start=doc.autoTableEndPosY();doc.setDrawColor(64);doc.setLineWidth(2);start=start+10;doc.line(40,start,550,start);if(start>=570){start=20;doc.autoTableAddPage();}}});doc.setFontSize(8);start=start+40;if($scope.connections.length>0){$scope.seat.push($scope.flight_selected.seat);if($scope.flight_selected.connections){for(var i=0;i<$scope.flight_selected.connections.length;i++){$scope.seat.push($scope.flight_selected.connections[i].seat);}}var classFlight=$scope.flight_selected.class;if(classFlight=="Executiva"){classFlight="Premium Business ( U )";}else{classFlight+=" ( T ) ";}var dateReportDeparture=new Date($scope.flight_selected.boarding_date);var count=0;var board=new Date($scope.flight_selected.boarding_date);$scope.connections.newboarding=new Date();$scope.connections.newlanding=new Date();$scope.days=new Array();for(var ind=0;ind<$scope.connections.length;ind++){$scope.connections[ind].newboarding=new Date();$scope.connections[ind].newlanding=new Date();var land=new Date(board.getFullYear(),board.getMonth(),board.getDate());board.setHours(parseInt($scope.connections[ind].boarding.split(":")[0]));board.setMinutes(parseInt($scope.connections[ind].boarding.split(":")[1]));land.setHours(parseInt($scope.connections[ind].landing.split(":")[0]));land.setMinutes(parseInt($scope.connections[ind].landing.split(":")[1]));if(ind>0){if(parseInt($scope.connections[ind].boarding.split(":")[0])<parseInt($scope.connections[ind-1].landing.split(":")[0])||$scope.connections[ind-1].landing.split(":")[0]<$scope.connections[ind-1].boarding.split(":")[0]){land.setDate(land.getDate()+1);}}$scope.connections[ind].newboarding=board;$scope.connections[ind].newlanding=land;$scope.connections[ind].newboarding.setDate($scope.connections[ind].newlanding.getDate());var c=$scope.connections[ind].newboarding;var l=$scope.connections[ind].newlanding;$scope.days.push({boarding:new Date(c),landing:new Date(l)});}$scope.days.forEach(function(element,index){$scope.connections[index].newboarding=new Date(element.boarding);$scope.connections[index].newlanding=new Date(element.landing);});for(var conn=0;conn<$scope.connections.length;conn++){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connections[conn].airportCodeFrom;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connections[conn].airportCodeTo;})[0];dateReportDeparture=$scope.connections[conn].newboarding;$scope.connect=$scope.connectionx[conn];count++;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{fontSize:12},margin:{top:start,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+10,20,20);doc.text("SAÍDA: ",60,start+20);doc.setFontType("bold");doc.text($scope.getWeekday(dateReportDeparture)+" "+$filter("date")(dateReportDeparture,"dd")+" "+$scope.getLaTamMonth(dateReportDeparture),100,start+20);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(160);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+20);doc.setFontSize(10);start=start+30;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(200,start,350,190,"FD");doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(200,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(320,start+40,320,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.connections[conn].airportCodeFrom,210,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.connections[conn].airportCodeTo,340,start+20);doc.setTextColor(0);doc.setFontSize(8);doc.setFontSize(10);doc.setTextColor(96);doc.text(from.city.name,210,start+30);doc.text(to.city.name,340,start+30);doc.setTextColor(0);start=start+10;doc.setTextColor(96);doc.setFontSize(10);doc.text("Partindo às (hora local):",210,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad($scope.connections[conn].newboarding.getHours())+":"+$rootScope.pad($scope.connections[conn].newboarding.getMinutes()),210,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",210,start+80);doc.text("Chegando às (hora local):",330,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad($scope.connections[conn].newlanding.getHours())+":"+$rootScope.pad($scope.connections[conn].newlanding.getMinutes()),330,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",330,start+80);doc.setTextColor(0);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);start=start+10;doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.connections[conn].flight);doc.setFontType("normal");doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.flight_selected.airline+" AIRLINES");start=start+30;var fl=$scope.connections[conn].flightTime.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.flight_selected.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+40;var fullName=$scope.flight_selected.pax_name+" "+$scope.flight_selected.paxLastName;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];var lets=$filter("groupBy")($scope.paxLatamConn,"pax");var results=Object.keys(lets).map(function(key){return lets[key];});var inter=new Array();for(var j in results){var seat=new Array();var pax="",ticket_code="";for(var f in results[j]){pax=results[j][f].pax;ticket_code=results[j][f].ticket_code;seat.push(results[j][f].sit);}inter.push({pax:pax,seat:seat,ticket_code:ticket_code});}for(var i in inter){var element=inter[i];rows.push({name:element.pax,seat:element.seat[conn],ticket:element.ticket_code});}doc.autoTable(columns,rows,{startY:start,pageBreak:"auto",margin:{left:40},theme:"grid",showHeader:"firstPage",columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},styles:{overflow:"linebreak",overflowColumns:false,fontSize:8,textColor:96},headerStyles:{fillColor:[224,224,224],fontSize:8},createdCell:function createdCell(cell,data){}});doc.setDrawColor(64);doc.setLineWidth(2);start=doc.autoTableEndPosY();start=start+10;doc.line(40,start,550,start);start=start+20;if(start>=610){start=60;doc.autoTableAddPage();}},drawCell:function drawCell(cell,data){}});}}if($scope.getIsReturn($scope.flight_selected)){$scope.returnFlight=$scope.getReturnFlight($scope.flight_selected.airline,$scope.flight_selected.cards_id,$scope.flight_selected.flight,$scope.flight_selected.airport_code_from,$scope.flight_selected.airport_code_to,$scope.flight_selected.flightLocator);$scope.Return=angular.copy($scope.returnFlight);var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.returnFlight.airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.returnFlight.airport_code_to;})[0];if($scope.flight_selected.seat){var seat=$scope.flight_selected.seat;}else{var seat="";}start=start+10;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];doc.autoTable(columns,rows,{columnStyles:{},styles:{fontSize:12},margin:{top:start,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+20,20,20);doc.text("SAÍDA: ",60,start+30);doc.setFontType("bold");doc.text($scope.getWeekday(new Date($scope.returnFlight.boarding_date))+" "+$filter("date")(new Date($scope.returnFlight.boarding_date),"dd")+" "+$scope.getLaTamMonth(new Date($scope.returnFlight.boarding_date)),100,start+30);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(160);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+30);doc.setFontSize(10);start=start+40;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(200,start,350,190,"FD");doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(200,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(320,start+40,320,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.returnFlight.airport_code_from,210,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.returnFlight.airport_code_to,340,start+20);doc.setTextColor(0);doc.setFontSize(8);start=start+10;doc.setFontSize(10);doc.setTextColor(96);doc.text(from.city.name,210,start+20);doc.text(to.city.name,340,start+20);doc.setTextColor(0);var timeBoarding=new Date($scope.returnFlight.boarding_date);var timeLanding=new Date($scope.returnFlight.landing_date);doc.setTextColor(96);doc.setFontSize(10);doc.text("Partindo às (hora local):",210,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeBoarding.getHours())+":"+$rootScope.pad(timeBoarding.getMinutes()),210,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",210,start+80);doc.text("Chegando às (hora local):",330,start+40);doc.setFontSize(13);doc.setTextColor(32);doc.text($rootScope.pad(timeLanding.getHours())+":"+$rootScope.pad(timeLanding.getMinutes()),330,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",330,start+80);doc.setTextColor(0);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);start=start+20;doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.returnFlight.flight);doc.setFontType("normal");doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.returnFlight.airline+" AIRLINES");start=start+30;var fl=$scope.returnFlight.flight_time.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.returnFlight.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+30;var fullName=$scope.returnFlight.pax_name+" "+$scope.returnFlight.paxLastName;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];$scope.paxReturn=$scope.getPaxLaTamReturn($scope.returnFlight.airline,$scope.returnFlight.cards_id,$scope.returnFlight.flight,$scope.returnFlight.flightLocator);var letsR=$filter("groupBy")($scope.paxReturn,"pax");var resultsRet=Object.keys(letsR).map(function(key){return letsR[key];});var inteR=new Array();for(var jn in resultsRet){var seatReturn=new Array();var pax="",ticket_code="";for(var fn in resultsRet[jn]){pax=resultsRet[jn][fn].pax;ticket_code=resultsRet[jn][fn].ticket_code;seatReturn.push(resultsRet[jn][fn].sit);}inteR.push({pax:pax,seat:seatReturn,ticket_code:ticket_code});}for(var i in inteR){var element=inteR[i];rows.push({name:element.pax,seat:element.seat[0],ticket:element.ticket_code});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},showHeader:"firstPage",headerStyles:{fillColor:[224,224,224],fontSize:8},styles:{fontSize:8,textColor:96},startY:start,margin:{left:40},theme:"grid",pageBreak:"avoid"});doc.setDrawColor(64);doc.setLineWidth(2);start=doc.autoTableEndPosY();start=start+10;doc.line(40,start,550,start);start=start+20;}});if(start>=610){start=20;doc.autoTableAddPage();}if($scope.connectionsReturn.length>0){$scope.seats.push($scope.returnFlight.seat);if($scope.returnFlight.connections){for(var i=0;i<$scope.returnFlight.connections.length;i++){$scope.seats.push($scope.returnFlight.connections[i].seat);}}var ConnectionsReturn=$scope.connectionsReturn;var classFlight=$scope.returnFlight.class;if(classFlight=="Executiva"){classFlight="Premium Business ( U )";}else{classFlight+=" ( T ) ";}var dateReportReturn=new Date($scope.Return.boarding_date);var counts=0;var _board=new Date($scope.Return.boarding_date);$scope.daysReturn=new Array();for(var index=0;index<$scope.connectionsReturn.length;index++){var land=new Date(_board.getFullYear(),_board.getMonth(),_board.getDate());_board.setHours(parseInt($scope.connectionsReturn[index].boarding.split(":")[0]));_board.setMinutes(parseInt($scope.connectionsReturn[index].boarding.split(":")[1]));land.setHours(parseInt($scope.connectionsReturn[index].landing.split(":")[0]));land.setMinutes(parseInt($scope.connectionsReturn[index].landing.split(":")[1]));if(index>0){if(parseInt($scope.connectionsReturn[index].boarding.split(":")[0])<parseInt($scope.connectionsReturn[index-1].landing.split(":")[0])||parseInt($scope.connectionsReturn[index-1].boarding.split(":")[0])>parseInt($scope.connectionsReturn[index-1].landing.split(":")[0])){land.setDate(land.getDate()+1);}}$scope.connectionsReturn[index].newboarding=_board;$scope.connectionsReturn[index].newlanding=land;$scope.connectionsReturn[index].newboarding.setDate($scope.connectionsReturn[index].newlanding.getDate());var cv=$scope.connectionsReturn[index].newboarding;$scope.daysReturn.push({boarding:new Date(cv),landing:new Date($scope.connectionsReturn[index].newlanding)});}$scope.daysReturn.forEach(function(el,index){$scope.connectionsReturn[index].newboarding=new Date(el.boarding),$scope.connectionsReturn[index].newlanding=new Date(el.landing);});for(var connection in $scope.connectionsReturn){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connectionsReturn[connection].airportCodeFrom;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.connectionsReturn[connection].airportCodeTo;})[0];dateReportReturn=$scope.connectionsReturn[connection].newboarding;counts++;var columns=[{title:"",dataKey:"name"},{title:"",dataKey:"data"},{title:"",dataKey:"hour"}];var rows=[{name:"",data:"",hour:""}];start=start+10;doc.autoTable(columns,rows,{columnStyles:{},styles:{fontSize:12},margin:{top:start,left:40},theme:"plain",pageBreak:"avoid",addPageContent:function addPageContent(data){doc.setFontSize(12);doc.addImage(base32Img,"JPEG",40,start+20,20,20);doc.text("SAÍDA: ",60,start+30);doc.setFontType("bold");doc.text($scope.getWeekday(dateReportReturn)+" "+$filter("date")(new Date(dateReportReturn),"dd")+" "+$scope.getLaTamMonth(dateReportReturn),100,start+30);doc.setFontType("normal");doc.setFontSize(9);doc.setTextColor(160);doc.text("Por favor, verifique o horário da decolagem dos vôos.",240,start+30);doc.setFontSize(10);start=start+40;doc.setDrawColor(224);doc.setFillColor(224,224,224);doc.rect(40,start,500,190,"FD");doc.setDrawColor(128);doc.setFillColor(255,255,255);doc.rect(200,start,350,190,"FD");doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(200,start+40,450,start+40);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(320,start+40,320,start+190);doc.setDrawColor(192,192,192);doc.setLineWidth(0.1);doc.line(450,start,450,start+190);doc.setFontSize(13);doc.setTextColor(32);doc.text($scope.connectionsReturn[connection].airportCodeFrom,210,start+20);doc.addImage(base8Img,"JPEG",320,start+15,7,7);doc.text($scope.connectionsReturn[connection].airportCodeTo,340,start+20);doc.setTextColor(0);doc.setFontSize(8);doc.setFontSize(10);doc.setTextColor(96);start=start+10;doc.text(from.city.name,210,start+20);doc.text(to.city.name,340,start+20);doc.setTextColor(96);doc.setFontSize(10);doc.text("Partindo às (hora local):",210,start+40);doc.setFontSize(13);doc.setTextColor(32);$scope.connectionsReturn[connection].newboarding=new Date($scope.connectionsReturn[connection].newboarding);doc.text($scope.connectionsReturn[connection].boarding,210,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",210,start+80);doc.text("Chegando às (hora local):",330,start+40);doc.setFontSize(13);doc.setTextColor(32);$scope.connectionsReturn[connection].newlanding=new Date($scope.connectionsReturn[connection].newlanding);doc.text($scope.connectionsReturn[connection].landing,330,start+60);doc.setFontSize(9);doc.setTextColor(96);doc.text("Terminal:"+"\n"+"Não disponível",330,start+80);doc.setTextColor(0);doc.setTextColor(0);doc.setFontSize(9);doc.setTextColor(96);doc.text("Aeronave: "+"",460,start+10);doc.text("Distância (em milhas"+"\n"+"ORIGEM/DESTINO): "+"\n"+"",460,start+30);doc.text("Escala: "+"",460,start+60);doc.text("Refeições: "+"",460,start+80);doc.setTextColor(0);doc.setFontSize(12);doc.text(50,start,"LATAM AIRLINES"+"\n"+"GROUP");start=start+30;doc.setFontType("bold");doc.text(50,start,$scope.connectionsReturn[connection].flight);doc.setFontType("normal");doc.setFontSize(10);doc.setTextColor(64);start=start+20;doc.text(50,start,"Operado por\n"+$scope.Return.airline+" AIRLINES");start=start+30;var fl=$scope.connectionsReturn[connection].flightTime.split(":");doc.text(50,start,"Duração\n"+fl[0]+"hr(s)"+" "+fl[1]+"min(s)");start=start+30;doc.text(50,start,"Classe\n"+$scope.Return.class);start=start+30;doc.text(50,start,"Status\n Confirmado");start=start+40;doc.setFontSize(8);start=start+10;var columns=[{title:"Nome do Passageiro",dataKey:"name"},{title:"Assentos",dataKey:"seat"},{title:"Recibo(s) de Bilhete(s) Eletrônico(s):",dataKey:"ticket"}];var rows=[];var lets=$filter("groupBy")($scope.paxReturn,"pax");var resultsReturn=Object.keys(lets).map(function(key){return lets[key];});var inter=new Array();for(var jn in resultsReturn){var seatReturn=new Array();var pax="",ticket_code="";for(var fn in resultsReturn[jn]){pax=resultsReturn[jn][fn].pax;ticket_code=resultsReturn[jn][fn].ticket_code;seatReturn.push(resultsReturn[jn][fn].sit);}inter.push({pax:pax,seat:seatReturn,ticket_code:ticket_code});}for(var i in inter){var element=inter[i];rows.push({name:element.pax,seat:element.seat[connection],ticket:element.ticket_code});}doc.autoTable(columns,rows,{columnStyles:{name:{columnWidth:200},seat:{columnWidth:155},ticket:{columnWidth:155}},showHeader:"firstPage",headerStyles:{fillColor:[224,224,224],fontSize:8},styles:{fontSize:8,textColor:96},startY:start,margin:{left:40},theme:"grid",pageBreak:"avoid"});doc.setDrawColor(64);doc.setLineWidth(2);start=doc.autoTableEndPosY();start=start+10;doc.line(40,start,550,start);start=start+20;},drawCell:function drawCell(cell,data){}});if(start>610){doc.autoTableAddPage();start=60;counts=0;}}}}if($scope.flight_selected.isBreak=="Quebrado"){return logger.logError("Este trecho esta quebrado!");}doc.save($scope.flight_selected.flightLocator+".pdf");if($scope.multiDownloads!==true){if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}}});});});});});});};$scope.printBilletLaTam2=function(flight_selected){$scope.flight_selected=flight_selected||this.onlineflight;$scope.latamNovo($scope.flight_selected);};$scope.trim=function(str){return str.replace(/^\s+|\s+$/g,"");};$scope.groupBy=function(xs,key){return xs.reduce(function(rv,x){(rv[x[key]]=rv[x[key]]||[]).push(x);return rv;},{});};$scope.changeClassFlights=function(flight){for(var i in $scope.onlineflights){if($scope.onlineflights[i].boarding_date==flight.boarding_date&&$scope.onlineflights[i].airport_code_from==flight.airport_code_from&&$scope.onlineflights[i].airport_code_to==flight.airport_code_to){$scope.onlineflights[i].class=flight.class;}}};$scope.getLaTamMonth=function(date){var month=date.getMonth();switch(month){case 0:return"JAN";case 1:return"FEV";case 2:return"MAR";case 3:return"ABR";case 4:return"MAI";case 5:return"JUN";case 6:return"JUL";case 7:return"AGO";case 8:return"SET";case 9:return"OUT";case 10:return"NOV";case 11:return"DEZ";}};$scope.getWeekday=function(date){var day=new Date(date).getDay();switch(day){case 0:return"Domingo";case 1:return"Segunda-feira";case 2:return"Terça-feira";case 3:return"Quarta-feira";case 4:return"Quinta-feira";case 5:return"Sexta-feira";case 6:return"Sábado";}};$scope.getBlueWeekday=function(date){var day=date.getDay();switch(day){case 0:return"Dom";case 1:return"Seg";case 2:return"Ter";case 3:return"Qua";case 4:return"Qui";case 5:return"Sex";case 6:return"Sáb";}};$scope.getMonth=function(date){var month=new Date(date).getMonth();switch(month){case 0:return"Janeiro";case 1:return"Fevereiro";case 2:return"Março";case 3:return"Abril";case 4:return"Maio";case 5:return"Junho";case 6:return"Julho";case 7:return"Agosto";case 8:return"Setembro";case 9:return"Outubro";case 10:return"Novembro";case 11:return"Dezembro";}};$scope.getReturn=function(airline,cards_id,flight){var pax=[];$scope.filterBillet=$filter("filter")($scope.onlineflights,airline);for(var i in $scope.filterBillet){if($scope.filterBillet[i].cards_id==cards_id&&$scope.filterBillet[i].flight!=flight){if($scope.connectionsReturn.length>0){pax.push({from:"   ",pax:$scope.filterBillet[i].pax_name+" "+$scope.filterBillet[i].paxLastName+" "+$scope.filterBillet[i].paxAgnome,froTo:$scope.filterBillet[i].airport_code_from+" - "+$scope.connectionsReturn[0].airportCodeTo,number:"  ",sit:" "+$scope.getSeat($scope.filterBillet[i])+" "});for(var j=1;j<=$scope.connectionsReturn.length-1;j++){pax.push({from:"   ",pax:"Conexão ("+j+")",froTo:$scope.connectionsReturn[j].airportCodeFrom+" - "+$scope.connectionsReturn[j].airportCodeTo,number:"  ",sit:$scope.getConnectionSeat($scope.filterBillet[i],j)});}}else{pax.push({from:"   ",pax:$scope.filterBillet[i].pax_name+" "+$scope.filterBillet[i].paxLastName+" "+$scope.filterBillet[i].paxAgnome,froTo:$scope.filterBillet[i].airport_code_from+" - "+$scope.filterBillet[i].airport_code_to,number:"  ",sit:" "+$scope.getSeat($scope.filterBillet[i])+" "});}}}return pax;};$scope.getSeat=function(flight){for(var s in $scope.onlineflights){if($scope.onlineflights[s].flight==flight.flight&&$scope.onlineflights[s].boarding_date==flight.boarding_date&&$scope.onlineflights[s].pax_name==flight.pax_name&&$scope.onlineflights[s].paxLastName==flight.paxLastName&&$scope.onlineflights[s].paxAgnome==flight.paxAgnome&&$scope.onlineflights[s].airport_code_from==flight.airport_code_from){if($scope.onlineflights[s].is_newborn=="S"){return"Colo";}return $scope.onlineflights[s].seat;}}return" --- ";};$scope.getConnectionSeat=function(flight,j){for(var s in $scope.onlineflights){if($scope.onlineflights[s].flight==flight.flight&&$scope.onlineflights[s].boarding_date==flight.boarding_date&&$scope.onlineflights[s].pax_name==flight.pax_name&&$scope.onlineflights[s].paxLastName==flight.paxLastName&&$scope.onlineflights[s].paxAgnome==flight.paxAgnome&&$scope.onlineflights[s].airport_code_from==flight.airport_code_from){if($scope.onlineflights[s].is_newborn=="S"){return"Colo";}if($scope.onlineflights[s].connections){return $scope.onlineflights[s].connections[j-1].seat;}else{return" --- ";}}}return" --- ";};$scope.getIsReturn=function(flight_selected){for(var i in $scope.onlineflights){if($scope.onlineflights[i].flightLocator==flight_selected.flightLocator&&$scope.onlineflights[i].airline==flight_selected.airline&&$scope.onlineflights[i].flight!=flight_selected.flight&&$scope.onlineflights[i].boarding_date!=flight_selected.boarding_date)return true;}return false;};$scope.getPax=function(airline,cards_id,flight,flightLocator){var pax=[];$scope.bagagge="";$scope.filterBillet=$filter("filter")($scope.onlineflights,airline);for(var i in $scope.filterBillet){if($scope.filterBillet[i].cards_id==cards_id&&$scope.filterBillet[i].flight==flight&&$scope.filterBillet[i].flightLocator==flightLocator){var fullName=$scope.filterBillet[i].pax_name;if($scope.filterBillet[i].paxLastName){fullName+=" "+$scope.filterBillet[i].paxLastName;}if($scope.filterBillet[i].paxAgnome){fullName+=" "+$scope.filterBillet[i].paxAgnome;}var paxName=fullName.split(" ");var name="";if(paxName[paxName.length-1]==""||paxName[paxName.length-1]==" "){paxName.splice(paxName.length-1,1);}if(paxName.length>2){if($scope.checkPaxName(paxName[paxName.length-1])){paxName.splice(paxName.length-1,1);}}for(var n in paxName){name+=paxName[n]+" ";}if($scope.filterBillet[i].baggage==0){$scope.bagagge="";}else{$scope.bagagge="23Kg";}if($scope.connections.length>0){pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.connections[0].airportCodeTo,cardNumber:$scope.bagagge,sit:" "+$scope.getSeat($scope.filterBillet[i])+" "});for(var j=1;j<=$scope.connections.length-1;j++){pax.push({pax:"Conexão",center:$scope.connections[j].airportCodeFrom+" - "+$scope.connections[j].airportCodeTo,cardNumber:$scope.bagagge,sit:" "+$scope.getConnectionSeat($scope.filterBillet[i],j)+" "});}}else{pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.filterBillet[i].airport_code_to,cardNumber:$scope.bagagge,sit:" "+$scope.getSeat($scope.filterBillet[i])+" "});}}}return pax;};$scope.getPaxLaTam=function(airline,cards_id,flight,flightLocator){var pax=[];$scope.bagagge="";$scope.filterBillet=$filter("filter")($scope.onlineflights,airline);for(var i in $scope.filterBillet){if($scope.filterBillet[i].cards_id==cards_id&&$scope.filterBillet[i].flight==flight&&$scope.filterBillet[i].flightLocator==flightLocator){var fullName=$scope.filterBillet[i].pax_name;if($scope.filterBillet[i].paxLastName){fullName+=" "+$scope.filterBillet[i].paxLastName;}if($scope.filterBillet[i].paxAgnome){fullName+=" "+$scope.filterBillet[i].paxAgnome;}var paxName=fullName.split(" ");var name="";if(paxName[paxName.length-1]==""||paxName[paxName.length-1]==" "){paxName.splice(paxName.length-1,1);}for(var n in paxName){name+=paxName[n]+" ";}if($scope.filterBillet[i].baggage==0){$scope.bagagge="";}else{$scope.bagagge="23Kg";}if($scope.connections&&$scope.connections!=""&&$scope.connections!=null){if($scope.connections.length>0){pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.connections[0].airportCodeTo,cardNumber:$scope.bagagge,sit:$scope.getSeat($scope.filterBillet[i])+" ",ticket_code:$scope.filterBillet[i].ticket_code,baggage:$scope.filterBillet[i].baggage,connection:$scope.filterBillet[i].connection});for(var j=1;j<=$scope.connections.length-1;j++){pax.push({pax:name,center:$scope.connections[j].airportCodeFrom+" - "+$scope.connections[j].airportCodeTo,cardNumber:$scope.bagagge,sit:$scope.getConnectionSeat($scope.filterBillet[i],j)+" ",ticket_code:$scope.filterBillet[i].ticket_code,baggage:$scope.filterBillet[i].baggage,connection:$scope.filterBillet[i].connection});}}else{pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.filterBillet[i].airport_code_to,cardNumber:$scope.bagagge,sit:$scope.getSeat($scope.filterBillet[i])+" ",ticket_code:$scope.filterBillet[i].ticket_code,baggage:$scope.filterBillet[i].baggage,connection:$scope.filterBillet[i].connection});}}else{pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.filterBillet[i].airport_code_to,cardNumber:$scope.bagagge,sit:$scope.getSeat($scope.filterBillet[i])+" ",ticket_code:$scope.filterBillet[i].ticket_code,baggage:$scope.filterBillet[i].baggage,connection:$scope.filterBillet[i].connection});}}}return pax;};$scope.getPaxLaTamReturn=function(airline,cards_id,flight,flightLocator){var pax=[];$scope.baggage="";$scope.returnFlight=$filter("filter")($scope.onlineflights,airline);for(var i in $scope.returnFlight){if($scope.returnFlight[i].is_newborn!="S"){if($scope.returnFlight[i].cards_id==cards_id&&$scope.returnFlight[i].flight==flight&&$scope.returnFlight[i].flightLocator==flightLocator){var fullName=$scope.returnFlight[i].pax_name;if($scope.returnFlight[i].paxLastName){fullName+=" "+$scope.returnFlight[i].paxLastName;}if($scope.returnFlight[i].paxAgnome){fullName+=" "+$scope.returnFlight[i].paxAgnome;}var paxName=fullName.split(" ");var name="";if(paxName[paxName.length-1]==""||paxName[paxName.length-1]==" "){paxName.splice(paxName.length-1,1);}for(var n in paxName){name+=paxName[n]+" ";}if($scope.returnFlight[i].baggage==0){$scope.baggage="";}else{$scope.baggage="23Kg";}if($scope.connectionsReturn&&$scope.connectionsReturn!=""&&$scope.connectionsReturn!=null){if($scope.connectionsReturn.length>0){pax.push({pax:name,center:$scope.returnFlight[i].airport_code_from+"-"+$scope.connectionsReturn[0].airportCodeTo,cardNumber:$scope.bagagge,sit:$scope.getSeat($scope.returnFlight[i])+" ",ticket_code:$scope.returnFlight[i].ticket_code,baggage:$scope.returnFlight[i].baggage});for(var j=1;j<=$scope.connectionsReturn.length-1;j++){pax.push({pax:name,center:$scope.connectionsReturn[j].airportCodeFrom+" - "+$scope.connectionsReturn[j].airportCodeTo,cardNumber:$scope.bagagge,sit:$scope.getConnectionSeat($scope.returnFlight[i],j)+" ",ticket_code:$scope.returnFlight[i].ticket_code,baggage:$scope.returnFlight[i].baggage});}}else{pax.push({pax:name,center:$scope.returnFlight[i].airport_code_from+"-"+$scope.returnFlight[i].airport_code_to,cardNumber:$scope.bagagge,sit:$scope.getSeat($scope.returnFlight[i])+" ",ticket_code:$scope.returnFlight[i].ticket_code,baggage:$scope.returnFlight[i].baggage});}}else{pax.push({pax:name,center:$scope.returnFlight[i].airport_code_from+"-"+$scope.returnFlight[i].airport_code_to,cardNumber:$scope.bagagge,sit:$scope.getSeat($scope.returnFlight[i])+" ",ticket_code:$scope.returnFlight[i].ticket_code,baggage:$scope.returnFlight[i].baggage});}}}}return pax;};$scope.getPaxReturn=function(airline,cards_id,flight,flightLocator){var pax=[];$scope.baggage="";$scope.filterBillet=$filter("filter")($scope.onlineflights,airline);for(var i in $scope.filterBillet){if($scope.filterBillet[i].cards_id==cards_id&&$scope.filterBillet[i].flight==flight&&$scope.filterBillet[i].flightLocator==flightLocator){var fullName=$scope.filterBillet[i].pax_name;if($scope.filterBillet[i].paxLastName){fullName+=" "+$scope.filterBillet[i].paxLastName;}if($scope.filterBillet[i].paxAgnome){fullName+=" "+$scope.filterBillet[i].paxAgnome;}var paxName=fullName.split(" ");var name="";if(paxName[paxName.length-1]==""||paxName[paxName.length-1]==" "){paxName.splice(paxName.length-1,1);}if(paxName.length>2){if($scope.checkPaxName(paxName[paxName.length-1])){paxName.splice(paxName.length-1,1);}}for(var n in paxName){name+=paxName[n]+" ";}if($scope.filterBillet[i].baggage==0){$scope.baggage="";}else{$scope.baggage="23Kg";}if($scope.connectionsReturn.length>0){pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.connectionsReturn[0].airportCodeTo,cardNumber:$scope.baggage,sit:" "+$scope.getSeat($scope.filterBillet[i])+" "});for(var j=1;j<=$scope.connectionsReturn.length-1;j++){pax.push({pax:"Conexão",center:$scope.connectionsReturn[j].airportCodeFrom+" - "+$scope.connectionsReturn[j].airportCodeTo,cardNumber:$scope.baggage,sit:" "+$scope.getConnectionSeat($scope.filterBillet[i],j)+" "});}}else{pax.push({pax:name,center:$scope.filterBillet[i].airport_code_from+"-"+$scope.filterBillet[i].airport_code_to,cardNumber:$scope.baggage,sit:" "+$scope.getSeat($scope.filterBillet[i])+" "});}}}return pax;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredOnlineOrders=$filter("orderBy")($scope.onlineorder,rowName);return $scope.onOrderChange();};$scope.search_flight=function(){$scope.filteredonlineflights=$filter("filter")($scope.onlineflights,$scope.searchKeywords);};$scope.order_flight=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredonlineflights=$filter("orderBy")($scope.onlineflights,rowName);};$scope.search_miles=function(){$scope.currentMiles=$filter("filter")($scope.flight_miles,$scope.searchKeywordsMiles);};$scope.order_miles=function(rowName){$scope.searchMilesOrder=rowName;$scope.searchMilesOrderDown=undefined;$scope.currentPageMiles=1;$scope.loadOrderMilesFunction();};$scope.order_miles_down=function(rowName){$scope.searchMilesOrder=undefined;$scope.searchMilesOrderDown=rowName;$scope.currentPageMiles=1;$scope.loadOrderMilesFunction();};$scope.onOrderMilesChange=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.back=function(){$scope.tabindex=$scope.tabindex-1;$scope.searchKeywords="";};$scope.next=function(){$scope.tabindex=$scope.tabindex+1;};$scope.getStatusOrder=function(order){if(order.status=="ESPERA"){return"Espera";}if(order.commercialStatus&&order.status!="EMITIDO"){if(order.status=="PRIORIDADE"){return"PRIORIDADE";}return"Liberado Comercial";}switch(order.status){case"PENDENTE":return"Pendente";case"RESERVA":return"Reserva";case"EMITIDO":return"Emitido";case"PRIORIDADE":return"Pendente";case"VOEB2B":return"VOEB2B";case"ENVIADO":return"Enviado";case"CANCELADO":return"Cancelado";case"FALHA EMISSAO":return"FALHA EMISSAO";case"ESPERA":return"Espera";case"VERIFICADO":return"Verificado";case"ESPERA VLR":return"Espera comercial - Valor";case"ESPERA LIM":return"Espera Comercial - Limite";case"ESPERA PGTO":return"Espera pagamento";case"ESPERA LIM VLR":return"Comercial Limite/Valor";case"DADOS_PASSAGEIRO_INVALIDO":return"DADOS PASSAGEIRO INVALIDO";case"SITE_CIA_FORA_AR":return"SITE CIA FORA AR";case"RETARIFADA":return"RETARIFADA";case"ANT":return"Antecipado";case"BLOQ":return"Bloqueado";case"ANT BLOQ":return"Antecipado/Bloqueado";}};$scope.findColor=function(order){switch(order.status){case"PENDENTE":return"";case"PRIORIDADE":return"";case"VOEB2B":return"";case"ESPERA VLR":return"";case"ESPERA LIM VLR":return"";case"DADOS_PASSAGEIRO_INVALIDO":return"";case"SITE_CIA_FORA_AR":return"";case"RETARIFADA":return"";case"ANT":return"";case"BLOQ":return"";case"ESPERA LIM":return"";case"ESPERA PGTO":return"";case"ANT BLOQ":return"";case"EMITIDO":if(order.showSms&&!order.sms){return"#FFA26D";}return"#9DCE9D";case"ENVIADO":return"#9DCE9D";case"RESERVA":return"#9BB3DC";case"CANCELADO":return"#F38E8E";case"FALHA EMISSAO":return"#F38E8E";case"VERIFICADO":if(order.showSms&&!order.sms){return"#FFA26D";}}};$scope.findClass=function(onlineflight){if(onlineflight.flightLocator==undefined||onlineflight.flightLocator==""||(onlineflight.airline=="TAM"||onlineflight.airline=="LATAM")&&(onlineflight.ticket_code==undefined||onlineflight.ticket_code==""))return"btn btn-danger smallBtn";else return"btn btn-line-info smallBtn";};$scope.orderTag=function(status){switch(status){case"PENDENTE":return"label label-warning";case"ESPERA VLR":return"label label-default";case"PRIORIDADE":return"label label-warning";case"VOEB2B":return"label label-purple";case"ESPERA PGTO":return"label label-default";case"ESPERA LIM":return"label label-default";case"RESERVA":return"label label-info";case"ENVIADO":return"label label-success";case"EMITIDO":return"label label-success";case"VERIFICADO":return"label label-success";case"CANCELADO":return"label label-danger";case"FALHA EMISSAO":return"label label-danger";case"ESPERA":return"label label-default";case"ESPERA LIM VLR":return"label label-default";case"DADOS_PASSAGEIRO_INVALIDO":return"label label-default";case"SITE_CIA_FORA_AR":return"label label-default";case"RETARIFADA":return"label label-default";case"ANT":return"label label-default";case"BLOQ":return"label label-default";case"ANT BLOQ":return"label label-default";}};$scope.testGroup=function(order){var test_group=["adm@onemilhas.com.br"];if(order.notificationurl!=null){if(order.notificationurl.includes("skymilhas")){return test_group.includes(order.client_email.toLowerCase());}}return false;};$scope.isPriority=function(order){if(order.status=="PENDENTE PRIORIDADE"||order.status=="PRIORIDADE"){return true;}else{return false;}};$scope.isFlightToday=function(order){if(order.status=="EMITIDO"||order.status=="VERIFICADO"||order.firstBoardingDate==""){return false;}var date=new Date(order.firstBoardingDate);var today=new Date();if(date.getFullYear()==today.getFullYear()&&date.getMonth()==today.getMonth()&&date.getDate()==today.getDate()){return true;}return false;};$scope.isFlightTomorrow=function(order){if(order.status=="EMITIDO"||order.status=="VERIFICADO"||order.firstBoardingDate==""){return false;}var date=new Date(order.firstBoardingDate);var today=new Date();today.setDate(today.getDate()+1);if(date.getFullYear()==today.getFullYear()&&date.getMonth()==today.getMonth()&&date.getDate()==today.getDate()){return true;}return false;};$scope.orderTagClient=function(order){if(order.check_2==true){return"label label-info";}if(order.commercialStatus){return"label label-warning";}switch(order.status){case"PENDENTE":return"label label-warning";case"ESPERA VLR":return"label label-default";case"PRIORIDADE":return"label label-warning";case"VOEB2B":return"label label-purple";case"ESPERA PGTO":return"label label-default";case"ESPERA LIM":return"label label-default";case"RESERVA":return"label label-info";case"ENVIADO":return"label label-success";case"EMITIDO":return"label label-success";case"VERIFICADO":return"label label-success";case"CANCELADO":return"label label-danger";case"FALHA EMISSAO":return"label label-danger";case"ESPERA":return"label label-default";case"ESPERA LIM VLR":return"label label-default";case"DADOS_PASSAGEIRO_INVALIDO":return"label label-default";case"SITE_CIA_FORA_AR":return"label label-default";case"RETARIFADA":return"label label-default";case"ANT":return"label label-default";case"BLOQ":return"label label-default";case"ANT BLOQ":return"label label-default";}};$scope.orderMiles=function(mile){switch(mile.priority){case"-1":return"label label-success";case"0":return"label label-primary";case"1":return"label label-danger";case"2":return"label label-warning";default:return"";}};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.numPerPageOpt=[10,30,50,100,200,500];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageOnlineOrder=[];$scope.numPerPageOptMiles=[10,30,50,100,200];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.selectMiles=function(page){var end,start;start=(page-1)*$scope.numPerPageMiles;end=start+$scope.numPerPageMiles;return $scope.currentMiles=$scope.filteredflight_miles.slice(start,end);};$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.atualization=function(){if(document.getElementById("online_page")&&($scope.tabindex===0||$scope.tabindex===99||$scope.tabindex===6)&&$scope.atualizations==true){$scope.loadOnlineOrder();}};$scope.$watch("[tabindex, atualizations]",function(){if(($scope.tabindex===0||$scope.tabindex===99||$scope.tabindex===6)&&$scope.atualizations==true){$scope.atualization();$scope.reserve=false;}if($scope.main.dealer){return;}if($scope.tabindex!=6&&$scope.tabindex!=99){if($scope.tabindex==0){$rootScope.socket.emit("order_update",{order_id:undefined,name:$scope.main.name});}else{if($scope.tabindex!=99&&$scope.tabindex!=6){$rootScope.socket.emit("order_update",{order_id:$scope.selected.id,name:$scope.main.name});}}}if($scope.tabindex==4){$scope.loadPaxesUsedCards();}});$scope.autoUpdateName=function(){setTimeout(function(){if($scope.selected.id){if($scope.tabindex!=99&&$scope.tabindex!=6){$rootScope.socket.emit("order_update",{order_id:$scope.selected.id,name:$scope.main.name});}}else{if($scope.tabindex!=99&&$scope.tabindex!=6){$rootScope.socket.emit("order_update",{order_id:undefined,name:$scope.main.name});}}return $scope.autoUpdateName();},5000);};init=function init(){$scope.tabindex=0;if($scope.main.dealer){$scope.tabindex=99;}else if($scope.main.commercial){$scope.tabindex=6;}$scope.checkValidRoute();if($scope.main.id==""){return;}$scope.myOrder=undefined;if(!$scope.main.dealer){$scope.autoUpdateName();}$scope.wsale={};$("#discount").number(true,2,",",".");$scope.milesMoney=false;$scope.third=false;$scope.atualizations=true;$scope.selected={};$rootScope.modalOpen=false;$scope.multiDownloads=false;$.post("../backend/application/index.php?rota=/loadAirline",{},function(result){$rootScope.airlines=jQuery.parseJSON(result).dataset;});$scope.watchDogCards();$scope.uploader=new FileUploader();$scope.uploader_billets=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader_billets.url="../backend/application/index.php?rota=/saveBilletOrder";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:"customFilter",fn:function fn(item,options){return this.queue.length<18;}});$scope.uploader_billets.autoUpload=true;$scope.uploader_billets.filters.push({name:"customFilter",fn:function fn(item,options){return this.queue.length<18;}});if(!$scope.main.dealer&&!$scope.main.wizarSaleEvent){$rootScope.socket.on("updateOrders",function(data){if($scope.atualizations){$scope.onlineorders=data.orders.orders;$scope.$digest();}});$rootScope.socket.on("order_update",function(data){if(data.name==$scope.main.name){$scope.myOrder=data.order_id;}if(data.order_id){$scope.addSessionName(data.order_id,data.name);}else{$scope.removeSessionName(data.name);}$scope.$digest();});$rootScope.socket.on("globalOrders",function(data){if($scope.atualizations){$scope.onlineorders=data.orders;$scope.$digest();}});}else if($scope.main.dealer){$rootScope.socket.on("updateOrdersDealer",function(data){$scope.onlineorders=data.orders.orders;$scope.$digest();});}};$scope.addSessionName=function(order_id,name){var tempOrders=$filter("filter")($scope.onlineorders,order_id);for(var idOrder in tempOrders){var newSessionName="";var and="";if(tempOrders[idOrder].userSession){var sessionName=tempOrders[idOrder].userSession.split(";");for(var idName in sessionName){if(sessionName[idName]!=name){newSessionName+=and+sessionName[idName];and=";";}}}tempOrders[idOrder].userSession=newSessionName+and+name;}};$scope.removeSessionName=function(name){var tempOrders=$filter("filter")($scope.onlineorders,name);for(var idOrder in tempOrders){var newSessionName="";var and="";if(tempOrders[idOrder].userSession){var sessionName=tempOrders[idOrder].userSession.split(";");for(var idName in sessionName){if(sessionName[idName]!=name){newSessionName+=and+sessionName[idName];and=";";}}}tempOrders[idOrder].userSession=newSessionName;}};$scope.setStatusOrder=function(order,status){if(!order){order=$rootScope.onlineOrder;}$.post("../backend/application/index.php?rota=/setStatusOrder",{hashId:$scope.session.hashId,data:order,status:status},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;});};$scope.backToList=function(){$scope.tabindex=0;};$scope.loadOnlineOrder=function(){cfpLoadingBar.start();if($scope.tabindex==3){return;}if($scope.tabindex==0||$scope.tabindex==99||$scope.tabindex==6){$scope.selected={};}$.post("../backend/application/index.php?rota=/loadOnlineOrder",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,main:$scope.main},function(result){$scope.onlineorders=jQuery.parseJSON(result).dataset.orders;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();});};$scope.taxByFlight=function(onlineflight){var tax=0;if(onlineflight.is_newborn!="S"){tax+=onlineflight.tax;}tax+=onlineflight.du_tax;return tax;};$scope.checkTimeFlight=function(args){if(args==undefined){var date=new Date();date.setDate(date.getDate()+2);for(var i=0;$scope.onlineflights.length>i;i++){if($scope.onlineflights[i].airline=="GOL"&&new Date($scope.onlineflights[i].boarding_date)<date){logger.logError("Voo GOL com embarque inferior a 48Hrs!");$scope.previousIndex=0;$scope.tabindex=0;$rootScope.$emit("openPermission",{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});$scope.$apply();return;}}}};$scope.getAllCheckend=function(){if($scope.selected){if($scope.selected.status=="EMITIDO"||$scope.selected.status=="VERIFICADO"){for(var i in $scope.onlineflights){if($scope.onlineflights[i].saleChecked==false)return false;}return true;}return false;}return false;};$scope.checkAllAsCheck=function(){var check=$scope.getAllCheckend();for(var i in $scope.onlineflights){$scope.onlineflights[i].saleChecked==!check;}};$scope.checkSale=function(flight){$.post("../backend/application/index.php?rota=/saveSaleCheck",{data:$scope.selected,sale:flight},function(result){logger.logSuccess("Salvo com sucesso");$scope.loadOnlineFlight();});};$scope.checkAllSales=function(){$.post("../backend/application/index.php?rota=/saveSaleCheckAll",{data:$scope.selected},function(result){logger.logSuccess("Salvo com sucesso");$scope.loadOnlineFlight();});};$scope.checkSale2=function(flight){$.post("../backend/application/index.php?rota=/saveSaleDoubleCheck",{data:$scope.selected,sale:flight},function(result){logger.logSuccess("Salvo com sucesso");$scope.loadOnlineFlight();});};$scope.checkAllSale2=function(){$.post("../backend/application/index.php?rota=/saveSaleDoubleCheckAll",{data:$scope.selected},function(result){logger.logSuccess("Salvo com sucesso");$scope.loadOnlineFlight();});};$scope.checkSMS=function(flight){$.post("../backend/application/index.php?rota=/saveSaleSMS",{hashId:$scope.session.hashId,data:$scope.selected,sale:flight},function(result){logger.logSuccess("Salvo com sucesso");$scope.loadOnlineFlight();});};$scope.findMilesOrder=function(){var miles=0;for(var i in $scope.onlineorders){miles+=$scope.onlineorders[i].miles_used;}return $rootScope.formatNumber(miles,0);};$scope.loadOnlineFlight=function(args){$scope.args=args;$scope.selected.startedDate=new Date();$scope.tabindex=3;$scope.showNextStep=false;cfpLoadingBar.start();$scope.commercial_free={};$.post("../backend/application/index.php?rota=/loadCommercialStatusOrder",{data:$scope.selected},function(result){$scope.commercial_free=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadOnlineFlight",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.onlineflights=jQuery.parseJSON(result).dataset;if(args){for(var i in $scope.onlineflights){$scope.onlineflights[i].userEmail=$scope.main.email;}}$scope.filteredonlineflights=jQuery.parseJSON(result).dataset;$scope.resume_flights=$filter("filter")($scope.onlineflights,"FILTER_FLIGHT");$scope.resume_paxs=$filter("filter")($scope.onlineflights,"FILTER_PAX");if($scope.selected.status=="EMITIDO"||$scope.selected.status=="ENVIADO"||$scope.selected.status=="VERIFICADO"){$.post("../backend/application/index.php?rota=/loadCardFlight",{hashId:$scope.session.hashId,data:$scope.onlineflights},function(result){$scope.sale=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.resume_flights=angular.copy($scope.resume_flights);for(var i=0;$scope.onlineflights.length>i;i++){for(var j=0;$scope.sale.length>j;j++){if($scope.sale[j].subClientEmail!=undefined&&$scope.sale[j].subClientEmail!=null){$scope.selected.subClientEmail=$scope.sale[j].subClientEmail;}if($scope.sale[j].pax_id&&$scope.sale[j].online_flight_id){if($scope.sale[j].pax_id==$scope.onlineflights[i].pax_id&&$scope.sale[j].online_flight_id==$scope.onlineflights[i].id){$scope.onlineflights[i].card_number=$scope.sale[j].cardNumber;$scope.onlineflights[i].miles_used=$scope.sale[j].miles_used;$scope.onlineflights[i].flightLocator=$scope.sale[j].flightLocator;$scope.onlineflights[i].du_tax=$scope.sale[j].duTax;$scope.onlineflights[i].discount=$scope.sale[j].discount;$scope.onlineflights[i].providerName=$scope.sale[j].providerName;$scope.onlineflights[i].provider_phone=$scope.sale[j].provider_phone;$scope.onlineflights[i].tax_card=$scope.sale[j].tax_card;$scope.onlineflights[i].tax_cardType=$scope.sale[j].tax_cardType;$scope.onlineflights[i].tax_providerName=$scope.sale[j].tax_providerName;$scope.onlineflights[i].user=$scope.sale[j].user;$scope.onlineflights[i].ticket_code=$scope.sale[j].ticket_code;$scope.onlineflights[i].processing_time=$scope.sale[j].processing_time;$scope.onlineflights[i].cards_id=$scope.sale[j].cards_id;$scope.onlineflights[i].saleChecked=$scope.sale[j].saleChecked;$scope.onlineflights[i].saleCheckedDate=$scope.sale[j].saleCheckedDate;$scope.onlineflights[i].sale_id=$scope.sale[j].sale_id;$scope.onlineflights[i].amountPaid=$scope.sale[j].amountPaid;$scope.onlineflights[i].status=$scope.sale[j].status;$scope.onlineflights[i].access_password=$scope.decript($scope.sale[j].access_password);$scope.onlineflights[i].recovery_password=$scope.decript($scope.sale[j].recovery_password);$scope.selected.issuing=$scope.sale[j].issuing;$scope.onlineflights[i].partnerReservationCode=$scope.sale[j].partnerReservationCode;$scope.onlineflights[i].sms=$scope.sale[j].sms;if($scope.sale[j].money>0){$scope.onlineflights[i].money=$scope.sale[j].money;}$scope.onlineflights[i].card_type=$scope.sale[j].card_type;$scope.onlineflights[i].phoneNumberAirline=$scope.sale[j].phoneNumberAirline;$scope.onlineflights[i].celNumberAirline=$scope.sale[j].celNumberAirline;$scope.onlineflights[i].tax=$scope.sale[j].tax;$scope.onlineflights[i].tax_billet=$scope.sale[j].tax_billet;$scope.onlineflights[i].baggage=$scope.sale[j].baggage;$scope.onlineflights[i].class=$scope.sale[j].class;$scope.onlineflights[i].saleChecked2=$scope.sale[j].saleChecked2;$scope.onlineflights[i].saleCheckedDate2=$scope.sale[j].saleCheckedDate2;$scope.onlineflights[i].taxOnlinePayment=$scope.sale[j].taxOnlinePayment;$scope.onlineflights[i].taxOnlineValidation=$scope.sale[j].taxOnlineValidation;$scope.onlineflights[i].baggage_price=$scope.sale[j].baggage_price;$scope.onlineflights[i].special_seat=$scope.sale[j].special_seat;}}else{if($scope.sale[j].flight==$scope.onlineflights[i].flight&&$scope.sale[j].pax_name==$scope.onlineflights[i].pax_name&&$scope.sale[j].online_flight_id==$scope.onlineflights[i].id){$scope.onlineflights[i].card_number=$scope.sale[j].cardNumber;$scope.onlineflights[i].miles_used=$scope.sale[j].miles_used;$scope.onlineflights[i].flightLocator=$scope.sale[j].flightLocator;$scope.onlineflights[i].du_tax=$scope.sale[j].duTax;$scope.onlineflights[i].discount=$scope.sale[j].discount;$scope.onlineflights[i].providerName=$scope.sale[j].providerName;$scope.onlineflights[i].provider_phone=$scope.sale[j].provider_phone;$scope.onlineflights[i].tax_card=$scope.sale[j].tax_card;$scope.onlineflights[i].tax_cardType=$scope.sale[j].tax_cardType;$scope.onlineflights[i].tax_providerName=$scope.sale[j].tax_providerName;$scope.onlineflights[i].user=$scope.sale[j].user;$scope.onlineflights[i].ticket_code=$scope.sale[j].ticket_code;$scope.onlineflights[i].processing_time=$scope.sale[j].processing_time;$scope.onlineflights[i].cards_id=$scope.sale[j].cards_id;$scope.onlineflights[i].saleChecked=$scope.sale[j].saleChecked;$scope.onlineflights[i].saleCheckedDate=$scope.sale[j].saleCheckedDate;$scope.onlineflights[i].sale_id=$scope.sale[j].sale_id;$scope.onlineflights[i].amountPaid=$scope.sale[j].amountPaid;$scope.onlineflights[i].status=$scope.sale[j].status;$scope.onlineflights[i].access_password=$scope.decript($scope.sale[j].access_password);$scope.onlineflights[i].recovery_password=$scope.decript($scope.sale[j].recovery_password);$scope.selected.issuing=$scope.sale[j].issuing;$scope.onlineflights[i].partnerReservationCode=$scope.sale[j].partnerReservationCode;$scope.onlineflights[i].sms=$scope.sale[j].sms;if($scope.sale[j].money>0){$scope.onlineflights[i].money=$scope.sale[j].money;}$scope.onlineflights[i].card_type=$scope.sale[j].card_type;$scope.onlineflights[i].phoneNumberAirline=$scope.sale[j].phoneNumberAirline;$scope.onlineflights[i].celNumberAirline=$scope.sale[j].celNumberAirline;$scope.onlineflights[i].tax=$scope.sale[j].tax;$scope.onlineflights[i].tax_billet=$scope.sale[j].tax_billet;$scope.onlineflights[i].baggage=$scope.sale[j].baggage;$scope.onlineflights[i].class=$scope.sale[j].class;$scope.onlineflights[i].saleChecked2=$scope.sale[j].saleChecked2;$scope.onlineflights[i].saleCheckedDate2=$scope.sale[j].saleCheckedDate2;$scope.onlineflights[i].taxOnlinePayment=$scope.sale[j].taxOnlinePayment;$scope.onlineflights[i].taxOnlineValidation=$scope.sale[j].taxOnlineValidation;$scope.onlineflights[i].baggage_price=$scope.sale[j].baggage_price;$scope.onlineflights[i].special_seat=$scope.sale[j].special_seat;}}}}$.post("../backend/application/index.php?rota=/loadCardsData",{data:$scope.onlineflights,type:"SALEDONE",clear_session:"false"},function(result){$scope.cards=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.cardPassword();$scope.tabindex=4;$scope.$apply();});});$.post("../backend/application/index.php?rota=/incodde/checkOrderBot",{order:$scope.selected},function(result){$scope.robotLog=jQuery.parseJSON(result).dataset;});}else{if($scope.onlineflights[0].card_number!=""){$.post("../backend/application/index.php?rota=/loadCardsData",{data:$scope.onlineflights,clear_session:"false"},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.cardPassword();});}$.post("../backend/application/index.php?rota=/loadClientName",{data:$scope.selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();if($scope.response!=undefined){if($scope.response.status=="Coberto"&&$scope.response.paymentType=="Coberto"){$scope.selected.early_covered=true;}$scope.selected.subClientEmail=$scope.response.subClientEmail;if($scope.check48hours()&&args==undefined){$scope.checkTimeFlight(args);$scope.previousIndex=0;$scope.tabindex=0;}else if($scope.response.status=="Bloqueado"&&args==undefined){logger.logError("Cliente Bloqueado! - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit("openPermission",{main:$scope.$parent.$parent.main});}else if($scope.response.status=="Antecipado/Bloqueado"&&args==undefined){logger.logError("Cliente Antecipado/Bloqueado! - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit("openPermission",{main:$scope.$parent.$parent.main});return;}else if($scope.response.status=="Pendente"&&args==undefined){logger.logError("Cliente Pendente! - Favor consultar o Comercial");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit("openPermission",{main:$scope.$parent.$parent.main});return;}else if($scope.response.paymentType=="Antecipado"&&args==undefined){if($scope.response.total_credits-$scope.selected.total_cost>=0){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_confirmation.html",controller:"ModalConfirmationCtrl",resolve:{header:function header(){return"Cliente Antecipado! Possui Crédito de R$"+$rootScope.formatNumber($scope.response.total_credits);}}});modalInstance.result.then(function(filterSales){$scope.wsale.client=$scope.response.client_name;$scope.selected.client_name=$scope.wsale.client;$scope.selected.subClientEmail=$scope.response.subClientEmail;$scope.previousIndex=$scope.tabindex;$scope.$apply();$scope.checkTimeFlight(args);$scope.showNextStep=true;$.post("../backend/application/index.php?rota=/incodde/checkOrderBot",{order:$scope.selected},function(result){$scope.robotLog=jQuery.parseJSON(result).dataset;});});}else{logger.logError("Cliente Antecipado! - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit("openPermission",{main:$scope.$parent.$parent.main});return;}}else if($scope.response.partner_limit=="true"&&args==undefined&&$scope.selected.commercialStatus==false){logger.logError("Cliente atingiu limite de emissões! Limite: "+$scope.response.totalLimit+" | Valor usado: "+$scope.response.usedValue+" - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit("openPermission",{main:$scope.$parent.$parent.main});return;}else if($scope.response.totalLimit>0&&$scope.selected.total_cost+$scope.response.usedValue>$scope.response.totalLimit&&args==undefined){logger.logError("Esta OP excederá o limite de emissões do cliente! Limite: "+$scope.response.totalLimit+" | Valor usado: "+$scope.response.usedValue+" | Valor da emissão: "+$scope.selected.total_cost+" - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit("openPermission",{main:$scope.$parent.$parent.main});return;}else{$scope.wsale.client=$scope.response.client_name;$scope.wsale.usedValueAndTotal=$scope.response.usedValue+"/"+$scope.response.totalLimit;$scope.selected.client_name=$scope.wsale.client;$scope.selected.subClientEmail=$scope.response.subClientEmail;$scope.previousIndex=$scope.tabindex;$scope.$apply();$scope.checkTimeFlight(args);$scope.showNextStep=true;$.post("../backend/application/index.php?rota=/incodde/checkOrderBot",{order:$scope.selected},function(result){$scope.robotLog=jQuery.parseJSON(result).dataset;});}}else{logger.logWarning("Cliente não vinculado!");$scope.previousIndex=0;$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});}});return $scope.select($scope.currentPage);}});};$scope.$watch("wsale.client",function(){var client=_.find($scope.clients,function(o){return o.name==$scope.wsale.client;});if(client&&client!=undefined&&client!=null){$scope.showNextStep=true;}else{$scope.showNextStep=false;}});$scope.checkPaxNames=function(pax_name){if(pax_name&&pax_name!=""){if($scope.blackListOfNames.indexOf(pax_name.split(" ")[pax_name.split(" ").length-1])>-1){return true;}}return false;};$scope.getTotalValue=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){cont+=$scope.onlineflights[i].cost+$scope.onlineflights[i].baggage_price+$scope.onlineflights[i].special_seat-$scope.onlineflights[i].discount;if($scope.onlineflights[i].is_newborn!="S"){cont+=$scope.onlineflights[i].tax_billet;}}return cont;}};$scope.getTotalDiscount=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){cont+=$scope.onlineflights[i].discount;}return cont;}};$scope.getTotal=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){cont+=$scope.onlineflights[i].cost;}return cont;}};$scope.getFlightTotal=function(onlineflight){if($scope.selected){if($scope.selected.status=="EMITIDO"||$scope.selected.status=="VERIFICADO"){return onlineflight.amountPaid;}else{if(onlineflight.is_newborn=="N"){return onlineflight.cost+onlineflight.tax_billet+onlineflight.baggage_price+onlineflight.special_seat-onlineflight.discount-onlineflight.cupom;}else{return onlineflight.cost-onlineflight.discount-onlineflight.cupom;}}}};$scope.getTotalTax=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){if($scope.onlineflights[i].is_newborn!="S"){cont+=$scope.onlineflights[i].tax;}}return cont;}};$scope.getPaxType=function(onlineflight){if($scope.onlineflights!=undefined){if(onlineflight.is_child=="S")return"CHD";if(onlineflight.is_newborn=="S")return"INF";return"ADT";}};$scope.hasNewBorn=function(){for(var i in $scope.onlineflights){if($scope.onlineflights[i].is_newborn=="S"){return true;}}return false;};$scope.hasChild=function(){for(var i in $scope.onlineflights){if($scope.onlineflights[i].is_child=="S"){return true;}}return false;};$scope.saveStatusOrder=function(){$.post("../backend/application/index.php?rota=/saveStatusOrder",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.loadSalesByFilter();});};$scope.saveOrder=function(){cfpLoadingBar.start();if($scope.validCredit()){$scope.args=undefined;$scope.selected._startedDate=$rootScope.formatServerDateTime($scope.selected.startedDate);$scope.selected.is_diamond=$scope.diamondPax;$scope.tabindex=0;$.post("../backend/application/index.php?rota=/generateOrder",{order_data:$scope.selected,flight_data:$scope.onlineflights,wsale_data:$scope.wsale},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.uploader_billets.clearQueue();}else{logger.logError(jQuery.parseJSON(result).message.text);}$scope.clearSession();cfpLoadingBar.complete();});}else{logger.logError("Milhas Invalidas para Venda");$scope.clearSession();}};$scope.clearSession=function(){$.post("../backend/application/index.php?rota=/loadCardsData",{data:$scope.onlineflights,clear_session:"true"},function(result){});};$scope.sendEmail=function(onlineflights){$scope.previousIndex=$scope.tabindex;$scope.tabindex=5;$scope.fillEmailContent(onlineflights);};$scope.decript=function(code){var data=code.split("320AB");var finaly="";for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.cardPassword=function(){for(var i=0;i<=$scope.onlineflights.length-1;i++){for(var j=0;j<=$scope.cards.length-1;j++){if($scope.cards[j].cards_id==$scope.onlineflights[i].cards_id){$scope.onlineflights[i].recovery_password=$scope.decript($scope.cards[j].recovery_password);$scope.onlineflights[i].token=$scope.cards[j].token;$scope.onlineflights[i].chip_number=$scope.cards[j].chip_number;$scope.onlineflights[i].email_provider=$scope.cards[j].email_provider;$scope.onlineflights[i].card_registrationCode=$scope.cards[j].card_registrationCode;if($scope.onlineflights[i].airline=="TAM"||$scope.onlineflights[i].airline=="LATAM"){$scope.onlineflights[i].access_id=$scope.cards[j].access_id;$scope.onlineflights[i].access_password=$scope.decript($scope.cards[j].access_password);}else{$scope.onlineflights[i].access_id=" - ";$scope.onlineflights[i].access_password=" - ";}}}}$scope.$apply();if($scope.selected.status!="ENVIADO"&&$scope.selected.status!="EMITIDO"&&$scope.selected.status!="VERIFICADO"){}if(!$scope.validCredit()){logger.logError("Milhas Invalidas para Venda");}};$scope.findBaggagePrice=function(airline,baggages){return _.find($rootScope.airlines,function(o){return o.name==airline;}).baggage*baggages;};$scope.duTax=function(){for(var i=0;$scope.resume_paxs.length>i;i++){var fullName=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){fullName+=" "+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){fullName+=" "+$scope.resume_paxs[i].paxAgnome;}$scope.resume=$filter("filter")($scope.onlineflights,fullName);$scope.resume=$filter("filter")($scope.resume,$scope.resume_paxs[i].airline);for(var j=0;$scope.resume.length>j;j++){if(($scope.resume[j].airline=="TAM"||$scope.resume[j].airline=="LATAM")&&$scope.resume[j].provider=="Loja TAM Ponta Grossa"){$scope.resume[j].tax_card=undefined;$scope.resume[j].du_tax=35/$scope.resume.length+$scope.findBaggagePrice($scope.resume[j].airline,$scope.resume[j].baggage);}else if(($scope.resume[j].airline=="TAM"||$scope.resume[j].airline=="LATAM")&&$scope.resume[j].provider=="Loja TAM Contagem"){$scope.resume[j].tax_card=undefined;$scope.resume[j].du_tax=25/$scope.resume.length+$scope.findBaggagePrice($scope.resume[j].airline,$scope.resume[j].baggage);}else if(($scope.resume[j].airline=="TAM"||$scope.resume[j].airline=="LATAM")&&$scope.resume[j].provider=="Loja TAM M"){$scope.resume[j].tax_card=undefined;$scope.resume[j].du_tax=28/$scope.resume.length+$scope.findBaggagePrice($scope.resume[j].airline,$scope.resume[j].baggage);}else if($scope.resume[j].airline=="AZUL"&&$scope.resume[j].is_newborn=="N"){}}}};$scope.validCredit=function(){var cards=[];var fill=false;for(var j in $scope.onlineflights){for(var i in cards){if(cards[i].cards_id==$scope.onlineflights[j].cards_id){fill=true;cards[i].credit-=$scope.onlineflights[j].miles_used;if(cards[i].credit<0){logger.logError("Saldo insuficiente para o cartão: "+cards[i].card_number+" !");for(var x in $scope.onlineflights){if(cards[i].cards_id==$scope.onlineflights[x].cards_id){$scope.onlineflights[x].card_number="";$scope.onlineflights[x].cards_id="";$scope.onlineflights[x].recovery_password="";$scope.onlineflights[x].token="";$scope.onlineflights[x].email_provider="";$scope.onlineflights[x].card_registrationCode="";$scope.onlineflights[x].access_id="";$scope.onlineflights[x].access_password="";$scope.onlineflights[x].card_leftover="";}}$scope.$digest();return false;}}}if(!fill){cards.push({cards_id:$scope.onlineflights[j].cards_id,credit:$scope.onlineflights[j].card_leftover-$scope.onlineflights[j].miles_used,card_number:$scope.onlineflights[j].card_number});}}return true;};$scope.isValidOrder=function(){if($scope.selected){if($scope.validFlights()===true){return true;}else{return false;}}};$scope.getPaxDescription=function(){if($scope.onlineflights){var inf=0;var chd=0;var adt=0;for(var i=0;$scope.resume_paxs.length>i;i++){if($scope.resume_paxs[i].is_child=="S")chd++;else if($scope.resume_paxs[i].is_newborn=="S")inf++;else adt++;}var result="";if(adt>0)result=adt+" Adulto(s)";if(chd>0)result=result+", "+chd+" Criança(s)";if(inf>0)result=result+", "+inf+" Recem Nascido(s)";return result;}};$scope.validFlights=function(){if($scope.onlineflights){for(var j=0;$scope.onlineflights.length>j;j++){if($scope.onlineflights[j].isBreak=="Integrado"){if($scope.onlineflights[j].provider!="CONFIANÇA"||$scope.onlineflights[j].provider!="Flytour"||$scope.onlineflights[j].provider!="Rextur Advance"||$scope.onlineflights[j].provider!="TAP"){if($scope.onlineflights[j].card_number==" - "&&($scope.onlineflights[j].provider=="Loja TAM Contagem"||$scope.onlineflights[j].provider=="Loja TAM Ponta Grossa"||$scope.onlineflights[j].provider=="Loja TAM M"||$scope.onlineflights[j].provider==="")){return false;}}if($scope.onlineflights[j].flightLocator==undefined){return false;}if(($scope.onlineflights[j].airline=="TAM"||$scope.onlineflights[j].airline=="LATAM")&&$scope.onlineflights[j].ticket_code==undefined){return false;}if($scope.onlineflights[j].provider==""&&$scope.onlineflights[j].tax_card==undefined||$scope.onlineflights[j].flightLocator==undefined)return false;}}return true;}};$scope.validOrder=function(){if($scope.wsale.client){$scope.selected.client_name=$scope.wsale.client;if($scope.response){if($scope.response.status=="Bloqueado"||$scope.response.paymentType=="Antecipado"){$scope.openClientWarning($scope.response);}}$scope.previousIndex=$scope.tabindex;$scope.tabindex++;}};$scope.openClientWarning=function(args){$scope.ClientWarning=args;var modalInstance;modalInstance=$modal.open({templateUrl:"ClientWarningModalCtrl.html",controller:"ClientWarningInstanceCtrl",resolve:{selected:function selected(){return $scope.ClientWarning;}}});modalInstance.result.then(function(){});};$scope.cancelOrder=function(){$scope.cancel=true;};$scope.cancelOnlineOrder=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/cancelOnlineOrder",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;});};$scope.loadSalesByFilter=function(){$.post("../backend/application/index.php?rota=/loadOnlineByFilter",{data:$scope.filter},function(result){if($scope.tabindex==0){$scope.onlineorder=jQuery.parseJSON(result).dataset;$scope.search();$scope.$apply();return $scope.select($scope.currentPage);}});};$scope.loadOrderMiles=function(){$scope.loadOrderMilesFunction=$scope.loadOrderMiles;cfpLoadingBar.start();var miles_used=0;for(var i in $scope.onlineflights){miles_used+=$scope.onlineflights[i].miles_used;}$scope.flight_selected={miles_used:miles_used};$scope.operation=3;$.post("../backend/application/index.php?rota=/loadSalesMiles",{searchKeywordsMiles:$scope.searchKeywordsMiles,ordenation:$scope.searchMilesOrder,ordernationDown:$scope.searchMilesOrderDown,page:$scope.currentPageMiles,numPerPage:$scope.numPerPageMiles,milesUsed:miles_used,airline:$scope.selected.airline,order:$scope.selected,pax_quant:$scope.resume_paxs.length,paxes:$scope.resume_paxs},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset.miles;$scope.total_miles=jQuery.parseJSON(result).dataset.total;$scope.filterCardsInUse();});};$scope.findFlightMiles=function(){if(this.onlineflight){$scope.flight_selected=this.onlineflight;}$scope.loadOrderMilesFunction=$scope.findFlightMiles;cfpLoadingBar.start();var totalFlight={miles_used:0};for(var i=0;i<$scope.onlineflights.length;i++){if($scope.onlineflights[i].flight==$scope.flight_selected.flight)totalFlight.miles_used+=$scope.onlineflights[i].miles_used;}$.post("../backend/application/index.php?rota=/loadSalesMiles",{searchKeywordsMiles:$scope.searchKeywordsMiles,ordenation:$scope.searchMilesOrder,ordernationDown:$scope.searchMilesOrderDown,page:$scope.currentPageMiles,numPerPage:$scope.numPerPageMiles,milesUsed:totalFlight.miles_used,boarding_date:$scope.flight_selected.boarding_date,airline:$scope.flight_selected.airline,order:$scope.selected,provider:$scope.flight_selected.provider,from:$scope.flight_selected.airport_code_from,to:$scope.flight_selected.airport_code_to,pax_quant:$scope.resume_paxs.length,paxes:$scope.resume_paxs},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset.miles;$scope.total_miles=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.tabindex=1;$scope.$digest();});$scope.operation=1;};$scope.findMiles=function(){if(this.onlineflight){$scope.flight_selected=this.onlineflight;}if($scope.flight_selected.airline=="LATAM"||$scope.flight_selected.airline=="AZUL"){if(!$scope.flight_selected.maxCards){$scope.flight_selected.maxCards=3;}}else{$scope.flight_selected.maxCards=-1;}var previous_card_id=$scope.flight_selected.cards_id;$scope.flight_selected.usedByCurrent=false;cfpLoadingBar.start();$scope.loadOrderMilesFunction=$scope.findMiles;$.post("../backend/application/index.php?rota=/loadSalesMiles",{searchKeywordsMiles:$scope.searchKeywordsMiles,ordenation:$scope.searchMilesOrder,ordernationDown:$scope.searchMilesOrderDown,page:$scope.currentPageMiles,numPerPage:$scope.numPerPageMiles,milesUsed:$scope.flight_selected.miles_used,boarding_date:$scope.flight_selected.boarding_date,airline:$scope.flight_selected.airline,provider:$scope.flight_selected.provider,from:$scope.flight_selected.airport_code_from,to:$scope.flight_selected.airport_code_to,order:$scope.selected,pax_quant:1,paxes:[$scope.flight_selected],maxCards:$scope.flight_selected.maxCards},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset.miles;$scope.total_miles=jQuery.parseJSON(result).dataset.total;if(previous_card_id){$scope.dessetCard(previous_card_id);}$scope.filterCardsInUse();});$scope.operation=2;};$scope.filterCardsInUse=function(){$.post("../backend/application/index.php?rota=/loadCardsInUse",{hashId:$scope.session.hashId},function(result){$scope.CardsUsados=jQuery.parseJSON(result).dataset;for(var m in $scope.flight_miles){$scope.flight_miles[m].usedByCurrent=false;for(var card in $scope.CardsUsados){if($scope.CardsUsados[card].userSession==$scope.main.name&&$scope.CardsUsados[card].cards_id==$scope.flight_miles[m].cards_id){$scope.flight_miles[m].usedByCurrent=true;break;}}}$scope.flight_miles=$scope.flight_miles.filter(function(Row){for(var _card in $scope.CardsUsados){if(!Row.usedByCurrent&&Row.cards_id==$scope.CardsUsados[_card].cards_id)return false;}return true;});cfpLoadingBar.complete();$scope.tabindex=1;$scope.$apply();});};$scope.findMoreCards=function(){$scope.flight_selected.maxCards+=3;$scope.findMiles();};$scope.downloadAllBillets=function(){$scope.multiDownloads=true;$scope.airline_flights=_.uniqBy($scope.onlineflights,"airline");for(var airline in $scope.airline_flights){if($scope.airline_flights[airline].airline=="LATAM"){$scope.filtered_flights_airline=$filter("filter")($scope.onlineflights,{airline:"LATAM"});$scope.filtered_flights=_.uniqBy($scope.filtered_flights_airline,"ticket_code");for(var flight in $scope.filtered_flights){$scope.printBilletLaTam($scope.filtered_flights[flight]);}}else if($scope.airline_flights[airline].airline=="GOL"){$scope.filtered_flights_airline=$filter("filter")($scope.onlineflights,{airline:"GOL"});$scope.filtered_flights=_.uniqBy($scope.filtered_flights_airline,"flightLocator");for(var flight in $scope.filtered_flights){$scope.printBilletGol($scope.filtered_flights[flight]);}}else if($scope.airline_flights[airline].airline=="AZUL"){$scope.filtered_flights_airline=$filter("filter")($scope.onlineflights,{airline:"AZUL"});$scope.filtered_flights=_.uniqBy($scope.filtered_flights_airline,"flightLocator");for(var flight in $scope.filtered_flights){$scope.printBilletAzul2($scope.filtered_flights[flight]);}}else if($scope.airline_flights[airline].airline=="AVIANCA"){$scope.filtered_flights_airline=$filter("filter")($scope.onlineflights,{airline:"AVIANCA"});$scope.filtered_flights=_.uniqBy($scope.filtered_flights_airline,"flightLocator");for(var flight in $scope.filtered_flights){$scope.printBilletAvianca($scope.filtered_flights[flight]);}}}if($scope.response){if($scope.response.notificationurl!=null&&$scope.response.notificationurl.indexOf("http")==-1){$scope.fillEmailBillet();}}else{$scope.fillEmailBillet();}};$scope.filter_by_key=function(array,key){var clear=[];for(var filterIndex in array){if(clear.indexOf(array[filterIndex][key])==-1){clear.push(array[filterIndex]);}}return clear;};$scope.searchHighValueCards=function(){$scope.loadOrderMilesFunction=$scope.searchHighValueCards;$.post("../backend/application/index.php?rota=/loadSalesMiles",{searchKeywordsMiles:$scope.searchKeywordsMiles,ordenation:$scope.searchMilesOrder,ordernationDown:$scope.searchMilesOrderDown,page:$scope.currentPageMiles,numPerPage:$scope.numPerPageMiles,milesUsed:0,airline:"LATAM",cardType:"HighValue",pax_quant:$scope.resume_paxs.length,paxes:$scope.resume_paxs},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset.miles;$scope.total_miles=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.tabindex=1;$scope.$digest();});};$scope.searchAllCards=function(permissions){$scope.loadOrderMilesFunction=$scope.searchAllCards;var milesUsed=-50000;if(permissions){var permissions=permissions;if(!permissions.sales&&!permissions.isMaster){milesUsed=1;}}$scope.operation=2;$.post("../backend/application/index.php?rota=/loadSalesMiles",{searchKeywordsMiles:$scope.searchKeywordsMiles,ordenation:$scope.searchMilesOrder,ordernationDown:$scope.searchMilesOrderDown,page:$scope.currentPageMiles,numPerPage:$scope.numPerPageMiles,milesUsed:milesUsed,airline:$scope.flight_selected.airline,pax_quant:1,paxes:$scope.resume_paxs},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset.miles;$scope.total_miles=jQuery.parseJSON(result).dataset.total;$scope.$digest();});};$scope.backToOrder=function(){$scope.tabindex=4;};$scope.openFindAllCardsCtrl=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"FindAllCardsCtrl.html",controller:"FindAllCardsInstanceCtrl",resolve:{main:function main(){return $scope.main;}}});modalInstance.result.then(function(permissions){$scope.searchAllCards(permissions);});};$scope.setCard=function(mile){var temp_miles=this.mile;$.post("../backend/application/index.php?rota=/cards/checkValidMaxPaxPerCard",{data:temp_miles,flight_selected:$scope.flight_selected,onlineflights:$scope.onlineflights,operation:$scope.operation},function(result){if(jQuery.parseJSON(result).message.type=="E"){return logger.logError("Este cartão não é mais valido para compras.");}$scope.flight_selected.card_number=temp_miles.card_number;$scope.flight_selected.card_leftover=temp_miles.leftover;$scope.flight_selected.card_registrationCode=temp_miles.card_registrationCode;$scope.flight_selected.card_type=temp_miles.card_type;$scope.flight_selected.cards_id=temp_miles.cards_id;$scope.flight_selected.diamond_free=temp_miles.diamond_free;$scope.flight_selected.providerName=temp_miles.name;$scope.flight_selected.provider_phone=temp_miles.provider_phone;$scope.flight_selected.phoneNumberAirline=temp_miles.phoneNumberAirline;$scope.flight_selected.celNumberAirline=temp_miles.celNumberAirline;$scope.flight_selected.provider_adress=temp_miles.provider_adress;$scope.flight_selected.cityfullname=temp_miles.cityfullname;$scope.flight_selected.notes=temp_miles.notes;if($scope.flight_selected.notes!=null&&$scope.flight_selected.notes!=undefined&&$scope.flight_selected.notes!=""){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/system_notification.html",controller:"SystemNotificationCtrl",periods:$scope.periods,size:"lg",resolve:{notification:function notification(){return{text:$scope.flight_selected.notes,description:"Em caso de duvidas, consulte seu gerente!"};},header:function header(){return"Aviso";}}});}if($scope.flight_selected.airline=="AVIANCA"){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/system_notification.html",controller:"SystemNotificationCtrl",periods:$scope.periods,size:"lg",resolve:{notification:function notification(){return{text:"Emitir e segurar o pedido ate o e-tiket chegar por e-mail",description:"Em caso de duvidas, consulte seu gerente!"};},header:function header(){return"Ficha AVIANCA";}}});}if($scope.operation==1){for(var i=0;i<$scope.onlineflights.length;i++){if($scope.onlineflights[i].flight==$scope.flight_selected.flight){$scope.onlineflights[i].card_number=$scope.flight_selected.card_number;$scope.onlineflights[i].card_leftover=$scope.flight_selected.card_leftover;$scope.onlineflights[i].card_registrationCode=$scope.flight_selected.card_registrationCode;$scope.onlineflights[i].card_type=$scope.flight_selected.card_type;$scope.onlineflights[i].cards_id=$scope.flight_selected.cards_id;$scope.onlineflights[i].providerName=$scope.flight_selected.providerName;$scope.onlineflights[i].provider_phone=$scope.flight_selected.provider_phone;$scope.onlineflights[i].phoneNumberAirline=$scope.flight_selected.phoneNumberAirline;$scope.onlineflights[i].celNumberAirline=$scope.flight_selected.celNumberAirline;$scope.onlineflights[i].provider_adress=$scope.flight_selected.provider_adress;$scope.onlineflights[i].cityfullname=$scope.flight_selected.cityfullname;}}}if($scope.operation==3){for(var j in $scope.onlineflights){$scope.onlineflights[j].card_number=$scope.flight_selected.card_number;$scope.onlineflights[j].card_leftover=$scope.flight_selected.card_leftover;$scope.onlineflights[j].card_registrationCode=$scope.flight_selected.card_registrationCode;$scope.onlineflights[j].card_type=$scope.flight_selected.card_type;$scope.onlineflights[j].cards_id=$scope.flight_selected.cards_id;$scope.onlineflights[j].providerName=$scope.flight_selected.providerName;$scope.onlineflights[j].provider_phone=$scope.flight_selected.provider_phone;$scope.onlineflights[j].phoneNumberAirline=$scope.flight_selected.phoneNumberAirline;$scope.onlineflights[j].celNumberAirline=$scope.flight_selected.celNumberAirline;$scope.onlineflights[j].provider_adress=$scope.flight_selected.provider_adress;$scope.onlineflights[j].cityfullname=$scope.flight_selected.cityfullname;}}$.post("../backend/application/index.php?rota=/loadCardsData",{data:$scope.onlineflights,clear_session:"false"},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.tabindex=4;$scope.cardPassword();});$scope.searchKeywordsMiles="";});};$scope.dessetCard=function(id){for(var j in $scope.onlineflights){if($scope.onlineflights[j].cards_id==id){$scope.onlineflights[j].card_number=null;$scope.onlineflights[j].card_leftover=null;$scope.onlineflights[j].card_registrationCode=null;$scope.onlineflights[j].card_type=null;$scope.onlineflights[j].cards_id=null;$.post("../backend/application/index.php?rota=/removeCardUse",{data:{"cards_id":id}},function(result){$scope.$apply();});}}};$scope.watchDogCards=function(){if($rootScope.watchDogPID!=0){clearInterval($rootScope.watchDogPID);$rootScope.watchDogPID=0;void 0;}if($scope.watchDogSelected){void 0;$rootScope.watchDogPID=setInterval(function(){$.post("../backend/application/index.php?rota=/removeCardUseByTime",{hashId:$scope.session.hashId,name:$scope.main.name,minutes:"20"},function(result){var resp=jQuery.parseJSON(result).dataset;if(resp.length>0){void 0;for(var i in resp){void 0;}}});},30000);}};$scope.setSelectedFlight=function(){if($scope.selected.status!="EMITIDO"){$scope.flight_selected=this.onlineflight;}else{$scope.flight_selected=undefined;}};$scope.undo=function(){if($scope.selected){if($scope.selected.status=="EMITIDO"||$scope.selected.status=="VERIFICADO"){$scope.tabindex=0;$scope.previousIndex=0;}else{$scope.tabindex=$scope.previousIndex;$scope.previousIndex--;}}else{$scope.tabindex=0;$scope.previousIndex=0;}$scope.cancel=false;};$scope.undoBtt=function(){$scope.undo();$scope.clearSession();$scope.tabindex=0;$scope.loadOnlineOrder();};$scope.findSpecialCards=function(){if($scope.onlineflights){if($scope.onlineflights.length>0){for(var i in $scope.onlineflights){if($scope.onlineflights[i].card_type=="RED"||$scope.onlineflights[i].card_type=="BLACK"||$scope.onlineflights[i].card_type=="DIAMANTE"||$scope.onlineflights[i].card_type=="CLUBE DIAMANTE")return true;}}}return false;};$scope.limpaRobo=function(){$.post("../backend/application/index.php?rota=/incodde/removerRobo",{order:$scope.selected},function(result){$scope.robotLog=[];logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$digest();});};$scope.bloqueiaRobo=false;$scope.in8Bot=function(){if(!$scope.onlineflights[0].tax_cardType){return logger.logError("Cartão de credito deve ser vinculado!");}if(!$scope.onlineflights[0].card_registrationCode||$scope.onlineflights[0].card_registrationCode==null||$scope.onlineflights[0].card_registrationCode=="null"){return logger.logError("Ficha deve ser vinculado!");}$scope.bloqueiaRobo=true;$.post("../backend/application/index.php?rota=/incodde/newOrder",{order:$scope.selected,onlineflights:$scope.onlineflights},function(result){$scope.bloqueiaRobo=false;$scope.$digest();var response=jQuery.parseJSON(result).dataset;if(jQuery.parseJSON(result).message.type=="S"){}else{logger.logError(jQuery.parseJSON(result).message.text);}$.post("../backend/application/index.php?rota=/incodde/checkOrderBot",{order:$scope.selected},function(result){$scope.robotLog=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.openRobotLog=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_robot_list.html",controller:"NotificationRobotListCtrl",periods:$scope.periods,size:"lg",resolve:{logs:function logs(){return $scope.robotLog;},header:function header(){return"Acompanhamento de emissão";},order:function order(){return $scope.selected;},onlineflights:function onlineflights(){return $scope.onlineflights;}}});};$scope.loadPaxesUsedCards=function(){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_to;})[0];var internacional=false;if(from&&to){if(from.internacional=="1"||to.internacional=="1"){internacional=true;}}$.post("../backend/application/index.php?rota=/cards/loadAllPaxesCardsUsed",{data:$scope.resume_paxs,internacional:internacional},function(result){$scope.resume_paxs=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.openPaxUsedByCode=function(pax){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_to;})[0];pax.internacional=false;if(from&&to){if(from.internacional=="1"||to.internacional=="1"){pax.internacional=true;}}$.post("../backend/application/index.php?rota=/cards/loadPaxUsedCards",pax,function(result){$scope.cardsUsed=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_names_list.html",controller:"ModalNamesLIstCtrl",resolve:{selected:function selected(){return $scope.selected;},paxPerCards:function paxPerCards(){return $scope.cardsUsed;}}});});};$scope.openPaxUsedCards=function(pax){var from=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_from;})[0];var to=$rootScope.airports.filter(function(airport){return airport.iataCode==$scope.onlineflights[0].airport_code_to;})[0];pax.internacional=false;if(from&&to){if(from.internacional=="1"||to.internacional=="1"){pax.internacional=true;}}$.post("../backend/application/index.php?rota=/cards/loadPaxUsedCards",pax,function(result){$scope.cardsUsed=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_names_list.html",controller:"ModalNamesLIstCtrl",resolve:{selected:function selected(){return $scope.selected;},paxPerCards:function paxPerCards(){return $scope.cardsUsed;}}});});};$scope.openAllPaxUsedCards=function(){$.post("../backend/application/index.php?rota=/cards/loadAllPaxUsedCards",{data:$scope.resume_paxs},function(result){$scope.cardsUsed=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_names_list.html",controller:"ModalNamesLIstCtrl",resolve:{selected:function selected(){return $scope.selected;},paxPerCards:function paxPerCards(){return $scope.cardsUsed;}}});});};$scope.openSearchModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"ModalCtrl.html",controller:"OnlineOrderModalInstanceCtrl",resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if($scope.main.isMaster||$scope.main.sale||$scope.main.changeMiles||$scope.main.conference||$scope.main.wizarSaleEvent){filter._issueDateFrom=$rootScope.formatServerDate(filter.issueDateFrom);filter._issueDateTo=$rootScope.formatServerDate(filter.issueDateTo);}else{var date=new Date();date.setDate(date.getDate()-3);if(filter.issueDateFrom&&filter.issueDateFrom!="Invalid Date"){if(filter.issueDateFrom<date){filter.issueDateFrom=new Date();filter.issueDateFrom.setDate(filter.issueDateFrom.getDate()-2);}}else{filter.issueDateFrom=new Date();filter.issueDateFrom.setDate(filter.issueDateFrom.getDate()-2);}if(filter.issueDateTo&&filter.issueDateTo!="Invalid Date"){filter._issueDateTo=$rootScope.formatServerDate(filter.issueDateTo);}filter._issueDateFrom=$rootScope.formatServerDate(filter.issueDateFrom);}$scope.filter=filter;$scope.loadOnlineOrder();},function(){void 0;});};$scope.openStatusModal=function(onlineorder){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/order_status.html",controller:"OrderStatusModalCtrl",periods:$scope.periods,size:"lg",resolve:{order:function order(){return onlineorder;},main:function main(){return $scope.main;}}});modalInstance.result.then(function(filter){},function(){void 0;});};$scope.openNotificationModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/order_notifications.html",controller:"OrderNotificationModalCtrl",periods:$scope.periods,size:"lg",resolve:{order:function order(){return $scope.selected;},onlineflights:function onlineflights(){return $scope.resume_flights;},resume_paxs:function resume_paxs(){return $scope.resume_paxs;}}});modalInstance.result.then(function(filter){if(filter){$scope.tabindex=0;$scope.$digest();}},function(){void 0;});};$scope.openOrdersNotificationModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/order_notification_status.html",controller:"OrdersNotificationModalCtrl",periods:$scope.periods,size:"lg",resolve:{order:function order(){return $scope.selected;}}});modalInstance.result.then(function(filter){},function(){void 0;});};return init();}]).filter("groupBy",function(){return function(data,key){if(!(data&&key))return;var result={};for(var i=0;i<data.length;i++){if(!result[data[i][key]])result[data[i][key]]=[];result[data[i][key]].push(data[i]);}return result;};}).filter("replaceAll",function(){return function(input){return input.replace(/_/g," ");};}).controller("FlightDataCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=this.onlineflight;$scope.originalFlight=angular.copy($scope.flight_selected);var modalInstance;modalInstance=$modal.open({templateUrl:"FlightDataOnline.html",controller:"FlightDataOnlineInstanceCtrl",resolve:{flight_selected:function flight_selected(){return $scope.flight_selected;},originalFlight:function originalFlight(){return $scope.originalFlight;}}});modalInstance.result.then(function(flight_selected){for(var i=0;i<$scope.$parent.$parent.onlineflights.length;i++){if($scope.$parent.$parent.onlineflights[i].flight==flight_selected.flight&&$scope.$parent.$parent.onlineflights[i].boarding_date==flight_selected.boarding_date){$scope.$parent.$parent.onlineflights[i].textarea=flight_selected.textarea;$scope.$parent.$parent.onlineflights[i].flightLocator=flight_selected.flightLocator;$scope.$parent.$parent.onlineflights[i].tax=flight_selected.tax;$scope.$parent.$parent.onlineflights[i].tax_billet=flight_selected.tax_billet;if(flight_selected.provider){$scope.$parent.$parent.onlineflights[i].provider=flight_selected.provider;}if(flight_selected.partnerReservationCode){$scope.$parent.$parent.onlineflights[i].partnerReservationCode=flight_selected.partnerReservationCode;}if(flight_selected.provider=="Rextur Advance"){$scope.$parent.$parent.onlineflights[i].card_number=" - ";$scope.$parent.$parent.onlineflights[i].recovery_password="";$scope.$parent.$parent.onlineflights[i].token="";$scope.$parent.$parent.onlineflights[i].email_provider="";$scope.$parent.$parent.onlineflights[i].card_registrationCode="";$scope.$parent.$parent.onlineflights[i].access_id="";$scope.$parent.$parent.onlineflights[i].access_password="";$scope.$parent.$parent.onlineflights[i].safeType=flight_selected.safeType;}else if(flight_selected.provider=="JACK FOR"||flight_selected.provider=="Outros"){$scope.$parent.$parent.onlineflights[i].card_number=" - ";$scope.$parent.$parent.onlineflights[i].recovery_password="";$scope.$parent.$parent.onlineflights[i].token="";$scope.$parent.$parent.onlineflights[i].email_provider="";$scope.$parent.$parent.onlineflights[i].card_registrationCode="";$scope.$parent.$parent.onlineflights[i].access_id="";$scope.$parent.$parent.onlineflights[i].access_password="";}}}$scope.$parent.$parent.resume_flights=$filter("filter")($scope.$parent.$parent.onlineflights,"FILTER_FLIGHT");});};}]).controller("FlightDataOnlineInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","flight_selected","originalFlight",function($scope,$rootScope,$modalInstance,logger,flight_selected,originalFlight){$scope.flight_selected=originalFlight;$scope.saleMethods=["JACK FOR","CONFIANÇA","Flytour","TAP","Rextur Advance","CNT Consolidadora","HAST Viagens","XML Viagens","Milhas Alpass","Alfa Rondonia Milhas","Outros"];$scope.safeMethods=["Cartao","Faturado"];$scope.ok=function(){$scope.flight_selected.textarea=angular.copy($scope.textarea);$modalInstance.close($scope.flight_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("PaxDataCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.updatePaxName=function(paxId,paxData){$.post("../backend/application/index.php?rota=/updatePaxName",{paxId:paxId,paxData:paxData},function(result){$scope.$parent.$parent.loadPaxesUsedCards();});};$scope.open=function(){$scope.pax_selected=this.pax;$scope.originalPax=angular.copy($scope.pax_selected);$scope.original=angular.copy($scope.pax_selected);$scope.master=$scope.$parent.$parent.$parent.$parent.main.isMaster||$scope.$parent.$parent.$parent.$parent.main.changeSale;$scope.hashId=$scope.$parent.$parent.$parent.$parent.session.hashId;var modalInstance;modalInstance=$modal.open({templateUrl:"PaxData.html",controller:"PaxDataInstanceCtrl",resolve:{pax_selected:function pax_selected(){return $scope.pax_selected;},originalPax:function originalPax(){return $scope.originalPax;},master:function master(){return $scope.master;},hashId:function hashId(){return $scope.hashId;}}});modalInstance.result.then(function(pax_selected){for(var i=0;i<$scope.$parent.$parent.onlineflights.length;i++){if($scope.$parent.$parent.onlineflights[i].pax_id==$scope.original.pax_id){$scope.$parent.$parent.onlineflights[i].pax_name=pax_selected.pax_name;$scope.$parent.$parent.onlineflights[i].paxLastName=pax_selected.paxLastName;$scope.$parent.$parent.onlineflights[i].paxAgnome=pax_selected.paxAgnome;$scope.$parent.$parent.onlineflights[i].identification=pax_selected.identification;$scope.$parent.$parent.onlineflights[i].userEmail=pax_selected.userEmail;$scope.updatePaxName($scope.original.pax_id,pax_selected);}}$scope.$parent.$parent.resume_paxs=$filter("filter")($scope.$parent.$parent.onlineflights,"FILTER_PAX");});};}]).controller("PaxDataInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","pax_selected","originalPax","master","hashId",function($scope,$rootScope,$modalInstance,logger,pax_selected,originalPax,master,hashId){$scope.pax_selected=originalPax;$scope.hashId=hashId;$scope.change=false;$scope.checked=true;$scope.master=master;$scope.changeValue=function(){$scope.change=true;};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.flight_selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$scope.pax_selected.userEmail=$scope.response.userEmail;$scope.checked=false;$scope.change=false;$scope.$apply();}else{$scope.checked=true;logger.logError("Dados não conferem!");$scope.$apply();}});};$scope.ok=function(){$modalInstance.close($scope.pax_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("FlightSelectedData",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$("#discount").maskMoney({thousands:".",decimal:",",precision:2});$("#miles_used").number(true,0,",",".");$scope.flight_selected=this.onlineflight;$scope.originalFlight=angular.copy($scope.flight_selected);if($scope.originalFlight.connection!=" Direto"){if(!$scope.originalFlight.connections){$scope.originalFlight.connections=[];var split=$scope.originalFlight.connection.split(" ");for(var i=1;i<split.length-1;i++){$scope.originalFlight.connections.push({seat:"---"});}}}$scope.master=$scope.$parent.$parent.$parent.$parent.main.isMaster||$scope.$parent.$parent.$parent.$parent.main.changeSale;$scope.hashId=$scope.$parent.$parent.$parent.$parent.session.hashId;if($scope.flight_selected.is_newborn=="S"){$scope.originalFlight.discount=$scope.flight_selected.cost-$scope.flight_selected.discount;}else{$scope.originalFlight.discount=$scope.flight_selected.cost+$scope.flight_selected.tax_billet+$scope.flight_selected.baggage_price+$scope.flight_selected.special_seat-$scope.flight_selected.discount;}var modalInstance;modalInstance=$modal.open({templateUrl:"FlightSelectedData.html",controller:"FlightSelectedDataInstanceCtrl",resolve:{flight_selected:function flight_selected(){return $scope.flight_selected;},originalFlight:function originalFlight(){return $scope.originalFlight;},master:function master(){return $scope.master;},hashId:function hashId(){return $scope.hashId;}}});modalInstance.result.then(function(flight_selected){if(flight_selected.is_newborn=="S"){var discount=flight_selected.cost-flight_selected.discount;}else{var discount=flight_selected.cost+flight_selected.tax_billet+flight_selected.baggage_price+flight_selected.special_seat-flight_selected.discount;}for(var i=0;i<$scope.$parent.$parent.onlineflights.length;i++){if($scope.$parent.$parent.onlineflights[i].flight==flight_selected.flight&&$scope.$parent.$parent.onlineflights[i].pax_id==flight_selected.pax_id&&$scope.$parent.$parent.onlineflights[i].boarding_date==flight_selected.boarding_date){$scope.$parent.$parent.onlineflights[i].miles_used=flight_selected.miles_used;$scope.$parent.$parent.onlineflights[i].flightLocator=flight_selected.flightLocator;$scope.$parent.$parent.onlineflights[i].du_tax=flight_selected.du_tax;$scope.$parent.$parent.onlineflights[i].money=flight_selected.money;$scope.$parent.$parent.onlineflights[i].is_diamond=flight_selected.is_diamond;$scope.$parent.$parent.onlineflights[i].provider=flight_selected.provider;$scope.$parent.$parent.onlineflights[i].userEmail=flight_selected.userEmail;$scope.$parent.$parent.onlineflights[i].discount=discount;$scope.$parent.$parent.onlineflights[i].isBreak=flight_selected.isBreak;$scope.$parent.$parent.onlineflights[i].ticket_code=flight_selected.ticket_code;$scope.$parent.$parent.onlineflights[i].partnerReservationCode=flight_selected.partnerReservationCode;$scope.$parent.$parent.onlineflights[i].seat=flight_selected.seat;$scope.$parent.$parent.onlineflights[i].connections=flight_selected.connections;$scope.$parent.$parent.onlineflights[i].baggage_price=flight_selected.baggage_price;$scope.$parent.$parent.onlineflights[i].special_seat=flight_selected.special_seat;if(flight_selected.provider=="Rextur Advance"){$scope.$parent.$parent.onlineflights[i].card_number=" - ";$scope.$parent.$parent.onlineflights[i].recovery_password="";$scope.$parent.$parent.onlineflights[i].token="";$scope.$parent.$parent.onlineflights[i].email_provider="";$scope.$parent.$parent.onlineflights[i].card_registrationCode="";$scope.$parent.$parent.onlineflights[i].access_id="";$scope.$parent.$parent.onlineflights[i].access_password="";$scope.$parent.$parent.onlineflights[i].safeType=flight_selected.safeType;}else if(flight_selected.provider=="JACK FOR"||flight_selected.provider=="Outros"){$scope.$parent.$parent.onlineflights[i].card_number=" - ";$scope.$parent.$parent.onlineflights[i].recovery_password="";$scope.$parent.$parent.onlineflights[i].token="";$scope.$parent.$parent.onlineflights[i].email_provider="";$scope.$parent.$parent.onlineflights[i].card_registrationCode="";$scope.$parent.$parent.onlineflights[i].access_id="";$scope.$parent.$parent.onlineflights[i].access_password="";}}}$scope.$parent.$parent.resume_flights=$filter("filter")($scope.$parent.$parent.onlineflights,"FILTER_FLIGHT");});};}]).controller("FlightSelectedDataInstanceCtrl",["$scope","$rootScope","$modalInstance","$filter","logger","flight_selected","originalFlight","master","hashId",function($scope,$rootScope,$modalInstance,$filter,logger,flight_selected,originalFlight,master,hashId){$scope.breakoptions=[{breakOption:"Integrado"},{breakOption:"Quebrado"}];$scope.saleMethods=["JACK FOR","CONFIANÇA","Flytour","TAP","Rextur Advance","CNT Consolidadora","HAST Viagens","XML Viagens","Milhas Alpass","Alfa Rondonia Milhas","Outros"];$scope.safeMethods=["Cartao","Faturado"];$scope.flight_selected=originalFlight;$scope.flight_selected.pinCode="";$scope.hashId=hashId;$scope.change=false;$scope.checked=true;$scope.master=master;$scope.cardType=true;if($scope.flight_selected.card_type=="RED"||$scope.flight_selected.card_type=="BLACK"){$scope.cardType=false;}$("#discount").maskMoney({thousands:".",decimal:",",precision:2});$("#miles_used").number(true,0,",",".");if($scope.flight_selected.provider!=""){$scope.third=true;}if($scope.flight_selected.isBreak!="Integrado"){$scope.break=true;}$scope.findBaggagePrice=function(airline,baggages){return _.find($rootScope.airlines,function(o){return o.name==airline;}).baggage*baggages;};$scope.$watch("flight_selected.provider",function(){if($scope.flight_selected.du_tax==undefined){$scope.flight_selected.tax_card=undefined;if($scope.flight_selected.airline=="TAM"||$scope.flight_selected.airline=="LATAM"){if($scope.flight_selected.provider=="Loja TAM Ponta Grossa"){$scope.flight_selected.du_tax=35+$scope.findBaggagePrice($scope.flight_selected.airline,$scope.flight_selected.baggage);}else if($scope.flight_selected.provider=="Loja TAM Contagem"){$scope.flight_selected.du_tax=25+$scope.findBaggagePrice($scope.flight_selected.airline,$scope.flight_selected.baggage);}else if($scope.flight_selected.provider=="Loja TAM M"){$scope.flight_selected.du_tax=28+$scope.findBaggagePrice($scope.flight_selected.airline,$scope.flight_selected.baggage);}}}});$scope.changeValue=function(){$scope.change=true;};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.flight_selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$scope.flight_selected.userEmail=$scope.response.userEmail;$scope.checked=false;$scope.change=false;$scope.$apply();}else{$scope.checked=true;logger.logError("Dados não conferem!");$scope.$apply();}});};$scope.ok=function(){flight_selected=$scope.flight_selected;$modalInstance.close($scope.flight_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("OnlineOrderModalInstanceCtrl",["$scope","$rootScope","$modalInstance","filter",function($scope,$rootScope,$modalInstance,filter){$scope.saleStatus=["RESERVA","PENDENTE","EMITIDO","EM ESPERA"];$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("TaxaCardData",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=this.onlineflight;$.post("../backend/application/index.php?rota=/loadInternalCards",{data:$scope.flight_selected},function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;$scope.decript=function(code){var data=code.split("320AB");var finaly="";for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};for(var i in $scope.internalCards){$scope.internalCards[i].password=$scope.decript($scope.internalCards[i].password);}if($scope.flight_selected.card_number!=" - "){$.post("../backend/application/index.php?rota=/loadCardProvider",{data:$scope.flight_selected},function(result){$scope.TaxCard=jQuery.parseJSON(result).dataset;if($scope.TaxCard.length==1&&$scope.flight_selected.tax_card==undefined){$scope.flight_selected.tax_card=$scope.TaxCard[0].card_number;$scope.flight_selected.tax_providerName=$scope.TaxCard[0].provider_name;}else{$scope.TaxCard={};}$scope.originalFlight=angular.copy($scope.flight_selected);$scope.master=$scope.$parent.$parent.$parent.$parent.main.isMaster||$scope.$parent.$parent.$parent.$parent.main.changeSale;$scope.hashId=$scope.$parent.$parent.$parent.$parent.session.hashId;var modalInstance;modalInstance=$modal.open({templateUrl:"TaxaCardData.html",controller:"TaxaCardInstanceCtrl",resolve:{internalCards:function internalCards(){return $scope.internalCards;},originalFlight:function originalFlight(){return $scope.originalFlight;},flight_selected:function flight_selected(){return $scope.flight_selected;},TaxCard:function TaxCard(){return $scope.TaxCard;},master:function master(){return $scope.master;},hashId:function hashId(){return $scope.hashId;}}});modalInstance.result.then(function(TaxCard){for(var i=0;i<$scope.$parent.$parent.onlineflights.length;i++){if($scope.$parent.$parent.onlineflights[i].flight==$scope.flight_selected.flight&&$scope.$parent.$parent.onlineflights[i].pax_id==$scope.flight_selected.pax_id){$scope.$parent.$parent.onlineflights[i].tax_card=TaxCard.tax_card;$scope.$parent.$parent.onlineflights[i].tax_password=TaxCard.tax_password;$scope.$parent.$parent.onlineflights[i].tax_cardType=TaxCard.tax_cardType;$scope.$parent.$parent.onlineflights[i].tax_dueDate=TaxCard.tax_dueDate;$scope.$parent.$parent.onlineflights[i].tax_providerName=TaxCard.tax_providerName;}}});});}});};}]).controller("TaxaCardInstanceCtrl",["$scope","$rootScope","$modalInstance","$filter","internalCards","originalFlight","flight_selected","TaxCard","master","hashId",function($scope,$rootScope,$modalInstance,$filter,internalCards,originalFlight,flight_selected,TaxCard,master,hashId){$scope.flight_selected={};$scope.findDate=function(date){var data=new Date(date);data.setDate(data.getDate()+1);return data;};$scope.internalCards=internalCards;$scope.flight_selected=originalFlight;$scope.resume_creditCards=$filter("filter")($scope.internalCards,$scope.flight_selected.airline);$scope.TaxCard=TaxCard;$scope.master=master;$scope.hashId=hashId;$scope.change=false;$scope.checked=true;$scope.changeValue=function(){$scope.change=true;};$scope.search=function(){$scope.TaxCard=$filter("filter")($scope.resume_creditCards,$scope.filter);$scope.flight_selected.tax_card=$scope.TaxCard[0].card_number;$scope.flight_selected.tax_password=$scope.TaxCard[0].password;$scope.flight_selected.tax_cardType=$scope.TaxCard[0].card_type;$scope.flight_selected.tax_dueDate=new Date($scope.TaxCard[0].due_date);$scope.flight_selected.tax_providerName=$scope.TaxCard[0].provider_name;$scope.flight_selected.provider_registration=$scope.TaxCard[0].provider_registration;$scope.flight_selected.providerPhone=$scope.TaxCard[0].providerPhone;$scope.flight_selected.providerEmail=$scope.TaxCard[0].providerEmail;$scope.flight_selected.providerAdress=$scope.TaxCard[0].providerAdress;$scope.flight_selected.provider_adress=$scope.TaxCard[0].provider_adress;$scope.flight_selected.birthdate=new Date($scope.TaxCard[0].birthdate);};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{hashId:$scope.hashId,data:$scope.flight_selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$scope.flight_selected.userEmail=$scope.response.userEmail;$scope.checked=false;$scope.change=false;$scope.$apply();}else{$scope.checked=true;logger.logError("Dados não conferem!");$scope.$apply();}});};$scope.ok=function(){flight_selected=$scope.flight_selected;$modalInstance.close($scope.flight_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("CardFlightSelectedData",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=this.onlineflight;var modalInstance;modalInstance=$modal.open({templateUrl:"CardFlightSelectedData.html",controller:"CardFlightSelectedDataInstanceCtrl",resolve:{flight_selected:function flight_selected(){return $scope.flight_selected;}}});modalInstance.result.then(function(flight_selected){});};}]).controller("CardFlightSelectedDataInstanceCtrl",["$scope","$rootScope","$modalInstance","flight_selected",function($scope,$rootScope,$modalInstance,flight_selected){$scope.flight_selected=flight_selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("OnlineModalPermissionCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on("openPermission",function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){args.main.userEmail="";args.main.userPassCode="";args.main.pinCode="";args.main.type=args.type;var modalInstance;modalInstance=$modal.open({templateUrl:"OnlineModalPermissionCtrl.html",controller:"OnlineModalPermissionInstanceCtrl",resolve:{permissions:function permissions(){return args.main;},hashId:function hashId(){return args.hashId;},selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(permissions){$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller("OnlineModalPermissionInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","permissions","hashId","selected",function($scope,$rootScope,$modalInstance,logger,permissions,hashId,selected){$scope.permissions=permissions;$scope.hashId=hashId;$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.email=function(){$rootScope.$emit("fillEmailBLoqued",{email:$rootScope.onlineOrder.client_email});$scope.cancel();};$scope.emailCommecial=function(){$rootScope.$emit("fillEmailBLoqued",{email:'suporte@onemilhas.com.br'});$scope.cancel();};$scope.setStatusOrder=function(order,status){if(!order){order=$rootScope.onlineOrder;}$.post("../backend/application/index.php?rota=/setStatusOrder",{hashId:$scope.hashId,data:order,status:status},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.checkCommercial=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$.post("../backend/application/index.php?rota=/setStatusOrderCommercial",{data:$rootScope.onlineOrder},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});$modalInstance.close($scope.permissions);}else{logger.logError("Dados não conferem!");}});};$scope.checkCommercialFaturado=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$.post("../backend/application/index.php?rota=/setStatusOrderCommercialFaturado",{data:$rootScope.onlineOrder,faturado:$scope.permissions.days},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});$modalInstance.close($scope.permissions);}else{logger.logError("Dados não conferem!");}});};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{hashId:$scope.hashId,data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$modalInstance.close($scope.permissions);$rootScope.$emit("checkedPermission",{});}else{logger.logError("Dados não conferem!");}});};}]).controller("CardTaxFlightDataCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=this.onlineflight;$.post("../backend/application/index.php?rota=/loadInternalCards",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;$scope.decript=function(code){var data=code.split("320AB");var finaly="";for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};for(var i in $scope.internalCards){$scope.internalCards[i].password=$scope.decript($scope.internalCards[i].password);}if($scope.flight_selected.card_number!=" - "){$.post("../backend/application/index.php?rota=/loadCardProvider",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.TaxCard=jQuery.parseJSON(result).dataset;if($scope.TaxCard.length==1&&$scope.flight_selected.tax_card==undefined){$scope.flight_selected.tax_card=$scope.TaxCard[0].card_number;$scope.flight_selected.tax_providerName=$scope.TaxCard[0].provider_name;}else{$scope.TaxCard={};}$scope.originalFlight=angular.copy($scope.flight_selected);$scope.master=$scope.$parent.$parent.$parent.$parent.main.isMaster||$scope.$parent.$parent.$parent.$parent.main.changeSale;$scope.hashId=$scope.$parent.$parent.$parent.$parent.session.hashId;var modalInstance;modalInstance=$modal.open({templateUrl:"CardTaxFlightDataCtrl.html",controller:"TaxaCardFlightDataInstanceCtrl",resolve:{internalCards:function internalCards(){return $scope.internalCards;},originalFlight:function originalFlight(){return $scope.originalFlight;},flight_selected:function flight_selected(){return $scope.flight_selected;},TaxCard:function TaxCard(){return $scope.TaxCard;},master:function master(){return $scope.master;},hashId:function hashId(){return $scope.hashId;}}});modalInstance.result.then(function(TaxCard){for(var i=0;i<$scope.$parent.$parent.onlineflights.length;i++){if($scope.$parent.$parent.onlineflights[i].flight==$scope.flight_selected.flight&&$scope.$parent.$parent.onlineflights[i].boarding_date==$scope.flight_selected.boarding_date){$scope.$parent.$parent.onlineflights[i].tax_card=TaxCard.tax_card;$scope.$parent.$parent.onlineflights[i].tax_password=TaxCard.tax_password;$scope.$parent.$parent.onlineflights[i].tax_cardType=TaxCard.tax_cardType;$scope.$parent.$parent.onlineflights[i].tax_dueDate=TaxCard.tax_dueDate;$scope.$parent.$parent.onlineflights[i].tax_providerName=TaxCard.tax_providerName;}}});});}});};}]).controller("TaxaCardFlightDataInstanceCtrl",["$scope","$rootScope","$modalInstance","$filter","internalCards","originalFlight","flight_selected","TaxCard","master","hashId",function($scope,$rootScope,$modalInstance,$filter,internalCards,originalFlight,flight_selected,TaxCard,master,hashId){$scope.internalCards=internalCards;$scope.flight_selected=originalFlight;$scope.flight_selected.pinCode="";$scope.resume_creditCards=$filter("filter")($scope.internalCards,$scope.flight_selected.airline);$scope.resume_creditCards.push({card_number:"OUTRO"});$scope.TaxCard=TaxCard;$scope.master=master;$scope.hashId=hashId;$scope.change=false;$scope.checked=true;$scope.findDate=function(date){var data=new Date(date);data.setDate(data.getDate()+1);return data;};$scope.changeValue=function(){$scope.change=true;};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{hashId:$scope.hashId,data:$scope.flight_selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$scope.flight_selected.userEmail=$scope.response.userEmail;$scope.checked=false;$scope.change=false;$scope.$apply();}else{$scope.checked=true;logger.logError("Dados não conferem!");$scope.$apply();}});};$scope.search=function(){$scope.TaxCard=$filter("filter")($scope.resume_creditCards,$scope.filter);$scope.flight_selected.tax_card=$scope.TaxCard[0].card_number;$scope.flight_selected.tax_password=$scope.TaxCard[0].password;$scope.flight_selected.tax_cardType=$scope.TaxCard[0].card_type;$scope.flight_selected.tax_dueDate=new Date($scope.TaxCard[0].due_date);$scope.flight_selected.tax_providerName=$scope.TaxCard[0].provider_name;$scope.flight_selected.provider_registration=$scope.TaxCard[0].provider_registration;$scope.flight_selected.providerAdress=$scope.TaxCard[0].providerAdress;$scope.flight_selected.providerPhone=$scope.TaxCard[0].providerPhone;$scope.flight_selected.providerEmail=$scope.TaxCard[0].providerEmail;$scope.flight_selected.provider_adress=$scope.TaxCard[0].provider_adress;$scope.flight_selected.birthdate=new Date($scope.TaxCard[0].birthdate);};$scope.ok=function(){flight_selected=$scope.flight_selected;$modalInstance.close($scope.flight_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("FindAllCardsInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","main",function($scope,$rootScope,$modalInstance,logger,main){$scope.main=main;$scope.flight_selected={pinCode:""};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.flight_selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$modalInstance.close($scope.response);}else{logger.logError("Dados não conferem!");}});};}]).controller("CloseOrder",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=$scope.$parent.selected;if($scope.flight_selected.comments.length>0||$scope.$parent.findSpecialCards()){var modalInstance;modalInstance=$modal.open({templateUrl:"CloseOrder.html",controller:"CloseOrderInstanceCtrl",resolve:{flight_selected:function flight_selected(){return $scope.flight_selected;},onlineflights:function onlineflights(){return $scope.$parent.onlineflights;}}});modalInstance.result.then(function(){$scope.$parent.saveOrder();});}else{$scope.$parent.saveOrder();}};}]).controller("CloseOrderInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","flight_selected","onlineflights",function($scope,$rootScope,$modalInstance,logger,flight_selected,onlineflights){$scope.flight_selected=flight_selected;$scope.onlineflights=onlineflights;$scope.findSpecialCardsLATAM=function(){if($scope.onlineflights){if($scope.onlineflights.length>0){for(var i in $scope.onlineflights){if($scope.onlineflights[i].card_type=="RED"||$scope.onlineflights[i].card_type=="BLACK")return true;}}}return false;};$scope.findSpecialCardsGOL=function(){if($scope.onlineflights){if($scope.onlineflights.length>0){for(var i in $scope.onlineflights){if($scope.onlineflights[i].card_type=="DIAMANTE"||$scope.onlineflights[i].card_type=="CLUBE DIAMANTE")return true;}}}return false;};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close();};}]).controller("ClientWarningInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","selected",function($scope,$rootScope,$modalInstance,logger,selected){$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("OrderStatusModalCtrl",["$scope","$rootScope","$modalInstance","logger","order","main",function($scope,$rootScope,$modalInstance,logger,order,main){$scope.main=main;$scope.selected=order;$scope.setStatusOrder=function(status){$.post("../backend/application/index.php?rota=/setStatusOrder",{data:$scope.selected,status:status},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.cancel();});};$scope.checkCommercial=function(){$.post("../backend/application/index.php?rota=/setStatusOrderCommercial",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancel();});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("OrderNotificationModalCtrl",["$scope","$rootScope","$modalInstance","logger","order","onlineflights","resume_paxs",function($scope,$rootScope,$modalInstance,logger,order,onlineflights,resume_paxs){$scope.selected=order;$scope.onlineflights=onlineflights;$scope.resume_paxs=resume_paxs;$scope.retarifation=false;$scope.inf=0;$scope.chd=0;$scope.adt=0;for(var i=0;$scope.resume_paxs.length>i;i++){if($scope.resume_paxs[i].is_child=="S")$scope.chd++;else if($scope.resume_paxs[i].is_newborn=="S")$scope.inf++;else $scope.adt++;}$scope.retarifation_opts=[];for(var _i in onlineflights){var path="IDA";if(_i!="0"){path="VOLTA";}$scope.retarifation_opts.push({milhas_adulto:parseFloat(onlineflights[_i].miles_per_adult),milhas_crianca:parseFloat(onlineflights[_i].miles_per_child),milhas_bebe:parseFloat(onlineflights[_i].miles_per_newborn),data_embarque:onlineflights[_i].boarding_date,voo:onlineflights[_i].flight,origem:onlineflights[_i].airport_code_from,destino:onlineflights[_i].airport_code_to,retarifation:false,path:path});}$scope.setNotificationOrder=function(status){if(status!="3"){$scope.retarifation_opts=undefined;}else{var retarifation=false;for(var i in $scope.retarifation_opts){if($scope.retarifation_opts[i].retarifation==true){retarifation=true;}}if(!retarifation){return logger.logError("Retarifação deve ser marcada");}}$.post("../backend/application/index.php?rota=/setNotificationOrder",{data:$scope.selected,status:status,retarifation:$scope.retarifation_opts},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(true);});};$scope.setNotification=function(){$scope.retarifation=true;};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("OrdersNotificationModalCtrl",["$scope","$rootScope","$modalInstance","logger","order",function($scope,$rootScope,$modalInstance,logger,order){$scope.selected=order;$.post("../backend/application/index.php?rota=/loadNotificationOrder",{data:$scope.selected},function(result){$scope.notifications=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.findDate=function(date){return new Date(date);};$scope.reSendBillets=function(){$.post("../backend/application/index.php?rota=/reSendBillets",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.reSendOrder=function(){$.post("../backend/application/index.php?rota=/reSendOrder",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();(function(){'use strict';angular.module('app.table').controller('OnlineOrderWaitingCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger','FileUploader',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader){var init;var partnerSelected;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredOnlineOrders=[];$scope.row='';$scope.previousIndex=0;$scope.currentPage=1;$scope.card=[];$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageOnlineOrder=$scope.filteredOnlineOrders.slice(start,end);};$scope.onFilterChange=function(){$scope.select($scope.currentPage);return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$rootScope.$on('checkedPermission',function(event,args){$scope.setSelected(true);});$rootScope.$on('fillEmailBLoqued',function(event,args){$scope.fillEmailBLoqued(args);});$scope.fillEmailBLoqued=function(args){$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco=undefined;$scope.wsalemail.subject='[One Milhas] - Pedido de emissão';var date=new Date();date.setUTCHours(date.getUTCHours()-2);if($scope.response){if($scope.response.subClientEmail){$scope.wsalemail.emailpartner=$scope.response.subClientEmail;}if($scope.check48hours()){$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>One Milhas";}else if($scope.response.status=="Bloqueado"){$scope.wsalemail.emailContent="Olá, <br><br>"+"Antes de seguirmos com a emissão, nosso setor financeiro solicita contato para as devidas atualizações.<br>"+"Horário de atendimento do setor financeiro: Segunda a Sexta de 09:00 as 18:00 ( horário de Brasília )  <br><br>"+"Email: financeiro@onemilhas.com.br <br>Telefones: (31) 3972-1929 <br><br>";$scope.wsalemail.mailcco="comercial@onemilhas.com.br";$scope.wsalemail.emailContent+="Atenciosamente.<br>One Milhas";}else if($scope.response.status=="Pendente"){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Cliente com status PENDENTE!"+"<br>"+$scope.response.client_name+"<br>"+"Atenciosamente.<br>One Milhas";if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=21){$scope.wsalemail.emailpartner='comercial@onemilhas.com.br';}else if(date.getDay()>0&&date.getDay()<6){$scope.wsalemail.mailcco="comercial@onemilhas.com.br";}else{$scope.wsalemail.emailpartner='comercial@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>21||date.getUTCHours()<=2)){$scope.wsalemail.mailcco="comercial@onemilhas.com.br";$scope.wsalemail.emailContent="Caro Parceiro.<br><br>"+"Agradecemos a confiança ao enviar a 1º emissão.Dentre as próximas horas iremos enviar nosso protocolo de ativação finalizando nosso cadastro.<br>"+"Para seguirmos com essa emissão gentileza entrar em contato com nosso setor comercial para alinharmos os últimos detalhes.<br><br>"+"(31) 3972-1929<br><br>"+"comercial@onemilhas.com.br<br><br>"+"Atenciosamente<br>Equipe One Milhas";}}else if($scope.response.paymentType=="Antecipado"){$scope.wsalemail.mailcco="comercial@onemilhas.com.br";$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Para darmos andamento a sua solicitação, pedimos que nos encaminhe o comprovante de pagamento neste mesmo e-mail: emissao@onemilhas.com.br . Aguardamos o recebimento do comprovante e liberação do setor financeiro para seguirmos com o processo..<br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: (31) 3972-1929<br><br>";$scope.wsalemail.emailContent+="<table style='text-align: center; border-collapse: collapse;' border='1' width='95%' align='center'><tbody>"+"<tr bgcolor='#FFFFFF'><td>&nbsp;</td><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Caixa</strong></span></td><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Bradesco</strong></span></td>"+"<td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Ita&uacute;</strong></span></td><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Brasil</strong></span></td>"+"<td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Santander</strong></span></td></tr><tr><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Banco:</strong></span></td>"+"<td>104</td><td>237</td><td>341</td><td>001</td><td>033</td></tr><tr><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Ag&ecirc;ncia:</strong></span></td>"+"<td>2922</td><td>3420</td><td>1582</td><td>-</td><td>4232</td></tr><tr><td bgcolor='#5D7B9D'><span style='color: #ffffff;'><strong>Conta:</strong></span></td>"+"<td>2643-6</td><td>29429-2</td><td>33678-8</td><td>-</td>"+"<td>13004689-8</td></tr><tr><td colspan='6'><strong>MMS VIAGENS LTDA</strong><br /><strong>CNPJ: 29.632.355/0001-85</strong></td></tr></tbody></table><br><br>";$scope.wsalemail.emailContent+="Atenciosamente.<br>One Milhas";}else if($scope.response.partner_limit=='true'){$scope.wsalemail.emailContent="Caro Parceiro, <br><br>"+"Seu limite foi excedido, com isso pedimos que entre em contato com o setor financeiro para seguirmos com a emissão.<br><br>"+"Email: financeiro@onemilhas.com.br<br> Telefones: 3972-1929<br><br>"+"Atenciosamente.<br>One Milhas";if(date.getDay()==0||date.getDay()==6){$scope.wsalemail.emailpartner='comercial@onemilhas.com.br;financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&date.getUTCHours()>=9&&date.getUTCHours()<=23){$scope.wsalemail.emailpartner='comercial@onemilhas.com.br;financeiro@onemilhas.com.br';}if(date.getDay()>0&&date.getDay()<6&&(date.getUTCHours()>23||date.getUTCHours()<=2)){$scope.wsalemail.emailpartner=args.email;$scope.wsalemail.mailcco="comercial@onemilhas.com.br";}}}else{$scope.wsalemail.emailContent="Prezado Parceiro, <br><br>"+"Conforme procedimentos internos, não emitimos trechos GOL com menos de 48 horas para o embarque.<br><br>"+"Atenciosamente.<br>One Milhas";}$scope.uploader.clearQueue();if($scope.response){if($scope.response.client_name){$scope.wsalemail.emailContent+="<br><br>Cliente: "+$scope.response.client_name;}}$scope.wsalemail.emailContent+="<br><br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Trechos</font></td></tr>"+"<tr><td>CIA</td><td>VOO</td><td>Conexões</td><td>Embarque</td><td>Desembarque</td><td>Duração</td><td>Origem</td><td>Destino</td></tr>";for(var i=0;$scope.resume_flights.length>i;i++){var testes=$scope.resume_flights[i].connection.split(' ');var connections='';for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[i].airline+"</td><td>"+$scope.resume_flights[i].flight+"</td><td>"+connections+"</td><td>"+$filter('date')($rootScope.findDate($scope.resume_flights[i].boarding_date),'dd/MM/yyyy')+"<br>"+$filter('date')($rootScope.findDate($scope.resume_flights[i].boarding_date),'HH:mm:ss')+"</td><td>"+$filter('date')($rootScope.findDate($scope.resume_flights[i].landing_date),'dd/MM/yyyy')+"<br>"+$filter('date')($rootScope.findDate($scope.resume_flights[i].landing_date),'HH:mm:ss')+"</td><td>"+$scope.resume_flights[i].flight_time+"</td><td>"+$scope.resume_flights[i].airport_description_from+"</td><td>"+$scope.resume_flights[i].airport_description_to+"</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table>"+"<br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'>Passageiros</font></td></tr>";for(var i=0;$scope.resume_paxs.length>i;i++){var pax_name=$scope.resume_paxs[i].pax_name;if($scope.resume_paxs[i].paxLastName){pax_name+=' '+$scope.resume_paxs[i].paxLastName;}if($scope.resume_paxs[i].paxAgnome){pax_name+=' '+$scope.resume_paxs[i].paxAgnome;}$scope.wsalemail.emailContent+="<tr><td colspan='2' bgcolor='#5D7B9D'><font color='#ffffff'> Passageiro "+(i+1)+" </font></td></tr><tr><td>Nome:</td><td>"+pax_name+"</td></tr><tr><td>Identificação:</td><td>"+$scope.resume_paxs[i].identification+"</td></tr><tr><td>Data Nascimento:</td><td>"+$filter('date')($scope.resume_paxs[i].birhtdate,'dd/MM/yyyy')+"</td></tr>";if($scope.resume_paxs[i].is_child!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>CHD</td></tr>";if($scope.resume_paxs[i].is_newborn!="N")$scope.wsalemail.emailContent+="<tr><td></td><td>INF</td></tr>";}$scope.wsalemail.emailContent+="</tbody></table><br><br>";if($scope.response){if($scope.response.status=='Bloqueado'||$scope.response.paymentType=='Antecipado'||$scope.response.partner_limit=='true'){$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles='';var pricing='';var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.resume_paxs){if($scope.resume_paxs[a].is_child=='S'){NumberOfChild++;}else if($scope.resume_paxs[a].is_newborn=='S'){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var miles='';var pricing='';var testes=$scope.resume_flights[b].connection.split(' ');connections='';for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+'ADT: '+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult,0)+' (x'+$rootScope.formatNumber(NumberOfAdult,0)+')';pricing=pricing+'ADT: '+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+' (x'+$rootScope.formatNumber(NumberOfAdult,0)+')';}if(NumberOfChild>0){miles=miles+'<br>CHD: '+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child,0)+' (x'+$rootScope.formatNumber(NumberOfChild,0)+')';pricing=pricing+'<br>CHD: '+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+' (x'+$rootScope.formatNumber(NumberOfChild,0)+')';}if(NumberOfNewborn>0){miles=miles+'<br>INF: '+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn,0)+' (x'+$rootScope.formatNumber(NumberOfNewborn,0)+')';pricing=pricing+'<br>INF: '+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+' (x'+$rootScope.formatNumber(NumberOfNewborn,0)+')';}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.total_cost)+"</font></td></tr>"+"</tbody></table>";}}else{$scope.wsalemail.emailContent+="<table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'><tbody><tr bgcolor='#5D7B9D'><td colspan='8' bgcolor='#5D7B9D'><font color='#ffffff'>Financeiro</font></td></tr>"+"<tr><td>CIA</td><td>#VOO</td><td>Milhas(Trecho)</td><td>Tarifa(Trecho)</td><td>Taxas(Trecho)</td><td>PAX(Trecho)</td><td>Milhas Total</td><td>Valor Total</td></tr>";var miles='';var pricing='';var NumberOfAdult=0;var NumberOfChild=0;var NumberOfNewborn=0;for(var a in $scope.onlineflights){if($scope.onlineflights[a].is_child=='S'){NumberOfChild++;}else if($scope.onlineflights[a].is_newborn=='S'){NumberOfNewborn++;}else{NumberOfAdult++;}}var connections;for(var b in $scope.resume_flights){var testes=$scope.resume_flights[b].connection.split(' ');connections='';for(var j=0;j<testes.length;j++){connections+=testes[j]+"<br>";}if(NumberOfAdult>0){miles=miles+'ADT: '+$rootScope.formatNumber($scope.resume_flights[b].miles_per_adult)+' (x'+$rootScope.formatNumber(NumberOfAdult,0)+')';pricing=pricing+'ADT: '+$rootScope.formatNumber($scope.resume_flights[b].cost_per_adult)+' (x'+$rootScope.formatNumber(NumberOfAdult,0)+')';}if(NumberOfChild>0){miles=miles+'<br>CHD: '+$rootScope.formatNumber($scope.resume_flights[b].miles_per_child)+' (x'+$rootScope.formatNumber(NumberOfChild,0)+')';pricing=pricing+'<br>CHD: '+$rootScope.formatNumber($scope.resume_flights[b].cost_per_child)+' (x'+$rootScope.formatNumber(NumberOfChild,0)+')';}if(NumberOfNewborn>0){miles=miles+'<br>INF: '+$rootScope.formatNumber($scope.resume_flights[b].miles_per_newborn)+' (x'+$rootScope.formatNumber(NumberOfNewborn,0)+')';pricing=pricing+'<br>INF: '+$rootScope.formatNumber($scope.resume_flights[b].cost_per_newborn)+' (x'+$rootScope.formatNumber(NumberOfNewborn,0)+')';}$scope.wsalemail.emailContent+="<tr><td>"+$scope.resume_flights[b].airline+"</td><td>"+$scope.resume_flights[b].flight+"</td>"+"<td>"+miles+"</td><td>"+pricing+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].tax)+"</td><td>"+NumberOfAdult+" ADT<br>"+NumberOfChild+" CHD<br>"+NumberOfNewborn+" INF"+"</td>"+"<td>"+$rootScope.formatNumber($scope.resume_flights[b].original_miles,0)+"</td><td>"+$rootScope.formatNumber($scope.resume_flights[b].cost+$scope.resume_flights[b].tax)+"</td></tr>";}$scope.wsalemail.emailContent+="<tr bgcolor='#5D7B9D'><td colspan='6' bgcolor='#5D7B9D'><font color='#ffffff'>Total</font></td>"+"<td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.miles_used,0)+"</font></td><td bgcolor='#5D7B9D'><font color='#ffffff'>"+$rootScope.formatNumber($rootScope.onlineOrder.total_cost)+"</font></td></tr>"+"</tbody></table>";}$scope.previousIndex=$scope.tabindex;$scope.tabindex=5;};$scope.check48hours=function(argument){var date=new Date();date.setDate(date.getDate()+2);for(var i=0;$scope.onlineflights.length>i;i++){if($scope.onlineflights[i].airline=="GOL"&&new Date($scope.onlineflights[i].boarding_date)<date){return true;}}return false;};$scope.getTotalTaxFlight=function(flightLocator){var tax=0;$scope.selectedFlights=$filter('filter')($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].is_newborn!="S"){tax+=$scope.selectedFlights[i].tax_billet;if($scope.selectedFlights[i].money){tax+=$scope.selectedFlights[i].money;}}}return tax;};$scope.getTotalMilesFlight=function(flightLocator,flight){var miles=0;$scope.selectedFlights=$filter('filter')($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].flight==flight){miles+=$scope.selectedFlights[i].miles_used;}}return miles;};$scope.getTotalMilesOrder=function(flightLocator){var miles=0;$scope.selectedFlights=$filter('filter')($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){miles+=$scope.selectedFlights[i].miles_used;}return miles;};$scope.getTotalTaxFlightFlight=function(flightLocator,flight){var tax=0;$scope.selectedFlights=$filter('filter')($scope.onlineflights,flightLocator);for(var i in $scope.selectedFlights){if($scope.selectedFlights[i].flight==flight){if($scope.selectedFlights[i].is_newborn!="S"){tax+=$scope.selectedFlights[i].tax;if($scope.selectedFlights[i].money){tax+=$scope.selectedFlights[i].money;}}}}return tax;};$scope.checkPaxName=function(name){var listNames=['JUNIOR','NETO','FILHO','SOBRINHO'];return listNames.indexOf(name)>-1;};$scope.changeClassFlights=function(flight){for(var i in $scope.onlineflights){if($scope.onlineflights[i].boarding_date==flight.boarding_date&&$scope.onlineflights[i].airport_code_from==flight.airport_code_from&&$scope.onlineflights[i].airport_code_to==flight.airport_code_to){$scope.onlineflights[i].class=flight.class;}}};$scope.search=function(){$scope.filteredOnlineOrders=$filter('filter')($scope.onlineorder,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredOnlineOrders=$filter('orderBy')($scope.onlineorder,rowName);return $scope.onOrderChange();};$scope.search_flight=function(){$scope.filteredonlineflights=$filter('filter')($scope.onlineflights,$scope.searchKeywords);};$scope.order_flight=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredonlineflights=$filter('orderBy')($scope.onlineflights,rowName);};$scope.search_miles=function(){$scope.currentMiles=$filter('filter')($scope.flight_miles,$scope.searchKeywordsMiles);};$scope.order_miles=function(rowName){$scope.rowMiles=rowName;$scope.filteredflight_miles=$filter('orderBy')($scope.flight_miles,rowName);$scope.onOrderMilesChange();};$scope.onOrderMilesChange=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.back=function(){$scope.tabindex=$scope.tabindex-1;$scope.searchKeywords='';};$scope.next=function(){$scope.tabindex=$scope.tabindex+1;};$scope.findColor=function(order){switch(order.status){case'PENDENTE':return"";case'PRIORIDADE':return"";case'VOEB2B':return"";case'ESPERA VLR':return"";case'ESPERA LIM VLR':return"";case'ANT':return"";case'BLOQ':return"";case'ESPERA LIM':return"";case'ESPERA PGTO':return"";case'EMITIDO':if(order.showSms&&!order.sms){return"#FFA26D";}return"#9DCE9D";case'ENVIADO':return"#9DCE9D";case'RESERVA':return"#9BB3DC";case'CANCELADO':return"#F38E8E";case'FALHA EMISSAO':return"#F38E8E";case'VERIFICADO':if(order.showSms&&!order.sms){return"#FFA26D";}}};$scope.findClass=function(onlineflight){if(onlineflight.flightLocator==undefined||onlineflight.flightLocator==''||(onlineflight.airline=='TAM'||onlineflight.airline=='LATAM')&&(onlineflight.ticket_code==undefined||onlineflight.ticket_code==''))return'btn btn-danger smallBtn';else return'btn btn-line-info smallBtn';};$scope.orderTag=function(status){switch(status){case'PENDENTE':return"label label-warning";case'ESPERA VLR':return"label label-default";case'PRIORIDADE':return"label label-purple";case'VOEB2B':return"label label-purple";case'ESPERA PGTO':return"label label-default";case'ESPERA LIM':return"label label-default";case'RESERVA':return"label label-info";case'ENVIADO':return"label label-success";case'EMITIDO':return"label label-success";case'VERIFICADO':return"label label-success";case'CANCELADO':return"label label-danger";case'FALHA EMISSAO':return"label label-danger";case'ESPERA':return"label label-default";case'ESPERA LIM VLR':return"label label-default";case'ANT':return"label label-default";case'BLOQ':return"label label-default";}};$scope.orderTagClient=function(order){if(order.commercialStatus){return"label label-warning";}if(order.check_2==true){return"label label-info";}switch(order.status){case'PENDENTE':return"label label-warning";case'ESPERA VLR':return"label label-default";case'PRIORIDADE':return"label label-purple";case'VOEB2B':return"label label-purple";case'ESPERA PGTO':return"label label-default";case'ESPERA LIM':return"label label-default";case'RESERVA':return"label label-info";case'ENVIADO':return"label label-success";case'EMITIDO':return"label label-success";case'VERIFICADO':return"label label-success";case'CANCELADO':return"label label-danger";case'FALHA EMISSAO':return"label label-danger";case'ESPERA':return"label label-default";case'ESPERA LIM VLR':return"label label-default";case'ANT':return"label label-default";case'BLOQ':return"label label-default";}};$scope.orderMiles=function(mile){switch(mile.priority){case'-1':return"label label-success";case'0':return"label label-primary";case'1':return"label label-danger";case'2':return"label label-warning";default:return"";}};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.numPerPageOpt=[10,30,50,100,200];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageOnlineOrder=[];$scope.numPerPageOptMiles=[10,30,50,100,200];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.selectMiles=function(page){var end,start;start=(page-1)*$scope.numPerPageMiles;end=start+$scope.numPerPageMiles;return $scope.currentMiles=$scope.filteredflight_miles.slice(start,end);};$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.atualization=function(){if(document.getElementById('online_page')&&($scope.tabindex===0||$scope.tabindex===99||$scope.tabindex===6)&&$scope.atualizations==true){$scope.loadOnlineOrderWaiting();}};$scope.$watch('[tabindex, atualizations]',function(){if(($scope.tabindex===0||$scope.tabindex===99||$scope.tabindex===6)&&$scope.atualizations==true){$scope.reserve=false;$scope.atualization();}if($scope.tabindex!=6){if($scope.tabindex==0){$rootScope.socket.emit('order_update',{order_id:undefined,name:$scope.main.name});}else{$rootScope.socket.emit('order_update',{order_id:$scope.selected.id,name:$scope.main.name});}}});init=function init(){$scope.tabindex=0;if($scope.main.dealer){$scope.tabindex=99;}else if($scope.main.commercial){$scope.tabindex=6;}$scope.checkValidRoute();if($scope.main.id==''){return;}$scope.wsale={};$('#discount').number(true,2,',','.');$scope.milesMoney=false;$scope.third=false;$scope.atualizations=true;$rootScope.modalOpen=false;$scope.multiDownloads=false;$.post("../backend/application/index.php?rota=/loadAirline",{},function(result){$rootScope.airlines=jQuery.parseJSON(result).dataset;});$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<18;}});$rootScope.socket.on('updateOrdersWaiting',function(data){if($scope.atualizations){$scope.onlineorder=data.orders;$scope.search();$scope.$digest();}});$rootScope.socket.on('order_update',function(data){if(data.order_id){var tempOrder=$filter('filter')($scope.onlineorder,data.order_id);$scope.addSessionName(data.order_id,data.name);}else{$scope.removeSessionName(data.name);}$scope.search();$scope.$digest();});};$scope.addSessionName=function(order_id,name){var tempOrders=$filter('filter')($scope.onlineorder,order_id);for(var idOrder in tempOrders){var newSessionName='';var and='';if(tempOrders[idOrder].userSession){var sessionName=tempOrders[idOrder].userSession.split(';');for(var idName in sessionName){if(sessionName[idName]!=name){newSessionName+=and+sessionName[idName];and=';';}}}tempOrders[idOrder].userSession=newSessionName+and+name;}};$scope.removeSessionName=function(name){var tempOrders=$filter('filter')($scope.onlineorder,name);for(var idOrder in tempOrders){var newSessionName='';var and='';if(tempOrders[idOrder].userSession){var sessionName=tempOrders[idOrder].userSession.split(';');for(var idName in sessionName){if(sessionName[idName]!=name){newSessionName+=and+sessionName[idName];and=';';}}}tempOrders[idOrder].userSession=newSessionName;}};$scope.setStatusOrder=function(order,status){if(!order){order=$rootScope.onlineOrder;}$.post("../backend/application/index.php?rota=/setStatusOrder",{hashId:$scope.session.hashId,data:order,status:status},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;});};$scope.backToList=function(){$scope.tabindex=0;};$scope.loadOnlineOrderWaiting=function(){cfpLoadingBar.start();if($scope.tabindex==0||$scope.tabindex==99||$scope.tabindex==6){$scope.selected={};}$.post("../backend/application/index.php?rota=/loadOnlineOrderWaiting",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.onlineorder=jQuery.parseJSON(result).dataset;if($scope.tabindex==0||$scope.tabindex==99||$scope.tabindex==6){$scope.search();$scope.cancel=false;cfpLoadingBar.complete();}});};$scope.taxByFlight=function(onlineflight){var tax=0;if(onlineflight.is_newborn!='S'){tax+=onlineflight.tax;}tax+=onlineflight.du_tax;return tax;};$scope.checkTimeFlight=function(args){if(args==undefined){var date=new Date();date.setDate(date.getDate()+2);for(var i=0;$scope.onlineflights.length>i;i++){if($scope.onlineflights[i].airline=="GOL"&&new Date($scope.onlineflights[i].boarding_date)<date){logger.logError("Voo GOL com embarque inferior a 48Hrs!");$scope.previousIndex=0;$scope.tabindex=0;$rootScope.$emit('openPermission',{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});$scope.$apply();return;}}}};$scope.getAllCheckend=function(){if($scope.selected){if($scope.selected.status=='EMITIDO'||$scope.selected.status=='VERIFICADO'){for(var i in $scope.onlineflights){if($scope.onlineflights[i].saleChecked==false)return false;}return true;}return false;}return false;};$scope.findMilesOrder=function(){var miles=0;for(var i in $scope.filteredOnlineOrders){miles+=$scope.filteredOnlineOrders[i].miles_used;}return $rootScope.formatNumber(miles,0);};$scope.loadOnlineFlight=function(args){$scope.args=args;$scope.selected.startedDate=new Date();$scope.tabindex=3;$scope.showNextStep=false;cfpLoadingBar.start();$scope.commercial_free={};$.post("../backend/application/index.php?rota=/loadCommercialStatusOrder",{data:$scope.selected},function(result){$scope.commercial_free=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadOnlineFlight",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.onlineflights=jQuery.parseJSON(result).dataset;$scope.filteredonlineflights=jQuery.parseJSON(result).dataset;$scope.search();$scope.resume_flights=$filter('filter')($scope.onlineflights,'FILTER_FLIGHT');$scope.resume_paxs=$filter('filter')($scope.onlineflights,'FILTER_PAX');if($scope.onlineflights[0].card_number!=''){$.post("../backend/application/index.php?rota=/loadCardsData",{data:$scope.onlineflights},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.cardPassword();});}$.post("../backend/application/index.php?rota=/loadClientName",{data:$scope.selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();if($scope.response!=undefined){if($scope.response.status=="Coberto"&&$scope.response.paymentType=="Coberto"){$scope.selected.early_covered=true;}$scope.selected.subClientEmail=$scope.response.subClientEmail;if($scope.check48hours()&&args==undefined){$scope.checkTimeFlight(args);$scope.previousIndex=0;$scope.tabindex=0;}else if($scope.response.status=="Bloqueado"&&args==undefined&&$scope.selected.commercialStatus==false){logger.logError("Cliente Bloqueado! - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit('openPermission',{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});}else if($scope.response.status=="Pendente"&&args==undefined&&$scope.selected.commercialStatus==false){logger.logError("Cliente Pendente! - Favor consultar o Comercial");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit('openPermission',{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});return;}else if($scope.response.paymentType=="Antecipado"&&args==undefined&&$scope.selected.commercialStatus==false){logger.logError("Cliente Antecipado! - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit('openPermission',{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});return;}else if($scope.response.partner_limit=="true"&&args==undefined&&$scope.selected.commercialStatus==false){logger.logError("Cliente Atingiu 'limite de emissões! - Favor consultar o Financeiro");$scope.previousIndex=0;$scope.tabindex=0;$scope.$emit('openPermission',{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId});return;}else{$scope.wsale.client=$scope.response.client_name;$scope.selected.client_name=$scope.wsale.client;$scope.selected.subClientEmail=$scope.response.subClientEmail;$scope.previousIndex=$scope.tabindex;$scope.$apply();$scope.checkTimeFlight(args);$scope.showNextStep=true;$.post("../backend/application/index.php?rota=/in8Bot/checkOrderBot",{order:$scope.selected},function(result){$scope.robotLog=jQuery.parseJSON(result).dataset;});}}else{logger.logWarning('Cliente não vinculado!');$scope.previousIndex=0;$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});}});return $scope.select($scope.currentPage);});};$scope.$watch('wsale.client',function(){var client=_.find($scope.clients,function(o){return o.name==$scope.wsale.client;});if(client&&client!=undefined&&client!=null){$scope.showNextStep=true;}else{$scope.showNextStep=false;}});$scope.checkPaxNames=function(pax_name){if(pax_name&&pax_name!=''){if($scope.blackListOfNames.indexOf(pax_name.split(' ')[pax_name.split(' ').length-1])>-1){return true;}}return false;};$scope.getTotalValue=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){cont+=$scope.onlineflights[i].cost-$scope.onlineflights[i].discount;if($scope.onlineflights[i].is_newborn!='S'){cont+=$scope.onlineflights[i].tax;}}return cont;}};$scope.getTotalDiscount=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){cont+=$scope.onlineflights[i].discount;}return cont;}};$scope.getTotal=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){cont+=$scope.onlineflights[i].cost;}return cont;}};$scope.getFlightTotal=function(onlineflight){if($scope.selected.status=='EMITIDO'||$scope.selected.status=='VERIFICADO'){return onlineflight.amountPaid;}else{if(onlineflight.is_newborn=="N"){return onlineflight.cost+onlineflight.tax-onlineflight.discount;}else{return onlineflight.cost-onlineflight.discount;}}};$scope.getTotalTax=function(){if($scope.onlineflights!=undefined){var cont=0;for(var i=0;i<$scope.onlineflights.length;i++){if($scope.onlineflights[i].is_newborn!='S'){cont+=$scope.onlineflights[i].tax;}}return cont;}};$scope.getPaxType=function(onlineflight){if($scope.onlineflights!=undefined){if(onlineflight.is_child=="S")return"CHD";if(onlineflight.is_newborn=="S")return"INF";return"ADT";}};$scope.saveStatusOrder=function(){$.post("../backend/application/index.php?rota=/saveStatusOrder",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.loadSalesByFilter();});};$scope.sendEmail=function(onlineflights){$scope.previousIndex=$scope.tabindex;$scope.tabindex=5;$scope.fillEmailContent(onlineflights);};$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.findBaggagePrice=function(airline,baggages){return _.find($rootScope.airlines,function(o){return o.name==airline;}).baggage*baggages;};$scope.isValidOrder=function(){if($scope.selected){if($scope.validFlights()===true){return true;}else{return false;}}};$scope.validFlights=function(){if($scope.onlineflights){for(var j=0;$scope.onlineflights.length>j;j++){if($scope.onlineflights[j].isBreak=="Integrado"){if($scope.onlineflights[j].card_number==" - "&&($scope.onlineflights[j].provider=='Loja TAM Contagem'||$scope.onlineflights[j].provider=='Loja TAM Ponta Grossa'||$scope.onlineflights[j].provider=='Loja TAM M'||$scope.onlineflights[j].provider==='')||$scope.onlineflights[j].flightLocator==undefined||($scope.onlineflights[j].airline=="TAM"||$scope.onlineflights[j].airline=="LATAM")&&$scope.onlineflights[j].ticket_code==undefined)return false;if($scope.onlineflights[j].provider==''&&$scope.onlineflights[j].tax_card==undefined||$scope.onlineflights[j].flightLocator==undefined)return false;}}return true;}};$scope.validOrder=function(){if($scope.wsale.client){$scope.selected.client_name=$scope.wsale.client;if($scope.response){if($scope.response.status=='Bloqueado'||$scope.response.paymentType=='Antecipado'){$scope.openClientWarning($scope.response);}}$scope.previousIndex=$scope.tabindex;$scope.tabindex++;}};$scope.openOrdersNotificationModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/order_notification_status.html",controller:'OrdersNotificationModalCtrl',periods:$scope.periods,size:'lg',resolve:{order:function order(){return $scope.selected;}}});modalInstance.result.then(function(filter){},function(){void 0;});};$scope.openClientWarning=function(args){$scope.ClientWarning=args;var modalInstance;modalInstance=$modal.open({templateUrl:"ClientWarningModalCtrl.html",controller:'ClientWarningInstanceCtrl',resolve:{selected:function selected(){return $scope.ClientWarning;}}});modalInstance.result.then(function(){});};$scope.cancelOrder=function(){$scope.cancel=true;};$scope.cancelOnlineOrder=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/cancelOnlineOrder",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;});};$scope.loadSalesByFilter=function(){$.post("../backend/application/index.php?rota=/loadOnlineWaitingByFilter",{data:$scope.filter},function(result){if($scope.tabindex==0){$scope.onlineorder=jQuery.parseJSON(result).dataset;$scope.search();$scope.$apply();return $scope.select($scope.currentPage);}});};$scope.filter_by_key=function(array,key){var clear=[];for(var filterIndex in array){if(clear.indexOf(array[filterIndex][key])==-1){clear.push(array[filterIndex]);}}return clear;};$scope.setSelected=function(args){$scope.args=args;$scope.flight_selected=undefined;$scope.wsale={};$scope.robotLog=[];$scope.multiDownloads=false;if(!args){$scope.selected=angular.copy(this.onlineorder);$rootScope.setOnlineOrder($scope.selected);}if(args===true){$scope.selected=$rootScope.onlineOrder;}$scope.uploader.formData={hashId:$scope.session.hashId};$scope.loadOnlineFlight(args);};$scope.setSelectedFlight=function(){if($scope.selected.status!="EMITIDO"){$scope.flight_selected=this.onlineflight;}else{$scope.flight_selected=undefined;}};$scope.undo=function(){if($scope.selected){if($scope.selected.status=="EMITIDO"||$scope.selected.status=="VERIFICADO"){$scope.tabindex=0;$scope.previousIndex=0;}else{$scope.tabindex=$scope.previousIndex;$scope.previousIndex--;}}else{$scope.tabindex=0;$scope.previousIndex=0;}$scope.cancel=false;};$scope.findSpecialCards=function(){if($scope.onlineflights){if($scope.onlineflights.length>0){for(var i in $scope.onlineflights){if($scope.onlineflights[i].card_type=='RED'||$scope.onlineflights[i].card_type=='BLACK'||$scope.onlineflights[i].card_type=='DIAMANTE'||$scope.onlineflights[i].card_type=='CLUBE DIAMANTE')return true;}}}return false;};$scope.openSearchModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"ModalCtrl.html",controller:'OnlineOrderModalInstanceCtrl',resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if($scope.main.isMaster||$scope.main.sale||$scope.main.changeMiles||$scope.main.conference){filter._issueDateFrom=$rootScope.formatServerDate(filter.issueDateFrom);filter._issueDateTo=$rootScope.formatServerDate(filter.issueDateTo);}else{var date=new Date();date.setDate(date.getDate()-3);if(filter.issueDateFrom&&filter.issueDateFrom!='Invalid Date'){if(filter.issueDateFrom<date){filter.issueDateFrom=new Date();filter.issueDateFrom.setDate(filter.issueDateFrom.getDate()-2);}}else{filter.issueDateFrom=new Date();filter.issueDateFrom.setDate(filter.issueDateFrom.getDate()-2);}if(filter.issueDateTo&&filter.issueDateTo!='Invalid Date'){filter._issueDateTo=$rootScope.formatServerDate(filter.issueDateTo);}filter._issueDateFrom=$rootScope.formatServerDate(filter.issueDateFrom);}$scope.filter=filter;$scope.loadSalesByFilter();},function(){void 0;});};$scope.confirOrderToEmit=function(){$.post("../backend/application/index.php?rota=/confirOrderToEmit",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$digest();});};$scope.confirmPayment=function(){$.post("../backend/application/index.php?rota=/onlineOrder/confirmPayment",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$digest();});};return init();}]).controller('OnlineOrderModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.saleStatus=['RESERVA','PENDENTE','EMITIDO','EM ESPERA'];$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('OnlineModalPermissionCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.modalOpen=false;$rootScope.$on('openPermission',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){args.main.userEmail='';args.main.userPassCode='';args.main.pinCode='';args.main.type=args.type;var modalInstance;modalInstance=$modal.open({templateUrl:"OnlineModalPermissionCtrl.html",controller:'OnlineModalPermissionInstanceCtrl',resolve:{permissions:function permissions(){return args.main;},hashId:function hashId(){return args.hashId;},selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(permissions){$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('OnlineModalPermissionInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','permissions','hashId','selected',function($scope,$rootScope,$modalInstance,logger,permissions,hashId,selected){$scope.permissions=permissions;$scope.hashId=hashId;$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.email=function(){$rootScope.$emit('fillEmailBLoqued',{email:$rootScope.onlineOrder.client_email});$scope.cancel();};$scope.emailCommecial=function(){$rootScope.$emit('fillEmailBLoqued',{email:'comercial@onemilhas.com.br'});$scope.cancel();};$scope.setStatusOrder=function(order,status){if(!order){order=$rootScope.onlineOrder;}$.post("../backend/application/index.php?rota=/setStatusOrder",{hashId:$scope.hashId,data:order,status:status},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.checkCommercial=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=='true'){$.post("../backend/application/index.php?rota=/setStatusOrderCommercial",{data:$rootScope.onlineOrder},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});$modalInstance.close($scope.permissions);}else{logger.logError("Dados não conferem!");}});};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{hashId:$scope.hashId,data:$scope.permissions},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=='true'){$modalInstance.close($scope.permissions);$rootScope.$emit('checkedPermission',{});}else{logger.logError("Dados não conferem!");}});};}]).controller('CloseOrder',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=$scope.$parent.selected;if($scope.flight_selected.comments.length>0||$scope.$parent.findSpecialCards()){var modalInstance;modalInstance=$modal.open({templateUrl:"CloseOrder.html",controller:'CloseOrderInstanceCtrl',resolve:{flight_selected:function flight_selected(){return $scope.flight_selected;},onlineflights:function onlineflights(){return $scope.$parent.onlineflights;}}});modalInstance.result.then(function(){$scope.$parent.saveOrder();});}else{$scope.$parent.saveOrder();}};}]).controller('CloseOrderInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','flight_selected','onlineflights',function($scope,$rootScope,$modalInstance,logger,flight_selected,onlineflights){$scope.flight_selected=flight_selected;$scope.onlineflights=onlineflights;$scope.findSpecialCardsLATAM=function(){if($scope.onlineflights){if($scope.onlineflights.length>0){for(var i in $scope.onlineflights){if($scope.onlineflights[i].card_type=='RED'||$scope.onlineflights[i].card_type=='BLACK')return true;}}}return false;};$scope.findSpecialCardsGOL=function(){if($scope.onlineflights){if($scope.onlineflights.length>0){for(var i in $scope.onlineflights){if($scope.onlineflights[i].card_type=='DIAMANTE'||$scope.onlineflights[i].card_type=='CLUBE DIAMANTE')return true;}}}return false;};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.ok=function(){$modalInstance.close();};}]).controller('ClientWarningInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','selected',function($scope,$rootScope,$modalInstance,logger,selected){$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.internal').controller('PermissionsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.types=['Sim','Não'];$scope.searchKeywords='';$scope.searchKeywordsTags='';$scope.searchDealer='';$scope.filteredPermissions=[];$scope.filteredDealers=[];$scope.filteredEmails=[];$scope.row='';$scope.selected={};$scope.horarioDozeTrintaESeis=new Date("1970-01-02 00:00:00");$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePermissions=$scope.filteredPermissions.slice(start,end);};$scope.selectDealers=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageDealers=$scope.filteredDealers.slice(start,end);};$scope.selectEmail=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageEmails=$scope.filteredEmails.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onFilterChangeEmails=function(){$scope.selectEmail(1);return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onNumPerPageChangeDealers=function(){$scope.selectDealers(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredPermissions=$filter('filter')($scope.permissions,$scope.searchKeywords);return $scope.onFilterChange();};$scope.searchDealers=function(){$scope.filteredDealers=$filter('filter')($scope.dealers,$scope.searchDealer);};$scope.searchEmails=function(){$scope.filteredEmails=$filter('filter')($scope.Emails,$scope.searchKeywords);return $scope.onFilterChangeEmails();};$scope.setSelected=function(){original=angular.copy(this.permission);$scope.selected=this.permission;$scope.clientsDealer=[];$.post("../backend/application/index.php?rota=/loadClientsDealer",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientsDealer=jQuery.parseJSON(result).dataset;$scope.showClientsControl=true;$scope.$apply();});$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadCustomersLink",{data:$scope.selected},function(result){$scope.clientsD=jQuery.parseJSON(result).dataset;$scope.clientsDealer=$scope.clientsD;});$scope.tabindex=2;};$scope.setSelectedDealers=function(){original=angular.copy(this.dealers);$scope.selected=this.dealers;$scope.clientsDealer=[];$.post("../backend/application/index.php?rota=/loadClientsDealer",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.clientsDealer=jQuery.parseJSON(result).dataset;if($scope.clientsDealer.length<1){$scope.clientsDealer.push({name:''});}$scope.tabindex=3;$scope.$apply();$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;});});};$scope.addClient=function(){if($scope.clientsDealer.length<300){$scope.clientsDealer.push({name:''});}else{logger.logError('Maximo atingido');}};$scope.removeClient=function(){if($scope.clientsDealer.length>0){$scope.clientsDealer.pop();}};$scope.linkCustomers=function(){$.post("../backend/application/index.php?rota=/saveClientPermission",{data:$scope.clientsDealer,client:$scope.selected},function(result){$scope.clientSave=jQuery.parseJSON(result).dataset;});};$scope.saveClientsDealers=function(){$.post("../backend/application/index.php?rota=/saveClientsDealer",{hashId:$scope.session.hashId,data:$scope.selected,clients:$scope.clientsDealer},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.cancelEdit();});};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredPermissions=$filter('orderBy')($scope.permissions,rowName);return $scope.onOrderChange();};$scope.setDates=function(){if($scope.selected.isDozeTrintaESeis){var s=$scope.horarioDozeTrintaESeis.getSeconds();var m=$scope.horarioDozeTrintaESeis.getMinutes();var h=$scope.horarioDozeTrintaESeis.getHours();var hSaida=h+12;var mEntrada=m-10;if(mEntrada<0){mEntrada+=60;h--;}var mSaida=m+10;if(mSaida>59){mSaida-=60;hSaida++;}var entrada='1970-01-01 '+String(h)+':'+String(mEntrada)+':'+String(s);var saida='1970-01-01 '+String(hSaida)+':'+String(mSaida)+':'+String(s);$scope.selected.sundayIn=new Date(entrada);$scope.selected.mondayIn=new Date(entrada);$scope.selected.tuesdayIn=new Date(entrada);$scope.selected.wednesdayIn=new Date(entrada);$scope.selected.thursdayIn=new Date(entrada);$scope.selected.fridayIn=new Date(entrada);$scope.selected.saturdayIn=new Date(entrada);$scope.selected.sundayOut=new Date(saida);$scope.selected.mondayOut=new Date(saida);$scope.selected.tuesdayOut=new Date(saida);$scope.selected.wednesdayOut=new Date(saida);$scope.selected.thursdayOut=new Date(saida);$scope.selected.fridayOut=new Date(saida);$scope.selected.saturdayOut=new Date(saida);}$scope.selected._sundayIn=$rootScope.formatServerDateTime($scope.selected.sundayIn);$scope.selected._mondayIn=$rootScope.formatServerDateTime($scope.selected.mondayIn);$scope.selected._tuesdayIn=$rootScope.formatServerDateTime($scope.selected.tuesdayIn);$scope.selected._wednesdayIn=$rootScope.formatServerDateTime($scope.selected.wednesdayIn);$scope.selected._thursdayIn=$rootScope.formatServerDateTime($scope.selected.thursdayIn);$scope.selected._fridayIn=$rootScope.formatServerDateTime($scope.selected.fridayIn);$scope.selected._saturdayIn=$rootScope.formatServerDateTime($scope.selected.saturdayIn);$scope.selected._sundayOut=$rootScope.formatServerDateTime($scope.selected.sundayOut);$scope.selected._mondayOut=$rootScope.formatServerDateTime($scope.selected.mondayOut);$scope.selected._tuesdayOut=$rootScope.formatServerDateTime($scope.selected.tuesdayOut);$scope.selected._wednesdayOut=$rootScope.formatServerDateTime($scope.selected.wednesdayOut);$scope.selected._thursdayOut=$rootScope.formatServerDateTime($scope.selected.thursdayOut);$scope.selected._fridayOut=$rootScope.formatServerDateTime($scope.selected.fridayOut);$scope.selected._saturdayOut=$rootScope.formatServerDateTime($scope.selected.saturdayOut);if(!$scope.selected._vacationEnd){$scope.selected._vacationEnd=new Date("2010-01-01 00:00:00");$scope.selected._vacationEnd="";}$scope.selected._vacationEnd=$rootScope.formatServerDateTime($scope.selected.vacationEnd);};$scope.savePermission=function(){if($scope.form_permission.$valid&&(!$scope.selected.onVacation||$scope.selected.onVacation&&$scope.selected.vacationEnd)){$scope.setDates();for(var i in $scope.Users){if($scope.Users[i].userName==$scope.selected.name){$scope.selected.userId=$scope.Users[i].id;}}$.post("../backend/application/index.php?rota=/savePermission",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadPermissions();});if($scope.clientsDealer){$scope.linkCustomers();}}else{logger.logError("Favor preencher todos os campos!");}};$scope.cancelEdit=function(){$scope.selected={};$scope.showClientsControl=false;$scope.loadPermissions();};$scope.nextWizard=function(){if($scope.form_newPermission.$valid){var original=angular.copy($scope.selected);$scope.selected=$filter('filter')($scope.permissions,$scope.selected.userName);if($scope.selected.length>0)$scope.selected=$scope.selected[0];else $scope.selected=original;$scope.tabindex=2;}else{logger.logError("Favor vincular um usuário valido!");}};$scope.getValue=function(){for(var i in $scope.permissions){$scope.permissions[i].purchase=$scope.permissions[i].purchase=='true';$scope.permissions[i].wizardPurchase=$scope.permissions[i].wizardPurchase=='true';$scope.permissions[i].sales=$scope.permissions[i].sales=='true';$scope.permissions[i].wizardSale=$scope.permissions[i].wizardSale=='true';$scope.permissions[i].milesBench=$scope.permissions[i].milesBench=='true';$scope.permissions[i].financial=$scope.permissions[i].financial=='true';$scope.permissions[i].creditCard=$scope.permissions[i].creditCard=='true';$scope.permissions[i].users=$scope.permissions[i].users=='true';$scope.permissions[i].changeSale=$scope.permissions[i].changeSale=='true';$scope.permissions[i].changeMiles=$scope.permissions[i].changeMiles=='true';$scope.permissions[i].commercial=$scope.permissions[i].commercial=='true';$scope.permissions[i].permission=$scope.permissions[i].permission=='true';$scope.permissions[i].pagseguro=$scope.permissions[i].pagseguro=='true';$scope.permissions[i].internRefund=$scope.permissions[i].internRefund=='true';$scope.permissions[i].internCommercial=$scope.permissions[i].internCommercial=='true';$scope.permissions[i].humanResources=$scope.permissions[i].humanResources=='true';$scope.permissions[i].salePlansEdit=$scope.permissions[i].salePlansEdit=='true';$scope.permissions[i].conference=$scope.permissions[i].conference=='true';$scope.permissions[i].onlineOnlineOrder=$scope.permissions[i].onlineOnlineOrder=='true';$scope.permissions[i].onlineBalanceOrder=$scope.permissions[i].onlineBalanceOrder=='true';$scope.permissions[i].onlineCardsInUse=$scope.permissions[i].onlineCardsInUse=='true';$scope.permissions[i].purchaseProvider=$scope.permissions[i].purchaseProvider=='true';$scope.permissions[i].purchasePaymentPruchase=$scope.permissions[i].purchasePaymentPruchase=='true';$scope.permissions[i].purchaseEndPruchase=$scope.permissions[i].purchaseEndPruchase=='true';$scope.permissions[i].purchasePruchases=$scope.permissions[i].purchasePruchases=='true';$scope.permissions[i].purchaseCardsPendency=$scope.permissions[i].purchaseCardsPendency=='true';$scope.permissions[i].saleClients=$scope.permissions[i].saleClients=='true';$scope.permissions[i].saleBalanceClients=$scope.permissions[i].saleBalanceClients=='true';$scope.permissions[i].saleFutureBoardings=$scope.permissions[i].saleFutureBoardings=='true';$scope.permissions[i].saleRefundCancel=$scope.permissions[i].saleRefundCancel=='true';$scope.permissions[i].saleRevertRefund=$scope.permissions[i].saleRevertRefund=='true';$scope.permissions[i].wizardSaleEvent=$scope.permissions[i].wizardSaleEvent=='true';$scope.permissions[i].onVacation=$scope.permissions[i].onVacation=='true';$scope.permissions[i].isDozeTrintaESeis=$scope.permissions[i].isDozeTrintaESeis=='true';$scope.permissions[i].sundayIn=new Date($scope.permissions[i].sundayIn);$scope.permissions[i].mondayIn=new Date($scope.permissions[i].mondayIn);$scope.permissions[i].tuesdayIn=new Date($scope.permissions[i].tuesdayIn);$scope.permissions[i].wednesdayIn=new Date($scope.permissions[i].wednesdayIn);$scope.permissions[i].thursdayIn=new Date($scope.permissions[i].thursdayIn);$scope.permissions[i].fridayIn=new Date($scope.permissions[i].fridayIn);$scope.permissions[i].saturdayIn=new Date($scope.permissions[i].saturdayIn);$scope.permissions[i].sundayOut=new Date($scope.permissions[i].sundayOut);$scope.permissions[i].mondayOut=new Date($scope.permissions[i].mondayOut);$scope.permissions[i].tuesdayOut=new Date($scope.permissions[i].tuesdayOut);$scope.permissions[i].wednesdayOut=new Date($scope.permissions[i].wednesdayOut);$scope.permissions[i].thursdayOut=new Date($scope.permissions[i].thursdayOut);$scope.permissions[i].fridayOut=new Date($scope.permissions[i].fridayOut);$scope.permissions[i].saturdayOut=new Date($scope.permissions[i].saturdayOut);if($scope.permissions[i].vacationEnd)$scope.permissions[i].vacationEnd=new Date($scope.permissions[i].vacationEnd.date);else $scope.permissions[i].vacationEnd="";if($scope.selected.isDozeTrintaESeis){var s=$scope.permissions[i].sundayIn.getSeconds();var m=$scope.permissions[i].sundayIn.getMinutes();var h=$scope.permissions[i].sundayIn.getHours();m+=10;if(m>59){mSaida-=60;h++;}var str='1970-01-01 '+String(h)+':'+String(m)+':'+String(s);$scope.horarioDozeTrintaESeis=new Date(str);}}$scope.search();$scope.tabindex=0;$scope.$apply();return $scope.select($scope.currentPage);};$scope.loadPermissions=function(){$.post("../backend/application/index.php?rota=/loadPermissions",$scope.session,function(result){$scope.permissions=jQuery.parseJSON(result).dataset;$scope.getValue();});$.post("../backend/application/index.php?rota=/loadDealers",$scope.session,function(result){$scope.dealers=jQuery.parseJSON(result).dataset;$scope.searchDealers();});};window.$scope=$scope;$scope.loadConfigEmails=function(){$.post("../backend/application/index.php?rota=/loadConfigEmails",$scope.session,function(result){$scope.Emails=jQuery.parseJSON(result).dataset;$scope.searchEmails();});};$scope.newPermission=function(){$scope.selected={};$.post("../backend/application/index.php?rota=/loadUsers",$scope.session,function(result){$scope.Users=jQuery.parseJSON(result).dataset;$scope.tabindex=1;$scope.$apply();});};$scope.setSelectedEmail=function(){$scope.selectedEmail=this.emails;$scope.tabindex=10;};$scope.controlClients=function(){$scope.showClientsControl=true;};$scope.cancelEditEmail=function(){$scope.tabindex=0;};$scope.saveConfigEmail=function(){$.post("../backend/application/index.php?rota=/saveConfigEmails",{hashId:$scope.session.hashId,data:$scope.selectedEmail},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadConfigEmails();$scope.tabindex=0;});};$scope.newConfigEmail=function(){$scope.selectedEmail={};$scope.tabindex=10;};$scope.loadTags=function(){$.post("../backend/application/index.php?rota=/loadTags",{},function(result){$scope.tags=jQuery.parseJSON(result).dataset;$scope.tabindex=4;$scope.searchTags();});};$scope.searchTags=function(){$scope.filteredTags=$filter('filter')($scope.tags,$scope.searchKeywordsTags);};$scope.setSelectedTag=function(){$scope.selectedTag=this.tag;$scope.tabindex=5;};$scope.saveTag=function(){$.post("../backend/application/index.php?rota=/saveTag",{data:$scope.selectedTag},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadTags();$scope.tabindex=0;});};$scope.newTag=function(){$scope.selectedTag={};$scope.tabindex=5;};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePermissions=[];init=function init(){$scope.tabindex=0;$scope.showClientsControl=false;$scope.checkValidRoute();$scope.loadPermissions();$scope.loadConfigEmails();$scope.loadTags();};return init();}]);})();;(function(){'use strict';angular.module('app.purchase').controller('ProjectsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.loadData=function(){cfpLoadingBar.start();cfpLoadingBar.complete();};init=function init(){$scope.checkValidRoute();$scope.loadData();};return init();}]);})();;(function(){'use strict';angular.module('app.marketing').controller('PlansPromoCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredPromos=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPagePromos=$scope.filteredPromos.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredPromos=$filter('filter')($scope.promos,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.promo;$scope.selected._startDate=new Date($scope.selected.startDate);$scope.selected._endDate=new Date($scope.selected.endDate);$.post("../backend/application/index.php?rota=/marketing/loadPlansControl",{data:$scope.selected},function(result){$scope.controlAirline=jQuery.parseJSON(result).dataset.airlines;$scope.$digest();});$scope.tabindex=1;};$scope.newPromo=function(){$scope.selected={};$scope.selected.airlines=['LATAM','GOL','AZUL','AVIANCA'];$scope.selected.airlinesTypes=['nacional','internacional','executivo'];$scope.selected.clients='';$scope.controlAirline={LATAM:{executivo:{configs:[]},internacional:{configs:[]},nacional:{configs:[]}},GOL:{executivo:{configs:[]},internacional:{configs:[]},nacional:{configs:[]}},AZUL:{executivo:{configs:[]},internacional:{configs:[]},nacional:{configs:[]}},AVIANCA:{executivo:{configs:[]},internacional:{configs:[]},nacional:{configs:[]}}};$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredPromos=$filter('orderBy')($scope.promos,rowName);return $scope.onOrderChange();};$scope.savePromo=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_confirmation.html",controller:'ModalConfirmationCtrl',resolve:{header:function header(){return'Salvar Promoção';}}});modalInstance.result.then(function(f){cfpLoadingBar.start();$scope.selected.startDate=$rootScope.formatServerDateTime($scope.selected._startDate);$scope.selected.endDate=$rootScope.formatServerDateTime($scope.selected._endDate);$.post("../backend/application/index.php?rota=/marketing/savePromoPlans",{data:$scope.selected,controlAirline:$scope.controlAirline},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadModalData();$scope.$apply();$scope.tabindex=0;cfpLoadingBar.complete();});});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.selectMiles=function(page){var end,start;start=(page-1)*$scope.numPerPageMiles;end=start+$scope.numPerPageMiles;return $scope.currentMiles=$scope.filteredflight_miles.slice(start,end);};$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.cancelEdit=function(){$scope.loadModalData();$scope.tabindex=0;};$scope.loadModalData=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/marketing/loadPromoPlans",{},function(result){$scope.promos=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.loadClients=function(){$.post("../backend/application/index.php?rota=/loadClientsNames",{searchKeywords:$scope.searchKeywords},function(result){$scope.clients=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePromos=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadModalData();$.post("../backend/application/index.php?rota=/loadSalePlans",$scope.session,function(result){$scope.salePlans=jQuery.parseJSON(result).dataset;$scope.salePlans.push({name:'Valor Fixo'});});$scope.loadClients();};return init();}]);})();;(function(){'use strict';angular.module('app.table').controller('PurchaseCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;$scope.searchKeywords='';$scope.filteredPurchases=[];$scope.row='';$scope.select=function(page){$scope.loadPurchases();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.currentPage=1;$scope.select(1);};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.print=function(){$.post("../backend/application/index.php?rota=/loadPurchasesToOperations",{order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,searchKeywords:$scope.searchKeywords},function(result){$scope.purchasesReport=jQuery.parseJSON(result).dataset.purchases;var data=[['PG','Cadastro','Data Comp.','Cliente','Nº  Cartão','Senha','CARTÃO','CPF','Qtd de Milhas','Milhas Utilizadas','REAL','Valor p/ 1.000 pts','Valor Total','Situação da Análise','OBS.','Telefone Contato','E-mail Contato','EXPIRAR','Companhia']];for(var i in $scope.purchasesReport){data.push(['',$scope.purchasesReport[i].provider_status,$filter('date')(new Date($scope.purchasesReport[i].purchase_date),'dd/MM/yyyy hh:mm:ss'),$scope.purchasesReport[i].providerName,$scope.purchasesReport[i].card_number,$scope.decript($scope.purchasesReport[i].recovery_password),'',$scope.purchasesReport[i].registration_code,$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles,0),$rootScope.formatNumber($scope.purchasesReport[i].leftover,0),$rootScope.formatNumber($scope.purchasesReport[i].purchase_miles,0),$scope.purchasesReport[i].cost_per_thousand,$scope.purchasesReport[i].total_cost,'','',$scope.purchasesReport[i].phone_number+' / '+$scope.purchasesReport[i].phone_number2,$scope.purchasesReport[i].email,$filter('date')(new Date($scope.purchasesReport[i].miles_due_date),'dd/MM/yyyy hh:mm:ss'),$scope.purchasesReport[i].airline]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","compras.csv");document.body.appendChild(link);link.click();});};$scope.findDate=function(date){return new Date(date);};$scope.setSelected=function(){var original=this.purchase;$scope.selected=original;$scope.cardPassword();$scope.isTable=false;$scope.airlineShowFields=this.purchase.airline=='TAM'||this.purchase.airline=='LATAM';$scope.purchaseDate=new Date($scope.selected.purchaseDate+'T12:00:00Z');$scope.milesDueDateDate=new Date($scope.selected.milesDueDate+'T12:00:00Z');$scope.selected.isPriority=$scope.selected.isPriority=='true';$('#purchasemiles').number(true,0,',','.');$('#milesLoesses').number(true,0,',','.');$("#purchasecostperthousand").maskMoney({thousands:'.',decimal:',',precision:2});$('#purchasetotalcost').number(true,2,',','.');$.post("../backend/application/index.php?rota=/loadHistoric",{hashId:$scope.session.hashId,data:$scope.selected,type:'PURCHASE'},function(result){$scope.PurchaseHistory=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadCardsData",{hashId:$scope.session.hashId,sale:$scope.selected},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.$apply();});$scope.MilesDueDate=[];$.post("../backend/application/index.php?rota=/loadMilesDueDate",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.MilesDueDate=jQuery.parseJSON(result).dataset;for(var i in $scope.MilesDueDate){$scope.MilesDueDate[i]._milesDueDate=new Date($scope.MilesDueDate[i].milesDueDate);}$scope.$digest();});$scope.selected._leftover=$scope.selected.leftover;$scope.selected._purchaseMiles=$scope.selected.purchaseMiles;if($scope.selected.bloqued=="Y")$scope.selected.is_bloqued=true;else $scope.selected.is_bloqued=false;return true;};$scope.saveStatus=function(){if($scope.selected.airline=='LATAM'){if($scope.selected.onlyInter==null||$scope.selected.onlyInter=='null'){return logger.logError('Tipo de emissão obrigatorio!');}}cfpLoadingBar.start();if($scope.selected.is_bloqued!==true){$scope.selected.bloqued="N";}else{$scope.selected.bloqued="Y";}$scope.selected._milesDueDate=$rootScope.formatServerDate($scope.milesDueDateDate);$scope.selected.recoveryPassword=$scope.ecript($scope.selected.recoveryPassword);$scope.selected.accessPassword=$scope.ecript($scope.selected.accessPassword);$.post("../backend/application/index.php?rota=/saveCardStatus",{data:$scope.selected},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$scope.toggleFormTable();$scope.loadPurchases();});};$scope.cardPassword=function(){$scope.selected.recoveryPassword=$scope.decript($scope.selected.recoveryPassword);$scope.selected.accessPassword=$scope.decript($scope.selected.accessPassword);};$scope.intencionToSave=function(){if($scope.selected._leftover!=$scope.selected.leftover||$scope.selected._purchaseMiles!=$scope.selected.purchaseMiles||$scope.selected.removeFromMilesbench==true){$scope.openPurchaseLogModal();}else{$scope.saveStatus();}};$scope.decript=function(code){var data;var finaly='';if(code!=null){data=code.split('320AB');for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}}return finaly;};$scope.ecript=function(code){if(code!=undefined){var data=code.split('');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;}};$scope.setCostPerThousand=function(){$scope.selected.costPerThousand=($scope.selected.totalCost/(($scope.selected.purchaseMiles-$scope.selected.losses)/1000)).toFixed(2);;$scope.apply();};$scope.setTotalCost=function(){if($scope.selected._purchaseMiles!=$scope.selected.purchaseMiles){$scope.selected.leftover=$scope.selected._leftover-($scope.selected._purchaseMiles-parseInt($scope.selected.purchaseMiles));if($scope.selected.leftover<0){$scope.selected.leftover=0;}}$scope.selected.totalCost=parseInt($scope.selected.purchaseMiles)/1000*$scope.selected.costPerThousand;};$scope.toggleFormTable=function(){$scope.selected.recoveryPassword=$scope.ecript($scope.selected.recoveryPassword);$scope.selected.accessPassword=$scope.ecript($scope.selected.accessPassword);$scope.isTable=!$scope.isTable;return $scope.isTable;};$scope.search=function(){$scope.loadPurchases();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadPurchases();};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadPurchases();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.numPerPageOpt=[10,30,50,100,1000];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPagePurchases=[];$scope.loadPurchases=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadPurchase",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.purchases=jQuery.parseJSON(result).dataset.purchases;$scope.totalData=jQuery.parseJSON(result).dataset.total;cfpLoadingBar.complete();$scope.$digest();});};init=function init(){$scope.checkValidRoute();$scope.isTable=true;$rootScope.modalOpen=false;$scope.loadPurchases();$.post("../backend/application/index.php?rota=/loadInternalCards",$scope.session,function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;});$scope.totalData=0;};$scope.openSearchModal=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"Purchase.html",controller:'PurchaseModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._purchaseDateFrom=$rootScope.formatServerDate(filter.purchaseDateFrom);filter._purchaseDateTo=$rootScope.formatServerDate(filter.purchaseDateTo);filter._dueDateFrom=$rootScope.formatServerDate(filter.dueDateFrom);filter._dueDateTo=$rootScope.formatServerDate(filter.dueDateTo);}$scope.filter=filter;$scope.loadPurchases();},function(){$log.info("Modal dismissed at: "+new Date());});};$scope.removePurchase=function(purchase){$.post("../backend/application/index.php?rota=/removePurchase",{data:purchase},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$scope.loadPurchases();});};$scope.openPurchaseLogModal=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"PurchaseLogModalCtrl.html",controller:'PurchaseLogInstanceCtrl',resolve:{}});modalInstance.result.then(function(resolve){$scope.selected.resolveDescription=resolve.resolveDescription;$scope.saveStatus();},function(){});};return init();}]).controller('PurchaseModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.statusPrucases=['Confirmadas','Canceladas','Pendentes','Todas'];$scope.filter=filter;$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('PurchaseLogInstanceCtrl',['$scope','$rootScope','$modalInstance','logger',function($scope,$rootScope,$modalInstance,logger){$scope.selected={resolveDescription:''};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.save=function(){if($scope.selected.resolveDescription.length<1)return logger.logError('Motivos devem ser informados');$modalInstance.close($scope.selected);};}]);})();;(function(){'use strict';angular.module('app.table').controller('RefoundCtrl',['$scope','$rootScope','$route','$filter','cfpLoadingBar','logger','$modal','$element',function($scope,$rootScope,$route,$filter,cfpLoadingBar,logger,$modal,$element){var init;$scope.saleStatus=['Pendente','Emitido','Reembolso Solicitado','Reembolso Pagante Solicitado','Reembolso CIA','Reembolso Confirmado','Cancelamento Solicitado','Cancelamento Efetivado','Cancelamento Nao Solicitado','Remarcação Solicitado','Remarcação Confirmado','Cancelamento Pendente','Reembolso Pendente','Reembolso No-show Solicitado','Reembolso No-show Confirmado','Reembolso Nao Solicitado','Reembolso Perdido'];$scope.searchKeywords='';$scope.filteredSales=[];$scope.row='';$scope.saleMethods=['JACK FOR','Loja TAM Ponta Grossa','Loja TAM Contagem','Rextur Advance','Loja TAM M','CONFIANÇA','TAP','Outros'];$scope.safePossibilities=[{method:'Faturado'},{method:'Cartao'}];$scope.removeFromRefundReport=['BASE CFTUR','cftur@gmail.com','CFTUR@GMAIL.COM','turismostar@hotmail.com','TURISMOSTAR@HOTMAIL.COM'];$scope.select=function(page){$scope.currentPage=page;$scope.loadOrders();};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.loadOrders();};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.findDate=function(date){if(date!=''){return new Date(date);}else{return'';}};$scope.setSelected=function(){$scope.selected={};$scope.repricing={};if(this.sale.status!="Cancelado"){$scope.selected=this.sale;$('#salemilesused').number(true,0,',','.');$('#saletax').number(true,2,',','.');$('#saledutax').number(true,2,',','.');$('#saletotalcost').number(true,2,',','.');$('#saleamountpaid').number(true,2,',','.');$('#saleextrafee').number(true,2,',','.');$('#salekickback').number(true,2,',','.');$('#milesMoney').number(true,2,',','.');$('#totalCost').number(true,2,',','.');$('#newMiles').number(true,0,',','.');$("#newValue").maskMoney({thousands:'.',decimal:',',precision:2});$("#repricingCost").maskMoney({thousands:'.',decimal:',',precision:2});$scope.ValueAirlines={};$.post("../backend/application/index.php?rota=/loadPlanControlDetails",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.ValueAirlines=jQuery.parseJSON(result).dataset;$scope.repricing.cost=$scope.ValueAirlines.repricing;$scope.$digest();});$scope.tabindex=1;$.post("../backend/application/index.php?rota=/loadBilletFinancial",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.billetStatus=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadLog",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.saleLog=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.airlineShowFields=$scope.selected.airline=='TAM'||$scope.selected.airline=='LATAM';$scope.boardingDate=new Date($scope.selected.boardingDate);$scope.landingDate=new Date($scope.selected.landingDate);$scope.paxBirthdate=new Date($scope.selected.paxBirthdate+'T12:00:00Z');if($scope.selected.status=="Reembolso Solicitado"||$scope.selected.status=="Reembolso Pagante Solicitado"||$scope.selected.status=="Reembolso No-show Solicitado"||$scope.selected.status=="Reembolso CIA"){$.post("../backend/application/index.php?rota=/loadBillsPayRefund",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.billsPayValue=jQuery.parseJSON(result).dataset;$scope.$digest();});}$.post("../backend/application/index.php?rota=/loadLastPurchaseData",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.lastPurchase=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.airports.filter(function(a){return a.code==$scope.selected.from;})[0].label;$scope.repricing.airportNamefrom=$scope.airports.filter(function(a){return a.code==$scope.selected.from;})[0].label;$scope.repricing.airportNameto=$scope.airports.filter(function(a){return a.code==$scope.selected.to;})[0].label;$scope.repricing.boardingDate=$scope.boardingDate;$scope.repricing.landingDate=$scope.landingDate;$scope.repricing.flight=$scope.selected.flight;$scope.repricing.flightLocator=$scope.selected.flightLocator;$scope.repricing.flightHour=$scope.selected.flightHour;$scope.repricing.milesused=0;return true;}else{logger.logError("Esta venda foi cancelada!");}};$scope.milesusedBlur=function(){if($scope.repricing.milesused==undefined||$scope.repricing.milesused==''){$scope.repricing.milesused=0;}};$scope.registerLog=function(){$.post("../backend/application/index.php?rota=/saveSaleOccurrence",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadLog",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.saleLog=jQuery.parseJSON(result).dataset;$scope.$digest();});});};$scope.repricingMulct=function(){var operation={};var operations=[];for(var x in $scope.airlines){if($scope.airlines[x].name==$scope.selected.airline){operations=$scope.airlines[x].operations;for(var x in operations){if(operations[x].type=="Remarcação"){operation=operations[x];}}}}var actualDate=new Date();var selectedDate=new Date($scope.selected.boardingDate);if($scope.selected.airline=="AVIANCA"){selectedDate.setHours(selectedDate.getHours()+5);}else{selectedDate.setHours(selectedDate.getHours()+3);}if(actualDate<selectedDate){if($scope.selected.international){if($scope.selected.airportLocation=="America Norte"&&operation.northAmericaBeforeBoarding!=0){return operation.northAmericaBeforeBoarding;}else if($scope.selected.airportLocation=="America Sul"&&operation.southAmericaBeforeBoarding!=0){return operation.southAmericaBeforeBoarding;}else{return operation.internationalBeforeBoarding;}}else{return operation.nationalBeforeBoarding;}}else{if($scope.selected.international){if($scope.selected.airportLocation=="America Norte"&&operation.northAmericaAfterBoarding!=0){return operation.northAmericaAfterBoarding;}else if($scope.selected.airportLocation=="America Sul"&&operation.southAmericaAfterBoarding!=0){return operation.southAmericaAfterBoarding;}else{return operation.internationalAfterBoarding;}}else{return operation.nationalAfterBoarding;}}};$scope.toggleFormTable=function(){$scope.tabindex=0;};$scope.search=function(){$scope.loadOrders();};$scope.order=function(rowName){$scope.searchOrder=rowName;$scope.searchOrderDown=undefined;$scope.loadOrders();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.saleTag=function(status){switch(status){case'Pendente':return"label label-info";case'Emitido':return"label label-success";case'Remarcação Confirmado':return"label label-success";case'Reembolso Solicitado':return"label label-warning";case'Reembolso Pagante Solicitado':return"label label-warning";case'Reembolso CIA':return"label label-warning";case'Remarcação Solicitado':return"label label-warning";case'Reembolso Confirmado':return"label label-default";case'Cancelamento Solicitado':return"label label-warning";case'Cancelamento Efetivado':return"label label-danger";case'Reembolso No-show Solicitado':return"label label-default";case'Reembolso No-show Confirmado':return"label label-default";case'Reembolso Nao Solicitado':return"label label-default";case'Cancelamento Nao Solicitado':return"label label-default";case'Reembolso Perdido':return"label label-default";}};$scope.noRefundModal=function(is_perdido){$scope.is_perdido=is_perdido;var modalInstance=$modal.open({size:"lg",templateUrl:"reembolsoConfirm.html",controller:"reembolsoModalInstanceCtrl",scope:$scope});modalInstance.result.then(function(resolve){$scope.noRefund();},function(){});};$scope.noRefund=function(){$.post("../backend/application/index.php?rota=/noRefund",{hashId:$scope.session.hashId,data:$scope.selected,is_perdido:$scope.is_perdido},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadOrders();});};$scope.confirmRepricing=function(){$.post("../backend/application/index.php?rota=/confirmRepricing",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadOrders();});};$scope.numPerPageOpt=[10,25,50,150];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPageSales=[];$rootScope.hashId=$scope.session.hashId;$scope.closeRefund=function(){if(!$scope.selected.returnDate){logger.logError('O campo de data de retorno deve ser informado.');}else{cfpLoadingBar.start();$scope.selected._returnDate=$rootScope.formatServerDate($scope.selected.returnDate);$.post("../backend/application/index.php?rota=/closeRefund",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadOrders();});cfpLoadingBar.complete();$scope.toggleFormTable();}};$scope.addRow=function(){if(this.sale.status!=='Pendente'){this.sale.checked=false;}};$scope.ClosecancelSale=function(){cfpLoadingBar.start();void 0;if(!$scope.selected.returnPointsDate){cfpLoadingBar.complete();return logger.logError('Necessario marcar a data do retorno dos pontos');}if($scope.selected.returnPointsDate!==""&&$scope.selected.returnPointsDate!='Invalid Date'){$scope.selected._returnPointsDate=$rootScope.formatServerDate($scope.selected.returnPointsDate);}else{cfpLoadingBar.complete();return logger.logError('Necessario marcar a data do retorno dos pontos');}$.post("../backend/application/index.php?rota=/ClosecancelSale",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadOrders();});};$scope.notConfirmedCancelSale=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/notConfirmedCancelSale",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadOrders();});};$scope.cancelSale=function(){cfpLoadingBar.start();if($scope.selected.cancelDate!==""&&$scope.selected.cancelDate!='Invalid Date'){$scope.selected._cancelDate=$rootScope.formatServerDate($scope.selected.cancelDate);}$.post("../backend/application/index.php?rota=/cancelSale",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadOrders();});};$scope.back=function(){$scope.tabindex--;};$scope.getMulta=function(selected){return $scope.ValueAirlines.refund;};$scope.mailOrder=function(){$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wsalemail,emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=='S'){$scope.loadOrders();logger.logSuccess(jQuery.parseJSON(result).message.text);}else{$scope.loadOrders();logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.getvalue=function(selected){var mulct=$scope.getMulta(selected);var data="";if(selected.amountPaid-mulct>0)data="Crédito: R$ "+$rootScope.formatNumber(selected.amountPaid-mulct);else data="Débito: R$ "+$rootScope.formatNumber(selected.amountPaid-mulct);return data;};$scope.fillEmailCancel=function(){$scope.wsalemail.emailpartner='arthur.srmviagens@gmail.com';$scope.wsalemail.mailcc='arthur.srmviagens@gmail.com';$scope.wsalemail.subject='[Orçamento] - Orçamento de Cancelamento';$scope.wsalemail.emailContent="Ola!<br><br>"+"Caso de cancelamento.<br><br>"+"Trecho: "+$scope.selected.airportNamefrom+" - "+$scope.selected.airportNameto+"<br>"+"Data embarque: "+$filter('date')(new Date($scope.selected.boardingDate),'dd/MM/yyyy hh:mm:ss')+'-'+$filter('date')(new Date($scope.selected.landingDate),'dd/MM/yyyy hh:mm:ss')+"<br>"+"Conforme solicitado o custo para cancelamento de bilhetes é:<br><br>"+"R$ 60,00 por trecho/pax<br><br>"+"Favor responder com OK para dar seguimento no processo de cancelamento.<br><br>"+"Att,";$scope.tabindex=2;};$scope.fillEmailRepricing=function(){$scope.wsalemail.emailpartner='arthur.srmviagens@gmail.com';$scope.wsalemail.mailcc='arthur.srmviagens@gmail.com';$scope.wsalemail.subject='[Orçamento] - Orçamento de Remarcação';$scope.wsalemail.emailContent="Ola!<br><br>"+"Caso de Remarcação.<br><br>"+"Trecho: "+$scope.repricing.airportNamefrom+'-'+$scope.repricing.airportNameto+"<br>"+"Data embarque: "+$filter('date')(new Date($scope.repricing.boardingDate),'dd/MM/yyyy hh:mm:ss')+'-'+$filter('date')(new Date($scope.repricing.landingDate),'dd/MM/yyyy hh:mm:ss')+"<br>"+"Diferença Trecho: R$"+$rootScope.formatNumber($scope.repricing.milesused*($scope.repricing.newValue/1000))+" - ("+$rootScope.formatNumber($scope.repricing.milesused,0)+")<br>"+"Multa: R$ "+$rootScope.formatNumber($scope.repricing.cost)+"<br><br>"+"Valor total para remarcação: R$ "+$rootScope.formatNumber($scope.repricing.cost+$scope.repricing.milesused*($scope.repricing.newValue/1000))+"<br><br>"+"Favor responder com OK para dar seguimento no processo de remarcação.<br><br>Att,";$scope.tabindex=2;};$scope.fillEmailRefund=function(){$scope.wsalemail.emailpartner='arthur.srmviagens@gmail.com';$scope.wsalemail.mailcc='arthur.srmviagens@gmail.com';$scope.wsalemail.subject='[Orçamento] - Orçamento de Reembolso';$scope.wsalemail.emailContent="Ola!<br><br>";var issueDate=new Date($scope.selected.issueDate);if($scope.selected.issuing=='app.voelegal'||$scope.selected.issuing=='srmapp.voelegal'){issueDate.setDate(issueDate.getDate()+365);}else{issueDate.setDate(issueDate.getDate()+60);}if(issueDate<new Date()){logger.logError("REEMBOLSO SUPERIOR A 60 DIAS");$scope.wsalemail.emailContent+="<br><br><font color='red'>REEMBOLSO SUPERIOR A 60 DIAS</font><br><br>";}if($scope.selected.saleType=='Cartao'){logger.logError("REEMBOLSO VENDA CARTÃO");$scope.wsalemail.emailContent+="<br><br><font color='red'>REEMBOLSO DE VENDA POR CARTÃO</font><br><br>";}$scope.wsalemail.emailContent+="Caso de reembolso.<br><br>";$scope.wsalemail.emailContent=$scope.wsalemail.emailContent+"O valor pago no bilhete terá o desconto referente a multa e o restante ficará de crédito.<br><br>"+"PAX: "+$scope.selected.paxName+"  ( "+$scope.selected.flightLocator;if($scope.selected.airline=="TAM"||$scope.selected.airline=="LATAM")$scope.wsalemail.emailContent+=" - "+$scope.selected.ticket_code;$scope.wsalemail.emailContent+=" )  "+$scope.selected.airline+"<br>"+"VOO : "+$filter('date')(new Date($scope.selected.boardingDate),'dd/MM/yyyy')+"<br>"+"Pago: R$ "+$rootScope.formatNumber($scope.selected.amountPaid)+" - "+$rootScope.formatNumber($scope.selected.milesOriginal,0)+" PTS<br>"+"Multa: - R$ "+$rootScope.formatNumber($scope.getMulta($scope.selected))+"<br>"+$scope.getvalue($scope.selected)+"<br><br>"+"Para agência o crédito será descontado do próximo borderô.<br><br>"+"Favor responder com OK para dar seguimento no processo de reembolso.<br><br>"+"Att,";$scope.tabindex=2;};$scope.fillEmailContent=function(){if($scope.selected.airline=='GOL'){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_confirmation_gol.html",controller:'ModalConfirmationCtrl',resolve:{header:function header(){return'Orçamento de Reembolso';}}});modalInstance.result.then(function(filterSales){$scope.fillEmailRefund();});}if($scope.selected.sale_method=='CONFIANÇA'||$scope.selected.sale_method=='Rextur Advance'){var modalInstanceconfianca;modalInstanceconfianca=$modal.open({templateUrl:"app/modals/modal_confirmation.html",controller:'ModalConfirmationCtrl',resolve:{header:function header(){return'Bilhete pagante. Confira tarifas!';}}});modalInstanceconfianca.result.then(function(filterSales){$scope.fillEmailRefund();});}else{$scope.fillEmailRefund();}};$scope.findRefundByFilter=function(){if($scope.showRefunds){$scope.showRefunds=false;$scope.filter.status='';$scope.filter.status2='';}else{$scope.showRefunds=true;$.post("../backend/application/index.php?rota=/loadRefundByFilter",{hashId:$scope.session.hashId},function(result){$scope.refundsChart=jQuery.parseJSON(result).dataset;});var date=new Date();$scope.filter._refundDateFrom=$rootScope.formatServerDate(new Date(date.getFullYear(),date.getMonth(),1));$scope.filter._returnDateFrom=$rootScope.formatServerDate(new Date(date.getFullYear(),date.getMonth(),1));$scope.loadOrders();}};$scope.ConfirmSolicitation=function(){$scope.selected._airlineSolicitation=$rootScope.formatServerDate($scope.selected.airlineSolicitation);$.post("../backend/application/index.php?rota=/confirmRefundSolicitation",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.loadOrders();});};$scope.printNoShowListOrderBy=function(){$.post("../backend/application/index.php?rota=/loadSalesToOperations",{searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter,refund_report:true},function(result){$scope.salesToReport=jQuery.parseJSON(result).dataset.sales;var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(18);doc.text(150,30,'Conferencia');var columns=[{title:"Fornecedor",dataKey:"partner"},{title:"Pax",dataKey:"pax"},{title:"Embarque",dataKey:"boardingDate"},{title:"ETicket",dataKey:"ticket_code"},{title:"Trecho",dataKey:"fromTo"},{title:"Localizador",dataKey:"flightLocator"},{title:"Pontos",dataKey:"miles"}];var rows=[];$scope.filteredSales=$scope.salesToReport;for(var i in $scope.filteredSales){var partnerName=$scope.filteredSales[i].providerName;if($scope.filteredSales[i].saleByThird=='Y'){partnerName=$scope.filteredSales[i].sale_method;}if($scope.removeFromRefundReport.indexOf($scope.filteredSales[i].cards_provider_email)>-1){void 0;}else{rows.push({partner:partnerName,pax:$scope.filteredSales[i].paxName,boardingDate:$filter('date')(new Date($scope.filteredSales[i].boardingDate),'dd/MM/yyyy hh:mm:ss'),ticket_code:$scope.filteredSales[i].ticket_code,fromTo:$scope.filteredSales[i].from+'-'+$scope.filteredSales[i].to,flightLocator:$scope.filteredSales[i].flightLocator,miles:$rootScope.formatNumber($scope.filteredSales[i].milesused,0)});}}doc.autoTable(columns,rows,{styles:{overflow:'linebreak',fontSize:6,margin:{horizontal:4},columnWidth:'auto'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='miles'){cell.styles.halign='right';}}});doc.save('Relatorio.pdf');});};$scope.printNoShowList=function(){$.post("../backend/application/index.php?rota=/loadSalesToOperations",{searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.filteredSales=jQuery.parseJSON(result).dataset.sales;var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(18);doc.text(150,30,'Conferencia');var columns=[{title:"Fornecedor",dataKey:"partner"},{title:"Pax",dataKey:"pax"},{title:"Embarque",dataKey:"boardingDate"},{title:"ETicket",dataKey:"ticket_code"},{title:"Trecho",dataKey:"fromTo"},{title:"Localizador",dataKey:"flightLocator"},{title:"Pontos",dataKey:"miles"}];var rows=[];for(var i in $scope.filteredSales){var partnerName=$scope.filteredSales[i].providerName;if($scope.filteredSales[i].saleByThird=='Y'){partnerName=$scope.filteredSales[i].sale_method;}if($scope.removeFromRefundReport.indexOf($scope.filteredSales[i].cards_provider_email)>-1){void 0;}else{rows.push({partner:partnerName,pax:$scope.filteredSales[i].paxName,boardingDate:$filter('date')(new Date($scope.filteredSales[i].boardingDate),'dd/MM/yyyy hh:mm:ss'),ticket_code:$scope.filteredSales[i].ticket_code,fromTo:$scope.filteredSales[i].from+'-'+$scope.filteredSales[i].to,flightLocator:$scope.filteredSales[i].flightLocator,miles:$rootScope.formatNumber($scope.filteredSales[i].milesused,0)});}}doc.autoTable(columns,rows,{styles:{fontSize:6,overflow:'linebreak',margin:{horizontal:4},columnWidth:'auto'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='miles'){cell.styles.halign='right';}}});doc.save('Relatorio.pdf');});};$scope.reportSales=function(){$.post("../backend/application/index.php?rota=/loadSalesToOperations",{order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.salesToReport=jQuery.parseJSON(result).dataset.sales;var data=[['Data Venda','Fornecedor','Pax','Embarque','ETicket','Localizador','Milhas usadas','Milhas vendidas','Trecho','Empresa','Emissor','Usuario','Valor','Companhia','Categoria','Tipo Cartao','notificationcode','Taxa Embarque','Taxa DU','Bagagem','Conforto','Custo cancelamento','cartao de credito','nacional\internacional']];for(var i in $scope.salesToReport){var partnerName=$scope.salesToReport[i].providerName;if($scope.salesToReport[i].saleByThird=='Y'){partnerName=$scope.salesToReport[i].sale_method;}data.push([$filter('date')(new Date($scope.salesToReport[i].issueDate),'dd/MM/yyyy hh:mm:ss'),partnerName,$scope.salesToReport[i].paxName,$filter('date')(new Date($scope.salesToReport[i].boardingDate),'dd/MM/yyyy hh:mm:ss'),$scope.salesToReport[i].ticket_code?$scope.salesToReport[i].ticket_code:' ',$scope.salesToReport[i].flightLocator,$rootScope.formatNumber($scope.salesToReport[i].milesused,0),$rootScope.formatNumber($scope.salesToReport[i].milesOriginal,0),$scope.salesToReport[i].from+'-'+$scope.salesToReport[i].to,$scope.salesToReport[i].client,$scope.salesToReport[i].issuing,$scope.salesToReport[i].user,$scope.salesToReport[i].amountPaid,$scope.salesToReport[i].airline,$scope.salesToReport[i].flight_category,$scope.salesToReport[i].cards_type?$scope.salesToReport[i].cards_type:' ',$scope.salesToReport[i].notificationcode?$scope.salesToReport[i].notificationcode:' ',$scope.salesToReport[i].tax,$scope.salesToReport[i].duTax,$scope.salesToReport[i].baggage_price?$scope.salesToReport[i].baggage_price:' ',$scope.salesToReport[i].special_seat?$scope.salesToReport[i].special_seat:' ',$scope.salesToReport[i].status.indexOf('Cancelamento')>-1?$scope.salesToReport[i].totalCost:'0',"="+'"'+parseInt($scope.salesToReport[i].cardTax)+'"',$scope.salesToReport[i].international==true?'Internacional':'Nacional']);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","my_data.csv");document.body.appendChild(link);link.click();});};$scope.refundsToCsv=function(){var data=[['Data_Venda','Status','Data','Agencia','PAX','E-TICKET','LOC','TIP CART','PONTOS','CARTAO','CREDITO','PEDIDO','VALOR','DATA VOO','TRECHO','RETORNO','PROCESSO','MULTA','VALOR CLIENTE']];$.post("../backend/application/index.php?rota=/loadRefundSales",{hashId:$scope.session.hashId},function(result){$scope.refundSales=jQuery.parseJSON(result).dataset;for(var i in $scope.refundSales){data.push([$scope.refundSales[i].issueDate,$scope.refundSales[i].status,$scope.refundSales[i].refundDate,$scope.refundSales[i].client,$scope.refundSales[i].paxName,$scope.refundSales[i].ticket_code,$scope.refundSales[i].flightLocator,$scope.refundSales[i].cards_type,$rootScope.formatNumber($scope.refundSales[i].milesused,0),$scope.refundSales[i].providerName,$scope.refundSales[i].cardTax,$scope.refundSales[i].airlineSolicitation,$rootScope.formatNumber($scope.refundSales[i].valueCia),$scope.refundSales[i].boardingDate,$scope.refundSales[i].airportFrom+'-'+$scope.refundSales[i].airportTo,$scope.refundSales[i].returnDate,$scope.refundSales[i].multc,$scope.refundSales[i].amount]);}var csvContent="data:text/csv;charset=utf-8,";var dataString;data.forEach(function(infoArray,index){dataString=infoArray.join(";");csvContent+=index<data.length?dataString+"\n":dataString;});var encodedUri=encodeURI(csvContent);var link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download","my_data.csv");document.body.appendChild(link);link.click();});};$scope.backToSale=function(){$scope.tabindex=0;};$scope.toRefundConference=function(){$.post("../backend/application/index.php?rota=/loadRefundsToConference",{filter:$scope.filterConference},function(result){$scope.refunds=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.tabindex=3;};$scope.setRefundCheck=function(refund){$.post("../backend/application/index.php?rota=/setRefundSaleCheck",{data:refund},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.toRefundConference();});};$scope.loadPendencys=function(){$.post("../backend/application/index.php?rota=/loadPendencys",{},function(result){$scope.pendencys=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.orderDown=function(rowName){$scope.searchOrder=undefined;$scope.searchOrderDown=rowName;$scope.loadOrders();};$scope.loadOrders=function(){$.post("../backend/application/index.php?rota=/loadSalesToOperations",{page:$scope.currentPage,numPerPage:$scope.numPerPage,searchKeywords:$scope.searchKeywords,order:$scope.searchOrder,orderDown:$scope.searchOrderDown,data:$scope.filter},function(result){$scope.sales=jQuery.parseJSON(result).dataset.sales;$scope.totalData=jQuery.parseJSON(result).dataset.total;$scope.tabindex=0;cfpLoadingBar.complete();$scope.$digest();});};init=function init(){$scope.checkValidRoute();if($scope.main.id==''){return;}$scope.tabindex=0;$scope.showRefunds=false;$rootScope.modalOpen=true;$scope.filter={};$scope.refundsChart=[];cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadAirport",$scope.session,function(result){$scope.airports=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadAirline",$scope.session,function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$scope.loadOrders();$.post("../backend/application/index.php?rota=/loadInternalCards",$scope.session,function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;});$scope.loadPendencys();};$scope.setSelectedRefund=function(){$scope.selected=angular.copy(this.refund);$('#salemilesused').number(true,0,',','.');$('#saletax').number(true,2,',','.');$('#saledutax').number(true,2,',','.');$('#saletotalcost').number(true,2,',','.');$('#saleamountpaid').number(true,2,',','.');$('#saleextrafee').number(true,2,',','.');$('#salekickback').number(true,2,',','.');$('#milesMoney').number(true,2,',','.');$('#totalCost').number(true,2,',','.');$('#newMiles').number(true,0,',','.');$("#newValue").maskMoney({thousands:'.',decimal:',',precision:2});$("#repricingCost").maskMoney({thousands:'.',decimal:',',precision:2});$.post("../backend/application/index.php?rota=/loadBilletFinancial",{data:$scope.selected},function(result){$scope.selected.billetStatus=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadLog",{data:$scope.selected},function(result){$scope.saleLog=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.airlineShowFields=$scope.selected.airline=='TAM'||$scope.selected.airline=='LATAM';$scope.boardingDate=new Date($scope.selected.boardingDate);$scope.landingDate=new Date($scope.selected.landingDate);$scope.paxBirthdate=new Date($scope.selected.paxBirthdate+'T12:00:00Z');if($scope.selected.status=="Reembolso Solicitado"||$scope.selected.status=="Reembolso Pagante Solicitado"||$scope.selected.status=="Reembolso No-show Solicitado"||$scope.selected.status=="Reembolso CIA"){$.post("../backend/application/index.php?rota=/loadBillsPayRefund",{data:$scope.selected},function(result){$scope.selected.billsPayValue=jQuery.parseJSON(result).dataset;$scope.$digest();});}$scope.tabindex=4;return true;};$scope.backToConference=function(){$scope.selected={};$scope.tabindex=3;};$scope.setSelectedPendency=function(selected){$rootScope.$emit('openSalePendencyModal',selected);};$scope.revertStatus=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_confirmation.html",controller:'ModalConfirmationCtrl',resolve:{header:function header(){return'Reverter Venda';}}});modalInstance.result.then(function(filterSales){$.post("../backend/application/index.php?rota=/revertStatusSale",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadOrders();});});};$scope.openRepricingWarning=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/card_data.html",controller:'ModalCardDataCtrl',resolve:{cards:function cards(){return $scope.selected;}}});};$scope.openSearchModal=function(){var modalInstance;$scope.filter={};modalInstance=$modal.open({templateUrl:"SaleRefoundModalDemoCtrl.html",controller:'SaleRefoundModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){if($scope.main.isMaster||$scope.main.sale||$scope.main.changeMiles||$scope.main.internRefund||$scope.main.conference||$scope.main.wizarSaleEvent){filter._boardingDateFrom=$rootScope.formatServerDate(filter.boardingDateFrom);filter._boardingDateTo=$rootScope.formatServerDate(filter.boardingDateTo);filter._saleDateFrom=$rootScope.formatServerDate(filter.saleDateFrom);filter._saleDateTo=$rootScope.formatServerDate(filter.saleDateTo);filter._refundDateFrom=$rootScope.formatServerDate(filter.refundDateFrom);filter._refundDateTo=$rootScope.formatServerDate(filter.refundDateTo);filter._returnDateFrom=$rootScope.formatServerDate(filter.returnDateFrom);filter._returnDateTo=$rootScope.formatServerDate(filter.returnDateTo);}else{var today=new Date();today.setDate(today.getDate()-1);filter._saleDateFrom=$rootScope.formatServerDate(today);filter._saleDateTo=$rootScope.formatServerDate();}}$scope.filter=filter;$scope.loadOrders();},function(){$log.info("Modal dismissed at: "+new Date());});};$scope.openSearchModalTwo=function(){var modalInstance;$scope.filterConference={};modalInstance=$modal.open({templateUrl:"SaleRefoundConferenceModalDemoCtrl.html",controller:'SaleRefoundModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filterConference;}}});modalInstance.result.then(function(filterConference){if(filterConference!=undefined){if($scope.main.isMaster||$scope.main.sale||$scope.main.changeMiles||$scope.main.internRefund||$scope.main.conference||$scope.main.wizarSaleEvent){filterConference._boardingDateFrom=$rootScope.formatServerDate(filterConference.boardingDateFrom);filterConference._boardingDateTo=$rootScope.formatServerDate(filterConference.boardingDateTo);filterConference._saleDateFrom=$rootScope.formatServerDate(filterConference.saleDateFrom);filterConference._saleDateTo=$rootScope.formatServerDate(filterConference.saleDateTo);filterConference._refundDateFrom=$rootScope.formatServerDate(filterConference.refundDateFrom);filterConference._refundDateTo=$rootScope.formatServerDate(filterConference.refundDateTo);filterConference._returnDateFrom=$rootScope.formatServerDate(filterConference.returnDateFrom);filterConference._returnDateTo=$rootScope.formatServerDate(filterConference.returnDateTo);}else{filterConference._saleDateFrom=$rootScope.formatServerDate(new Date());filterConference._saleDateTo=$rootScope.formatServerDate();}}$scope.filterConference=filterConference;$scope.toRefundConference();},function(){});};$scope.generateRepricing=function(repricing){$scope.repricing._boardingDate=$rootScope.formatServerDateTime($scope.repricing.boardingDate);$scope.repricing._landingDate=$rootScope.formatServerDateTime($scope.repricing.landingDate);$.post("../backend/application/index.php?rota=/generateRepricing",{data:$scope.selected,repricing:$scope.repricing},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.toggleFormTable();$scope.loadOrders();});};$scope.openRepricingModal=function(){$.post("../backend/application/index.php?rota=/loadInternalCards",{},function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;$scope.flight_selected=$scope.selected;$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};for(var i in $scope.internalCards){$scope.internalCards[i].password=$scope.decript($scope.internalCards[i].password);}$scope.repricing.newValue=$('#newValue').maskMoney('unmasked')[0];$scope.repricing.repricingCost=$('#repricingCost').maskMoney('unmasked')[0];$scope.repricing.returnMiles=false;var cost=$scope.repricing.repricingCost+$scope.repricing.milesused/1000*$scope.repricing.newValue;$scope.repricing.tax_card='';$scope.repricing.value=parseFloat(cost);$scope.repricing.valueRefund=0;$.post("../backend/application/index.php?rota=/loadCardProvider",{data:$scope.flight_selected},function(result){$scope.TaxCard=jQuery.parseJSON(result).dataset;if($scope.TaxCard.length==1&&$scope.flight_selected.tax_card==undefined){$scope.repricing.tax_card=$scope.TaxCard[0].card_number;$scope.repricing.tax_password=$scope.decript($scope.TaxCard[0].password);$scope.repricing.tax_cardType=$scope.TaxCard[0].card_type;$scope.repricing.tax_dueDate=$scope.TaxCard[0].due_date;$scope.repricing.tax_providerName=$scope.TaxCard[0].provider_name;$scope.repricing.provider_registration=$scope.TaxCard[0].provider_registration;$scope.repricing.provider_adress=$scope.TaxCard[0].provider_adress;$scope.repricing.birthdate=$scope.TaxCard[0].birthdate;}else{$scope.TaxCard={};}var modalInstance;if($scope.repricing.method){modalInstance=$modal.open({templateUrl:"RepricingCtrl.html",controller:'RepricingInstanceCtrl',resolve:{repricing:function repricing(){return $scope.repricing;},internalCards:function internalCards(){return $scope.internalCards;},TaxCard:function TaxCard(){return $scope.TaxCard;}}});modalInstance.result.then(function(repricing){$scope.generateRepricing(repricing);});}});});};return init();}]).controller('SaleRefoundModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter',function($scope,$rootScope,$modalInstance,filter){$scope.saleStatus=['Pendente','Emitido','Reembolso Solicitado','Reembolso Pagante Solicitado','Reembolso CIA','Reembolso Confirmado','Cancelamento Solicitado','Cancelamento Efetivado','Cancelamento Nao Solicitado','Remarcação Solicitado','Remarcação Confirmado','Cancelamento Pendente','Reembolso Pendente','Reembolso No-show Solicitado','Reembolso No-show Confirmado','Reembolso Nao Solicitado','Reembolso Perdido'];$.post("../backend/application/index.php?rota=/loadProvider",{hashId:$scope.$parent.hashId},function(result){$scope.providers=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.filterConference=filter;$scope.okConference=function(){$modalInstance.close($scope.filterConference);};$scope.cancelConference=function(){$modalInstance.dismiss("cancel");};}]).controller('RefundCtrl',['$scope','$rootScope','$modal','$log','logger',function($scope,$rootScope,$modal,$log,logger){$scope.generateRefund=function(Refund){$.post("../backend/application/index.php?rota=/generateRefund",{hashId:$scope.$parent.hashId,refund:Refund,sale:$scope.$parent.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.$parent.$parent.toggleFormTable();$scope.$parent.$parent.$parent.loadOrders();});};$scope.open=function(){$.post("../backend/application/index.php?rota=/loadInternalCards",$scope.session,function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;$scope.flight_selected=$scope.$parent.selected;$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};for(var i in $scope.internalCards){$scope.internalCards[i].password=$scope.decript($scope.internalCards[i].password);}if($scope.$parent.getMulta($scope.flight_selected)){var valueRefund=0;if($scope.flight_selected.SaleProvider=='Loja TAM M'){valueRefund=178;}else if($scope.flight_selected.SaleProvider=='Loja TAM Contagem'){valueRefund=175;}else if($scope.flight_selected.SaleProvider=='Loja TAM Ponta Grossa'){valueRefund=190;}$scope.refund={value:parseFloat(($scope.flight_selected.amountPaid-$scope.$parent.getMulta($scope.flight_selected)).toFixed(2)),valueRefund:valueRefund};}else{$scope.refund={value:0,valueRefund:0};}$.post("../backend/application/index.php?rota=/loadCardProvider",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.TaxCard=jQuery.parseJSON(result).dataset;if($scope.TaxCard.length==1&&$scope.flight_selected.tax_card==undefined){$scope.refund.tax_card=$scope.TaxCard[0].card_number;$scope.refund.tax_password=$scope.decript($scope.TaxCard[0].password);$scope.refund.tax_cardType=$scope.TaxCard[0].card_type;$scope.refund.tax_dueDate=$scope.TaxCard[0].due_date;$scope.refund.tax_providerName=$scope.TaxCard[0].provider_name;$scope.refund.provider_registration=$scope.TaxCard[0].provider_registration;$scope.refund.provider_adress=$scope.TaxCard[0].provider_adress;$scope.refund.birthdate=$scope.TaxCard[0].birthdate;}else{$scope.TaxCard={};}var modalInstance;modalInstance=$modal.open({templateUrl:"Refund.html",controller:'RefundInstanceCtrl',resolve:{Refund:function Refund(){return $scope.refund;},internalCards:function internalCards(){return $scope.internalCards;},TaxCard:function TaxCard(){return $scope.TaxCard;},selected:function selected(){return $scope.flight_selected;}}});modalInstance.result.then(function(Refund){$scope.generateRefund(Refund);});});});};}]).controller('RefundInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','Refund','internalCards','TaxCard','selected',function($scope,$rootScope,$modalInstance,$filter,Refund,internalCards,TaxCard,selected){$scope.refund=Refund;$scope.internalCards=internalCards;$scope.TaxCard=TaxCard;$scope.selected=selected;$scope.findDate=function(date){if(date!=''){return new Date(date+'T12:00:00Z');}else{return'';}};$scope.saleMethods=['JACK FOR','Loja TAM Ponta Grossa','Loja TAM Contagem','Loja TAM M','Rextur Advance','Outros'];$scope.getTextRefund=function(){var issueDate=new Date($scope.selected.issueDate);issueDate.setDate(issueDate.getDate()+60);if(issueDate<new Date()){return'Reembolso invalido !!! Data posterior a XYZ dias';}if($scope.selected.saleType=='Cartao'){return'Reembolso de venda cartão';}};$scope.search=function(){$scope.TaxCard=$filter('filter')($scope.internalCards,$scope.filter);$scope.refund.tax_card=$scope.TaxCard[0].card_number;$scope.refund.tax_password=$scope.TaxCard[0].password;$scope.refund.tax_cardType=$scope.TaxCard[0].card_type;$scope.refund.tax_dueDate=$scope.findDate($scope.TaxCard[0].due_date);$scope.refund.tax_providerName=$scope.TaxCard[0].provider_name;$scope.refund.provider_registration=$scope.TaxCard[0].provider_registration;$scope.refund.provider_adress=$scope.TaxCard[0].provider_adress;$scope.refund.birthdate=$scope.findDate($scope.TaxCard[0].birthdate);};$scope.ok=function(){$modalInstance.close($scope.refund);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('CancelCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.open=function(){var modalInstance;$.post("../backend/application/index.php?rota=/loadCardsData",{sale:$scope.$parent.selected},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};if($scope.cards.recovery_password){$scope.cards.recovery_password=$scope.decript($scope.cards.recovery_password);}if($scope.cards.access_password){$scope.cards.access_password=$scope.decript($scope.cards.access_password);}modalInstance=$modal.open({templateUrl:"Cancel.html",controller:'CancelInstanceCtrl',resolve:{cards:function cards(){return $scope.cards;}}});modalInstance.result.then(function(selected){$scope.$parent.$parent.$parent.selected.CancelCost=selected.CancelCost;$scope.$parent.$parent.$parent.selected.CancelReason=selected.CancelReason;$scope.$parent.$parent.$parent.selected.cancelDate=selected.cancelDate;$scope.$parent.$parent.$parent.selected.ourCost=selected.ourCost;$scope.$parent.$parent.$parent.cancelSale();});});};}]).controller('CancelInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','cards',function($scope,$rootScope,$modalInstance,logger,cards){$scope.cards=cards;$scope.selected={cancelDate:new Date()};$scope.ok=function(){if(!$scope.selected.ourCost){return logger.logError("Nosso Custo obrigatorio");}$modalInstance.close($scope.selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('ShowCardCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.open=function(){var modalInstance;$scope.selected=$scope.$parent.$parent.$parent.selected;$.post("../backend/application/index.php?rota=/loadCardsData",{hashId:$scope.session.hashId,sale:$scope.$parent.selected},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.cards.recovery_password=$scope.decript($scope.cards.recovery_password);$scope.cards.access_password=$scope.decript($scope.cards.access_password);modalInstance=$modal.open({templateUrl:"Card.html",controller:'ShowCardInstanceCtrl',resolve:{cards:function cards(){return $scope.cards;},selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(selected){});});};}]).controller('ShowCardInstanceCtrl',['$scope','$rootScope','$modalInstance','cards','selected',function($scope,$rootScope,$modalInstance,cards,selected){$scope.cards=cards;$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('RepricingInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','repricing','internalCards','TaxCard',function($scope,$rootScope,$modalInstance,$filter,repricing,internalCards,TaxCard){$scope.repricing=repricing;$scope.internalCards=internalCards;$scope.TaxCard=TaxCard;$scope.saleMethods=['JACK FOR','Loja TAM Ponta Grossa','Loja TAM Contagem','Loja TAM M','Rextur Advance','Outros'];$scope.safePossibilities=[{method:'Faturado'},{method:'Cartao'}];$('#refundvalue').number(true,0,',','.');$('#value').number(true,0,',','.');$scope.search=function(){$scope.TaxCard=$filter('filter')($scope.internalCards,$scope.filter);$scope.repricing.tax_card=$scope.TaxCard[0].card_number;$scope.repricing.tax_password=$scope.TaxCard[0].password;$scope.repricing.tax_cardType=$scope.TaxCard[0].card_type;$scope.repricing.tax_dueDate=new Date($scope.TaxCard[0].due_date+'T12:00:00Z');$scope.repricing.tax_providerName=$scope.TaxCard[0].provider_name;$scope.repricing.provider_registration=$scope.TaxCard[0].provider_registration;$scope.repricing.provider_adress=$scope.TaxCard[0].provider_adress;$scope.repricing.birthdate=new Date($scope.TaxCard[0].birthdate+'T12:00:00Z');};$scope.ok=function(){$modalInstance.close($scope.repricing);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).directive('morrisRefundChart',[function(){return{restrict:'A',scope:{data:'='},link:function link(scope,ele,attrs,update,bar,updateInterval,_finish29){var colors,data,func,options;data=scope.data;updateInterval=3000;if(attrs.lineColors===void 0||attrs.lineColors===''){colors=null;}else{colors=JSON.parse(attrs.lineColors);}options={element:ele[0],data:scope.$parent.refundsChart,xkey:attrs.xkey,ykeys:JSON.parse(attrs.ykeys),labels:JSON.parse(attrs.labels),lineWidth:attrs.lineWidth||2,lineColors:colors||['#0b62a4','#7a92a3','#4da74d','#afd8f8','#edc240','#cb4b4b','#9440ed'],resize:true};update=function update(){setTimeout(_finish29,updateInterval);options.data=scope.$parent.refundsChart;};_finish29=function finish(){if(scope.$parent.refundsChart!=undefined&&scope.$parent.refundsChart.length>0){options.data=scope.$parent.refundsChart;return new Morris.Line(options);}else{setTimeout(_finish29,updateInterval);}};return update();}};}]).controller('SalePendencyModalCtrl',['$scope','$rootScope','$modal','$log','logger',function($scope,$rootScope,$modal,$log,logger){$scope.setSalePendencyStatus=function(sale){$.post("../backend/application/index.php?rota=/setSalePendencyStatus",{data:sale},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.loadPendencys();});};$scope.open=function(){var modalInstance;$scope.selected=$scope.$parent.selected;modalInstance=$modal.open({templateUrl:"SalePendencyModal.html",controller:'SalePendencyModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(selected){$scope.setSalePendencyStatus(selected);},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('SalePendencyModalInstanceCtrl',['$scope','$rootScope','$modalInstance','selected',function($scope,$rootScope,$modalInstance,selected){$scope.selected=selected;$scope.ok=function(){$modalInstance.close($scope.selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('SalePendencyDescriptionModalCtrl',['$scope','$rootScope','$modal','$log','logger',function($scope,$rootScope,$modal,$log,logger){$scope.setSalePendencyStatus=function(sale){$.post("../backend/application/index.php?rota=/setSalePendencyStatus",{data:sale},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.loadPendencys();});};$rootScope.modalOpen=false;$rootScope.$on('openSalePendencyModal',function(event,args){if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;if(args){$scope.selected=args;}modalInstance=$modal.open({templateUrl:"SalePendencyModalDescription.html",controller:'SalePendencyModalDescriptionInstanceCtrl',periods:$scope.$parent.periods,size:'lg',resolve:{selected:function selected(){return $scope.selected;}}});modalInstance.result.then(function(selected){$scope.setSalePendencyStatus(selected);$rootScope.modalOpen=false;},function(){$log.info("Modal dismissed at: "+new Date());$rootScope.modalOpen=false;});};}]).controller('SalePendencyModalDescriptionInstanceCtrl',['$scope','$rootScope','$modalInstance','selected',function($scope,$rootScope,$modalInstance,selected){$scope.selected=selected;$.post("../backend/application/index.php?rota=/loadSalePendencys",{data:$scope.selected},function(result){$scope.logsPendencys=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.findDate=function(date){return new Date(date);};$scope.ok=function(){$modalInstance.close($scope.selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("reembolsoModalInstanceCtrl",["$scope","$rootScope","$modalInstance",function($scope,$rootScope,$modalInstance){$scope.ok=function(){$modalInstance.close();};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app').controller('RemittanceFileCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger','FileUploader','$window',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger,FileUploader,$window){var init;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.banks=['BRADESCO','SANTANDER'];$scope.searchKeywords='';$scope.filteredBillsReceive=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBillsReceive=$scope.filteredBillsReceive.slice(start,end);};$scope.getStatusDesc=function(status){switch(status){case'B':return"Baixada";case'E':return"Emitida";case'A':return"Em Aberto";case'T':return"Transferencia";}};$scope.redirectToGoogle=function(link){$window.open(link,'_blank');};$scope.findColor=function(billreceive){if(billreceive.paymentType=='Boleto'){return'#98d1f5';}};$scope.billReceiveTag=function(status){switch(status){case'B':return"label label-success";case'E':return"label label-info";case'A':return"label label-warning";case'T':return"label label-default";}};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.setSelected=function(){$scope.selected=this.billreceive;$scope.nextWizardStage();return $scope.selected;};$scope.search=function(){$scope.filteredBillsReceive=$filter('filter')($scope.billsreceive,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredBillsReceive=$filter('orderBy')($scope.billsreceive,rowName);return $scope.onOrderChange();};$scope.nextWizardStage=function(){$scope.tabindex=$scope.tabindex+1;return $scope.tabindex;};$scope.priorWizardStage=function(){$scope.tabindex=$scope.tabindex-1;return $scope.tabindex;};$scope.WizardStageProgress=function(){return($scope.tabindex+1)*34;};$scope.addRow=function(_bill){if(_bill.status=='B'){_bill.checked=false;}return _bill;};$scope.loadBills=function(){if($scope.wbillet_client.$valid){$scope.loadBillsReceive();$scope.nextWizardStage();}};$scope.addRow=function(){this.client.checked!=this.client.checked;};var getSumBills=function getSumBills(clients,callback){var newClients=[];var clientsNotValid=[];for(var i in clients){var _client=angular.copy(clients[i]);var newBills=[];for(var j in _client.bills){var _bill=angular.copy(_client.bills[j]);if(_bill.checked)newBills.push(_bill);}if(_client.registrationCode&&_client.zipCode&&_client.bills.length>0&&_client.name&&_client.adress&&_client.checked==true&&_client.paymentType=='Boleto'&&_client.billingPeriod=='Diario'){if(newBills.length>0){_client.bills=angular.copy(newBills);newClients.push(_client);}}else{clientsNotValid.push(_client);}}var doc_number;var our_number;$.post("../backend/application/index.php?rota=/loadLastBillet",$scope.session,function(result){var lastBillet=jQuery.parseJSON(result).dataset;doc_number=parseInt(lastBillet.id);our_number=parseInt(lastBillet.id);for(var index in newClients){doc_number++;our_number++;newClients[index].billToReceive=angular.copy(newClients[index].bills[0]);newClients[index].billToReceive.description='';newClients[index].billToReceive.alreadyPaid=0;newClients[index].billToReceive.actual_value=0;newClients[index].billToReceive.discount=0;if(newClients[index].paymentType=='Antecipado'){for(var i in newClients[index].bills){if(newClients[index].bills[i].account_type=="Reembolso"||newClients[index].bills[i].account_type=="Credito"||newClients[index].bills[i].account_type=="Credito Adiantamento"){newClients[index].billToReceive.actual_value=newClients[index].billToReceive.actual_value-newClients[index].bills[i].actual_value;if(newClients[index].bills[i].paymentType=='Comum'){newClients[index].billToReceive.alreadyPaid=newClients[index].billToReceive.alreadyPaid-newClients[index].bills[i].actual_value;}}else{newClients[index].billToReceive.actual_value=newClients[index].billToReceive.actual_value+newClients[index].bills[i].actual_value;if(newClients[index].bills[i].paymentType=='Comum'){newClients[index].billToReceive.alreadyPaid=newClients[index].billToReceive.alreadyPaid+newClients[index].bills[i].actual_value;}}}}else{for(var i in newClients[index].bills){if(newClients[index].bills[i].account_type=="Reembolso"||newClients[index].bills[i].account_type=="Credito"||newClients[index].bills[i].account_type=='Credito Adiantamento'){newClients[index].billToReceive.actual_value=newClients[index].billToReceive.actual_value-newClients[index].bills[i].actual_value;}else{newClients[index].billToReceive.actual_value=newClients[index].billToReceive.actual_value+newClients[index].bills[i].actual_value;if(newClients[index].useCommission==true){newClients[index].billToReceive.actual_value-=newClients[index].bills[i].comission;newClients[index].billToReceive.discount+=newClients[index].bills[i].comission;}}}}newClients[index].billToReceive.valueFloat=newClients[index].billToReceive.actual_value;newClients[index].billToReceive.actual_value=$rootScope.formatNumber(newClients[index].billToReceive.actual_value);newClients[index].billToReceive.doc_number=doc_number;newClients[index].billToReceive.our_number=our_number;newClients[index].billToReceive.transfer=false;newClients[index].billToReceive.due_date=new Date(newClients[index].billToReceive.due_date+'T12:00:00Z');var lastBank=window.localStorage.getItem("last-bank");if(lastBank){newClients[index].billToReceive.bank=lastBank;}else{newClients[index].billToReceive.bank='BRADESCO';}if(newClients[index].paymentType=='Antecipado'&&!newClients[index].billToReceive.early){newClients[index].billToReceive.early=true;newClients[index].billToReceive.hasBillet=false;}else{newClients[index].billToReceive.early=false;newClients[index].billToReceive.hasBillet=true;}if(newClients[index].paymentType=='Antecipado'){for(var i in newClients[index].bills){if(newClients[index].bills[i].paymentType=='Boleto'){newClients[index].billToReceive.early=false;newClients[index].billToReceive.hasBillet=true;}}}if(newClients[index].workingDays==true||newClients[index].workingDays=='true'){var paymentDays=0;if(newClients[index].paymentDays>7){paymentDays=parseInt(newClients[index].paymentDays/5)*2+newClients[index].paymentDays;newClients[index].billToReceive.due_date=new Date();newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+paymentDays);}else{paymentDays=newClients[index].paymentDays;newClients[index].billToReceive.due_date=new Date();if(newClients[index].billToReceive.due_date.getDay()==0){newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+1);paymentDays--;}if(newClients[index].billToReceive.due_date.getDay()==6){newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+2);paymentDays--;}for(var j=0;j<paymentDays;j++){if(newClients[index].billToReceive.due_date.getDay()==0){newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+1);}if(newClients[index].billToReceive.due_date.getDay()==6){newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+2);}newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+1);}}}else{newClients[index].billToReceive.due_date=new Date();newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+newClients[index].paymentDays);}if(newClients[index].billToReceive.due_date.getDay()==6){newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+2);}if(newClients[index].billToReceive.due_date.getDay()==0){newClients[index].billToReceive.due_date.setDate(newClients[index].billToReceive.due_date.getDate()+1);}var object={clientsToReceive:newClients,clientsNotValid:clientsNotValid};}callback(object);});};$scope.getTotalChecked=function(){var total=0;for(var i in $scope.clientsToReceive){if($scope.clientsToReceive[i].checked==true&&$scope.clientsToReceive[i].alreadBilled==0&&$scope.clientsToReceive[i].paymentType!='Antecipado'&&$scope.clientsToReceive[i].totalValue>0){total+=$scope.clientsToReceive[i].totalValue;}}return total;};$scope.filterList=function(item){return item.paymentType!='Antecipado'&&item.totalValue>0;};$scope.filterListPreview=function(item){return item.paymentType=='Antecipado'||item.totalValue<=0;};$scope.loadOpenedBillets=function(){$.post("../backend/application/index.php?rota=/loadOpenedBillets",{data:$scope.client},function(result){$scope.openedBillets=jQuery.parseJSON(result).dataset;if($scope.openedBillets.length>0){$scope.possibleCloseBillets=true;$scope.$digest();}});};$scope.setBilletToClose=function(billet){$scope.currentBillet=billet;};$scope.openModalCloseBillets=function(){$rootScope.$emit('openCloseBillesWtihCreditModal',$scope.openedBillets);};$scope.setActual_Value=function(){$scope.wbillet.actual_value=parseFloat($scope.wbillet.original_value)+parseFloat($scope.wbillet.tax)-parseFloat($scope.wbillet.discount);};$scope.findBillets=function(){$scope.billsreceive=[];$.post("../backend/application/index.php?rota=/loadBillGenerated",{hashId:$scope.session.hashId,data:$scope.client},function(result){$scope.billsgenerated=jQuery.parseJSON(result).dataset;for(var i in $scope.billsgenerated){$scope.fillBillets($scope.billsgenerated[i]);}$scope.billetGenerated=true;$scope.search();$scope.$apply();});};$scope.fillBillets=function(bill){var alreadFill=false;bill.pax_name='';bill.flightLocator='';for(var j in $scope.billsreceive){if($scope.billsreceive[j].billet===bill.billet){alreadFill=true;if(bill.account_type=="Reembolso"||bill.account_type=="Credito"||bill.account_type=='Credito Adiantamento'){$scope.billsreceive[j].actual_value-=bill.actual_value;}else{$scope.billsreceive[j].actual_value+=bill.actual_value;}}}if(!alreadFill){if(bill.account_type=="Reembolso"||bill.account_type=="Credito"||bill.account_type=='Credito Adiantamento'){void 0;bill.actual_value=bill.actual_value*-1;}bill.account_type='BORDERO';$scope.billsreceive.push(bill);}};$scope.addDivision=function(){$scope.billetsDivision.push({actualValue:0,dueDate:$scope.wbillet.due_date,name:$scope.wbillet.our_number});};$scope.removeDivision=function(){$scope.billetsDivision.pop();};$scope.getSumBillsReceive=function(){var value=0;if($scope.billsreceive){if($scope.billsreceive.length>0){$scope.checkedrows=$filter('filter')($scope.billsreceive,true);for(var i in $scope.checkedrows){if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=='Credito Adiantamento'){value-=$scope.checkedrows[i].actual_value;}else{value+=$scope.checkedrows[i].actual_value;}}}}return $rootScope.formatNumber(value);};$scope.markAll=function(){for(var i in $scope.billsreceive){$scope.billsreceive[i].checked=true;}};$scope.unMarkAll=function(){for(var i in $scope.billsreceive){$scope.billsreceive[i].checked=false;}};$scope.loadBillsReceive=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadBillsReceive",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.billsreceive=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$.post("../backend/application/index.php?rota=/loadClientsByFilter",{hashId:$scope.session.hashId,data:$scope.filter},function(result){$scope.client=jQuery.parseJSON(result).dataset;$scope.client=$scope.client[0];});return $scope.select($scope.currentPage);});};$scope.setSelectedClient=function(_client){if($scope.selectedClient){if($scope.selectedClient==_client)$scope.selectedClient={};else $scope.selectedClient=_client;}else $scope.selectedClient=_client;};$scope.toggleAll=function(_client){var toggleStatus=_client.isAllSelected;angular.forEach(_client.bills,function(itm){itm.checked=toggleStatus;});return _client;};$scope.optionToggled=function(_client){_client.isAllSelected=_client.bills.every(function(bill){return bill.selected;});return _client;};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open('GET',url);xhr.send();};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBillsReceive=[];$rootScope.hashId=$scope.session.hashId;$scope.yesterdayBills=function(){$scope.buttonEnable=false;$.post("../backend/application/index.php?rota=/yesterdayBills",$scope.session,function(result){$scope.clientsToReceive=jQuery.parseJSON(result).dataset;$scope.buttonEnable=true;$scope.$apply();$scope.caclValuesAndDueDate();});};$scope.caclValuesAndDueDate=function(){for(var index in $scope.clientsToReceive){if($scope.clientsToReceive[index].paymentType=='Antecipado'){$scope.clientsToReceive[index].totalValue=0;}else{$scope.clientsToReceive[index].totalValue=0;for(var i in $scope.clientsToReceive[index].bills){if($scope.clientsToReceive[index].bills[i].checked&&$scope.clientsToReceive[index].bills[i].alreadBilled==0){if($scope.clientsToReceive[index].bills[i].account_type=="Reembolso"||$scope.clientsToReceive[index].bills[i].account_type=="Credito"||$scope.clientsToReceive[index].bills[i].account_type=='Credito Adiantamento'){$scope.clientsToReceive[index].totalValue=$scope.clientsToReceive[index].totalValue-$scope.clientsToReceive[index].bills[i].actual_value;}else{$scope.clientsToReceive[index].totalValue=$scope.clientsToReceive[index].totalValue+$scope.clientsToReceive[index].bills[i].actual_value;}}}}if($scope.clientsToReceive[index].workingDays==true||$scope.clientsToReceive[index].workingDays=='true'){var paymentDays=0;if($scope.clientsToReceive[index].paymentDays>7){paymentDays=parseInt($scope.clientsToReceive[index].paymentDays/5)*2+$scope.clientsToReceive[index].paymentDays;$scope.clientsToReceive[index].due_date=new Date();$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+paymentDays);}else{paymentDays=$scope.clientsToReceive[index].paymentDays;$scope.clientsToReceive[index].due_date=new Date();if($scope.clientsToReceive[index].due_date.getDay()==0){$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+1);paymentDays--;}if($scope.clientsToReceive[index].due_date.getDay()==6){$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+2);paymentDays--;}for(var j=0;j<paymentDays;j++){if($scope.clientsToReceive[index].due_date.getDay()==0){$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+1);}if($scope.clientsToReceive[index].due_date.getDay()==6){$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+2);}$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+1);}}}else{$scope.clientsToReceive[index].due_date=new Date();$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+$scope.clientsToReceive[index].paymentDays);}if($scope.clientsToReceive[index].due_date.getDay()==6){$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+2);}if($scope.clientsToReceive[index].due_date.getDay()==0){$scope.clientsToReceive[index].due_date.setDate($scope.clientsToReceive[index].due_date.getDate()+1);}}$scope.$apply();};$scope.findBilling=function(){$.post("../backend/application/index.php?rota=/checkClientsDeadLine",{hashId:$scope.session.hashId},function(result){$scope.clientsDeadLine=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findDate=function(date){return new Date(date);};$scope.findAll=function(){$.post("../backend/application/index.php?rota=/loadClientToReceive",$scope.session,function(result){$scope.clientsToReceive=jQuery.parseJSON(result).dataset;$scope.$apply();});};$scope.markAll=function(){for(var i in $scope.clientsToReceive){for(var j in $scope.clientsToReceive[i].bills){$scope.clientsToReceive[i].bills[j].checked=true;}}};$scope.uMarkAll=function(){for(var i in $scope.clientsToReceive){for(var j in $scope.clientsToReceive[i].bills){$scope.clientsToReceive[i].bills[j].checked=false;}}};$scope.markAllClients=function(){for(var i in $scope.clientsToReceive){$scope.clientsToReceive[i].checked=true;}};$scope.uMarkAllClients=function(){for(var i in $scope.clientsToReceive){$scope.clientsToReceive[i].checked=false;}};$scope.generateRemittanceBradescoSRM=function(){$scope.buttonEnable=false;getSumBills(angular.copy($scope.clientsToReceive),function(clients){if(clients.clientsToReceive.length>0){clients.clientsToReceive.forEach(function(element){element.billToReceive.due_date=$rootScope.formatServerDate(element.billToReceive.due_date);},this);$.post("../backend/application/index.php?rota=/SRM/generateRemittanceBradesco",{data:clients.clientsToReceive},function(result){$scope.printAll(clients.clientsToReceive);var status=jQuery.parseJSON(result).dataset['status'];var message=jQuery.parseJSON(result).dataset['message'];if(status=='success'){$scope.redirectToGoogle(jQuery.parseJSON(result).dataset['arquivo_path']);logger.logSuccess(message);$scope.yesterdayBills();}else{logger.logError(message);}$scope.$apply();if(clients.clientsNotValid.length>0){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_client_list.html",controller:'NotificationClientListCtrl',periods:$scope.$parent.periods,size:'lg',resolve:{data:function data(){return clients.clientsNotValid;},header:function header(){return'Clientes não gerados';}}});logger.logError("Alguns boletos não foram emitidos. Favor verificar os dados cadastrais dos clientes e tente novamente.");}});}else{logger.logError("Favor verificar se todas as contas que foram selecionadas, estão com os dados cadastrais do cliente preenchidos corretamente.");$scope.buttonEnable=true;$scope.$apply();}});};$scope.generateRemittanceBradescoMMS=function(){$scope.buttonEnable=false;getSumBills(angular.copy($scope.clientsToReceive),function(clients){if(clients.clientsToReceive.length>0){clients.clientsToReceive.forEach(function(element){element.billToReceive.due_date=$rootScope.formatServerDate(element.billToReceive.due_date);},this);$.post("../backend/application/index.php?rota=/MMS/generateRemittanceBradesco",{data:clients.clientsToReceive},function(result){$scope.printAll(clients.clientsToReceive);var status=jQuery.parseJSON(result).dataset['status'];var message=jQuery.parseJSON(result).dataset['message'];if(status=='success'){$scope.redirectToGoogle(jQuery.parseJSON(result).dataset['arquivo_path']);logger.logSuccess(message);$scope.yesterdayBills();}else{logger.logError(message);}$scope.$apply();if(clients.clientsNotValid.length>0){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_client_list.html",controller:'NotificationClientListCtrl',periods:$scope.$parent.periods,size:'lg',resolve:{data:function data(){return clients.clientsNotValid;},header:function header(){return'Clientes não gerados';}}});logger.logError("Alguns boletos não foram emitidos. Favor verificar os dados cadastrais dos clientes e tente novamente.");}});}else{logger.logError("Favor verificar se todas as contas que foram selecionadas, estão com os dados cadastrais do cliente preenchidos corretamente.");$scope.buttonEnable=true;$scope.$apply();}});};$scope.generateRemittanceBBrasilSRM=function(){$scope.buttonEnable=false;getSumBills(angular.copy($scope.clientsToReceive),function(clients){if(clients.clientsToReceive.length>0){clients.clientsToReceive.forEach(function(element){element.billToReceive.due_date=$rootScope.formatServerDate(element.billToReceive.due_date);},this);$.post("../backend/application/index.php?rota=/SRM/generateRemittanceBBrasil",{data:clients.clientsToReceive},function(result){$scope.printAll(clients.clientsToReceive);var status=jQuery.parseJSON(result).dataset['status'];var message=jQuery.parseJSON(result).dataset['message'];if(status=='success'){$scope.redirectToGoogle(jQuery.parseJSON(result).dataset['arquivo_path']);logger.logSuccess(message);$scope.yesterdayBills();}else{logger.logError(message);}$scope.$apply();if(clients.clientsNotValid.length>0){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_client_list.html",controller:'NotificationClientListCtrl',periods:$scope.$parent.periods,size:'lg',resolve:{data:function data(){return clients.clientsNotValid;},header:function header(){return'Clientes não gerados';}}});logger.logError("Alguns boletos não foram emitidos. Favor verificar os dados cadastrais dos clientes e tente novamente.");}});}else{logger.logError("Favor verificar se todas as contas que foram selecionadas, estão com os dados cadastrais do cliente preenchidos corretamente.");$scope.buttonEnable=true;$scope.$apply();}});};$scope.generateRemittanceBBrasilMMS=function(){$scope.buttonEnable=false;getSumBills(angular.copy($scope.clientsToReceive),function(clients){if(clients.clientsToReceive.length>0){clients.clientsToReceive.forEach(function(element){element.billToReceive.due_date=$rootScope.formatServerDate(element.billToReceive.due_date);},this);$.post("../backend/application/index.php?rota=/MMS/generateRemittanceBBrasil",{data:clients.clientsToReceive},function(result){$scope.printAll(clients.clientsToReceive);var status=jQuery.parseJSON(result).dataset['status'];var message=jQuery.parseJSON(result).dataset['message'];if(status=='success'){$scope.redirectToGoogle(jQuery.parseJSON(result).dataset['arquivo_path']);logger.logSuccess(message);$scope.yesterdayBills();}else{logger.logError(message);}$scope.$apply();if(clients.clientsNotValid.length>0){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_client_list.html",controller:'NotificationClientListCtrl',periods:$scope.$parent.periods,size:'lg',resolve:{data:function data(){return clients.clientsNotValid;},header:function header(){return'Clientes não gerados';}}});logger.logError("Alguns boletos não foram emitidos. Favor verificar os dados cadastrais dos clientes e tente novamente.");}});}else{logger.logError("Favor verificar se todas as contas que foram selecionadas, estão com os dados cadastrais do cliente preenchidos corretamente.");$scope.buttonEnable=true;$scope.$apply();}});};$scope.generateRemittanceSantanderSRM=function(){$scope.buttonEnable=false;getSumBills(angular.copy($scope.clientsToReceive),function(clients){if(clients.clientsToReceive.length>0){clients.clientsToReceive.forEach(function(element){element.billToReceive.due_date=$rootScope.formatServerDate(element.billToReceive.due_date);},this);$.post("../backend/application/index.php?rota=/SRM/generateRemittanceSantander",{data:clients.clientsToReceive},function(result){$scope.printAll(clients.clientsToReceive);var status=jQuery.parseJSON(result).dataset['status'];var message=jQuery.parseJSON(result).dataset['message'];if(status=='success'){$scope.redirectToGoogle(jQuery.parseJSON(result).dataset['arquivo_path']);logger.logSuccess(message);$scope.yesterdayBills();}else{logger.logError(message);}$scope.$apply();if(clients.clientsNotValid.length>0){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/notification_client_list.html",controller:'NotificationClientListCtrl',periods:$scope.$parent.periods,size:'lg',resolve:{data:function data(){return clients.clientsNotValid;},header:function header(){return'Clientes não gerados';}}});logger.logError("Alguns boletos não foram emitidos. Favor verificar os dados cadastrais dos clientes e tente novamente.");}});}else{logger.logError("Favor verificar se todas as contas que foram selecionadas, estão com os dados cadastrais do cliente preenchidos corretamente.");$scope.buttonEnable=true;$scope.$apply();}});};$scope.printAll=function(array){var doc=new jsPDF('p','pt');void 0;for(var client in array){doc.margin=0.5;doc.setFontSize(18);var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"},{title:"Taxa",dataKey:"miles_tax"},{title:"Milhas",dataKey:"miles"},{title:"EMISSOR",dataKey:"issuing"},{title:"CLIENTE",dataKey:"client"}];var rows=[];for(var i=0;i<array[client].bills.length;i++){if(array[client].bills[i].account_type=="Reembolso"||array[client].bills[i].account_type=="Credito"||array[client].bills[i].account_type=='Credito Adiantamento'){rows.push({issuing_date:$filter('date')(array[client].bills[i].issuing_date,'dd/MM/yyyy'),flightLocator:array[client].bills[i].flightLocator,from:array[client].bills[i].account_type,airline:array[client].bills[i].airline,pax_name:array[client].bills[i].description,actual_value:array[client].bills[i].actual_value*-1,miles_tax:array[client].bills[i].miles_tax,miles:array[client].bills[i].miles,issuing:array[client].bills[i].issuing,client:array[client].bills[i].client});}else{rows.push({issuing_date:$filter('date')(array[client].bills[i].issuing_date,'dd/MM/yyyy'),flightLocator:array[client].bills[i].flightLocator,from:array[client].bills[i].from+'-'+array[client].bills[i].to,airline:array[client].bills[i].airline,pax_name:array[client].bills[i].pax_name,actual_value:$rootScope.formatNumber(array[client].bills[i].actual_value),miles_tax:array[client].bills[i].miles_tax,miles:array[client].bills[i].miles,issuing:array[client].bills[i].issuing,client:array[client].bills[i].client});}}rows.push({});rows.push({});rows.push({pax_name:'Total:',actual_value:$rootScope.formatNumber(array[client].billToReceive.valueFloat)});if(array[client].billToReceive.discount>0){rows.push({pax_name:'Descontos:',actual_value:$rootScope.formatNumber(array[client].billToReceive.discount)});}rows.push({});rows.push({issuing_date:'Vencimento:',flightLocator:$filter('date')(array[client].billToReceive.due_date,'dd/MM/yyyy'),pax_name:'Boleto Nº '+array[client].billToReceive.doc_number});doc.autoTable(columns,rows,{theme:'grid',styles:{fontSize:8,overflow:'linebreak'},startY:90,margin:{horizontal:10},bodyStyles:{valign:'top'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='actual_value'){cell.styles.halign='right';}}});doc.addPage();}doc.save('BORDEROS.pdf');};$scope.fildDateNotBlack=function(date){return new Date(date);};$scope.getClass=function(billreceive){if(billreceive.account_type=="Reembolso"||billreceive.account_type=="Credito"||billreceive.account_type=='Credito Adiantamento'){return"label label-danger";}};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.filter={};$scope.wizardBillet=false;$scope.billetGenerated=false;$scope.possibleCloseBillets=false;$rootScope.modalOpen=false;cfpLoadingBar.start();$scope.billetsDivision=[];$scope.buttonEnable=false;$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});$scope.yesterdayBills();$scope.findBilling();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<10;}});};return init();}]);})();;(function(){'use strict';angular.module('app').controller('ReturnFileCtrl',ReturnFileCtrl);ReturnFileCtrl.inject=['$scope','cfpLoadingBar','logger','FileUploader'];function ReturnFileCtrl($scope,cfpLoadingBar,logger,FileUploader){var vm=this;$scope.banks=['BBRASIL','BRADESCO','SANTANDER'];$scope.bank='BRADESCO';activate();function activate(){$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/PaymentSlip/readFile";$scope.uploader.filters.push({name:'customFilter',fn:function fn(item,options){return this.queue.length<1;}});$scope.uploader.onSuccessItem=function(response,status){logger.logSuccess(status.message.text);};$scope.uploader.onErrorItem=function(response,status){logger.logError(status.message.text);};}$scope.setBank=function(bank){if(bank=='BBRASIL'){$scope.uploader.url="../backend/application/index.php?rota=/PaymentSlip/readFileBB";}else if(bank=='SANTANDER'){$scope.uploader.url="../backend/application/index.php?rota=/PaymentSlip/readFileSA";}else if(bank=='BRADESCO'){$scope.uploader.url="../backend/application/index.php?rota=/PaymentSlip/readFile";}void 0;};}})();(function(){'use strict';angular.module('app.table').controller('RiskAnalysisCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var tabindex;$scope.searchKeywords='';$scope.selected={};$scope.Billets=[];$scope.Sales=[];$scope.setSelected=function(){$scope.tabindex=true;$scope.showReport=false;$scope.client=$filter('filter')($scope.clients,$scope.selected.name);for(var i in $scope.client){if($scope.client[i].name==$scope.selected.name){$scope.selectedClient=angular.copy($scope.client[i]);$.post("../backend/application/index.php?rota=/loadBilletsClient",{data:$scope.selectedClient},function(result){$scope.Billets=jQuery.parseJSON(result).dataset;$scope.$apply();$.post("../backend/application/index.php?rota=/loadSalesClient",{data:$scope.selectedClient},function(result){$scope.Sales=jQuery.parseJSON(result).dataset;$scope.showReport=true;$scope.$apply();});});}}};$scope.getTotal=function(){var total=0;if($scope.Sales){if($scope.Sales.length>0){for(var i in $scope.Sales){if($scope.Sales[i].checked){total+=$scope.Sales[i].amountPaid;}}}}return total;};$scope.getTotalCancelCost=function(){var total=0;if($scope.Sales){if($scope.Sales.length>0){for(var i in $scope.Sales){if($scope.Sales[i].checked){total+=$scope.Sales[i].cancelCost;}}}}return total;};$scope.getDueValue=function(){var total=0;$scope.count=0;if($scope.Billets.length>0){var date=new Date($rootScope.formatServerDate(new Date())+'T12:00:00Z');var dueDate;for(var i=0;i<$scope.Billets.length;i++){if($scope.Billets[i].status=='E'&&$scope.Billets[i].actual_value>0){dueDate=new Date($scope.Billets[i].due_date+'T12:00:00Z');if(dueDate<date){$scope.count++;total=total+($scope.Billets[i].actual_value-$scope.Billets[i].alreadyPaid);}}}}return total;};$scope.getStatusDesc=function(status){switch(status){case'B':return"Pago";case'E':return"Em Aberto";case'A':return"Em Aberto";case'C':return"Cancelado";}};$scope.exportAnalysis=function(){var doc=new jsPDF('l','pt');doc.margin=0.5;doc.setFontSize(16);doc.text($scope.selected.name,400,20);var coluns=[{title:"Boletos - Atrasados",dataKey:"issuing_date"},{title:"Vencimento",dataKey:"due_date"},{title:"Valor",dataKey:"actual_value"},{title:"Pago",dataKey:"alreadyPaid"},{title:"Nosso Numero",dataKey:"our_number"}];var start=50;var date=new Date();date.setDate(date.getDate()-1);var data=[];for(var i in $scope.Billets){var dueDate=new Date($scope.Billets[i].due_date+'T12:00:00Z');if(dueDate<date){data.push({issuing_date:$filter('date')(new Date($scope.Billets[i].IssueDate+'T12:00:00Z'),'dd/MM/yyyy'),due_date:$filter('date')(new Date($scope.Billets[i].due_date+'T12:00:00Z'),'dd/MM/yyyy'),actual_value:$rootScope.formatNumber($scope.Billets[i].actual_value),alreadyPaid:$rootScope.formatNumber($scope.Billets[i].alreadyPaid),our_number:$scope.Billets[i].ourNumber});}}data.push({issuing_date:'Total',actual_value:$rootScope.formatNumber($scope.getDueValue())});doc.autoTable(coluns,data,{startY:start,margin:{horizontal:15}});start=doc.autoTableEndPosY()+20;var coluns=[{title:"Boletos - Gerados",dataKey:"issuing_date"},{title:"Vencimento",dataKey:"due_date"},{title:"Valor",dataKey:"actual_value"},{title:"Pago",dataKey:"alreadyPaid"},{title:"Nosso Numero",dataKey:"our_number"}];data=[];for(var i in $scope.Billets){var dueDate=new Date($scope.Billets[i].due_date+'T12:00:00Z');if(dueDate>=date){data.push({issuing_date:$filter('date')(new Date($scope.Billets[i].IssueDate+'T12:00:00Z'),'dd/MM/yyyy'),due_date:$filter('date')(new Date($scope.Billets[i].due_date+'T12:00:00Z'),'dd/MM/yyyy'),actual_value:$rootScope.formatNumber($scope.Billets[i].actual_value),alreadyPaid:$rootScope.formatNumber($scope.Billets[i].alreadyPaid),our_number:$scope.Billets[i].ourNumber});}}data.push({issuing_date:'Total',actual_value:$rootScope.formatNumber($scope.alreadyGenerated())});doc.autoTable(coluns,data,{startY:start,margin:{horizontal:15}});start=doc.autoTableEndPosY()+20;coluns=[{title:"Valor",dataKey:"name"},{title:"Totais",dataKey:"total"}];data=[];data.push({name:'Bilhetes Futuros',total:$rootScope.formatNumber($scope.getTotal())});data.push({name:'Cancelamento',total:$rootScope.formatNumber($scope.getTotalCancelCost())});data.push({name:'Total',total:$rootScope.formatNumber($scope.cancelCost())});doc.autoTable(coluns,data,{startY:start,margin:{horizontal:15}});start=doc.autoTableEndPosY()+20;coluns=[{title:"Balanço",dataKey:"total"},{title:"Status",dataKey:"status"}];data=[];data.push({total:$rootScope.formatNumber($scope.getDueValue()+$scope.alreadyGenerated()-$scope.cancelCost()),status:$scope.getStatus()});doc.autoTable(coluns,data,{startY:start,margin:{horizontal:15}});start=doc.autoTableEndPosY()+20;coluns=[{title:"Bilhetes",dataKey:"issuing_date"},{title:"CIA",dataKey:"airline"},{title:"Pax",dataKey:"pax"},{title:"Embarque",dataKey:"boardingDate"},{title:"Trecho",dataKey:"from_to"},{title:"Localizador",dataKey:"flightLocator"},{title:"Pago",dataKey:"amountPaid"},{title:"Cancelamento",dataKey:"cancelCost"}];data=[];for(var i in $scope.Sales){if($scope.Sales[i].checked){data.push({issuing_date:$filter('date')(new Date($scope.Sales[i].issueDate+'T12:00:00Z'),'dd/MM/yyyy'),airline:$scope.Sales[i].airline,pax:$scope.Sales[i].paxName,boardingDate:$filter('date')(new Date($scope.Sales[i].boardingDate+'T12:00:00Z'),'dd/MM/yyyy'),from_to:$scope.Sales[i].from+'-'+$scope.Sales[i].to,flightLocator:$scope.Sales[i].flightLocator,amountPaid:$rootScope.formatNumber($scope.Sales[i].amountPaid),cancelCost:$rootScope.formatNumber($scope.Sales[i].cancelCost)});}}data.push({amountPaid:$rootScope.formatNumber($scope.getTotal()),cancelCost:$rootScope.formatNumber($scope.getTotalCancelCost())});doc.autoTable(coluns,data,{startY:start,margin:{horizontal:15}});start=doc.autoTableEndPosY()+20;doc.save('Analise de Risco.pdf');};$scope.cancelCost=function(){var cost=0;if($scope.tabindex===true){if($scope.Sales.length>0){for(var i=0;i<$scope.Sales.length;i++){cost=cost+$scope.Sales[i].totalCost;}}}return $scope.getTotal()-$scope.getTotalCancelCost();};$scope.getClass=function(){if($scope.getDueValue()+$scope.alreadyGenerated()-$scope.cancelCost()>0)return"label label-danger";else return"label label-info";};$scope.getStatus=function(){if($scope.getDueValue()+$scope.alreadyGenerated()-$scope.cancelCost()>0)return"NEGATIVO";else return"POSITIVO";};$scope.alreadyGenerated=function(){var total=0;$scope.count2=0;if($scope.Billets.length>0){var date=new Date($rootScope.formatServerDate(new Date())+'T12:00:00Z');var dueDate;for(var i=0;i<$scope.Billets.length;i++){if($scope.Billets[i].status=='E'&&$scope.Billets[i].actual_value>0){dueDate=new Date($scope.Billets[i].due_date+'T12:00:00Z');if(dueDate>=date){$scope.count2++;total=total+($scope.Billets[i].actual_value-$scope.Billets[i].alreadyPaid);}}}}return total;};$scope.findDate=function(date){return new Date(date);};$scope.loadClients=function(){$.post("../backend/application/index.php?rota=/loadClient",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset.clients;});};init=function init(){$scope.tabindex=false;$scope.showReport=false;$scope.checkValidRoute();$('#gol').number(true,2,',','.');$('#tam').number(true,2,',','.');$('#avianca').number(true,2,',','.');$('#azul').number(true,2,',','.');$scope.loadClients();};return init();}]).controller('RiskAnalisysContactModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){void 0;$scope.selected=$scope.$parent.selected.name;$scope.main=$scope.$parent.$parent.$parent.main;$scope.session=$scope.$parent.$parent.$parent.session;var modalInstance;modalInstance=$modal.open({templateUrl:"RiskAnalisysContactModalCtrl.html",controller:'RiskAnalisysContactInstanceCtrl',resolve:{selected:function selected(){return $scope.selected;},main:function main(){return $scope.main;},session:function session(){return $scope.session;}}});modalInstance.result.then(function(){});};}]).controller('RiskAnalisysContactInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','selected','main','session',function($scope,$rootScope,$modalInstance,logger,selected,main,session){$scope.selected=selected;$scope.main=main;$scope.session=session;$.post("../backend/application/index.php?rota=/loadClientContacts",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.contacts=jQuery.parseJSON(result).dataset;$scope.$digest();});$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.table').controller('SaleCtrl',['$scope','$rootScope','$route','$filter','cfpLoadingBar','logger','$modal','$element',function($scope,$rootScope,$route,$filter,cfpLoadingBar,logger,$modal,$element){var init;$scope.saleStatus=['Pendente','Emitido','Cancelamento Solicitado','Cancelamento Efetivado','Cancelamento Pendente','Cancelamento Nao Solicitado','Remarcação Solicitado','Remarcação Confirmado','Reembolso No-show Solicitado','Reembolso No-show Confirmado','Reembolso Nao Solicitado','Reembolso Pendente','Reembolso Solicitado','Reembolso Pagante Solicitado','Reembolso CIA','Reembolso Confirmado','Reembolso Perdido'];$scope.parceiros=['JACK FOR','Loja TAM Ponta Grossa','Loja TAM Contagem','Loja TAM M','CONFIANÇA','Flytour','TAP','Rextur Advance','CNT Consolidadora','HAST Viagens','XML Viagens','Milhas Alpass','Alfa Rondonia Milhas','Outros'];$scope.searchKeywords='';$scope.saleMethods=['JACK FOR','Loja TAM Ponta Grossa','Loja TAM Contagem','Loja TAM M','CONFIANÇA','Flytour','TAP','Rextur Advance','CNT Consolidadora','HAST Viagens','XML Viagens','Milhas Alpass','Alfa Rondonia Milhas','Outros'];$scope.searchKeywordsMiles='';$scope.filteredSales=[];$scope.row='';$scope.total_cost_calculated=0;$scope.total_miles_calculated=0;$scope.noValueDealers=[22091,25112,23950,28341,21185,23386,25113,25375,25376,25377,25378,25608,27132,31517,31518,32317,33040,33041,34400,34597,34600,35228,35267,35493,35688,35770,35785,35880,37362,39489,39492,39991,40269,40432,40649,43400,44985,45895,47526,509517];$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageSales=$scope.filteredSales.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.getCommissions=function(){var total=0;for(var i in $scope.filteredSales){total+=$scope.filteredSales[i].commission;}return total;};$scope.getAllCommissions=function(){var total=0;for(var i in $scope.filteredSales){total+=$scope.filteredSales[i].comissao_vendas;}return total;};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.printSynthetic=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(20);doc.text(150,30,'Vendas Realizadas - Sintetico');var columns=[{title:"Cliente",dataKey:"client"},{title:"Telefone",dataKey:"client_phone"},{title:"Email",dataKey:"client_email"},{title:"Quantidade",dataKey:"count"},{title:"Milhas",dataKey:"miles"},{title:"Valor Total",dataKey:"value"}];var rows=[];$.post("../backend/application/index.php?rota=/loadClientsSales",{hashId:$scope.session.hashId,data:$scope.filter,filter:$scope.searchKeywords},function(result){$scope.clientSales=jQuery.parseJSON(result).dataset;for(var i=0;i<$scope.clientSales.length;i++){rows.push({client:$scope.clientSales[i].client_name,client_phone:$scope.clientSales[i].client_phone,client_email:$scope.clientSales[i].client_email,count:$scope.clientSales[i].count,miles:$rootScope.formatNumber($scope.clientSales[i].miles,0),value:$rootScope.formatNumber($scope.clientSales[i].total_cost)});}doc.autoTable(columns,rows,{styles:{overflow:'linebreak',fontSize:8},createdCell:function createdCell(cell,data){if(data.column.dataKey==='miles'){cell.styles.halign='right';}if(data.column.dataKey==='value'){cell.styles.halign='right';}}});doc.save('Relatorio_vendas_Sintetico.pdf');});};$scope.printAnalytical=function(){var doc=new jsPDF('l','pt');doc.margin=0.5;doc.setFontSize(18);doc.text(150,30,'Vendas Realizadas - Analitico');var columns=[{title:"Data",dataKey:"issueDate"},{title:"Cliente",dataKey:"client_name"},{title:"Pax",dataKey:"pax"},{title:"Loc",dataKey:"flightLocator"},{title:"Trecho",dataKey:"fromTo"},{title:"Status",dataKey:"status"},{title:"Embarque",dataKey:"boardingDate"},{title:"Cartão",dataKey:"cardNumber"},{title:"Milhas Usadas",dataKey:"miles"},{title:"M+M",dataKey:"m_m"},{title:"Desc",dataKey:"discount"},{title:"Taxa",dataKey:"tax"},{title:"Val Final",dataKey:"value"},{title:"Emissor",dataKey:"issuer"}];var rows=[];var total=0;for(var i=0;i<$scope.filteredSales.length;i++){if($scope.filteredSales[i].providerName==""){$scope.provider=$scope.filteredSales[i].sale_method;}else{$scope.provider=$scope.filteredSales[i].providerName;}total+=$scope.filteredSales[i].amountPaid;rows.push({issueDate:$filter('date')(new Date($scope.filteredSales[i].issueDate),'dd/MM/yyyy hh:mm:ss'),client_name:$scope.filteredSales[i].client,pax:$scope.filteredSales[i].paxName,flightLocator:$scope.filteredSales[i].flightLocator,fromTo:$scope.filteredSales[i].from+'-'+$scope.filteredSales[i].to+' - '+$scope.filteredSales[i].airline,status:$scope.filteredSales[i].status,boardingDate:$filter('date')(new Date($scope.filteredSales[i].boardingDate),'dd/MM/yyyy hh:mm:ss'),cardNumber:$scope.filteredSales[i].providerName,miles:$rootScope.formatNumber($scope.filteredSales[i].milesused,0),m_m:$rootScope.formatNumber($scope.filteredSales[i].miles_money),discount:$rootScope.formatNumber($scope.filteredSales[i].discount),tax:$rootScope.formatNumber($scope.filteredSales[i].tax),value:$rootScope.formatNumber($scope.filteredSales[i].amountPaid),issuer:$scope.filteredSales[i].user});}rows.push({value:$rootScope.formatNumber(total)});doc.autoTable(columns,rows,{styles:{fontSize:6,overflow:'linebreak',margin:{horizontal:4},columnWidth:'auto'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='miles'||data.column.dataKey==='value'||data.column.dataKey==='tax'||data.column.dataKey==='du_tax'||data.column.dataKey==='m_m'||data.column.dataKey==='discount'){cell.styles.halign='right';}}});doc.save('Relatorio_vendas_Analitico.pdf');$scope.filteredSales=$filter('filter')($scope.sales,$scope.searchKeywords);};$scope.backToSale=function(){$scope.tabindex=0;};$scope.getTotalOrders=function(){return Object.keys(_.groupBy($scope.sales,'externalId')).length;};$scope.setSelected=function(){$scope.selected={};if(this.sale.status!="Cancelado"){$scope.selected=angular.copy(this.sale);var totalCost_float=$scope.selected.totalCost;$scope.selected.custoProd="buscando...";$scope.selected.custoProd_display=true;$('#salemilesused').number(true,0,',','.');$('#salemilesoriginal').number(true,0,',','.');$('#saletotalcost').number(true,2,',','.');$scope.selected.amountPaid=$rootScope.formatNumber($scope.selected.amountPaid);$("#saleamountpaid").maskMoney({thousands:'.',decimal:',',precision:2});$('#saleextrafee').number(true,2,',','.');$('#salekickback').number(true,2,',','.');$('#milesMoney').number(true,2,',','.');$scope.selected.totalCost=$rootScope.formatNumber($scope.selected.totalCost);$('#totalCost').maskMoney({thousands:'.',decimal:',',precision:2});$('#custoProd').maskMoney({thousands:'.',decimal:',',precision:2});$('#taxOnlinePayment').maskMoney({thousands:'.',decimal:',',precision:2});$.post("../backend/application/index.php?rota=/loadLog",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.saleLog=jQuery.parseJSON(result).dataset;$scope.tabindex=1;$scope.airlineShowFields=$scope.selected.airline=='TAM'||$scope.selected.airline=='LATAM';$scope.selected._boardingDate=new Date($scope.selected.boardingDate);$scope.selected._landingDate=new Date($scope.selected.landingDate);if($scope.selected.paxBirthdate!=''){$scope.selected._paxBirthdate=new Date($scope.selected.paxBirthdate+'T12:00:00Z');}$scope.$apply();return true;});$.post("../backend/application/index.php?rota=/loadBilletFinancial",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.selected.billetStatus=jQuery.parseJSON(result).dataset;$scope.$digest();});$.post("../backend/application/index.php?rota=/loadInternalCards",{hashId:$scope.session.hashId},function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;});if($scope.selected.cards_id&&$scope.selected.cards_id!=""){$.post("../backend/application/index.php?rota=/loadSalesMiles",{milesUsed:0,airline:$scope.selected.airline},function(result){var flight_mile=$filter('filter')(jQuery.parseJSON(result).dataset,function(Row){return Row.cards_id==$scope.selected.cards_id;});if(flight_mile.length>0){flight_mile=flight_mile[0];$scope.selected.custoProd=parseFloat($scope.selected.milesused/1000);$scope.selected.custoProd*=parseFloat(flight_mile.cost_per_thousand);$scope.selected.custoProd+=$scope.selected.tax;$scope.selected.custoProd+=$scope.selected.duTax;$scope.selected.custoProd+=$scope.selected.baggage_price;$scope.selected.custoProd+=$scope.selected.special_seat;$scope.selected.custoProd=$rootScope.formatNumber($scope.selected.custoProd);}else{$scope.selected.custoProd="";$scope.selected.custoProd_display=false;}$scope.loadSaleHistory();});}}else{logger.logError("Esta venda foi cancelada!");}void 0;};$scope.setKickBack=function(){$scope.selected.kickback=$scope.selected.amountPaid-$scope.selected.totalCost-$scope.selected.tax-$scope.selected.duTax-$scope.selected.extraFee;};$scope.toggleFormTable=function(){if($scope.tabindex==0){return $scope.tabindex=1;}return $scope.tabindex=0;};$scope.search=function(){$scope.filteredSales=$filter('filter')($scope.sales,$scope.searchKeywords);return $scope.onFilterChange();};$scope.search_miles=function(){$scope.filtered_flight_miles=$filter('filter')($scope.flight_miles,$scope.searchKeywordsMiles);};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredSales=$filter('orderBy')($scope.sales,rowName);return $scope.onOrderChange();};$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.saleTag=function(status){switch(status){case'Pendente':return"label label-info";case'Emitido':return"label label-success";case'Remarcação Confirmado':return"label label-success";case'Reembolso Solicitado':return"label label-warning";case'Reembolso Pagante Solicitado':return"label label-warning";case'Reembolso CIA':return"label label-warning";case'Remarcação Solicitado':return"label label-warning";case'Reembolso Confirmado':return"label label-default";case'Cancelamento Solicitado':return"label label-warning";case'Cancelamento Efetivado':return"label label-danger";case'Reembolso No-show Solicitado':return"label label-default";case'Reembolso No-show Confirmado':return"label label-default";case'Reembolso Nao Solicitado':return"label label-default";case'Cancelamento Nao Solicitado':return"label label-default";case'Reembolso Perdido':return"label label-default";}};$scope.openFindAllCardsCtrl=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/find_all_cards.html",controller:'FindAllCardsInstanceCtrl',resolve:{main:function main(){return $scope.main;}}});modalInstance.result.then(function(permissions){var milesUsed=-50000;if(!permissions.sales&&!permissions.isMaster){milesUsed=1;}$scope.operation=2;$.post("../backend/application/index.php?rota=/loadSalesMiles",{milesUsed:milesUsed,airline:$scope.selected.airline,pax_quant:1,from:$scope.selected.from,to:$scope.selected.to},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset;$scope.search_miles();$scope.$digest();});});};$scope.getSaleStatus=function(sale){var date=new Date(sale.issueDate);if(sale.saleChecked==true&&date.getMonth()==new Date().getMonth()&&date.getFullYear()==new Date().getFullYear()&&date.getDate()==new Date().getDate()){return'Venda Verificada';}return sale.status;};$scope.numPerPageOpt=[10,25,50,150,2000];$scope.numPerPage=$scope.numPerPageOpt[1];$scope.currentPage=1;$scope.currentPageSales=[];$rootScope.hashId=$scope.session.hashId;$scope.saveOrder=function(){cfpLoadingBar.start();$scope.selected.amountPaid=$('#saleamountpaid').maskMoney('unmasked')[0];$scope.selected.totalCost=$('#totalCost').maskMoney('unmasked')[0];$scope.selected.boardingDate=$rootScope.formatServerDateTime($scope.selected._boardingDate);$scope.selected.landingDate=$rootScope.formatServerDateTime($scope.selected._landingDate);if($scope.selected._paxBirthdate!==""&&$scope.selected._paxBirthdate!='Invalid Date'){$scope.selected.paxBirthdate=$rootScope.formatServerDate($scope.selected._paxBirthdate);}$.post("../backend/application/index.php?rota=/saveSale",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$.post("../backend/application/index.php?rota=/loadOrder",{},function(result){$scope.sales=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.search();$scope.$apply();return $scope.select($scope.currentPage);});});$scope.toggleFormTable();};$scope.openFlightLocator=function(){$scope.selectedSale=$filter('filter')($scope.sales,'true');$scope.tabindex=2;};$scope.saveFlightLocator=function(){$.post("../backend/application/index.php?rota=/saveFlightLocator",{hashId:$scope.$parent.hashId,flightLocator:$scope.editsale.flightLocator,sales:$scope.selectedSale},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.tabindex=0;$scope.$apply();});};$scope.addRow=function(){if(this.sale.status!=='Pendente'){this.sale.checked=false;}};$scope.verifyFilter=function(){for(var i in $scope.filter.statuses){if($scope.filter.statuses[i]==true)return false;}return!$scope.filter.boardingDateFrom&&!$scope.filter.boardingDateTo&&!$scope.filter.saleDateFrom&&!$scope.filter.saleDateFrom&&!$scope.filter.providerName&&!$scope.filter.flightLocator&&!$scope.filter.providerRegistrationCode&&!$scope.filter.client&&!$scope.filter.issuer&&!$scope.filter.user&&!$scope.filter.state&&!$scope.filter.cardNumber&&!$scope.filter.minMiles&&!$scope.filter.maxMiles&&!$scope.filter.paxName&&!$scope.filter.airline&&!$scope.filter.dealer&&!$scope.filter.ticket_code&&!$scope.filter.externalid;};$scope.loadSalesByFilter=function(){if(!$scope.verifyFilter()){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSaleByFilter",{data:$scope.filter,dealer:$scope.dealerKeywords},function(result){$scope.sales=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.search();$scope.$apply();return $scope.select($scope.currentPage);});}else{void 0;}};$scope.findCard=function(){$.post("../backend/application/index.php?rota=/loadSalesMiles",{milesUsed:$scope.selected.milesused,airline:$scope.selected.airline,pax_quant:1,paxes:[{pax_name:$scope.selected.paxName,paxLastName:'',paxAgnome:''}],from:$scope.selected.from,to:$scope.selected.to},function(result){$scope.flight_miles=jQuery.parseJSON(result).dataset;$scope.search_miles();$scope.tabindex=3;$scope.$apply();});};$scope.loadSaleHistory=function(){$.post("../backend/application/index.php?rota=/loadSaleHistory",{data:{'cards_id':$scope.selected.cards_id}},function(result){var all_sale_purchases=jQuery.parseJSON(result).dataset;if(all_sale_purchases.sales)all_sale_purchases=all_sale_purchases.sales;for(var i in all_sale_purchases){if(all_sale_purchases[i].id==$scope.selected.id){$scope.sale_purchases=all_sale_purchases[i].sale_purchases;$scope.total_cost_calculated=0;$scope.total_miles_calculated=0;for(var j in $scope.sale_purchases){$scope.sale_purchases[j].cost_calculated=$scope.sale_purchases[j].miles_used/1000*$scope.sale_purchases[j].cost_per_thousand;$scope.total_cost_calculated+=$scope.sale_purchases[j].cost_calculated;$scope.total_miles_calculated+=$scope.sale_purchases[j].miles_used;}void 0;break;}}$scope.$apply();});};$scope.setCard=function(){$scope.selected.providerName=this.mile.name;$scope.selected.cards_id=this.mile.cards_id;$scope.tabindex=1;};$scope.findMiles=function(){var total=0;if($scope.filteredSales){if($scope.filteredSales.length>0){for(var i in $scope.filteredSales){total+=$scope.filteredSales[i].milesused;}}}return $rootScope.formatNumber(total,0);};$scope.findMilesOriginal=function(){var total=0;if($scope.filteredSales){if($scope.filteredSales.length>0){for(var i in $scope.filteredSales){total+=$scope.filteredSales[i].milesOriginal;}}}return $rootScope.formatNumber(total,0);};$scope.checkSale=function(){$.post("../backend/application/index.php?rota=/saveSaleCheck",{hashId:$scope.session.hashId,data:$scope.selected},function(result){logger.logSuccess('Salvo com sucesso');$.post("../backend/application/index.php?rota=/loadOrder",$scope.session,function(result){$scope.sales=jQuery.parseJSON(result).dataset;});});};$scope.saveAsDiamond=function(event){$.post("../backend/application/index.php?rota=/sale/saveAsDiamond",{hashId:$scope.session.hashId,data:$scope.selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.type_message=='success'){logger.logSuccess($scope.response.message);}else if($scope.response.type_message=='error'){logger.logError($scope.response.message);$scope.selected.is_diamond=false;}});};$scope.printCompiled=function(){var doc=new jsPDF('p','pt');doc.margin=0.5;doc.setFontSize(18);doc.text(150,30,'Vendas Realizadas');$scope.reportOrders=$filter('orderBy')($scope.sales,'client');var columns=[{title:"Data",dataKey:"issueDate"},{title:"Cliente",dataKey:"client_name"},{title:"Pax",dataKey:"pax"},{title:"Cobrado",dataKey:"value"}];var rows=[];var total=0;var lastClient='';for(var i in $scope.reportOrders){if(lastClient!=$scope.filteredSales[i].client){rows.push({value:$rootScope.formatNumber(total)});total=0;lastClient=$scope.filteredSales[i].client;}rows.push({issueDate:$filter('date')(new Date($scope.filteredSales[i].issueDate),'dd/MM/yyyy hh:mm:ss'),client_name:$scope.filteredSales[i].client,pax:$scope.filteredSales[i].paxName,value:$rootScope.formatNumber($scope.filteredSales[i].amountPaid)});total+=$scope.filteredSales[i].amountPaid;}doc.autoTable(columns,rows,{styles:{fontSize:6,overflow:'linebreak',margin:{horizontal:4},columnWidth:'auto'},createdCell:function createdCell(cell,data){if(data.column.dataKey==='value'){cell.styles.halign='right';}}});doc.save('Relatorio_vendas_Analitico.pdf');};$scope.loadDealerOrders=function(){if(!$scope.dealerKeywords._saleDateFrom){var date=new Date();$scope.dealerKeywords._saleDateFrom=$rootScope.formatServerDate(new Date(date.getFullYear(),date.getMonth(),1));$scope.dealerKeywords._saleDateFrom=$rootScope.formatServerDate(new Date());}$.post("../backend/application/index.php?rota=/loadDealerOrder",{hashId:$scope.session.hashId,data:$scope.dealerKeywords},function(result){$scope.sales=jQuery.parseJSON(result).dataset;$scope.search();$scope.tabindex=99;$scope.$apply();return $scope.select($scope.currentPage);});};$scope.changeFilds=function(){$scope.filteredFilds=$filter('filter')($scope.filters,true);};$scope.orderDown=function(rowName){rowName='-'+rowName;if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredSales=$filter('orderBy')($scope.sales,rowName);return $scope.onOrderChange();};$scope.getFild=function(sale,fild){if(fild=='from'){return sale[fild]+'-'+sale['to'];}if(!sale[fild]){return'';}if(new Date(sale[fild])=='Invalid Date'||typeof sale[fild]=="number"||sale[fild]==""||sale[fild].length<=9){if(typeof sale[fild]=="number"){return $rootScope.formatNumber(sale[fild]);}return sale[fild];}else{return $filter('date')(new Date(sale[fild]),'dd/MM/yyyy');}};$scope.listOrders=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/listOrders",{data:$scope.filter,dealer:$scope.dealerKeywords},function(result){cfpLoadingBar.complete();$scope.orders=jQuery.parseJSON(result).dataset.orders;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/orders_listing.html",controller:'OrdersListingCtrl',periods:$scope.periods,size:'lg',resolve:{orders:function orders(){return $scope.orders;}}});});};init=function init(){$scope.checkValidRoute();$scope.filter={statuses:{}};if($scope.main.id==''){return;}$scope.tabindex=0;$scope.dealerKeywords={};$scope.filters=[{name:'client',label:'Cliente',check:true},{name:'issueDate',label:'Data Emissão',check:true},{name:'airline',label:'CIA',check:true},{name:'from',label:'Trecho',check:true},{name:'commission',label:'Valor',check:true},{name:'paxName',label:'Passageiro',check:true},{name:'boardingDate',label:'Embarque',check:true},{name:'flightLocator',label:'Localizador',check:true},{name:'status',label:'Status',check:true},{name:'refundDate',label:'Reembolso',check:true},{name:'externalId',label:'Pedido',check:true},{name:'origin',label:'Origem',check:true},{name:'dealer_b2c',label:'Representante',check:true},{name:'comissao_vendas',label:'Comissao',check:true},{name:'dealer_b2c_tipo_comissao',label:'tipo comissao',check:true},{name:'cupom',label:'cupom',check:true}];$scope.changeFilds();if($scope.main.dealer||$scope.main.client){if($scope.noValueDealers.indexOf($scope.main.id)>-1){$scope.filters=[{name:'airline',label:'CIA',check:true},{name:'from',label:'Trecho',check:true},{name:'paxName',label:'Passageiro',check:true},{name:'client',label:'Cliente',check:true},{name:'issueDate',label:'Data Emissão',check:true},{name:'boardingDate',label:'Embarque',check:true},{name:'flightLocator',label:'Localizador',check:true},{name:'status',label:'Status',check:true},{name:'refundDate',label:'Reembolso',check:true}];}$scope.tabindex=99;if($scope.main.id==21141){$scope.filters.unshift({name:'company_name',label:'Razão Social',check:true});}$scope.changeFilds();var date=new Date();$scope.filter._saleDateFrom=$rootScope.formatServerDate(new Date(date.getFullYear(),date.getMonth(),1));$scope.loadSalesByFilter();}else{cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadAirport",$scope.session,function(result){$scope.airports=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadOrder",$scope.session,function(result){$scope.sales=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});}if($scope.main.isMaster||$scope.main.commercial){$.post("../backend/application/index.php?rota=/loadDealers",{hashId:$scope.session.hashId},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;});}else{$.post("../backend/application/index.php?rota=/marketing/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset.dealers;$scope.$digest();});}};return init();}]).controller('SaleModalDemoCtrl',['$scope','$rootScope','$modal','cfpLoadingBar','$log',function($scope,$rootScope,$modal,cfpLoadingBar,$log){$scope.verifyFilter=function(){for(var i in $scope.filter.statuses){if($scope.filter.statuses[i]==true)return false;}return!$scope.filter.boardingDateFrom&&!$scope.filter.boardingDateTo&&!$scope.filter.saleDateFrom&&!$scope.filter.saleDateFrom&&!$scope.filter.providerName&&!$scope.filter.flightLocator&&!$scope.filter.providerRegistrationCode&&!$scope.filter.client&&!$scope.filter.issuer&&!$scope.filter.user&&!$scope.filter.state&&!$scope.filter.cardNumber&&!$scope.filter.minMiles&&!$scope.filter.maxMiles&&!$scope.filter.paxName&&!$scope.filter.airline&&!$scope.filter.dealer&&!$scope.filter.ticket_code&&!$scope.filter.externalid;};$scope.loadSalesByFilter=function(){if(!$scope.verifyFilter()){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSaleByFilter",{data:$scope.$parent.filter,dealer:$scope.$parent.dealerKeywords},function(result){if(!$scope.$parent.dealerKeywords.name){$scope.$parent.sales=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.$parent.search();$scope.$parent.$apply();return $scope.$parent.select($scope.$parent.currentPage);}else{$scope.$parent.$parent.sales=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.$parent.$parent.search();$scope.$parent.$parent.$apply();return $scope.$parent.$parent.select($scope.$parent.$parent.currentPage);}});}else{void 0;}};$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"Sale.html",controller:'SaleModalInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.$parent.filter;},main:function main(){return $scope.main;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._boardingDateFrom=$rootScope.formatServerDate(filter.boardingDateFrom);filter._boardingDateTo=$rootScope.formatServerDate(filter.boardingDateTo);filter._saleDateFrom=$rootScope.formatServerDate(filter.saleDateFrom);filter._saleDateTo=$rootScope.formatServerDate(filter.saleDateTo);}$scope.$parent.filter=filter;$scope.loadSalesByFilter();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('SaleModalInstanceCtrl',['$scope','$rootScope','$modalInstance','filter','main',function($scope,$rootScope,$modalInstance,filter,main){$.post("../backend/application/index.php?rota=/loadState",{},function(result){$scope.states=jQuery.parseJSON(result).dataset;});$scope.main=main;$scope.saleStatus=['Cancelamento Efetivado','Cancelamento Nao Solicitado','Cancelamento Solicitado','Emitido','Reembolso Confirmado','Reembolso Nao Solicitado','Reembolso No-show Confirmado','Reembolso No-show Solicitado','Reembolso Pendente','Reembolso Solicitado','Remarcação Confirmado','Remarcação Solicitado','Reembolso Perdido'];$scope.filter=filter;$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$.post("../backend/application/index.php?rota=/loadClientsNames",{hashId:$scope.$parent.hashId},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadProfile",{hashId:$scope.$parent.hashId},function(result){$scope.profiles=jQuery.parseJSON(result).dataset;});if(($scope.main.isMaster||$scope.main.commercial)&&!$scope.main.dealer){$.post("../backend/application/index.php?rota=/loadDealers",{hashId:$scope.$parent.hashId},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;});}else{$.post("../backend/application/index.php?rota=/marketing/loadDealers",{},function(result){$scope.dealers=jQuery.parseJSON(result).dataset.dealers;$scope.$digest();});}$scope.findIssuers=function(){$.post("../backend/application/index.php?rota=/loadIssuers",{hashId:$scope.$parent.hashId,data:$scope.filter},function(result){$scope.issuers=jQuery.parseJSON(result).dataset;});};$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('ReplicateSaleCtrl',['$scope','$rootScope','$modal','$log',function($scope,$rootScope,$modal,$log){$scope.replicateSale=function(replicate){$.post("../backend/application/index.php?rota=/replicateSale",{data:$scope.$parent.selected,replicate:replicate},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});};$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"ReplicateSaleModal.html",controller:'ReplicateSaleInstanceCtrl',periods:$scope.$parent.periods,resolve:{}});modalInstance.result.then(function(replicate){$scope.replicateSale(replicate);},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('ReplicateSaleInstanceCtrl',['$scope','$rootScope','$modalInstance',function($scope,$rootScope,$modalInstance){$scope.replicate={};$.post("../backend/application/index.php?rota=/loadAirline",{},function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.replicate.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$.post("../backend/application/index.php?rota=/loadClientsNames",{},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$scope.ok=function(){$modalInstance.close($scope.replicate);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('SaleModalDealerCtrl',['$scope','$rootScope','$modal','cfpLoadingBar','$log',function($scope,$rootScope,$modal,cfpLoadingBar,$log){$scope.verifyFilter=function(){for(var i in $scope.filter.statuses){if($scope.filter.statuses[i]==true)return false;}return!$scope.filter.boardingDateFrom&&!$scope.filter.boardingDateTo&&!$scope.filter.saleDateFrom&&!$scope.filter.saleDateFrom&&!$scope.filter.providerName&&!$scope.filter.flightLocator&&!$scope.filter.providerRegistrationCode&&!$scope.filter.client&&!$scope.filter.issuer&&!$scope.filter.user&&!$scope.filter.state&&!$scope.filter.cardNumber&&!$scope.filter.minMiles&&!$scope.filter.maxMiles&&!$scope.filter.paxName&&!$scope.filter.airline&&!$scope.filter.dealer&&!$scope.filter.ticket_code&&!$scope.filter.externalid;};$scope.loadSalesByFilter=function(){if(!$scope.verifyFilter()){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadSaleByFilter",{data:$scope.$parent.filter,dealer:$scope.$parent.dealerKeywords},function(result){cfpLoadingBar.complete();void 0;$scope.$parent.$parent.sales=jQuery.parseJSON(result).dataset;$scope.$parent.$parent.search();$scope.$parent.$parent.$apply();return $scope.$parent.$parent.select($scope.$parent.$parent.currentPage);});}else{void 0;}};$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"Sale.html",controller:'SaleModalDealerInstanceCtrl',periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;},main:function main(){return $scope.main;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._boardingDateFrom=$rootScope.formatServerDate(filter.boardingDateFrom);filter._boardingDateTo=$rootScope.formatServerDate(filter.boardingDateTo);filter._saleDateFrom=$rootScope.formatServerDate(filter.saleDateFrom);filter._saleDateTo=$rootScope.formatServerDate(filter.saleDateTo);}$scope.$parent.filter=filter;$scope.loadSalesByFilter();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller('SaleModalDealerInstanceCtrl',['$scope','$rootScope','$modalInstance','filter','main',function($scope,$rootScope,$modalInstance,filter,main){$.post("../backend/application/index.php?rota=/loadState",{},function(result){$scope.states=jQuery.parseJSON(result).dataset;});$scope.main=main;$scope.saleStatus=['Pendente','Emitido','Reembolso Solicitado','Reembolso Pagante Solicitado','Reembolso CIA','Reembolso Confirmado','Cancelamento Solicitado','Cancelamento Efetivado','Remarcação Solicitado','Remarcação Confirmado','Cancelamento Pendente','Cancelamento Nao Solicitado','Reembolso Pendente','Reembolso No-show Solicitado','Reembolso No-show Confirmado','Reembolso Nao Solicitado','Reembolso Perdido'];$scope.filter=filter;$scope.searchProviders=function(){$.post("../backend/application/index.php?rota=/loadProvider",{searchKeywords:$scope.filter.providerName},function(result){$scope.providers=jQuery.parseJSON(result).dataset.providers;$scope.$digest();});};$.post("../backend/application/index.php?rota=/loadClientsNames",{hashId:$scope.$parent.hashId},function(result){$scope.clients=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadProfile",{hashId:$scope.$parent.hashId},function(result){$scope.profiles=jQuery.parseJSON(result).dataset;});if($scope.main.isMaster||$scope.main.commercial){$.post("../backend/application/index.php?rota=/loadDealers",{hashId:$scope.$parent.hashId},function(result){$scope.dealers=jQuery.parseJSON(result).dataset;});}$scope.findIssuers=function(){$.post("../backend/application/index.php?rota=/loadIssuers",{hashId:$scope.$parent.hashId,data:$scope.filter},function(result){$scope.issuers=jQuery.parseJSON(result).dataset;});};$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('OrdersListingCtrl',['$scope','$rootScope','$modalInstance','orders',function($scope,$rootScope,$modalInstance,orders){$scope.orders=orders;$scope.selected={};$scope.setSelectedOrder=function(order){$scope.selected=order;};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.table').controller('SystemNotificationCtrl',['$scope','$rootScope','$modalInstance','notification','header',function($scope,$rootScope,$modalInstance,notification,header){$scope.header=header;$scope.notification=notification;$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){'use strict';angular.module('app.marketing').controller('SystemsDataCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.searchKeywordsMiles='';$scope.filteredSystems=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageSystems=$scope.filteredSystems.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredSystems=$filter('filter')($scope.systems,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){$scope.selected=this.system;$scope.tabindex=1;};$scope.newSystem=function(){$scope.selected={};$scope.tabindex=1;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredSystems=$filter('orderBy')($scope.systems,rowName);return $scope.onOrderChange();};$scope.saveSystem=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/systems/save",{data:$scope.selected},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadModalData();$scope.$apply();$scope.tabindex=0;});};$scope.numPerPageOptMiles=[10,30,50,100];$scope.numPerPageMiles=$scope.numPerPageOptMiles[2];$scope.currentPageMiles=1;$scope.currentMiles=[];$scope.selectMiles=function(page){var end,start;start=(page-1)*$scope.numPerPageMiles;end=start+$scope.numPerPageMiles;return $scope.currentMiles=$scope.filteredflight_miles.slice(start,end);};$scope.onNumPerPageChangeMiles=function(){$scope.selectMiles(1);return $scope.currentPageMiles=1;};$scope.cancelEdit=function(){$scope.loadModalData();$scope.tabindex=0;};$scope.loadModalData=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/systems/load",{},function(result){$scope.systems=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageSystems=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.loadModalData();};return init();}]);})();;(function(){'use strict';angular.module('app.pagSeguro').controller('TransactionsCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger',function($scope,$rootScope,$filter,cfpLoadingBar,logger){var init;var original;$scope.searchKeywords='';$scope.filteredTransaction=[];$scope.row='';$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageTransactions=$scope.filteredTransaction.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredTransaction=$filter('filter')($scope.transactions,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){var original=angular.copy(this.transaction);$rootScope.$emit('openPagSeguroTransaction',{main:$scope.$parent.$parent.main,hashId:$scope.$parent.$parent.session.hashId,transaction:original});};$scope.loadTransactions=function(){$.post("../backend/application/index.php?rota=/loadPagSeguroTransactions",$scope.session,function(result){$scope.transactions=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();$scope.search();});};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredTransaction=$filter('orderBy')($scope.transactions,rowName);return $scope.onOrderChange();};$scope.findDate=function(date){if(date==''){return'';}return new Date(date);};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageTransactions=[];init=function init(){$scope.checkValidRoute();$scope.tabindex=0;cfpLoadingBar.start();$rootScope.modalOpen=false;$scope.loadTransactions();};return init();}]).controller('PagSeguroTransactionModalCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$rootScope.$on('openPagSeguroTransaction',function(event,args){event.stopPropagation();if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(_args){var modalInstance;modalInstance=$modal.open({templateUrl:"PagSeguroTransactionModalCtrl.html",controller:'PagSeguroTransactionInstanceCtrl',resolve:{args:function args(){return _args;}}});modalInstance.result.then(function(args){$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller('PagSeguroTransactionInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','args',function($scope,$rootScope,$modalInstance,logger,args){$scope.args=args;$scope.selected=$scope.args.transaction;if($scope.selected.issueDate!=''){$scope.selected._issueDate=new Date($scope.selected.issueDate);}$("#pagseguro_refund_value").maskMoney({thousands:'.',decimal:',',precision:2});$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.confirRefund=function(){$.post("../backend/application/index.php?rota=/generatePagSegurorefund",{hashId:$scope.args.hashId,data:$scope.selected},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$modalInstance.dismiss("cancel");});};$scope.confirCancel=function(){$.post("../backend/application/index.php?rota=/generatePagSeguroCancel",{hashId:$scope.args.hashId,data:$scope.selected},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);}else{logger.logError(jQuery.parseJSON(result).message.text);}$modalInstance.dismiss("cancel");});};}]);})();;(function(){'use strict';angular.module('app.purchase').controller('UserCtrl',['$scope','$rootScope','$filter','cfpLoadingBar','logger','$modal',function($scope,$rootScope,$filter,cfpLoadingBar,logger,$modal){var init;var original;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.userStatus=['Pendente','Aprovado','Bloqueado','Reprovado'];$scope.searchKeywords='';$scope.filteredUsers=[];$scope.row='';$scope.days=0;$scope.ocultar_bloqueados=true;$scope.loginsHistoric=[];$scope.loginsHistoricCrop=25;$scope.isOnlyUser=false;$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageUsers=$scope.filteredUsers.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.filtra_bloqueados=function(){$scope.users=$scope.users_historico;if($scope.ocultar_bloqueados){$scope.users=$scope.users_historico.filter(function(Row){return!Row.bloqued;});}$scope.search();};$scope.search=function(){$scope.filteredUsers=$filter('filter')($scope.users,$scope.searchKeywords);return $scope.onFilterChange();};$scope.setSelected=function(){original=angular.copy(this.user);$scope.selected=this.user;$scope.isTable=false;return void 0;};$scope.newUser=function(){$scope.selected={};$scope.selected.type='U';$scope.isTable=false;};$scope.toggleFormTable=function(){$scope.isTable=!$scope.isTable;return void 0;};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredUsers=$filter('orderBy')($scope.users,rowName);return $scope.onOrderChange();};$scope.saveUser=function(){if($scope.form_user.$valid){$scope.selected.cityfullname=$scope.selected.city+', '+$scope.selected.state;if($scope.selected.registrationCode.length<=11){if(!$rootScope.ValidaCPF($scope.selected.registrationCode)){return logger.logError('CPF Inválido');}}else{if(!$rootScope.ValidaCNPJ($scope.selected.registrationCode)){return logger.logError('CNPJ Inválido');}}cfpLoadingBar.start();if($scope.selected.bloqued){$scope.selected.status='Bloqueado';}else{$scope.selected.status='Aprovado';}if($scope.selected.dealer){$scope.selected.type='U_D';$scope.selected.partnerType='U_D';}$.post("../backend/application/index.php?rota=/saveProfile",{data:$scope.selected},function(result){$scope.users.push($scope.selected);$scope.$apply();$scope.isTable=!$scope.isTable;logger.logSuccess(jQuery.parseJSON(result).message.text);});cfpLoadingBar.complete();}};$scope.blockuser=function(user){if(!user.bloqued){user.status='Bloqueado';}else{user.status='Aprovado';}$.post("../backend/application/index.php?rota=/saveProfile",{hashId:$scope.session.hashId,data:user},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.loadProfile();});};$scope.cancelEdit=function(){$scope.loadProfile();$scope.isTable=!$scope.isTable;};window.$scope=$scope;$scope.loadLoginHistoric=function(id,openModal,savePDF){$scope.isOnlyUser=false;if(id>0){$scope.isOnlyUser=true;}$.post("../backend/application/index.php?rota=/loadHistoric",{hashId:$scope.session.hashId,data:id,type:"LOGIN",days:$scope.days},function(result){$scope.loginsHistoricOriginal=jQuery.parseJSON(result).dataset;for(var i=0;i<$scope.loginsHistoricOriginal.length;i++){var spl=$scope.loginsHistoricOriginal[i].description.split(":");if(spl[1])$scope.loginsHistoricOriginal[i].ip=spl[1];else $scope.loginsHistoricOriginal[i].ip="";$scope.loginsHistoricOriginal[i].description=spl[0].split(".")[0];}$scope.loginsHistoric=$scope.loginsHistoricOriginal.filter(function(row,index){return index<$scope.loginsHistoricCrop;});$scope.$apply();if(openModal){$modal.open({size:"lg",templateUrl:"login.html",controller:"loginModalInstanceCtrl",scope:$scope});}if(savePDF==1){$scope.printLogs(false,id);}else if(savePDF==2){$scope.printLogs(true,id);}});};$scope.printLogs=function(todos,id){var columns=[{title:"Nome",dataKey:"name"},{title:"IP",dataKey:"ip"},{title:"Data e Horário",dataKey:"date"},{title:"Descrição",dataKey:"description"}];var rows=[];if(todos){for(var i=0;i<$scope.loginsHistoricOriginal.length;i++){rows.push({name:$scope.loginsHistoricOriginal[i].userName,ip:$scope.loginsHistoricOriginal[i].ip,date:$scope.loginsHistoricOriginal[i].issue_date,description:$scope.loginsHistoricOriginal[i].description});}}else{for(var _i2=0;_i2<$scope.loginsHistoric.length;_i2++){rows.push({name:$scope.loginsHistoric[_i2].userName,ip:$scope.loginsHistoric[_i2].ip,date:$scope.loginsHistoric[_i2].issue_date,description:$scope.loginsHistoric[_i2].description});}}var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(18);doc.autoTable(columns,rows,{theme:"grid",styles:{fontSize:8,overflow:"linebreak"},startY:90,margin:{horizontal:10},bodyStyles:{valign:"top"}});var arq="Relatório_Logs";if(id>=0)arq+="_"+id+"_";if(todos)arq+="(todos)";arq+=".pdf";doc.save(arq);};$scope.loadProfile=function(){$.post("../backend/application/index.php?rota=/loadProfile",$scope.session,function(result){$scope.users=jQuery.parseJSON(result).dataset;$scope.users_historico=jQuery.parseJSON(result).dataset;$scope.filtra_bloqueados();cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.loadProfileOrdered=function(){$.post("../backend/application/index.php?rota=/loadProfile",$scope.session,function(result){$scope.users=jQuery.parseJSON(result).dataset;$scope.users_historico=jQuery.parseJSON(result).dataset;$scope.filtra_bloqueados();$scope.order('name');cfpLoadingBar.complete();return $scope.select($scope.currentPage);});};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageUsers=[];init=function init(){$scope.checkValidRoute();$scope.isTable=true;cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadState",$scope.session,function(result){$scope.states=jQuery.parseJSON(result).dataset;});$('#userstate').on('blur',function(obj,datum){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadCity",{hashId:$scope.session.hashId,state:$scope.selected.state},function(result){$scope.cities=jQuery.parseJSON(result).dataset;});cfpLoadingBar.complete();});$scope.loadProfileOrdered();};return init();}]).controller("loginModalInstanceCtrl",["$scope","$rootScope","$modalInstance",function($scope,$rootScope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]);})();;(function(){"use strict";angular.module("app").controller("WizardBilletCtrl",["$scope","$rootScope","$filter","cfpLoadingBar","logger","FileUploader","$window",'$interval',function($scope,$rootScope,$filter,cfpLoadingBar,logger,FileUploader,$window,$interval){var init;$scope.periods=["Ultimos 30 dias","Mes Corrente","Semana Corrente","Hoje"];$scope.banks=["BRADESCO","SANTANDER"];$scope.searchKeywords="";$scope.filteredBillsReceive=[];$scope.row="";$scope.ocultar_bloqueados=false;$scope.ocultar_bloqueados_disabled=false;$scope.botoes_processando=false;$scope.botao="b0";$scope.days=1;$scope.enterPressed=false;$scope.onDaysEnterKey=function(keyCode){$scope.enterPressed=false;if(keyCode==13){$scope.enterPressed=true;$scope.findYesterday();}};$scope.onDaysBlur=function(){if(!$scope.enterPressed){$scope.findYesterday();}$scope.enterPressed=false;};$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageBillsReceive=$scope.filteredBillsReceive.slice(start,end);};$scope.getStatusDesc=function(status){switch(status){case"B":return"Baixada";case"E":return"Emitida";case"A":return"Em Aberto";case"T":return"Transferencia";}};$scope.redirectToGoogle=function(link){$window.open(link,"_blank");};$scope.findColor=function(billreceive){if(billreceive.paymentType=="Boleto"){return"#98d1f5";}};$scope.billReceiveTag=function(status){switch(status){case"B":return"label label-success";case"E":return"label label-info";case"A":return"label label-warning";case"T":return"label label-default";}};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row="";};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.setSelected=function(){$scope.selected=this.billreceive;$scope.nextWizardStage();return $scope.selected;};$scope.search=function(){$scope.filteredBillsReceive=$filter("filter")($scope.billsreceive,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredBillsReceive=$filter("orderBy")($scope.billsreceive,rowName);return $scope.onOrderChange();};$scope.nextWizardStage=function(){$scope.tabindex=$scope.tabindex+1;return $scope.tabindex;};$scope.priorWizardStage=function(){$scope.tabindex=$scope.tabindex-1;return $scope.tabindex;};$scope.WizardStageProgress=function(){return($scope.tabindex+1)*34;};$scope.addRow=function(){if(this.billreceive.status=="B"){this.billreceive.checked=false;}};$scope.loadBills=function(){if($scope.wbillet_client.$valid){$scope.loadBillsReceive();$scope.nextWizardStage();}};$scope.getSumBills=function(){$scope.possibleCloseBillets=false;$scope.currentBillet={};if($scope.client){$scope.uploader.formData={hashId:$scope.session.hashId};var i=0;$scope.checkedrows=$filter("filter")($scope.billsreceive,true);$scope.wbillet=angular.copy($scope.checkedrows[0]);$scope.wbillet.description="";$scope.wbillet.alreadyPaid=0;$scope.wbillet.actual_value=0;$scope.wbillet.discount=0;if($scope.client.paymentType=="Antecipado"){for(var i in $scope.checkedrows){if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.wbillet.actual_value=$scope.wbillet.actual_value-$scope.checkedrows[i].actual_value;if($scope.checkedrows[i].paymentType=="Comum"){$scope.wbillet.alreadyPaid=$scope.wbillet.alreadyPaid-$scope.checkedrows[i].actual_value;}}else{if($scope.checkedrows[i].alreadBilled==0){$scope.wbillet.actual_value=$scope.wbillet.actual_value+$scope.checkedrows[i].actual_value;if($scope.checkedrows[i].paymentType=="Comum"){$scope.wbillet.alreadyPaid=$scope.wbillet.alreadyPaid+$scope.checkedrows[i].actual_value;}}}}}else{for(var i in $scope.checkedrows){if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.wbillet.actual_value=$scope.wbillet.actual_value-$scope.checkedrows[i].actual_value;}else{if($scope.checkedrows[i].alreadBilled==0){$scope.wbillet.actual_value=$scope.wbillet.actual_value+$scope.checkedrows[i].actual_value;if($scope.client.useCommission==true){$scope.wbillet.actual_value-=$scope.checkedrows[i].comission;$scope.wbillet.discount+=$scope.checkedrows[i].comission;}}}}}$scope.wbillet.valueFloat=$scope.wbillet.actual_value;if($scope.wbillet.actual_value<0){$scope.loadOpenedBillets();}$scope.wbillet.actual_value=$rootScope.formatNumber($scope.wbillet.actual_value);$.post("../backend/application/index.php?rota=/loadLastBillet",$scope.session,function(result){$scope.lastBillet=jQuery.parseJSON(result).dataset;if($scope.wbillet.doc_number===undefined&&$scope.wbillet.our_number===undefined){$scope.wbillet.doc_number=parseInt($scope.lastBillet.id)+1;$scope.wbillet.our_number=parseInt($scope.lastBillet.id)+1;}$scope.$apply();});$scope.nextWizardStage();$scope.wbillet.transfer=false;$("#wbilletdiscount").number(true,2,",",".");$("#wbillettax").number(true,2,",",".");$("#wbilletoriginal_value").number(true,2,",",".");$("#wbilletactual_value").maskMoney({thousands:".",decimal:",",precision:2});$scope.wbillet.due_date=new Date($scope.wbillet.due_date+"T12:00:00Z");var lastBank=window.localStorage.getItem("last-bank");if(lastBank){$scope.wbillet.bank=lastBank;}else{$scope.wbillet.bank="BRADESCO";}if($scope.client.paymentType=="Antecipado"&&!$scope.wbillet.early){$scope.wbillet.early=true;$scope.wbillet.hasBillet=false;}else{$scope.wbillet.early=false;$scope.wbillet.hasBillet=true;}if($scope.client.paymentType=="Antecipado"){for(var i in $scope.checkedrows){if($scope.checkedrows[i].paymentType=="Boleto"){$scope.wbillet.early=false;$scope.wbillet.hasBillet=true;}}}if($scope.client.workingDays){var paymentDays=0;if($scope.client.paymentDays>7){paymentDays=parseInt($scope.client.paymentDays/5)*2+$scope.client.paymentDays;$scope.wbillet.due_date=new Date();$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+paymentDays);}else{paymentDays=$scope.client.paymentDays;$scope.wbillet.due_date=new Date();if($scope.wbillet.due_date.getDay()==0){$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+1);paymentDays--;}if($scope.wbillet.due_date.getDay()==6){$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+2);paymentDays--;}for(var j=0;j<paymentDays;j++){if($scope.wbillet.due_date.getDay()==0){$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+1);}if($scope.wbillet.due_date.getDay()==6){$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+2);}$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+1);}}}else{$scope.wbillet.due_date=new Date();$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+$scope.client.paymentDays);}if($scope.wbillet.due_date.getDay()==6){$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+2);}if($scope.wbillet.due_date.getDay()==0){$scope.wbillet.due_date.setDate($scope.wbillet.due_date.getDate()+1);}}};$scope.loadOpenedBillets=function(){$.post("../backend/application/index.php?rota=/loadOpenedBillets",{data:$scope.client},function(result){$scope.openedBillets=jQuery.parseJSON(result).dataset;if($scope.openedBillets.length>0){$scope.possibleCloseBillets=true;$scope.$digest();}});};$scope.setBilletToClose=function(billet){$scope.currentBillet=billet;};$scope.openModalCloseBillets=function(){$rootScope.$emit("openCloseBillesWtihCreditModal",$scope.openedBillets);};$scope.setActual_Value=function(){$scope.wbillet.actual_value=parseFloat($scope.wbillet.original_value)+parseFloat($scope.wbillet.tax)-parseFloat($scope.wbillet.discount);};$scope.findBillets=function(){$scope.billsreceive=[];$.post("../backend/application/index.php?rota=/loadBillGenerated",{hashId:$scope.session.hashId,data:$scope.client},function(result){$scope.billsgenerated=jQuery.parseJSON(result).dataset;for(var i in $scope.billsgenerated){$scope.fillBillets($scope.billsgenerated[i]);}$scope.billetGenerated=true;$scope.search();$scope.$apply();});};$scope.fillBillets=function(bill){var alreadFill=false;bill.pax_name="";bill.flightLocator="";for(var j in $scope.billsreceive){if($scope.billsreceive[j].billet===bill.billet){alreadFill=true;if(bill.account_type=="Reembolso"||bill.account_type=="Credito"||bill.account_type=="Credito Adiantamento"){$scope.billsreceive[j].actual_value-=bill.actual_value;}else{if($scope.billsreceive[j].alreadBilled==0){$scope.billsreceive[j].actual_value+=bill.actual_value;}}}}if(!alreadFill){if(bill.account_type=="Reembolso"||bill.account_type=="Credito"||bill.account_type=="Credito Adiantamento"){bill.actual_value=bill.actual_value*-1;}bill.account_type="BORDERO";$scope.billsreceive.push(bill);}};$scope.addDivision=function(){$scope.billetsDivision.push({actualValue:0,dueDate:$scope.wbillet.due_date,name:$scope.wbillet.our_number});};$scope.removeDivision=function(){$scope.billetsDivision.pop();};$scope.getSumBillsReceive=function(){var value=0;if($scope.billsreceive){if($scope.billsreceive.length>0){$scope.checkedrows=$filter("filter")($scope.billsreceive,true);for(var i in $scope.checkedrows){if($scope.checkedrows[i].alreadBilled==0){if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){value-=$scope.checkedrows[i].actual_value;}else{value+=$scope.checkedrows[i].actual_value;}}}}}return $rootScope.formatNumber(value);};$scope.markAll=function(){for(var i in $scope.billsreceive){$scope.billsreceive[i].checked=true;}};$scope.markYesterday=function(){var dias=1;if(new Date().getDay()==1){dias=3;}var yesterday1=new Date(new Date().setDate(new Date().getDate()-dias));var yesterday2=new Date(new Date().setDate(new Date().getDate()-1));yesterday1.setHours(0,0,1,0);yesterday2.setHours(23,59,59,999);for(var i in $scope.billsreceive){$scope.billsreceive[i].checked=false;var venda=new Date($scope.billsreceive[i].issuing_date.replaceAll("-","/"));venda.setHours(3,0,0,0);if(venda>=yesterday1&&venda<=yesterday2){$scope.billsreceive[i].checked=true;}}};$scope.unMarkAll=function(){for(var i in $scope.billsreceive){$scope.billsreceive[i].checked=false;}};$scope.loadBillsReceive=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadBillsReceive",{data:$scope.filter},function(result){$scope.billsreceive=jQuery.parseJSON(result).dataset;$scope.search();cfpLoadingBar.complete();$.post("../backend/application/index.php?rota=/loadClientsByFilter",{data:$scope.filter},function(result){$scope.client=jQuery.parseJSON(result).dataset;$scope.client=$scope.client[0];$scope.$digest();});return $scope.select($scope.currentPage);});};$scope.getDate=function(days){var date=new Date();date.setDate(date.getDate()+days);if(date.getDay()==6){date.setDate(date.getDate()+2);}if(date.getDay()==0){date.setDate(date.getDate()+1);}return date;};$scope.saveBillet=function(){$scope.wizardBillet=true;cfpLoadingBar.start();if($scope.wbillet.bank=="SANTANDER"){$scope.saveEmail=true;$scope.billet.sendDate=new Date();$scope.billet.sendDate.setDate($scope.billet.sendDate.getDate()+1);}window.localStorage.setItem("last-bank",$scope.wbillet.bank);for(var i in $scope.billreceive){$scope.billreceive.due_date=$scope.wbillet.due_date;}for(var j in $scope.billetsDivision){$scope.billetsDivision[j]._dueDate=$rootScope.formatServerDate($scope.billetsDivision[j].dueDate);}$scope.wbillet.actual_value=$("#wbilletactual_value").maskMoney("unmasked")[0];$scope.wbillet.due_date=$rootScope.formatServerDate($scope.wbillet.due_date);if($scope.wbillet.billingPartner){$scope.client=$filter("filter")($scope.clients,$scope.wbillet.billingPartner);if($scope.client.length==1){$scope.client=$scope.client[0];}else{if($scope.client.length>1){for(var i in $scope.client){if($scope.client[i].name=$scope.wbillet.billingPartner){$scope.client=$scope.client[i];break;}}}}}if($scope.billetGenerated){$.post("../backend/application/index.php?rota=/loadBillsBillets",{hashId:$scope.session.hashId,checkedrows:$scope.checkedrows},function(result){$scope.billsreceive=jQuery.parseJSON(result).dataset;$.post("../backend/application/index.php?rota=/saveBillet",{hashId:$scope.session.hashId,checkedrows:$scope.billsreceive,wbillet:$scope.wbillet,billetsDivision:$scope.billetsDivision,billetCredit:$scope.currentBillet},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.fillEmailContent();});});}else{$.post("../backend/application/index.php?rota=/saveBillet",{hashId:$scope.session.hashId,checkedrows:$scope.checkedrows,wbillet:$scope.wbillet,billetsDivision:$scope.billetsDivision,billetCredit:$scope.currentBillet},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);cfpLoadingBar.complete();$scope.fillEmailContent();});}$scope.carrega_botao();};$scope.saveEmailBillet=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}$scope.billet._sendDate=$rootScope.formatServerDate($scope.billet.sendDate);$.post("../backend/application/index.php?rota=/saveEmail",{hashId:$scope.session.hashId,data:$scope.billet,attachment:file,type:"FINANCEIRO",client:$scope.wbillet},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$window.location.href="#/billsReceive/billet";}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.fillEmailModel2=function(){$scope.billet.emailContent="<br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'>"+"<tbody><tr bgcolor='#5D7B9D'><td colspan='11' bgcolor='#5D7B9D'><font color='#ffffff'><b>Dados</b></font></td></tr>"+"<tr><td>Data</td><td>Passageiro</td><td>Localizador</td><td>Trecho</td><td>CIA</td><td>Valor</td><td>Milhas</td><td>Emissor</td><td>Cliente</td><td>Obs</td>";if($scope.billetGenerated){$scope.billet.emailContent+="<td>Bordero</td>";}$scope.billet.emailContent+="</tr>";$scope.checkedrows=$filter("filter")($scope.billsreceive,true);for(var i=0;$scope.checkedrows.length>i;i++){$scope.billet.emailContent+="<tr><td>"+$filter("date")($scope.checkedrows[i].issuing_date,"dd/MM/yyyy")+"</td><td>";if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.billet.emailContent+=$scope.checkedrows[i].description+"</td><td>";}else{$scope.billet.emailContent+=$scope.checkedrows[i].pax_name+"</td><td>";}$scope.billet.emailContent+=$scope.checkedrows[i].flightLocator+"</td><td>"+$scope.checkedrows[i].from+"-"+$scope.checkedrows[i].to+"</td><td>"+$scope.checkedrows[i].airline+"</td>";if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.billet.emailContent+="<td><font color='red'>"+$rootScope.formatNumber(-$scope.checkedrows[i].actual_value)+"</font></td><td>"+$scope.checkedrows[i].miles+"</td>";}else{$scope.billet.emailContent+="<td>"+$rootScope.formatNumber($scope.checkedrows[i].actual_value)+"</td><td>"+$scope.checkedrows[i].miles+"</td>";}$scope.billet.emailContent+="<td>"+$scope.checkedrows[i].issuing+"</td><td>"+$scope.checkedrows[i].client+"</td><td>"+$scope.checkedrows[i].SaleDescription+"</td>";if($scope.billetGenerated){if($scope.checkedrows[i].status=="E"){$scope.billet.emailContent+="<td>"+$scope.checkedrows[i].billet+"<td>";}else{$scope.billet.emailContent+="<td><td>";}}$scope.billet.emailContent+="</tr>";}$scope.billet.emailContent+="<tr><td></td><td></td><td></td><td></td><td><b>Total:</b></td><td><b>"+$rootScope.formatNumber($scope.wbillet.actual_value)+"</b></td><td></td><td></td><td></td><td></td></tr>";var due_date="</tbody></table><br><br><b>Vencimento: "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+" </b><br><br><b>Numero boleto: "+$scope.wbillet.our_number+"</b>";if($scope.billetsDivision.length>0){due_date="";for(var j in $scope.billetsDivision){due_date=due_date+"</tbody></table><br><br><b>Vencimento: "+$filter("date")($scope.billetsDivision[j].dueDate,"dd/MM/yyyy")+" </b><br><br><b>Numero boleto: "+$scope.billetsDivision[j].name+"</b>";}}$scope.billet.subject="BOLETO - ONE MILHAS - VENCIMENTO "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+"  - "+$scope.wbillet.our_number;if($scope.wbillet.early){$scope.billet.emailContent="<br>Prezados,<br><br>Seguem emissões que já estão pagas.<br><br>Obrigado pela parceria.<br>"+$scope.billet.emailContent;$scope.billet.subject="BORDERO DE EMISSÃO ONE MILHAS  - "+$scope.wbillet.our_number;due_date="</tbody></table><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}else{$scope.billet.emailContent="<br>Prezado(a), seguem emissões. Obrigado!"+$scope.billet.emailContent;$scope.billet.subject="BOLETO - ONE MILHAS - VENCIMENTO "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+"  - "+$scope.wbillet.our_number;due_date="</tbody></table><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}if($scope.wbillet.actual_value<0){$scope.billet.subject="BORDERO DE REEMBOLSO ONE MILHAS - "+$scope.wbillet.our_number;due_date="</tbody></table><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}if($scope.wbillet.discount>0){due_date+="<br><br><b>Descontos: "+$rootScope.formatNumber($scope.wbillet.discount)+"</b>";}$scope.billet.emailContent+=due_date;$scope.$apply();};$scope.fillEmailContent=function(){if(isNaN($scope.wbillet.actual_value)){$scope.wbillet.actual_value=$("#wbilletactual_value").maskMoney("unmasked")[0];}if($scope.client.finnancialEmail){if($scope.client.finnancialEmail!=undefined&&$scope.client.finnancialEmail!=null&&$scope.client.finnancialEmail!=""){$scope.billet.emailpartner=$scope.client.finnancialEmail;}else{$scope.billet.emailpartner=$scope.client.email;}}else{$scope.billet.emailpartner=$scope.client.email;}$scope.billet.mailcc="";$scope.billet.client=$scope.client.name;$scope.billet.emailContent="<br><br><table width='95%' align='center' border='1' style='text-align: center; border-collapse: collapse'>"+"<tbody><tr bgcolor='#5D7B9D'><td colspan='10' bgcolor='#5D7B9D'><font color='#ffffff'><b>Dados</b></font></td></tr>"+"<tr><td>Data</td><td>Passageiro</td><td>Localizador</td><td>Trecho</td><td>CIA</td><td>Valor</td><td>Já Pago</td><td>Milhas</td><td>Emissor</td><td>Cliente</td>";$scope.billet.emailContent+="</tr>";$scope.checkedrows=$filter("filter")($scope.billsreceive,true);for(var i=0;$scope.checkedrows.length>i;i++){$scope.billet.emailContent+="<tr><td>"+$filter("date")($scope.checkedrows[i].issuing_date,"dd/MM/yyyy")+"</td><td>";if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.billet.emailContent+=$scope.checkedrows[i].description+"</td><td>";}else{$scope.billet.emailContent+=$scope.checkedrows[i].pax_name+"</td><td>";}$scope.billet.emailContent+=$scope.checkedrows[i].flightLocator+"</td><td>"+$scope.checkedrows[i].from+"-"+$scope.checkedrows[i].to+"</td><td>"+$scope.checkedrows[i].airline+"</td>";if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){$scope.billet.emailContent+="<td><font color='red'>"+$rootScope.formatNumber(-$scope.checkedrows[i].actual_value)+"</font></td><td>"+$rootScope.formatNumber($scope.checkedrows[i].alreadBilled)+"</td><td>"+$scope.checkedrows[i].miles+"</td>";}else{$scope.billet.emailContent+="<td>"+$rootScope.formatNumber($scope.checkedrows[i].actual_value)+"</td><td>"+$rootScope.formatNumber($scope.checkedrows[i].alreadBilled)+"</td><td>"+$scope.checkedrows[i].miles+"</td>";}$scope.billet.emailContent+="<td>"+$scope.checkedrows[i].issuing+"</td><td>"+$scope.checkedrows[i].client+"</td>";$scope.billet.emailContent+="</tr>";}$scope.billet.emailContent+="<tr><td></td><td></td><td></td><td></td><td><b>Total:</b></td><td><b>"+$rootScope.formatNumber($scope.wbillet.actual_value)+"</b></td><td></td><td></td><td></td><td></td></tr>";var due_date="</tbody></table><br><br><b>Vencimento: "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+" </b><br><br><b>Numero boleto: "+$scope.wbillet.our_number+"</b>";if($scope.billetsDivision.length>0){due_date="</tbody></table><br><br>";for(var j in $scope.billetsDivision){due_date=due_date+"<br><br><b>Vencimento: "+$filter("date")($scope.billetsDivision[j].dueDate,"dd/MM/yyyy")+" </b><br><b>Valor: "+$rootScope.formatNumber($scope.billetsDivision[j].actualValue)+"</b><br><b>Numero boleto: "+$scope.billetsDivision[j].name+"</b>";}}$scope.billet.subject="BOLETO - ONE MILHAS - VENCIMENTO "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+"  - "+$scope.wbillet.our_number;if($scope.wbillet.early){$scope.billet.emailContent="<br>Prezados,<br><br>Seguem emissões que já estão pagas.<br><br>Obrigado pela parceria.<br>"+$scope.billet.emailContent;$scope.billet.subject="BORDERO DE EMISSÃO ONE MILHAS - "+$scope.wbillet.our_number;due_date="</tbody></table><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}else{$scope.billet.subject="BOLETO - ONE MILHAS - VENCIMENTO "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+"  - "+$scope.wbillet.our_number;$scope.billet.emailContent="<br>Prezado(a), seguem emissões. Obrigado!"+$scope.billet.emailContent;due_date="</tbody></table><br><br><b>Vencimento: "+$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")+" </b><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}if($scope.wbillet.actual_value<0){$scope.billet.subject="BORDERO DE REEMBOLSO ONE MILHAS - "+$scope.wbillet.our_number;due_date="</tbody></table><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}if($scope.wbillet.alreadyPaid>0){due_date=due_date+"<br><br><b>Já Pago: "+$rootScope.formatNumber($scope.wbillet.alreadyPaid)+"</b>";if($scope.wbillet.actual_value-$scope.wbillet.alreadyPaid>0){due_date=due_date+"<br><b>Restando: R$ "+$rootScope.formatNumber($scope.wbillet.actual_value-$scope.wbillet.alreadyPaid)+"</b>";}}if($scope.client.billingPeriod!="Diario"&&$scope.client.billingPeriod!=""&&$scope.client.billingPeriod&&!$scope.billetGenerated){$scope.billet.subject="BORDERO DE EMISSÃO ONE MILHAS - "+$scope.wbillet.our_number;due_date="</tbody></table><br><br><b>Numero Borderô: "+$scope.wbillet.our_number+"</b>";}if($scope.wbillet.discount>0){due_date+="<br><br><b>Descontos: "+$rootScope.formatNumber($scope.wbillet.discount)+"</b>";}$scope.billet.emailContent+=due_date;$scope.tabindex=3;$scope.$apply();};$scope.mailOrder=function(){var file=[];for(var j in $scope.uploader.queue){file.push($scope.uploader.queue[j].file.name);}var raw_content=$scope.print(false);$.post("../backend/application/index.php?rota=/mailOrder",{data:$scope.billet,attachment:file,type:"FINANCEIRO",client:$scope.client,raw_content:raw_content,emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=="S"){logger.logSuccess(jQuery.parseJSON(result).message.text);$window.location.href="#/billsReceive/billet";}else{logger.logError(jQuery.parseJSON(result).message.text);}});};$scope.setClient=function(){$scope.filter.clientName=this.client.name;$scope.loadBills();};$scope.printBills=function(){var doc=new jsPDF("l","pt");doc.margin=0.5;doc.setFontSize(18);$scope.reportBillsReceive=$filter("filter")($scope.billsreceive,true);doc.text(150,30,"Resumo Debitos - "+$scope.reportBillsReceive[0].client);var columns=[{title:"Data Venda",dataKey:"issuing_date"},{title:"Tipo Conta",dataKey:"account_type"},{title:"PAX",dataKey:"pax"},{title:"Localizador",dataKey:"flightLocator"},{title:"Valor",dataKey:"value"},{title:"Já pago",dataKey:"alreadBilled"},{title:"Taxa",dataKey:"tax"},{title:"Milhas",dataKey:"miles_tax"},{title:"due_date",dataKey:"due_date"}];var rows=[];var total=0;for(var i=0;i<$scope.reportBillsReceive.length;i++){if($scope.checkedrows[i].account_type=="Reembolso"||$scope.checkedrows[i].account_type=="Credito"||$scope.checkedrows[i].account_type=="Credito Adiantamento"){total-=$scope.reportBillsReceive[i].actual_value;rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy HH:mm:ss"),account_type:$scope.reportBillsReceive[i].account_type,pax:$scope.reportBillsReceive[i].description,flightLocator:$scope.reportBillsReceive[i].flightLocator,value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),alreadBilled:$rootScope.formatNumber($scope.reportBillsReceive[i].alreadBilled),tax:$scope.reportBillsReceive[i].tax,miles_tax:$scope.reportBillsReceive[i].miles_tax,due_date:$filter("date")($scope.reportBillsReceive[i].due_date,"dd/MM/yyyy")});}else{if($scope.reportBillsReceive[i].alreadBilled==0){total+=$scope.reportBillsReceive[i].actual_value;}rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy HH:mm:ss"),account_type:$scope.reportBillsReceive[i].account_type,pax:$scope.reportBillsReceive[i].pax_name,flightLocator:$scope.reportBillsReceive[i].flightLocator,value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),alreadBilled:$rootScope.formatNumber($scope.reportBillsReceive[i].alreadBilled),tax:$scope.reportBillsReceive[i].tax,miles_tax:$scope.reportBillsReceive[i].miles_tax,due_date:$filter("date")($scope.reportBillsReceive[i].due_date,"dd/MM/yyyy")});}}rows.push({flightLocator:"Total:",value:$rootScope.formatNumber(total)});if($scope.wbillet.discount>0){rows.push({pax_name:"Descontos:",actual_value:$rootScope.formatNumber($scope.wbillet.discount)});}doc.autoTable(columns,rows,{styles:{fontSize:8,overflow:"linebreak"},createdCell:function createdCell(cell,data){if(data.column.dataKey==="value"){cell.styles.halign="right";}}});doc.save("Resumo Debitos "+$scope.reportBillsReceive[0].client+".pdf");};$scope.filterList=function(item){return item.paymentType!="Antecipado";};$scope.filterListPreview=function(item){return item.paymentType=="Antecipado";};$scope.printReportModel=function(isSave){var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(16);doc.setTextColor(0);$scope.reportBillsReceive=$filter("filter")($scope.billsreceive,true);doc.setFontStyle("bold");doc.text("IDEAL VIAGENS",200,50);var start=60;doc.autoTable([{title:"",dataKey:"text"}],[{text:"PAULO RDRIGUES DOS SANTOS JUNIOR MMS VIAGENS"},{text:"CNPJ: 20.966.716/0001-55"},{text:"Rua: Jurua, 46 Conj. 301 Bairro: Graça"},{text:"CEP: 31.140-020 BELO HORIZONTE / MG"},{text:"Tel: 31.3017-0304  E-mail: "}],{theme:"plain",styles:{fontSize:8,overflow:"linebreak"},startY:start,margin:{horizontal:10},bodyStyles:{valign:"top"}});start=doc.autoTableEndPosY()+20;doc.autoTable([{title:"Nº Borderô",dataKey:"ourNumber"},{title:"Valor da Fatura / Borderô",dataKey:"actual_value"},{title:"Data Emissão",dataKey:"issue_date"},{title:"Data Vencimento",dataKey:"due_date"}],[{ourNumber:$scope.wbillet.our_number,actual_value:"R$ "+$rootScope.formatNumber($scope.wbillet.actual_value),issue_date:$filter("date")(new Date(),"dd/MM/yyyy"),text:$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy")}],{theme:"plain",styles:{fontSize:8,overflow:"linebreak"},startY:start,margin:{horizontal:10},bodyStyles:{valign:"top"}});start=doc.autoTableEndPosY()+10;doc.autoTable([{title:"",dataKey:"text"}],[{text:"Sacado: "+$scope.client.company_name},{text:"Endereço: "+$scope.client.adress+" "+$scope.client.adressNumber+" "+$scope.client.adressComplement+" "+$scope.client.zipCode+" "+$scope.client.adressDistrict},{text:"Tel: "+$scope.client.phoneNumber},{text:"CNPJ: "+$scope.client.registrationCode},{text:""},{text:"Banco: 237- Bradesco - Agência: 3420 Conta Corrente: 4879-8"}],{theme:"plain",styles:{fontSize:8,overflow:"linebreak"},startY:start,margin:{horizontal:10},bodyStyles:{valign:"top"}});var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"TRECHO",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"SOLICITANTE",dataKey:"issuing"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"}];var rows=[];var total=0;for(var i=0;i<$scope.reportBillsReceive.length;i++){if($scope.billetGenerated){if($scope.reportBillsReceive[i].status=="E"){if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,issuing:$scope.reportBillsReceive[i].issuing});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),issuing:$scope.reportBillsReceive[i].issuing});}}else{if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client});}}}else{if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,issuing:$scope.reportBillsReceive[i].issuing});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),issuing:$scope.reportBillsReceive[i].issuing});}}}rows.push({});rows.push({pax_name:"Total:",actual_value:$rootScope.formatNumber(total)});start=doc.autoTableEndPosY()+20;doc.autoTable(columns,rows,{theme:"plain",styles:{fontSize:8,overflow:"linebreak"},startY:start,margin:{horizontal:10},bodyStyles:{valign:"top"},createdCell:function createdCell(cell,data){if(data.column.dataKey==="actual_value"){cell.styles.halign="right";}}});if(isSave)doc.save("BORDERO "+$scope.billsreceive[0].client+".pdf");return doc;};$scope.imprimeTudo=function(){var ids=[];var inserido=false;ids.push(0);for(var i=0;i<$scope.clientsToReceive.length;i++){if($scope.clientsToReceive[i].acessado_hoje){ids.push($scope.clientsToReceive[i].id);}}$scope.filter={clientName:" "};$.post("../backend/application/index.php?rota=/loadClientsByFilter",{data:$scope.filter,impressao_ids:ids},function(result){$scope.client=jQuery.parseJSON(result).dataset;var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(18);for(var j=0;j<$scope.client.length;j++){if($scope.client[j].raw_email!=""){for(var k=0;k<$scope.client[j].raw_email.length;k++){var resp=JSON.parse($scope.client[j].raw_email[k]);var columns=resp[0];var rows=resp[1];doc.autoTable(columns,rows,{theme:"grid",styles:{fontSize:8,overflow:"linebreak"},startY:90,margin:{horizontal:10},bodyStyles:{valign:"top"},createdCell:function createdCell(cell,data){if(data.column.dataKey==="actual_value"){cell.styles.halign="right";}}});doc.addPage();inserido=true;}}}if(inserido)doc.save("Relatorio.pdf");});};$scope.printFill=function(){$scope.reportBillsReceive=$filter("filter")($scope.billsreceive,true);if($scope.billetGenerated){var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"},{title:"Já Pago",dataKey:"alreadBilled"},{title:"Taxa",dataKey:"miles_tax"},{title:"Milhas",dataKey:"miles"},{title:"EMISSOR",dataKey:"issuing"},{title:"CLIENTE",dataKey:"client"},{title:"BORDERO",dataKey:"billet"}];}else{var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"},{title:"Já Pago",dataKey:"alreadBilled"},{title:"Taxa",dataKey:"miles_tax"},{title:"Milhas",dataKey:"miles"},{title:"EMISSOR",dataKey:"issuing"},{title:"CLIENTE",dataKey:"client"}];}var rows=[];for(var i=0;i<$scope.reportBillsReceive.length;i++){if($scope.billetGenerated){if($scope.reportBillsReceive[i].status=="E"){if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,alreadBilled:$scope.reportBillsReceive[i].alreadBilled,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,billet:$scope.reportBillsReceive[i].billet});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),alreadBilled:$scope.reportBillsReceive[i].alreadBilled,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,billet:$scope.reportBillsReceive[i].billet});}}else{if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,alreadBilled:$scope.reportBillsReceive[i].alreadBilled,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,billet:""});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),alreadBilled:$scope.reportBillsReceive[i].alreadBilled,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,billet:""});}}}else{if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,alreadBilled:$scope.reportBillsReceive[i].alreadBilled,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),alreadBilled:$scope.reportBillsReceive[i].alreadBilled,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client});}}}rows.push({});rows.push({});rows.push({pax_name:"Total:",actual_value:$rootScope.formatNumber($scope.wbillet.actual_value)});if($scope.wbillet.alreadyPaid>0){rows.push({pax_name:"Já Pago:",actual_value:$rootScope.formatNumber($scope.wbillet.alreadyPaid)});if($scope.wbillet.actual_value-$scope.wbillet.alreadyPaid>0){rows.push({pax_name:"Restando:",actual_value:$rootScope.formatNumber($scope.wbillet.actual_value-$scope.wbillet.alreadyPaid)});}}if($scope.wbillet.discount>0){rows.push({pax_name:"Descontos:",actual_value:$rootScope.formatNumber($scope.wbillet.discount)});}rows.push({});if($scope.billetsDivision.length>0){for(var j in $scope.billetsDivision){rows.push({issuing_date:"Vencimento:",flightLocator:$filter("date")($scope.billetsDivision[j].dueDate,"dd/MM/yyyy"),pax_name:"Boleto Nº "+$scope.billetsDivision[j].name,actual_value:$rootScope.formatNumber($scope.billetsDivision[j].actualValue)});}}else{rows.push({issuing_date:"Vencimento:",flightLocator:$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy"),pax_name:"Boleto Nº "+$scope.wbillet.our_number});}return[columns,rows];};$scope.print=function(isSave){var resp=$scope.printFill();if(isSave){var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(18);var columns=resp[0];var rows=resp[1];doc.autoTable(columns,rows,{theme:"grid",styles:{fontSize:8,overflow:"linebreak"},startY:90,margin:{horizontal:10},bodyStyles:{valign:"top"},createdCell:function createdCell(cell,data){if(data.column.dataKey==="actual_value"){cell.styles.halign="right";}}});doc.save("BORDERO "+$scope.billsreceive[0].client+".pdf");}return JSON.stringify(resp);};$scope.toDataUrl=function(url,callback){var xhr=new XMLHttpRequest();xhr.responseType="blob";xhr.onload=function(){var reader=new FileReader();reader.onloadend=function(){callback(reader.result);};reader.readAsDataURL(xhr.response);};xhr.open("GET",url);xhr.send();};$scope.printModel2=function(isSave){var doc=new jsPDF("p","pt");doc.margin=0.5;doc.setFontSize(18);$scope.reportBillsReceive=$filter("filter")($scope.billsreceive,true);if($scope.billetGenerated){var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"},{title:"Taxa",dataKey:"miles_tax"},{title:"Milhas",dataKey:"miles"},{title:"EMISSOR",dataKey:"issuing"},{title:"CLIENTE",dataKey:"client"},{title:"OBS",dataKey:"comments"},{title:"BORDERO",dataKey:"billet"}];}else{var columns=[{title:"DATA",dataKey:"issuing_date"},{title:"LOC",dataKey:"flightLocator"},{title:"ORIGEM",dataKey:"from"},{title:"CIA",dataKey:"airline"},{title:"PAX",dataKey:"pax_name"},{title:"VALOR",dataKey:"actual_value"},{title:"Taxa",dataKey:"miles_tax"},{title:"Milhas",dataKey:"miles"},{title:"EMISSOR",dataKey:"issuing"},{title:"CLIENTE",dataKey:"client"},{title:"OBS",dataKey:"comments"}];}var rows=[];for(var i=0;i<$scope.reportBillsReceive.length;i++){if($scope.billetGenerated){if($scope.reportBillsReceive[i].status=="E"){if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,comments:$scope.reportBillsReceive[i].SaleDescription,billet:$scope.reportBillsReceive[i].billet});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,comments:$scope.reportBillsReceive[i].SaleDescription,billet:$scope.reportBillsReceive[i].billet});}}else{if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,comments:$scope.reportBillsReceive[i].SaleDescription,billet:""});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,comments:$scope.reportBillsReceive[i].SaleDescription,billet:""});}}}else{if($scope.reportBillsReceive[i].account_type=="Reembolso"||$scope.reportBillsReceive[i].account_type=="Credito"||$scope.reportBillsReceive[i].account_type=="Credito Adiantamento"){rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].account_type,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].description,actual_value:$scope.reportBillsReceive[i].actual_value*-1,miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,comments:$scope.reportBillsReceive[i].SaleDescription});}else{rows.push({issuing_date:$filter("date")($scope.reportBillsReceive[i].issuing_date,"dd/MM/yyyy"),flightLocator:$scope.reportBillsReceive[i].flightLocator,from:$scope.reportBillsReceive[i].from+"-"+$scope.reportBillsReceive[i].to,airline:$scope.reportBillsReceive[i].airline,pax_name:$scope.reportBillsReceive[i].pax_name,actual_value:$rootScope.formatNumber($scope.reportBillsReceive[i].actual_value),miles_tax:$scope.reportBillsReceive[i].miles_tax,miles:$scope.reportBillsReceive[i].miles,issuing:$scope.reportBillsReceive[i].issuing,client:$scope.reportBillsReceive[i].client,comments:$scope.reportBillsReceive[i].SaleDescription});}}}rows.push({});rows.push({});rows.push({});rows.push({pax_name:"Total:",actual_value:$rootScope.formatNumber($scope.wbillet.actual_value)});if($scope.wbillet.discount>0){rows.push({pax_name:"Descontos:",actual_value:$rootScope.formatNumber($scope.wbillet.discount)});}rows.push({issuing_date:"Vencimento:",flightLocator:$filter("date")($scope.wbillet.due_date,"dd/MM/yyyy"),pax_name:"Boleto Nº "+$scope.wbillet.our_number});doc.autoTable(columns,rows,{theme:"grid",styles:{fontSize:8,overflow:"linebreak"},startY:90,margin:{horizontal:10},bodyStyles:{valign:"top"},createdCell:function createdCell(cell,data){if(data.column.dataKey==="actual_value"){cell.styles.halign="right";}}});if(isSave)doc.save("BORDERO "+$scope.billsreceive[0].client+".pdf");return doc;};$scope.numPerPageOpt=[10,30,50,100];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageBillsReceive=[];$rootScope.hashId=$scope.session.hashId;$scope.findYesterday=function(){$scope.botao="b0";cfpLoadingBar.start();$scope.ocultar_bloqueados_disabled=true;$scope.botoes_processando=true;$.post("../backend/application/index.php?rota=/loadYesterdayBills",{sesion:$scope.session,days:$scope.days,apply_calc:false},function(result){$scope.clientsToReceive=jQuery.parseJSON(result).dataset;$scope.clientsToReceive_historico=jQuery.parseJSON(result).dataset;$scope.$apply();$.post("../backend/application/index.php?rota=/loadYesterdayBills",{sesion:$scope.session,days:$scope.days,apply_calc:true},function(result){$scope.clientsToReceive=jQuery.parseJSON(result).dataset;$scope.clientsToReceive_historico=jQuery.parseJSON(result).dataset;$scope.ocultar_bloqueados_disabled=false;$scope.botoes_processando=false;cfpLoadingBar.complete();$scope.$apply();});});};$scope.findBilling=function(){$.post("../backend/application/index.php?rota=/checkClientsDeadLine",{hashId:$scope.session.hashId},function(result){$scope.clientsDeadLine=jQuery.parseJSON(result).dataset;$scope.$digest();});};$scope.findTodos=function(){$scope.botao="b1";$scope.findAll();};$scope.findBilhetes=function(){$scope.botao="b2";$scope.findAll();};$scope.findOutros=function(){$scope.botao="b3";$scope.findAll();};$scope.carrega_botao=function(){switch($scope.botao){case"b0":$scope.findYesterday();break;case"b1":case"b2":case"b3":$scope.findAll();break;}};$scope.findAll=function(){cfpLoadingBar.start();$scope.ocultar_bloqueados_disabled=true;$scope.botoes_processando=true;$.post("../backend/application/index.php?rota=/loadClientToReceive",{sesion:$scope.session,apply_calc:false,botao:$scope.botao},function(result){$scope.clientsToReceive=jQuery.parseJSON(result).dataset;$scope.clientsToReceive_historico=jQuery.parseJSON(result).dataset;$scope.$apply();$.post("../backend/application/index.php?rota=/loadClientToReceive",{sesion:$scope.session,apply_calc:true,botao:$scope.botao},function(result){$scope.clientsToReceive=jQuery.parseJSON(result).dataset;$scope.clientsToReceive_historico=jQuery.parseJSON(result).dataset;$scope.ocultar_bloqueados_disabled=false;$scope.botoes_processando=false;cfpLoadingBar.complete();$scope.$apply();});});};$scope.filtra_clientsToReceive=function(){$scope.clientsToReceive=$scope.clientsToReceive_historico;if($scope.ocultar_bloqueados){$scope.clientsToReceive=$scope.clientsToReceive_historico.filter(function(Row){if(Row.somente_reembolso==undefined)return true;return!Row.somente_reembolso;});}};$scope.getClass=function(billreceive){if(billreceive.account_type=="Reembolso"||billreceive.account_type=="Credito"||billreceive.account_type=="Credito Adiantamento"){return"label label-danger";}};$scope.loadAllSpecialBillets=function(){$.post("../backend/application/index.php?rota=/loadAllSpecialBillets",{},function(result){$scope.specialBillets=jQuery.parseJSON(result).dataset;$scope.$digest();});};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.filter={};$scope.wizardBillet=false;$scope.billetGenerated=false;$scope.possibleCloseBillets=false;$rootScope.modalOpen=false;cfpLoadingBar.start();$scope.billetsDivision=[];$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});if(!$scope.clientsToReceive)$scope.findYesterday();$scope.findBilling();$scope.loadAllSpecialBillets();$scope.uploader=new FileUploader();$scope.uploader.url="../backend/application/index.php?rota=/saveFile";$scope.uploader.autoUpload=true;$scope.uploader.filters.push({name:"customFilter",fn:function fn(item,options){return this.queue.length<10;}});};return init();}]).controller("WBilletModalDemoCtrl",["$scope","$rootScope","$modal","$log",function($scope,$rootScope,$modal,$log){$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"WBillet.html",controller:"WBilletModalInstanceCtrl",periods:$scope.$parent.periods,resolve:{filter:function filter(){return $scope.filter;}}});modalInstance.result.then(function(filter){if(filter!=undefined){filter._dueDateFrom=$rootScope.formatServerDate(filter.dueDateFrom);filter._dueDateTo=$rootScope.formatServerDate(filter.dueDateTo);filter._saleDateFrom=$rootScope.formatServerDate(filter.saleDateFrom);filter._saleDateTo=$rootScope.formatServerDate(filter.saleDateTo);}$scope.$parent.filter=filter;$scope.$parent.loadBillsReceive();},function(){$log.info("Modal dismissed at: "+new Date());});};}]).controller("WBilletModalInstanceCtrl",["$scope","$rootScope","$modalInstance","filter",function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){};$scope.cancel=function(){};}]).controller("WBilletModalAttachmentCtrl",["$scope","$rootScope","$modal","$log",function($scope,$rootScope,$modal,$log){$scope.open=function(uploader){if(uploader.queue.length<=0){var modalInstance;modalInstance=$modal.open({templateUrl:"atachmmentsAlert.html",controller:"WBilletModalAttachmentInstanceCtrl",periods:"zxc",resolve:{filter:function filter(){}}});modalInstance.result.then(function(filter){$scope.$parent.mailOrder();},function(){});}else{$scope.$parent.mailOrder();}};}]).controller("WBilletModalAttachmentInstanceCtrl",["$scope","$rootScope","$modalInstance","filter",function($scope,$rootScope,$modalInstance,filter){$scope.filter=filter;$scope.ok=function(){$modalInstance.close($scope.filter);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller("BillsreceiveChangeCtrl",["$scope","$rootScope","$modal","$log","$filter","logger",function($scope,$rootScope,$modal,$log,$filter,logger){$scope.open=function(){$scope.bill=this.billreceive;$scope.bill=angular.copy($scope.bill);var modalInstance;modalInstance=$modal.open({templateUrl:"BillsreceiveChangeCtrl.html",controller:"BillsreceiveChangeInstanceCtrl",resolve:{main:function main(){return $scope.$parent.$parent.$parent.$parent.main;},hashId:function hashId(){return $scope.$parent.$parent.$parent.$parent.session.hashId;},bill:function bill(){return $scope.bill;}}});modalInstance.result.then(function(bill){if(bill){$.post("../backend/application/index.php?rota=/changeBillValue",{hashId:$scope.$parent.$parent.$parent.session.hashId,data:bill},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.$parent.$parent.loadBillsReceive();$scope.$parent.$parent.$apply();});}else{$scope.$parent.$parent.loadBillsReceive();$scope.$parent.$parent.$apply();}});};}]).controller("BillsreceiveChangeInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","main","hashId","bill",function($scope,$rootScope,$modalInstance,logger,main,hashId,bill){$scope.main=main;$scope.hashId=hashId;$scope.bill=bill;$scope.checked=true;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{hashId:$scope.hashId,data:$scope.bill},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=="true"){$scope.checked=false;$scope.$apply();}else{logger.logError("Dados não conferem!");}});};$scope.remove=function(){$.post("../backend/application/index.php?rota=/removeBill",{hashId:$scope.hashId,data:$scope.bill},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);$modalInstance.close(undefined);});};$scope.ok=function(){$modalInstance.close($scope.bill);};}]).controller("CloseBilletsWithCreditCtrl",["$scope","$rootScope","$modal","$log","$filter",function($scope,$rootScope,$modal,$log,$filter){$rootScope.$on("openCloseBillesWtihCreditModal",function(event,args){if($rootScope.modalOpen==false){$rootScope.modalOpen=true;$scope.open(args);}});$scope.open=function(args){var modalInstance;modalInstance=$modal.open({templateUrl:"CloseBilletsWithCreditModal.html",controller:"CloseBilletsWithCreditInstanceCtrl",resolve:{selected:function selected(){return args;}}});modalInstance.result.then(function(resolve){$scope.$parent.setBilletToClose(resolve);$rootScope.modalOpen=false;},function(){$rootScope.modalOpen=false;});};}]).controller("CloseBilletsWithCreditInstanceCtrl",["$scope","$rootScope","$modalInstance","logger","selected",function($scope,$rootScope,$modalInstance,logger,selected){$scope.selected=selected;$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.setSelected=function(billet){$modalInstance.close(billet);};}]);})();(function(){'use strict';angular.module('app.wizardsale',['ui.utils.masks']).controller('WizardSaleCtrl',['$scope','$rootScope','$filter','$modal','cfpLoadingBar','logger',function($scope,$rootScope,$filter,$modal,cfpLoadingBar,logger){var init;var isReturned;var partnerSelected;$scope.periods=['Ultimos 30 dias','Mes Corrente','Semana Corrente','Hoje'];$scope.searchKeywords='';$scope.filteredMiles=[];$scope.row='';$scope.flight={};$scope.paxs=[{pax_name:'',identification:'',paxBirthdate:'',gender:'M',type:'ADT'}];$scope.saleMethods=[{id:2,method:'JACK FOR'},{id:3,method:'Loja TAM Ponta Grossa'},{id:4,method:'Loja TAM Contagem'},{id:4,method:'Loja TAM M'},{id:4,method:'CONFIANÇA'},{id:8,method:'Flytour'},{id:4,method:'TAP'},{id:5,method:'Rextur Advance'},{id:6,method:'Outros'}];$scope.refoundPossibilities=[{id:0,method:'Reembolso Solicitado'},{id:1,method:'Reembolso Confirmado'}];$scope.safePossibilities=[{id:0,method:'Faturado'},{id:1,method:'Cartao'}];$scope.flight.repricing_cost=210;$scope.select=function(page){var end,start;start=(page-1)*$scope.numPerPage;end=start+$scope.numPerPage;return $scope.currentPageMiles=$scope.filteredMiles.slice(start,end);};$scope.onFilterChange=function(){$scope.select(1);$scope.currentPage=1;return $scope.row='';};$scope.onNumPerPageChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.onOrderChange=function(){$scope.select(1);return $scope.currentPage=1;};$scope.search=function(){$scope.filteredMiles=$filter('filter')($scope.miles,$scope.searchKeywords);return $scope.onFilterChange();};$scope.order=function(rowName){if($scope.row===rowName){return;}$scope.row=rowName;$scope.filteredMiles=$filter('orderBy')($scope.miles,rowName);return $scope.onOrderChange();};$scope.nextWizardStage=function(){$scope.tabindex=$scope.tabindex+1;return $scope.tabindex;};$scope.priorWizardStage=function(){$scope.tabindex=$scope.tabindex-1;return $scope.tabindex;};$scope.WizardStageProgress=function(){return($scope.tabindex+1)*25;};$scope.getTotal=function(){return parseFloat($scope.flight.commission)+parseFloat($scope.flight.cost)+parseFloat($scope.flight.tax);};$scope.getParcial=function(){return parseFloat(parseFloat($scope.flight.cost)+parseFloat($scope.flight.tax));};$scope.loadCards=function(){if($scope.flight.partner!='Rextur Advance'&&$scope.flight.partner!='JACK FOR'&&$scope.flight.partner!='CONFIANÇA'&&$scope.flight.partner!='Flytour'&&$scope.flight.miles_original<=0)return logger.logError("Milhas não podem ser 0");void 0;if($scope.validarForm()){$scope.flight.cost_per_thousand=$('#cost_per_thousand').maskMoney('unmasked')[0];$scope.flight.commission=$('#commission').maskMoney('unmasked')[0];$scope.flight.du_tax=$('#du_tax').maskMoney('unmasked')[0];$scope.flight.repricing_cost=$('#repricing_cost').maskMoney('unmasked')[0];$scope.flight.safe_commission=$('#safe_commission').maskMoney('unmasked')[0];if($scope.common==true){if($scope.flight.airline=="TAM"||$scope.flight.airline=="LATAM"){if($scope.flight.partner=="Loja TAM Ponta Grossa"){for(var i in $scope.paxs){$scope.paxs[i].du_tax=40;}$scope.flight.du_tax=40;}else if($scope.flight.partner=="Loja TAM Contagem"){for(var i in $scope.paxs){$scope.paxs[i].du_tax=25;}$scope.flight.du_tax=25;}else if($scope.flight.partner=="Loja TAM M"){for(var i in $scope.paxs){$scope.paxs[i].du_tax=28;}$scope.flight.du_tax=28;}}else if($scope.flight.airline=="AZUL"){for(var i in $scope.paxs){$scope.paxs[i].du_tax=20;}$scope.flight.du_tax=20;}}$scope.flight.miles_used=$scope.flight.miles_original;if($scope.noCard==false&&$scope.partner==false&&$scope.safe==false&&$scope.baggage==false&&$scope.flight.partner!="JACK FOR"&&$scope.flight.partner!="Rextur Advance"&&$scope.flight.partner!="CONFIANÇA"&&$scope.flight.partner!="Flytour"){cfpLoadingBar.start();if($scope.flight.miles_used==undefined){$scope.flight.miles_used=$scope.flight.miles_original;}if($scope.refound==true){$scope.flight.miles_refound=$scope.flight.miles_used;$scope.flight.miles_used=-50000;}else if($scope.repricing==true){$scope.flight.miles_used=$scope.flight.milesDiference;}$scope.resume_paxs=[];for(var i in $scope.paxs){$scope.resume_paxs.push({pax_name:$scope.paxs[i].pax_name,paxLastName:'',paxAgnome:''});}$.post("../backend/application/index.php?rota=/loadSalesMiles",{milesUsed:$scope.flight.miles_used*$scope.paxs.length,airline:$scope.flight.airline,pax_quant:$scope.paxs.length,paxes:$scope.resume_paxs,from:$scope.flight.airport_description_from.substring(0,3),to:$scope.flight.airport_description_to.substring(0,3)},function(result){$scope.miles=jQuery.parseJSON(result).dataset;void 0;cfpLoadingBar.complete();if(!$scope.divers){$scope.flight._boardingDate=new Date($scope.flight.boardingDate);$scope.flight._landingDate=new Date($scope.flight.landing_date);}$scope.tabindex=2;$scope.search();return $scope.select($scope.currentPage);});}else{if(!$scope.divers){$scope.flight._boardingDate=new Date($scope.flight.boardingDate);$scope.flight._landingDate=new Date($scope.flight.landing_date);}if($scope.safe){$scope.flight.safeType=$scope.safePossibilities[0].method;}$scope.tabindex=3;}}else{logger.logError("Favor preencher todos os campos obrigatorios!");}};$scope.$watch('[tabindex]',function(){if($scope.tabindex==3){$scope.loadPaxesUsedCards();}});$scope.loadPaxUsedCards=function(pax){$.post("../backend/application/index.php?rota=/cards/loadPaxUsedCards",{pax_name:pax.pax_name,paxLastName:'',paxAgnome:'',identification:pax.identification,airline:$scope.flight.airline},function(result){$scope.cardsUsed=jQuery.parseJSON(result).dataset;pax.quant=$scope.cardsUsed.length;$scope.$digest();});};$scope.loadPaxesUsedCards=function(){$scope.resume_paxs=[];for(var i in $scope.paxs){$scope.resume_paxs.push({pax_name:$scope.paxs[i].pax_name,paxLastName:'',paxAgnome:'',airline:$scope.flight.airline});}$.post("../backend/application/index.php?rota=/cards/loadAllPaxesCardsUsed",{data:$scope.resume_paxs},function(result){$scope.resume_paxs=jQuery.parseJSON(result).dataset;for(var i in $scope.resume_paxs){$scope.paxs[i].quant=parseFloat($scope.resume_paxs[i].quant);$scope.paxs[i].code=$scope.resume_paxs[i].code;}$scope.$digest();});};$scope.openPaxUsedCards=function(pax){$.post("../backend/application/index.php?rota=/cards/loadPaxUsedCards",{pax_name:pax.pax_name,paxLastName:'',paxAgnome:'',identification:pax.identification},function(result){$scope.cardsUsed=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_names_list.html",controller:'ModalNamesLIstCtrl',resolve:{selected:function selected(){return $scope.selected;},paxPerCards:function paxPerCards(){return $scope.cardsUsed;}}});});};$scope.openAllPaxUsedCards=function(){$scope.resume_paxs=[];for(var i in $scope.paxs){$scope.resume_paxs.push({pax_name:$scope.paxs[i].pax_name,paxLastName:'',paxAgnome:''});}$.post("../backend/application/index.php?rota=/cards/loadAllPaxUsedCards",{data:$scope.resume_paxs},function(result){$scope.cardsUsed=jQuery.parseJSON(result).dataset;var modalInstance;modalInstance=$modal.open({templateUrl:"app/modals/modal_names_list.html",controller:'ModalNamesLIstCtrl',resolve:{selected:function selected(){return $scope.selected;},paxPerCards:function paxPerCards(){return $scope.cardsUsed;}}});});};$scope.$watch('order.client_name',function(){var client=_.find($scope.clients,function(o){return o.name==$scope.order.client_name;});if(client&&client!=undefined&&client!=null){$scope.showNextStep=true;}else{$scope.showNextStep=false;}});$scope.setCards=function(){$scope.cards=this.mile;if($scope.flight_selected.pax_name!==undefined){$scope.flight_selected.card_number=$scope.cards.card_number;$scope.flight_selected.cards_id=$scope.cards.cards_id;$scope.flight_selected.card_registrationCode=$scope.cards.card_registrationCode;$scope.flight_selected.providerName=$scope.cards.name;$scope.flight_selected.provider_phone=$scope.cards.provider_phone;$scope.flight_selected.phoneNumberAirline=$scope.cards.phoneNumberAirline;$scope.flight_selected.celNumberAirline=$scope.cards.celNumberAirline;}else{for(var i in $scope.paxs){$scope.paxs[i].cards_id=$scope.cards.cards_id;$scope.paxs[i].card_registrationCode=$scope.cards.card_registrationCode;$scope.paxs[i].card_number=$scope.cards.card_number;$scope.paxs[i].providerName=$scope.cards.name;$scope.paxs[i].provider_phone=$scope.cards.provider_phone;$scope.paxs[i].phoneNumberAirline=$scope.cards.phoneNumberAirline;$scope.paxs[i].celNumberAirline=$scope.cards.celNumberAirline;}}for(var j in $scope.paxs){$scope.paxs[j].miles_used=$scope.flight.miles_original;$scope.paxs[j].airline=$scope.flight.airline;}if($scope.refound){$scope.flight.value=$scope.getMulta();$scope.flight.miles_used=$scope.flight.miles_refound;}$scope.isReturned=false;$.post("../backend/application/index.php?rota=/loadCardsData",{hashId:$scope.session.hashId,data:$scope.paxs},function(result){$scope.cards=jQuery.parseJSON(result).dataset;$scope.tabindex=3;$scope.cardPassword();$scope.codeAirport();});};$scope.codeAirport=function(){for(var i=0;i<$scope.airports.length-1;i++){if($scope.airports[i].label==$scope.flight.airport_description_from)$scope.flight.airport_code_from=$scope.airports[i].code;if($scope.airports[i].label==$scope.flight.airport_description_to)$scope.flight.airport_code_to=$scope.airports[i].code;if($scope.flight.airport_code_to!=undefined&&$scope.flight.airport_code_from!=undefined)return null;}};$scope.cardPassword=function(){for(var j=0;$scope.cards.length>j;j++){for(var i=0;$scope.paxs.length>i;i++){if($scope.cards[j].cards_id==$scope.paxs[i].cards_id){$scope.paxs[i].recovery_password=$scope.decript($scope.cards[j].recovery_password);$scope.paxs[i].token=$scope.cards[j].token;if($scope.paxs[i].airline=="TAM"||$scope.paxs[i].airline=="LATAM"){$scope.paxs[i].access_id=$scope.cards[j].access_id;$scope.paxs[i].access_password=$scope.decript($scope.cards[j].access_password);}else{$scope.paxs[i].access_id=" - ";$scope.paxs[i].access_password=" - ";}}}}$scope.$apply();};$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};$scope.checkOperation=function(value){switch(value){case'D':$scope.noCard=false;$scope.partner=false;$scope.common=false;$scope.divers=true;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;return;case'C':$scope.divers=false;$scope.partner=false;$scope.common=false;$scope.noCard=true;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;return;case'P':$scope.divers=false;$scope.noCard=false;$scope.common=false;$scope.partner=true;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;return;case'S':$scope.divers=false;$scope.noCard=false;$scope.common=false;$scope.partner=false;$scope.safe=true;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;return;case'R':$scope.divers=false;$scope.noCard=false;$scope.common=false;$scope.partner=false;$scope.safe=false;$scope.refound=true;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;return;case'X':$scope.divers=false;$scope.noCard=false;$scope.common=false;$scope.partner=false;$scope.safe=false;$scope.refound=false;$scope.hotel=false;$scope.repricing=true;$scope.baggage=false;return;case'H':$scope.divers=false;$scope.noCard=false;$scope.common=false;$scope.partner=false;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=true;$scope.baggage=false;return;case'B':$scope.divers=false;$scope.noCard=false;$scope.common=false;$scope.partner=false;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=true;return;default:$scope.divers=false;$scope.noCard=false;$scope.partner=false;$scope.common=true;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;return;}};$scope.validarForm=function(){if($scope.flight.airline=='')return false;if($scope.flight.airport_description_from==''&&($scope.noCard||$scope.partner||$scope.common||$scope.refound||$scope.repricing||$scope.baggage)){return false;}if($scope.flight.airport_description_to==''&&($scope.noCard||$scope.partner||$scope.common||$scope.safe||$scope.refound||$scope.repricing||$scope.baggage)){return false;}if($scope.flight.boardingDate==''&&($scope.noCard||$scope.partner||$scope.common||$scope.safe||$scope.refound||$scope.repricing||$scope.hotel)){return false;}if($scope.flight.landing_date==''&&($scope.noCard||$scope.partner||$scope.common||$scope.safe||$scope.refound||$scope.repricing||$scope.hotel)){return false;}if($scope.flight.flight_time==''&&($scope.noCard||$scope.partner||$scope.common||$scope.refound||$scope.repricing||$scope.hotel)){return false;}for(var i in $scope.paxs){if($scope.paxs[i].pax_name==''&&($scope.noCard||$scope.partner||$scope.common||$scope.safe||$scope.refound||$scope.repricing||$scope.hotel)){return false;}}if($scope.flight.miles_original==''&&($scope.divers||$scope.partner||$scope.common||$scope.refound)){return false;}if($scope.flight.cost==''&&($scope.divers||$scope.partner||$scope.common||$scope.refound)){return false;}if($scope.flight.tax==''&&($scope.divers||$scope.partner||$scope.common||$scope.refound)){return false;}if($scope.flight.commission==''&&$scope.noCard){return false;}if($scope.flight.amount_paid==''&&($scope.partner||$scope.common||$scope.safe||$scope.refound)){return false;}if($scope.flight.safe_commission==''&&$scope.safe){return false;}if($scope.flight.milesDiference==''&&$scope.repricing){return false;}if($scope.flight.repricing_cost==''&&$scope.repricing){return false;}if($scope.flight.costPerThousand==''&&($scope.divers||$scope.repricing)){return false;}return true;};$scope.validCardUsed=function(){if($scope.cards==undefined){logger.logError('Cartão deve ser selecionado');return false;}};$('#wsalereturnDate').on('blur',function(obj,datum){$scope.isReturned=!($scope.wsale.returnDate==undefined);if($scope.wsale.returnDate==undefined){$scope.wsale.return_flight='';$scope.wsale.return_flightHour='';}$scope.$apply();return $scope.isReturned;});$scope.numPerPageOpt=[3,5,10,20];$scope.numPerPage=$scope.numPerPageOpt[2];$scope.currentPage=1;$scope.currentPageMiles=[];$scope.formatNumber=function(number,decimalsLength,decimalSeparator,thousandSeparator){return $rootScope.formatNumber(number,decimalsLength,decimalSeparator,thousandSeparator);};$scope.setToClientDate=function(datetime){return $rootScope.formatClientDate(datetime);};$scope.getMulta=function(){var actualDate=new Date();var selectedDate=new Date($scope.flight._boardingDate);if($scope.flight.airline=="AZUL"){if(actualDate<selectedDate){return parseFloat($scope.flight.amount_paid).toFixed(2)-190;}else return parseFloat($scope.flight.amount_paid).toFixed(2)-240;}else if($scope.flight.airline=="GOL"){if(actualDate<selectedDate){return parseFloat($scope.flight.amount_paid).toFixed(2)-250;}else return parseFloat($scope.flight.amount_paid).toFixed(2)-0;}else if($scope.flight.airline=="TAM"||$scope.flight.airline=="LATAM"){if(actualDate<selectedDate){return parseFloat($scope.flight.amount_paid).toFixed(2)-250;}else return parseFloat($scope.flight.amount_paid).toFixed(2)-290;}};$scope.saveOrder=function(){for(var i in $scope.paxs){$scope.paxs[i]._paxBirthdate=$rootScope.formatServerDate($scope.paxs[i].paxBirthdate);}if(!$scope.flight._boardingDate){$scope.flight._boardingDate=new Date($scope.flight.boardingDate);$scope.flight._landingDate=new Date($scope.flight.landing_date);}$scope.flight._boardingDate=$rootScope.formatServerDateTime($scope.flight._boardingDate);$scope.flight._landingDate=$rootScope.formatServerDateTime($scope.flight._landingDate);$scope.flight.kickback=$scope.flight.amount_paid-$scope.flight.cost-$scope.flight.tax;$scope.flight.status='Pendente';$scope.codeAirport();cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/saveOrder",{data:$scope.flight,paxs:$scope.paxs,order:$scope.order,divers:$scope.divers,noCard:$scope.noCard,partner:$scope.partner,safe:$scope.safe,baggage:$scope.baggage,refound:$scope.refound,repricing:$scope.repricing,hotel:$scope.hotel},function(result){logger.logSuccess(jQuery.parseJSON(result).message.text);});cfpLoadingBar.complete();};$scope.mailOrder=function(){cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/mailOrder",{hashId:$scope.session.hashId,data:$scope.wsalemail,emailType:'EMAIL-GMAIL'},function(result){if(jQuery.parseJSON(result).message.type=='S'){logger.logSuccess(jQuery.parseJSON(result).message.text);$scope.saveOrder();}else{logger.logError(jQuery.parseJSON(result).message.text);}});cfpLoadingBar.complete();};$scope.checkLimit=function(){$scope.order.totalValue=$('#total_value').maskMoney('unmasked')[0];$.post("../backend/application/index.php?rota=/checkLimitSale",{hashId:$scope.session.hashId,data:$scope.order},function(result){$scope.check=jQuery.parseJSON(result).dataset;if($scope.check.partner_limit=='true'){logger.logError("Limite sera ultrapassado com emissão, consulte o comercial");}if($scope.check.paymentType=='Antecipado'){logger.logError("Cliente Antecipado, consulte o comercial");}if($scope.check.status=='Bloqueado'){logger.logError("Cliente Bloqueado, consulte o comercial");}});};$scope.getWeekdayGol=function(){var day=new Date(date).getDay();void 0;switch(day){case 0:return'Domingo';case 1:return'Segunda-feira';case 2:return'Terça-feira';case 3:return'Quarta-feira';case 4:return'Quinta-feira';case 5:return'Sexta-feira';case 6:return'Sábado';}};$scope.getMonth=function(date){var month=date.getMonth();switch(month){case 1:return'Janeiro';case 2:return'Fevereiro';case 3:return'Março';case 4:return'Abril';case 5:return'Maio';case 6:return'Junho';case 7:return'Julho';case 8:return'Agosto';case 9:return'Setembro';case 10:return'Outubro';case 11:return'Novembro';case 12:return'Dezembro';}};$scope.getTotalTax=function(){var total=0;for(var i in $scope.paxs){total+=$scope.flight.tax;}return total;};$scope.validClient=function(){if($scope.wsale_client.$valid){$scope.nextWizardStage();$scope.checkLimit();}};$scope.$watch('tabindex',function(){if($scope.tabindex==1){$scope.flight.tax=$rootScope.formatNumber($scope.flight.tax);$scope.flight.amount_paid=$rootScope.formatNumber($scope.flight.amount_paid);}});$scope.ecript=function(code){var data=code.split("");var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+data[j].charCodeAt(0)*320+'320AB';}return finaly;};$scope.setSafe=function(){$scope.flight.safe_commission=$scope.flight.amount_paid*0.1;};$scope.removePax=function(){if($scope.paxs.length>1){$scope.paxs.pop();}};$scope.addPax=function(){if($scope.paxs.length<9){$scope.paxs.push({pax_name:'',identification:'',paxBirthdate:'',gender:'M',type:'ADT'});}};$scope.flightLocator=function(){for(var i in $scope.paxs){$scope.paxs[i].flight_locator=$scope.flight.flight_locator;}};init=function init(){$scope.checkValidRoute();$scope.tabindex=0;$scope.isReturned=true;$scope.order={};$scope.divers=false;$scope.noCard=false;$scope.partner=false;$scope.common=true;$scope.safe=false;$scope.refound=false;$scope.repricing=false;$scope.hotel=false;$scope.baggage=false;$scope.flight_selected={};$('#miles').number(true,0,',','.');$('#miles_card').number(true,0,',','.');$('#milesDiference').number(true,0,',','.');$('#time').number(true,2,':');$("#value").maskMoney({thousands:'.',decimal:',',precision:2});$("#tax").maskMoney({thousands:'.',decimal:',',precision:2});$("#amount_paid").maskMoney({thousands:'.',decimal:',',precision:2});$("#cost_per_thousand").maskMoney({thousands:'.',decimal:',',precision:2});$("#commission").maskMoney({thousands:'.',decimal:',',precision:2});$("#du_tax").maskMoney({thousands:'.',decimal:',',precision:2});$("#repricing_cost").maskMoney({thousands:'.',decimal:',',precision:2});$("#safe_commission").maskMoney({thousands:'.',decimal:',',precision:2});$("#total_value").maskMoney({thousands:'.',decimal:',',precision:2});cfpLoadingBar.start();$.post("../backend/application/index.php?rota=/loadAirline",$scope.session,function(result){$scope.airlines=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadClientsNames",$scope.session,function(result){$scope.clients=jQuery.parseJSON(result).dataset;cfpLoadingBar.complete();});$.post("../backend/application/index.php?rota=/loadAirport",$scope.session,function(result){$scope.airports=jQuery.parseJSON(result).dataset;});$.post("../backend/application/index.php?rota=/loadIssuing",$scope.session,function(result){$scope.issuings=jQuery.parseJSON(result).dataset;});$('#wsalemilesused').number(true,0,',','.');};return init();}]).controller('CardTaxCardData',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$.post("../backend/application/index.php?rota=/loadInternalCards",$scope.session,function(result){$scope.internalCards=jQuery.parseJSON(result).dataset;$scope.flight_selected=$scope.$parent.flight;$scope.decript=function(code){var data=code.split('320AB');var finaly='';for(var j=0;data.length>j;j++){finaly=finaly+String.fromCharCode(data[j]/320);}return finaly;};for(var i in $scope.internalCards){$scope.internalCards[i].password=$scope.decript($scope.internalCards[i].password);}$scope.type=$scope.$parent.common;if($scope.flight_selected.card_number!=' - '){$.post("../backend/application/index.php?rota=/loadCardProvider",{hashId:$scope.session.hashId,data:$scope.flight_selected},function(result){$scope.TaxCard=jQuery.parseJSON(result).dataset;if($scope.TaxCard.length==1&&$scope.flight_selected.tax_card==undefined){$scope.flight_selected.tax_card=$scope.TaxCard[0].card_number;$scope.flight_selected.tax_password=$scope.decript($scope.TaxCard[0].password);$scope.flight_selected.tax_cardType=$scope.TaxCard[0].card_type;$scope.flight_selected.tax_dueDate=$scope.TaxCard[0].due_date;$scope.flight_selected.tax_providerName=$scope.TaxCard[0].provider_name;$scope.flight_selected.provider_registration=$scope.TaxCard[0].provider_registration;$scope.flight_selected.provider_adress=$scope.TaxCard[0].provider_adress;$scope.flight_selected.birthdate=$scope.TaxCard[0].birthdate;$scope.flight_selected.providerAdress=$scope.TaxCard[0].providerAdress;}else{$scope.TaxCard={};}$scope.originalFlight=angular.copy($scope.flight_selected);var modalInstance;modalInstance=$modal.open({templateUrl:"CardTaxCardData.html",controller:'CardTaxCardInstanceCtrl',resolve:{internalCards:function internalCards(){return $scope.internalCards;},originalFlight:function originalFlight(){return $scope.originalFlight;},flight_selected:function flight_selected(){return $scope.flight_selected;},TaxCard:function TaxCard(){return $scope.TaxCard;}}});modalInstance.result.then(function(TaxCard){$scope.flight_selected.tax_card=TaxCard.tax_card;$scope.flight_selected.tax_password=TaxCard.tax_password;$scope.flight_selected.tax_cardType=TaxCard.tax_cardType;$scope.flight_selected.tax_dueDate=TaxCard.tax_dueDate;$scope.flight_selected.tax_providerName=TaxCard.tax_providerName;});});}});};}]).controller('CardTaxCardInstanceCtrl',['$scope','$rootScope','$modalInstance','$filter','internalCards','originalFlight','flight_selected','TaxCard',function($scope,$rootScope,$modalInstance,$filter,internalCards,originalFlight,flight_selected,TaxCard){$scope.internalCards=internalCards;$scope.flight_selected=originalFlight;$scope.TaxCard=TaxCard;$scope.resume_creditCards=$filter('filter')($scope.internalCards,$scope.flight_selected.airline);$scope.resume_creditCards.push({card_number:'OUTRO'});$scope.findDate=function(date){var data=new Date(date);data.setDate(data.getDate()+1);void 0;return data;};$scope.search=function(){$scope.TaxCard=$filter('filter')($scope.resume_creditCards,$scope.filter);$scope.flight_selected.tax_card=$scope.TaxCard[0].card_number;$scope.flight_selected.tax_password=$scope.TaxCard[0].password;$scope.flight_selected.tax_cardType=$scope.TaxCard[0].card_type;$scope.flight_selected.tax_dueDate=new Date($scope.TaxCard[0].due_date);$scope.flight_selected.tax_providerName=$scope.TaxCard[0].provider_name;$scope.flight_selected.provider_registration=$scope.TaxCard[0].provider_registration;$scope.flight_selected.providerAdress=$scope.TaxCard[0].providerAdress;$scope.flight_selected.provider_adress=$scope.TaxCard[0].provider_adress;$scope.flight_selected.birthdate=new Date($scope.TaxCard[0].birthdate);};$scope.ok=function(){flight_selected=$scope.flight_selected;$modalInstance.close($scope.flight_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('FlightData',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){$scope.flight_selected=this.pax;$scope.originalFlight=angular.copy($scope.flight_selected);var modalInstance;modalInstance=$modal.open({templateUrl:"FlightData.html",controller:'FlightDataInstanceCtrl',resolve:{flight_selected:function flight_selected(){return $scope.flight_selected;},originalFlight:function originalFlight(){return $scope.originalFlight;}}});modalInstance.result.then(function(flight_selected){for(var i in $scope.$parent.paxs){if($scope.$parent.paxs[i].pax_name==flight_selected.pax_name){$scope.$parent.paxs[i].miles_used=flight_selected.miles_used;$scope.$parent.paxs[i].du_tax=flight_selected.du_tax;$scope.$parent.paxs[i].money=flight_selected.money;$scope.$parent.paxs[i].flight_locator=flight_selected.flight_locator;$scope.$parent.paxs[i].ticket_code=flight_selected.ticket_code;$scope.$parent.paxs[i].baggage=flight_selected.baggage;$scope.$parent.paxs[i].special_seat=flight_selected.special_seat;}}$scope.$parent.flight.du_tax=flight_selected.du_tax;});};}]).controller('FlightDataInstanceCtrl',['$scope','$rootScope','$modalInstance','flight_selected','originalFlight',function($scope,$rootScope,$modalInstance,flight_selected,originalFlight){$scope.flight_selected=originalFlight;$scope.ok=function(){flight_selected=$scope.flight_selected;$modalInstance.close($scope.flight_selected);};$scope.cancel=function(){$modalInstance.dismiss("cancel");};}]).controller('FindAllCardsManualCtrl',['$scope','$rootScope','$modal','$log','$filter',function($scope,$rootScope,$modal,$log,$filter){$scope.open=function(){var modalInstance;modalInstance=$modal.open({templateUrl:"FindAllCardsManualCtrl.html",controller:'FindAllCardsManualInstanceCtrl',resolve:{main:function main(){return $scope.$parent.$parent.main;},hashId:function hashId(){return $scope.$parent.$parent.$parent.session.hashId;}}});modalInstance.result.then(function(){$.post("../backend/application/index.php?rota=/loadSalesMiles",{hashId:$scope.session.hashId,milesUsed:-50000,airline:$scope.$parent.flight.airline},function(result){$scope.$parent.miles=jQuery.parseJSON(result).dataset;$scope.$parent.search();$scope.$parent.$apply();});});};}]).controller('FindAllCardsManualInstanceCtrl',['$scope','$rootScope','$modalInstance','logger','main','hashId',function($scope,$rootScope,$modalInstance,logger,main,hashId){$scope.main=main;$scope.hashId=hashId;$scope.flight_selected={pinCode:''};$scope.cancel=function(){$modalInstance.dismiss("cancel");};$scope.check=function(){$.post("../backend/application/index.php?rota=/checkAcessCode",{hashId:$scope.hashId,data:$scope.flight_selected},function(result){$scope.response=jQuery.parseJSON(result).dataset;if($scope.response.valid=='true'){$modalInstance.close();}else{logger.logError("Dados não conferem!");}});};}]);})();;